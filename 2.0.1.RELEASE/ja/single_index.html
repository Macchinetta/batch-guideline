<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="author" content="NTT Corporation.">
<title>Macchinetta Batch Framework (2.x) Development Guideline</title>
<link rel="stylesheet" href="./theme/css/readthedocs.css">
<link rel="stylesheet" href="./theme/css/font-awesome.min.css">
<link rel="stylesheet" href="./theme/css/coderay-asciidoctor.css">
<link rel="stylesheet" href="./theme/css/header-footer.css">
<title>Macchinetta Batch Framework (2.x) Development Guideline</title>

<div class="common-bg">
  <div class="information">
    Macchinetta Batch Framework (2.x) Development Guideline - version 2.0.1.RELEASE, 2018-3-9
  </div>
  <div class="index">
      <a href="#">&gt; INDEX</a>
  </div>
</div>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113850349-5"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-113850349-5');
</script>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Macchinetta Batch Framework (2.x) Development Guideline</h1>
<div class="details">
<span id="author" class="author">NTT Corporation.</span><br>
<span id="revnumber">version 2.0.1.RELEASE,</span>
<span id="revdate">2018-3-9</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#Ch01">1. はじめに</a>
<ul class="sectlevel2">
<li><a href="#Ch01_TermsOfUse">1.1. 利用規約</a>
<ul class="sectlevel3">
<li><a href="#macchinetta-利用規約">1.1.1. Macchinetta 利用規約</a></li>
</ul>
</li>
<li><a href="#Ch01_Intro">1.2. 導入</a>
<ul class="sectlevel3">
<li><a href="#Ch01_Intro_Goal">1.2.1. ガイドラインの目的</a></li>
<li><a href="#Ch01_Intro_TargetReaders">1.2.2. ガイドラインの対象読者</a></li>
<li><a href="#Ch01_Intro_Structure">1.2.3. ガイドラインの構成</a></li>
<li><a href="#Ch01_Intro_HowToReadGuide">1.2.4. ガイドラインの読み方</a></li>
<li><a href="#Ch01_Intro_TestedEnviroments">1.2.5. ガイドラインの動作検証環境</a></li>
</ul>
</li>
<li><a href="#Ch01_ChangeLog">1.3. 更新履歴</a></li>
</ul>
</li>
<li><a href="#Ch02">2. Macchinetta Batch Framework (2.x)のコンセプト</a>
<ul class="sectlevel2">
<li><a href="#Ch02_GeneralBatchProcess">2.1. 一般的なバッチ処理</a>
<ul class="sectlevel3">
<li><a href="#Ch02_GeneralBatchProcess_AboutBatchProcess">2.1.1. 一般的なバッチ処理とは</a></li>
<li><a href="#Ch02_GeneralBatchProcess_Scenario">2.1.2. バッチ処理に求められる要件</a></li>
<li><a href="#Ch02_GeneralBatchProcess_Considerations">2.1.3. バッチ処理で考慮する原則と注意点</a></li>
</ul>
</li>
<li><a href="#Ch02_MacchinettaBatchStack">2.2. Macchinetta Batch Framework (2.x)のスタック</a>
<ul class="sectlevel3">
<li><a href="#Ch02_MacchinettaBatchStack_Overview">2.2.1. 概要</a></li>
<li><a href="#Ch02_MacchinettaBatchStack_Stack">2.2.2. Macchinetta Batch Framework (2.x)のスタック</a></li>
<li><a href="#Ch02_MacchinettaBatchStack_Components">2.2.3. Macchinetta Batch Framework (2.x)の構成要素</a></li>
</ul>
</li>
<li><a href="#Ch02_SpringBatchArch">2.3. Spring Batchのアーキテクチャ</a>
<ul class="sectlevel3">
<li><a href="#Ch02_SpringBatchArch_Overview">2.3.1. Overview</a></li>
<li><a href="#Ch02_SpringBatchArch_Arch">2.3.2. Architecture</a></li>
</ul>
</li>
<li><a href="#Ch02_MacchinettaBatchArch">2.4. Macchinetta Batch Framework (2.x)のアーキテクチャ</a>
<ul class="sectlevel3">
<li><a href="#Ch02_MacchinettaBatchArch_Overview">2.4.1. 概要</a></li>
<li><a href="#Ch02_MacchinettaBatchArch_JobComponents">2.4.2. ジョブの構成要素</a></li>
<li><a href="#Ch02_MacchinettaBatchArch_StepImpl">2.4.3. ステップの実装方式</a></li>
<li><a href="#Ch02_MacchinettaBatchArch_LaunchMethod">2.4.4. ジョブの起動方式</a></li>
<li><a href="#Ch02_MacchinettaBatchArch_DecisionPoints">2.4.5. 利用する際の検討ポイント</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch03">3. アプリケーション開発の流れ</a>
<ul class="sectlevel2">
<li><a href="#Ch03_CreateProject">3.1. バッチアプリケーションの開発</a>
<ul class="sectlevel3">
<li><a href="#Ch03_CreateProject_blank">3.1.1. ブランクプロジェクトとは</a></li>
<li><a href="#Ch03_CreateProject_HowToCreate">3.1.2. プロジェクトの作成</a></li>
<li><a href="#Ch03_CreateProject_ProjectStructure">3.1.3. プロジェクトの構成</a></li>
<li><a href="#Ch03_CreateProject_Make">3.1.4. 開発の流れ</a></li>
<li><a href="#Ch03_CreateProject_CreateJob">3.1.5. ジョブの作成</a></li>
<li><a href="#Ch03_CreateProject_BuildAndExec">3.1.6. プロジェクトのビルドと実行</a></li>
</ul>
</li>
<li><a href="#Ch03_CreateChunkJob">3.2. チャンクモデルジョブの作成</a>
<ul class="sectlevel3">
<li><a href="#Ch03_CreateChunkJob_Overview">3.2.1. Overview</a></li>
<li><a href="#Ch03_CreateChunkJob_HowToUse">3.2.2. How to use</a></li>
</ul>
</li>
<li><a href="#Ch03_CreateTaskletJob">3.3. タスクレットモデルジョブの作成</a>
<ul class="sectlevel3">
<li><a href="#Ch03_CreateTaskletJob_Overview">3.3.1. Overview</a></li>
<li><a href="#Ch03_CreateTaskletJob_HowToUse">3.3.2. How to use</a></li>
</ul>
</li>
<li><a href="#Ch03_ChunkOrTasklet">3.4. チャンクモデルとタスクレットモデルの使い分け</a></li>
</ul>
</li>
<li><a href="#Ch04">4. ジョブの起動</a>
<ul class="sectlevel2">
<li><a href="#Ch04_SyncJob">4.1. 同期実行</a>
<ul class="sectlevel3">
<li><a href="#Ch04_SyncJob_Overview">4.1.1. Overview</a></li>
<li><a href="#Ch04_SyncJob_HowToUse">4.1.2. How to use</a></li>
</ul>
</li>
<li><a href="#Ch04_JobParameter">4.2. ジョブの起動パラメータ</a>
<ul class="sectlevel3">
<li><a href="#Ch04_JobParameter_Overview">4.2.1. Overview</a></li>
<li><a href="#Ch04_JobParameter_HowToUse">4.2.2. How to use</a></li>
<li><a href="#Ch04_JobParameter_HowToExtends">4.2.3. How to extends</a></li>
</ul>
</li>
<li><a href="#Ch04_AsyncJobWithDB">4.3. 非同期実行(DBポーリング)</a>
<ul class="sectlevel3">
<li><a href="#Ch04_AsyncJobWithDB_Overview">4.3.1. Overview</a></li>
<li><a href="#Ch04_AsyncJobWithDB_Arch">4.3.2. Architecture</a></li>
<li><a href="#Ch04_AsyncJobWithDB_HowToUse">4.3.3. How to use</a></li>
<li><a href="#Ch04_AsyncJobWithDB_HowToExtend">4.3.4. How to extend</a></li>
<li><a href="#Ch04_AsyncJobWithDB_Appendix">4.3.5. Appendix</a></li>
</ul>
</li>
<li><a href="#Ch04_AsyncJobWithWeb">4.4. 非同期実行(Webコンテナ)</a>
<ul class="sectlevel3">
<li><a href="#Ch04_AsyncJobWithWeb_Overview">4.4.1. Overview</a></li>
<li><a href="#Ch04_AsyncJobWithWeb_Arch">4.4.2. Architecture</a></li>
<li><a href="#Ch04_AsyncJobWithWeb_HowToUse">4.4.3. How to use</a></li>
<li><a href="#Ch04_AsyncJobWithWeb_HowToExtend">4.4.4. How to extend</a></li>
</ul>
</li>
<li><a href="#Ch04_Listener">4.5. リスナー</a>
<ul class="sectlevel3">
<li><a href="#Ch04_Listener_Overview">4.5.1. Overview</a></li>
<li><a href="#Ch04_Listener_HowToUse">4.5.2. How to use</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch05">5. データの入出力</a>
<ul class="sectlevel2">
<li><a href="#Ch05_Transaction">5.1. トランザクション制御</a>
<ul class="sectlevel3">
<li><a href="#Ch05_Transaction_Overview">5.1.1. Overview</a></li>
<li><a href="#Ch05_Transaction_Arch">5.1.2. Architecture</a></li>
<li><a href="#Ch05_Transaction_HowToUse">5.1.3. How to use</a></li>
</ul>
</li>
<li><a href="#Ch05_DBAccess">5.2. データベースアクセス</a>
<ul class="sectlevel3">
<li><a href="#Ch05_DBAccess_Overview">5.2.1. Overview</a></li>
<li><a href="#Ch05_DBAccess_HowToUse">5.2.2. How to use</a></li>
<li><a href="#Ch05_DBAccess_HowToExtend">5.2.3. How To Extend</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess">5.3. ファイルアクセス</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_Overview">5.3.1. Overview</a></li>
<li><a href="#Ch05_FileAccess_HowToUse">5.3.2. How to use</a></li>
<li><a href="#Ch05_FileAccess_HowToExtend">5.3.3. How To Extend</a></li>
</ul>
</li>
<li><a href="#Ch05_ExclusiveControl">5.4. 排他制御</a>
<ul class="sectlevel3">
<li><a href="#Ch05_ExclusiveControl_Overview">5.4.1. Overview</a></li>
<li><a href="#Ch05_ExclusiveControl_HowToUse">5.4.2. How to use</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch06">6. 異常系への対応</a>
<ul class="sectlevel2">
<li><a href="#Ch06_InputValidation">6.1. 入力チェック</a>
<ul class="sectlevel3">
<li><a href="#Ch06_InputValidation_Overview">6.1.1. Overview</a></li>
<li><a href="#Ch06_InputValidation_HowToUse">6.1.2. How to use</a></li>
</ul>
</li>
<li><a href="#Ch06_ExceptionHandling">6.2. 例外ハンドリング</a>
<ul class="sectlevel3">
<li><a href="#Ch06_ExceptionHandling_Overview">6.2.1. Overview</a></li>
<li><a href="#Ch06_ExceptionHandling_HowToUse">6.2.2. How to use</a></li>
<li><a href="#Ch06_ExceptionHandling_Appendix">6.2.3. Appendix</a></li>
</ul>
</li>
<li><a href="#Ch06_RerunRestart">6.3. 処理の再実行</a>
<ul class="sectlevel3">
<li><a href="#Ch06_RerunRestart_Overview">6.3.1. Overview</a></li>
<li><a href="#Ch06_RerunRestart_HowToUse">6.3.2. How to use</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch07_JobManagement">7. ジョブの管理</a>
<ul class="sectlevel2">
<li><a href="#Ch07_JobManagement_Overview">7.1. Overview</a>
<ul class="sectlevel3">
<li><a href="#Ch07_JobManagement_Overview_JobExecutionManagement">7.1.1. ジョブの実行管理とは</a></li>
</ul>
</li>
<li><a href="#Ch07_JobManagement_HowToUse">7.2. How to use</a>
<ul class="sectlevel3">
<li><a href="#Ch07_JobManagement_HowToUse_JobStatusManagement">7.2.1. ジョブの状態管理</a></li>
<li><a href="#Ch07_JobManagement_HowToUse_ExitCode">7.2.2. 終了コードのカスタマイズ</a></li>
<li><a href="#Ch07_JobManagement_HowToUse_DuplicateSafe">7.2.3. 二重起動防止</a></li>
<li><a href="#Ch07_JobManagement_HowToUse_Logging">7.2.4. ロギング</a></li>
<li><a href="#Ch07_JobManagement_HowToUse_MessageManagement">7.2.5. メッセージ管理</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch08">8. フロー制御と並列･多重処理</a>
<ul class="sectlevel2">
<li><a href="#Ch08_FlowControll">8.1. フロー制御</a>
<ul class="sectlevel3">
<li><a href="#Ch08_FlowControll_Overview">8.1.1. Overview</a></li>
<li><a href="#Ch08_FlowControll_HowToUse">8.1.2. How to use</a></li>
<li><a href="#Ch08_FlowControll_HowToExtend">8.1.3. How to extend</a></li>
</ul>
</li>
<li><a href="#Ch08_ParallelAndMultiple">8.2. 並列処理と多重処理</a>
<ul class="sectlevel3">
<li><a href="#Ch08_ParallelAndMultiple_Overview">8.2.1. Overview</a></li>
<li><a href="#Ch08_ParallelAndMultiple_HowToUse">8.2.2. How to use</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch09">9. チュートリアル</a>
<ul class="sectlevel2">
<li><a href="#Ch09_Introduction">9.1. はじめに</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Introduction_Purpose">9.1.1. チュートリアルの目的</a></li>
<li><a href="#Ch09_Introduction_Target">9.1.2. 対象読者</a></li>
<li><a href="#Ch09_Introduction_Environment">9.1.3. 検証環境</a></li>
<li><a href="#Ch09_Introduction_AboutFrameWork">9.1.4. フレームワークの概要</a></li>
<li><a href="#Ch09_Introduction_HowToProceed">9.1.5. チュートリアルの進め方</a></li>
</ul>
</li>
<li><a href="#Ch09_TutorialApplication">9.2. 作成するアプリケーションの説明</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Application_Overview">9.2.1. 背景</a></li>
<li><a href="#Ch09_Application_ProcessingOverview">9.2.2. 処理概要</a></li>
<li><a href="#Ch09_Application_BusinessRequirements">9.2.3. 業務仕様</a></li>
<li><a href="#Ch09_Application_ImplementationMethod">9.2.4. 学習コンテンツ</a></li>
</ul>
</li>
<li><a href="#Ch09_EnvironmentConstruction">9.3. 環境構築</a>
<ul class="sectlevel3">
<li><a href="#Ch09_EnvironmentConstruction_BlankProject">9.3.1. プロジェクトの作成</a></li>
<li><a href="#Ch09_EnvironmentConstruction_Import">9.3.2. プロジェクトのインポート</a></li>
<li><a href="#Ch09_EnvironmentConstruction_BlankProjectConstruction">9.3.3. プロジェクトの構成</a></li>
<li><a href="#Ch09_EnvironmentConstruction_Setting">9.3.4. 設定ファイルの確認・編集</a></li>
<li><a href="#Ch09_EnvironmentConstruction_InputDataPreparation">9.3.5. 入力データの準備</a></li>
<li><a href="#Ch09_EnvironmentConstruction_DataSourceExplorer">9.3.6. STSからデータベースを参照する準備</a></li>
<li><a href="#Ch09_EnvironmentConstruction_OperationCheck">9.3.7. プロジェクトの動作確認</a></li>
</ul>
</li>
<li><a href="#Ch09_Impl_single_index">9.4. バッチジョブの実装</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Impl_DBAccessJob">9.4.1. データベースアクセスでデータ入出力を行うジョブ</a></li>
<li><a href="#Ch09_Impl_FileAccessJob">9.4.2. ファイルアクセスでデータ入出力を行うジョブ</a></li>
<li><a href="#Ch09_Impl_ValidationJob">9.4.3. 入力データの妥当性検証を行うジョブ</a></li>
<li><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob">9.4.4. ChunkListenerで例外ハンドリングを行うジョブ</a></li>
<li><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob">9.4.5. try-catchで例外ハンドリングを行うジョブ</a></li>
<li><a href="#Ch09_Impl_AsyncExecutionJob">9.4.6. 非同期実行方式のジョブ</a></li>
</ul>
</li>
<li><a href="#Ch09_Conclusion">9.5. おわりに</a></li>
</ul>
</li>
<li><a href="#Ch99_SummaryOfPoints">10. 利用時の注意点</a>
<ul class="sectlevel2">
<li><a href="#Ch99_SummaryOfPoints_AboutThis">10.1. Macchinetta Batch 2.xの注意点について</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="Ch01"><a class="anchor" href="#Ch01"></a>1. はじめに</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch01_TermsOfUse"><a class="anchor" href="#Ch01_TermsOfUse"></a>1.1. 利用規約</h3>
<div class="sect3">
<h4 id="macchinetta-利用規約"><a class="anchor" href="#macchinetta-利用規約"></a>1.1.1. Macchinetta 利用規約</h4>
<div class="paragraph">
<p>本ドキュメントを使用するにあたり、以下の規約に同意していただく必要があります。同意いただけない場合は、本ドキュメント及びその複製物の全てを直ちに消去又は破棄してください。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>本ドキュメントの著作権及びその他一切の権利は、日本電信電話株式会社（以下「NTT」とする）あるいはNTTに権利を許諾する第三者に帰属します。</p>
</li>
<li>
<p>本ドキュメントの一部または全部を、自らが使用する目的において、複製、翻訳、翻案することができます。ただし本ページの規約全文、およびNTTの著作権表示を削除することはできません。</p>
</li>
<li>
<p>本ドキュメントの一部または全部を、自らが使用する目的において改変したり、本ドキュメントを用いた二次的著作物を作成することができます。ただし、「参考文献：Macchinetta Batch Framework Development
Guideline」あるいは同等の表現を、作成したドキュメント及びその複製物に記載するものとします。</p>
</li>
<li>
<p>前2項によって作成したドキュメント及びその複製物を、無償の場合に限り、第三者へ提供することができます。</p>
</li>
<li>
<p>NTTの書面による承諾を得ることなく、本規約に定められる条件を超えて、本ドキュメント及びその複製物を使用したり、本規約上の権利の全部又は一部を第三者に譲渡したりすることはできません。</p>
</li>
<li>
<p>NTTは、本ドキュメントの内容の正確性、使用目的への適合性の保証、使用結果についての的確性や信頼性の保証、及び瑕疵担保義務も含め、直接、間接に被ったいかなる損害に対しても一切の責任を負いません。</p>
</li>
<li>
<p>NTTは、本ドキュメントが第三者の著作権、その他如何なる権利も侵害しないことを保証しません。また、著作権、その他の権利侵害を直接又は間接の原因としてなされる如何なる請求（第三者との間の紛争を理由になされる請求を含む。）に関しても、NTTは一切の責任を負いません。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>本ドキュメントで使用されている各社の会社名及びサービス名、商品名に関する登録商標および商標は、以下の通りです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Macchinetta は、NTTの登録商標です。</p>
</li>
<li>
<p>その他の会社名、製品名は、各社の登録商標または商標です。</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="Ch01_Intro"><a class="anchor" href="#Ch01_Intro"></a>1.2. 導入</h3>
<div class="sect3">
<h4 id="Ch01_Intro_Goal"><a class="anchor" href="#Ch01_Intro_Goal"></a>1.2.1. ガイドラインの目的</h4>
<div class="paragraph">
<p>本ガイドラインではSpring Framework、Spring Batch、MyBatis を中心としたフルスタックフレームワークを利用して、
保守性の高いバッチアプリケーション開発をするためのベストプラクティスを提供する。</p>
</div>
<div class="paragraph">
<p>本ガイドラインを読むことで、ソフトウェア開発(主にコーディング)が円滑に進むことを期待する。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch01_Intro_TargetReaders"><a class="anchor" href="#Ch01_Intro_TargetReaders"></a>1.2.2. ガイドラインの対象読者</h4>
<div class="paragraph">
<p>本ガイドラインはソフトウェア開発経験のあるアーキテクトやプログラマ向けに書かれており、
以下の知識があることを前提としている。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring FrameworkのDIやAOPに関する基礎的な知識がある</p>
</li>
<li>
<p>Javaを使用してアプリケーションを開発したことがある</p>
</li>
<li>
<p>SQLに関する知識がある</p>
</li>
<li>
<p>Mavenを使用したことがある</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これからJavaを勉強し始めるという人向けではない。</p>
</div>
<div class="paragraph">
<p>Spring Frameworkに関して、本ドキュメントを読むための基礎知識があるかどうかを測るために
<a href="https://macchinetta.github.io/server-guideline/current/ja//Appendix/SpringComprehensionCheck.html">Spring Framework理解度チェックテスト</a>
を参照するとよい。
この理解度テストが4割回答できない場合は、別途以下のような書籍で学習することを推奨する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.shoeisha.co.jp/book/detail/9784798142470">Spring徹底入門 (翔泳社) [日本語] </a></p>
</li>
<li>
<p><a href="http://gihyo.jp/book/2016/978-4-7741-8217-9">［改訂新版］Spring入門――Javaフレームワーク・より良い設計とアーキテクチャ [日本語]</a></p>
</li>
<li>
<p><a href="http://www.apress.com/9781430261513">Pro Spring 4th Edition (Apress)</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="Ch01_Intro_Structure"><a class="anchor" href="#Ch01_Intro_Structure"></a>1.2.3. ガイドラインの構成</h4>
<div class="paragraph">
<p>まず、重要なこととして、本ガイドラインは
<a href="https://macchinetta.github.io/server-guideline/current/ja//index.html">Macchinetta Server Framework (1.x) Development Guideline</a>
(以降、Macchinetta Server 1.x 開発ガイドライン)のサブセットとして位置づけている。
出来る限りMacchinetta Server 1.x 開発ガイドラインを活用し説明の重複を省くことで、ユーザの学習コスト低減を狙っている。
よって随所にMacchinetta Server 1.x 開発ガイドラインへの参照を示しているため、両方のガイドを活用しながら開発を進めていってほしい。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#Ch02">Macchinetta Batch Framework (2.x)のコンセプト</a></dt>
<dd>
<p>バッチ処理の基本的な考え方、Macchinetta Batch Framework (2.x)の基本的な考え方、Spring Batchの概要を説明する。</p>
</dd>
<dt class="hdlist1"><a href="#Ch03">アプリケーション開発の流れ</a></dt>
<dd>
<p>Macchinetta Batch Framework (2.x)を利用してアプリケーション開発する上で必ず押さえておかなくてはならない知識や作法について説明する。</p>
</dd>
<dt class="hdlist1"><a href="#Ch04">ジョブの起動</a></dt>
<dd>
<p>同期実行、非同期実行、起動パラメータといったジョブの起動方法について説明する。</p>
</dd>
<dt class="hdlist1"><a href="#Ch05">データの入出力</a></dt>
<dd>
<p>データベースアクセス、ファイルアクセスといった、各種リソースへの入出力について説明する。</p>
</dd>
<dt class="hdlist1"><a href="#Ch06">異常系への対応</a></dt>
<dd>
<p>入力チェックや例外ハンドリングといった異常系について説明する。</p>
</dd>
<dt class="hdlist1"><a href="#Ch07_JobManagement">ジョブの管理</a></dt>
<dd>
<p>ジョブの実行管理の方法について説明する。</p>
</dd>
<dt class="hdlist1"><a href="#Ch08">フロー制御と並列･多重処理</a></dt>
<dd>
<p>ジョブを並列処理/分散処理する方法について説明する。</p>
</dd>
<dt class="hdlist1"><a href="#Ch09">チュートリアル</a></dt>
<dd>
<p>基本的なバッチアプリケーション開発をとおして、Macchinetta Batch Framework (2.x)によるバッチアプリケーション開発を体験する。</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="Ch01_Intro_HowToReadGuide"><a class="anchor" href="#Ch01_Intro_HowToReadGuide"></a>1.2.4. ガイドラインの読み方</h4>
<div class="paragraph">
<p>以下のコンテンツはMacchinetta Batch Framework (2.x)を使用するすべての開発者が読むことを強く推奨する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch02">Macchinetta Batch Framework (2.x)のコンセプト</a></p>
</li>
<li>
<p><a href="#Ch03">アプリケーション開発の流れ</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以下のコンテンツは通常必要となるため、基本的には読んでおくこと。
開発対象に応じて、取捨選択するとよい。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch04">ジョブの起動</a></p>
</li>
<li>
<p><a href="#Ch05">データの入出力</a></p>
</li>
<li>
<p><a href="#Ch06">異常系への対応</a></p>
</li>
<li>
<p><a href="#Ch07_JobManagement">ジョブの管理</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以下のコンテンツは一歩進んだ実装をする際にはじめて参照すれば良い。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch08">フロー制御と並列･多重処理</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以下のコンテンツはMacchinetta Batch Framework (2.x)を使用して実際のアプリケーション開発を体験したい開発者が読むことを推奨する。
はじめてMacchinetta Batch Framework (2.x)に触れる場合は、まずこのコンテンツから読み始め、他のコンテンツを参照しながら進めるとよい。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch09">チュートリアル</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch01_Intro_HowToReadGuide_representation"><a class="anchor" href="#Ch01_Intro_HowToReadGuide_representation"></a>1.2.4.1. ガイドラインの表記</h5>
<div class="paragraph">
<p>本ガイドラインの表記について、留意事項を述べる。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">WindowsコマンドプロンプトとUnix系ターミナルについて</dt>
<dd>
<p>WindowsとUnix系では表記の違いで動作しなくなる場合は併記する。
そうでない場合は、Unix系の表記で統一する。</p>
<div class="dlist">
<dl>
<dt class="hdlist1">プロンプト記号</dt>
<dd>
<p>Unix系の<code>$</code>にて表記する。</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">プロンプト表記例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ java -version</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Bean定義のプロパティとコンストラクタについて</dt>
<dd>
<p>本ガイドラインでは、<code>p</code>と<code>c</code>のネームスペースを用いた表記とする。
ネームスペースを用いることで、Bean定義の記述が簡潔になったり、コンストラクタ引数が明確になる効果がある。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ネームスペースを利用した記述</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.transform.FixedByteLengthLineTokenizer</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">c:ranges</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1-6, 7-10, 11-12, 13-22, 23-32</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">c:charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>参考までに、ネームスペースを利用しない記述を示す。</p>
</div>
<div class="listingblock">
<div class="title">ネームスペースを利用しない記述</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.transform.FixedByteLengthLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;constructor-arg</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1-6, 7-10, 11-12, 13-22, 23-32</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;constructor-arg</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">names</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>なお、ユーザに対してネームスペースを用いる記述を強要することはない。
あくまで説明を簡潔にするための配慮であると受け止めてほしい。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch01_Intro_TestedEnviroments"><a class="anchor" href="#Ch01_Intro_TestedEnviroments"></a>1.2.5. ガイドラインの動作検証環境</h4>
<div class="paragraph">
<p>本ガイドラインで説明している内容の動作検証環境については、
「 <a href="https://github.com/Macchinetta/macchinetta-batch-functionaltest/wiki/Tested-Environment">テスト済み環境</a> 」を参照されたい。</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="Ch01_ChangeLog"><a class="anchor" href="#Ch01_ChangeLog"></a>1.3. 更新履歴</h3>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 15%;">
<col style="width: 25%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">更新日付</th>
<th class="tableblock halign-left valign-top">更新箇所</th>
<th class="tableblock halign-left valign-top">変更内容</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2018-3-9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.0.1 RELEASE 版公開</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch02_MacchinettaBatchStack_Stack">Macchinetta Batch Framework (2.x)のスタック</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CVE-2018-1199対応によるSpring Frameworkのバージョンアップデート</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-12-22</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.0.0 RELEASE 版公開</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch02"><a class="anchor" href="#Ch02"></a>2. Macchinetta Batch Framework (2.x)のコンセプト</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch02_GeneralBatchProcess"><a class="anchor" href="#Ch02_GeneralBatchProcess"></a>2.1. 一般的なバッチ処理</h3>
<div class="sect3">
<h4 id="Ch02_GeneralBatchProcess_AboutBatchProcess"><a class="anchor" href="#Ch02_GeneralBatchProcess_AboutBatchProcess"></a>2.1.1. 一般的なバッチ処理とは</h4>
<div class="paragraph">
<p>一般的に、バッチ処理とは「まとめて一括処理する」ことを指す。<br>
データベースやファイルから大量のレコードを読み込み、処理し、書き出す処理であることが多い。<br>
バッチ処理には以下の特徴があり、オンライン処理と比較して、応答性より処理スループットを優先した処理方式である。</p>
</div>
<div class="ulist">
<div class="title">バッチ処理の特徴</div>
<ul>
<li>
<p>データを一定の量でまとめて処理する。</p>
</li>
<li>
<p>処理に一定の順序がある。</p>
</li>
<li>
<p>スケジュールに従って実行・管理される。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>次にバッチ処理を利用する主な目的を以下に示す。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">スループットの向上</dt>
<dd>
<p>データをまとめて処理することで、処理のスループットを向上できる。<br>
ファイルやデータベースは、1件ごとにデータを入出力せず、一定件数にまとめることで、I/O待ちのオーバヘッドが劇的に少なくなり効率的である。
1件ごとのI/O待ちは微々たるものでも、大量データを処理する場合はその累積が致命的な遅延となる。</p>
</dd>
<dt class="hdlist1">応答性の確保</dt>
<dd>
<p>オンライン処理の応答性を確保するため、即時処理を行う必要がない処理をバッチ処理に切り出す。<br>
たとえば、すぐに処理結果が必要でない場合、オンライン処理で受付まで処理を行い、裏でバッチ処理を行う構成がある。
このような処理方式は、<code>ディレードバッチ</code>、<code>ディレードオンライン</code>などと呼ばれる。</p>
</dd>
<dt class="hdlist1">時間やイベントへの対応</dt>
<dd>
<p>特定の時間やイベントに応じた処理は、バッチ処理として実装することが素直と言える。<br>
たとえば、業務要件により1ヶ月分のデータを翌月第1週の週末に集計する、システム運用ルールに則って週末日曜の午前2時に1週間分の業務データをバックアップする、などである。</p>
</dd>
<dt class="hdlist1">外部システムとの連携上の制約</dt>
<dd>
<p>ファイルなど外部システムとのインターフェースが制約となるために、バッチ処理を利用することもある。<br>
外部システムから送付されてきたファイルは、一定期間のデータをまとめたものになる。
これを取り込む処理は、オンライン処理よりもバッチ処理が向いている。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>バッチ処理を実現するには、さまざまな技術要素を組み合わせることが一般的である。ここでは、主要な技術を紹介する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ジョブスケジューラ</dt>
<dd>
<p>バッチ処理の1実行単位をジョブと呼ぶ。これを管理するためのミドルウェアである。<br>
バッチシステムにおいて、ジョブが数個であることは稀であり、通常は数百、ときには数千にいたる場合もある。
そのため、ジョブの関連を定義し、実行スケジュールを管理する専用の仕組みが不可欠になる。</p>
</dd>
<dt class="hdlist1">シェルスクリプト</dt>
<dd>
<p>ジョブを実現する方法の1つ。OSやミドルウェアなどに実装されているコマンドを組み合わせて1つの処理を実現する。<br>
手軽に実装できる反面、複雑なビジネスロジックを記述するには不向きであるため、ファイルのコピー・バックアップ・テーブルクリアなど主にシンプルな処理に用いる。
また、別のプログラミング言語で実装した処理を実行する際に、起動前の設定や実行後の処理だけをシェルスクリプトが担うことも多い。</p>
</dd>
<dt class="hdlist1">プログラミング言語</dt>
<dd>
<p>ジョブを実現する方法の1つ。シェルスクリプトよりも構造化されたコードを記述でき、開発生産性・メンテナンス性・品質などを確保するのに有利である。
そのため、比較的複雑なロジックになりやすいファイルやデータベースのデータを加工するようなビジネスロジックの実装によく使われる。</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_GeneralBatchProcess_Scenario"><a class="anchor" href="#Ch02_GeneralBatchProcess_Scenario"></a>2.1.2. バッチ処理に求められる要件</h4>
<div class="paragraph">
<p>業務処理を実現するために、バッチ処理に求められる要件には以下のようなものがある。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>性能向上</p>
<div class="ulist">
<ul>
<li>
<p>一定量のデータをまとめて処理できる。</p>
</li>
<li>
<p>ジョブを並列/多重に実行できる。</p>
</li>
</ul>
</div>
</li>
<li>
<p>異常発生時のリカバリ</p>
<div class="ulist">
<ul>
<li>
<p>再実行(手動/スケジュール)ができる。</p>
</li>
<li>
<p>再処理した時に、処理済レコードのスキップして、未処理部分だけを処理できる。</p>
</li>
</ul>
</div>
</li>
<li>
<p>多様な起動方式</p>
<div class="ulist">
<ul>
<li>
<p>同期実行ができる。</p>
</li>
<li>
<p>非同期実行ができる。</p>
<div class="ulist">
<ul>
<li>
<p>実行契機としては、DBポーリング、HTTPリクエスト、などがある。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>さまざまな入出力インターフェース</p>
<div class="ulist">
<ul>
<li>
<p>データベース</p>
</li>
<li>
<p>ファイル</p>
<div class="ulist">
<ul>
<li>
<p>CSVやTSVなどの可変長</p>
</li>
<li>
<p>固定長</p>
</li>
<li>
<p>XML</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>上記の要件について具体的な内容を以下に示す。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">大量データを一定のリソースで効率よく処理できる(性能向上)</dt>
<dd>
<p>大量のデータをまとめて処理することで処理時間を短縮する。このとき重要なのは、<strong>「一定のリソースで」</strong>の部分である。<br>
100万件でも1億件でも、一定のCPUやメモリの使用で処理でき、件数に応じて緩やかにかつリニアに処理時間が延びるのが理想である。
まとめて処理するには、一定件数ごとにトランザクションを開始・終了させ、まとめて入出力することで、
使用するリソースを平準化させる仕組みが必要となる。<br>
それでも処理しきれない膨大なデータを相手にする場合は、一歩進んでハードウェアリソースを限界まで使い切る仕組みも追加で必要になる。
処理対象データを件数やグループで分割して、複数プロセス・複数スレッドによって多重処理する。
さらに推し進めて複数マシンによる分散処理をすることもある。
リソースを限界まで使い切る際には、I/Oを限りなく低減することがきわめて重要になる。</p>
</dd>
<dt class="hdlist1">可能な限り処理を継続する(異常発生時のリカバリ)</dt>
<dd>
<p>大量データを処理するにあたって、入力データが異常な場合や、システム自体に異常が発生した場合の防御策を考えておく必要がある。<br>
大量データは必然的に処理し終わるまでに長時間かかるが、エラー発生後に復旧までの時間が長期化すると、システム運用に大きな影響を及ぼしてしまう。<br>
たとえば、1000万件のデータを処理する場合を考える。999万件目でエラーになり、それまでの処理をすべてやり直すとしたら、 運用スケジュールに影響が出てしまうことは明白である。<br>
このような影響を抑えるために、バッチ処理ならではの処理継続性が重要となる。これにはエラーデータをスキップしながら次のデータを処理する仕組み、
処理をリスタートする仕組み、可能な限り自動復旧を試みる仕組み、などが必要となる。また、1つのジョブを極力シンプルなつくりにし、再実行を容易にすることも重要である。</p>
</dd>
<dt class="hdlist1">実行契機に応じて柔軟に実行できる(多様な起動方式)</dt>
<dd>
<p>時刻を契機とする場合、オンラインや外部システムとの連携を契機とした場合など、さまざまな実行契機に対応する仕組みが必要になる。
同期実行ではジョブスケジューラから定時になったら処理を起動する、
非同期実行ではプロセスを常駐させておきイベントに応じて随時バッチ処理を行う、というような
様々な仕組みが一般的に知られている。</p>
</dd>
<dt class="hdlist1">さまざまな入出力インターフェースを扱える(さまざまな入出力インターフェース)</dt>
<dd>
<p>オンラインや外部システムと連携するということは、データベースはもちろん、CSV/XMLといったさまざまなフォーマットのファイルを扱えることが重要となる。
さらに、それぞれの入出力形式を透過的に扱える仕組みがあると実装しやすくなり、複数フォーマットへの対応も迅速に行なえるようになる。</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_GeneralBatchProcess_Considerations"><a class="anchor" href="#Ch02_GeneralBatchProcess_Considerations"></a>2.1.3. バッチ処理で考慮する原則と注意点</h4>
<div class="paragraph">
<p>バッチ処理システムを構築する際に考慮すべき重要な原則、および、いくつかの一般的な考慮事項を示す。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>単一のバッチ処理は可能な限り簡素化し、複雑な論理構造を避ける。</p>
</li>
<li>
<p>処理とデータは物理的に近い場所におく(処理を実行する場所にデータを保存する)。</p>
</li>
<li>
<p>システムリソース(特にI/O)の利用を最小限にし、できるだけインメモリで多くの操作を実行する。</p>
</li>
<li>
<p>また、不要な物理I/Oを避けるため、アプリケーションのI/O(SQLなど)を見直す。</p>
</li>
<li>
<p>複数のジョブで同じ処理を繰り返さない。</p>
<div class="ulist">
<ul>
<li>
<p>たとえば、集計処理とレポート処理がある場合に、レポート処理で集計処理を再度することは避ける。</p>
</li>
</ul>
</div>
</li>
<li>
<p>常にデータの整合性に関しては最悪の事態を想定する。十分なチェックとデータの整合性を維持するために、データの検証を行う。</p>
</li>
<li>
<p>バックアップについて十分に検討する。特にシステムが年中無休で実行されている場合は、バックアップの難易度が高くなる。</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="Ch02_MacchinettaBatchStack"><a class="anchor" href="#Ch02_MacchinettaBatchStack"></a>2.2. Macchinetta Batch Framework (2.x)のスタック</h3>
<div class="sect3">
<h4 id="Ch02_MacchinettaBatchStack_Overview"><a class="anchor" href="#Ch02_MacchinettaBatchStack_Overview"></a>2.2.1. 概要</h4>
<div class="paragraph">
<p>Macchinetta Batch Framework (2.x)の構成について説明し、Macchinetta Batch Framework (2.x)の担当範囲を示す。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_MacchinettaBatchStack_Stack"><a class="anchor" href="#Ch02_MacchinettaBatchStack_Stack"></a>2.2.2. Macchinetta Batch Framework (2.x)のスタック</h4>
<div class="paragraph">
<p>Macchinetta Batch Framework (2.x)で使用するSoftware Frameworkは、
<a href="http://projects.spring.io/spring-framework/">Spring Framework</a> (<a href="http://projects.spring.io/spring-batch/">Spring Batch</a>)
を中心としたOSSの組み合わせである。以下にMacchinetta Batch Framework (2.x)のスタック概略図を示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_MacchinettaBatchStack_Stack.png" alt="Macchinetta Batch Framework (2.x) Stack">
</div>
<div class="title">Macchinetta Batch Framework (2.x)のスタック概略図</div>
</div>
<div class="paragraph">
<p>ジョブスケジューラやデータベースなどの製品についての説明は、本ガイドラインの説明対象外とする。</p>
</div>
<div class="sect4">
<h5 id="Ch02_MacchinettaBatchStack_Stack_OSS"><a class="anchor" href="#Ch02_MacchinettaBatchStack_Stack_OSS"></a>2.2.2.1. 利用するOSSのバージョン</h5>
<div class="paragraph">
<p>Macchinetta Batch Framework (2.x)のバージョン2.0.1.RELEASEで利用するOSSのバージョン一覧を以下に示す。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Macchinetta Batch Framework (2.x)で使用するOSSのバージョンは、原則として、Spring IO platformの定義に準じている。
なお、バージョン2.0.1.RELEASEにおけるSpring IO platformのバージョンは、
<a href="https://docs.spring.io/platform/docs/Brussels-SR5/reference/htmlsingle/">Brussels-SR5</a>である。<br>
Spring IO platformの詳細については、Macchinetta Server Framework (1.x)の
<a href="https://macchinetta.github.io/server-guideline/current/ja//Overview/FrameworkStack.html#oss">利用するOSSのバージョン</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">OSSバージョン一覧</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 15%;">
<col style="width: 5%;">
<col style="width: 5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">GroupId</th>
<th class="tableblock halign-left valign-top">ArtifactId</th>
<th class="tableblock halign-left valign-top">Version</th>
<th class="tableblock halign-left valign-top">Spring IO platform</th>
<th class="tableblock halign-left valign-top">Remarks</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-aop</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.14.RELEASE</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-beans</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.14.RELEASE</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-context</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.14.RELEASE</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.14.RELEASE</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.14.RELEASE</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-tx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.14.RELEASE</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-jdbc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.14.RELEASE</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-batch-core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.0.8.RELEASE</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-batch-infrastructure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.0.8.RELEASE</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Retry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.retry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-retry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.2.1.RELEASE</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.batch-api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0.1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.ibm.jbatch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.ibm.jbatch-tck-spi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatis3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.mybatis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mybatis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.4.5</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatis3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.mybatis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mybatis-spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.3.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatis3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.mybatis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mybatis-typehandlers-jsr310</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.inject</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.inject</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ログ出力</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ch.qos.logback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">logback-classic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1.11</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ログ出力</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ch.qos.logback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">logback-core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1.11</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ログ出力</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.slf4j</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jcl-over-slf4j</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.7.25</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ログ出力</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.slf4j</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">slf4j-api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.7.25</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力チェック</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.validation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">validation-api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1.0.Final</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力チェック</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.hibernate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate-validator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.3.5.Final</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力チェック</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.jboss.logging</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss-logging</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3.1.Final</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力チェック</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.fasterxml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">classmate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.3.4</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">コネクションプール</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.commons</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">commons-dbcp2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.1.1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">コネクションプール</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.commons</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">commons-pool2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.4.2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EL式</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.glassfish</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.el</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.0.0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">インメモリデータベース</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.h2database</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">h2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.4.193</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XML</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.thoughtworks.xstream</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xstream</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.4.10</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.codehaus.jettison</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jettison</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TERASOLUNA Batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.terasoluna.batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">terasoluna-batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.1.1.RELEASE</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="exampleblock">
<div class="title">Remarksについて</div>
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Spring IO platformでサポートしているライブラリが個別に依存しているライブラリ</p>
</li>
<li>
<p>脆弱性対応のため、Spring IO platformのバージョンとは異なるバージョンを設定</p>
</li>
</ol>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">xstreamの標準エラー出力について</div>
<div class="paragraph">
<p>xstreamのバージョンが1.4.10になり、Spring BatchがBean定義を読み込み、ジョブ実行する際に標準エラー出力で以下のメッセージが出力される。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">Security framework of XStream not initialized, XStream is probably vulnerable.</code></pre>
</div>
</div>
<div class="paragraph">
<p>現時点では、Spring BatchでXStreamのセキュリティ設定ができないため、メッセージの出力は抑制できない。</p>
</div>
<div class="paragraph">
<p>開発したジョブBean定義を読み込む以外でXStreamを使用する場合(データ連携など)は、信頼できる生成元のXML以外はXStreamで読み込みを行わないようにすること。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_MacchinettaBatchStack_Components"><a class="anchor" href="#Ch02_MacchinettaBatchStack_Components"></a>2.2.3. Macchinetta Batch Framework (2.x)の構成要素</h4>
<div class="paragraph">
<p>Macchinetta Batch Framework (2.x)のSoftware Framework構成要素について説明する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_MacchinettaBatchStack_Stack_Detail.png" alt="Macchinetta Batch Framework (2.x) Components of Software Framework">
</div>
<div class="title">Software Framework構成要素の概略図</div>
</div>
<div class="paragraph">
<p>以下に、各要素の概要を示す。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">基盤フレームワーク</dt>
<dd>
<p>フレームワークの基盤として、Spring Frameworkを利用する。DIコンテナをはじめ各種機能を活用する。</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.spring.io/spring/docs/4.3.11.RELEASE/spring-framework-reference/htmlsingle/#spring-core">Spring Framework 4.3</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">バッチフレームワーク</dt>
<dd>
<p>バッチフレームワークとして、Spring Batchを利用する。</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.spring.io/spring-batch/trunk/reference/html/index.html">Spring Batch 3.0</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">非同期実行</dt>
<dd>
<p>非同期実行を実現する方法として、以下の機能を利用する。</p>
<div class="dlist">
<dl>
<dt class="hdlist1">DBポーリングによる周期起動</dt>
<dd>
<p>TERASOLUNA Batch Framework for Java (5.x)が提供するライブラリを利用する。</p>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch04_AsyncJobWithDB">"非同期実行(DBポーリング)"</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Webコンテナ起動</dt>
<dd>
<p>Spring MVCを使用して、Spring Batchと連携をする。</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.spring.io/spring/docs/4.3.11.RELEASE/spring-framework-reference/html/mvc.html">Spring MVC 4.3</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">O/R Mapper</dt>
<dd>
<p>MyBatisを利用し、Spring Frameworkとの連携ライブラリとして、MyBatis-Springを使用する。</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.mybatis.org/mybatis-3/">MyBatis 3.4</a></p>
</li>
<li>
<p><a href="http://www.mybatis.org/spring/">MyBatis-Spring</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">ファイルアクセス</dt>
<dd>
<p><a href="http://docs.spring.io/spring-batch/trunk/reference/html/readersAndWriters.html#flatFiles">Spring Batchから提供されている機能</a>
に加えて、補助機能をTERASOLUNA Batch Framework for Java (5.x)が提供する。</p>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess">"ファイルアクセス"</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">ロギング</dt>
<dd>
<p>ロガーはAPIにSLF4J、実装にLogbackを利用する。</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.slf4j.org/">SLF4J</a></p>
</li>
<li>
<p><a href="https://logback.qos.ch/">Logback</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">バリデーション</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1">単項目チェック</dt>
<dd>
<p>単項目チェックにはBean Validationを利用し、実装はHibernate Validatorを使用する。</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://download.oracle.com/otn-pub/jcp/bean_validation-1_1-fr-eval-spec/bean-validation-specification.pdf">Bean Validation 1.1</a></p>
</li>
<li>
<p><a href="http://docs.jboss.org/hibernate/validator/5.3/reference/en-US/html/">Hibernate Validator 5.3</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">相関チェック</dt>
<dd>
<p>相関チェックにはBean Validation、もしくはSpring Validationを利用する。</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.spring.io/spring/docs/4.3.11.RELEASE/spring-framework-reference/html/validation.html#validator">Spring Validation</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">コネクションプール</dt>
<dd>
<p>コネクションプールには、DBCPを利用する。</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://commons.apache.org/proper/commons-dbcp/">DBCP 2</a></p>
</li>
<li>
<p><a href="https://commons.apache.org/proper/commons-pool/">Commons Pool 2</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="Ch02_SpringBatchArch"><a class="anchor" href="#Ch02_SpringBatchArch"></a>2.3. Spring Batchのアーキテクチャ</h3>
<div class="sect3">
<h4 id="Ch02_SpringBatchArch_Overview"><a class="anchor" href="#Ch02_SpringBatchArch_Overview"></a>2.3.1. Overview</h4>
<div class="paragraph">
<p>Macchinetta Server Framework (1.x)の基盤となる、Spring Batchのアーキテクチャについて説明をする。</p>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Overview_SpringBatch"><a class="anchor" href="#Ch02_SpringBatchArch_Overview_SpringBatch"></a>2.3.1.1. Spring Batchとは</h5>
<div class="paragraph">
<p>Spring Batchは、その名のとおりバッチアプリケーションフレームワークである。
SpringがもつDIコンテナやAOP、トランザクション管理機能をベースとして以下の機能を提供している。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">処理の流れを定型化する機能</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1">タスクレットモデル</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1">シンプルな処理</dt>
<dd>
<p>自由に処理を記述する方式である。SQLを1回発行するだけ、コマンドを発行するだけ、といった簡素なケースや
複数のデータベースやファイルにアクセスしながら処理するような複雑で定型化しにくいケースで用いる。</p>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">チャンクモデル</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1">大量データを効率よく処理</dt>
<dd>
<p>一定件数のデータごとにまとめて入力/加工/出力する方式。データの入力/加工/出力といった処理の流れを定型化し、
一部を実装するだけでジョブが実装できる。</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">様々な起動方法</dt>
<dd>
<p>コマンドライン実行、Servlet上で実行、その他のさまざまな契機での実行を実現する。</p>
</dd>
<dt class="hdlist1">様々なデータ形式の入出力</dt>
<dd>
<p>ファイル、データベース、メッセージキューをはじめとするさまざまなデータリソースとの入出力を簡単に行う。</p>
</dd>
<dt class="hdlist1">処理の効率化</dt>
<dd>
<p>多重実行、並列実行、条件分岐を設定ベースで行う。</p>
</dd>
<dt class="hdlist1">ジョブの管理</dt>
<dd>
<p>実行状況の永続化、データ件数を基準にしたリスタートなどを可能にする。</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Overview_HelloWorld"><a class="anchor" href="#Ch02_SpringBatchArch_Overview_HelloWorld"></a>2.3.1.2. Hello, Spring Batch！</h5>
<div class="paragraph">
<p>Spring Batchのアーキテクチャを理解する上で、未だSpring Batchに触れたことがない場合は、
以下の公式ドキュメントを一読するとよい。
Spring Batchを用いた簡単なアプリケーションの作成を通して、イメージを掴んでほしい。</p>
</div>
<div class="paragraph">
<p><a href="https://spring.io/guides/gs/batch-processing/">Creating a Batch Service</a></p>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Overview_BasicStructure"><a class="anchor" href="#Ch02_SpringBatchArch_Overview_BasicStructure"></a>2.3.1.3. Spring Batchの基本構造</h5>
<div class="paragraph">
<p>Spring Batchの基本的な構造を説明する。</p>
</div>
<div class="paragraph">
<p>Spring Batchはバッチ処理の構造を定義している。この構造を理解してから開発を行うことを推奨する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_SpringBatchArchitecture_Overview_MainComponents.png" alt="Spring Batch Main Components">
</div>
<div class="title">Spring Batchに登場する主な構成要素</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Spring Batchに登場する主な構成要素</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">構成要素</th>
<th class="tableblock halign-left valign-top">役割</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Job</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Batchにおけるバッチアプリケーションの一連の処理をまとめた1実行単位。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Step</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jobを構成する処理の単位。1つのJobに1～N個のStepをもたせることが可能。<br>
1つのJobを複数のStepに分割して処理することにより、処理の再利用、並列化、条件分岐が可能になる。
Stepは、チャンクモデルまたはタスクレットモデル(これらについては後述する)のいずれかで実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JobLauncher</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jobを起動するためのインターフェース。<br>
JobLauncherをユーザが直接利用することも可能だが、javaコマンドから<br>
<code>CommandLineJobRunner</code>を起動することでより簡単にバッチ処理を開始できる。
<code>CommandLineJobRunner</code>は、JobLauncherを起動するための各種処理を引き受けてくれる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">ItemReader<br>
ItemProcessor<br>
ItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンクモデルを実装する際に、データの入力/加工/出力の3つに分割するためのインターフェース。<br>
バッチアプリケーションは、この3パターンの処理で構成されることが多いことに由来し、
Spring Batchでは主にチャンクモデルで<br>
これらインターフェースの実装を活用する。
ユーザはビジネスロジックをそれぞれの役割に応じて分割して記述する。<br>
データの入出力を担うItemReaderとItemWriterは、データベースやファイルからJavaオブジェクトへの変換、もしくはその逆の処理であることが多い。
そのため、Spring Batchから標準的な実装が提供されている。
ファイルやデータベースからデータの入出力を行う一般的なバッチアプリケーションの場合は、<br>
Spring Batchの標準実装をそのまま使用するだけで要件を満たせるケースもある。<br>
データの加工を担うItemProcessorは、入力チェックやビジネスロジックを実装する。</p>
<p class="tableblock">タスクレットモデルでは、ItemReader/ItemProcessor/ItemWriterが、1つのTaskletインターフェース実装に置き換わる。Tasklet内に入出力、入力チェック、ビジネスロジックのすべてを実装する必要がある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JobRepository</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JobやStepの状況を管理する機構。これらの管理情報は、Spring Batchが規定するテーブルスキーマを元にデータベース上に永続化される。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_SpringBatchArch_Arch"><a class="anchor" href="#Ch02_SpringBatchArch_Arch"></a>2.3.2. Architecture</h4>
<div class="paragraph">
<p><a href="#Ch02_SpringBatchArch_Overview">Overview</a>ではSpring Batchの基本構造については簡単に説明した。</p>
</div>
<div class="paragraph">
<p>これを踏まえて、以下の点について説明をする。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch02_SpringBatchArch_Arch_ProcessFlow">処理全体の流れ</a></p>
</li>
<li>
<p><a href="#Ch02_SpringBatchArch_Arch_ExecutionOfJob">Jobの起動</a></p>
</li>
<li>
<p><a href="#Ch02_SpringBatchArch_Arch_BusinessLogic">ビジネスロジックの実行</a></p>
</li>
<li>
<p><a href="#Ch02_SpringBatchArch_Arch_MetadataSchema">JobRepositoryのメタデータスキーマ</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>最後に、Spring Batchを利用したバッチアプリケーションの性能チューニングポイントについて説明をする。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch02_SpringBatchArch_Arch_Performance">代表的な性能チューニングポイント</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Arch_ProcessFlow"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_ProcessFlow"></a>2.3.2.1. 処理全体の流れ</h5>
<div class="paragraph">
<p>Spring Batchの主な構成要素と処理全体の流れについて説明をする。
また、ジョブの実行状況などのメタデータがどのように管理されているかについても説明する。</p>
</div>
<div class="paragraph">
<p>Spring Batchの主な構成要素と処理全体の流れ(チャンクモデル)を下図に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch02/SpringBatchArchitecture/Ch02_SpringBatchArchitecture_Architecture_ProcessFlow.png" alt="Spring Batch Process Flow">
</div>
<div class="title">Spring Batchの主な構成要素と処理全体の流れ</div>
</div>
<div class="paragraph">
<p>中心的な処理の流れ(黒線)とジョブ情報を永続化する流れ(赤線)について説明する。</p>
</div>
<div class="olist arabic">
<div class="title">中心的な処理の流れ</div>
<ol class="arabic">
<li>
<p>ジョブスケジューラからJobLauncherが起動される。</p>
</li>
<li>
<p>JobLauncherからJobを実行する。</p>
</li>
<li>
<p>JobからStepを実行する。</p>
</li>
<li>
<p>StepはItemReaderによって入力データを取得する。</p>
</li>
<li>
<p>StepはItemProcessorによって入力データを加工する。</p>
</li>
<li>
<p>StepはItemWriterによって加工されたデータを出力する</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">ジョブ情報を永続化する流れ</div>
<ol class="arabic">
<li>
<p>JobLauncherはJobRepositoryを介してDatabaseにJobInstanceを登録する。</p>
</li>
<li>
<p>JobLauncherはJobRepositoryを介してDatabaseにジョブが実行開始したことを登録する。</p>
</li>
<li>
<p>JobStepはJobRepositoryを介してDatabaseに入出力件数や状態など各種情報を更新する。</p>
</li>
<li>
<p>JobLauncherはJobRepositoryを介してDatabaseにジョブが実行終了したことを登録する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>新たに構成要素と永続化に焦点をあてたJobRepositoryについての説明を以下に示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">永続化に関連する構成要素</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">構成要素</th>
<th class="tableblock halign-left valign-top">役割</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JobInstance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring BatchはJobの「論理的」な実行を示す。JobInstanceをJob名と引数によって識別している。
言い換えると、Job名と引数が同一である実行は、同一JobInstanceの実行と認識し、前回起動時の続きとしてJobを実行する。<br>
対象のJobが再実行をサポートしており、前回実行時にエラーなどで処理が途中で中断していた場合は処理の途中から実行される。
一方、再実行をサポートしていないJobや、対象のJobInstanceがすでに正常に処理が完了している場合は例外が発生し、Javaプロセスが異常終了する。
たとえば、すでに正常に処理が完了している場合はJobInstanceAlreadyCompleteExceptionが発生する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JobExecution<br>
ExecutionContext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JobExecutionはJobの「物理的」な実行を示す。JobInstance とは異なり、同一のJobを再実行する場
合も別のJobExecutionとなる。結果、JobInstanceとJobExecutionは1対多の関係になる。<br>
同一のJobExecution内で処理の進捗状況などのメタデータを共有するための領域として、ExecutionContextがある。
ExecutionContextは主にSpring Batchがフレームワークの状態などを記録するために使用されているが、アプリケーションがExecutionContextへアクセスする手段も提供されている。<br>
JobExecutionContextに格納するオブジェクトは、<code>java.io.Serializable</code>を実装したクラスでなければならない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">StepExecution<br>
ExecutionContext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">StepExecutionはStep の「物理的」な実行を示す。JobExecutionとStepExecutionは1対多の関係になる。<br>
JobExecutionと同様に、Step内でデータを共有するための領域としてExecutionCotnextがある。データの局所化という観点から、
複数のStepで共有しなくてもよい情報はJobのExecutionContextを使用するのでなく、対象StepのExecutionContextを利用したほうがよい。<br>
StepExecutionContextに格納するオブジェクトは、<code>java.io.Serializable</code>を実装したクラスでなければならない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JobRepository</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JobExecutionやStepExecutionなどのバッチアプリケーション実行結果や状態を管理するためのデータを管理、永続化する機能を提供する。<br>
一般的なバッチアプリケーションはJavaプロセスを起動することで処理が開始し、処理の終了ともにJavaプロセスも終了させるケースが多い。
そのためこれらのデータはJavaプロセスを跨いで参照される可能性があることから、揮発性なメモリ上だけではなくデータベースなどの永続層へ格納する。
データベースに格納する場合は、JobExecutionやStepExecutionを格納するためのテーブルやシーケンスなどのデータベースオブジェクトが必要になる。<br>
Spring Batch が提供するスキーマ情報を元に<br>
データベースオブジェクトを生成する必要がある。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Spring Batchが重厚にメタデータの管理を行っている理由は、再実行を実現するためである。
バッチ処理を再実行可能にするには、前回実行時のスナップショットを残しておく必要があり、メタデータやJobRepositoryはそのための基盤となっている。</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Arch_ExecutionOfJob"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_ExecutionOfJob"></a>2.3.2.2. Jobの起動</h5>
<div class="paragraph">
<p>Jobをどのように起動するかについて説明する。</p>
</div>
<div class="paragraph">
<p>Javaプロセス起動直後にバッチ処理を開始し、バッチ処理が完了後にJavaプロセスを終了するケースを考える。
下図にJavaプロセス起動からバッチ処理を開始までについて処理の流れを示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch02/SpringBatchArchitecture/Ch02_SpringBatchArchitecture_Architecture_LaunchFlow.png" alt="Job Launch Flow">
</div>
<div class="title">Javaプロセス起動からバッチ処理を開始までの処理の流れ</div>
</div>
<div class="paragraph">
<div class="title">Javaプロセスの起動とJobの開始</div>
<p>Javaプロセス起動と同時に、Spring Batch上で定義されたJobを開始するためには、Javaを起動するシェルスクリプトを記述するのが一般的である。
Spring Batchが提供するCommandLineJobRunnerを使用すると、ユーザが定義したSpring Batch上のJobを簡単に起動することができる。</p>
</div>
<div class="paragraph">
<p>CommandLineJobRunnerを使用したジョブの起動コマンドは以下のとおりである。</p>
</div>
<div class="listingblock">
<div class="title">XMLによるBean定義を行った場合の起動コマンド</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">java -cp ${CLASSPATH} org.springframework.batch.core.launch.support.CommandLineJobRunner &lt;jobPath&gt; &lt;jobName&gt; &lt;JobArgumentName1&gt;=&lt;value1&gt; &lt;JobArgumentName2&gt;=&lt;value2&gt; ...</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">ジョブパラメータの指定</div>
<p>CommandLineJobRunnerは起動するJob名だけでなく、引数(ジョブパラメータ)を渡すことも可能である。
引数は前述した例のように、<code>&lt;Job引数名&gt;=&lt;値&gt;</code>の形式で指定する。
すべての引数はCommandLineJobRunnerやJobLauncherが解釈とチェックを行なったうえで、JobExecutionへJobParametersに変換して格納する。
詳細は<a href="#Ch04_JobParameter">ジョブの起動パラメータ</a>を参照のこと。</p>
</div>
<div class="paragraph">
<div class="title">JobInstanceの登録と復元</div>
<p>JobLauncherがJobRepositoryからJob名と引数に合致するJobInstanceをデータベースから取得する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>該当するJobInstanceが存在しない場合は、JobInstanceを新規登録する。</p>
</li>
<li>
<p>該当するJobInstanceが存在した場合は、紐付いているJobExecutionを復元する。<br></p>
<div class="ulist">
<ul>
<li>
<p>Spring Batchでは日次実行など繰り返して起動する可能性のあるJobに対しては、JobInstanceをユニークにするためだけの引数を追加する方法がとられている。
たとえば、システム時刻であったり、乱数を引数に追加する方法が挙げられる。<br>
本ガイドラインで推奨している方法については<a href="#Ch04_JobParameter_HowToUse_Converter">パラメータ変換クラスについて</a>を参照。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Arch_BusinessLogic"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_BusinessLogic"></a>2.3.2.3. ビジネスロジックの実行</h5>
<div class="paragraph">
<p>Spring Batchでは、JobをStepと呼ぶさらに細かい単位に分割する。
Jobが起動すると、Jobは自身に登録されているStepを起動し、StepExecutionを生成する。
Stepはあくまで処理を分割するための枠組みであり、ビジネスロジックの実行はStepから呼び出されるTaskletに任されている。</p>
</div>
<div class="paragraph">
<p>StepからTaskletへの流れを以下に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch02/SpringBatchArchitecture/Ch02_SpringBatchArchitecture_Architecture_StepTaskletFlow.png" alt="Step-Tasklet Flow">
</div>
<div class="title">StepからTaskletへの処理の流れ</div>
</div>
<div class="paragraph">
<p>Taskletの実装方法には「チャンクモデル」と「タスクレットモデル」の2つの方式がある。
概要についてはすでに説明しているため、ここではその構造について説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch02_SpringBatchArch_Arch_BusinessLogic_Chunk"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_BusinessLogic_Chunk"></a>2.3.2.3.1. チャンクモデル</h6>
<div class="paragraph">
<p>前述したようにチャンクモデルとは、処理対象となるデータを1件ずつ処理するのではなく、一定数の塊(チャンク)を単位として処理を行う方式である。
ChunkOrientedTaskletがチャンク処理をサポートしたTaskletの具象クラスとなる。
このクラスがもつcommit-intervalという設定値により、チャンクに含めるデータの最大件数(以降、「チャンク数」と呼ぶ)を調整することができる。
ItemReader、ItemProcessor、ItemWriterは、いずれもチャンク処理を前提としたインターフェースとなっている。</p>
</div>
<div class="paragraph">
<p>次に、ChunkOrientedTasklet がどのようにItemReader、ItemProcessor、ItemWriterを呼び出しているかを説明する。</p>
</div>
<div class="paragraph">
<p>ChunkOrientedTaskletが1つのチャンクを処理するシーケンス図を以下に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_SpringBatchArchitecture_Architecture_Sequence_ChunkOrientedTasklet.png" alt="Sequence of Chunk processing with ChunkOrientedTasklet">
</div>
<div class="title">ChunkOrientedTaskletによるチャンク処理</div>
</div>
<div class="paragraph">
<p>ChunkOrientedTaskletは、チャンク数分だけItemReaderおよびItemProcessor、すなわちデータの読み込みと加工を繰り返し実行する。
チャンク数分のデータすべての読み込みが完了してから、ItemWriterのデータ書き込み処理が1回だけ呼び出され、チャンクに含まれるすべての加工済みデータが渡される。
データの更新処理がチャンクに対して1回呼び出されるように設計されているのは、JDBCのaddBatch、executeBatchのようにI/Oをまとめやすくするためである。</p>
</div>
<div class="paragraph">
<p>次に、チャンク処理において実際の処理を担うItemReader、ItemProcessor、ItemWriterについて紹介する。
各インターフェースともユーザが独自に実装を行うことが想定されているが、Spring Batchが提供する汎用的な具象クラスでまかなうことができる場合がある。</p>
</div>
<div class="paragraph">
<p>特にItemProcessorはビジネスロジックそのものが記述されることが多いため、Spring Batchからは具象クラスがあまり提供されていない。
ビジネスロジックを記述する場合はItemProcessorインターフェースを実装する。
ItemProcessorはタイプセーフなプログラミングが可能になるよう、入出力で使用するオブジェクトの型をそれぞれ型引数に指定できるようになっている。</p>
</div>
<div class="paragraph">
<p>以下に簡単なItemProcessorの実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">ItemProcessorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyItemProcessor</span> <span class="directive">implements</span>
      ItemProcessor&lt;MyInputObject, MyOutputObject&gt; {  <span class="comment">// (1)</span>
  <span class="annotation">@Override</span>
    <span class="directive">public</span> MyOutputObject process(MyInputObject item) <span class="directive">throws</span> <span class="exception">Exception</span> {  <span class="comment">// (2)</span>

        MyOutputObject processedObject = <span class="keyword">new</span> MyOutputObject();  <span class="comment">// (3)</span>

        <span class="comment">// Coding business logic for item of input data</span>

    <span class="keyword">return</span> processedObject; <span class="comment">// (4)</span>
  }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入出力で使用するオブジェクトの型をそれぞれ型引数に指定したItemProcessorインターフェースを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>process</code>メソッドを実装する。引数のitemが入力データである。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力オブジェクトを作成し、入力データのitemに対して処理したビジネスロジックの結果を格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力オブジェクトを返却する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>ItemReaderやItemWriterは様々な具象クラスがSpring Batchから提供されており、それらを利用することで十分な場合が多い。
しかし、特殊な形式のファイルを入出力したりする場合は、独自のItemReaderやItemWriterを実装した具象クラスを作成し使用することができる。</p>
</div>
<div class="paragraph">
<p>実際のアプリケーション開発時におけるビジネスロジックの実装に関しては、<a href="#Ch03">アプリケーション開発の流れ</a>を参照。</p>
</div>
<div class="paragraph">
<p>最後にSpring Batchが提供するItemReader、ItemProcessor、ItemWriterの代表的な具象クラスを示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Spring Batchが提供するItemReader、ItemProcessor、ItemWriterの代表的な具象クラス</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 25%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">インターフェース</th>
<th class="tableblock halign-left valign-top">具象クラス名</th>
<th class="tableblock halign-left valign-top">概要</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle" rowspan="5"><p class="tableblock">ItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FlatFileItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CSVファイルなどの、フラットファイル(非構造的なファイル)の読み込みを行う。Resourceオブジェクトをインプットとし、区切り文字やオブジェクトへのマッピングルールをカスタマイズすることができる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">StaxEventItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XMLファイルの読み込みを行う。名前のとおり、StAXをベースとしたXMLファイルの読み込みを行う実装となっている。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JdbcPagingItemReader<br>
JdbcCursorItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDBCを使用してSQLを実行し、データベース上のレコードを読み込む。データベース上にある大量のデータを処理する場合は、全件をメモリ上に読み込むことを避け、一度の処理に必要なデータのみの読み込み、破棄を繰り返す必要がある。<br>
JdbcPagingItemReaderはJdbcTemplateを用いてSELECT SQLをページごとに分けて発行することで実現する。一方、JdbcCursorItemReaderはJDBCのカーソルを使用することで、1回のSELECT SQLの発行で実現する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Macchinetta Batch 2.xではMyBatisを利用することを基本とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">MyBatisCursorItemReader<br>
MyBatisPagingItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatisと連携してデータベース上のレコードを読み込む。MyBatisが提供しているSpring連携ライブラリMyBatis-Springから提供されている。PagingとCursorの違いについては、MyBatisを利用して実現していること以外はJdbcXXXItemReaderと同様。<br>
その他に、JPA実装やHibernateなどと連携してデータベース上のレコードを読み込むJpaPagingItemReader、HibernatePagingItemReader、
HibernateCursorItemReaderが提供されている。
<span class="icon"><i class="fa fa-warning"></i></span> Macchinetta Batch 2.xでは<code>MyBatisCursorItemReader</code>を利用することを基本とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JmsItemReader<br>
AmqpItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JMSやAMQPからメッセージを受信し、その中に含まれるデータの読み込みを行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle" rowspan="3"><p class="tableblock">ItemProcessor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PassThroughItemProcessor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">何も行なわない。入力データの加工や修正が不要な場合に使用する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">ValidatingItemProcessor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力チェックを行う。入力チェックルールの実装には、Spring Batch独自の<br>
org.springframework.batch.item.validator.Validatorを実装する必要がある。<br>
しかし、Springから提供されている汎用的なorg.springframework.validation.ValidatorへのアダプタであるSpringValidatorが提供されており、
org.springframework.validation.Validatorのルールを利用できる。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Macchinetta Batch 2.xではValidatingItemProcessorの利用は禁止している。<br>
詳細は、<a href="#Ch06_InputValidation">入力チェック</a>を参照。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">CompositeItemProcessor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">同一の入力データに対し、複数のItemProcessorを逐次的に実行する。ValidatingItemProcessorによる入力チェックの後にビジネスロジックを実行したい場合などに有効。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle" rowspan="5"><p class="tableblock">ItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FlatFileItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理済みのJavaオブジェクトを、CSVファイルなどのフラットファイルとして書き込みを行う。区切り文字やオブジェクトからファイル行へのマッピングルールをカスタマイズできる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">StaxEventItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理済みのJavaオブジェクトをXMLファイルとして書き込みを行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JdbcBatchItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDBCを使用してSQLを実行し、処理済みのJavaオブジェクトをデータベースへ出力する。内部ではJdbcTemplateが使用されている。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">MyBatisBatchItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatisと連携して、処理済みのJavaオブジェクトをデータベースへ出力する。MyBatisが提供しているSpring連携ライブラリMyBatis-Springから提供されている。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Macchinetta Batch 2.xでは、JPA実装やHibernate向けのJpaItemWriter、HibernateItemWriterは利用しない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JmsItemWriter<br>
AmqpItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理済みのJavaオブジェクトを、JMSやAMQPでメッセージを送信する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">PassThroughItemProcessorの省略</div>
<div class="paragraph">
<p>XMLでジョブを定義する場合は、ItemProcessorの設定を省略することができる。
省略した場合、PassThroughItemProcessorと同様に何もせずに入力データをItemWriterへ受け渡すことになる。</p>
</div>
<div class="listingblock">
<div class="title">ItemProcessorの省略</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exampleJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exampleStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch02_SpringBatchArch_Arch_BusinessLogic_Tasklet"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_BusinessLogic_Tasklet"></a>2.3.2.3.2. タスクレットモデル</h6>
<div class="paragraph">
<p>チャンクモデルは、複数の入力データを1件ずつ読み込み、一連の処理を行うバッチアプリケーションに適した枠組みとなっている。
しかし、時にはチャンク処理の型に当てはまらないような処理を実装することもある。
たとえば、システムコマンドを実行したり、制御用テーブルのレコードを1件だけ更新したいような場合などである。</p>
</div>
<div class="paragraph">
<p>そのような場合には、チャンク処理によって得られる性能面のメリットが少なく、
設計や実装を困難にするデメリットの方が大きいため、タスクレットモデルを使用するほうが合理的である。</p>
</div>
<div class="paragraph">
<p>タスクレットモデルを使用する場合は、Spring Batchから提供されているTaskletインターフェースをユーザが実装する必要がある。
また、Spring Batchでは以下の具象クラスが提供されているが、Macchinetta Batch 2.xでは以降説明しない。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Spring Batchが提供するTaskletの具象クラス</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">クラス名</th>
<th class="tableblock halign-left valign-top">概要</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">SystemCommandTasklet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">非同期にシステムコマンドを実行するためのTasklet。commandプロパティに実行したいコマンドを指定する。<br>
システムコマンドは呼び出し元のスレッドと別スレッドで実行されるため、タイムアウトを設定したり、処理中にシステムコマンドの実行スレッドをキャンセルすることも可能である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">MethodInvokingTaskletAdapter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">POJOクラスに定義された特定のメソッドを実行するためのTasklet。targetObjectプロパティに対象クラスのBeanを、targetMethodプロパティに実行させたいメソッド名を指定する。<br>
POJOクラスはバッチ処理の終了した状態をメソッドの返り値として返却することができるが、その場合は後述するExitStatusをメソッドの返り値とする必要がある。
他の型で返り値を返却した場合は、返り値の内容にかかわらず正常終了した(ExitStatus.COMPLETED)とみなされる。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Arch_MetadataSchema"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_MetadataSchema"></a>2.3.2.4. JobRepositoryのメタデータスキーマ</h5>
<div class="paragraph">
<p>JobRepositoryのメタデータスキーマについて説明する。</p>
</div>
<div class="paragraph">
<p>なお、Spring Batchのリファレンス
<a href="http://docs.spring.io/spring-batch/trunk/reference/html/metaDataSchema.html">Appendix B. Meta-Data Schema</a>
にて説明されている内容も含めて、全体像を説明する。</p>
</div>
<div class="paragraph">
<p>Spring Batchメタデータテーブルは、Javaでそれらを表すドメインオブジェクト(Entityオブジェクト)に対応している。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">対応一覧</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">テーブル</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entityオブジェクト</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">概要</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_JOB_INSTANCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JobInstance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ名、およびジョブパラメータをシリアライズした文字列を保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_JOB_EXECUTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JobExecution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの状態・実行結果を保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_JOB_EXECUTION_PARAMS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JobExecutionParams</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">起動時に与えられたジョブパラメータを保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_JOB_EXECUTION_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JobExecutionContext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ内部のコンテキストを保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_STEP_EXECUTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">StepExecution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの状態・実行結果、コミット・ロールバック件数を保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_STEP_EXECUTION_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">StepExecutionContext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップ内部のコンテキストを保持する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>JobRepositoryは、各Javaオブジェクトに保存された内容を、テーブルへ正確に格納する責任がある。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">メタデータテーブルへ格納する文字列について</div>
<div class="paragraph">
<p>メタデータテーブルへ格納する文字列には文字数の制限があり、制限を超えた分の文字列を切り捨てる。<br>
またSpring Batchではマルチバイト文字を考慮しておらず、Spring Batchが提供するメタデータテーブルのDDLでは格納する文字列が制限に収まる文字数でもエラーになる可能性がある。
マルチバイト文字を格納するためには、メタデータテーブルのカラムを使用するエンコーディングによってサイズ拡張したり、文字データ型を文字数定義に設定する必要がある。</p>
</div>
<div class="paragraph">
<p>Spring Batchが提供する<code>Oracle Schema</code>は、データベースの文字データ型はバイト数定義がデフォルト設定となるため、
Macchinetta Batch 2.xでは、明示的に文字データ型を文字数定義に設定するOracle用のDDLを提供する。<br>
提供するDDLは、Macchinetta Batch 2.xのjarに同梱されているorg.terasoluna.batchパッケージに含まれている。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>6つの全テーブルと相互関係のERDモデルはを以下に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_SpringBatchArchitecture_Architecture_ER.png" alt="ER Diagram">
</div>
<div class="title">ER図</div>
</div>
<div class="sect5">
<h6 id="Ch02_SpringBatchArch_Arch_MetadataSchema_Version"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_MetadataSchema_Version"></a>2.3.2.4.1. バージョン</h6>
<div class="paragraph">
<p>データベーステーブルの多くは、バージョンカラムが含まれている。
Spring Batchは、データベースへの更新を扱う楽観的ロック戦略を採用しているため、このカラムは重要となる。
このレコードは、バージョンカラムの値がインクリメントされるたびに更新されることを意味している。
JobRepositoryが値の更新時に、バージョン番号が変更されている場合、同時アクセスのエラーが発生したことを示すOptimisticLockingFailureExceptionがスローされる。
別のバッチジョブは異なるマシンで実行されているかもしれないが、それらはすべて同じデータベーステーブルを使用しているため、このチェックが必要となる。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch02_SpringBatchArch_Arch_MetadataSchema_SequenceID"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_MetadataSchema_SequenceID"></a>2.3.2.4.2. ID(シーケンス)定義</h6>
<div class="paragraph">
<p>BATCH_JOB_INSTANCE、BATCH_JOB_EXECUTION、およびBATCH_STEP_EXECUTIONは各_IDで終わる列が含まれている。
これらのフィールドは、それぞれのテーブル用主キーとして機能する。
しかし、それらは、データベースで生成されたキーではなく、むしろ個別のシーケンスで生成される。
データベースにドメインオブジェクトのいずれかを挿入した後、それが与えられたキーは、それらが一意にJavaで識別できるように、実際のオブジェクトに設定する必要なためである。<br>
データベースによってはシーケンスをサポートしていないことがある。この場合、テーブルを各シーケンスの代わりに使用している。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition"></a>2.3.2.4.3. テーブル定義</h6>
<div class="paragraph">
<p>各テーブルの項目について説明をする。</p>
</div>
<div class="sect6">
<h7 id="Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition_JobInstance"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition_JobInstance"></a>BATCH_JOB_INSTANCE</h7>
<div class="paragraph">
<p>BATCH_JOB_INSTANCEテーブルはJobInstanceに関連するすべての情報を保持し、全体的な階層の最上位である。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">BATCH_JOB_INSTANCEの定義</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">カラム名</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_INSTANCE_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">インスタンスを識別する一意のIDで主キーである。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VERSION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch02_SpringBatchArch_Arch_MetadataSchema_Version">バージョン</a>を参照。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの名前。 インスタンスを識別するために必要とされるので非nullである。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">同じジョブを別々のインスタンスとして一意に識別するためのシリアライズ化されたJobParameters。<br>
同じジョブ名をもつJobInstancesは、異なるJobParameters(つまり、異なるJOB_KEY値)をもつ必要がある。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition_JobExecution"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition_JobExecution"></a>BATCH_JOB_EXECUTION</h7>
<div class="paragraph">
<p>BATCH_JOB_EXECUTIONテーブルはJobExecutionオブジェクトに関連するすべての情報を保持する。
ジョブが実行されるたびに、常に新しいJobExecutionでこの表に新しい行が登録される。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">BATCH_JOB_EXECUTIONの定義</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">カラム名</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">一意にこのジョブ実行を識別する主キー。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VERSION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch02_SpringBatchArch_Arch_MetadataSchema_Version">バージョン</a>を参照。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_INSTANCE_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このジョブ実行が属するインスタンスを示すBATCH_JOB_INSTANCEテーブルからの外部キー。
インスタンスごとに複数の実行が存在する場合がある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CREATE_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ実行が作成された時刻。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">START_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ実行が開始された時刻。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">END_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ実行が成功または失敗に関係なく、終了した時刻を表す。<br>
ジョブが現在実行されていないにもかかわらず、このカラムの値が空であることは、いくつかのエラータイプがあり、フレームワークが最後のセーブを実行できなかったことを示す。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ実行のステータスを表す文字列。BatchStatus列挙オブジェクトが出力する文字列である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXIT_CODE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ実行の終了コードを表す文字列。 CommandLineJobRunnerによる起動の場合、これを数値に変換することができる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXIT_MESSAGE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブが終了した状態をより詳細に説明する文字列。
障害が発生した場合には、可能であればスタックトレースをできるだけ多く含む文字列となる場合がある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LAST_UPDATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このレコードのジョブ実行が最後に更新された時刻。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition_JobExecutionParams"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition_JobExecutionParams"></a>BATCH_JOB_EXECUTION_PARAMS</h7>
<div class="paragraph">
<p>BATCH_JOB_EXECUTION_PARAMSテーブルは、JobParametersオブジェクトに関連するすべての情報を保持する。
これはジョブに渡された0以上のキーと値とのペアが含まれ、ジョブが実行されたパラメータを記録する役割を果たす。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">BATCH_JOB_EXECUTION_PARAMSの定義</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">カラム名</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このジョブパラメータが属するジョブ実行を示すBATCH_JOB_EXECUTIONテーブルからの外部キー。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TYPE_CD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String、date、long、またはdoubleのいずれかのデータ型であることを示す文字列。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KEY_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">パラメータキー。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRING_VAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データ型が文字列である場合のパラメータ値。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATE_VAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データ型が日時である場合のパラメータ値。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LONG_VAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データ型が整数値である場合のパラメータ値。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DOUBLE_VAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データ型が実数である場合のパラメータ値。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IDENTIFYING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">パラメータがジョブインスタンスが一意であることを識別するための値であることを示すフラグ。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition_JobExecutionContext"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition_JobExecutionContext"></a>BATCH_JOB_EXECUTION_CONTEXT</h7>
<div class="paragraph">
<p>BATCH_JOB_EXECUTION_CONTEXTテーブルは、JobのExecutionContextに関連するすべての情報を保持する。
特定のジョブ実行に必要とされるジョブレベルのデータがすべて含まれている。
このデータは、ジョブが失敗した後で処理を再処理する際に取得しなければならない状態を表し、失敗したジョブが「処理を中断したところから始める」ことを可能にする。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">BATCH_JOB_EXECUTION_CONTEXTの定義</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">カラム名</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このJobのExecutionContextが属するジョブ実行を示すBATCH_JOB_EXECUTIONテーブルからの外部キー。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SHORT_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SERIALIZED_CONTEXTの文字列表現。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SERIALIZED_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">シリアライズされたコンテキスト全体。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition_StepExecution"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition_StepExecution"></a>BATCH_STEP_EXECUTION</h7>
<div class="paragraph">
<p>BATCH_STEP_EXECUTIONテーブルは、StepExecutionオブジェクトに関連するすべての情報を保持する。
このテーブルには、BATCH_JOB_EXECUTIONテーブルと多くの点で非常に類似しており、各JobExecutionが作られるごとに常にStepごとに少なくとも1つのエントリがある。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">BATCH_STEP_EXECUTIONの定義</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">カラム名</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STEP_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">一意にこのステップ実行を識別する主キー。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VERSION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch02_SpringBatchArch_Arch_MetadataSchema_Version">バージョン</a>を参照。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STEP_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの名前。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このStepExecutionが属するJobExecutionを示すBATCH_JOB_EXECUTIONテーブルからの外部キー。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">START_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップ実行が開始された時刻。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">END_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップ実行が成功または失敗に関係なく、終了した時刻を表す。<br>
ジョブが現在実行されていないにもかかわらず、このカラムの値が空であることは、いくつかのエラータイプがあり、フレームワークが最後のセーブを実行できなかったことを示す。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップ実行のステータスを表す文字列。BatchStatus列挙オブジェクトが出力する文字列である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">COMMIT_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクションをコミットしている回数。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">READ_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReaderで読み込んだデータ件数。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FILTER_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessorでフィルタリングしたデータ件数。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WRITE_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriterで書き込んだデータ件数。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">READ_SKIP_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReaderでスキップしたデータ件数。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WRITE_SKIP_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriterでスキップしたデータ件数。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PROCESS_SKIP_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessorでスキップしたデータ件数。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ROLLBACK_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクションをロールバックしている回数。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXIT_CODE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップ実行の終了コードを表す文字列。 CommandLineJobRunnerによる起動の場合、これを数値に変換することができる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXIT_MESSAGE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップが終了した状態をより詳細に説明する文字列。
障害が発生した場合には、可能であればスタックトレースをできるだけ多く含む文字列となる場合がある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LAST_UPDATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このレコードのステップ実行が最後に更新された時刻。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition_StepExecutionContext"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_MetadataSchema_TableDefinition_StepExecutionContext"></a>BATCH_STEP_EXECUTION_CONTEXT</h7>
<div class="paragraph">
<p>BATCH_STEP_EXECUTION_CONTEXTテーブルは、StepのExecutionContext に関連するすべての情報を保持する。
特定のステップ実行に必要とされるステップレベルのデータがすべて含まれている。
このデータは、ジョブが失敗した後で処理を再処理する際に取得しなければならない状態を表し、失敗したジョブが「処理を中断したところから始める」ことを可能にする。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">BATCH_STEP_EXECUTION_CONTEXTの定義</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">カラム名</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STEP_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このStepのExecutionContextが属するジョブ実行を示すBATCH_STEP_EXECUTIONテーブルからの外部キー。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SHORT_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SERIALIZED_CONTEXTの文字列表現。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SERIALIZED_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">シリアライズされたコンテキスト全体。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch02_SpringBatchArch_Arch_MetadataSchema_DDL"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_MetadataSchema_DDL"></a>2.3.2.4.4. DDLスクリプト</h6>
<div class="paragraph">
<p>Spring Batch CoreのJARファイルには、いくつかのデータベースプラットフォームに応じたリレーショナル表を作成するサンプルスクリプトが含まれている。
これらのスクリプトはそのまま使用、または必要に応じて追加のインデックスと制約を変更することができる。<br>
スクリプトは、org.springframework.batch.coreのパッケージに含まれており、ファイル名は、<code>schema-*.sql</code>で形成されている。
"*"は、ターゲット・データベース・プラットフォームの短い名前である。</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Arch_Performance"><a class="anchor" href="#Ch02_SpringBatchArch_Arch_Performance"></a>2.3.2.5. 代表的な性能チューニングポイント</h5>
<div class="paragraph">
<p>Spring Batchにおける代表的な性能チューニングポイントを説明する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンクサイズの調整</dt>
<dd>
<p>リソースへの出力によるオーバヘッドを抑えるために、チャンクサイズを大きくする。<br>
ただし、チャンクサイズを大きくしすぎるとリソース側の負荷が高くなりかえって性能が低下することがあるので、
適度なサイズになるように調整を行う。</p>
</dd>
<dt class="hdlist1">フェッチサイズの調整</dt>
<dd>
<p>リソースからの入力によるオーバヘッドを抑えるために、リソースに対するフェッチサイズ(バッファサイズ)を大きくする。</p>
</dd>
<dt class="hdlist1">ファイル読み込みの効率化</dt>
<dd>
<p>BeanWrapperFieldSetMapperを使用すると、Beanのクラスとプロパティ名を順番に指定するだけでレコードをBeanにマッピングしてくれる。
しかし、内部で複雑な処理を行うため時間がかかる。マッピングを行う専用のFieldSetMapperインターフェース実装を用いることで処理時間を短縮できる可能性がある。<br>
ファイル入出力の詳細は、<a href="#Ch05_FileAccess">"ファイルアクセス"</a>を参照。</p>
</dd>
<dt class="hdlist1">並列処理・多重処理</dt>
<dd>
<p>Spring Batchでは、Step実行の並列化、データ分割による多重処理をサポートしている。並列化もしくは多重化を行い、処理を並列走行させることで性能を改善できる。
しかし、並列数および多重数を大きくしすぎるとリソース側の負荷が高くなりかえって性能が低下することがあるので、適度なサイズになるように調整を行う。<br>
並列処理・多重処理の詳細は、<a href="#Ch08_ParallelAndMultiple">"並列処理と多重処理"</a>を参照。</p>
</dd>
<dt class="hdlist1">分散処理の検討</dt>
<dd>
<p>Spring Batchでは、複数マシンでの分散処理もサポートしている。指針は、並列処理・多重処理と同様である。<br>
分散処理は、基盤設計や運用設計が複雑化するため、本ガイドラインでは説明を行わない。</p>
</dd>
</dl>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch02_MacchinettaBatchArch"><a class="anchor" href="#Ch02_MacchinettaBatchArch"></a>2.4. Macchinetta Batch Framework (2.x)のアーキテクチャ</h3>
<div class="sect3">
<h4 id="Ch02_MacchinettaBatchArch_Overview"><a class="anchor" href="#Ch02_MacchinettaBatchArch_Overview"></a>2.4.1. 概要</h4>
<div class="paragraph">
<p>Macchinetta Batch Framework (2.x)のアーキテクチャ全体像を説明する。</p>
</div>
<div class="paragraph">
<p>Macchinetta Batch Framework (2.x)では、<a href="#Ch02_GeneralBatchProcess">"一般的なバッチ処理システム"</a>で説明したとおり
TERASOLUNA Batch Framework for Java (5.x)を中心としたOSSの組み合わせを利用して実現する。</p>
</div>
<div class="paragraph">
<p>TERASOLUNA Batch Framework for Java (5.x)の階層アーキテクチャを含めたMacchinetta Batch Framework (2.x)の構成概略図を以下に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_MacchinettaBatchArchitecture_Stack.png" alt="Macchinetta Batch Framework (2.x) Stack">
</div>
<div class="title">Macchinetta Batch Framework (2.x)の構成概略図</div>
</div>
<div class="dlist">
<div class="title">Spring Batchの階層アーキテクチャの説明</div>
<dl>
<dt class="hdlist1">アプリケーション</dt>
<dd>
<p>開発者によって書かれたすべてのジョブ定義およびビジネスロジック。</p>
</dd>
<dt class="hdlist1">コア</dt>
<dd>
<p>TERASOLUNA Batch Framework for Java (5.x) が提供するバッチジョブを起動し、制御するために必要なコア・ランタイム・クラス。</p>
</dd>
<dt class="hdlist1">インフラストラクチャ</dt>
<dd>
<p>TERASOLUNA Batch Framework for Java (5.x) が提供する開発者およびコアフレームワーク自体が利用する一般的なItemReader/ItemProcessor/ItemWriterの実装。</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_MacchinettaBatchArch_JobComponents"><a class="anchor" href="#Ch02_MacchinettaBatchArch_JobComponents"></a>2.4.2. ジョブの構成要素</h4>
<div class="paragraph">
<p>ジョブの構成要素を説明するため、ジョブの構成概略図を下記に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_MacchinettaBatchArchitecture_JobComponents.png" alt="Job Components">
</div>
<div class="title">ジョブの構成概略図</div>
</div>
<div class="paragraph">
<p>この節では、ジョブとステップについて構成すべき粒度の指針も含めて説明をする。</p>
</div>
<div class="sect4">
<h5 id="Ch02_MacchinettaBatchArch_Overview_Job"><a class="anchor" href="#Ch02_MacchinettaBatchArch_Overview_Job"></a>2.4.2.1. ジョブ</h5>
<div class="paragraph">
<p>ジョブとは、バッチ処理全体をカプセル化するエンティティであり、ステップを格納するためのコンテナである。<br>
1つのジョブは、1つ以上のステップで構成することができる。</p>
</div>
<div class="paragraph">
<p>ジョブの定義は、XMLによるBean定義ファイルに記述する。
ジョブ定義ファイルには複数のジョブを定義することができるが、ジョブの管理が煩雑になりやすくなる。</p>
</div>
<div class="paragraph">
<p>従って、Macchinetta Batch Framework (2.x)では以下の指針とする。</p>
</div>
<div class="paragraph">
<p><span class="icon"><i class="fa fa-tags"></i></span> 1ジョブ=1ジョブ定義ファイル</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_MacchinettaBatchArch_Overview_Step"><a class="anchor" href="#Ch02_MacchinettaBatchArch_Overview_Step"></a>2.4.2.2. ステップ</h5>
<div class="paragraph">
<p>ステップとは、バッチ処理を制御するために必要な情報を定義したものである。
ステップにはチャンクモデルとタスクレットモデルを定義することができる。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンクモデル</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>ItemReader、ItemProcessor、およびItemWriterで構成される。</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">タスクレットモデル</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Taskletだけで構成される。</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p><a href="#Ch02_GeneralBatchProcess_Considerations">"バッチ処理で考慮する原則と注意点"</a>にあるとおり、
単一のバッチ処理では、可能な限り簡素化し、複雑な論理構造を避ける必要がある。</p>
</div>
<div class="paragraph">
<p>従って、Macchinetta Batch Framework (2.x)では以下の指針とする。</p>
</div>
<div class="paragraph">
<p><span class="icon"><i class="fa fa-tags"></i></span> 1ステップ=1バッチ処理=1ビジネスロジック</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">チャンクモデルでのビジネスロジック分割</div>
<div class="paragraph">
<p>1つのビジネスロジックが複雑で規模が大きくなる場合、ビジネスロジックを分割することがある。
概略図を見るとわかるとおり、1つのステップには1つのItemProcessorしか設定できないため、ビジネスロジックの分割ができないように思える。
しかし、CompositeItemProcssorという複数のItemProcessorをまとめるItemProcessorがあり、
この実装を使うことでビジネスロジックを分割して実行することができる。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_MacchinettaBatchArch_StepImpl"><a class="anchor" href="#Ch02_MacchinettaBatchArch_StepImpl"></a>2.4.3. ステップの実装方式</h4>
<div class="sect4">
<h5 id="Ch02_MacchinettaBatchArch_StepImpl_ChunkOriented"><a class="anchor" href="#Ch02_MacchinettaBatchArch_StepImpl_ChunkOriented"></a>2.4.3.1. チャンクモデル</h5>
<div class="paragraph">
<p>チャンクモデルの定義と使用目的を説明する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">定義</dt>
<dd>
<p>ItemReader、ItemProcessorおよびItemWriter実装とチャンク数をChunkOrientedTaskletに設定する。それぞれの役割を説明する。</p>
<div class="ulist">
<ul>
<li>
<p>ChunkOrientedTasklet･･･ItemReader/ItemProcessorを呼び出し、チャンクを作成する。作成したチャンクをItemWriterへ渡す。</p>
</li>
<li>
<p>ItemReader･･･入力データを読み込む。</p>
</li>
<li>
<p>ItemProcessor･･･読み込んだデータを加工する。</p>
</li>
<li>
<p>ItemWriter･･･加工されたデータをチャンク単位で出力する。</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"></dt>
<dd>
<p>チャンクモデルの概要は、 <a href="#Ch02_SpringBatchArch_Arch_BusinessLogic_Chunk">"チャンクモデル"</a> を参照。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">チャンクモデルのジョブ設定例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exampleJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exampleStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">processor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">使用目的</dt>
<dd>
<p>一定件数のデータをまとめて処理を行うため、大量データを取り扱う場合に用いられる。</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_MacchinettaBatchArch_StepImpl_TaskletOriented"><a class="anchor" href="#Ch02_MacchinettaBatchArch_StepImpl_TaskletOriented"></a>2.4.3.2. タスクレットモデル</h5>
<div class="paragraph">
<p>タスクレットモデルの定義・使用目的を説明する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">定義</dt>
<dd>
<p>Tasklet実装だけを設定する。<br>
タスクレットモデルの概要は、 <a href="#Ch02_SpringBatchArch_Arch_BusinessLogic_Tasklet">"タスクレットモデル"</a> を参照。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">タスクレットモデルのジョブ設定例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exampleJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exampleStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">使用目的</dt>
<dd>
<p>システムコマンドの実行など、入出力を伴わない処理を実行するために用いられる。<br>
また、一括でデータをコミットしたい場合にも用いられる。</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_MacchinettaBatchArch_StepImpl_diffOfChunkAndTasklet"><a class="anchor" href="#Ch02_MacchinettaBatchArch_StepImpl_diffOfChunkAndTasklet"></a>2.4.3.3. チャンクモデルとタスクレットモデルの機能差</h5>
<div class="paragraph">
<p>チャンクモデルとタスクレットモデルの機能差について説明する。
詳細については各機能の節を参照してもらい、ここでは概略のみにとどめる。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">機能差一覧</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">機能</th>
<th class="tableblock halign-left valign-top">チャンクモデル</th>
<th class="tableblock halign-left valign-top">タスクレットモデル</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">構成要素</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader/ItemProcessor/ItemWriter/ChunkOrientedTaskletで構成される。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Taksletのみで構成される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクション</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンク単位にトランザクションが発生する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1トランザクションで処理する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">推奨する再処理方式</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リラン、リスタートを利用できる。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リランのみ利用することを原則とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外ハンドリング</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リスナーを使うことでハンドリング処理が容易になっている。独自実装も可能である。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">独自実装が必要である。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_MacchinettaBatchArch_LaunchMethod"><a class="anchor" href="#Ch02_MacchinettaBatchArch_LaunchMethod"></a>2.4.4. ジョブの起動方式</h4>
<div class="paragraph">
<p>ジョブの起動方式について説明する。ジョブの起動方式には以下のものがある。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch02_MacchinettaBatchArch_LaunchMethod_Sync">同期実行方式</a></p>
</li>
<li>
<p><a href="#Ch02_MacchinettaBatchArch_LaunchMethod_Async">非同期実行方式</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>それぞれの起動方式について説明する。</p>
</div>
<div class="sect4">
<h5 id="Ch02_MacchinettaBatchArch_LaunchMethod_Sync"><a class="anchor" href="#Ch02_MacchinettaBatchArch_LaunchMethod_Sync"></a>2.4.4.1. 同期実行方式</h5>
<div class="paragraph">
<p>同期実行方式とは、ジョブを起動してからジョブが終了するまで起動元へ制御が戻らない実行方式である。</p>
</div>
<div class="paragraph">
<p>ジョブスケジューラからジョブを起動する概略図を示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_MacchinettaBatchArchitecture_SynchronizedExec.png" alt="Synchronized Execution">
</div>
<div class="title">同期実行概略図</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ジョブスケジューラからジョブを起動するためのシェルスクリプトを起動する。<br>
シェルスクリプトから終了コード(数値)が返却するまでジョブスケジューラは待機する。</p>
</li>
<li>
<p>シェルスクリプトからジョブを起動するために<code>CommandLineJobRunner</code>を起動する。<br>
<code>CommandLineJobRunner</code>から終了コード(数値)が返却するまでシェルスクリプトは待機する。</p>
</li>
<li>
<p><code>CommandLineJobRunner</code>はジョブを起動する。ジョブは処理終了後に終了コード(文字列)を<code>CommandLineJobRunner</code>へ返却する。<br>
<code>CommandLineJobRunner</code>は、ジョブから返却された終了コード(文字列)から終了コード(数値)に変換してシェルスクリプトへ返却する。</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_MacchinettaBatchArch_LaunchMethod_Async"><a class="anchor" href="#Ch02_MacchinettaBatchArch_LaunchMethod_Async"></a>2.4.4.2. 非同期実行方式</h5>
<div class="paragraph">
<p>非同期実行方式とは、起動元とは別の実行基盤(別スレッドなど)でジョブを実行することで、ジョブ起動後すぐに起動元へ制御が戻る方式である。
この方式の場合、ジョブの実行結果はジョブ起動とは別の手段で取得する必要がある。</p>
</div>
<div class="paragraph">
<p>Macchinetta Batch Framework (2.x)では、以下に示す2とおりの方法について説明をする。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch02_MacchinettaBatchArch_LaunchMethod_Async_DB">非同期実行方式(DBポーリング)</a></p>
</li>
<li>
<p><a href="#Ch02_MacchinettaBatchArch_LaunchMethod_Async_Web">非同期実行方式(Webコンテナ)</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">その他の非同期実行方式</div>
<div class="paragraph">
<p>MQなどのメッセージを利用して非同期実行を実現することもできるが、ジョブ実行のポイントは同じであるため、Macchinetta Batch Framework (2.x)では説明は割愛する。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="Ch02_MacchinettaBatchArch_LaunchMethod_Async_DB"><a class="anchor" href="#Ch02_MacchinettaBatchArch_LaunchMethod_Async_DB"></a>2.4.4.2.1. 非同期実行方式(DBポーリング)</h6>
<div class="paragraph">
<p><a href="#Ch04_AsyncJobWithDB">"非同期実行(DBポーリング)"</a>とは、
ジョブ実行の要求をデータベースに登録し、その要求をポーリングして、ジョブを実行する方式である。</p>
</div>
<div class="paragraph">
<p>Macchinetta Batch Framework (2.x)で利用しているTERASOLUNA Batch Framework for Java (5.x)は、DBポーリング機能を提供している。提供しているDBポーリングによる起動の概略図を示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_MacchinettaBatchArchitecture_ASynchronized_DBPolling.png" alt="DB Polling">
</div>
<div class="title">DBポーリング概略図</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ユーザはデータベースへジョブ要求を登録する。</p>
</li>
<li>
<p>DBポーリング機能は、定期的にジョブ要求の登録を監視していて、登録されたことを検知すると該当するジョブを実行する。</p>
<div class="ulist">
<ul>
<li>
<p>SimpleJobOperatorからジョブを起動し、ジョブ終了後に<code>JobExecutionId</code>を受け取る。</p>
</li>
<li>
<p>JobExecutionIdとは、ジョブ実行を一意に識別するIDであり、このIDを使ってJobRepositoryから実行結果を参照する。</p>
</li>
<li>
<p>ジョブの実行結果は、Spring Batchの仕組みによって、JobRepositoryへ登録される。</p>
</li>
<li>
<p>DBポーリング自体が非同期で実行されている。</p>
</li>
</ul>
</div>
</li>
<li>
<p>DBポーリング機能は、SimpleJobOperatorから返却されたJobExecutionIdとスタータスを起動したジョブ要求に対して更新を行う。</p>
</li>
<li>
<p>ジョブの処理経過・結果は、JobExecutionIdを利用して別途参照を行う。</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="Ch02_MacchinettaBatchArch_LaunchMethod_Async_Web"><a class="anchor" href="#Ch02_MacchinettaBatchArch_LaunchMethod_Async_Web"></a>2.4.4.2.2. 非同期実行方式(Webコンテナ)</h6>
<div class="paragraph">
<p><a href="#Ch04_AsyncJobWithWeb">"非同期実行(Webコンテナ)"</a>とは、
Webコンテナ上のWebアプリケーションへのリクエストを契機にジョブを非同期実行する方式である。
Webアプリケーションは、ジョブの終了を待たずに起動後すぐにレスポンスを返却することができる。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_MacchinettaBatchArchitecture_ASynchronized_WebContainer.png" alt="Web Container">
</div>
<div class="title">Webコンテナ概略図</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>クライアントからWebアプリケーションへリクエストを送信する。</p>
</li>
<li>
<p>Webアプリケーションは、リクエストから要求されたジョブを非同期実行する。</p>
<div class="ulist">
<ul>
<li>
<p>SimpleJobOperatorからジョブを起動直後に<code>JobExecutionId</code>を受け取る。</p>
</li>
<li>
<p>ジョブの実行結果は、Spring Batchの仕組みによって、JobRepositoryへ登録される。</p>
</li>
</ul>
</div>
</li>
<li>
<p>Webアプリケーションは、ジョブの終了を待たずにクライアントへレスポンスを返信する。</p>
</li>
<li>
<p>ジョブの処理経過・結果は、JobExecutionIdを利用して別途参照を行う。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>また、 <a href="https://macchinetta.github.io/server-guideline/current/ja//">Macchinetta Server Framework (1.x)</a>で構築されるWebアプリケーションと連携することも可能である。</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_MacchinettaBatchArch_DecisionPoints"><a class="anchor" href="#Ch02_MacchinettaBatchArch_DecisionPoints"></a>2.4.5. 利用する際の検討ポイント</h4>
<div class="paragraph">
<p>Macchinetta Batch Framework (2.x)を利用する際の検討ポイントを示す。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ジョブ起動方法</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#Ch02_MacchinettaBatchArch_LaunchMethod_Sync">同期実行方式</a></dt>
<dd>
<p>スケジュールどおりにジョブを起動したり、複数のジョブを組み合わせてバッチ処理行う場合に利用する。</p>
</dd>
<dt class="hdlist1"><a href="#Ch02_MacchinettaBatchArch_LaunchMethod_Async_DB">非同期実行方式(DBポーリング)</a></dt>
<dd>
<p>ディレード処理、処理時間が短いジョブの連続実行、大量ジョブの集約などに利用する。</p>
</dd>
<dt class="hdlist1"><a href="#Ch02_MacchinettaBatchArch_LaunchMethod_Async_Web">非同期実行方式(Webコンテナ)</a></dt>
<dd>
<p>DBポーリングと同様だが、起動までの即時性が求められる場合にはこちらを利用する。</p>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">実装方式</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#Ch02_MacchinettaBatchArch_StepImpl_ChunkOriented">チャンクモデル</a></dt>
<dd>
<p>大量データを効率よく処理したい場合に利用する。</p>
</dd>
<dt class="hdlist1"><a href="#Ch02_MacchinettaBatchArch_StepImpl_TaskletOriented">タスクレットモデル</a></dt>
<dd>
<p>シンプルな処理や、定型化しにくい処理、データを一括で処理したい場合に利用する。</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch03"><a class="anchor" href="#Ch03"></a>3. アプリケーション開発の流れ</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch03_CreateProject"><a class="anchor" href="#Ch03_CreateProject"></a>3.1. バッチアプリケーションの開発</h3>
<div class="paragraph">
<p>バッチアプリケーションの開発について、以下の流れで説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch03_CreateProject_blank">ブランクプロジェクトとは</a></p>
</li>
<li>
<p><a href="#Ch03_CreateProject_HowToCreate">プロジェクトの作成</a></p>
</li>
<li>
<p><a href="#Ch03_CreateProject_ProjectStructure">プロジェクトの構成</a></p>
</li>
<li>
<p><a href="#Ch03_CreateProject_Make">開発の流れ</a></p>
</li>
<li>
<p><a href="#Ch03_CreateProject_BuildAndExec_Build">アプリケーションのビルド</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="Ch03_CreateProject_blank"><a class="anchor" href="#Ch03_CreateProject_blank"></a>3.1.1. ブランクプロジェクトとは</h4>
<div class="paragraph">
<p>ブランクプロジェクトとは、Spring BatchやMyBatis3をはじめとする各種設定を予め行った開発プロジェクトの雛形であり、
アプリケーション開発のスタート地点である。<br>
本ガイドラインでは、シングルプロジェクト構成のブランクプロジェクトを提供する。<br>
構成の説明については、<a href="#Ch03_CreateProject_ProjectStructure">プロジェクトの構成</a>を参照のこと。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Macchinetta Server 1.xとの違い</div>
<div class="paragraph">
<p>Macchinetta Server 1.xはマルチプロジェクト構成を推奨している。
この理由は主に、以下の様なメリットを享受するためである。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>環境差分の吸収しやすくする</p>
</li>
<li>
<p>ビジネスロジックとプレゼンテーションを分離しやすくする</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>しかし、本ガイドラインではMacchinetta Server 1.xと異なりシングルプロジェクト構成としている。</p>
</div>
<div class="paragraph">
<p>これは、前述の点はバッチアプリケーションの場合においても考慮すべきだが、
シングルプロジェクト構成にすることで1ジョブに関連する資材を近づけることを優先している。<br>
また、バッチアプリケーションの場合、
環境差分はプロパティファイルや環境変数で切替れば十分なケースが多いことも理由の1つである。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateProject_HowToCreate"><a class="anchor" href="#Ch03_CreateProject_HowToCreate"></a>3.1.2. プロジェクトの作成</h4>
<div class="paragraph">
<p><code>Maven Archetype Plugin</code>の<code>archetype:generate</code>を使用して、プロジェクトを作成する方法を説明する。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">作成環境の前提について</div>
<div class="paragraph">
<p>以下を前提とし説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java SE Development Kit 8</p>
</li>
<li>
<p>Apache Maven 3.x</p>
<div class="ulist">
<ul>
<li>
<p>インターネットに繋がっていること</p>
</li>
<li>
<p>インターネットにプロキシ経由で繋ぐ場合は、Mavenのプロキシ設定 が行われていること</p>
</li>
</ul>
</div>
</li>
<li>
<p>IDE</p>
<div class="ulist">
<ul>
<li>
<p>Spring Tool Suite / Eclipse 等</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>プロジェクトを作成するディレクトリにて、以下のコマンドを実行する。</p>
</div>
<div class="listingblock">
<div class="title">コマンドプロンプト(Windows)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;mvn archetype:generate ^
  -DarchetypeGroupId=com.github.macchinetta.blank ^
  -DarchetypeArtifactId=macchinetta-batch-archetype ^
  -DarchetypeVersion=2.0.1.RELEASE</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bash(Unix, Linux, &#8230;&#8203;)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ mvn archetype:generate \
  -DarchetypeGroupId=com.github.macchinetta.blank \
  -DarchetypeArtifactId=macchinetta-batch-archetype \
  -DarchetypeVersion=2.0.1.RELEASE</code></pre>
</div>
</div>
<div class="paragraph">
<p>その後、利用者の状況に合わせて、以下を対話式に設定する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>groupId</p>
</li>
<li>
<p>artifactId</p>
</li>
<li>
<p>version</p>
</li>
<li>
<p>package</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以下の値を設定し実行した例を示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">ブランクプロジェクトの各要素の説明</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項目名</th>
<th class="tableblock halign-left valign-top">設定例</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">groupId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.example.batch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">artifactId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0.0-SNAPSHOT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.example.batch</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">コマンドプロンプトでの実行例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;mvn archetype:generate ^
More? -DarchetypeGroupId=com.github.macchinetta.blank ^
More? -DarchetypeArtifactId=macchinetta-batch-archetype ^
More? -DarchetypeVersion=2.0.1.RELEASE
[INFO] Scanning for projects&#8230;&#8203;
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Maven Stub Project (No POM) 1
[INFO] ------------------------------------------------------------------------

(.. omitted)

Define value for property 'groupId': com.example.batch
Define value for property 'artifactId': batch
Define value for property 'version' 1.0-SNAPSHOT: : 1.0.0-SNAPSHOT
Define value for property 'package' com.example.batch: :
Confirm properties configuration:
groupId: com.example.batch
artifactId: batch
version: 1.0.0-SNAPSHOT
package: com.example.batch
 Y: : y
[INFO] ------------------------------------------------------------------------
[INFO] Using following parameters for creating project from Archetype: macchinetta-batch-archetype:2.0.1.RELEASE
[INFO] ------------------------------------------------------------------------
[INFO] Parameter: groupId, Value: com.example.batch
[INFO] Parameter: artifactId, Value: batch
[INFO] Parameter: version, Value: 1.0.0-SNAPSHOT
[INFO] Parameter: package, Value: com.example.batch
[INFO] Parameter: packageInPathFormat, Value: com/example/batch
[INFO] Parameter: package, Value: com.example.batch
[INFO] Parameter: version, Value: 1.0.0-SNAPSHOT
[INFO] Parameter: groupId, Value: com.example.batch
[INFO] Parameter: artifactId, Value: batch
[INFO] Project created from Archetype in dir: C:\xxx\batch
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 36.952 s
[INFO] Finished at: 2017-07-25T14:23:42+09:00
[INFO] Final Memory: 14M/129M
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bashでの実行例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ mvn archetype:generate \
&gt; -DarchetypeGroupId=com.github.macchinetta.blank \
&gt; -DarchetypeArtifactId=macchinetta-batch-archetype \
&gt; -DarchetypeVersion=2.0.1.RELEASE
[INFO] Scanning for projects&#8230;&#8203;
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Maven Stub Project (No POM) 1
[INFO] ------------------------------------------------------------------------

(.. omitted)

Define value for property 'groupId': com.example.batch
Define value for property 'artifactId': batch
Define value for property 'version' 1.0-SNAPSHOT: : 1.0.0-SNAPSHOT
Define value for property 'package' com.example.batch: :
Confirm properties configuration:
groupId: com.example.batch
artifactId: batch
version: 1.0.0-SNAPSHOT
package: com.example.batch
 Y: : y
[INFO] ----------------------------------------------------------------------------
[INFO] Using following parameters for creating project from Archetype: macchinetta-batch-archetype:2.0.1.RELEASE
[INFO] ----------------------------------------------------------------------------
[INFO] Parameter: groupId, Value: com.example.batch
[INFO] Parameter: artifactId, Value: batch
[INFO] Parameter: version, Value: 1.0.0-SNAPSHOT
[INFO] Parameter: package, Value: com.example.batch
[INFO] Parameter: packageInPathFormat, Value: com/example/batch
[INFO] Parameter: package, Value: com.example.batch
[INFO] Parameter: version, Value: 1.0.0-SNAPSHOT
[INFO] Parameter: groupId, Value: com.example.batch
[INFO] Parameter: artifactId, Value: batch
[INFO] Project created from Archetype in dir: C:\xxx\batch
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 01:19 min
[INFO] Finished at: 2017-07-25T14:20:09+09:00
[INFO] Final Memory: 17M/201M
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>以上により、プロジェクトの作成が完了した。</p>
</div>
<div class="paragraph">
<p>正しく作成出来たかどうかは、以下の要領で確認できる。</p>
</div>
<div class="listingblock">
<div class="title">コマンドプロンプトでの実行(正しく作成できたことの確認)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;mvn clean dependency:copy-dependencies -DoutputDirectory=lib package
C:\xxx&gt;java -cp &quot;lib/*;target/*&quot; ^
org.springframework.batch.core.launch.support.CommandLineJobRunner ^
META-INF/jobs/job01.xml job01</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bashでの実行(正しく作成できたことの確認)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ mvn clean dependency:copy-dependencies -DoutputDirectory=lib package
$ java -cp 'lib/*:target/*' \
org.springframework.batch.core.launch.support.CommandLineJobRunner \
META-INF/jobs/job01.xml job01</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下の出力が得られれば正しく作成できている。</p>
</div>
<div class="listingblock">
<div class="title">コマンドプロンプトでの出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;mvn clean dependency:copy-dependencies -DoutputDirectory=lib package
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Macchinetta Batch Framework (2.x) Blank Project 1.0.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------

(.. omitted)

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 11.007 s
[INFO] Finished at: 2017-07-25T14:24:36+09:00
[INFO] Final Memory: 23M/165M
[INFO] ------------------------------------------------------------------------

C:\xxx&gt;java -cp &quot;lib/*;target/*&quot; ^
More? org.springframework.batch.core.launch.support.CommandLineJobRunner ^
More? META-INF/jobs/job01.xml job01

(.. omitted)

[2017/07/25 14:25:22] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=job01]] launched with the following parameters: [{jsr_batch_run_id=1}]
[2017/07/25 14:25:22] [main] [o.s.b.c.j.SimpleStepHandler] [INFO ] Executing step: [job01.step01]
[2017/07/25 14:25:23] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=job01]] completed with the following parameters: [{jsr_batch_run_id=1}] and the following status: [COMPLETED]
[2017/07/25 14:25:23] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@62043840: startup date [Tue Jul 25 14:25:20 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bashでの出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ mvn clean dependency:copy-dependencies -DoutputDirectory=lib package
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Macchinetta Batch Framework (2.x) Blank Project 1.0.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------

(.. omitted)

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 10.827 s
[INFO] Finished at: 2017-07-25T14:21:19+09:00
[INFO] Final Memory: 27M/276M
[INFO] ------------------------------------------------------------------------

$ java -cp 'lib/*:target/*' \
&gt; org.springframework.batch.core.launch.support.CommandLineJobRunner \
&gt; META-INF/jobs/job01.xml job01
[2017/07/25 14:21:49] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Refreshing org.springframework.context.support.ClassPathXmlApplicationContext@62043840: startup date [Tue Jul 25 14:21:49 JST 2017]; root of context hierarchy

(.. omitted)

[2017/07/25 14:21:52] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=job01]] launched with the following parameters: [{jsr_batch_run_id=1}]
[2017/07/25 14:21:52] [main] [o.s.b.c.j.SimpleStepHandler] [INFO ] Executing step: [job01.step01]
[2017/07/25 14:21:52] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=job01]] completed with the following parameters: [{jsr_batch_run_id=1}] and the following status: [COMPLETED]
[2017/07/25 14:21:52] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@62043840: startup date [Tue Jul 25 14:21:49 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateProject_ProjectStructure"><a class="anchor" href="#Ch03_CreateProject_ProjectStructure"></a>3.1.3. プロジェクトの構成</h4>
<div class="paragraph">
<p>前述までで作成したプロジェクトの構成について説明する。
プロジェクトは、以下の点を考慮した構成となっている。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>起動方式に依存しないジョブの実装を実現する</p>
</li>
<li>
<p>Spring BatchやMyBatisといった各種設定の手間を省く</p>
</li>
<li>
<p>環境依存の切替を容易にする</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以下に構成を示し、各要素について説明する。<br>
(わかりやすさのため、前述の<code>mvn archetype:generate</code>実行時の出力を元に説明する。)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch03_CreateProject_BlankProjectDir.png" alt="BlankProject Structure">
</div>
<div class="title">プロジェクトのディレクトリ構造</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">ブランクプロジェクトの各要素の説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バッチアプリケーション全体の各種クラスを格納するrootパッケージ。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1ジョブに関する各種クラスを格納するパッケージ。<br>
ここには、DTO、TaskletやProcessorの実装、MyBatis3のMapperインターフェースを格納する。<br>
本ガイドラインでは格納方法に制約は設けないので、これは一例として参考にしてほしい。</p>
<p class="tableblock">初期状態を参考にユーザにて自由にカスタムしてよいが、
ジョブ固有の資材を判断しやすくすることに配慮してほしい。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バッチアプリケーション全体に関わる設定ファイル。<br>
初期状態では、データベースの接続や、非同期実行に関する設定を記述している。
ユーザにて、自由に追記してよい。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logback(ログ出力)の設定ファイル。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BeanValidationを用いた入力チェックにて、エラーとなった際に表示するメッセージを定義する設定ファイル。<br>
初期状態では、BeanValidationと、その実装であるHibernateValidatorのデフォルトメッセージを定義したうえで、
すべてコメントアウトしている。<br>
この状態ではデフォルトメッセージを使うため、メッセージをカスタマイズしたい場合にのみ
コメントインし任意のメッセージに修正すること。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatis3のMapperインターフェースの対となるMapper XMLファイル。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">主にログ出力時に用いるメッセージを定義するプロパティファイル。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ固有のBean定義ファイルを格納するディレクトリ。<br>
階層構造はジョブ数に応じて自由に構成してよい。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バッチアプリケーション全体に関わるBean定義ファイルを格納するディレクトリ。<br>
Spring BatchやMyBatisの初期設定や、同期/非同期といった起動契機に依らずにジョブを起動するための設定を行っている。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">非同期実行(DBポーリング)機能に関連する設定を記述したBean定義ファイル。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ固有のBean定義ファイルにてimportすることで、各種設定を削減するためのBean定義ファイル。<br>
これをimportすることで、ジョブは起動契機によるBean定義の差を吸収することが出来る。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Batchの挙動や、ジョブ共通の設定に対するBean定義ファイル。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>また、各ファイルの関連図を以下に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch03_CreateProject_FilesRelation.png" alt="Files Relation">
</div>
<div class="title">各ファイルの関連図</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateProject_Make"><a class="anchor" href="#Ch03_CreateProject_Make"></a>3.1.4. 開発の流れ</h4>
<div class="paragraph">
<p>ジョブを開発する一連の流れについて説明する。<br>
ここでは、詳細な説明ではなく、大まかな流れを把握することを主眼とする。</p>
</div>
<div class="sect4">
<h5 id="Ch03_CreateProject_Make_ImportToIDE"><a class="anchor" href="#Ch03_CreateProject_Make_ImportToIDE"></a>3.1.4.1. IDEへの取り込み</h5>
<div class="paragraph">
<p>生成したプロジェクトはMavenのプロジェクト構成に従っているため、
各種IDEによって、Mavenプロジェクトとしてimportする。<br>
詳細な手順は割愛する。</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch03_CreateProject_Make_Setting"><a class="anchor" href="#Ch03_CreateProject_Make_Setting"></a>3.1.4.2. アプリケーション全体の設定</h5>
<div class="paragraph">
<p>ユーザの状況に応じて以下をカスタマイズする。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch03_CreateProject_Make_Setting_POM">pom.xmlのプロジェクト情報</a></p>
</li>
<li>
<p><a href="#Ch03_CreateProject_Make_Setting_DB">データベース関連の設定</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これら以外の設定をカスタマイズする方法については、個々の機能にて説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch03_CreateProject_Make_Setting_POM"><a class="anchor" href="#Ch03_CreateProject_Make_Setting_POM"></a>3.1.4.2.1. pom.xmlのプロジェクト情報</h6>
<div class="paragraph">
<p>プロジェクトのPOMには以下の情報が仮の値で設定されているため、状況に応じて設定すること。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>プロジェクト名(name要素)</p>
</li>
<li>
<p>プロジェクト説明(description要素)</p>
</li>
<li>
<p>プロジェクトURL(url要素)</p>
</li>
<li>
<p>プロジェクト創設年(inceptionYear要素)</p>
</li>
<li>
<p>プロジェクトライセンス(licenses要素)</p>
</li>
<li>
<p>プロジェクト組織(organization要素)</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="Ch03_CreateProject_Make_Setting_DB"><a class="anchor" href="#Ch03_CreateProject_Make_Setting_DB"></a>3.1.4.2.2. データベース関連の設定</h6>
<div class="paragraph">
<p>データベース関連の設定は複数箇所にあるため、それぞれを修正すること。</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.h2database<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>h2<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;scope&gt;</span>runtime<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>

<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.postgresql<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>postgresql<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;scope&gt;</span>runtime<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">batch-application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt"># (2)
# Admin DataSource settings.
admin.jdbc.driver=org.h2.Driver
admin.jdbc.url=jdbc:h2:mem:batch-admin;DB_CLOSE_DELAY=-1
admin.jdbc.username=sa
admin.jdbc.password=

# (2)
# Job DataSource settings.
#jdbc.driver=org.postgresql.Driver
#jdbc.url=jdbc:postgresql://localhost:5432/postgres
#jdbc.username=postgres
#jdbc.password=postgres
jdbc.driver=org.h2.Driver
jdbc.url=jdbc:h2:mem:batch;DB_CLOSE_DELAY=-1
jdbc.username=sa
jdbc.password=

# (3)
# Spring Batch schema initialize.
data-source.initialize.enabled=true
spring-batch.schema.script=classpath:org/springframework/batch/core/schema-h2.sql
terasoluna-batch.commit.script=classpath:org/terasoluna/batch/async/db/schema-commit.sql</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">META-INF/spring/launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;jdbc:initialize-database</span> <span class="attribute-name">data-source</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminDataSource</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${data-source.initialize.enabled:false}</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">ignore-failures</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${spring-batch.schema.script}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${terasoluna-batch.commit.script}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/jdbc:initialize-database&gt;</span>

<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp2.BasicDataSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:driverClassName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.jdbc.driver}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.jdbc.url}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.jdbc.username}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.jdbc.password}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxTotal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:minIdle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxWaitMillis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:defaultAutoCommit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp2.BasicDataSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:driverClassName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.driver}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.url}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.username}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.password}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxTotal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:minIdle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxWaitMillis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:defaultAutoCommit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.SqlSessionFactoryBean</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:dataSource-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">configuration</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.ibatis.session.Configuration</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:localCacheScope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STATEMENT</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:lazyLoadingEnabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:aggressiveLazyLoading</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:defaultFetchSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:defaultExecutorType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REUSE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">META-INF/spring/async-batch-daemon.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminSqlSessionFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.SqlSessionFactoryBean</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:dataSource-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminDataSource</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">configuration</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.ibatis.session.Configuration</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:localCacheScope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STATEMENT</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:lazyLoadingEnabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:aggressiveLazyLoading</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:defaultFetchSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:defaultExecutorType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REUSE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">データベース関連の設定における各要素の説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pom.xmlでは利用するデータベースへの接続に使用するJDBCドライバの依存関係を定義する。<br>
初期状態ではH2 Database(インメモリデータベース)とPostgreSQLが設定されているが、必要に応じて追加削除を行うこと。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDBCドライバの接続設定をする。<br>
- <code>admin.jdbc.xxx</code>はSpring BatchやMacchinetta Batch 2.xが利用する<br>
- <code>jdbc.xxx～</code>はジョブ個別が利用する<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring BatchやMacchinetta Batch 2.xが利用するデータベースの初期化処理を実行するか否か、および、利用するスクリプトを定義する。<br>
Spring Batchは<strong>JobRepository</strong>にアクセスするため、データベースが必須となる。
また、Macchinetta Batch 2.xは<strong>非同期実行(DBポーリング)</strong>にて<strong>ジョブ要求テーブル</strong>にアクセスするため、
データベースが必須となる。<br>
有効にするか否かは、以下を基準とするとよい。<br>
- H2 Databaseを利用する場合は有効にする。無効にすると<strong>JobRepository</strong>や<strong>ジョブ要求テーブル</strong>にアクセスできずエラーになる。<br>
- H2 Databaseを利用しない場合は事故を予防するために無効にする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データソースの設定をする。<br>
必要に応じて接続数等をチューニングする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatisの挙動を設定する。<br>
必要に応じてフェッチサイズ等をチューニングする。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateProject_CreateJob"><a class="anchor" href="#Ch03_CreateProject_CreateJob"></a>3.1.5. ジョブの作成</h4>
<div class="paragraph">
<p>ジョブの作成方法は、以下を参照のこと。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch03_CreateChunkJob">チャンクモデルジョブの作成</a></p>
</li>
<li>
<p><a href="#Ch03_CreateTaskletJob">タスクレットモデルジョブの作成</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateProject_BuildAndExec"><a class="anchor" href="#Ch03_CreateProject_BuildAndExec"></a>3.1.6. プロジェクトのビルドと実行</h4>
<div class="paragraph">
<p>プロジェクトのビルドと実行について説明する。</p>
</div>
<div class="sect4">
<h5 id="Ch03_CreateProject_BuildAndExec_Build"><a class="anchor" href="#Ch03_CreateProject_BuildAndExec_Build"></a>3.1.6.1. アプリケーションのビルド</h5>
<div class="paragraph">
<p>プロジェクトのルートディレクトリに移動し、以下のコマンドを発行する。</p>
</div>
<div class="listingblock">
<div class="title">ビルド(Windows/Bash)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ mvn clean dependency:copy-dependencies -DoutputDirectory=lib package</code></pre>
</div>
</div>
<div class="paragraph">
<p>これにより、以下が生成される。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>&lt;ルートディレクトリ&gt;/target/[artifactId]-[version].jar</p>
<div class="ulist">
<ul>
<li>
<p>作成したバッチアプリケーションのJarが生成される</p>
</li>
</ul>
</div>
</li>
<li>
<p>&lt;ルートディレクトリ&gt;/lib/(依存Jarファイル)</p>
<div class="ulist">
<ul>
<li>
<p>依存するJarファイル一式がコピーされる</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>試験環境や商用環境へ配備する際は、これらのJarファイルを任意のディレクトリにコピーすればよい。</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch03_CreateProject_BuildAndExec_BuildPerEnv"><a class="anchor" href="#Ch03_CreateProject_BuildAndExec_BuildPerEnv"></a>3.1.6.2. 環境に応じた設定ファイルの切替</h5>
<div class="paragraph">
<p>プロジェクトのpom.xmlでは、初期値として以下のProfileを設定している。</p>
</div>
<div class="listingblock">
<div class="title">pom.xmlのProfiles設定</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;profiles&gt;</span>
    <span class="comment">&lt;!-- Including application properties and log settings into package. (default) --&gt;</span>
    <span class="tag">&lt;profile&gt;</span>
        <span class="tag">&lt;id&gt;</span>IncludeSettings<span class="tag">&lt;/id&gt;</span>
        <span class="tag">&lt;activation&gt;</span>
            <span class="tag">&lt;activeByDefault&gt;</span>true<span class="tag">&lt;/activeByDefault&gt;</span>
        <span class="tag">&lt;/activation&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;exclude-property</span><span class="tag">/&gt;</span>
            <span class="tag">&lt;exclude-log</span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/profile&gt;</span>

    <span class="comment">&lt;!-- Excluding application properties and log settings into package. --&gt;</span>
    <span class="tag">&lt;profile&gt;</span>
        <span class="tag">&lt;id&gt;</span>ExcludeSettings<span class="tag">&lt;/id&gt;</span>
        <span class="tag">&lt;activation&gt;</span>
            <span class="tag">&lt;activeByDefault&gt;</span>false<span class="tag">&lt;/activeByDefault&gt;</span>
        <span class="tag">&lt;/activation&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;exclude-property&gt;</span>batch-application.properties<span class="tag">&lt;/exclude-property&gt;</span>
            <span class="tag">&lt;exclude-log&gt;</span>logback.xml<span class="tag">&lt;/exclude-log&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/profile&gt;</span>
<span class="tag">&lt;/profiles&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ここでは、<code>環境依存となる設定ファイルを含めるかどうか</code>を切替ている。
この設定を活用して、環境配備の際に設定ファイルを別途配置することで環境差分を吸収することができる。
また、これを応用して、試験環境と商用環境でJarに含める設定ファイルを変えることもできる。
以下に、一例を示す。</p>
</div>
<div class="listingblock">
<div class="title">環境ごとに設定ファイルを切替えるpom.xmlの記述例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;build&gt;</span>
    <span class="tag">&lt;resources&gt;</span>
        <span class="tag">&lt;resource&gt;</span>
            <span class="tag">&lt;directory&gt;</span>src/main/resources<span class="tag">&lt;/directory&gt;</span>
        <span class="tag">&lt;/resource&gt;</span>
        <span class="tag">&lt;resource&gt;</span>
            <span class="tag">&lt;directory&gt;</span>${project.root.basedir}/${project.config.resource.directory.rdbms}<span class="tag">&lt;/directory&gt;</span>
        <span class="tag">&lt;/resource&gt;</span>
    <span class="tag">&lt;/resources&gt;</span>
<span class="tag">&lt;/build&gt;</span>

<span class="tag">&lt;profiles&gt;</span>
    <span class="tag">&lt;profile&gt;</span>
        <span class="tag">&lt;id&gt;</span>postgresql9-local<span class="tag">&lt;/id&gt;</span>
        <span class="tag">&lt;activation&gt;</span>
            <span class="tag">&lt;activeByDefault&gt;</span>true<span class="tag">&lt;/activeByDefault&gt;</span>
        <span class="tag">&lt;/activation&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.postgresql<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>postgresql<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;scope&gt;</span>runtime<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
        <span class="tag">&lt;/dependencies&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;project.config.resource.directory.rdbms&gt;</span>config/rdbms/postgresql9/local<span class="tag">&lt;/project.config.resource.directory.rdbms&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/profile&gt;</span>
    <span class="tag">&lt;profile&gt;</span>
        <span class="tag">&lt;id&gt;</span>postgresql9-it<span class="tag">&lt;/id&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.postgresql<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>postgresql<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;scope&gt;</span>runtime<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
        <span class="tag">&lt;/dependencies&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;project.config.resource.directory.rdbms&gt;</span>config/rdbms/postgresql9/it<span class="tag">&lt;/project.config.resource.directory.rdbms&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/profile&gt;</span>
<span class="tag">&lt;/profiles&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>なお、MavenのProfileは以下の要領で、コマンド実行時に有効化することができる。<br>
必要に応じて、複数Profileを有効化することもできる。必要に応じて、有効活用して欲しい。</p>
</div>
<div class="listingblock">
<div class="title">MavenのProfileを有効化する例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ mvn -P profile-1,profile-2</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="Ch03_CreateProject_BuildAndExec_BuildPerEnv_AppExecution"><a class="anchor" href="#Ch03_CreateProject_BuildAndExec_BuildPerEnv_AppExecution"></a>3.1.6.2.1. アプリケーションの実行</h6>
<div class="paragraph">
<p>前段でビルドした結果を元に、ジョブを実行する例を示す。<br>
<code>[artifactId]</code>と<code>[version]</code>は<a href="#Ch03_CreateProject_HowToCreate">プロジェクトの作成</a>にて設定したものに、ユーザに応じて読み替えて欲しい。</p>
</div>
<div class="listingblock">
<div class="title">コマンドプロンプト(Windows)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;java -cp &quot;target\[artifactId]-[version].jar;lib\*&quot; ^
org.springframework.batch.core.launch.support.CommandLineJobRunner ^
META-INF/jobs/job01.xml job01</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bash(Unix, Linux, &#8230;&#8203;)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ java -cp 'target/[artifactId]-[version].jar:lib/*' \
org.springframework.batch.core.launch.support.CommandLineJobRunner \
META-INF/jobs/job01.xml job01</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">javaコマンドが返却する終了コードをハンドリングする必要性</div>
<div class="paragraph">
<p>実際のシステムでは、
ジョブスケジューラからジョブを発行する際にjavaコマンドを直接発行するのではなく、
java起動用のシェルスクリプトを挟んで起動することが一般的である。<br></p>
</div>
<div class="paragraph">
<p>これはjavaコマンド起動前の環境変数を設定するためや、javaコマンドの終了コードをハンドリングするためである。
この、<code>javaコマンドの終了コードのハンドリング</code>は、以下を理由に常に行うことを推奨する。<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>javaコマンドの終了コードは正常:<code>0</code>、異常:<code>1</code>であるが、ジョブスケジューラはジョブの成功/失敗を終了コードの範囲で判断する。
そのため、ジョブスケジューラの設定によっては、javaコマンドは異常終了したのにもかかわらずジョブスケジューラは正常終了したと判断してしまう。</p>
</li>
<li>
<p>OSやジョブスケジューラが扱うことができる終了コードは有限の範囲である。</p>
<div class="ulist">
<ul>
<li>
<p>OSやジョブスケジューラの仕様に応じて、ユーザにて使用する終了コードの範囲を定義することが重要である。</p>
</li>
<li>
<p>一般的に、POSIX標準で策定されている0から255の間に収めることが多い。</p>
<div class="ulist">
<ul>
<li>
<p>Macchinetta Batch 2.xでは、正常:<code>0</code>、それ以外:<code>255</code>として終了コードを返却するよう設定している。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>以下に、終了コードのハンドリング例を示す。</p>
</div>
<div class="listingblock">
<div class="title">終了コードのハンドリング例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">#!/bin/bash

# ..omitted.

java -cp ...
RETURN_CODE=$?
if [ $RETURN_CODE = 1 ]; then
   return 255
else
   return $RETURN_CODE
fi</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch03_CreateChunkJob"><a class="anchor" href="#Ch03_CreateChunkJob"></a>3.2. チャンクモデルジョブの作成</h3>
<div class="sect3">
<h4 id="Ch03_CreateChunkJob_Overview"><a class="anchor" href="#Ch03_CreateChunkJob_Overview"></a>3.2.1. Overview</h4>
<div class="paragraph">
<p>チャンクモデルジョブの作成方法について説明する。
チャンクモデルのアーキテクチャについては、<a href="#Ch02_SpringBatchArch">Spring Batchのアーキテクチャ</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p>ここでは、チャンクモデルジョブの構成要素について説明する。</p>
</div>
<div class="sect4">
<h5 id="Ch03_CreateChunkJob_Overview_Components"><a class="anchor" href="#Ch03_CreateChunkJob_Overview_Components"></a>3.2.1.1. 構成要素</h5>
<div class="paragraph">
<p>チャンクモデルジョブの構成要素を以下に示す。
これらの構成要素をBean定義にて組み合わせることで1つのジョブを実現する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">チャンクモデルジョブの構成要素</caption>
<colgroup>
<col style="width: 5.2631%;">
<col style="width: 21.0526%;">
<col style="width: 52.6315%;">
<col style="width: 10.5263%;">
<col style="width: 10.5265%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">名称</th>
<th class="tableblock halign-left valign-top">役割</th>
<th class="tableblock halign-left valign-top">設定必須</th>
<th class="tableblock halign-left valign-top">実装必須</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">様々なリソースからデータを取得するためのインターフェース。<br>
Spring Batchにより、フラットファイルや<br>
データベースを対象とした実装が提供されているため、ユーザにて作成する必要はない。</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-minus"></i></span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力から出力へデータを加工するためのインターフェース。<br>
ユーザは必要に応じてこのインターフェースを<code>implements</code>し、ビジネスロジックを実装する。</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-minus"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-minus"></i></span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">様々なリソースへデータを出力するためのインターフェース。<br>
<code>ItemReader</code>と対になるインターフェースと考えてよい。<br>
Spring Batchにより、フラットファイルや<br>
データベースのための実装が提供されているため、ユーザにて作成する必要はない。</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-minus"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>この表のポイントは以下である。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>入力リソースから出力リソースへ単純にデータを移し替えるだけであれば、設定のみで実現できる。</p>
</li>
<li>
<p><code>ItemProcessor</code>は、必要が生じた際にのみ実装すればよい。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以降、これらの構成要素を用いたジョブの実装方法について説明する。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateChunkJob_HowToUse"><a class="anchor" href="#Ch03_CreateChunkJob_HowToUse"></a>3.2.2. How to use</h4>
<div class="paragraph">
<p>ここでは、実際にチャンクモデルジョブを実装する方法について、以下の順序で説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch03_CreateChunkJob_HowToUse_JobConfig">ジョブの設定</a></p>
</li>
<li>
<p><a href="#Ch03_CreateChunkJob_HowToUse_Components">コンポーネントの実装</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch03_CreateChunkJob_HowToUse_JobConfig"><a class="anchor" href="#Ch03_CreateChunkJob_HowToUse_JobConfig"></a>3.2.2.1. ジョブの設定</h5>
<div class="paragraph">
<p>Bean定義ファイルにて、チャンクモデルジョブを構成する要素の組み合わせ方を定義する。
以下に例を示し、構成要素の繋がりを説明する。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義ファイルの例(チャンクモデル)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;context:component-scan</span>
        <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.common</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;mybatis:scan</span>
        <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.mst</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (4) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.mst.CustomerRepository.findAll</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (5) --&gt;</span>
    <span class="comment">&lt;!-- Item Processor --&gt;</span>
    <span class="comment">&lt;!-- Item Processor in order that based on the Bean defined by the annotations, not defined here --&gt;</span>

    <span class="comment">&lt;!-- (6) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId,customerName,customerAddress,customerTel,chargeBranchId</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- (7) --&gt;</span>
    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobCustomerList01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (8) --&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobCustomerList01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (9) --&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (10) --&gt;</span>
                <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">processor</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- (11) --&gt;</span>
            <span class="tag">&lt;/batch:tasklet&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ItemProcessor実装クラスの設定</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">processor</span><span class="delimiter">&quot;</span></span>) <span class="comment">// (5)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;Customer, Customer&gt; {
  <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Macchinetta Batch 2.xを利用する際に、常に必要なBean定義を読み込む設定をインポートする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャン対象のベースパッケージを設定する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> コンポーネントスキャンを使用したアノテーションベースのBean定義を行わない場合、かつアノテーションを使用してBeanの依存性解決を行う場合は、<code>&lt;context:annotation-config/&gt;</code>タグの定義が必要となる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatis-Springの設定。<br>
MyBatis-Springの設定の詳細は、<a href="#Ch05_DBAccess">データベースアクセス</a>を参照のこと。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReaderの設定。<br>
ItemReaderの詳細は、
<a href="#Ch05_DBAccess">データベースアクセス</a>、
<a href="#Ch05_FileAccess">ファイルアクセス</a>
を参照のこと。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessorは、(2)によりアノテーションにて定義することができ、Bean定義ファイルで定義する必要がない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriterの設定。<br>
ItemWriterの詳細は、
<a href="#Ch05_DBAccess">データベースアクセス</a>、
<a href="#Ch05_FileAccess">ファイルアクセス</a>
を参照のこと。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの設定。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要がある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobRepository</code>の設定。<br>
<code>job-repository</code>属性に設定する値は、特別な理由がない限り<code>jobRepository</code>固定とすること。<br>
これにより、すべてのジョブが1つの<code>JobRepository</code>で管理できる。
<code>jobRepository</code>のBean定義は、(1)により解決する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの設定。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要はないが、障害発生時に追跡しやすくなる等の様々なメリットがあるため一意とする。<br>
特別な理由がない限り、(7)で指定したid属性に[step+連番]を付加する形式とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">タスクレットの設定。<br>
<code>transaction-manager</code>属性に設定する値は、特別な理由がない限り<code>jobTransactionManager</code>固定とすること。<br>
これにより、(11)の<code>commit-interval</code>ごとにトランザクションが管理される。
詳細については、<a href="#Ch05_Transaction">トランザクション制御</a>を参照のこと。<br>
<code>jobTransactionManager</code>のBean定義は、(1)により解決する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンクモデルジョブの設定。<br>
<code>reader</code>、<code>writer</code>それぞれの属性に、前項までに定義した<code>ItemReader</code>、<code>ItemWriter</code>のBeanIDを指定する。<br>
<code>processor</code>属性に、ItemProcessorの実装クラスのBeanIDを指定する。<br>
<code>commit-interval</code>属性に1チャンクあたりの入力データ件数を設定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">commit-intervalのチューニング</div>
<div class="paragraph">
<p><code>commit-interval</code>はチャンクモデルジョブにおける、性能上のチューニングポイントである。</p>
</div>
<div class="paragraph">
<p>前述の例では10件としているが、利用できるマシンリソースやジョブの特性によって適切な件数は異なる。
複数のリソースにアクセスしてデータを加工するジョブであれば10件から100件程度で処理スループットが頭打ちになることもある。
一方、入出力リソースが1:1対応しておりデータを移し替える程度のジョブであれば5000件や10000件でも処理スループットが伸びることがある。</p>
</div>
<div class="paragraph">
<p>ジョブ実装時の<code>commit-interval</code>は100件程度で仮置きしておき、
その後に実施した性能測定の結果に応じてジョブごとにチューニングするとよい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch03_CreateChunkJob_HowToUse_Components"><a class="anchor" href="#Ch03_CreateChunkJob_HowToUse_Components"></a>3.2.2.2. コンポーネントの実装</h5>
<div class="paragraph">
<p>ここでは主に、ItemProcessorを実装する方法について説明する。</p>
</div>
<div class="paragraph">
<p>他のコンポーネントについては、以下を参照のこと。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ItemReader、ItemWriter</p>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_DBAccess">データベースアクセス</a>、
<a href="#Ch05_FileAccess">ファイルアクセス</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Listener</p>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch04_Listener">リスナー</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="Ch03_CreateChunkJob_HowToUse_Components_Processor"><a class="anchor" href="#Ch03_CreateChunkJob_HowToUse_Components_Processor"></a>3.2.2.2.1. ItemProcessorの実装</h6>
<div class="paragraph">
<p>ItemProcessorの実装方法を説明する。</p>
</div>
<div class="paragraph">
<p>ItemProcessorは、以下のインターフェースが示すとおり、入力リソースから取得したデータ<strong>1件</strong>を元に、
出力リソースに向けたデータ<strong>1件</strong>を作成する役目を担う。
つまり、ItemProcessorはデータ<strong>1件</strong>に対するビジネスロジックを実装する箇所、と言える。</p>
</div>
<div class="listingblock">
<div class="title">ItemProcessorインターフェース</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemProcessor</span>&lt;I, O&gt; {
    O process(I item) <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>なお、インターフェースが示す<code>I</code>と<code>O</code>は以下のとおり同じ型でも異なる型でもよい。
同じ型であれば入力データを一部修正することを意味し、
異なる型であれば入力データを元に出力データを生成することを意味する。</p>
</div>
<div class="listingblock">
<div class="title">ItemProcessor実装例(入出力が同じ型)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AmountUpdateItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetail, SalesPlanDetail&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        item.setAmount(<span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span>));
        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ItemProcessor実装例(入出力が異なる型)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UpdateItemFromDBProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPlanDetail&gt; {

    <span class="annotation">@Inject</span>
    CustomerRepository customerRepository;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPerformanceDetail readItem) <span class="directive">throws</span> <span class="exception">Exception</span> {
        Customer customer = customerRepository.findOne(readItem.getCustomerId());

        SalesPlanDetail writeItem = <span class="keyword">new</span> SalesPlanDetail();
        writeItem.setBranchId(customer.getChargeBranchId());
        writeItem.setYear(readItem.getYear());
        writeItem.setMonth(readItem.getMonth());
        writeItem.setCustomerId(readItem.getCustomerId());
        writeItem.setAmount(readItem.getAmount());
        <span class="keyword">return</span> writeItem;
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">ItemProcessorからnullを返却することの意味</div>
<div class="paragraph">
<p>ItemProcessorからnullを返却することは、当該データを後続処理(Writer)に渡さないことを意味し、
言い換えるとデータをフィルタすることになる。
これは、入力データの妥当性検証を実施する上で有効活用できる。
詳細については、<a href="#Ch06_InputValidation">入力チェック</a>を参照のこと。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">ItemProcessorの処理スループットをあげるには</div>
<div class="paragraph">
<p>前述した実装例のように、ItemProcessorの実装クラスではデータベースやファイルを始めとしたリソースにアクセスしなければならないことがある。
ItemProcessorは入力データ1件ごとに実行されるため、I/Oが少しでも発生するとジョブ全体では大量のI/Oが発生することになる。
そのため、極力I/Oを抑えることが処理スループットをあげる上で重要となる。</p>
</div>
<div class="paragraph">
<p>1つの方法として、後述のListenerを活用することで事前に必要なデータをメモリ上に確保しておき、
ItemProcessorにおける処理の大半を、CPU/メモリ間で完結するように実装する手段がある。
ただし、1ジョブあたりのメモリを大量に消費することにも繋がるので、何でもメモリ上に確保すればよいわけではない。
I/O回数やデータサイズを元に、メモリに格納するデータを検討すること。</p>
</div>
<div class="paragraph">
<p>この点については、<a href="#Ch05">データの入出力</a>でも紹介する。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">複数のItemProcessorを同時に利用する</div>
<div class="paragraph">
<p>汎用的なItemProcessorを用意し、個々のジョブに適用したい場合は、
Spring Batchが提供する<code>CompositeItemProcessor</code>を利用し連結することで実現できる。</p>
</div>
<div class="listingblock">
<div class="title">CompositeItemProcessorによる複数ItemProcessorの連結</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">processor</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.CompositeItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegates</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">commonItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">businessLogicItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>delegates属性に指定した順番に処理されることに留意すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch03_CreateTaskletJob"><a class="anchor" href="#Ch03_CreateTaskletJob"></a>3.3. タスクレットモデルジョブの作成</h3>
<div class="sect3">
<h4 id="Ch03_CreateTaskletJob_Overview"><a class="anchor" href="#Ch03_CreateTaskletJob_Overview"></a>3.3.1. Overview</h4>
<div class="paragraph">
<p>タスクレットモデルジョブの作成方法について説明する。
タスクレットモデルのアーキテクチャについては、<a href="#Ch02_SpringBatchArch">Spring Batchのアーキテクチャ</a>を参照のこと。</p>
</div>
<div class="sect4">
<h5 id="Ch03_CreateTaskletJob_Overview_Components"><a class="anchor" href="#Ch03_CreateTaskletJob_Overview_Components"></a>3.3.1.1. 構成要素</h5>
<div class="paragraph">
<p>タスクレットモデルジョブでは、複数の構成要素は登場しない。
<code>org.springframework.batch.core.step.tasklet.Tasklet</code>を実装し、Bean定義で設定するのみである。
また、発展的な実装手段としてチャンクモデルの構成要素である<code>ItemReader</code>や<code>ItemWriter</code>をコンポーネントとして使うことも可能である。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateTaskletJob_HowToUse"><a class="anchor" href="#Ch03_CreateTaskletJob_HowToUse"></a>3.3.2. How to use</h4>
<div class="paragraph">
<p>ここでは、実際にタスクレットモデルジョブを実装する方法について、以下の順序で説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch03_CreateTaskletJob_HowToUse_JobConfig">ジョブの設定</a></p>
</li>
<li>
<p><a href="#Ch03_CreateTaskletJob_HowToUse_Impl">Taskletの実装</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch03_CreateTaskletJob_HowToUse_JobConfig"><a class="anchor" href="#Ch03_CreateTaskletJob_HowToUse_JobConfig"></a>3.3.2.1. ジョブの設定</h5>
<div class="paragraph">
<p>Bean定義ファイルにて、タスクレットモデルジョブを定義する。
以下に例を示す。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義ファイルの例(タスクレットモデル)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;context:component-scan</span>
          <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.common</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                           <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleJobTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (6) --&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Tasklet実装クラスの例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.common</span>;

<span class="annotation">@Component</span> <span class="comment">// (3)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleJobTasklet</span> <span class="directive">implements</span> Tasklet {
  <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Macchinetta Batch 2.xを利用する際に、常に必要なBean定義を読み込む設定をインポートする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャン対象のベースパッケージを設定する。<br>
タスクレットモデルはアノテーションによるBean定義を基本とし、Tasklet実装クラスのBean定義はXML上では不要とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの設定。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要がある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobRepository</code>の設定。<br>
<code>job-repository</code>属性に設定する値は、特別な理由がない限り<code>jobRepository</code>固定とすること。<br>
これにより、すべてのジョブが1つの<code>JobRepository</code>で管理できる。
<code>jobRepository</code>のBean定義は、(1)により解決する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの設定。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要はないが、障害発生時に追跡しやすくなる等の様々なメリットがあるため一意とする。<br>
 特別な理由がない限り、(3)で指定したid属性に[step+連番]を付加する形式とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">タスクレットの設定。<br>
<code>transaction-manager</code>属性に設定する値は、特別な理由がない限り<code>jobTransactionManager</code>固定とすること。<br>
これにより、タスクレット全体の処理が1つのトランザクションで管理される。
詳細については、<a href="#Ch05_Transaction">トランザクション制御</a>を参照のこと。<br>
<code>jobTransactionManager</code>のBean定義は、(1)により解決する。<br></p>
<p class="tableblock">また、<code>ref</code>属性は、(2)により解決するTaskletの実装クラスのBeanIDを指定する。<br>
ここでは、Tasklet実装クラス名<code>SimpleJobTasklet</code>の先頭を小文字にした<code>simpleJobTasklet</code>となる。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">アノテーション利用時のBean名</div>
<div class="paragraph">
<p><code>@Component</code>アノテーション利用時のBean名は、デフォルトでは
<code>org.springframework.context.annotation.AnnotationBeanNameGenerator</code>
を通じて生成される。命名ルールを確認したいときは、本クラスのJavadocを参照するとよい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch03_CreateTaskletJob_HowToUse_Impl"><a class="anchor" href="#Ch03_CreateTaskletJob_HowToUse_Impl"></a>3.3.2.2. Taskletの実装</h5>
<div class="paragraph">
<p>まずはシンプルな実装で概要を理解し、次にチャンクモデルのコンポーネントを利用する実装へと進む。</p>
</div>
<div class="paragraph">
<p>以下の順序で説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch03_CreateTaskletJob_HowToUse_SimpleImpl">シンプルなTaskletの実装</a></p>
</li>
<li>
<p><a href="#Ch03_CreateTaskletJob_HowToUse_InOutImpl">チャンクモデルのコンポーネントを利用するTasklet実装</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="Ch03_CreateTaskletJob_HowToUse_SimpleImpl"><a class="anchor" href="#Ch03_CreateTaskletJob_HowToUse_SimpleImpl"></a>3.3.2.3. シンプルなTaskletの実装</h5>
<div class="paragraph">
<p>ログを出力するのみのTasklet実装を通じ、最低限のポイントを説明する。</p>
</div>
<div class="listingblock">
<div class="title">シンプルなTasklet実装クラスの例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.common</span>;

<span class="comment">// omitted.</span>

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleJobTasklet</span> <span class="directive">implements</span> Tasklet { <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(SimpleJobTasklet.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {  <span class="comment">// (2)</span>
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">called tasklet.</span><span class="delimiter">&quot;</span></span>); <span class="comment">// (3)</span>
        <span class="keyword">return</span> RepeatStatus.FINISHED; <span class="comment">// (4)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.core.step.tasklet.Tasklet</code>インターフェースを<code>implements</code>して実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Tasklet</code>インターフェースが定義する<code>execute</code>メソッドを実装する。
引数の<code>StepContribution</code>, <code>ChunkContext</code>は必要に応じて利用するが、ここでは説明を割愛する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">任意の処理を実装する。ここではINFOログを出力している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Taskletの処理が完了したかどうかを返却する。<br>
常に<code>return RepeatStatus.FINISHED;</code>と明示する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch03_CreateTaskletJob_HowToUse_InOutImpl"><a class="anchor" href="#Ch03_CreateTaskletJob_HowToUse_InOutImpl"></a>3.3.2.4. チャンクモデルのコンポーネントを利用するTasklet実装</h5>
<div class="paragraph">
<p>Spring Batch では、Tasklet実装の中でチャンクモデルの各種コンポーネントを利用することに言及していない。
Macchinetta Batch 2.xでは、以下のような状況に応じてこれを選択してよい。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>複数のリソースを組み合わせながら処理するため、チャンクモデルの形式に沿いにくい</p>
</li>
<li>
<p>チャンクモデルでは処理が複数箇所に実装することになるため、タスクレットモデルの方が全体像を把握しやすい</p>
</li>
<li>
<p>リカバリをシンプルにするため、チャンクモデルの中間コミットではなく、タスクレットモデルの一括コミットを使いたい</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>また、チャンクモデルのコンポーネントを利用してTasklet実装するうえで処理の単位についても考慮してほしい。
出力件数の単位としては以下の3パターンが考えられる。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">出力件数の単位と特徴</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 85%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">出力件数</th>
<th class="tableblock halign-left valign-top">特徴</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1件</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データを1件ずつ、入力、処理、出力しているため、処理のイメージがしやすい。<br>
大量データの場合はI/Oの多発により性能劣化を引き起こす可能性があるので留意が必要である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">全件</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データを1件ずつ、入力、処理してメモリ上に貯めておき、最後に全件一括で出力する。<br>
少量データの場合はデータの整合性を担保するとともに性能向上を期待できる。
ただし、大量データの場合はリソース(CPU、メモリ)に高負荷がかかる可能性があるので留意が必要である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">一定件数</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データを1件ずつ、入力、処理してメモリ上に貯めておき、一定件数まできたところで出力する。<br>
大量データを一定のリソース(CPU、メモリ)で効率よく処理できることにより性能向上を期待できる。<br>
また、一定件数ごとに処理するため、トランザクション制御を実装することにより中間コミット方式にも移行できる。
ただし、中間コミット方式とする場合、ジョブが異常終了した後のリカバリは処理済みデータと未処理データが混在する可能性があるので留意が必要である。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>以下に、チャンクモデルのコンポーネントである<code>ItemReader</code>や<code>ItemWriter</code>を利用するTasklet実装について説明する。</p>
</div>
<div class="paragraph">
<p>この実装例は、1件単位に処理している例である。</p>
</div>
<div class="listingblock">
<div class="title">チャンクモデルのコンポーネントを利用するTasklet実装例1</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>()
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>) <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanChunkTranTask</span> <span class="directive">implements</span> Tasklet {

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>) <span class="comment">// (2)</span>
    ItemStreamReader&lt;SalesPlanDetail&gt; itemReader; <span class="comment">// (3)</span>

    <span class="annotation">@Inject</span>
    SalesPlanDetailRepository repository; <span class="comment">// (4)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        SalesPlanDetail item;

        <span class="keyword">try</span> {
            itemReader.open(chunkContext.getStepContext().getStepExecution()
                    .getExecutionContext()); <span class="comment">// (5)</span>

            <span class="keyword">while</span> ((item = itemReader.read()) != <span class="predefined-constant">null</span>) { <span class="comment">// (6)</span>

                <span class="comment">// do some processes.</span>

                repository.create(item); <span class="comment">// (7)</span>
            }
        } <span class="keyword">finally</span> {
            itemReader.close(); <span class="comment">// (8)</span>
        }
        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義例1</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;context:component-scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.plan</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;context:component-scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.transaction.component</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (9) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.plan</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (10) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (11) --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">createSalesPlanChunkTranTask</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">createSalesPlanChunkTranTask.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesPlanChunkTranTask</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">本クラス内で利用するItemReaderのBeanスコープに合わせ、stepスコープとする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力リソース(この例ではフラットファイル)へのアクセスは<code>ItemReader</code>を通じて行う。<br>
ここでは、<code>detailCSVReader</code>というBean名を指定するが、わかりやすさのためなので任意とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemReader</code>のサブインターフェースである、<code>ItemStreamReader</code>として型を定義する。<br>
これは、(5), (8)のリソースオープン/クローズを実装する必要があるためである。
後ほど補足する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力リソース(この例ではデータベース)へのアクセスはMyBatisのMapperを通じて行う。<br>
ここでは、簡単のためMapperを直接利用している。常に<code>ItemWriter</code>を用いる必要はない。
もちろん、<code>MyBatisBatchItemWriter</code>を用いてもよい。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力リソースをオープンする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力リソース全件を逐次ループ処理する。<br>
<code>ItemReader#read</code>は、入力データがすべて読み取り末端に到達した場合、<code>null</code>を返却する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データベースへ出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リソースは必ずクローズすること。<br>
なお、例外処理は必要に応じて実装すること。
ここで例外が発生した場合、タスクレット全体のトランザクションがロールバックされ、
例外のスタックトレースを出力し、ジョブが異常終了する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatis-Springの設定。<br>
MyBatis-Springの設定の詳細は、<a href="#Ch05_DBAccess">データベースアクセス</a>を参照のこと。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイルから入力するため、<code>FlatFileItemReader</code>のBean定義を追加する。詳細はここでは割愛する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各種コンポーネントはアノテーションによって解決するため、<br>
<a href="#Ch03_CreateTaskletJob_HowToUse_SimpleImpl">シンプルなTaskletの実装</a>の場合と同様となる。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">スコープの統一について</div>
<div class="paragraph">
<p>Tasklet実装クラスと、InjectするBeanのスコープは、同じスコープに統一すること。</p>
</div>
<div class="paragraph">
<p>たとえば、<code>FlatFileItemReader</code>が引数から入力ファイルパスを受け取る場合にはBeanスコープを<code>step</code>にする必要がある。
この時、Tasklet実装クラスのスコープも<code>step</code>にする必要がある。</p>
</div>
<div class="paragraph">
<p>仮にTasklet実装クラスのスコープを<code>singleton</code>としたケースを説明する。
この時、アプリケーション起動時の<code>ApplicationContext</code>生成時にTasklet実装クラスをインスタンス化した後、
<code>FlatFileItemReader</code>のインスタンスを解決してInjectしようとする。
しかし、<code>FlatFileItemReader</code>は<code>step</code>スコープでありstep実行時に生成するためまだ存在しない。
結果、Tasklet実装クラスをインスタンス化できないと判断し<code>ApplicationContext</code>生成に失敗してしまう。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">@Injectを付与するフィールドの型について</div>
<div class="paragraph">
<p>利用する実装クラスに応じて、以下のいずれかとする。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ItemReader/ItemWriter</p>
<div class="ulist">
<ul>
<li>
<p>対象となるリソースへのオープン・クローズを実施する必要がない場合に利用する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ItemSteamReader/ItemStreamWriter</p>
<div class="ulist">
<ul>
<li>
<p>対象となるリソースへのオープン・クローズを実施する必要がある場合に利用する。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>必ずjavadocを確認してどちらを利用するか判断すること。以下に代表例を示す。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">FlatFileItemReader/Writerの場合</dt>
<dd>
<p>ItemSteamReader/ItemStreamWriterにて扱う</p>
</dd>
<dt class="hdlist1">MyBatisCursorItemReaderの場合</dt>
<dd>
<p>ItemStreamReaderにて扱う</p>
</dd>
<dt class="hdlist1">MyBatisBatchItemWriterの場合</dt>
<dd>
<p>ItemWriterにて扱う</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>この実装例は、一定件数単位に処理するチャンクモデルを模倣した例である</p>
</div>
<div class="listingblock">
<div class="title">チャンクモデルのコンポーネントを利用するTasklet実装例2</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPerformanceTasklet</span> <span class="directive">implements</span> Tasklet {


    <span class="annotation">@Inject</span>
    ItemStreamReader&lt;SalesPerformanceDetail&gt; reader;

    <span class="annotation">@Inject</span>
    ItemWriter&lt;SalesPerformanceDetail&gt; writer; <span class="comment">// (1)</span>

    <span class="type">int</span> chunkSize = <span class="integer">10</span>; <span class="comment">// (2)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="keyword">try</span> {
            reader.open(chunkContext.getStepContext().getStepExecution()
                    .getExecutionContext());

            <span class="predefined-type">List</span>&lt;SalesPerformanceDetail&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(chunkSize); <span class="comment">// (2)</span>
            SalesPerformanceDetail item = <span class="predefined-constant">null</span>;
            <span class="keyword">do</span> {
                <span class="comment">// Pseudo operation of ItemReader</span>
                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; chunkSize; i++) { <span class="comment">// (3)</span>
                    item = reader.read();
                    <span class="keyword">if</span> (item == <span class="predefined-constant">null</span>) {
                        <span class="keyword">break</span>;
                    }
                    <span class="comment">// Pseudo operation of ItemProcessor</span>
                    <span class="comment">// do some processes.</span>

                    items.add(item);
                }

                <span class="comment">// Pseudo operation of ItemWriter</span>
                <span class="keyword">if</span> (!items.isEmpty()) {
                    writer.write(items); <span class="comment">// (4)</span>
                    items.clear();
                }
            } <span class="keyword">while</span> (item != <span class="predefined-constant">null</span>);
        } <span class="keyword">finally</span> {
            <span class="keyword">try</span> {
                reader.close();
            } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
                <span class="comment">// do nothing.</span>
            }
        }

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義例2</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;context:component-scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.common,</span>
        <span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.performance,</span>
        <span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch06.exceptionhandling</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.performance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.performance.SalesPerformanceDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.performance.SalesPerformanceDetailRepository.create</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>


<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfTasklet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfTasklet.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesPerformanceTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemWriter</code>の実装として<code>MyBatisBatchItemWriter</code>を利用する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemWriter</code>は一定件数をまとめて出力する。<br>
ここでは10件ごとに処理し出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンクモデルの動作にそって、<br>
read&#8594;process&#8594;read&#8594;process&#8594;&#8230;&#8203;&#8594;writeとなるようにする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemWriter</code>を通じてまとめて出力する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>ItemReader</code>や<code>ItemWriter</code>の実装クラスを利用するかどうかは都度判断してほしいが、
ファイルアクセスは<code>ItemReader</code>や<code>ItemWriter</code>の実装クラスを利用するとよいだろう。
それ以外のデータベースアクセス等は無理に使う必要はない。性能向上のために使えばよい。</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch03_ChunkOrTasklet"><a class="anchor" href="#Ch03_ChunkOrTasklet"></a>3.4. チャンクモデルとタスクレットモデルの使い分け</h3>
<div class="paragraph">
<p>ここでは、チャンクモデルとタスクレットモデルの使い分けについて、それぞれの特徴を整理することで説明する。
なお、説明において、以降の章で詳細な説明をする事項もあるため、適宜対応する章を参照して欲しい。</p>
</div>
<div class="paragraph">
<p>また、以降の内容は考え方の一例として捉えて欲しい。制約や推奨事項ではない。
ユーザやシステムの特性に応じてジョブを作成する際の参考にしてほしい。</p>
</div>
<div class="paragraph">
<p>以下に、チャンクモデルとタスクレットモデルの主要な違いについて列挙する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">チャンクモデルとタスクレットモデルの比較</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 45%;">
<col style="width: 45%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項目</th>
<th class="tableblock halign-left valign-top">チャンク</th>
<th class="tableblock halign-left valign-top">タスクレット</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">構成要素</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemReader</code>, <code>ItemProcessor</code>, <code>ItemWriter</code>の3つに分割する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Tasklet</code>の1つに集約する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクション</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">一定件数で中間コミットを発行しながら処理することが基本となる。一括コミットはできない。<br>
処理対象データ件数に依らず一定のマシンリソースで処理できる。<br>
処理途中でエラーが発生すると未処理データと処理済データが混在する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">全体で一括コミットにて処理することが基本となる。中間コミットはユーザにて実装する必要がある。<br>
処理対象データが大量になると、マシンリソースが枯渇する恐れがある。<br>
処理途中でエラーが発生すると未処理データのみにロールバックされる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">リスタート</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">件数ベースのリスタートができる。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">件数ベースのリスタートはできない。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>これを踏まえて、以下にそれぞれを使い分ける例をいくつか紹介する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">リカバリを限りなくシンプルにしたい</dt>
<dd>
<p>エラーとなったジョブは対象のジョブをリランするのみで復旧したい場合など、
リカバリをシンプルにしたい時はタスクレットモデルを選択するとよい。<br>
チャンクモデルでは処理済データをジョブ実行前の状態に戻したり、
未処理データのみ処理するようジョブを予め作りこんでおいたり、
といった対処が必要となる。</p>
</dd>
<dt class="hdlist1">処理の内容をまとめたい</dt>
<dd>
<p>1ジョブ1クラスなど、ジョブの見通しを優先したい場合はタスクレットを選択するとよい。</p>
</dd>
<dt class="hdlist1">大量のデータを安定して処理したい</dt>
<dd>
<p>1000万件など、一括処理するとリソースに影響する件数を対象とする際はチャンクモデルを活用するか検討するとよい。
これは中間コミットによって安定させることを意味する。
タスクレットモデルでも中間コミットを打つことが可能だが、チャンクモデルの方がシンプルな実装になる可能性がある。</p>
</dd>
<dt class="hdlist1">エラー後の復旧は件数ベースリスタートとしたい</dt>
<dd>
<p>バッチウィンドウがシビアであり、エラーとなったデータ以降から再開したい場合に、
Spring Batchが提供する件数ベースリスタートを活用するときは、チャンクモデルを選択する必要がある。
これにより、個々のジョブでその仕組を作りこむ必要がなくなる。</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>チャンクモデルとタスクレットモデルは、併用することが基本である。<br>
バッチシステム内のジョブすべてをどちらかのモデルでのみ実装する必要はない。<br>
システム全体のジョブがもつ特性を踏まえて、一方のモデルを基本とし、状況に応じてもう一方のモデルを使うことは自然である。</p>
</div>
<div class="paragraph">
<p>たとえば、大部分は処理件数や処理時間に余裕があるならばタスクレットモデルを基本とし、
極少数の大量件数を処理するジョブはチャンクモデルを選択する、といったことは自然といえる。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch04"><a class="anchor" href="#Ch04"></a>4. ジョブの起動</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch04_SyncJob"><a class="anchor" href="#Ch04_SyncJob"></a>4.1. 同期実行</h3>
<div class="sect3">
<h4 id="Ch04_SyncJob_Overview"><a class="anchor" href="#Ch04_SyncJob_Overview"></a>4.1.1. Overview</h4>
<div class="paragraph">
<p>同期実行について説明する。
同期実行とは、ジョブスケジューラなどによりシェルを介して新規プロセスとして起動し、ジョブの実行結果を呼び出し元に返却する実行方法である。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_syncJob_overview.png" alt="overview of sync job">
</div>
<div class="title">同期実行の概要</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_syncjob_seq.png" alt="sequence of sync job">
</div>
<div class="title">同期実行の流れ</div>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで同じ使い方になる。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_SyncJob_HowToUse"><a class="anchor" href="#Ch04_SyncJob_HowToUse"></a>4.1.2. How to use</h4>
<div class="paragraph">
<p><code>CommandLineJobRunner</code>によってジョブを起動する方法を説明する。</p>
</div>
<div class="paragraph">
<p>なお、アプリケーションのビルドや実行については、<a href="#Ch03_CreateProject_HowToCreate">プロジェクトの作成</a>を参照のこと。
また、起動パラメータの指定方法や活用方法については、<a href="#Ch04_JobParameter">ジョブの起動パラメータ</a>を参照のこと。
これらと本節の説明は一部重複するが、同期実行の要素に注目して説明する。</p>
</div>
<div class="sect4">
<h5 id="Ch04_SyncJob_HowToUse_Run"><a class="anchor" href="#Ch04_SyncJob_HowToUse_Run"></a>4.1.2.1. 実行方法</h5>
<div class="paragraph">
<p>Macchinetta Batch 2.xにおいて、同期実行は Spring Batch が提供する<code>CommandLineJobRunner</code>によって実現する。
<code>CommandLineJobRunner</code>は、以下の要領にてjavaコマンドを発行することで起動する。</p>
</div>
<div id="Ch04_SyncJob_HowToUse_Run_Syntax" class="listingblock">
<div class="title">CommandLineJobRunnerの構文</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ java org.springframework.batch.core.launch.support.CommandLineJobRunner &lt;jobPath&gt; &lt;options&gt; &lt;jobIdentifier&gt; &lt;jobParameters&gt;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">引数にて指定する項目</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 80%;">
<col style="width: 10%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">指定する項目</th>
<th class="tableblock halign-left valign-top">説明</th>
<th class="tableblock halign-left valign-top">必須</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobPath</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">起動するジョブの設定を記述したBean定義ファイルのパス。classpathからの相対パスにて指定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">options</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">起動する際の各種オプション(停止、リスタートなど)を指定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobIdentifier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの識別子として、Bean定義上のジョブ名、もしくはジョブを実行後のジョブ実行IDを指定する。
通常はジョブ名を指定する。ジョブ実行IDは停止やリスタートの際にのみ指定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobParameters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの引数を指定する。指定は<code>key=value</code>形式となる。</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>以下に、必須項目のみを指定した場合の実行例を示す。</p>
</div>
<div class="listingblock">
<div class="title">コマンドプロンプトでのCommandLineJobRunnerの実行例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;java -cp &quot;target\[artifactId]-[version].jar;lib\*&quot; ^   # (1)
    org.springframework.batch.core.launch.support.CommandLineJobRunner ^ # (2)
    META-INF/jobs/job01.xml job01 # (3)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">BashでのCommandLineJobRunnerの実行例</div>
<div class="content">
<pre>$ java -cp 'target/[artifactId]-[version].jar:lib/*' \ # (1)
    org.springframework.batch.core.launch.support.CommandLineJobRunner \ # (2)
    META-INF/jobs/job01.xml job01 # (3)</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義の設定(抜粋)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">employeeReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">employeeProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">employeeWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java</code>コマンドを実行する際に、バッチアプリケーションのjarと、依存するjarを<code>classpath</code>に指定する。
 ここではコマンド引数で指定しているが、環境変数等を用いてもよい。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">起動するクラスに、<code>CommandLineJobRunner</code>をFQCNで指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CommandLineJobRunner</code>に沿って、起動引数を渡す。
ここでは、<code>jobPath</code>と<code>jobIdentifier</code>としてジョブ名の2つを指定している。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>次に、任意項目として起動パラメータを指定した場合の実行例を示す。</p>
</div>
<div class="listingblock">
<div class="title">コマンドプロンプトでのCommandLineJobRunnerの実行例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;java -cp &quot;target\[artifactId]-[version].jar;lib\*&quot; ^
    org.springframework.batch.core.launch.support.CommandLineJobRunner ^
    META-INF/jobs/setupJob.xml setupJob target=server1 outputFile=/tmp/result.csv # (1)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">BashでのCommandLineJobRunnerの実行例</div>
<div class="content">
<pre>$ java -cp 'target/[artifactId]-[version].jar:lib/*' \
    org.springframework.batch.core.launch.support.CommandLineJobRunner \
    META-INF/jobs/setupJob.xml setupJob target=server1 outputFile=/tmp/result.csv # (1)</pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの起動パラメータとして、<code>target=server1</code>と<code>outputFile=/tmp/result.csv</code>を指定している。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch04_SyncJob_HowToUse_Options"><a class="anchor" href="#Ch04_SyncJob_HowToUse_Options"></a>4.1.2.2. 任意オプション</h5>
<div class="paragraph">
<p><a href="#Ch04_SyncJob_HowToUse_Run_Syntax">CommandLineJobRunnerの構文</a>で示した任意のオプションについて補足する。</p>
</div>
<div class="paragraph">
<p><code>CommandLineJobRunner</code>では以下の4つの起動オプションが使用できる。
ここでは個々の説明は他に委ねることとし、概要のみ説明する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-restart</dt>
<dd>
<p>失敗したジョブを再実行する。詳細は、<a href="#Ch06_RerunRestart">処理の再実行</a>を参照のこと。</p>
</dd>
<dt class="hdlist1">-stop</dt>
<dd>
<p>実行中のジョブを停止する。詳細は、<a href="#Ch07_JobManagement">ジョブの管理</a>を参照のこと。</p>
</dd>
<dt class="hdlist1">-abandon</dt>
<dd>
<p>停止されたジョブを放棄する。放棄されたジョブは再実行不可となる。
Macchinetta Batch 2.xでは、このオプションを活用するシーンがないため、説明を割愛する。</p>
</dd>
<dt class="hdlist1">-next</dt>
<dd>
<p>過去に一度実行完了したジョブを再度実行する。ただし、Macchinetta Batch 2.xでは、このオプションを利用しない。<br>
なぜなら、Macchinetta Batch 2.xでは、Spring Batchのデフォルトである「同じパラメータで起動したジョブは同一ジョブとして認識され、同一ジョブは1度しか実行できない」
という制約を回避しているためである。<br>
詳細は<a href="#Ch04_JobParameter_HowToUse_Converter">パラメータ変換クラスについて</a>にて説明する。<br>
また、本オプションを利用するには、<code>JobParametersIncrementer</code>というインターフェースの実装クラスが必要だが、
Macchinetta Batch 2.xでは設定を行っていない。<br>
そのため、本オプションを指定して起動すると、必要なBean定義が存在しないためエラーとなる。</p>
</dd>
</dl>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch04_JobParameter"><a class="anchor" href="#Ch04_JobParameter"></a>4.2. ジョブの起動パラメータ</h3>
<div class="sect3">
<h4 id="Ch04_JobParameter_Overview"><a class="anchor" href="#Ch04_JobParameter_Overview"></a>4.2.1. Overview</h4>
<div class="paragraph">
<p>本節では、ジョブの起動パラメータ(以降、パラメータ)の利用方法について説明する。</p>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで同じ使い方になる。</p>
</div>
<div class="paragraph">
<p>パラメータは、以下のような実行環境や実行タイミングに応じてジョブの動作を柔軟に切替える際に使用する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>処理対象のファイルパス</p>
</li>
<li>
<p>システムの運用日時</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>パラメータを与える方法は、以下のとおりである。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch04_JobParameter_HowToUse_CLIArgs">コマンドライン引数から与える</a></p>
</li>
<li>
<p><a href="#Ch04_JobParameter_HowToUse_FromFile">ファイルから標準入力へリダイレクトする</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>指定したパラメータは、Bean定義やSpring管理下のJavaで参照できる。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_JobParameter_HowToUse"><a class="anchor" href="#Ch04_JobParameter_HowToUse"></a>4.2.2. How to use</h4>
<div class="sect4">
<h5 id="Ch04_JobParameter_HowToUse_Converter"><a class="anchor" href="#Ch04_JobParameter_HowToUse_Converter"></a>4.2.2.1. パラメータ変換クラスについて</h5>
<div class="paragraph">
<p>Spring Batchでは、受け取ったパラメータを以下の流れで処理する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>JobParametersConverter</code>の実装クラスが<code>JobParameters</code>に変換する。</p>
</li>
<li>
<p>Bean定義やSpring管理下のJavaにて<code>JobParameters</code>からパラメータを参照する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">パラメータ変換クラスの実装クラスについて</div>
<p>前述した<code>JobParametersConverter</code>の実装クラスは複数提供されている。
以下にそれぞれの特徴を示す。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DefaultJobParametersConverter</p>
<div class="ulist">
<ul>
<li>
<p>パラメータのデータ型を指定することができる(String、Long、Date、Doubleの4種類)。</p>
</li>
</ul>
</div>
</li>
<li>
<p>JsrJobParametersConverter</p>
<div class="ulist">
<ul>
<li>
<p>パラメータのデータ型を指定することができない(Stringのみ)。</p>
</li>
<li>
<p>パラメータにジョブ実行を識別するID(RUN_ID)を<code>jsr_batch_run_id</code>という名称で自動的に付与する。</p>
<div class="ulist">
<ul>
<li>
<p>RUN_IDは、ジョブが実行される都度増加する。増加は、データベースのSEQUENCE(名称は<code>JOB_SEQ</code>となる)を利用するため、重複することがない。</p>
</li>
<li>
<p>Spring Batchでは、同じパラメータで起動したジョブは同一ジョブとして認識され、同一ジョブは1度しか実行できない、という仕様がある。
これに対し、<code>jsr_batch_run_id</code>という名称のパラメータを一意な値で付加することにより、別のジョブと認識する仕組みとなっている。
詳細は、<a href="#Ch02_SpringBatchArch">Spring Batchのアーキテクチャ</a>を参照すること。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring BatchではBean定義で使用する<code>JobParametersConverter</code>の実装クラスを指定しない場合、<code>DefaultJobParametersConverter</code>が使用される。<br>
しかし、Macchinetta Batch 2.xでは以下の理由により<code>DefaultJobParametersConverter</code>は採用しない。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1つのジョブを同じパラメータによって、異なるタイミングで起動することは一般的である。</p>
</li>
<li>
<p>起動時刻のタイムスタンプなどを指定し、異なるジョブとして管理することも可能だが、それだけのためにジョブパラメータを指定するのは煩雑である。</p>
</li>
<li>
<p><code>DefaultJobParametersConverter</code>はパラメータに対しデータ型を指定することができるが、型変換に失敗した場合のハンドリングが煩雑になる。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Macchinetta Batch 2.xでは、<code>JsrJobParametersConverter</code>を利用することで、ユーザが意識することなく自動的にRUN_IDを付与している。
この仕組みにより、ユーザから見ると同一ジョブをSpring Batchとしては異なるジョブとして扱っている。</p>
</div>
<div class="paragraph">
<div class="title">パラメータ変換クラスの設定について</div>
<p>Macchinetta Batch 2.xでは、予め<code>launch-context.xml</code>にて<code>JsrJobParametersConverter</code>を使用するように設定している。<br>
そのためMacchinetta Batch 2.xを推奨設定で使用する場合は<code>JobParametersConverter</code>の設定を行う必要はない。</p>
</div>
<div class="listingblock">
<div class="title">META-INF\spring\launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersConverter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.jsr.JsrJobParametersConverter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:dataSource-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminDataSource</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobOperator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.launch.support.SimpleJobOperator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:jobRepository-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:jobRegistry-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:jobExplorer-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExplorer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:jobParametersConverter-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersConverter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:jobLauncher-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLauncher</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>以降は<code>JsrJobParametersConverter</code>を利用する前提で説明する。</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_JobParameter_HowToUse_CLIArgs"><a class="anchor" href="#Ch04_JobParameter_HowToUse_CLIArgs"></a>4.2.2.2. コマンドライン引数から与える</h5>
<div class="paragraph">
<p>まず、もっとも基本的な、コマンドライン引数から与える方法について説明する。</p>
</div>
<div class="paragraph">
<div class="title">パラメータの付与</div>
<p>コマンドライン引数として<code>CommandLineJobRunner</code>の第3引数以降に<code>&lt;パラメータ名&gt;=&lt;値&gt;</code>形式で列挙する。</p>
</div>
<div class="paragraph">
<p>パラメータの個数や長さは、Spring BatchやMacchinetta Batch 2.xにおいては制限がない。
しかし、OSにはコマンド引数の長さに制限がある。<br>
そのため、あまりに大量の引数が必要な場合は、<a href="#Ch04_JobParameter_HowToUse_FromFile">ファイルから標準入力へリダイレクトする</a>や
<a href="#Ch04_JobParameter_HowToExtends_PropertyConbination">パラメータとプロパティの併用</a>などの方法を活用すること。</p>
</div>
<div class="listingblock">
<div class="title">コマンドライン引数としてパラメータを設定する例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID param1=abc outputFileName=/tmp/result.csv</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">パラメータの参照</div>
<p>以下のように、Bean定義またはJavaで参照することができる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bean定義で参照する</p>
<div class="ulist">
<ul>
<li>
<p><code>#{jobParameters['xxx']}</code>で参照可能</p>
</li>
</ul>
</div>
</li>
<li>
<p>Javaで参照する</p>
<div class="ulist">
<ul>
<li>
<p><code>@Value("#{jobParameters['xxx']}")</code>で参照可能</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">JobParametersを参照するBeanのスコープはStepスコープでなければならない</div>
<div class="paragraph">
<p><code>JobParameters</code>を参照する際は、参照するBeanのスコープを<code>Step</code>スコープとする必要がある。
これは、<code>JobParameters</code>を参照する際に、Spring Batchの<strong>late binding</strong>という仕組みを使用しているためである。</p>
</div>
<div class="paragraph">
<p><strong>late binding</strong>とはその名のとおり、遅延して値を設定することである。
Spring Frameworkの<code>ApplicationContext</code>は、デフォルトでは各種Beanのプロパティを解決してから<code>ApplicationContext</code>のインスタンスを生成する。
Spring Batchでは<code>ApplicationContext</code>のインスタンスを生成する時にはプロパティを解決せず、
各種Beanが必要になった際にプロパティを解決する機能をもつ。これが<strong>遅延</strong>という言葉が意味することである。
この機能により、Spring Batch自体の実行に必要な<code>ApplicationContext</code>を生成し実行した後に、
パラメータに応じて各種Beanの振る舞いを切替えることが可能となる。</p>
</div>
<div class="paragraph">
<p>なお、<code>Step</code>スコープはSpring Batch独自のスコープであり、Stepの実行ごとに新たなインスタンスが生成される。
また、<strong>late binding</strong>による値の解決は、Bean定義においてSpEL式を用いることで可能となる。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Stepスコープの指定では@StepScopeアノテーションは使用できない</div>
<div class="paragraph">
<p>Spring Batchでは、<code>Step</code>スコープを指定するアノテーションとして<code>@StepScope</code>が提供されているが、
これはJavaConfigにおいてのみ使用できるアノテーションである。</p>
</div>
<div class="paragraph">
<p>そのため、Macchinetta Batch 2.xにおける<code>Step</code>スコープの指定は以下のいずれかの方法で行う。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Bean定義では、Beanに<code>scope="step"</code>を付与する。</p>
</li>
<li>
<p>Javaでは、クラスに<code>@Scope("step")</code>を付与する。</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">コマンドライン引数で与えたパラメータをBean定義で参照する例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">beanタグにscope属性としてスコープを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">参照するパラメータを指定する。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">コマンドライン引数で与えたパラメータをJavaで参照する例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ParamRefInJavaTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="comment">/**
     * Holds a String type value
     */</span>
    <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['str']}</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (2)</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> str;

    <span class="comment">// omitted execute()</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">クラスに<code>@Scope</code>アノテーションを付与してスコープを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Value</code>アノテーションを使用して参照するパラメータを指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch04_JobParameter_HowToUse_FromFile"><a class="anchor" href="#Ch04_JobParameter_HowToUse_FromFile"></a>4.2.2.3. ファイルから標準入力へリダイレクトする</h5>
<div class="paragraph">
<p>ファイルから標準入力へリダイレクトする方法について説明する。</p>
</div>
<div class="paragraph">
<div class="title">パラメータを定義するファイルの作成</div>
<p>パラメータは下記のようにファイルに定義する。</p>
</div>
<div class="listingblock">
<div class="title">params.txt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt">param1=abc
outputFile=/tmp/result.csv</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">パラメータを定義したファイルを標準入力へリダイレクトする</div>
<p>コマンドライン引数としてパラメータを定義したファイルをリダイレクトする。</p>
</div>
<div class="listingblock">
<div class="title">実行方法</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID &lt; params.txt</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">パラメータの参照</div>
<p>パラメータの参照方法は<a href="#Ch04_JobParameter_HowToUse_CLIArgs">コマンドライン引数から与える</a>方法と同様である。</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_JobParameter_HowToUse_DefaultValue"><a class="anchor" href="#Ch04_JobParameter_HowToUse_DefaultValue"></a>4.2.2.4. パラメータのデフォルト値を設定する</h5>
<div class="paragraph">
<p>パラメータを任意とした場合、以下の形式でデフォルト値を設定することができる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>#{jobParameters['パラメータ名'] ?: デフォルト値}</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ただし、パラメータを使用して値を設定している項目であるということは、デフォルト値もパラメータと同様に環境や実行タイミングによって異なる可能性がある。</p>
</div>
<div class="paragraph">
<p>まずは、デフォルト値をソースコード上にハードコードをする方法を説明する。
しかし、後述の<a href="#Ch04_JobParameter_HowToExtends_PropertyConbination">パラメータとプロパティの併用</a>を活用する方が適切なケースが多いため、合わせて参照すること。</p>
</div>
<div class="paragraph">
<div class="title">デフォルト値を設定したパラメータの参照</div>
<p>該当するパラメータが設定されなかった場合にデフォルト値に設定した値が参照される。</p>
</div>
<div class="listingblock">
<div class="title">コマンドライン引数で与えたパラメータをBean定義で参照する例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParamaters[inputFile] ?: /input/sample.csv}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        // omitted settings
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">beanタグにscope属性としてスコープを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">参照するパラメータを指定する。<br>
デフォルト値に<code>/output/result.csv</code>を設定している。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">コマンドライン引数で与えたパラメータをJavaで参照する例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ParamRefInJavaTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="comment">/**
     * Holds a String type value
     */</span>
    <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['str'] ?: 'xyz'}</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (2)</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> str;

    <span class="comment">// omitted execute()</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">クラスに<code>@Scope</code>アノテーションを付与してスコープを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Value</code>アノテーションを使用して参照するパラメータを指定する。<br>
デフォルト値に<code>xyz</code>を設定している。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch04_JobParameter_HowToUse_ParamsValidation"><a class="anchor" href="#Ch04_JobParameter_HowToUse_ParamsValidation"></a>4.2.2.5. パラメータの妥当性検証</h5>
<div class="paragraph">
<p>オペレーションミスや意図しない挙動を防ぐために、ジョブの起動時にパラメータの妥当性検証が必要となる場合もある。<br>
パラメータの妥当性検証はSpring Batchが提供する<code>JobParametersValidator</code>を活用することで実現可能である。</p>
</div>
<div class="paragraph">
<p>パラメータはItemReader/ItemProcessor/ItemWriterといった様々な場所で参照するため、
ジョブの起動直後に妥当性検証が行われる。</p>
</div>
<div class="paragraph">
<p>パラメータの妥当性を検証する方法は2つあり、検証の複雑度によって異なる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch04_JobParameter_HowToUse_ParamsValidation_Default">簡易な妥当性検証</a></p>
<div class="ulist">
<ul>
<li>
<p>適用例</p>
<div class="ulist">
<ul>
<li>
<p>必須パラメータが設定されていることの検証</p>
</li>
<li>
<p>意図しないパラメータが設定されていないことの検証</p>
</li>
</ul>
</div>
</li>
<li>
<p>使用するバリデータ</p>
<div class="ulist">
<ul>
<li>
<p>Spring Batchが提供している<code>DefaultJobParametersValidator</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch04_JobParameter_HowToUse_ParamsValidation_Origin">複雑な妥当性検証</a></p>
<div class="ulist">
<ul>
<li>
<p>適用例</p>
<div class="ulist">
<ul>
<li>
<p>数値の範囲検証やパラメータ間の相関チェックなどの複雑な検証</p>
</li>
<li>
<p>Spring Batchが提供している<code>DefaultJobParametersValidator</code>にて実現不可能な検証</p>
</li>
</ul>
</div>
</li>
<li>
<p>使用するバリデータ</p>
<div class="ulist">
<ul>
<li>
<p><code>JobParametersValidator</code>を自作で実装したクラス</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Ch04_JobParameter_HowToUse_ParamsValidation_Default">簡易な妥当性検証</a>および<a href="#Ch04_JobParameter_HowToUse_ParamsValidation_Origin">複雑な妥当性検証</a>の妥当性を検証する方法についてそれぞれ説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch04_JobParameter_HowToUse_ParamsValidation_Default"><a class="anchor" href="#Ch04_JobParameter_HowToUse_ParamsValidation_Default"></a>4.2.2.5.1. 簡易な妥当性検証</h6>
<div class="paragraph">
<p>Spring Batchは<code>JobParametersValidator</code>のデフォルト実装として、<code>DefaultJobParametersValidator</code>を提供している。<br>
このバリデータでは設定により以下を検証することができる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>必須パラメータが設定されていること</p>
</li>
<li>
<p>必須または任意パラメータ以外のパラメータが指定されていないこと</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以下に定義例を示す。</p>
</div>
<div class="listingblock">
<div class="title">DefaultJobParametersValidatorを使用する妥当性検証の定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersValidator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.job.DefaultJobParametersValidator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">requiredKeys</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;list&gt;</span>
        <span class="tag">&lt;value&gt;</span>jsr_batch_run_id<span class="tag">&lt;/value&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;value&gt;</span>inputFileName<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;value&gt;</span>outputFileName<span class="tag">&lt;/value&gt;</span>
    <span class="tag">&lt;/list&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">optionalKeys</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
    <span class="tag">&lt;list&gt;</span>
        <span class="tag">&lt;value&gt;</span>param1<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;value&gt;</span>param2<span class="tag">&lt;/value&gt;</span>
    <span class="tag">&lt;/list&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobUseDefaultJobParametersValidator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobUseDefaultJobParametersValidator.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleTasklet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/batch:step&gt;</span>
  <span class="tag">&lt;batch:validator</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersValidator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DefaultJobParametersValidator</code>のBeanを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">必須パラメータはプロパティ<code>requiredKeys</code>に設定する。<br>
listタグを使用して必須パラメータのパラメータ名を複数指定できる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">必須パラメータに<code>jsr_batch_run_id</code>を設定する。<br>
Macchinetta Batch 2.xでは、<code>DefaultJobParametersValidator</code>を使用する場合はこの設定が必須である。<br>
必須となる理由は後述する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">任意パラメータはプロパティ<code>optionalKeys</code>に設定する。<br>
listタグを使用して任意パラメータのパラメータ名を複数指定できる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobタグ内にvalidatorタグを使用してジョブにバリデータを適用する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Macchinetta Batch 2.xでは省略できない必須パラメータ</div>
<div class="paragraph">
<p>Macchinetta Batch 2.xではパラメータ変換に<code>JsrJobParametersConverter</code>を採用しているため、以下のパラメータが常に設定される。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jsr_batch_run_id</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>そのため、<code>requiredKeys</code>には、<code>jsr_batch_run_id</code>を必ず含めること。<br>
詳細な説明は、<a href="#Ch04_JobParameter_HowToUse_Converter">パラメータ変換クラスについて</a>を参照すること。</p>
</div>
<div class="listingblock">
<div class="title">パラメータの定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersValidator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.job.DefaultJobParametersValidator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">requiredKeys</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;list&gt;</span>
        <span class="tag">&lt;value&gt;</span>jsr_batch_run_id<span class="tag">&lt;/value&gt;</span>  <span class="comment">&lt;!-- mandatory --&gt;</span>
        <span class="tag">&lt;value&gt;</span>inputFileName<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;value&gt;</span>outputFileName<span class="tag">&lt;/value&gt;</span>
    <span class="tag">&lt;/list&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">optionalKeys</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;list&gt;</span>
        <span class="tag">&lt;value&gt;</span>param1<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;value&gt;</span>param2<span class="tag">&lt;/value&gt;</span>
    <span class="tag">&lt;/list&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">DefaultJobParametersValidatorを使用した場合のOKケースとNGケース</div>
<p><code>DefaultJobParametersValidator</code>にて検証可能な条件の理解を深めるため、検証結果がOKとなる場合とNGとなる場合の例を示す。</p>
</div>
<div class="listingblock">
<div class="title">DefaultJobParametersValidator定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersValidator</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.job.DefaultJobParametersValidator</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">p:requiredKeys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outputFileName</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">p:optionalKeys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">param1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">NGケース1</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID param1=aaa</code></pre>
</div>
</div>
<div class="paragraph">
<p>必須パラメータ<code>outputFile</code>が設定されていないためNGとなる。</p>
</div>
<div class="listingblock">
<div class="title">NGケース2</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID outputFileName=/tmp/result.csv param2=aaa</code></pre>
</div>
</div>
<div class="paragraph">
<p>必須パラメータ、任意パラメータのどちらにも指定されていないパラメータ<code>param2</code>が設定されたためNGとなる。</p>
</div>
<div class="listingblock">
<div class="title">OKケース1</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID param1=aaa outputFileName=/tmp/result.csv</code></pre>
</div>
</div>
<div class="paragraph">
<p>必須および任意として指定されたパラメータが設定されているためOKとなる。</p>
</div>
<div class="listingblock">
<div class="title">OKケース2</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID fileoutputFilename=/tmp/result.csv</code></pre>
</div>
</div>
<div class="paragraph">
<p>必須パラメータが設定されているためOKとなる、任意パラメータは設定されていなくてもよい。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_JobParameter_HowToUse_ParamsValidation_Origin"><a class="anchor" href="#Ch04_JobParameter_HowToUse_ParamsValidation_Origin"></a>4.2.2.5.2. 複雑な妥当性検証</h6>
<div class="paragraph">
<p><code>JobParametersValidator</code>インターフェースの実装を自作することで、
要件に応じたパラメータの検証を実現することができる。</p>
</div>
<div class="paragraph">
<p><code>JobParametersValidator</code>クラスは以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JobParametersValidator</code>クラスを実装し、validateメソッドをオーバーライドする</p>
</li>
<li>
<p>validateメソッドは以下の要領で実装する</p>
<div class="ulist">
<ul>
<li>
<p><code>JobParameters</code>から各パラメータを取得し検証する</p>
<div class="ulist">
<ul>
<li>
<p>検証の結果がOKである場合には、何もする必要はない</p>
</li>
<li>
<p>検証の結果がNGである場合には、<code>JobParametersInvalidException</code>をスローする</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>JobParametersValidator</code>クラスの実装例を示す。
ここでは、<code>str</code>で指定された文字列の長さが、<code>num</code>で指定された数値以下であることを検証している。</p>
</div>
<div class="listingblock">
<div class="title">JobParametersValidatorインターフェースの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ComplexJobParametersValidator</span> <span class="directive">implements</span> JobParametersValidator {  <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> validate(JobParameters parameters) <span class="directive">throws</span> JobParametersInvalidException {
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, JobParameter&gt; params = parameters.getParameters();  <span class="comment">// (2)</span>

        <span class="predefined-type">String</span> str = params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">str</span><span class="delimiter">&quot;</span></span>).getValue().toString();  <span class="comment">// (3)</span>
        <span class="type">int</span> num = <span class="predefined-type">Integer</span>.parseInt(params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">num</span><span class="delimiter">&quot;</span></span>).getValue().toString()); <span class="comment">// (4)</span>

        <span class="keyword">if</span>(str.length() &gt; num){
            <span class="keyword">throw</span> <span class="keyword">new</span> JobParametersInvalidException(
            <span class="string"><span class="delimiter">&quot;</span><span class="content">The str must be less than or equal to num. [str:</span><span class="delimiter">&quot;</span></span>
                    + str + <span class="string"><span class="delimiter">&quot;</span><span class="content">][num:</span><span class="delimiter">&quot;</span></span> + num + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// (5)</span>
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobParametersValidator</code>クラスを実装しvalidateメソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">パラメータは<code>JobParameters</code>型で引数として受ける。<br>
<code>parameters.getParameters()</code>とすることで、Map形式で取得することでパラメータの参照が容易になる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">keyを指定してパラメータを取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">パラメータをint型へ変換する。String型以外を扱う場合は適宜変換を行うこと。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">パラメータ<code>str</code>の文字列長がパラメータ<code>num</code>の値を超えている場合に妥当性検証結果NGとしている。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">ジョブの定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobUseComplexJobParametersValidator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobUseComplexJobParametersValidator.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleTasklet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:validator&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch04.jobparameter.ComplexJobParametersValidator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:validator&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobタグ内にvalidatorタグを使用してジョブにバリデータを適用する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">非同期起動時におけるパラメータの妥当性検証について</div>
<div class="paragraph">
<p>非同期起動方式(DBポーリングやWebコンテナ)でも、同様にジョブ起動時に検証することは可能だが、
以下のようなタイミングでジョブを起動する前に検証することが望ましい。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DBポーリング</p>
<div class="ulist">
<ul>
<li>
<p>ジョブ要求テーブルへのINSERT前</p>
</li>
</ul>
</div>
</li>
<li>
<p>Webコンテナ</p>
<div class="ulist">
<ul>
<li>
<p>Controller呼び出し時(@Validatedを付与する)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>非同期起動の場合、結果は別途確認する必要が生じるため、パラメータ設定ミスのような
場合は早期にエラーを応答し、ジョブの要求をリジェクトすることが望ましい。</p>
</div>
<div class="paragraph">
<p>また、この時の妥当性検証において、<code>JobParametersValidator</code>を使う必要はない。
ジョブ要求テーブルへINSERTする機能や、Webコンテナ上のControllerは
多くの場合Spring Batchに依存していないはずであり、
<code>JobParametersValidator</code>を使用するためだけにSpring Batchに依存することは避けた方がよい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_JobParameter_HowToExtends"><a class="anchor" href="#Ch04_JobParameter_HowToExtends"></a>4.2.3. How to extends</h4>
<div class="sect4">
<h5 id="Ch04_JobParameter_HowToExtends_PropertyConbination"><a class="anchor" href="#Ch04_JobParameter_HowToExtends_PropertyConbination"></a>4.2.3.1. パラメータとプロパティの併用</h5>
<div class="paragraph">
<p>Spring BatchのベースであるSpring Frameworkには、プロパティ管理の機能が備わっており、
環境変数やプロパティファイルに設定した値を扱うことができる。
詳細は、Macchinetta Server 1.x 開発ガイドラインの
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/GeneralFuncDetail/PropertyManagement.html">プロパティ管理</a> を参照すること。</p>
</div>
<div class="paragraph">
<p>プロパティとパラメータを組み合わせることで、大部分のジョブに共通的な設定をプロパティファイルに行ったうえで、一部をパラメータで上書きするといったことが可能になる。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">パラメータとプロパティが解決されるタイミングについて</div>
<div class="paragraph">
<p>前述のとおり、パラメータとプロパティは、機能を提供するコンポーネントが異なる。<br>
Spring Batchはパラメータ管理の機能をもち、Spring Frameworkはプロパティ管理の機能をもつ。<br>
この差は記述方法の差に現れている。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Batchがもつ機能の場合</p>
<div class="ulist">
<ul>
<li>
<p><code>#{jobParamaters[xxx]}</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Frameworkがもつ機能の場合</p>
<div class="ulist">
<ul>
<li>
<p><code>@Value("${xxx}")</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>また、それぞれの値が解決されるタイミングが異なる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Batchがもつ機能の場合</p>
<div class="ulist">
<ul>
<li>
<p>Application Contextを生成後、ジョブを実行するタイミングで設定される。</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Frameworkがもつ機能の場合</p>
<div class="ulist">
<ul>
<li>
<p>Application Contextの生成時に設定される。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>よって、Spring Batchによるパラメータの値が優先される結果になる。<br>
この点を念頭におくと、組み合わせる際に応用が効くため両者を区別して扱うこと。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以降、プロパティとパラメータを組み合わせて設定する方法について説明する。</p>
</div>
<div class="paragraph">
<div class="title">環境変数による設定に加えて、コマンドライン引数で追加設定する場合</div>
<p>環境変数による設定に加えて、コマンドライン引数を使用してパラメータを設定する方法を説明する。<br>
Bean定義においても同様に参照可能である。</p>
</div>
<div class="listingblock">
<div class="title">環境変数に加えてコマンドライン引数でパラメータを設定する例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Set environment variables
$ export env1=aaa
$ export env2=bbb

# Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID param3=ccc outputFile=/tmp/result.csv</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Javaにおいて環境変数とパラメータを参照する例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">${env1}</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="directive">private</span> <span class="predefined-type">String</span> param1;

<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">${env2}</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="directive">private</span> <span class="predefined-type">String</span> param2;

<span class="directive">private</span> <span class="predefined-type">String</span> param3;

<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['param3']</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (2)</span>
<span class="directive">public</span> <span class="type">void</span> setParam3(<span class="predefined-type">String</span> param3) {
    <span class="local-variable">this</span>.param3 = param3;
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Value</code>アノテーションを使用して参照する環境変数を指定する。<br>
参照する際の形式は<code>${環境変数名}</code>である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Value</code>アノテーションを使用して参照するパラメータを指定する。<br>
参照する際の形式は<code>#{jobParameters['パラメータ名']</code>である。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">環境変数をデフォルトとする場合の例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Set environment variables
$ export env1=aaa

# Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID param1=bbb outputFile=/tmp/result.csv</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Javaにおいて環境変数をデフォルト値としてパラメータを参照する例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['param1'] ?: '${env1}'}</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">void</span> setParam1(<span class="predefined-type">String</span> param1) {
    <span class="local-variable">this</span>.param1 = param1;
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">環境変数をデフォルト値として<code>@Value</code>アノテーションを使用して参照するパラメータを指定する。<br>
パラメータが設定されなかった場合、環境変数の値が設定される。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">誤ったデフォルト値の設定方法</div>
<div class="paragraph">
<p>以下の要領で定義した場合、コマンドライン引数からparam1を設定しない場合に、
env1の値が設定されてほしいにも関わらず、param1にnullが設定されてしまうため注意すること。</p>
</div>
<div class="listingblock">
<div class="title">誤ったデフォルト値の設定方法例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">${env1}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">String</span> param1;

<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['param1']}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">void</span> setParam1(<span class="predefined-type">String</span> param1) {
  <span class="local-variable">this</span>.param1 = param1;
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch04_AsyncJobWithDB"><a class="anchor" href="#Ch04_AsyncJobWithDB"></a>4.3. 非同期実行(DBポーリング)</h3>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithDB_Overview"><a class="anchor" href="#Ch04_AsyncJobWithDB_Overview"></a>4.3.1. Overview</h4>
<div class="paragraph">
<p>DBポーリングによるジョブ起動について説明をする。</p>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで同じ使い方になる。</p>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Overview_AboutAsync"><a class="anchor" href="#Ch04_AsyncJobWithDB_Overview_AboutAsync"></a>4.3.1.1. DBポーリングによるジョブの非同期実行とは</h5>
<div class="paragraph">
<p>非同期実行させたいジョブを登録する専用のテーブル(以降、ジョブ要求テーブル)を一定周期で監視し、登録された情報を元にジョブを非同期実行することをいう。<br>
Macchinetta Batch 2.xでは、テーブルを監視しジョブを起動するモジュールを非同期バッチデーモンという名称で定義する。
非同期バッチデーモンは1つのJavaプロセスとして稼働し、1ジョブごとにプロセス内のスレッドを割り当てて実行する。</p>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_Overview_AboutAsync_Function"><a class="anchor" href="#Ch04_AsyncJobWithDB_Overview_AboutAsync_Function"></a>4.3.1.1.1. TERASOLUNA Batch 5.xが提供する機能</h6>
<div class="paragraph">
<p>TERASOLUNA Batch 5.xは、以下の機能を<strong>非同期実行(DBポーリング)</strong>として提供する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">非同期実行(DBポーリング)の機能一覧</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">機能</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">非同期バッチデーモン機能</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ要求テーブルポーリング機能を常駐実行させる機能</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ要求テーブルポーリング機能</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ要求テーブルに登録された情報にもとづいてジョブを非同期実行する機能。<br>
ジョブ要求テーブルのテーブル定義も合わせて提供する。</p></td>
</tr>
</tbody>
</table>
<div class="sect6">
<h7 id="Ch04_AsyncJobWithDB_Overview_AboutAsync_Function_Premise"><a class="anchor" href="#Ch04_AsyncJobWithDB_Overview_AboutAsync_Function_Premise"></a>利用前提</h7>
<div class="paragraph">
<p>ジョブ要求テーブルでは、ジョブ要求のみを管理する。要求されたジョブの実行状況および結果は、<code>JobRepository</code>に委ねる。
これら2つを通じてジョブのステータスを管理することを前提としている。<br></p>
</div>
<div class="paragraph">
<p>また、<code>JobRepository</code>にインメモリデータベースを使用すると、非同期バッチデーモン停止後に<code>JobRepository</code>がクリアされ、ジョブの実行状況および結果を参照できない。
そのため、<code>JobRepository</code>には永続性が担保されているデータベースを使用することを前提とする。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">インメモリデータベースの使用</div>
<div class="paragraph">
<p><code>JobRepository</code>を参照せずにジョブ実行結果の成否を得る手段がある場合、インメモリデータベースで運用するケースも考えられる。<br>
インメモリデータベースで長期連続運用をする場合、メモリリソースを大量消費してジョブ実行に悪影響を及ぼす可能性がある。<br>
つまり、インメモリデータベースは、長期連続運用するには向かず、定期的に再起動する運用が望ましい。<br>
それでも長期連続運用で利用したい場合は、定期的に<code>JobRepository</code>からデータを削除するなどのメンテナンス作業が必須である。<br>
再起動する場合は、初期化を有効にしておけば再起動時に再作成されるため、メンテナンスは不要である。
初期化については、<a href="#Ch03_CreateProject_Make_Setting_DB">データベース関連の設定</a>参照。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_Overview_AboutAsync_Scene"><a class="anchor" href="#Ch04_AsyncJobWithDB_Overview_AboutAsync_Scene"></a>4.3.1.1.2. 活用シーン</h6>
<div class="paragraph">
<p>非同期実行(DBポーリング)を活用するシーンを以下にいくつか示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">活用シーン一覧</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">活用シーン</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ディレード処理</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">オンライン処理と連携して、即時に完了する必要がなく、かつ、時間がかかる処理をジョブとして切り出したい場合。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理時間が短いジョブの連続実行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1ジョブあたり数秒～数十秒の処理を連続実行する場合。<br>
非同期実行(DBポーリング)を活用することで、1ジョブごとにJavaプロセスの起動・終了によるリソースの圧迫を回避できる。
また、起動・終了処理を割愛することに繋がるためジョブの実行時間を短縮することが可能となる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">大量にあるジョブの集約</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理時間が短いジョブの連続実行と同様である。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">非同期実行(Webコンテナ)と使い分けるポイント</div>
<div class="paragraph">
<p><a href="#Ch04_AsyncJobWithWeb">"非同期実行(Webコンテナ)"</a>と使い分けるポイントを以下に示す。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>バッチ処理にWebAPサーバを導入することにハードルがある</p>
</li>
<li>
<p>可用性を担保する際に、データベースのみを考慮すればよい</p>
<div class="ulist">
<ul>
<li>
<p>その代わり、データベースにアクセスが集中するため、非同期実行(Webコンテナ)ほどスケールしない可能性がある</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Spring Batch Integrationを採用しない理由</div>
<div class="paragraph">
<p>Spring Batch Integrationを利用して同様の機能を実現することは可能である。<br>
しかし、Spring Batch Integrationを使用すると非同期実行以外の要素も含めた技術要素の理解・取得が必要となる。<br>
それにより、本機能の理解/活用/カスタマイズが難しくなるのを避けるため、Spring Batch Integrationの適用は見送っている。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">非同期実行(DBポーリング)での注意点</div>
<div class="paragraph">
<p>1ジョブあたり数秒にも満たない超ショートバッチを大量に実行する場合、<code>JobRepository</code>も含めてデータベースへのアクセスが都度発生する。
この点に起因する性能劣化もあり得るため、超ショートバッチの大量処理は、非同期実行(DBポーリング)には向いていない。
本機能を利用する際はこの点を踏まえ、目標性能を満たせるか十分に検証をすること。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithDB_Arch"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch"></a>4.3.2. Architecture</h4>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Arch_Sequence"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_Sequence"></a>4.3.2.1. DBポーリングの処理シーケンス</h5>
<div class="paragraph">
<p>DBポーリングの処理シーケンスについて説明する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithDB_Sequence_db_polling.png" alt="sequence of DB polling">
</div>
<div class="title">DBポーリングのシーケンス図</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>AsyncBatchDeamon</code>をshなどから起動する。</p>
</li>
<li>
<p><code>AsyncBatchDeamon</code>は、起動時にジョブを定義したBean定義ファイルをすべて読み込む。</p>
</li>
<li>
<p><code>AsyncBatchDeamon</code>は、一定間隔でポーリングするために<code>TaskScheduler</code>を起動する。</p>
<div class="ulist">
<ul>
<li>
<p><code>TaskScheduler</code>は、一定間隔で特定の処理を起動する。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>TaskScheduler</code>は、<code>JobRequestPollTask</code>(ジョブ要求テーブルをポーリングする処理)を起動する。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>は、ジョブ要求テーブルからポーリングステータスが未実行(INIT)のレコードを取得する。</p>
<div class="ulist">
<ul>
<li>
<p>一定件数をまとめて取得する。デフォルトは3件。</p>
</li>
<li>
<p>対象のレコードが存在しない場合は、一定間隔を空けて再度ポーリングを行う。デフォルトは5秒間隔。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>JobRequestPollTask</code>は、レコードの情報にもとづいて、ジョブをスレッドに割り当てて実行する。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>は、ジョブ要求テーブルのポーリングステータスをポーリング済み(POLLED)へ更新する。</p>
<div class="ulist">
<ul>
<li>
<p>ジョブの同時実行数に達している場合は、取得したレコードから起動できないレコードを破棄し、次回ポーリング処理時にレコードを再取得する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>スレッドに割り当てられたジョブは、<code>JobOperator</code>によりジョブを開始する。</p>
</li>
<li>
<p>実行したジョブのジョブ実行ID(Job execution id)を取得する。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>は、ジョブ実行時に取得したジョブ実行IDにもとづいて、ジョブ要求テーブルのポーリングステータスをジョブ実行済み(EXECUTED)に更新する。</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">処理シーケンスの補足</div>
<div class="paragraph">
<p>Spring Batchのリファレンスでは、<code>JobLauncher</code>に<code>AsyncTaskExecutor</code>を設定することで非同期実行が実現できることを示している。
しかし、この方法を採用すると<code>AsyncTaskExecutor</code>がジョブ実行が出来ない状態を検知できない。
これは、ジョブに割り当てられるスレッドがない時などに発生し、その結果以下の事象に繋がる可能性がある。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ジョブが実行できないにも関わらず、ジョブの起動をしようとし続け不要な処理をしてしまう</p>
</li>
<li>
<p>スレッドが空いたタイミングによっては、ポーリングした順番にジョブが起動せず、ジョブ要求テーブル上ランダムに起動するように見えてしまう</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>この事象を回避するため前述の処理シーケンスとなっている。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Arch_RequireTable"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_RequireTable"></a>4.3.2.2. ポーリングするテーブルについて</h5>
<div class="paragraph">
<p>非同期実行(DBポーリング)でポーリングを行うテーブルについて説明する。</p>
</div>
<div class="paragraph">
<p>以下データベースオブジェクトを必要とする。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ジョブ要求テーブル(必須)</p>
</li>
<li>
<p>ジョブシーケンス(データベース製品によっては必須)</p>
<div class="ulist">
<ul>
<li>
<p>データベースがカラムの自動採番に対応していない場合に必要となる。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_Arch_RequireTable_TableStructure"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_RequireTable_TableStructure"></a>4.3.2.2.1. ジョブ要求テーブルの構造</h6>
<div class="paragraph">
<p>以下に、TERASOLUNA Batch 5.xが対応しているデータベース製品のうち、PostgreSQLの場合を示す。
その他のデータベースについては、TERASOLUNA Batch 5.xのjarに同梱されているDDLを参照してほしい。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">ジョブ要求テーブルへ格納する文字列について</div>
<div class="paragraph">
<p>メタデータテーブルと同様にジョブ要求テーブルのカラムは、明示的に文字データ型を文字数定義に設定するDDLを提供する。</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">batch_job_request (PostgreSQLの場合)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">カラム名</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">制約</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">job_seq_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigserial</p>
<p class="tableblock">(別途シーケンスを定義する場合は、bigintとする)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT NULL<br>
PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポーリング時に実行するジョブの順序を決める番号。<br>
データベースの自動採番機能を利用。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">job_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">varchar(100)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">実行するジョブ名。<br>
ジョブ実行時の必須パラメータ。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">job_parameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">varchar(200)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">実行するジョブに渡すパラメータ。</p>
<p class="tableblock">単一パラメータの書式は同期実行と同じだが、複数パラメータを指定する場合は、同期型実行の空白区切りとは異なり、
各パラメータをカンマ区切り(下記参照)にする必要がある。<br></p>
<p class="tableblock">{パラメータ名}={パラメータ値},{パラメータ名}={パラメータ値}&#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">job_execution_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ実行時に払い出されるID。<br>
このIDをキーにして<code>JobRepository</code>を参照する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">polling_status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">varchar(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポーリング処理状況。<br>
INIT : 未実行<br>
POLLED: ポーリング済み<br>
EXECUTED : ジョブ実行済み</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">create_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ要求のレコードを登録した日時。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">update_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ要求のレコードを更新した日時。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>DDLは以下のとおり。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> batch_job_request (
    job_seq_id bigserial <span class="directive">PRIMARY</span> <span class="type">KEY</span>,
    job_name <span class="predefined-type">varchar</span>(<span class="integer">100</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    job_parameter <span class="predefined-type">varchar</span>(<span class="integer">200</span>),
    job_execution_id <span class="predefined-type">bigint</span>,
    polling_status <span class="predefined-type">varchar</span>(<span class="integer">10</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    create_date <span class="predefined-type">timestamp</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    update_date <span class="predefined-type">timestamp</span>
);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_Arch_RequireTable_SequenceStructure"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_RequireTable_SequenceStructure"></a>4.3.2.2.2. ジョブ要求シーケンスの構造</h6>
<div class="paragraph">
<p>データベースがカラムの自動採番に対応していない場合は、シーケンスによる採番が必要になる。<br>
以下に、TERASOLUNA Batch 5.xが対応しているデータベース製品のうち、PostgreSQLの場合を示す。<br>
その他のデータベースについては、TERASOLUNA Batch 5.xのjarに同梱されているDDLを参照してほしい。</p>
</div>
<div class="paragraph">
<p>DDLは以下のとおり。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> SEQUENCE batch_job_request_seq MAXVALUE <span class="integer">9223372036854775807</span> NO CYCLE;</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>カラムの自動採番に対応しているデータベースについては、TERASOLUNA Batch 5.xのjarに同梱されているDDLにジョブ要求シーケンスは定義されていない。
シーケンスの最大値を変更したい場合などには<code>job_seq_id</code>のデータ型を自動採番の定義から数値型
(PostgreSQL場合だと、<code>bigserial</code>から<code>bigint</code>)に変更した上で、
ジョブ要求シーケンスを定義すると良い。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_Arch_RequireTable_PollingStatus"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_RequireTable_PollingStatus"></a>4.3.2.2.3. ポーリングステータス(polling_status)の遷移パターン</h6>
<div class="paragraph">
<p>ポーリングステータスの遷移パターンを下表に示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">ポーリングステータスの遷移パターン一覧</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">遷移元</th>
<th class="tableblock halign-left valign-top">遷移先</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">同時実行数に達して、ジョブの実行を拒否された場合はステータスの変更はない。<br>
次回ポーリング時にポーリング対象のレコードとなる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">POLLED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの起動に成功した時に遷移する。<br>
ジョブを実行している時のステータス。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">POLLED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXECUTED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの実行が終了した時に遷移する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_Arch_RequireTable_SQL"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_RequireTable_SQL"></a>4.3.2.2.4. ジョブ要求取得SQL</h6>
<div class="paragraph">
<p>ジョブの同時実行数分のジョブ要求を取得するため、ジョブ要求取得SQLでは取得する件数を制限している。<br>
ジョブ要求取得SQLは使用するデータベース製品およびバージョンによって異なる記述になる。
そのため、TERASOLUNA Batch 5.xが提供しているSQLでは対応できない場合がある。<br>
その場合は<a href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable">ジョブ要求テーブルのカスタマイズ</a>を参考に、
<code>BatchJobRequestMapper.xml</code>のSQLMapを再定義する必要がある。<br>
提供しているSQLについては、TERASOLUNA Batch 5.xのjarに同梱されている<code>BatchJobRequestMapper.xml</code>を参照のこと。</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Arch_JobLaunching"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_JobLaunching"></a>4.3.2.3. ジョブの起動について</h5>
<div class="paragraph">
<p>ジョブの起動方法について説明をする。</p>
</div>
<div class="paragraph">
<p>TERASOLUNA Batch 5.xのジョブ要求テーブルポーリング機能内部では、
Spring Batchから提供されている<code>JobOperator</code>の<code>start</code>メソッドでジョブを起動する。</p>
</div>
<div class="paragraph">
<p>Macchinetta Batch 2.xでは、非同期実行(DBポーリング)で起動したジョブのリスタートは、
コマンドラインからの実行をガイドしている。
そのため、<code>JobOperator</code>には<code>start</code>以外にも<code>restart</code>などの起動メソッドがあるが、
<code>start</code>メソッド以外は使用していない。</p>
</div>
<div class="dlist">
<div class="title">startメソッドの引数</div>
<dl>
<dt class="hdlist1">jobName</dt>
<dd>
<p>ジョブ要求テーブルの<code>job_name</code>に登録した値を設定する。</p>
</dd>
<dt class="hdlist1">jobParametrers</dt>
<dd>
<p>ジョブ要求テーブルの<code>job_parameters</code>に登録した値を設定する。</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Arch_OnError"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_OnError"></a>4.3.2.4. DBポーリング処理で異常が発生した場合について</h5>
<div class="paragraph">
<p>DBポーリング処理で異常が発生した場合について説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_Arch_OnError_Failure"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_OnError_Failure"></a>4.3.2.4.1. データベース接続障害</h6>
<div class="paragraph">
<p>障害が発生した時点で行われていた処理別に振る舞いを説明する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ジョブ要求テーブルからのレコード取得時</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>JobRequestPollTask</code>はエラーとなるが、次回のポーリングにて<code>JobRequestPollTask</code>が再実行される。</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">ポーリングステータスをINITからPOLLEDに変更する間</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>JobOperator</code>によるジョブ実行前に<code>JobRequestPollTask</code>はエラー終了する。ポーリングステータスは、INITのままになる。</p>
</li>
<li>
<p>接続障害回復後に行われるポーリング処理では、ジョブ要求テーブルに変更がないため実行対象となり、次回ポーリング時にジョブが実行される。</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">ポーリングステータスをPOLLEDからEXECUTEDに変更する間</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>JobRequestPollTask</code>は、ジョブ実行IDをジョブ要求テーブルに更新することができずにエラー終了する。ポーリングステータスは、POLLEDのままになる。</p>
</li>
<li>
<p>接続障害回復後に行われるポーリング処理の対象外となり、障害時のジョブは実行されない。</p>
</li>
<li>
<p>ジョブ要求テーブルからジョブ実行IDを知ることができないため、ジョブの最終状態をログや<code>JobRepository</code>から判断し、必要に応じてジョブの再実行など回復処理を行う。</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>JobRequestPollTask</code>で例外が発生しても、即座に自動復旧しようとはしない。以下に理由を示す。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>JobRequestPollTask</code>は、一定間隔で起動するため、これに委ねることで(即座ではないが)自動復旧できる。</p>
</li>
<li>
<p>障害発生時に即座にリトライしても回復できるケースは稀であり、かえってリトライにより負荷を発生してしまう可能性がある。</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_Arch_OnError_Abend"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_OnError_Abend"></a>4.3.2.4.2. 非同期バッチデーモンのプロセス異常終了</h6>
<div class="paragraph">
<p>非同期バッチデーモンのプロセスが異常終了した場合は、実行中ジョブのトランザクションは暗黙的にロールバックされる。<br>
ポーリングステータスによる状態はデータベース接続障害と同じになる。</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Arch_Shutdown"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_Shutdown"></a>4.3.2.5. DBポーリング処理の停止について</h5>
<div class="paragraph">
<p>非同期バッチデーモン(<code>AsyncBatchDeamon</code>)は、ファイルの生成によって停止する。
ファイルが生成されたことを確認後、ポーリング処理を空振りさせ、起動中ジョブの終了を可能な限り待ってから停止する。</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Arch_Components"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_Components"></a>4.3.2.6. 非同期実行特有のアプリケーション構成となる点について</h5>
<div class="paragraph">
<p>非同期実行における特有の構成を説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_Arch_Components_AppCtx"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_Components_AppCtx"></a>4.3.2.6.1. ApplicationContextの構成</h6>
<div class="paragraph">
<p>非同期バッチデーモンは、非同期実行専用の<code>async-batch-daemon.xml</code>をApplicationContextとして読み込む。
同期実行でも使用している<code>launch-context.xml</code>の他に次の構成を追加している。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">非同期実行設定</dt>
<dd>
<p><code>JobRequestPollTask</code>などの非同期実行に必要なBeanを定義している。</p>
</dd>
<dt class="hdlist1">ジョブ登録設定</dt>
<dd>
<p>非同期実行として実行するジョブは、<code>org.springframework.batch.core.configuration.support.AutomaticJobRegistrar</code>で登録を行う。
<code>AutomaticJobRegistrar</code>を用いることで、ジョブ単位にコンテキストのモジュール化を行っている。
モジュール化することにより、ジョブ間で利用するBeanIDが重複していても問題にならないようにしている。</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">モジュール化とは</div>
<div class="paragraph">
<p>モジュール化とは、「共通定義-各ジョブ定義」の階層構造になっており、各ジョブで定義されたBeanは、ジョブ間で独立したコンテキストに属することである。
各ジョブ定義で定義されていないBeanへの参照がある場合は、共通定義で定義されたBeanを参照することになる。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_Arch_Config"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_Config"></a>4.3.2.6.2. Bean定義の構成</h6>
<div class="paragraph">
<p>ジョブのBean定義は、同期実行のBean定義と同じ構成でよい。ただし、以下の注意点がある。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AutomaticJobRegistrar</code>でジョブを登録する際、ジョブのBeanIDは識別子となるため重複をしてはいけない。</p>
</li>
<li>
<p>ステップのBeanIDも重複しないことが望ましい。</p>
<div class="ulist">
<ul>
<li>
<p>設計時に、BeanIDの命名規則を<code>{ジョブID}.{ステップID}</code>とすることで、ジョブIDのみ一意に設計すればよい。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ジョブのBean定義における<code>job-base-context.xml</code>のインポートは、同期実行と非同期実行で挙動が異なる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>同期実行では、<code>job-base-context.xml</code>から更に<code>launch-context.xml</code>をインポートする。</p>
</li>
<li>
<p>非同期実行では、<code>job-base-context.xml</code>から<code>launch-context.xml</code>をインポートしない。
その代わりに<code>AsyncBatchDeamon</code>がロードする<code>async-batch-daemon.xml</code>にて、
<code>launch-context.xml</code>をインポートする。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これは、Spring Batchを起動する際に必要な各種Beanは各ジョブごとにインスタンス化する必要はないことに起因する。
Spring Batchの起動に必要な各種Beanは各ジョブの親となる共通定義(<code>async-batch-daemon.xml</code>)にて1つだけ生成すればよい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithDB_HowToUse"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse"></a>4.3.3. How to use</h4>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToUse_Config"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Config"></a>4.3.3.1. 各種設定</h5>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToUse_Config_Polling"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Config_Polling"></a>4.3.3.1.1. ポーリング処理の設定</h6>
<div class="paragraph">
<p>非同期実行に必要な設定は、<code>batch-application.properties</code>で行う。</p>
</div>
<div class="listingblock">
<div class="title">batch-application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">#(1)
# Admin DataSource settings.
admin.jdbc.driver=org.postgresql.Driver
admin.jdbc.url=jdbc:postgresql://localhost:5432/postgres
admin.jdbc.username=postgres
admin.jdbc.password=postgres

# TERASOLUNA AsyncBatchDaemon settings.
# (2)
async-batch-daemon.schema.script=classpath:org/terasoluna/batch/async/db/schema-postgresql.sql
# (3)
async-batch-daemon.job-concurrency-num=3
# (4)
async-batch-daemon.polling-interval=5000
# (5)
async-batch-daemon.polling-initial-delay=1000
# (6)
async-batch-daemon.polling-stop-file-path=/tmp/stop-async-batch-daemon</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ要求テーブルが格納されているデータベースへの接続設定。<br>
デフォルトでは<code>JobRepository</code>の設定を使用する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ要求テーブルを定義するDDLのパス。<br>
非同期バッチデーモン起動時にジョブ要求テーブルがない場合は、自動生成される。<br>
これは主に試験用機能であり、<code>batch-application.properties</code>内の<br>
<code>data-source.initialize.enabled</code>で実行可否を設定できる。<br>
詳細な定義は<code>async-batch-daemon.xml</code>内の<code>&lt;jdbc:initialize-database&gt;</code>を参照のこと。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポーリング時に一括で取得する件数の設定。この設定値は同時並行数としても用いる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポーリング周期の設定。単位はミリ秒。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポーリング初回起動遅延時間の設定。単位はミリ秒。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">終了ファイルパスの設定。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">環境変数による設定値の変更</div>
<div class="paragraph">
<p><code>batch-application.properties</code>の設定値は、同名の環境変数を定義することで設定の変更が可能である。<br>
環境変数が設定された場合は、プロパティ値より優先して使用される。<br>
これは、以下のBean定義に起因する。</p>
</div>
<div class="listingblock">
<div class="title">launch-context.xmlの設定箇所</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;context:property-placeholder</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:batch-application.properties</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">system-properties-mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">OVERRIDE</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">ignore-resource-not-found</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">ignore-unresolvable</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">order</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>詳細については、Macchinetta Server 1.x 開発ガイドラインの
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/GeneralFuncDetail/PropertyManagement.html#technical-details-label">プロパティファイル定義方法について</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToUse_Config_Job"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Config_Job"></a>4.3.3.1.2. ジョブの設定</h6>
<div class="paragraph">
<p>非同期実行する対象のジョブは、<code>async-batch-daemon.xml</code>の<code>automaticJobRegistrar</code>に設定する。<br>
以下に初期設定を示す。</p>
</div>
<div class="listingblock">
<div class="title">async-batch-daemon.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">automaticJobRegistrar</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.AutomaticJobRegistrar</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">applicationContextFactories</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.ClasspathXmlApplicationContextsFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resources</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="tag">&lt;value&gt;</span>classpath:/META-INF/jobs/**/*.xml<span class="tag">&lt;/value&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLoader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.DefaultJobLoader</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:jobRegistry-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">非同期実行するジョブBean定義のパス。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">登録ジョブの絞込みについて</div>
<div class="paragraph">
<p>登録するジョブは、非同期実行することを前提に設計・実装されたジョブを指定すること。
非同期で実行することを想定していないジョブを含めて指定すると、ジョブ登録時に意図しない参照により例外が発生することもあるので注意すること。</p>
</div>
<div class="listingblock">
<div class="title">絞込の例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">automaticJobRegistrar</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.AutomaticJobRegistrar</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">applicationContextFactories</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.ClasspathXmlApplicationContextsFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resources</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="comment">&lt;!-- For the async directory and below --&gt;</span>
                    <span class="tag">&lt;value&gt;</span>classpath:/META-INF/jobs/aysnc/**/*.xml<span class="tag">&lt;/value&gt;</span>
                    <span class="comment">&lt;!-- For a specific job --&gt;</span>
                    <span class="tag">&lt;value&gt;</span>classpath:/META-INF/jobs/CASE100/SpecialJob.xml<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLoader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.DefaultJobLoader</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:jobRegistry-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">ジョブパラメータの入力値検証</div>
<div class="paragraph">
<p><code>JobPollingTask</code>は、ジョブ要求テーブルから取得したレコードについて妥当性検証をしない。<br>
よって、テーブルに登録する側にてジョブ名やジョブパラメータについて検証することが望ましい。<br>
ジョブ名が誤っていると、ジョブを起動するが見つからず、例外が発生してしまう。<br>
ジョブパラメータが誤っていると、ジョブは起動するが誤動作してしまう。<br>
ジョブパラメータに限っては、ジョブ起動後に検証を行うことができる。ジョブパラメータの検証については、
<a href="#Ch04_JobParameter_HowToUse_ParamsValidation">"パラメータの妥当性検証"</a>を参照のこと。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">ジョブ設計上の留意点</div>
<div class="paragraph">
<p>非同期実行(DBポーリング)の特性上、同一ジョブの並列実行が可能になっているので、並列実行した場合に同一ジョブが影響を与えないようにする必要がある。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToUse_Daemon"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Daemon"></a>4.3.3.2. 非同期処理の起動から終了まで</h5>
<div class="paragraph">
<p>非同期バッチデーモンの起動と終了、ジョブ要求テーブルへの登録方法について説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToUse_Daemon_Launch"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Daemon_Launch"></a>4.3.3.2.1. 非同期バッチデーモンの起動</h6>
<div class="paragraph">
<p>TERASOLUNA Batch 5.xが提供する、<code>AsyncBatchDaemon</code>を起動する。</p>
</div>
<div class="listingblock">
<div class="title">AsyncBatchDaemonの起動</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Start AsyncBatchDaemon
$ java -cp dependency/* org.terasoluna.batch.async.db.AsyncBatchDaemon</code></pre>
</div>
</div>
<div class="paragraph">
<p>この場合、<code>META-INF/spring/async-batch-daemon.xml</code>を読み込み各種Beanを生成する。</p>
</div>
<div class="paragraph">
<p>また、別途カスタマイズした<code>async-batch-daemon.xml</code>を利用したい場合は第一引数に指定して<code>AsyncBatchDaemon</code>を起動することで実現できる。<br>
引数に指定するBean定義ファイルは、クラスパスからの相対パスで指定すること。<br>
なお、第二引数以降は無視される。</p>
</div>
<div class="listingblock">
<div class="title">カスタマイズしたMETA-INF/spring/customized-async-batch-daemon.xmlを利用する場合</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Start AsyncBatchDaemon
$ java -cp dependency/* org.terasoluna.batch.async.db.AsyncBatchDaemon \
    META-INF/spring/customized-async-batch-daemon.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>async-batch-daemon.xml</code>のカスタマイズは、ごく一部の設定を変更する場合は直接修正してよい。<br>
しかし、大幅な変更を加える場合や、後述する<a href="#Ch04_AsyncJobWithDB_HowToExtend_MultiDaemon">複数起動</a>にて複数の設定を管理する場合は、
別途ファイルを作成して管理するほうが扱いやすい。<br>
ユーザの状況に応じて選択すること。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>dependency配下には、実行に必要なjar一式が格納されている前提とする。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToUse_Daemon_Request"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Daemon_Request"></a>4.3.3.2.2. ジョブの要求</h6>
<div class="paragraph">
<p>INSERT文のSQLを発行することでジョブ要求テーブルに登録を行う。</p>
</div>
<div class="listingblock">
<div class="title">PostgreSQLの場合</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">INSERT</span> <span class="class">INTO</span> batch_job_request(job_name,job_parameter,polling_status,create_date)
<span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">JOB01</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">param1=dummy,param2=100</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">INIT</span><span class="delimiter">'</span></span>, current_timestamp);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToUse_Daemon_Stop"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Daemon_Stop"></a>4.3.3.2.3. 非同期バッチデーモンの停止</h6>
<div class="paragraph">
<p><code>batch-application.properties</code>に設定した終了ファイルを置く。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ touch /tmp/stop-async-batch-daemon</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">非同期バッチデーモン起動前に終了ファイルがある場合</div>
<div class="paragraph">
<p>非同期バッチデーモン起動前に終了ファイルがある場合、非同期バッチデーモンは即時終了する。
非同期バッチデーモンは、終了ファイルがない状態で起動する必要がある。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToUse_RefStatus"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_RefStatus"></a>4.3.3.3. ジョブのステータス確認</h5>
<div class="paragraph">
<p>ジョブの状態管理はSpring Batchから提供される<code>JobRepository</code>で行い、ジョブ要求テーブルではジョブのステータスを管理しない。
ジョブ要求テーブルでは<code>job_execution_id</code>のカラムをもち、このカラムに格納される値により個々の要求に対するジョブのステータスを確認できるようにしている。
ここでは、SQLを直接発行してジョブのステータスを確認する簡単な例を示す。
ジョブステータス確認の詳細は、<a href="#Ch07_JobManagement_HowToUse_JobStatusManagement_Retrieve">"状態の確認"</a>を参照のこと。</p>
</div>
<div class="listingblock">
<div class="title">PostgreSQLの場合</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> job_execution_id <span class="keyword">FROM</span> batch_job_request <span class="keyword">WHERE</span> job_seq_id = <span class="integer">1</span>;

job_execution_id
<span class="comment">----------------</span>
              <span class="integer">2</span>
(<span class="integer">1</span> <span class="type">row</span>)

<span class="class">SELECT</span> * <span class="keyword">FROM</span> batch_job_execution <span class="keyword">WHERE</span> job_execution_id = <span class="integer">2</span>;

job_execution_id | version | job_instance_id |       create_time       |       start_time        |        end_time         |  status   | exit_code | exit_message |
ocation
<span class="comment">------------------+---------+-----------------+-------------------------+-------------------------+-------------------------+-----------+-----------+--------------+-</span>
<span class="comment">--------</span>
              <span class="integer">2</span> |       <span class="integer">2</span> |               <span class="integer">2</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-06</span> <span class="integer">20</span>:<span class="integer">54</span>:<span class="float">02.263</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-06</span> <span class="integer">20</span>:<span class="integer">54</span>:<span class="float">02.295</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-06</span> <span class="integer">20</span>:<span class="integer">54</span>:<span class="float">02.428</span> | COMPLETED | COMPLETED |              |
(<span class="integer">1</span> <span class="type">row</span>)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToUse_Recovery"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Recovery"></a>4.3.3.4. ジョブが異常終了した後のリカバリ</h5>
<div class="paragraph">
<p>異常終了したジョブのリカバリに関する基本事項は、<a href="#Ch06_RerunRestart">"処理の再実行"</a>を参照のこと。ここでは、非同期実行特有の事項について説明をする。</p>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToUse_Recovery_Rerun"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Recovery_Rerun"></a>4.3.3.4.1. リラン</h6>
<div class="paragraph">
<p>異常終了したジョブのリランは、ジョブ要求テーブルに別レコードとしてINSERTすることで行う。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToUse_Recovery_Restart"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Recovery_Restart"></a>4.3.3.4.2. リスタート</h6>
<div class="paragraph">
<p>異常終了したジョブをリスタートする場合は、コマンドラインから同期実行ジョブとして実行する。
コマンドラインからの実行する理由は、「意図したリスタート実行なのか意図しない重複実行であるかの判断が難しいため、運用で混乱をきたす可能性がある」ためである。<br>
リスタート方法は<a href="#Ch06_RerunRestart_HowToUse_Restart">"ジョブのリスタート"</a>を参照のこと。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToUse_Recovery_Stop"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Recovery_Stop"></a>4.3.3.4.3. 停止</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>処理時間が想定を超えて停止していない場合は、コマンドラインからの停止を試みる。
停止方法は<a href="#Ch07_JobManagement_HowToUse_JobStatusManagement_JobStop">"ジョブの停止"</a>を参照のこと。</p>
</li>
<li>
<p>コマンドラインからの停止も受け付けない場合は、<a href="#Ch04_AsyncJobWithDB_HowToUse_Daemon_Stop">非同期バッチデーモンの停止</a>により、非同期バッチデーモンを終了させる。</p>
</li>
<li>
<p>非同期バッチデーモンも終了できない状態になっている場合は、非同期バッチデーモンのプロセスを強制終了させる。</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>非同期バッチデーモンを終了させる場合は、他のジョブに影響がないように十分に注意して行う。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToUse_Env"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Env"></a>4.3.3.5. 環境配備について</h5>
<div class="paragraph">
<p>ジョブのビルドとデプロイは同期実行と同じである。ただし、<a href="#Ch04_AsyncJobWithDB_HowToUse_Config_Job">ジョブの設定</a>にもあるとおり非同期実行するジョブの絞込みをしておくことが重要である。</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToUse_CumulativeData"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_CumulativeData"></a>4.3.3.6. 累積データの退避について</h5>
<div class="paragraph">
<p>非同期バッチデーモンを長期運用していると<code>JobRepository</code>とジョブ要求テーブルに膨大なデータが累積されていく。以下の理由によりこれらの累積データを退避させる必要がある。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>膨大なデータ量に対してデータを検索/更新する際の性能劣化</p>
</li>
<li>
<p>IDの採番用シーケンスが周回することによるIDの重複</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>テーブルデータの退避やシーケンスのリセットについては、利用するデータベースのマニュアルを参照してほしい。</p>
</div>
<div class="paragraph">
<p>以下に退避対象のテーブルおよびシーケンスの一覧を示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">退避対象一覧</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">テーブル/シーケンス</th>
<th class="tableblock halign-left valign-top">提供しているフレームワーク</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_request</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">TERASOLUNA Batch 5.x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_request_seq</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_instance</p></td>
<td class="tableblock halign-left valign-top" rowspan="9"><p class="tableblock">Spring Batch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_exeution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_exeution_params</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_exeution_context</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_step_exeution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_step_exeution_context</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_seq</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_execution_seq</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_step_execution_seq</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">自動採番カラムのシーケンス</div>
<div class="paragraph">
<p>自動採番のカラムに対して自動的にシーケンスが作成されている場合があるので、忘れずにそのシーケンスも退避対象に含める。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">データベース固有の仕様について</div>
<div class="paragraph">
<p>Oracleではデータ型にCLOBを利用するなど、データベース固有のデータ型を使用している場合があるので注意をする。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithDB_HowToExtend"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToExtend"></a>4.3.4. How to extend</h4>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToExtend_CustomTable"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable"></a>4.3.4.1. ジョブ要求テーブルのカスタマイズ</h5>
<div class="paragraph">
<p>ジョブ要求テーブルは、取得レコードの抽出条件を変更するためにカラム追加をしてカスタマイズすることができる。
ただし、<code>JobRequestPollTask</code>からSQLを発行する際に渡せる項目は、
<code>BatchJobRequest</code>の項目のみである。</p>
</div>
<div class="paragraph">
<p>ジョブ要求テーブルのカスタマイズによる拡張手順は以下のとおり。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ジョブ要求テーブルのカスタマイズ</p>
</li>
<li>
<p><code>BatchJobRequestRepository</code>インターフェースの拡張インターフェースの作成</p>
</li>
<li>
<p>カスタマイズしたテーブルを使用したSQLMapの定義</p>
</li>
<li>
<p><code>async-batch-daemon.xml</code>のBean定義の修正</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>カスタマイズ例として以下のようなものがある。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable_Priority">優先度カラムによるジョブ実行順序の制御の例</a></p>
</li>
<li>
<p><a href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable_GroupID">グループIDによる複数プロセスによる分散処理</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以降、この2つの例について、拡張手順を説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToExtend_CustomTable_Priority"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable_Priority"></a>4.3.4.1.1. 優先度カラムによるジョブ実行順序の制御の例</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ジョブ要求テーブルのカスタマイズ</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>ジョブ要求テーブルに優先度カラム(priority)を追加する。</p>
</div>
<div class="listingblock">
<div class="title">優先度カラムの追加 (PostgreSQLの場合)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> batch_job_request (
    job_seq_id bigserial <span class="directive">PRIMARY</span> <span class="type">KEY</span>,
    job_name <span class="predefined-type">varchar</span>(<span class="integer">100</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    job_parameter <span class="predefined-type">varchar</span>(<span class="integer">200</span>),
    priority <span class="predefined-type">int</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    job_execution_id <span class="predefined-type">bigint</span>,
    polling_status <span class="predefined-type">varchar</span>(<span class="integer">10</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    create_date <span class="predefined-type">timestamp</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    update_date <span class="predefined-type">timestamp</span>
);</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p><code>BatchJobRequestRepository</code>インターフェースの拡張インターフェースの作成</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>BatchJobRequestRepository</code>インターフェースを拡張したインターフェースを作成する。</p>
</div>
<div class="listingblock">
<div class="title">拡張インターフェース</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">CustomizedBatchJobRequestRepository</span> <span class="directive">extends</span> BatchJobRequestRepository {
    <span class="comment">// (2)</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">拡張ポイント</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchJobRequestRepository</code>を拡張する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">メソッドは追加しない。</p></td>
</tr>
</tbody>
</table>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>カスタマイズしたテーブルを使用したSQLMapの定義</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>優先度を順序条件にしたSQLをSQLMapに定義する。</p>
</div>
<div class="listingblock">
<div class="title">SQLMap定義(CustomizedBatchJobRequestRepository.xml)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.extend.repository.CustomizedBatchJobRequestRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">find</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.async.db.model.BatchJobRequest</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        SELECT
            job_seq_id AS jobSeqId,
            job_name AS jobName,
            job_parameter AS jobParameter,
            job_execution_id AS jobExecutionId,
            polling_status AS pollingStatus,
            create_date AS createDate,
            update_date AS updateDate
        FROM
            batch_job_request
        WHERE
            polling_status = 'INIT'
        ORDER BY
            priority ASC,   <span class="comment">&lt;!--(2) --&gt;</span>
            job_seq_id ASC
        LIMIT #{pollingRowLimit}
    <span class="tag">&lt;/select&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;update</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updateStatus</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        UPDATE
            batch_job_request
        SET
            polling_status = #{batchJobRequest.pollingStatus},
            job_execution_id = #{batchJobRequest.jobExecutionId},
            update_date = #{batchJobRequest.updateDate}
        WHERE
            job_seq_id = #{batchJobRequest.jobSeqId}
        AND
            polling_status = #{pollingStatus}
    <span class="tag">&lt;/update&gt;</span>

<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">拡張ポイント</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchJobRequestRepository</code>の拡張インターフェースをFQCNでnamespaceに設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">priorityをORDER句へ追加する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新SQLは変更しない。</p></td>
</tr>
</tbody>
</table>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p><code>async-batch-daemon.xml</code>のBean定義の修正</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>(2)で作成した拡張インターフェースを<code>batchJobRequestRepository</code>に設定する。</p>
</div>
<div class="listingblock">
<div class="title">async-batch-daemon.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"> <span class="comment">&lt;!--(1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchJobRequestRepository</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.mapper.MapperFactoryBean</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:mapperInterface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.extend.repository.CustomizedBatchJobRequestRepository</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminSqlSessionFactory</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">拡張ポイント</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchJobRequestRepository</code>の拡張インターフェースをFQCNで<code>mapperInterface</code>プロパティに設定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToExtend_CustomTable_GroupID"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable_GroupID"></a>4.3.4.1.2. グループIDによる複数プロセスによる分散処理</h6>
<div class="paragraph">
<p><code>AsyncBatchDaemon</code>起動時に環境変数でグループIDを指定して、対象のジョブを絞り込む。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ジョブ要求テーブルのカスタマイズ</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>ジョブ要求テーブルにグループIDカラム(group_id)を追加する。</p>
</div>
<div class="listingblock">
<div class="title">グループIDカラムの追加 (PostgreSQLの場合)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> batch_job_request (
    job_seq_id bigserial <span class="directive">PRIMARY</span> <span class="type">KEY</span>,
    job_name <span class="predefined-type">varchar</span>(<span class="integer">100</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    job_parameter <span class="predefined-type">varchar</span>(<span class="integer">200</span>),
    group_id <span class="predefined-type">varchar</span>(<span class="integer">10</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    job_execution_id <span class="predefined-type">bigint</span>,
    polling_status <span class="predefined-type">varchar</span>(<span class="integer">10</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    create_date <span class="predefined-type">timestamp</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    update_date <span class="predefined-type">timestamp</span>
);</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p><code>BatchJobRequestRepository</code>インターフェースの拡張インターフェース作成</p>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable_Priority">優先度カラムによるジョブ実行順序の制御の例</a>と同じ</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>カスタマイズしたテーブルを使用したSQLMapの定義</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>グループIDを抽出条件にしたSQLをSQLMapに定義する。</p>
</div>
<div class="listingblock">
<div class="title">SQLMap定義(CustomizedBatchJobRequestRepository.xml)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.extend.repository.CustomizedBatchJobRequestRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">find</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.async.db.model.BatchJobRequest</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        SELECT
            job_seq_id AS jobSeqId,
            job_name AS jobName,
            job_parameter AS jobParameter,
            job_execution_id AS jobExecutionId,
            polling_status AS pollingStatus,
            create_date AS createDate,
            update_date AS updateDate
        FROM
            batch_job_request
        WHERE
            polling_status = 'INIT'
        AND
            group_id = #{groupId}  <span class="comment">&lt;!--(2) --&gt;</span>
        ORDER BY
            job_seq_id ASC
        LIMIT #{pollingRowLimit}
    <span class="tag">&lt;/select&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">拡張ポイント</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchJobRequestRepository</code>の拡張インターフェースをFQCNでnamespaceに設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">groupIdを検索条件に追加。</p></td>
</tr>
</tbody>
</table>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p><code>async-batch-daemon.xml</code>のBean定義の修正</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>(2)で作成した拡張インターフェースを<code>batchJobRequestRepository</code>に設定し、
<code>jobRequestPollTask</code>に環境変数で与えられたグループIDをクエリパラメータとして設定する。</p>
</div>
<div class="listingblock">
<div class="title">async-batch-daemon.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"> <span class="comment">&lt;!--(1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchJobRequestRepository</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.mapper.MapperFactoryBean</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:mapperInterface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.extend.repository.CustomizedBatchJobRequestRepository</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminSqlSessionFactory</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRequestPollTask</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.async.db.JobRequestPollTask</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">c:transactionManager-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminTransactionManager</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">c:jobOperator-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobOperator</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">c:batchJobRequestRepository-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchJobRequestRepository</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">c:daemonTaskExecutor-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">daemonTaskExecutor</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">c:automaticJobRegistrar-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">automaticJobRegistrar</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:optionalPollingQueryParams-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pollingQueryParam</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>

   <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pollingQueryParam</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.beans.factory.config.MapFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sourceMap</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;map&gt;</span>
                <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">groupId</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${GROUP_ID}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;/map&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
   <span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">拡張ポイント</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchJobRequestRepository</code>の拡張インターフェースをFQCNで<code>mapperInterface</code>プロパティに設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobRequestPollTask</code>の<code>optionalPollingQueryParams</code>プロパティに(3)で定義するMapを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">環境変数で与えれらたグループID(GROUP_ID)をクエリパラメータのグループID(groupId)に設定する。</p></td>
</tr>
</tbody>
</table>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>環境変数にグループIDを設定後、<code>AsyncBatchDaemon</code>を起動する。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">AsyncBatchDaemonの起動</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Set environment variables
$ export GROUP_ID=G1

# Start AsyncBatchDaemon
$ java -cp dependency/* org.terasoluna.batch.async.db.AsyncBatchDaemon</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToExtend_ClockCustomize"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToExtend_ClockCustomize"></a>4.3.4.2. タイムスタンプに用いるクロックのカスタマイズ</h5>
<div class="paragraph">
<p>タイムスタンプに用いるクロックは、デフォルト設定では<code>systemDefaultZone</code>から取得している。<br>
しかし、ある特定の時間帯はポーリングをキャンセルするといった、ジョブ要求の取得条件をシステム日時に依存した非同期バッチデーモンに拡張したい場合など、ある特定の日時を指定したり、使用するシステムと異なるタイムゾーンを使用して試験を実施したい場合がある。そのため非同期実行では、用途に合わせてカスタマイズしたクロックを設定できる機能を備えている。<br>
また、ジョブ要求テーブルからのリクエスト取得をカスタマイズしていないときのデフォルト設定において、クロックを変更したとき影響を受けるのはジョブ要求テーブルの<code>update_date</code>のみである。</p>
</div>
<div class="paragraph">
<p>クロックのカスタマイズ手順は以下のとおり。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>async-batch-daemon.xml</code>のコピーを作成</p>
</li>
<li>
<p>ファイル名を<code>customized-async-batch-daemon.xml</code>に変更</p>
</li>
<li>
<p><code>customized-async-batch-daemon.xml</code>のBean定義を修正</p>
</li>
<li>
<p>カスタマイズしたAsyncBatchDaemonを起動<br>
詳細は、<a href="#Ch04_AsyncJobWithDB_HowToUse_Daemon_Launch">非同期バッチデーモンの起動</a>を参照</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>下記に日時を固定し、タイムゾーンを変更するための設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">META-INF/spring/customized-async-batch-daemon.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRequestPollTask</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.async.db.JobRequestPollTask</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:transactionManager-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminTransactionManager</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:jobOperator-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobOperator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:batchJobRequestRepository-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchJobRequestRepository</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:daemonTaskExecutor-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">daemonTaskExecutor</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:automaticJobRegistrar-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">automaticJobRegistrar</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:clock-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clock</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>　<span class="comment">&lt;!-- (1) --&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clock</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.time.Clock</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">factory-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fixed</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:fixedInstant</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{T(java.time.ZonedDateTime).parse('2016-12-31T16:00-08:00[America/Los_Angeles]').toInstant()}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:zone</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{T(java.time.ZoneId).of('PST', T(java.time.ZoneId).SHORT_IDS)}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobRequestPollTask</code>の<code>clock</code>プロパティに(2)で定義するBeanを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日時を2016年12月31日16時0分0秒に固定し、タイムゾーンをロサンゼルス時間とした<code>java.time.Clock</code>のBeanを定義する。<br>
ロサンゼルス時間のタイムゾーンIDは<code>PST</code>である。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToExtend_MultiDaemon"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToExtend_MultiDaemon"></a>4.3.4.3. 複数起動</h5>
<div class="paragraph">
<p>以下の様な目的で、複数サーバ上で非同期バッチデーモンを起動させる場合がある。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>可用性向上</p>
<div class="ulist">
<ul>
<li>
<p>非同期バッチジョブがいずれかのサーバで実行できればよく、ジョブが起動できないという状況をなくしたい場合</p>
</li>
</ul>
</div>
</li>
<li>
<p>性能向上</p>
<div class="ulist">
<ul>
<li>
<p>複数サーバでバッチ処理の負荷を分散させたい場合</p>
</li>
</ul>
</div>
</li>
<li>
<p>リソースの有効利用</p>
<div class="ulist">
<ul>
<li>
<p>サーバ性能に差がある場合に特定のジョブを最適なリソースのサーバに振り分ける場合</p>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable">ジョブ要求テーブルのカスタマイズ</a>で提示したグループIDによるジョブノードの分割に相当</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>上記に示す観点のいずれかにもとづいて利用するのかを意識して運用設計を行うことが必要となる。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithDB_MultipleActivation.png" alt="Ch04 AsyncJobWithDB MultipleActivation">
</div>
<div class="title">複数起動の概略図</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">複数の非同期バッチデーモンが同一ジョブ要求レコードを取得した場合</div>
<div class="paragraph">
<p><code>JobRequestPollTask</code>は、楽観ロックによる排他制御を行っているため、ポーリングステータスをINITからPOLLEDへ更新できた非同期バッチデーモンが取得したレコードのジョブを実行できる。
排他された他の非同期バッチデーモンは、次のジョブ要求レコードを処理する。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithDB_Appendix"><a class="anchor" href="#Ch04_AsyncJobWithDB_Appendix"></a>4.3.5. Appendix</h4>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Appendix_Modular"><a class="anchor" href="#Ch04_AsyncJobWithDB_Appendix_Modular"></a>4.3.5.1. ジョブ定義のモジュール化について</h5>
<div class="paragraph">
<p><a href="#Ch04_AsyncJobWithDB_Arch_Components_AppCtx">ApplicationContextの構成</a>でも簡単に説明したが、<code>AutomaticJobRegistrar</code>を用いることで以下の事象を回避することができる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>同じBeanID(BeanName)を使用すると、Beanが上書きされてしまい、ジョブが意図しない動作をする。</p>
<div class="ulist">
<ul>
<li>
<p>その結果、意図しないエラーが発生する可能性が高くなる。</p>
</li>
</ul>
</div>
</li>
<li>
<p>エラーを回避するために、ジョブ全体でBeanすべてのIDが一意になるように命名しなければいけなくなる。</p>
<div class="ulist">
<ul>
<li>
<p>ジョブ数が増えてくると管理するのが困難になり、不必要なトラブルが発生する可能性が高くなる。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>AutomaticJobRegistrar</code>を使用しない場合に起こる現象について説明をする。
ここで説明する内容は上記の問題を引き起こすので、非同期実行では使用しないこと。</p>
</div>
<div class="listingblock">
<div class="title">Job1.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Reader --&gt;</span>
<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.job.repository.EmployeeRepositoy.findAll</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['basedir']}/input/employee.csv</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invoiceNo,salesDate,productId,customerId,quant,price</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>


<span class="comment">&lt;!-- Job --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job1.step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:tasklet&gt;</span>
  <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Job2.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Reader --&gt;</span>
<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['basedir']}/input/invoice.csv</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invoiceNo,salesDate,productId,customerId,quant,price</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invoiceFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.job.repository.InvoiceRepository.create</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- Job --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job2.step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:tasklet&gt;</span>
  <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">BeanIdが上書きされる定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">automaticJobRegistrar</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.AutomaticJobRegistrar</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">applicationContextFactories</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.ClasspathXmlApplicationContextsFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resources</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="tag">&lt;value&gt;</span>classpath:/META-INF/jobs/other/async/*.xml<span class="tag">&lt;/value&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLoader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.DefaultJobLoader</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:jobRegistry-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.JobRegistryBeanPostProcessor</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">p:jobRegistry-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

<span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:/META-INF/jobs/async/*.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>   <span class="comment">&lt;!-- (6) --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定のポイント一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job1ではデータベースから読み込むItemReaderを<code>reader</code>というBeanIDで定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job1ではファイルへ書き込むItemWriterを<code>writer</code>というBeanIDで定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job2ではファイルから読み込むItemReaderを<code>reader</code>というBeanIDで定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job2ではデータベースへ書き込むItemWriterを<code>writer</code>というBeanIDで定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AutomaticJobRegistrar</code>は対象となるジョブ以外のジョブ定義を読む込むように設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Springのimportを使用して、対象のJob定義を読み込むようにする。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>この場合、Job1.xml,Job2.xmlの順に読み込まれたとすると、Job1.xmlで定義されたいたreader,writerはJob2.xmlの定義で上書きされる。<br>
その結果、Job1を実行すると、Job2のreader,writerが使用されて期待した処理が行われなくなる。</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch04_AsyncJobWithWeb"><a class="anchor" href="#Ch04_AsyncJobWithWeb"></a>4.4. 非同期実行(Webコンテナ)</h3>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithWeb_Overview"><a class="anchor" href="#Ch04_AsyncJobWithWeb_Overview"></a>4.4.1. Overview</h4>
<div class="paragraph">
<p>Webコンテナ内でジョブを非同期で実行するための方法について説明する。</p>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで同じ使い方になる。</p>
</div>
<div class="paragraph">
<div class="title">Webコンテナによるジョブの非同期実行とは</div>
<p>ジョブを含めたWebアプリケーションをWebコンテナにデプロイし、
送信されたリクエストの情報を元にジョブを実行することを指す。<br>
ジョブの実行ごとに1つのスレッドを割り当てた上で並列に動作するため、
他のジョブやリクエストに対する処理とは独立して実行できる。</p>
</div>
<div class="paragraph">
<div class="title">提供機能</div>
<p>Macchinetta Batch 2.xでは、非同期実行(Webコンテナ)向けの実装は提供しない。<br>
本ガイドラインにて実現方法を提示するのみとする。<br>
これは、Webアプリケーションの起動契機はHTTP/SOAP/MQなど多様であるため、
ユーザにて実装することが適切と判断したためである。</p>
</div>
<div class="ulist">
<div class="title">利用前提</div>
<ul>
<li>
<p>アプリケーションの他にWebコンテナが必要となる。</p>
</li>
<li>
<p>ジョブの実装以外に必要となる、Webアプリケーション、クライアントは動作要件に合わせて別途実装する。</p>
</li>
<li>
<p>ジョブの実行状況および結果は<code>JobRepository</code>に委ねる。
また、Webコンテナ停止後にも<code>JobRepository</code>からジョブの実行状況および結果を参照可能とするため、
インメモリデータベースではなく、永続性が担保されているデータベースを使用する。</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">活用シーン</div>
<p><a href="#Ch04_AsyncJobWithDB_Overview">"非同期実行(DBポーリング) - Overview"</a>と同様である。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">非同期実行(DBポーリング)との違い</div>
<div class="paragraph">
<p>アーキテクチャ上、非同期実行時の即時性と、要求管理テーブルの有無、の2点が異なる。<br>
<a href="#Ch04_AsyncJobWithDB">"非同期実行(DBポーリング)"</a>は要求管理テーブルに登録された複数のジョブが一定の周期で非同期実行される。<br>
それに対し、本機能は要求管理テーブルを必要とせず代わりにWebコンテナ上で非同期実行を受け付ける。<br>
Webリクエスト送信により直ちに実行するため、起動までの即時性が求められるショートバッチに向いている。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithWeb_Arch"><a class="anchor" href="#Ch04_AsyncJobWithWeb_Arch"></a>4.4.2. Architecture</h4>
<div class="paragraph">
<p>本方式による非同期ジョブはWebコンテナ上にデプロイされたアプリケーション(war)として動作するが、
ジョブ自身はWebコンテナのリクエスト処理とは非同期(別スレッド)で動作する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithWebContainer_Sequence.png" alt="sequence of async web">
</div>
<div class="title">非同期実行(Webコンテナ)のシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">ジョブの起動</div>
<ol class="arabic">
<li>
<p>Webクライアントは実行対象のジョブをWebコンテナに要求する。</p>
</li>
<li>
<p><code>JobController</code>はSpring Batchの<code>JobOperator</code>に対しジョブの実行開始を依頼する。</p>
</li>
<li>
<p><code>ThreadPoolTaskExecutor</code>によって非同期でジョブを実行する。</p>
</li>
<li>
<p>実行された対象のジョブを一意に判別するためのジョブ実行ID(<code>job execution id</code>)を返却する。</p>
</li>
<li>
<p><code>JobController</code>はWebクライアントに対し、ジョブ実行IDを含むレスポンスを返却する。</p>
</li>
<li>
<p>目的のジョブを実行する。</p>
<div class="ulist">
<ul>
<li>
<p>ジョブの結果は<code>JobRepository</code>に反映される。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>Job</code>が実行結果を返却する。これはクライアントへ直接通知できない。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">ジョブの実行結果確認</div>
<ol class="arabic" start="8">
<li>
<p>Webクライアントはジョブ実行IDを<code>JobController</code>をWebコンテナに送信する。</p>
</li>
<li>
<p><code>JobController</code>はジョブ実行IDを用い<code>JobExplorer</code>にジョブの実行結果を問い合わせる。</p>
</li>
<li>
<p><code>JobExplorer</code>はジョブの実行結果を返却する。</p>
</li>
<li>
<p><code>JobController</code>はWebクライアントに対しレスポンスを返却する。</p>
<div class="ulist">
<ul>
<li>
<p>レスポンスにはジョブ実行IDを設定する。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Webコンテナによるリクエスト受信後、ジョブ実行ID払い出しまでがリクエスト処理と同期するが、
以降のジョブ実行はWebコンテナとは別のスレッドプールで非同期に行われる。<br>
これは再度リクエストで問い合わせを受けない限り、Webクライアント側では非同期ジョブの
実行状態が検知できないことを意味する。</p>
</div>
<div class="paragraph">
<p>このためWebクライアント側では1回のジョブ実行で、リクエストを「ジョブの起動」で1回、
「結果の確認」が必要な場合は加えてもう1回、Webコンテナにリクエストを送信する必要がある。<br>
特に初回の「ジョブの起動」時に見え方が異なる異常検知については、
後述の<a href="#Ch04_AsyncJobWithWeb_Arch_OnError">ジョブ起動時における異常発生の検知について</a>で説明する。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>JobRepository</code>、<code>JobExplorer</code>を使用して直接RDBMSを参照し、ジョブの実行状態を確認することもできる。
ジョブの実行状態・結果を参照する機能の詳細については、<a href="#Ch07_JobManagement">ジョブの管理</a>を参照のこと。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">ジョブ実行ID(job execution id)の取り扱いについて</div>
<div class="paragraph">
<p>ジョブ実行IDは起動対象が同じジョブ、同じジョブパラメータであっても、ジョブ起動ごとに異なるシーケンス値が払い出される。<br>
リクエスト送信により受付が行われたジョブ実行IDは<code>JobRepository</code>により外部RDBMSで永続化される。<br>
しかし、Webクライアントの障害などによりこのIDが消失した場合、ジョブ実行状況の特定・追跡が困難となる。<br>
このため、Webクライアント側ではレスポンスとして返却されたジョブ実行IDをログに記録するなど、ジョブ実行IDの消失に備えておくこと。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_Arch_OnError"><a class="anchor" href="#Ch04_AsyncJobWithWeb_Arch_OnError"></a>4.4.2.1. ジョブ起動時における異常発生の検知について</h5>
<div class="paragraph">
<p>Webクライアントからジョブの起動リクエストを送信後、ジョブ実行ID払い出しを境にして異常検知の見え方が異なる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ジョブ起動時のレスポンスにて異常がすぐ検知できるもの</p>
<div class="ulist">
<ul>
<li>
<p>起動対象のジョブが存在しない。</p>
</li>
<li>
<p>ジョブパラメータの形式誤り。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ジョブ起動後、Webコンテナに対しジョブ実行状態・結果の問い合わせが必要となるもの</p>
<div class="ulist">
<ul>
<li>
<p>ジョブの実行ステータス</p>
</li>
<li>
<p>非同期ジョブ実行で使用されるスレッドプールが枯渇したことによるジョブの起動失敗</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>「ジョブ起動時の異常」は Spring MVCコントローラ内で発生する例外として検知できる。
ここでは説明を割愛するので、別途 Macchinetta Server 1.x 開発ガイドラインの
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebServiceDetail/REST.html#resthowtouseexceptionhandling">例外のハンドリングの実装</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p>また、ジョブパラメータとして利用するリクエストの入力チェックは必要に応じて Spring MVC のコントローラ内で行うこと。<br>
具体的な実装方法については、Macchinetta Server 1.x 開発ガイドラインの
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebApplicationDetail/Validation.html">入力チェック</a>を参照のこと。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">スレッドプール枯渇によるジョブの起動失敗はジョブ起動時に捕捉できない</div>
<div class="paragraph">
<p>スレッドプール枯渇によるジョブの起動失敗は、<code>JobOperator</code>から例外があがってこないため、別途確認する必要がある。
確認方法の1つは、ジョブの実行状態確認時に<code>JobExplorer</code>を用い、以下の条件に合致しているかどうかである。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ステータスが<code>FAILED</code>である</p>
</li>
<li>
<p><code>jobExecution.getExitStatus().getExitDescription()</code>にて、
<code>org.springframework.core.task.TaskRejectedException</code>の例外スタックトレースが記録されている</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_Arch_Components"><a class="anchor" href="#Ch04_AsyncJobWithWeb_Arch_Components"></a>4.4.2.2. 非同期実行(Webコンテナ)のアプリケーション構成</h5>
<div class="paragraph">
<p>本機能は<a href="#Ch04_AsyncJobWithDB">"非同期実行(DBポーリング)"</a>と同様、
非同期実行特有の構成としてSpring プロファイルの<code>async</code>と<code>AutomaticJobRegistrar</code>を使用している。</p>
</div>
<div class="paragraph">
<p>一方で、これら機能を非同期実行(Webコンテナ)使用する上で、いくつかの事前知識と設定が必要となる。
<a href="#Ch04_AsyncJobWithWeb_Arch_AppCtx">"ApplicationContextの構成"</a>を参照。<br>
具体的な<code>async</code>プロファイルと<code>AutomaticJobRegistrar</code>の設定方法については
<a href="#Ch04_AsyncJobWithWeb_HowToUse_Impl">"非同期実行(Webコンテナ)によるアプリケーションの実装方法について"</a>で後述する。</p>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_Arch_AppCtx"><a class="anchor" href="#Ch04_AsyncJobWithWeb_Arch_AppCtx"></a>4.4.2.2.1. ApplicationContextの構成</h6>
<div class="paragraph">
<p>上述のとおり、非同期実行(Webコンテナ)のアプリケーション構成として、複数のアプリケーションモジュールが含まれている。<br>
それぞれのアプリケーションコンテキストとBean定義についての種類、および関係性を把握しておく必要がある。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithWebContainer_Package.png" alt="Package structure of async web">
</div>
<div class="title">ApplicationContextの構成</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithWebContainer_BeanDefinitions.png" alt="BeanDefinitions structure of async web">
</div>
<div class="title">Bean定義ファイルの構成</div>
</div>
<div class="paragraph">
<p>非同期実行(Webコンテナ)における<code>ApplicationContext</code>では、
バッチアプリケーションの<code>ApplicationContext</code>はWebのコンテキスト内に取り込まれる。<br>
個々のジョブコンテキストはこのWebコンテキストから<code>AutomaticJobRegistrar</code>によりモジュール化され、
Webコンテキストの子コンテキストとして動作する。</p>
</div>
<div class="paragraph">
<p>以下、それぞれのコンテキストを構成するBean定義ファイルについて説明する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Bean定義ファイル一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">共通Bean定義ファイル。<br>
アプリケーション内では親コンテキストとなり、子コンテキストであるジョブ間で一意に共有される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブBean定義から必ずインポートされるBean定義ファイル。<br>
Spring プロファイルが非同期実行時に指定される<code>async</code>の場合は(1)の<code>launch-context.xml</code>を読み込まない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブごとに作成するBean定義ファイル。<br>
<code>AutomaticJobRegistrar</code>によりモジュラー化され、アプリケーション内ではそれぞれ独立した子コンテキストとして使用される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DispatcherServlet</code>から読み込まれる。<br>
ジョブBean定義のモジュラー化を行う<code>AutomaticJobRegistrar</code>や、ジョブの非同期・並列実行で使用されるスレッドプールである<code>taskExecutor</code>など、非同期実行特有のBeanを定義する。<br>
また、非同期実行では(1)の<code>launch-context.xml</code><br>
を直接インポートし親コンテキストとして一意に共有化される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ContextLoaderListener</code>により、Webアプリケーション内で共有される親コンテキストとなる。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithWeb_HowToUse"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse"></a>4.4.3. How to use</h4>
<div class="paragraph">
<p>ここでは、Webアプリケーション側の実装例として、Macchinetta Server Framework (1.x)を用いて説明する。<br>
あくまで説明のためであり、Macchinetta Server 1.xは非同期実行(Webコンテナ)の必須要件ではないことに留意してほしい。</p>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_HowToUse_Impl"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_Impl"></a>4.4.3.1. 非同期実行(Webコンテナ)によるアプリケーションの実装概要</h5>
<div class="paragraph">
<p>以下の構成を前提とし説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Webアプリケーションプロジェクトとバッチアプリケーションプロジェクトは独立し、
webアプリケーションからバッチアプリケーションを参照する。</p>
<div class="ulist">
<ul>
<li>
<p>Webアプリケーションプロジェクトから生成するwarファイルは、
バッチアプリケーションプロジェクトから生成されるjarファイルを含むこととなる</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>非同期実行の実装は<a href="#Ch04_AsyncJobWithWeb_Arch">Architecture</a>に従い、Webアプリケーション内の
Spring MVCコントローラが、<code>JobOperator</code>によりジョブを起動する。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Web/バッチアプリケーションプロジェクトの分離について</div>
<div class="paragraph">
<p>アプリケーションビルドの最終成果物はWebアプリケーションのwarファイルであるが、
開発プロジェクトはWeb/バッチアプリケーションで分離して実装を行うとよい。<br>
これはバッチアプリケーション単体で動作可能なライブラリとなるため、開発プロジェクト上の試験を
容易にする他、作業境界とライブラリ依存関係を明確にする効果がある。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以降、Web/バッチの開発について、以下2つを利用する前提で説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Macchinetta Batch 2.xによるバッチアプリケーションプロジェクト</p>
</li>
<li>
<p>Macchinetta Server 1.xによるWebアプリケーションプロジェクト</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>バッチアプリケーションプロジェクトの作成および具体的なジョブの実装方法については、
<a href="#Ch03_CreateProject_HowToCreate">"プロジェクトの作成"</a>、
<a href="#Ch03_CreateTaskletJob">"タスクレットモデルジョブの作成"</a>、
<a href="#Ch03_CreateChunkJob">"チャンクモデルジョブの作成"</a>
を参照のこと。
ここでは、Webアプリケーションからバッチアプリケーションを起動することに終始する。</p>
</div>
<div class="paragraph">
<p>ここでは Maven archetype:generate を用い、
以下のバッチアプリケーションプロジェクトを作成しているものとして説明する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">ジョブプロジェクト作成例</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">名称</th>
<th class="tableblock halign-left valign-top">値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">groupId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jp.co.ntt.fw.macchinetta.batch.sample</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">artifactId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">asyncbatch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0-SNAPSHOT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jp.co.ntt.fw.macchinetta.batch.sample</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>また説明の都合上、ブランクプロジェクトに初めから登録されているジョブを使用する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明に用いるジョブ</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">名称</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ名</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">job01</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブパラメータ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">param1=value1</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">非同期実行(Webコンテナ)ジョブ設計の注意点</div>
<div class="paragraph">
<p>非同期実行(Webコンテナ)の特性として個々のジョブは短時間で完了しWebコンテナ上でステートレスに
動作するケースが適している。<br>
また複雑さを避ける上では、ジョブ定義を単一のステップのみで構成し、ステップの終了コードによるフローの分岐や
並列処理・多重処理を定義しないことが望ましい。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ジョブ実装を含むjarファイルが作成可能な状態として、Webアプリケーションの作成を行う。</p>
</div>
<div class="paragraph">
<div class="title">Webアプリケーションの実装</div>
<p>Macchinetta Server 1.xが提供するブランクプロジェクトを用い、Webアプリケーションの実装方法を説明する。
詳細は、Macchinetta Server 1.x 開発ガイドライン
<a href="https://macchinetta.github.io/server-guideline/current/ja//ImplementationAtEachLayer/CreateWebApplicationProject.html">Webアプリケーション向け開発プロジェクトの作成</a>
を参照。</p>
</div>
<div class="paragraph">
<p>ここでは非同期実行アプリケーションプロジェクトと同様、以下の名称で作成したものとして説明する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Webコンテナプロジェクト作成例</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">名称</th>
<th class="tableblock halign-left valign-top">値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">groupId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jp.co.ntt.fw.macchinetta.batch.sample</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">artifactId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">asyncapp</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0-SNAPSHOT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jp.co.ntt.fw.macchinetta.batch.sample</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">groupIdの命名について</div>
<div class="paragraph">
<p>プロジェクトの命名は任意であるが、Maven マルチプロジェクトとしてバッチアプリケーションを
Webアプリケーションの子モジュールとする場合、<code>groupId</code>は統一しておくと管理しやすい。<br>
ここでは両者の<code>groupId</code>を<code>jp.co.ntt.fw.macchinetta.batch.sample</code>としている。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_HowToUse_Config"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_Config"></a>4.4.3.2. 各種設定</h5>
<div class="paragraph">
<div class="title">バッチアプリケーションをWebアプリケーションの一部に含める</div>
<p>pom.xmlを編集し、バッチアプリケーションをWebアプリケーションの一部に含める。</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>バッチアプリケーションを<code>jar</code> としてNEXUSやMavenローカルリポジトリに登録し、
Webアプリケーションとは別プロジェクトとする場合はこの手順は不要である。<br>
ただし、Mavenによりビルドされる対象が別プロジェクトとなり、バッチアプリケーションの修正を行ってもWebアプリケーションのビルド時に反映されないため注意すること。<br>
バッチアプリケーションの修正をWebアプリケーションに反映させるためには同リポジトリに登録する必要がある。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithWebContainer_DirectoryStructure.png" alt="directory structure">
</div>
<div class="title">ディレクトリ構成</div>
</div>
<div class="listingblock">
<div class="title">asyncapp/pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;project&gt;</span>
  <span class="comment">&lt;!-- omitted --&gt;</span>
  <span class="tag">&lt;modules&gt;</span>
    <span class="tag">&lt;module&gt;</span>asyncapp-domain<span class="tag">&lt;/module&gt;</span>
    <span class="tag">&lt;module&gt;</span>asyncapp-env<span class="tag">&lt;/module&gt;</span>
    <span class="tag">&lt;module&gt;</span>asyncapp-initdb<span class="tag">&lt;/module&gt;</span>
    <span class="tag">&lt;module&gt;</span>asyncapp-web<span class="tag">&lt;/module&gt;</span>
    <span class="tag">&lt;module&gt;</span>asyncapp-selenium<span class="tag">&lt;/module&gt;</span>
    <span class="tag">&lt;module&gt;</span>asyncbatch<span class="tag">&lt;/module&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
  <span class="tag">&lt;/modules&gt;</span>
<span class="tag">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">asyncapp/asyncbatch/pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;project&gt;</span>
  <span class="tag">&lt;modelVersion&gt;</span>4.0.0<span class="tag">&lt;/modelVersion&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>jp.co.ntt.fw.macchinetta.batch.sample<span class="tag">&lt;/groupId&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>asyncbatch<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
  <span class="comment">&lt;!-- (1) --&gt;</span>
  <span class="tag">&lt;parent&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>jp.co.ntt.fw.macchinetta.batch.sample<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>asyncapp<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;relativePath&gt;</span>../pom.xml<span class="tag">&lt;/relativePath&gt;</span>
  <span class="tag">&lt;/parent&gt;</span>
  <span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;/project&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">削除・追加内容</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Webアプリケーションを親とし、バッチアプリケーションを子とするための設定を追記する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">子モジュール化にともない、不要となる記述を削除する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">依存ライブラリの追加</div>
<p>バッチアプリケーションをWebアプリケーションの依存ライブラリとして追加する。</p>
</div>
<div class="listingblock">
<div class="title">asyncapp/async-web/pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;project&gt;</span>
  <span class="comment">&lt;!-- omitted --&gt;</span>
  <span class="tag">&lt;dependencies&gt;</span>
　　<span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>${project.groupId}<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>asyncbatch<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>${project.version}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="comment">&lt;!-- omitted --&gt;</span>
  <span class="tag">&lt;/dependencies&gt;</span>
  <span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;/project&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">追加内容</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バッチアプリケーションをWebアプリケーションの依存ライブラリとして追加する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp"></a>4.4.3.3. Webアプリケーションの実装</h5>
<div class="paragraph">
<p>ここではWebアプリケーションとして、以下Macchinetta Server 1.x 開発ガイドラインを参考に、RESTful Webサービスを作成する。</p>
</div>
<div class="paragraph">
<p><a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebServiceDetail/REST.html">RESTful Web Serviceで必要となるSpring MVCのコンポーネントを有効化するための設定</a></p>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp_Config"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_Config"></a>4.4.3.3.1. Webアプリケーションの設定</h6>
<div class="paragraph">
<p>まず、Webアプリケーションのブランクプロジェクトから、各種設定ファイルの追加・削除・編集を行う。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>説明の都合上、バッチアプリケーションの実装形態としてRESTful Web Service を用いた実装を行っている。<br>
従来のWebアプリケーション(Servlet/JSP)やSOAPを使用した場合でも同様な手順となるので、適宜読み替えること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithWebContainer_AppendBeanDefinitionsOnBlank.png" alt="AppendBeanDefinitionsOnBlank">
</div>
<div class="title">ブランクプロジェクトから追加・削除するBean定義ファイル</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">追加・削除するBean定義ファイル</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-mvc.xmlは(2)を作成するため、不要となるので削除する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RESTful Web Service用のspring-mvc-rest.xmlを作成する。必要となる定義の記述例を以下に示す。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">asyncapp/asyncapp-web/src/main/resources/META-INF/spring/spring-mvc-rest.xml の記述例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>
<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/launch-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jsonMessageConverter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.http.converter.json.MappingJackson2HttpMessageConverter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:objectMapper-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">objectMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">objectMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.http.converter.json.Jackson2ObjectMapperFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dateFormat</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.fasterxml.jackson.databind.util.StdDateFormat</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;mvc:annotation-driven&gt;</span>
  <span class="tag">&lt;mvc:message-converters</span> <span class="attribute-name">register-defaults</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jsonMessageConverter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/mvc:message-converters&gt;</span>
<span class="tag">&lt;/mvc:annotation-driven&gt;</span>

<span class="tag">&lt;mvc:default-servlet-handler</span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.sample.app.api</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.AutomaticJobRegistrar</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">applicationContextFactories</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.ClasspathXmlApplicationContextsFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resources</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                  <span class="tag">&lt;value&gt;</span>classpath:/META-INF/jobs/**/*.xml<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLoader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.DefaultJobLoader</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:jobRegistry-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;task:executor</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskExecutor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">queue-capacity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLauncher</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.launch.support.SimpleJobLauncher</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:jobRepository-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:taskExecutor-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">asyncapp/asyncapp-web/src/main/webapp/WEB-INF/web.xml の記述例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;servlet&gt;</span>
    <span class="tag">&lt;servlet-name&gt;</span>restApiServlet<span class="tag">&lt;/servlet-name&gt;</span>
    <span class="tag">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/servlet-class&gt;</span>
    <span class="tag">&lt;init-param&gt;</span>
        <span class="tag">&lt;param-name&gt;</span>contextConfigLocation<span class="tag">&lt;/param-name&gt;</span>
        <span class="comment">&lt;!-- (6) --&gt;</span>
        <span class="tag">&lt;param-value&gt;</span>classpath*:META-INF/spring/spring-mvc-rest.xml<span class="tag">&lt;/param-value&gt;</span>
    <span class="tag">&lt;/init-param&gt;</span>
    <span class="comment">&lt;!-- (7) --&gt;</span>
    <span class="tag">&lt;init-param&gt;</span>
        <span class="tag">&lt;param-name&gt;</span>spring.profiles.active<span class="tag">&lt;/param-name&gt;</span>
        <span class="tag">&lt;param-value&gt;</span>async<span class="tag">&lt;/param-value&gt;</span>
    <span class="tag">&lt;/init-param&gt;</span>
    <span class="tag">&lt;load-on-startup&gt;</span>1<span class="tag">&lt;/load-on-startup&gt;</span>
<span class="tag">&lt;/servlet&gt;</span>

<span class="tag">&lt;servlet-mapping&gt;</span>
    <span class="tag">&lt;servlet-name&gt;</span>restApiServlet<span class="tag">&lt;/servlet-name&gt;</span>
    <span class="tag">&lt;url-pattern&gt;</span>/api/v1/*<span class="tag">&lt;/url-pattern&gt;</span>
<span class="tag">&lt;/servlet-mapping&gt;</span>
<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">RESTful Web Service の有効化例</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バッチアプリケーション内にある<code>launch-context.xml</code>のimportし、必須となるBean定義を取り込む。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コントローラを動的にスキャンするためのパッケージを記述する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">個々のジョブBean定義ファイルをモジュラー化することにより子コンテキストとして動的ロードを行う<code>AutomaticJobRegistrar</code>のBean定義を記述する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">非同期で実行するジョブが用いる<code>TaskExecutor</code>を定義する。<br>
JobLauncherの<code>TaskExecutor</code>に<code>AsyncTaskExecutor</code>実装クラスを設定することで非同期実行が可能となる。
<code>AsyncTaskExecutor</code>実装クラスの1つである<code>ThreadPoolTaskExecutor</code>を利用する。</p>
<p class="tableblock">また、並列起動可能なスレッドの多重度を指定ことができる。<br>
この例では3スレッドがジョブの実行に割り当てられ、それを超えたリクエストは10までがキューイングされる。
キューイングされたジョブは未開始の状態ではあるが、REST リクエストは成功とみなされる。<br>
さらにキューイングの上限を超えたジョブのリクエストは<code>org.springframework.core.task.TaskRejectedException</code>が発生し、
ジョブの起動要求が拒否される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)の<code>taskExecutor</code>を有効化するため、<code>launch-context.xml</code>で定義されている<code>jobLauncher</code>をオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DispatcherServlet</code>が読み込むBean定義として、<br>
上述で記載した<code>spring-mvc-rest.xml</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Framework のプロファイルとして、非同期バッチを表す<code>async</code>を明示する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">asyncプロファイルの指定をしなかった場合</div>
<div class="paragraph">
<p>この場合、Webアプリケーション横断で共有すればよい<code>launch-context.xml</code>に定義されたBeanが、ジョブごとに重複して生成される。<br>
重複した場合でも機能上動作するため誤りに気づきにくく、予期しないリソース枯渇や性能劣化が発生する恐れがある。
必ず指定すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">スレッドプールのサイジング</div>
<div class="paragraph">
<p>スレッドプールの上限が過剰である場合、膨大なジョブが並走することとなり、
アプリケーション全体のスループットが劣化する恐れがある。
サイジングを行ったうえで適正な上限値を定めること。<br>
非同期実行のスレッドプールとは別に、Webコンテナのリクエストスレッドや
同一筐体内で動作している他のアプリケーションも含めて検討する必要がある。</p>
</div>
<div class="paragraph">
<p>また、スレッドプール枯渇に伴う<code>TaskRejectException</code>発生の確認、および再実行は
Webクライアントから別途リクエストを送信する必要がある。
そのため、スレッドプール枯渇時、ジョブ起動を待機させる<code>queue-capacity</code>は必ず設定すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">RESTful Web Service API の定義</div>
<p>REST APIで使用するリクエストの例として、
ここでは「ジョブの起動」、「ジョブの状態確認」の2つを定義する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">REST API 定義例</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 15%;">
<col style="width: 25%;">
<col style="width: 10%;">
<col style="width: 15%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">API</th>
<th class="tableblock halign-left valign-top">パス</th>
<th class="tableblock halign-left valign-top">HTTPメソッド</th>
<th class="tableblock halign-left valign-top">要求/応答</th>
<th class="tableblock halign-left valign-top">電文形式</th>
<th class="tableblock halign-left valign-top">電文の説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">ジョブの起動</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">/api/v1/job/<em>ジョブ名</em></p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リクエスト</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブパラメータ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">レスポンス</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ実行ID<br>
ジョブ名<br>
メッセージ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">ジョブの実行状態確認</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">/api/v1/job/<em>ジョブ実行ID</em></p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リクエスト</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">レスポンス</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ実行ID<br>
ジョブ名<br>
ジョブ実行ステータス<br>
ジョブ終了コード<br>
ステップ実行ID<br>
ステップ名<br>
ステップ終了コード</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp_JavaBeans"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_JavaBeans"></a>4.4.3.3.2. コントローラで使用するJavaBeansの実装</h6>
<div class="paragraph">
<p>JSON電文としてRESTクライアントに返却される以下3クラスを作成する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ジョブ起動操作 <code><code>JobOperationResource</code></code></p>
</li>
<li>
<p>ジョブの実行状態 <code><code>JobExecutionResource</code></code></p>
</li>
<li>
<p>ステップの実行状態 <code>StepExecutionResource</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これらクラスは<code>JobOperationResource</code>のジョブ実行ID(<code>job execution id</code>)を除きあくまで参考実装であり、フィールドの実装は任意である。</p>
</div>
<div class="listingblock">
<div class="title">ジョブ起動操作情報実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// asyncapp/asyncapp-web/src/main/java/jp/co/ntt/fw/macchinetta/batch/sample/app/api/jobinfo/JobOperationResource.java</span>
<span class="keyword">package</span> <span class="namespace">jp.co.ntt.fw.macchinetta.batch.sample.app.api.jobinfo</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">JobOperationResource</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> jobName = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">String</span> jobParams = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">Long</span> jobExecutionId = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">String</span> errorMessage = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="exception">Exception</span> error = <span class="predefined-constant">null</span>;

    <span class="comment">// Getter and setter are omitted.</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ジョブ実行情報実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// asyncapp/asyncapp-web/src/main/java/jp/co/ntt/fw.macchinetta/batch/sample/app/api/jobinfo/JobExecutionResource.java</span>
<span class="keyword">package</span> <span class="namespace">jp.co.ntt.fw.macchinetta.batch.sample.app.api.jobinfo</span>;

<span class="comment">// omitted.</span>

<span class="directive">public</span> <span class="type">class</span> <span class="class">JobExecutionResource</span> {

    <span class="directive">private</span> <span class="predefined-type">Long</span> jobExecutionId = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">String</span> jobName = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">Long</span> stepExecutionId = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">String</span> stepName = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;StepExecutionResource&gt; stepExecutions = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">private</span> <span class="predefined-type">String</span> status = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">String</span> exitStatus = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">String</span> errorMessage;

    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; failureExceptions = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="comment">// Getter and setter are omitted.</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ステップ実行情報実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// asyncapp/asyncapp-web/src/main/java/jp/co/ntt/fw/macchinetta/batch/sample/app/api/jobinfo/StepExecutionResource.java</span>
<span class="keyword">package</span> <span class="namespace">jp.co.ntt.fw.macchinetta.batch.sample.app.api.jobinfo</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">StepExecutionResource</span> {

  <span class="directive">private</span> <span class="predefined-type">Long</span> stepExecutionId = <span class="predefined-constant">null</span>;

  <span class="directive">private</span> <span class="predefined-type">String</span> stepName = <span class="predefined-constant">null</span>;

  <span class="directive">private</span> <span class="predefined-type">String</span> status = <span class="predefined-constant">null</span>;

  <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; failureExceptions = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="comment">// Getter and setter are omitted.</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp_Controller"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_Controller"></a>4.4.3.3.3. コントローラの実装</h6>
<div class="paragraph">
<p><code>@RestController</code>を用い、RESTful Web Service のコントローラを実装する。<br>
ここでは簡単のため、<code>JobOperator</code>をコントローラにインジェクションし、ジョブの起動や実行状態の取得を行う。
もちろんMacchinetta Server 1.xに従って、コントローラからServiceをはさんで<code>JobOperator</code>を起動してもよい。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">ジョブ起動時に渡されるジョブパラメータについて</div>
<div class="paragraph">
<p>起動時に<code>JobOperator#start()</code>の第二引数で渡されるジョブパラメータは<code>String</code>である。
ジョブパラメータが複数ある場合、同期実行の<code>CommandLineJobRunner</code>とは異なり、カンマ区切りで渡す必要がある。
具体的には以下の形式をとる。<br>
<code>{ジョブパラメータ1}={値1},{ジョブパラメータ2}={値2},&#8230;&#8203;</code></p>
</div>
<div class="paragraph">
<p>これは、<a href="#Ch04_AsyncJobWithDB">"非同期実行(DBポーリング)"</a>におけるジョブパラメータの指定方法と同様である。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">コントローラ実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// asyncapp/asyncapp-web/src/main/java/jp/co/ntt/fw/macchinetta/batch/sample/app/api/JobController.java</span>
<span class="keyword">package</span> <span class="namespace">jp.co.ntt.fw.macchinetta.batch.sample.app.api</span>;

<span class="comment">// omitted.</span>

<span class="comment">// (1)</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RestController</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobController</span> {

    <span class="comment">// (2)</span>
    <span class="annotation">@Inject</span>
    JobOperator jobOperator;

    <span class="comment">// (2)</span>
    <span class="annotation">@Inject</span>
    JobExplorer jobExplorer;

    <span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">{jobName}</span><span class="delimiter">&quot;</span></span>, method = RequestMethod.POST)
    <span class="directive">public</span> ResponseEntity&lt;JobOperationResource&gt; launch(<span class="annotation">@PathVariable</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobName</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> jobName,
            <span class="annotation">@RequestBody</span> JobOperationResource requestResource) {

        JobOperationResource responseResource = <span class="keyword">new</span> JobOperationResource();
        responseResource.setJobName(jobName);
        <span class="keyword">try</span> {
            <span class="comment">// (3)</span>
            <span class="predefined-type">Long</span> jobExecutionId = jobOperator.start(jobName, requestResource.getJobParams());
            responseResource.setJobExecutionId(jobExecutionId);
            <span class="keyword">return</span> ResponseEntity.ok().body(responseResource);
        } <span class="keyword">catch</span> (NoSuchJobException | JobInstanceAlreadyExistsException | JobParametersInvalidException e) {
            responseResource.setError(e);
            <span class="keyword">return</span> ResponseEntity.badRequest().body(responseResource);
        }
    }

    <span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">{jobExecutionId}</span><span class="delimiter">&quot;</span></span>, method = RequestMethod.GET)
    <span class="annotation">@ResponseStatus</span>(HttpStatus.OK)
    <span class="directive">public</span> JobExecutionResource getJob(<span class="annotation">@PathVariable</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExecutionId</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">Long</span> jobExecutionId) {

        JobExecutionResource responseResource = <span class="keyword">new</span> JobExecutionResource();
        responseResource.setJobExecutionId(jobExecutionId);

        <span class="comment">// (4)</span>
        JobExecution jobExecution = jobExplorer.getJobExecution(jobExecutionId);

        <span class="keyword">if</span> (jobExecution == <span class="predefined-constant">null</span>) {
            responseResource.setErrorMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">Job execution not found.</span><span class="delimiter">&quot;</span></span>);
        } <span class="keyword">else</span> {
            mappingExecutionInfo(jobExecution, responseResource);
        }

        <span class="keyword">return</span> responseResource;
    }

    <span class="directive">private</span> <span class="type">void</span> mappingExecutionInfo(JobExecution src, JobExecutionResource dest) {
      dest.setJobName(src.getJobInstance().getJobName());
      <span class="keyword">for</span> (StepExecution se : src.getStepExecutions()) {
          StepExecutionResource ser = <span class="keyword">new</span> StepExecutionResource();
          ser.setStepExecutionId(se.getId());
          ser.setStepName(se.getStepName());
          ser.setStatus(se.getStatus().toString());
          <span class="keyword">for</span> (<span class="predefined-type">Throwable</span> th : se.getFailureExceptions()) {
              ser.getFailureExceptions().add(th.toString());
          }
          dest.getStepExecutions().add(ser);
      }
      dest.setStatus(src.getStatus().toString());
      dest.setExitStatus(src.getExitStatus().toString());
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">コントローラの実装</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@RestController</code>を指定する。
さらに<code>@RequestMapping("job")</code>により、<code>web.xml</code>のサーブレットマッピングとあわせると、
REST APIの基底パスは<code><em>contextName</em>/api/v1/job/</code>となる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobOperator</code>、<code>JobExplorer</code>のフィールドインジェクションを記述する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobOperator</code> を使用して新規に非同期ジョブを起動する。<br>
返り値としてジョブ実行IDを受け取り、REST クライアントに返却する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExplorer</code> を使用し、ジョブ実行IDを基にジョブの実行状態(<code>JobExecution</code>)を取得する。<br>
あらかじめ設計された電文フォーマットに変換した上でRESTクライアントに返却する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp_IntegrationConfig"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_IntegrationConfig"></a>4.4.3.3.4. Web/バッチアプリケーションモジュール設定の統合</h6>
<div class="paragraph">
<p>バッチアプリケーションモジュール(<code>asyncbatch</code>)は単体で動作可能なアプリケーションとして動作する。
そのため、バッチアプリケーションモジュール(<code>asyncbatch</code>)は、Webアプリケーションモジュール(<code>asyncapp-web</code>)との間で競合・重複する設定が存在する。
これらは、必要に応じて統合する必要がある。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ログ設定ファイル<code>logback.xml</code>の統合<br>
Web/バッチ間でLogback定義ファイルが複数定義されている場合、正常に動作しない。<br>
<code>asyncbatch/src/main/resources/logback.xml</code>の記述内容は<code>asyncapp-env/src/main/resources/</code>の同ファイルに統合した上で削除する。</p>
</li>
<li>
<p>データソース、MyBatis設定ファイルは統合しない<br>
データソース、MyBatis設定ファイルの定義はWeb/バッチ間では、以下関係によりアプリケーションコンテキストの定義が独立するため、統合しない。</p>
<div class="ulist">
<ul>
<li>
<p>バッチの<code>asyncbatch</code>モジュールはサーブレットに閉じたコンテキストとして定義される。</p>
</li>
<li>
<p>Webの<code>asyncapp-domain</code>、<code>asyncapp-env</code>モジュールはアプリケーション全体で使用されるコンテキストとして定義される。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Webとバッチモジュールによるデータソース、MyBatis設定の相互参照</div>
<div class="paragraph">
<p>Webとバッチモジュールによるコンテキストのスコープが異なるため、
特にWebモジュールからバッチのデータソース、MyBatis設定、Mapperインターフェースは参照できない。<br>
RDBMSスキーマ初期化もそれぞれ異なるモジュールの設定に応じて独立して行われるため、相互干渉により
意図しない初期化が行われないよう配慮すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">REST コントローラ特有のCSRF対策設定</div>
<div class="paragraph">
<p>Webブランクプロジェクトの初期設定では、RESTコントローラに対しリクエストを送信するとCSRFエラーとして
ジョブの実行が拒否される。
そのため、ここでは以下方法によりCSRF対策を無効化した前提で説明している。</p>
</div>
<div class="paragraph">
<p><a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebServiceDetail/REST.html#csrf">CSRF対策</a></p>
</div>
<div class="paragraph">
<p>ここで作成されるWebアプリケーションはインターネット上には公開されず、CSRFを攻撃手段として
悪用しうる第三者からのRESTリクエスト送信が発生しない前提でCSRF対策を無効化している。
実際のWebアプリケーションでは動作環境により要否が異なる点に注意すること。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp_Build"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_Build"></a>4.4.3.3.5. ビルド</h6>
<div class="paragraph">
<p>Mavenコマンドでビルドし、warファイルを作成する。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ cd asyncapp
$ ls
asyncbatch/  asyncapp-web/  pom.xml
$ mvn clean package
[INFO] Scanning for projects...
[INFO] ------------------------------------------------------------------------
[INFO] Reactor Build Order:
[INFO]
[INFO] Macchinetta Server Framework (1.x) Web Blank Multi Project (MyBatis3)
[INFO] Macchinetta Batch Framework (2.x) Blank Project
[INFO] asyncapp-web
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Macchinetta Server Framework (1.x) Web Blank Multi Project (MyBatis3) 1.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------

(omitted)

[INFO] ------------------------------------------------------------------------
[INFO] Reactor Summary:
[INFO]
[INFO] Macchinetta Server Framework (1.x) Web Blank Multi Project (MyBatis3) SUCCESS [  0.226 s]
[INFO] Macchinetta Batch Framework (2.x) Blank Project SUCCESS [  6.481s]
[INFO] asyncapp-web ....................................... SUCCESS [  5.400 s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 12.597 s
[INFO] Finished at: 2017-02-10T22:32:43+09:00
[INFO] Final Memory: 38M/250M
[INFO] ------------------------------------------------------------------------
$</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp_Deploy"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_Deploy"></a>4.4.3.3.6. デプロイ</h6>
<div class="paragraph">
<p>TomcatなどのWebコンテナを起動し、ビルドで生成された<code>war</code>ファイルをデプロイする。
詳細な手順は割愛する。</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_HowToUse_Run"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_Run"></a>4.4.3.4. REST Clientによるジョブの起動と実行結果確認</h5>
<div class="paragraph">
<p>ここではREST クライアントとしてcurlコマンドを使用し、非同期ジョブを起動する。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ curl -v \
  -H &quot;Accept: application/json&quot; -H &quot;Content-type: application/json&quot; \
  -d '{&quot;jobParams&quot;: &quot;param1=value1&quot;}' \
  http://localhost:8080/asyncapp-web/api/v1/job/job01
* timeout on name lookup is not supported
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 8088 (#0)
&gt; POST /asyncapp-web/api/v1/job/job01 HTTP/1.1
&gt; Host: localhost:8088
&gt; User-Agent: curl/7.51.0
&gt; Accept: application/json
&gt; Content-type: application/json
&gt; Content-Length: 30
&gt;
* upload completely sent off: 30 out of 30 bytes
&lt; HTTP/1.1 200
&lt; X-Track: 0267db93977b4552880a4704cf3e4565
&lt; Content-Type: application/json;charset=UTF-8
&lt; Transfer-Encoding: chunked
&lt; Date: Fri, 10 Feb 2017 13:55:46 GMT
&lt;
{&quot;jobName&quot;:&quot;job01&quot;,&quot;jobParams&quot;:null,&quot;jobExecutionId&quot;:3,&quot;error&quot;:null,&quot;errorMessag
e&quot;:null}* Curl_http_done: called premature == 0
* Connection #0 to host localhost left intact
$</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記より、ジョブ実行ID:<code>jobExecutionId = 3</code>として、ジョブが実行されていることが確認できる。<br>
続けてこのジョブ実行IDを使用し、ジョブの実行結果を取得する。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ curl -v http://localhost:8080/asyncapp-web/api/v1/job/3
* timeout on name lookup is not supported
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 8088 (#0)
&gt; GET /asyncapp-web/api/v1/job/3 HTTP/1.1
&gt; Host: localhost:8088
&gt; User-Agent: curl/7.51.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200
&lt; X-Track: 7d94bf4d383745efb20cbf37cb6a8e13
&lt; Content-Type: application/json;charset=UTF-8
&lt; Transfer-Encoding: chunked
&lt; Date: Fri, 10 Feb 2017 14:07:44 GMT
&lt;
{&quot;jobExecutionId&quot;:3,&quot;jobName&quot;:&quot;job01&quot;,&quot;stepExecutions&quot;:[{&quot;stepExecutionId&quot;:5,&quot;st
epName&quot;:&quot;job01.step01&quot;,&quot;status&quot;:&quot;COMPLETED&quot;,&quot;failureExceptions&quot;:[]}],&quot;status&quot;:&quot;C
OMPLETED&quot;,&quot;exitStatus&quot;:&quot;exitCode=COMPLETED;exitDescription=&quot;,&quot;errorMessage&quot;:null
}* Curl_http_done: called premature == 0
* Connection #0 to host localhost left intact
$</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>exitCode=COMPLETED</code>であることより、ジョブが正常終了していることが確認できる。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">シェルスクリプトなどでcurlの実行結果を判定する場合</div>
<div class="paragraph">
<p>上記の例ではREST APIによる応答電文まで表示させている。
curlコマンドでHTTPステータスのみを確認する場合は<code>curl -s URL -o /dev/null -w "%{http_code}\n"</code>とすることで、HTTPステータスが標準出力に表示される。<br>
ただし、ジョブ実行IDはレスポンスボディ部のJSONを解析する必要があるため、必要に応じてREST
クライアントアプリケーションを作成すること。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithWeb_HowToExtend"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToExtend"></a>4.4.4. How to extend</h4>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_HowToExtend_StopAndRestart"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToExtend_StopAndRestart"></a>4.4.4.1. ジョブの停止とリスタート</h5>
<div class="paragraph">
<p>非同期ジョブの停止・リスタートは複数実行しているジョブの中から停止・リスタートする必要がある。
また、同名のジョブが並走している場合に、問題が発生しているジョブのみを対象にする必要もある。
よって、対象とするジョブ実行が特定でき、その状態が確認できる必要がある。<br>
ここではこの前提を満たす場合、非同期実行の停止・リスタートを行うための実装について説明する。</p>
</div>
<div class="paragraph">
<p>以降、<a href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_Controller">コントローラの実装</a>の<code>JobController</code>に対して、
ジョブの停止(stop)やリスタート(restart)を追加する方法について説明する。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
ジョブの停止・リスタートは<code>JobOperator</code>を用いた実装をしなくても実施できる。<br>
詳細は<a href="#Ch07_JobManagement">ジョブの管理</a>を参照し、目的に合う方式を検討すること。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">停止・リスタートの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// asyncapp/asyncapp-web/src/main/java/jp/co/ntt/fw/macchinetta/batch/sample/app/api/JobController.java</span>
<span class="keyword">package</span> <span class="namespace">jp.co.ntt.fw.macchinetta.batch.sample.app.api</span>;

<span class="comment">// omitted.</span>

<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RestController</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobController</span> {

    <span class="comment">// omitted.</span>

    <span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">stop/{jobExecutionId}</span><span class="delimiter">&quot;</span></span>, method = RequestMethod.PUT)
    <span class="annotation">@Deprecated</span>
    <span class="directive">public</span> ResponseEntity&lt;JobOperationResource&gt; stop(
            <span class="annotation">@PathVariable</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExecutionId</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">Long</span> jobExecutionId) {

      JobOperationResource responseResource = <span class="keyword">new</span> JobOperationResource();
      responseResource.setJobExecutionId(jobExecutionId);
      <span class="type">boolean</span> result = <span class="predefined-constant">false</span>;
      <span class="keyword">try</span> {
          <span class="comment">// (1)</span>
          result = jobOperator.stop(jobExecutionId);
          <span class="keyword">if</span> (!result) {
              responseResource.setErrorMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">stop failed.</span><span class="delimiter">&quot;</span></span>);
              <span class="keyword">return</span> ResponseEntity.badRequest().body(responseResource);
          }
          <span class="keyword">return</span> ResponseEntity.ok().body(responseResource);
      } <span class="keyword">catch</span> (NoSuchJobExecutionException | JobExecutionNotRunningException e) {
          responseResource.setError(e);
          <span class="keyword">return</span> ResponseEntity.badRequest().body(responseResource);
      }
    }

    <span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">restart/{jobExecutionId}</span><span class="delimiter">&quot;</span></span>,
                    method = RequestMethod.PUT)
    <span class="annotation">@Deprecated</span>
    <span class="directive">public</span> ResponseEntity&lt;JobOperationResource&gt; restart(
            <span class="annotation">@PathVariable</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExecutionId</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">Long</span> jobExecutionId) {

        JobOperationResource responseResource = <span class="keyword">new</span> JobOperationResource();
        responseResource.setJobExecutionId(jobExecutionId);
        <span class="keyword">try</span> {
            <span class="comment">// (2)</span>
            <span class="predefined-type">Long</span> id = jobOperator.restart(jobExecutionId);
            responseResource.setJobExecutionId(id);
            <span class="keyword">return</span> ResponseEntity.ok().body(responseResource);
        } <span class="keyword">catch</span> (JobInstanceAlreadyCompleteException |
                  NoSuchJobExecutionException | NoSuchJobException |
                  JobRestartException | JobParametersInvalidException e) {
            responseResource.setErrorMessage(e.getMessage());
            <span class="keyword">return</span> ResponseEntity.badRequest().body(responseResource);
        }
    }

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">コントローラによる停止・リスタート実装例</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobOperator#stop()</code>を呼び出すことにより、実行中のジョブに対し停止を指示する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobOperator#restart()</code>を呼び出すことにより、異常終了・停止したステップから再実行させる。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_HowToExtend_MultipleLaunch"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToExtend_MultipleLaunch"></a>4.4.4.2. 複数起動</h5>
<div class="paragraph">
<p>ここでの複数起動とは、Webコンテナを複数起動し、それぞれがジョブ要求を待ち受けることを指す。</p>
</div>
<div class="paragraph">
<p>非同期ジョブの実行管理は外部RDBMSによって行われるため、各アプリケーションの接続先となる
外部RDBMSを共有することで、同一筐体あるいは別筐体にまたがって非同期ジョブ起動を待ち受けることができる。</p>
</div>
<div class="paragraph">
<p>用途としては特定のジョブに対する負荷分散や冗長化などがあげられる。
しかし、<a href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp">Webアプリケーションの実装</a>
で述べたように、Webコンテナを複数起動し並列性を高めるだけでこれらの効果が容易に得られるわけではない。
効果を得るためには、一般的なWebアプリケーションと同様の対処が求められる場合がある。
以下にその一例を示す。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Webアプリケーションの特性上、1リクエスト処理はステートレスに動作するが、
バッチの非同期実行はジョブの起動と結果の確認を合わせて設計しなければ、かえって障害耐性が低下する恐れもある。<br>
たとえば、ジョブ起動用Webコンテナを冗長化した場合でもクライアント側の障害によりジョブ起動後にジョブ実行IDを
ロストすることでジョブの途中経過や結果の確認は困難となる。</p>
</li>
<li>
<p>複数のWebコンテナにかかる負荷を分散させるために、クライアント側にリクエスト先を振り分ける機能を実装したり、
ロードバランサを導入したりする必要がある。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>このように、複数起動の適性は一概に定めることができない。
そのため、目的と用途に応じてロードバランサの利用やWebクライアントによるリクエスト送信制御方式などを検討し、
非同期実行アプリケーションの性能や耐障害性を落とさない設計が必要となる。</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch04_Listener"><a class="anchor" href="#Ch04_Listener"></a>4.5. リスナー</h3>
<div class="sect3">
<h4 id="Ch04_Listener_Overview"><a class="anchor" href="#Ch04_Listener_Overview"></a>4.5.1. Overview</h4>
<div class="paragraph">
<p>リスナーとは、ジョブやステップを実行する前後に処理を挿入するためのインターフェースである。</p>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで使い方が異なるため、それぞれについて説明する。</p>
</div>
<div class="paragraph">
<p>リスナーには多くのインターフェースがあるため、それぞれの役割について説明する。
その後に、設定および実装方法について説明をする。</p>
</div>
<div class="sect4">
<h5 id="Ch04_Listener_Overview_Types"><a class="anchor" href="#Ch04_Listener_Overview_Types"></a>4.5.1.1. リスナーの種類</h5>
<div class="paragraph">
<p>Spring Batchでは、実に多くのリスナーインターフェースが定義されている。
ここではそのすべてを説明するのではなく、利用頻度が高いものを中心に扱う。</p>
</div>
<div class="paragraph">
<p>まず、リスナーは2種類に大別される。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">JobListener</dt>
<dd>
<p>ジョブの実行に対して処理を挟み込むためのインターフェース</p>
</dd>
<dt class="hdlist1">StepListener</dt>
<dd>
<p>ステップの実行に対して処理を挟み込むためのインターフェース</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">JobListenerについて</div>
<div class="paragraph">
<p>Spring Batchには、<code>JobListener</code>という名前のインターフェースは存在しない。
<code>StepListener</code>との対比のため 、本ガイドラインでは便宜的に定義している。<br>
Java Batch(jBatch)には、<code>javax.batch.api.listener.JobListener</code>というインターフェースが存在するので、実装時には間違えないように注意すること。
また、<code>StepListener</code>もシグネチャが異なる同名インターフェース(<code>javax.batch.api.listener.StepListener</code>)が存在するので、同様に注意すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="Ch04_Listener_Overview_Types_JobListener"><a class="anchor" href="#Ch04_Listener_Overview_Types_JobListener"></a>4.5.1.1.1. JobListener</h6>
<div class="paragraph">
<p><code>JobListener</code>のインターフェースは、<code>JobExecutionListener</code>の1つのみとなる。</p>
</div>
<div id="Ch04_Listener_Overview_Types_JobExecutionListener" class="dlist">
<dl>
<dt class="hdlist1">JobExecutionListener</dt>
<dd>
<p>ジョブの開始前、終了後に処理を挟み込む。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">JobExecutionListenerインターフェース</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">JobExecutionListener</span> {
  <span class="type">void</span> beforeJob(JobExecution jobExecution);
  <span class="type">void</span> afterJob(JobExecution jobExecution);
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_Listener_Overview_Types_StepListener"><a class="anchor" href="#Ch04_Listener_Overview_Types_StepListener"></a>4.5.1.1.2. StepListener</h6>
<div class="paragraph">
<p><code>StepListener</code>のインターフェースは以下のように多くの種類がある。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">StepListener</dt>
<dd>
<p>以降に紹介する各種リスナーのマーカーインターフェース。</p>
</dd>
</dl>
</div>
<div id="Ch04_Listener_Overview_Types_StepExecutionListener" class="dlist">
<dl>
<dt class="hdlist1">StepExecutionListener</dt>
<dd>
<p>ステップ実行の開始前、終了後に処理を挟み込む。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">StepExecutionListenerインターフェース</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">StepExecutionListener</span> <span class="directive">extends</span> StepListener {
  <span class="type">void</span> beforeStep(StepExecution stepExecution);
  ExitStatus afterStep(StepExecution stepExecution);
}</code></pre>
</div>
</div>
<div id="Ch04_Listener_Overview_Types_ChunkListener" class="dlist">
<dl>
<dt class="hdlist1">ChunkListener</dt>
<dd>
<p>1つのチャンクを処理する前後と、エラーが発生した場合に処理を挟み込む。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ChunkListenerインターフェース</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ChunkListener</span> <span class="directive">extends</span> StepListener {
  <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> ROLLBACK_EXCEPTION_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">sb_rollback_exception</span><span class="delimiter">&quot;</span></span>;
  <span class="type">void</span> beforeChunk(ChunkContext context);
  <span class="type">void</span> afterChunk(ChunkContext context);
  <span class="type">void</span> afterChunkError(ChunkContext context);
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">ROLLBACK_EXCEPTION_KEYの用途</div>
<div class="paragraph">
<p><code>afterChunkError</code>メソッドにて、発生した例外を取得したい場合に利用する。
Spring Batchはチャンク処理中にエラーが発生した場合、<code>ChunkContext</code>に<code>sb_rollback_exception</code>というキー名で
例外を格納した上で<code>ChunkListener</code>を呼び出すため、以下の要領でアクセスできる。</p>
</div>
<div class="listingblock">
<div class="title">使用例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> afterChunkError(ChunkContext context) {
    logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while chunk. [context:{}]</span><span class="delimiter">&quot;</span></span>, context,
            context.getAttribute(ChunkListener.ROLLBACK_EXCEPTION_KEY));
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>例外ハンドリングについては、<a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_ChunkListener">ChunkListenerインターフェースによる例外ハンドリング</a>を参照。</p>
</div>
<div id="Ch04_Listener_Overview_Types_ItemReadListener" class="dlist">
<dl>
<dt class="hdlist1">ItemReadListener</dt>
<dd>
<p>ItemReaderが1件のデータを取得する前後と、エラーが発生した場合に処理を挟み込む。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ItemReadListenerインターフェース</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemReadListener</span>&lt;T&gt; <span class="directive">extends</span> StepListener {
  <span class="type">void</span> beforeRead();
  <span class="type">void</span> afterRead(T item);
  <span class="type">void</span> onReadError(<span class="exception">Exception</span> ex);
}</code></pre>
</div>
</div>
<div id="Ch04_Listener_Overview_Types_ItemProcessListener" class="dlist">
<dl>
<dt class="hdlist1">ItemProcessListener</dt>
<dd>
<p>ItemProcessorが1件のデータを加工する前後と、エラーが発生した場合に処理を挟み込む。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ItemProcessListenerインターフェース</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemProcessListener</span>&lt;T, S&gt; <span class="directive">extends</span> StepListener {
  <span class="type">void</span> beforeProcess(T item);
  <span class="type">void</span> afterProcess(T item, S result);
  <span class="type">void</span> onProcessError(T item, <span class="exception">Exception</span> e);
}</code></pre>
</div>
</div>
<div id="Ch04_Listener_Overview_Types_ItemWriteListener" class="dlist">
<dl>
<dt class="hdlist1">ItemWriteListener</dt>
<dd>
<p>ItemWriterが1つのチャンクを出力する前後と、エラーが発生した場合に処理を挟み込む。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ItemWriteListenerインターフェース</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemWriteListener</span>&lt;S&gt; <span class="directive">extends</span> StepListener {
  <span class="type">void</span> beforeWrite(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> S&gt; items);
  <span class="type">void</span> afterWrite(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> S&gt; items);
  <span class="type">void</span> onWriteError(<span class="exception">Exception</span> exception, <span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> S&gt; items);
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>本ガイドラインでは、以下のリスナーについては説明をしない。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>リトライ系リスナー</p>
</li>
<li>
<p>スキップ系リスナー</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これらのリスナーは例外ハンドリングでの使用を想定したものであるが、
本ガイドラインではこれらのリスナーを用いた例外ハンドリングは行わない方針である。
詳細は、<a href="#Ch06_ExceptionHandling">例外ハンドリング</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_Listener_HowToUse"><a class="anchor" href="#Ch04_Listener_HowToUse"></a>4.5.2. How to use</h4>
<div class="paragraph">
<p>リスナーの実装と設定方法について説明する。</p>
</div>
<div class="sect4">
<h5 id="Ch04_Listener_HowToUse_Impl"><a class="anchor" href="#Ch04_Listener_HowToUse_Impl"></a>4.5.2.1. リスナーの実装</h5>
<div class="paragraph">
<p>リスナーの実装と設定方法について説明する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>リスナーインターフェースを<code>implements</code>して実装する。</p>
</li>
<li>
<p>コンポーネントにメソッドベースでアノテーションを付与して実装する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>どちらで実装するかは、リスナーの役割に応じて選択する。基準は後述する。</p>
</div>
<div class="sect5">
<h6 id="Ch04_Listener_HowToUse_Impl_WithoutAnnotation"><a class="anchor" href="#Ch04_Listener_HowToUse_Impl_WithoutAnnotation"></a>4.5.2.1.1. インターフェースを実装する場合</h6>
<div class="paragraph">
<p>各種リスナーインターフェースを<code>implements</code>して実装する。必要に応じて、複数のインターフェースを同時に実装してもよい。
以下に実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">JobExecutionListenerの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobExecutionLoggingListener</span> <span class="directive">implements</span> JobExecutionListener { <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(JobExecutionLoggingListener.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) { <span class="comment">// (2)</span>
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">job started. [JobName:{}]</span><span class="delimiter">&quot;</span></span>, jobExecution.getJobInstance().getJobName());
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterJob(JobExecution jobExecution) { <span class="comment">// (3)</span>

        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">job finished.[JobName:{}][ExitStatus:{}]</span><span class="delimiter">&quot;</span></span>, jobExecution.getJobInstance().getJobName(),
                jobExecution.getExitStatus().getExitCode());
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">リスナーの設定例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJobWithListener</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJobWithListener.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
             <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">processor</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;batch:listeners&gt;</span>
                 <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingEachProcessInStepListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;/batch:listeners&gt;</span>
         <span class="tag">&lt;/batch:tasklet&gt;</span>
     <span class="tag">&lt;/batch:step&gt;</span>
     <span class="tag">&lt;batch:listeners&gt;</span>
         <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExecutionLoggingListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (4) --&gt;</span>
     <span class="tag">&lt;/batch:listeners&gt;</span>
 <span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecutionListener</code>を<code>implements</code>して実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecutionListener</code>が定義している<code>beforeJob</code>メソッドを実装する。<br>
この例では、ジョブ開始ログを出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecutionListener</code>が定義している<code>afterJob</code>メソッドを実装する。<br>
この例では、ジョブ終了ログを出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean定義の<code>&lt;listeners&gt;</code>タグで、(1)で実装したリスナーを設定する。<br>
設定方法の詳細は、<a href="#Ch04_Listener_HowToUse_Configuration">リスナーの設定</a>で説明する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">リスナーのサポートクラス</div>
<div class="paragraph">
<p>複数のリスナーインターフェースを<code>implements</code>した場合、処理が不要な部分についても空実装をする必要がある。
この作業を簡略化するため、あらかじめ空実装を施したサポートクラスがSpring Batchには用意されている。
インターフェースではなく、サポートクラスを活用してもよいが、その場合<code>implements</code>ではなく<code>extends</code>になるため注意すること。</p>
</div>
<div class="ulist">
<div class="title">サポートクラス</div>
<ul>
<li>
<p><code>org.springframework.batch.core.listener.ItemListenerSupport</code></p>
</li>
<li>
<p><code>org.springframework.batch.core.listener.StepListenerSupport</code></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_Listener_HowToUse_Impl_WithAnnotation"><a class="anchor" href="#Ch04_Listener_HowToUse_Impl_WithAnnotation"></a>4.5.2.1.2. アノテーションを付与する場合</h6>
<div class="paragraph">
<p>各種リスナーインターフェースに対応したアノテーションを付与する。必要に応じて、複数のアノテーションを同時に実装してもよい。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">リスナーインターフェースとの対応表</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">リスナーインターフェース</th>
<th class="tableblock halign-left valign-top">アノテーション</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_JobExecutionListener">JobExecutionListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@beforeJob</code><br>
<code>@afterJob</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_StepExecutionListener">StepExecutionListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@BeforeStep</code><br>
<code>@AfterStep</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_ChunkListener">ChunkListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@BeforeChunk</code><br>
<code>@AfterChunk</code><br>
<code>@afterChunkError</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_ItemReadListener">ItemReadListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@BeforeRead</code><br>
<code>@AfterRead</code><br>
<code>@OnReadError</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_ItemProcessListener">ItemProcessListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@beforeProcess</code><br>
<code>@afterProcess</code><br>
<code>@onProcessError</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_ItemWriteListener">ItemWriteListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@BeforeWrite</code><br>
<code>@AfterWrite</code><br>
<code>@OnWriteError</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>これらアノテーションはコンポーネント化された実装のメソッドに付与することで目的のスコープで動作する。
以下に実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">アノテーションを付与したItemProcessorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AnnotationAmountCheckProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetail, SalesPlanDetail&gt; {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(AnnotationAmountCheckProcessor.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">if</span> (item.getAmount().signum() == -<span class="integer">1</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">amount is negative.</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="keyword">return</span> item;
    }

    <span class="comment">// (1)</span>
    <span class="comment">/*
    @BeforeProcess
    public void beforeProcess(Object item) {
        logger.info(&quot;before process. [Item :{}]&quot;, item);
    }
    */</span>

    <span class="comment">// (2)</span>
    <span class="annotation">@AfterProcess</span>
    <span class="directive">public</span> <span class="type">void</span> afterProcess(<span class="predefined-type">Object</span> item, <span class="predefined-type">Object</span> result) {
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">after process. [Result :{}]</span><span class="delimiter">&quot;</span></span>, result);
    }

    <span class="comment">// (3)</span>
    <span class="annotation">@OnProcessError</span>
    <span class="directive">public</span> <span class="type">void</span> onProcessError(<span class="predefined-type">Object</span> item, <span class="exception">Exception</span> e) {
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">on process error.</span><span class="delimiter">&quot;</span></span>, e);
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">リスナーの設定例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJobWithListenerAnnotation</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJobWithListenerAnnotation.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">annotationAmountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="error">&lt;</span>! -- (4) --<span class="error">&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">アノテーションで実装する場合は、処理が必要なタイミングのアノテーションのみを付与すればよい。<br>
この例では、ItemProcessの処理前には何もする必要がないため、<code>@beforeProcess</code>を付与した実装は不要となる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessの処理後に行う処理を実装する。<br>
この例では処理結果をログを出力している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessでエラーが発生したときの処理を実装する。<br>
この例では発生した例外をログを出力している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">アノテーションでリスナー実装がされているItemProcessを<code>&lt;chunk&gt;</code>タグに設定する。<br>
リスナーインターフェースとは異なり、<code>&lt;listener&gt;</code>タグで設定しなくても、自動的にリスナーが登録される。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">アノテーションを付与するメソッドの制約</div>
<div class="paragraph">
<p>アノテーションを付与するメソッドはどのようなメソッドでもよいわけではない。
対応するリスナーインターフェースのメソッドと、シグネチャを一致させる必要がある。
この点は、各アノテーションのjavadocに明記されている。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">JobExecutionListenerをアノテーションで実装したときの注意</div>
<div class="paragraph">
<p>JobExecutionListenerは、他のリスナーとスコープが異なるため、上記の設定では自動的にリスナー登録がされない。
そのため、<code>&lt;listener&gt;</code>タグで明示的に設定する必要がある。詳細は、<a href="#Ch04_Listener_HowToUse_Configuration">リスナーの設定</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Tasklet実装へのアノテーションによるリスナー実装</div>
<div class="paragraph">
<p>Tasklet実装へのアノテーションによるリスナー実装した場合、以下の設定では一切リスナーが起動しないため注意する。</p>
</div>
<div class="listingblock">
<div class="title">Taskletの場合</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletJobWithListenerAnnotation</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletJobWithListenerAnnotation.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">annotationSalesPlanDetailRegisterTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>タスクレットモデルの場合は、<a href="#Ch04_Listener_HowToUse_SelectionCriteria">インターフェースとアノテーションの使い分け</a>に従ってリスナーインターフェースを利用するのがよい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_Listener_HowToUse_Configuration"><a class="anchor" href="#Ch04_Listener_HowToUse_Configuration"></a>4.5.2.2. リスナーの設定</h5>
<div class="paragraph">
<p>リスナーは、Bean定義の<code>&lt;listeners&gt;</code>.<code>&lt;listener&gt;</code>タグによって設定する。
XMLスキーマ定義では様々な箇所に記述できるが、インターフェースの種類によっては意図とおり動作しないものが存在するため、
以下の位置に設定すること。</p>
</div>
<div class="listingblock">
<div class="title">リスナーを設定する位置</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- for chunk mode --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(1)</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(1)</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(1)</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(2)</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(3)</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- for tasklet mode --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tasklet</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(2)</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(3)</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定値の説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_StepListener">StepListener</a>に属するアノテーションによる実装を含んだコンポーネントを設定する。<br>
アノテーションの場合、必然的にこの場所に設定することになる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_StepListener">StepListener</a>に属するリスナーインターフェース実装を設定する。<br>
タスクレットモデルの場合、<code>ItemReadListener</code>,<code>ItemProcessListener</code>,<code>ItemWriteListener</code>は利用できない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_JobListener">JobListener</a>に属するリスナーを設定する。<br>
インターフェースとアノテーション、どちらの実装でもここに設定する必要がある。</p></td>
</tr>
</tbody>
</table>
<div class="sect5">
<h6 id="Ch04_Listener_HowToUse_MultipleConfiguration"><a class="anchor" href="#Ch04_Listener_HowToUse_MultipleConfiguration"></a>4.5.2.2.1. 複数リスナーの設定</h6>
<div class="paragraph">
<p><code>&lt;batch:listeners&gt;</code>タグには複数のリスナーを設定することができる。</p>
</div>
<div class="paragraph">
<p>複数のリスナーを登録したときに、リスナーがどのような順番で起動されるかを以下に示す。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ItemProcessListener実装</p>
<div class="ulist">
<ul>
<li>
<p>listenerA, listenerB</p>
</li>
</ul>
</div>
</li>
<li>
<p>JobExecutionListener実装</p>
<div class="ulist">
<ul>
<li>
<p>listenerC, listenerD</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">複数リスナーの設定例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pocessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenerA</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenerB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenerC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenerD</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_Listener_composite.png" alt="Listener execution order">
</div>
<div class="title">リスナーの起動順序</div>
</div>
<div class="ulist">
<ul>
<li>
<p>前処理に該当する処理は、リスナーの登録順に起動される。</p>
</li>
<li>
<p>後処理またはエラー処理に該当する処理は、リスナー登録の逆順に起動される。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_Listener_HowToUse_SelectionCriteria"><a class="anchor" href="#Ch04_Listener_HowToUse_SelectionCriteria"></a>4.5.2.3. インターフェースとアノテーションの使い分け</h5>
<div class="paragraph">
<p>リスナーインターフェースとアノテーションによるリスナーの使い分けを説明する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">リスナーインターフェース</dt>
<dd>
<p>job、step、chunkにおいて共通する横断的な処理の場合に利用する。</p>
</dd>
<dt class="hdlist1">アノテーション</dt>
<dd>
<p>ビジネスロジック固有の処理を行いたい場合に利用する。<br>
原則として、ItemProcessorに対してのみ実装する。</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_Listener_HowToUse_Exception"><a class="anchor" href="#Ch04_Listener_HowToUse_Exception"></a>4.5.2.4. StepExecutionListenerでの前処理における例外発生</h5>
<div class="paragraph">
<p>前処理(<code>beforeStep</code>メソッド)で例外が発生した場合、モデルによりリソースのオープン/クローズの実行有無が変わる。それぞれのモデルにおいて前処理で例外が発生した場合について説明する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンクモデル</dt>
<dd>
<p>リソースのオープン前に前処理が実行されるため、リソースのオープンは行われない。<br>
リソースのクローズは、リソースのオープンがされていない場合でも実行されるため、<code>ItemReader</code>/<code>ItemWriter</code>を実装する場合にはこのことに注意する必要がある。</p>
</dd>
<dt class="hdlist1">タスクレットモデル</dt>
<dd>
<p>タスクレットモデルでは、<code>execute</code>メソッド内で明示的にリソースのオープン/クローズを行う。<br>
前処理で例外が発生すると、<code>execute</code>メソッドは実行されないため、当然リソースのオープン/クローズも行われない。</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_Listener_HowToUse_JobAbort"><a class="anchor" href="#Ch04_Listener_HowToUse_JobAbort"></a>4.5.2.5. 前処理(StepExecutionListener#beforeStep())でのジョブの打ち切り</h5>
<div class="paragraph">
<p>ジョブを実行する条件が整っていない場合、ジョブを実行する前に処理を打ち切りたい場合がある。</p>
</div>
<div class="paragraph">
<p>そのような場合は、前処理(<code>beforeStep</code>メソッド)にて例外をスローすることでジョブ実行前に処理を打ち切ることができる。<br>
ここでは以下の要件を実装する場合を例に説明する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>StepExecutionListener</code>が定義している<code>beforeStep</code>メソッドで入力ファイルと出力ファイルの起動パラメータの妥当性検証を行う。<br></p>
</li>
<li>
<p>起動パラメータのいずれかが未指定の場合、例外をスローする。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>しかし、Macchinetta Batch 2.xでは起動パラメータの妥当性検証は、<code>JobParametersValidator</code>の使用を推奨している。
ここでは、あくまでも前処理中断のサンプルとしてわかりやすい妥当性検証を利用しているため、実際に起動パラメータの妥当性検証を行う場合は<a href="#Ch04_JobParameter_HowToUse_ParamsValidation">"パラメータの妥当性検証"</a>を参照すること。</p>
</div>
<div class="paragraph">
<p>以下に実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">起動パラメータの妥当性検証を行うStepExecutionListenerの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CheckingJobParameterErrorStepExecutionListener</span> <span class="directive">implements</span> StepExecutionListener {

    <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>) <span class="comment">// (1)</span>
    <span class="directive">private</span> <span class="predefined-type">File</span> inputFile;

    <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>) <span class="comment">// (1)</span>
    <span class="directive">private</span> <span class="predefined-type">File</span> outputFile;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="keyword">if</span> (inputFile == <span class="predefined-constant">null</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> BeforeStepException(<span class="string"><span class="delimiter">&quot;</span><span class="content">The input file must be not null.</span><span class="delimiter">&quot;</span></span>); <span class="comment">// (2)</span>
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (outputFile == <span class="predefined-constant">null</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> BeforeStepException(<span class="string"><span class="delimiter">&quot;</span><span class="content">The output file must be not null.</span><span class="delimiter">&quot;</span></span>); <span class="comment">// (2)</span>
        }
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ExitStatus afterStep(StepExecution stepExecution) {
        <span class="comment">// omitted.</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">リスナーの設定例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch04.listener.LoggingReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch04.listener.LoggingWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJobWithAbortListener</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJobWithAbortListener.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
        <span class="tag">&lt;batch:listeners&gt;</span>
            <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">checkingJobParameterErrorStepExecutionListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;/batch:listeners&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@Valueアノテーションを使用して参照するパラメータを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外をスローする。<br>
この例では<code>RuntimeException</code>クラスを継承し、自作した例外クラスを使用している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">参照するパラメータを指定する。<br>
パラメータをセットしているクラスはそれぞれ<code>ItemStreamReader</code>、<code>ItemStreamWriter</code>を実装した独自クラスである。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リスナーインターフェース実装を設定する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch05"><a class="anchor" href="#Ch05"></a>5. データの入出力</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch05_Transaction"><a class="anchor" href="#Ch05_Transaction"></a>5.1. トランザクション制御</h3>
<div class="sect3">
<h4 id="Ch05_Transaction_Overview"><a class="anchor" href="#Ch05_Transaction_Overview"></a>5.1.1. Overview</h4>
<div class="paragraph">
<p>本節では、ジョブにおけるトランザクション制御について以下の順序で説明する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch05_Transaction_Overview_TxType">一般的なバッチ処理におけるトランザクション制御のパターンについて</a></p>
</li>
<li>
<p><a href="#Ch05_Transaction_Arch_UnderSpringBatch">Spring Batchにおけるトランザクション制御</a></p>
</li>
<li>
<p><a href="#Ch05_Transaction_HowToUse">"データベースやファイルといったリソースをトランザクショナルに処理するための方法"</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで使い方が異なるため、それぞれについて説明する。</p>
</div>
<div class="sect4">
<h5 id="Ch05_Transaction_Overview_TxType"><a class="anchor" href="#Ch05_Transaction_Overview_TxType"></a>5.1.1.1. 一般的なバッチ処理におけるトランザクション制御のパターンについて</h5>
<div class="paragraph">
<p>一般的に、バッチ処理は大量件数を処理するため、処理の終盤で何かしらのエラーが発生した場合に全件処理しなおしとなってしまうと
バッチシステムのスケジュールに悪影響を与えてしまう。<br>
これを避けるために、1ジョブの処理内で一定件数ごとにトランザクションを確定しながら処理を進めていくことで、
エラー発生時の影響を局所化することが多い。<br>
(以降、一定件数ごとにトランザクションを確定する方式を「中間コミット方式」、コミット単位にデータをひとまとめにしたものを「チャンク」と呼ぶ。)</p>
</div>
<div class="paragraph">
<p>中間コミット方式のポイントを以下にまとめる。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>エラー発生時の影響を局所化する。</p>
<div class="ulist">
<ul>
<li>
<p>更新時にエラーが発生しても、エラー箇所直前のチャンクまでの処理が確定している。</p>
</li>
</ul>
</div>
</li>
<li>
<p>リソースを一定量しか使わない。</p>
<div class="ulist">
<ul>
<li>
<p>処理対象データの大小問わず、チャンク分のリソースしか使用しないため安定する。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>ただし、中間コミット方式があらゆる場面で有効な方法というわけではない。<br>
システム内に一時的とはいえ処理済みデータと未処理データが混在することになる。
その結果、リカバリ処理時に未処理データを識別することが必要となるため、リカバリが複雑になる可能性がある。
これを避けるには、中間コミット方式ではなく、全件を1トランザクションで確定させるしかない。<br>
(以降、全件を1トランザクションで確定する方式を「一括コミット方式」と呼ぶ。)</p>
</div>
<div class="paragraph">
<p>とはいえ、何千万件というような大量件数を一括コミット方式で処理してしまうと、
コミットを行った際に全件をデータベース反映しようとして高負荷をかけてしまうような事態が発生する。
そのため、一括コミット方式は小規模なバッチ処理には向いているが、大規模バッチで採用するには注意が必要となる。
よって、この方法も万能な方法というわけではない。</p>
</div>
<div class="paragraph">
<p>つまり、「影響の局所化」と「リカバリの容易さ」はトレードオフの関係にある。
「中間コミット方式」と「一括コミット方式」のどちらを使うかは、ジョブの性質に応じてどちらを優先すべきかを決定して欲しい。<br>
もちろん、バッチシステム内のジョブすべてをどちらか一方で実現する必要はない。
基本的には「中間コミット方式」を採用するが、特殊なジョブのみ「一括コミット方式」を採用する(または、その逆とする)ことは自然である。</p>
</div>
<div class="paragraph">
<p>以下に、「中間コミット方式」と「一括コミット方式」のメリット・デメリット、採用ポイントをまとめる。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">方式別特徴一覧</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">コミット方式</th>
<th class="tableblock halign-left valign-top">メリット</th>
<th class="tableblock halign-left valign-top">デメリット</th>
<th class="tableblock halign-left valign-top">採用ポイント</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">中間コミット方式</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">エラー発生時の影響を局所化する</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リカバリ処理が複雑になる可能性がある</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">大量データを一定のマシンリソースで処理したい場合</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">一括コミット方式</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの整合性を担保する</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">大量件数処理時に高負荷になる可能性がある</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">永続化リソースに対する処理結果をAll or Nothingとしたい場合<br>
小規模のバッチ処理に向いている</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">データベースの同一テーブルへ入出力する際の注意点</div>
<div class="paragraph">
<p>データベースの仕組み上、コミット方式を問わず、
同一テーブルへ入出力する処理で大量データを取り扱う際に注意が必要な点がある。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>読み取り一貫性を担保するための情報が出力(UPDATEの発行)により失われた結果、
入力(SELECT)にてエラーが発生することがある。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これを回避するには、以下の対策がある。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>情報を確保する領域を大きくする。</p>
<div class="ulist">
<ul>
<li>
<p>拡張する際には、リソース設計にて十分検討の上実施してほしい。</p>
</li>
<li>
<p>拡張方法は使用するデータベースに依存するため、マニュアルを参照すること。</p>
</li>
</ul>
</div>
</li>
<li>
<p>入力データを分割し多重処理を行う。</p>
<div class="ulist">
<ul>
<li>
<p>多重処理については、<a href="#Ch08_ParallelAndMultiple_HowToUse_Partitioning">"Partitioning Step (多重処理)"</a>を参照。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_Transaction_Arch"><a class="anchor" href="#Ch05_Transaction_Arch"></a>5.1.2. Architecture</h4>
<div class="sect4">
<h5 id="Ch05_Transaction_Arch_UnderSpringBatch"><a class="anchor" href="#Ch05_Transaction_Arch_UnderSpringBatch"></a>5.1.2.1. Spring Batchにおけるトランザクション制御</h5>
<div class="paragraph">
<p>ジョブのトランザクション制御はSpring Batchがもつ仕組みを活用する。</p>
</div>
<div class="paragraph">
<p>以下に2種類のトランザクションを定義する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">フレームワークトランザクション</dt>
<dd>
<p>Spring Batchが制御するトランザクション</p>
</dd>
<dt class="hdlist1">ユーザトランザクション</dt>
<dd>
<p>ユーザが制御するトランザクション</p>
</dd>
</dl>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_Arch_UnderSpringBatchChunkModel"><a class="anchor" href="#Ch05_Transaction_Arch_UnderSpringBatchChunkModel"></a>5.1.2.1.1. チャンクモデルにおけるトランザクション制御の仕組み</h6>
<div class="paragraph">
<p>チャンクモデルにおけるトランザクション制御は、中間コミット方式のみとなる。
一括コミット方式は実現できない。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>チャンクモデルにおける一括コミット方式についてはJIRAにレポートされている。<br>
<a href="https://jira.spring.io/browse/BATCH-647" class="bare">https://jira.spring.io/browse/BATCH-647</a><br>
結果、<code>chunk completion policy</code>をカスタマイズしてチャンクサイズを動的に変更することで解決している。
しかし、この方法では全データを1チャンクに格納してしまいメモリを圧迫してしまうため、方式として採用することはできない。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>この方式の特徴は、チャンク単位にトランザクションが繰り返し行われることである。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">正常系でのトランザクション制御</dt>
<dd>
<p>正常系でのトランザクション制御を説明する。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_TransactionControlChunkModel_commit.png" alt="Transaction Control Chunk Model Normal Process">
</div>
<div class="title">正常系のシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで、以降の処理を繰り返す。</p>
</li>
<li>
<p>チャンク単位で、フレームワークトランザクションを開始する。</p>
</li>
<li>
<p>チャンクサイズに達するまで2から5までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは、<code>ItemReader</code>から入力データを取得する。</p>
</li>
<li>
<p><code>ItemReader</code>は、ステップに入力データを返却する。</p>
</li>
<li>
<p>ステップは、<code>ItemProcessor</code>で入力データに対して処理を行う。</p>
</li>
<li>
<p><code>ItemProcessor</code>は、ステップに処理結果を返却する。</p>
</li>
<li>
<p>ステップはチャンクサイズ分のデータを<code>ItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>ItemWriter</code>は、対象となるリソースへ出力を行う。</p>
</li>
<li>
<p>ステップはフレームワークトランザクションをコミットする。</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">異常系でのトランザクション制御</dt>
<dd>
<p>異常系でのトランザクション制御を説明する。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_TransactionControlChunkModel_rollback.png" alt="Transaction Control Chunk Model Abnormal Process">
</div>
<div class="title">異常系のシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで以降の処理を繰り返す。</p>
</li>
<li>
<p>チャンク単位でのフレームワークトランザクションを開始する。</p>
</li>
<li>
<p>チャンクサイズに達するまで2から5までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは、<code>ItemReader</code>から入力データを取得する。</p>
</li>
<li>
<p><code>ItemReader</code>は、ステップに入力データを返却する。</p>
</li>
<li>
<p>ステップは、<code>ItemProcessor</code>で入力データに対して処理を行う。</p>
</li>
<li>
<p><code>ItemProcessor</code>は、ステップに処理結果を返却する。</p>
</li>
<li>
<p>ステップはチャンクサイズ分のデータを<code>ItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>ItemWriter</code>は、対象となるリソースへ出力を行う。</p>
<div class="ulist">
<ul>
<li>
<p>2から7までの処理過程で<strong>例外が発生</strong>すると、以降の処理を行う。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p>ステップはフレームワークトランザクションをロールバックする。</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_Arch_UnderSpringBatchTaskletModel"><a class="anchor" href="#Ch05_Transaction_Arch_UnderSpringBatchTaskletModel"></a>5.1.2.1.2. タスクレットモデルにおけるトランザクション制御の仕組み</h6>
<div class="paragraph">
<p>タスクレットモデルにおけるトランザクション制御は、
一括コミット方式と中間コミット方式のいずれかを利用できる。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">一括コミット方式</dt>
<dd>
<p>Spring Batchがもつトランザクション制御の仕組みを利用する</p>
</dd>
<dt class="hdlist1">中間コミット方式</dt>
<dd>
<p>ユーザにてトランザクションを直接操作する</p>
</dd>
</dl>
</div>
<div class="sect6">
<h7 id="Ch05_Transaction_Arch_UnderSpringBatch_TaskletModel_SingleTransaction"><a class="anchor" href="#Ch05_Transaction_Arch_UnderSpringBatch_TaskletModel_SingleTransaction"></a>タスクレットモデルにおける一括コミット方式</h7>
<div class="paragraph">
<p>Spring Batchがもつトランザクション制御の仕組みについて説明する。</p>
</div>
<div class="paragraph">
<p>この方式の特徴は、1つのトランザクション内で繰り返しデータ処理を行うことである。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">正常系でのトランザクション制御</dt>
<dd>
<p>正常系でのトランザクション制御を説明する。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_TransactionControlTaskletModel_SingleTransaction_commit.png" alt="Single Transaction Control Tasklet Model Normal Process">
</div>
<div class="title">正常系のシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
<div class="ulist">
<ul>
<li>
<p>ステップはフレームワークトランザクションを開始する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップはタスクレットを実行する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで3から7までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>タスクレットは、<code>Repository</code>から入力データを取得する。</p>
</li>
<li>
<p><code>Repository</code>は、タスクレットに入力データを返却する。</p>
</li>
<li>
<p>タスクレットは、入力データを処理する。</p>
</li>
<li>
<p>タスクレットは、<code>Repository</code>へ出力データを渡す。</p>
</li>
<li>
<p><code>Repository</code>は、対象となるリソースへ出力を行う。</p>
</li>
<li>
<p>タスクレットはステップへ処理終了を返却する。</p>
</li>
<li>
<p>ステップはフレームワークトランザクションをコミットする。</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">異常系でのトランザクション制御</dt>
<dd>
<p>異常系でのトランザクション制御を説明する。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_TransactionControlTaskletModel_SingleTransaction_rollback.png" alt="Single Transaction Control Tasklet Model Abormal Process">
</div>
<div class="title">異常系のシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
<div class="ulist">
<ul>
<li>
<p>ステップはフレームワークトランザクションを開始する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップはタスクレットを実行する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで3から7までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>タスクレットは、<code>Repository</code>から入力データを取得する。</p>
</li>
<li>
<p><code>Repository</code>は、タスクレットに入力データを返却する。</p>
</li>
<li>
<p>タスクレットは、入力データを処理する。</p>
</li>
<li>
<p>タスクレットは、<code>Repository</code>へ出力データを渡す。</p>
</li>
<li>
<p><code>Repository</code>は、対象となるリソースへ出力を行う。</p>
<div class="ulist">
<ul>
<li>
<p>2から7までの処理過程で<strong>例外が発生</strong>すると、以降の処理を行う。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p>タスクレットはステップへ例外をスローする。</p>
</li>
<li>
<p>ステップはフレームワークトランザクションをロールバックする。</p>
</li>
</ol>
</div>
</div>
<div class="sect6">
<h7 id="Ch05_Transaction_Arch_UnderSpringBatch_TaskletModel_ChunkTransaction"><a class="anchor" href="#Ch05_Transaction_Arch_UnderSpringBatch_TaskletModel_ChunkTransaction"></a>タスクレットモデルにおける中間コミット方式</h7>
<div class="paragraph">
<p>ユーザにてトランザクションを直接操作する仕組みについて説明する。</p>
</div>
<div class="paragraph">
<p>この方式の特徴は、リソースの操作を行えないフレームワークトランザクションを利用することで、ユーザトランザクションのみにリソースの操作を行わせることである。<br>
<code>transaction-manager</code>属性に、リソースが紐づかない<code>org.springframework.batch.support.transaction.ResourcelessTransactionManager</code>を指定する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">正常系でのトランザクション制御</dt>
<dd>
<p>正常系でのトランザクション制御を説明する。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_TransactionControlTaskletModel_ChunkTransaction_commit.png" alt="Chunk Transaction Control Tasklet Model Normal Process">
</div>
<div class="title">正常系のシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
<div class="ulist">
<ul>
<li>
<p>ステップは<strong>フレームワークトランザクション</strong>を開始する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップはタスクレットを実行する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで3から10までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>タスクレットは、<code>TransacitonManager</code>より<strong>ユーザトランザクション</strong>を開始する。</p>
<div class="ulist">
<ul>
<li>
<p>チャンクサイズに達するまで4から8までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>タスクレットは、<code>Repository</code>から入力データを取得する。</p>
</li>
<li>
<p><code>Repository</code>は、タスクレットに入力データを返却する。</p>
</li>
<li>
<p>タスクレットは、入力データを処理する。</p>
</li>
<li>
<p>タスクレットは、<code>Repository</code>へ出力データを渡す。</p>
</li>
<li>
<p><code>Repository</code>は、対象となるリソースへ出力を行う。</p>
</li>
<li>
<p>タスクレットは、<code>TransacitonManager</code>により<strong>ユーザトランザクション</strong>のコミットを実行する。</p>
</li>
<li>
<p><code>TransacitonManager</code>は、対象となるリソースへコミットを発行する。</p>
</li>
<li>
<p>タスクレットはステップへ処理終了を返却する。</p>
</li>
<li>
<p>ステップは<strong>フレームワークトランザクション</strong>をコミットする。</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ここでは1件ごとにリソースへ出力しているが、
チャンクモデルと同様に、チャンク単位で一括更新し処理スループットの向上を狙うことも可能である。
その際に、<code>SqlSessionTemplate</code>の<code>executorType</code>を<code>BATCH</code>に設定することで、BatchUpdateを利用することもできる。
これは、MyBatisのItemWriterを利用する場合と同様の動作になるため、MyBatisのItemWriterを利用して更新してもよい。
MyBatisのItemWriterについて、詳細は
<a href="#Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter">MyBatisBatchItemWriter</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">異常系でのトランザクション制御</dt>
<dd>
<p>異常系でのトランザクション制御を説明する。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_TransactionControlTaskletModel_ChunkTransaction_rollback.png" alt="Chunk Transaction Control Tasklet Model Abormal Process">
</div>
<div class="title">異常系のシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
<div class="ulist">
<ul>
<li>
<p>ステップは<strong>フレームワークトランザクション</strong>を開始する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップはタスクレットを実行する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで3から11までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>タスクレットは、<code>TransacitonManager</code>より<strong>ユーザトランザクション</strong>を開始する。</p>
<div class="ulist">
<ul>
<li>
<p>チャンクサイズに達するまで4から8までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>タスクレットは、<code>Repository</code>から入力データを取得する。</p>
</li>
<li>
<p><code>Repository</code>は、タスクレットに入力データを返却する。</p>
</li>
<li>
<p>タスクレットは、入力データを処理する。</p>
</li>
<li>
<p>タスクレットは、<code>Repository</code>へ出力データを渡す。</p>
</li>
<li>
<p><code>Repository</code>は、対象となるリソースへ出力を行う。</p>
<div class="ulist">
<ul>
<li>
<p>3から8までの処理過程で<strong>例外が発生</strong>すると、以降の処理を行う。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p>タスクレットは、発生した例外に対する処理を行う。</p>
</li>
<li>
<p>タスクレットは、<code>TransacitonManager</code>により<strong>ユーザトランザクション</strong>のロールバックを実行する。</p>
</li>
<li>
<p><code>TransacitonManager</code>は、対象となるリソースへロールバックを発行する。</p>
</li>
<li>
<p>タスクレットはステップへ例外をスローする。</p>
</li>
<li>
<p>ステップは<strong>フレームワークトランザクション</strong>をロールバックする。</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">処理の継続について</div>
<div class="paragraph">
<p>ここでは、例外をハンドリングして処理をロールバック後、処理を異常終了しているが、
継続して次のチャンクを処理することも可能である。
いずれの場合も、途中でエラーが発生したことをステップのステータス・終了コードを変更することで後続の処理に通知する必要がある。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">フレームワークトランザクションについて</div>
<div class="paragraph">
<p>ここでは、ユーザトランザクションをロールバック後に例外をスローしてジョブを異常終了させているが、
ステップへ処理終了を返却しジョブを正常終了させることも出来る。
この場合、フレームワークトランザクションは、<strong>コミット</strong>される。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_Arch_UnderSpringBatch_SelectionPolicy"><a class="anchor" href="#Ch05_Transaction_Arch_UnderSpringBatch_SelectionPolicy"></a>5.1.2.1.3. モデル別トランザクション制御の選定方針</h6>
<div class="paragraph">
<p>Macchinetta Batch 2.xの基盤となるSpring Batchでは、チャンクモデルでは中間コミット方式しか実現できない。
しかし、タスクレットモデルでは、中間コミット方式、一括コミット方式のいずれも実現できる。</p>
</div>
<div class="paragraph">
<p>よって、Macchinetta Batch 2.xでは、一括コミット方式が必要な際は、タスクレットモデルにて実装する。</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_Transaction_Overview_DiffLaunching"><a class="anchor" href="#Ch05_Transaction_Overview_DiffLaunching"></a>5.1.2.2. 起動方式ごとのトランザクション制御の差</h5>
<div class="paragraph">
<p>起動方式によってはジョブの起動前後にSpring Batchの管理外となるトランザクションが発生する。
ここでは、2つの非同期実行処理方式におけるトランザクションについて説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_Arch_DiffLaunching_DB"><a class="anchor" href="#Ch05_Transaction_Arch_DiffLaunching_DB"></a>5.1.2.2.1. DBポーリングのトランザクションについて</h6>
<div class="paragraph">
<p>DBポーリングが行うジョブ要求テーブルへの処理については、Spring Batch管理外のトランザクション処理が行われる。
また、ジョブで発生した例外については、ジョブ内で対応が完結するため、<code>JobRequestPollTask</code>が行うトランザクションには影響を与えない。</p>
</div>
<div class="paragraph">
<p>下図にトランザクションに焦点を当てた簡易的なシーケンス図を示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_AsyncWithDB_Transaction_Difference.png" alt="With Database polling transaction">
</div>
<div class="title">DBポーリング処理のトランザクション</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>非同期バッチデーモンで<code>JobRequestPollTask</code>が周期実行される。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>は、Spring Batch管理外のトランザクションを開始する。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>は、ジョブ要求テーブルから非同期実行対象ジョブを取得する。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>は、Spring Batch管理外のトランザクションをコミットする。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>は、Spring Batch管理外のトランザクションを開始する。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>は、ジョブ要求テーブルのポーリングステータスをINITからPOLLEDへ更新する。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>は、Spring Batch管理外のトランザクションをコミットする。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>は、ジョブを実行する。</p>
</li>
<li>
<p>ジョブ内では、管理用データベース(<code>JobRepository</code>)へのトランザクション管理はSpring Batchが行う。</p>
</li>
<li>
<p>ジョブ内では、ジョブ用データベースへのトランザクション管理はSpring Batchが行う。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>にjob_execution_idが返却される。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>は、Spring Batch管理外のトランザクションを開始する。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>は、ジョブ要求テーブルのポーリングステータスをPOLLEDからEXECUTEへ更新する。</p>
</li>
<li>
<p><code>JobRequestPollTask</code>は、Spring Batch管理外のトランザクションをコミットする。</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">SELECT発行時のコミットについて</div>
<div class="paragraph">
<p>データベースによっては、SELECT発行時に暗黙的にトランザクションを開始する場合がある。
そのため、明示的にコミットを発行することでトランザクションを確定させ、他のトランザクションと明確に区別し影響を与えないようにしている。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_Arch_DiffLaunching_Web"><a class="anchor" href="#Ch05_Transaction_Arch_DiffLaunching_Web"></a>5.1.2.2.2. WebAPサーバ処理のトランザクションについて</h6>
<div class="paragraph">
<p>WebAPが対象とするリソースへの処理については、Spring Batch管理外のトランザクション処理が行われる。
また、ジョブで発生した例外については、ジョブ内で対応が完結するため、WebAPが行うトランザクションには影響を与えない。</p>
</div>
<div class="paragraph">
<p>下図にトランザクションに焦点を当てた簡易的なシーケンス図を示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_AsyncWithWeb_Transaction_Difference.png" alt="With Web Application transaction">
</div>
<div class="title">WebAPサーバ処理のトランザクション</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>クライアントからリクエストによりWebAPの処理が実行される。</p>
</li>
<li>
<p>WebAPは、Spring Batch管理外のトランザクションを開始する。</p>
</li>
<li>
<p>WebAPは、ジョブ実行前にWebAPでのリソースに対して読み書きを行う。</p>
</li>
<li>
<p>WebAPは、ジョブを実行する。</p>
</li>
<li>
<p>ジョブ内では、管理用データベース(<code>JobRepository</code>)へのトランザクション管理はSpring Batchが行う。</p>
</li>
<li>
<p>ジョブ内では、ジョブ用データベースへのトランザクション管理はSpring Batchが行う。</p>
</li>
<li>
<p>WebAPにjob_execution_idが返却される。</p>
</li>
<li>
<p>WebAPは、ジョブ実行後にWebAPでのリソースに対して読み書きを行う。</p>
</li>
<li>
<p>WebAPは、Spring Batch管理外のトランザクションをコミットする。</p>
</li>
<li>
<p>WebAPは、クライアントにレスポンスを返す。</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_Transaction_HowToUse"><a class="anchor" href="#Ch05_Transaction_HowToUse"></a>5.1.3. How to use</h4>
<div class="paragraph">
<p>ここでは、1ジョブにおけるトランザクション制御について、以下の場合に分けて説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_Transaction_HowToUse_SingleDataSource">単一データソースの場合</a></p>
</li>
<li>
<p><a href="#Ch05_Transaction_HowToUse_MultiDataSource">複数データソースの場合</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>データソースとは、データの格納先(データベース、ファイル等)を指す。
単一データソースとは1つのデータソースを、複数データソースとは2つ以上のデータソースを指す。</p>
</div>
<div class="paragraph">
<p>単一データソースを処理するケースは、データベースのデータを加工するケースが代表的である。<br>
複数データソースを処理するケースは、以下のようにいくつかバリエーションがある。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>複数のデータベースの場合</p>
</li>
<li>
<p>データベースとファイルの場合</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch05_Transaction_HowToUse_SingleDataSource"><a class="anchor" href="#Ch05_Transaction_HowToUse_SingleDataSource"></a>5.1.3.1. 単一データソースの場合</h5>
<div class="paragraph">
<p>1つのデータソースに対して入出力するジョブのトランザクション制御について説明する。</p>
</div>
<div class="paragraph">
<p>以下にMacchinetta Batch 2.xでの設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">データソースの設定(META-INF/spring/launch-context.xml)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Job-common definitions --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp2.BasicDataSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:driverClassName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.driver}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.url}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.username}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.password}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxTotal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:minIdle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxWaitMillis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:defaultAutoCommit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">トランザクションマネージャの設定(META-INF/spring/launch-context.xml)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.datasource.DataSourceTransactionManager</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:dataSource-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:rollbackOnCommitFailure</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクションマネージャのBean定義<br>
データソースは上記で定義した<code>jobDataSource</code>を設定する。<br>
コミットに失敗した場合はロールバックをするように設定済み。</p></td>
</tr>
</tbody>
</table>
<div class="sect5">
<h6 id="Ch05_Transaction_HowToUse_SingleDataSource_Tx"><a class="anchor" href="#Ch05_Transaction_HowToUse_SingleDataSource_Tx"></a>5.1.3.1.1. トランザクション制御の実施</h6>
<div class="paragraph">
<p>ジョブモデルおよびコミット方式により制御方法が異なる。</p>
</div>
<div class="sect6">
<h7 id="Ch05_Transaction_HowToUse_SingleDataSource_Tx_Chunk"><a class="anchor" href="#Ch05_Transaction_HowToUse_SingleDataSource_Tx_Chunk"></a>チャンクモデルの場合</h7>
<div class="paragraph">
<p>チャンクモデルの場合は、中間コミット方式となり、Spring Batchにトランザクション制御を委ねる。
ユーザにて制御することは一切行わないようにする。</p>
</div>
<div class="listingblock">
<div class="title">設定例(ジョブ定義)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:tasklet&gt;</code>タグの<code>transaction-manager</code>属性に定義済みの<code>jobTransactionManager</code>を設定する。<br>
ここに設定したトランザクションマネージャで中間コミット方式のトランザクションを制御する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>commit-interval</code>属性にチャンクサイズを設定する。この例では10件処理するごとに1回コミットが発行される。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch05_Transaction_HowToUse_SingleDataSource_Tx_Tasklet"><a class="anchor" href="#Ch05_Transaction_HowToUse_SingleDataSource_Tx_Tasklet"></a>タスクレットモデルの場合</h7>
<div class="paragraph">
<p>タスクレットモデルの場合は、一括コミット方式、中間コミット方式でトランザクション制御の方法が異なる。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">一括コミット方式</dt>
<dd>
<p>Spring Batchにトランザクション制御を委ねる。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">設定例(ジョブ定義)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesPlanSingleTranTask</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:tasklet&gt;</code>タグの<code>transaction-manager</code>属性に定義済みの<code>jobTransactionManager</code>を設定する。<br>
ここに設定したトランザクションマネージャで一括コミット方式のトランザクションを制御する。</p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">中間コミット方式</dt>
<dd>
<p>ユーザにてトランザクション制御を行う。</p>
<div class="ulist">
<ul>
<li>
<p>処理の途中でコミットを発行する場合は、<code>TransacitonManager</code>をInjectして手動で行う。</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">設定例(ジョブ定義)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobResourcelessTransactionManager</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesPlanChunkTranTask</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>()
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanChunkTranTask</span> <span class="directive">implements</span> Tasklet {

    <span class="annotation">@Inject</span>
    ItemStreamReader&lt;SalesPlanDetail&gt; itemReader;

     <span class="comment">// (2)</span>
    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>)
    PlatformTransactionManager transactionManager;

    <span class="annotation">@Inject</span>
    SalesPlanDetailRepository repository;

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> CHUNK_SIZE = <span class="integer">10</span>;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
                                ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        DefaultTransactionDefinition definition = <span class="keyword">new</span> DefaultTransactionDefinition();
        TransactionStatus status = <span class="predefined-constant">null</span>;

        <span class="keyword">try</span> {
            <span class="comment">// omitted.</span>

            itemReader.open(executionContext);

            <span class="keyword">while</span> ((item = itemReader.read()) != <span class="predefined-constant">null</span>) {

                <span class="keyword">if</span> (count % CHUNK_SIZE == <span class="integer">0</span>) {
                    status = transactionManager.getTransaction(definition); <span class="comment">// (3)</span>
                }
                count++;

                <span class="comment">// omitted.</span>

                repository.create(item);
                <span class="keyword">if</span> (count % CHUNK_SIZE == <span class="integer">0</span>) {
                    transactionManager.commit(status);  <span class="comment">// (4)</span>
                }
            }
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while reading.</span><span class="delimiter">&quot;</span></span>, e);
            transactionManager.rollback(status);    <span class="comment">// (5)</span>
            <span class="keyword">throw</span> e;
        } <span class="keyword">finally</span> {
            <span class="keyword">if</span> (!status.isCompleted()) {
                transactionManager.commit(status);   <span class="comment">// (6)</span>
            }
            itemReader.close();
        }

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:tasklet&gt;</code>タグの<code>transaction-manager</code>属性に定義済みの<code>jobResourcelessTransactionManager</code>を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクションマネージャをInjectする。<br>
@Namedアノテーションで<code>jobTransactionManager</code>を指定して利用するBeanを特定させる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンクの開始時にトランザクションを開始する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンク終了時にトランザクションをコミットする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外発生時にはトランザクションをロールバックする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">最後のチャンクについて、トランザクションをコミットする。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">ItemWriterによる更新</div>
<div class="paragraph">
<p>上記の例では、Repositoryを使用しているが、ItemWriterを利用してデータを更新することもできる。
ItemWriterを利用することで実装がシンプルになる効果があり、特にファイルを更新する場合はFlatFileItemWriterを利用するとよい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_HowToUse_SingleDataSource_NonTx"><a class="anchor" href="#Ch05_Transaction_HowToUse_SingleDataSource_NonTx"></a>5.1.3.1.2. 非トランザクショナルなデータソースに対する補足</h6>
<div class="paragraph">
<p>ファイルの場合はトランザクションの設定や操作は不要である。</p>
</div>
<div class="paragraph">
<p><code>FlatFileItemWriter</code>を利用する場合、擬似的なトランザクション制御が行える。
これは、リソースへの書き込みを遅延し、コミットタイミングで実際に書き出すことで実現している。
正常時にはチャンクサイズに達したときに、実際のファイルにチャンク分データを出力し、例外が発生するとそのチャンクのデータ出力が行われない。</p>
</div>
<div class="paragraph">
<p><code>FlatFileItemWriter</code>は、<code>transactional</code>プロパティでトランザクション制御の有無を切替えられる。デフォルトはtrueでトランザクション制御が有効になっている。
<code>transactional</code>プロパティがfalseの場合、<code>FlatFileItemWriter</code>は、トランザクションとは無関係にデータの出力を行う。</p>
</div>
<div class="paragraph">
<p>一括コミット方式を採用する場合、<code>transactional</code>プロパティをfalseにすることを推奨する。
上記の説明にあるとおりコミットのタイミングでリソースへ書き出すため、それまではメモリ内に全出力分のデータを保持することになる。
そのため、データ量が多い場合にはメモリ不足になりエラーとなる可能性が高くなる。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">ファイルしか扱わないジョブにおけるTransacitonManagerの設定について</div>
<div class="paragraph">
<p>以下に示すジョブ定義のように、<code>batch:tasklet</code>の<code>transaction-manager</code>属性はxsdスキーマにおいて必須のため省略できない。</p>
</div>
<div class="listingblock">
<div class="title">TransacitonManager設定箇所の抜粋</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:tasklet&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>そのため、<code>jobTransactionManager</code>を常に指定すること。この時、以下の挙動となる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>transactional</code>がtrueの場合</p>
<div class="ulist">
<ul>
<li>
<p>指定したTransacitonManagerに同期してリソースに出力する。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>transactional</code>がfalseの場合</p>
<div class="ulist">
<ul>
<li>
<p>指定したTransacitonManagerのトランザクション処理は空振りし、トランザクションと関係なくリソースに出力する。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>この時、<code>jobTransactionManager</code>が参照するリソース(たとえば、データベース)に対してトランザクションが発行されるが、
テーブルアクセスは伴わないため実害がない。</p>
</div>
<div class="paragraph">
<p>また、実害がある場合や空振りでも参照するトランザクションを発行したくない場合は、リソースを必要としない<code>ResourcelessTransactionManager</code>を使用することができる。
<code>ResourcelessTransactionManager</code>は<code>launch-context.xml</code>に<code>jobResourcelessTransactionManager</code>として定義済みである。</p>
</div>
<div class="listingblock">
<div class="title">ResourcelessTransactionManagerの使用例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobResourcelessTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:tasklet&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_Transaction_HowToUse_MultiDataSource"><a class="anchor" href="#Ch05_Transaction_HowToUse_MultiDataSource"></a>5.1.3.2. 複数データソースの場合</h5>
<div class="paragraph">
<p>複数データソースに対して入出力するジョブのトランザクション制御について説明する。
入力と出力で考慮点が異なるため、これらを分けて説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_HowToUse_MultiDataSource_Input"><a class="anchor" href="#Ch05_Transaction_HowToUse_MultiDataSource_Input"></a>5.1.3.2.1. 複数データソースからの取得</h6>
<div class="paragraph">
<p>複数データソースからのデータを取得する場合、処理の軸となるデータと、それに付随する追加データを分けて取得する。
以降は、処理の軸となるデータを処理対象レコード、それに付随する追加データを付随データと呼ぶ。</p>
</div>
<div class="paragraph">
<p>Spring Batchの構造上、ItemReaderは1つのリソースから処理対象レコードを取得することを前提としているためである。
これは、リソースの種類を問わず同じ考え方となる。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>処理対象レコードの取得</p>
<div class="ulist">
<ul>
<li>
<p>ItemReaderにて取得する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>付随データの取得</p>
<div class="ulist">
<ul>
<li>
<p>付随データは、そのデータに対す変更の有無と件数に応じて、以下の取得方法を選択する必要がある。これは、択一ではなく、併用してもよい。</p>
<div class="ulist">
<ul>
<li>
<p>ステップ実行前に一括取得</p>
</li>
<li>
<p>処理対象レコードに応じて都度取得</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="sect6">
<h7 id="Ch05_Transaction_HowToUse_MultiDataSource_Input_Bulk"><a class="anchor" href="#Ch05_Transaction_HowToUse_MultiDataSource_Input_Bulk"></a>ステップ実行前に一括取得する場合</h7>
<div class="paragraph">
<p>以下を行うListenerを実装し、以降のStepからデータを参照する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>データを一括して取得する</p>
</li>
<li>
<p>スコープが<code>Job</code>または<code>Step</code>のBeanに情報を格納する</p>
<div class="ulist">
<ul>
<li>
<p>Spring Batchの<code>ExecutionContext</code>を活用してもよいが、
可読性や保守性のために別途データ格納用のクラスを作成してもよい。
ここでは、簡単のため<code>ExecutionContext</code>を活用した例で説明する。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>マスタデータなど、処理対象データに依存しないデータを読み込む場合にこの方法を採用する。
ただし、マスタデータと言えど、メモリを圧迫するような大量件数が対象である場合は、都度取得したほうがよいかを検討すること。</p>
</div>
<div class="listingblock">
<div class="title">一括取得するListenerの実装</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BranchMasterReadStepListener</span> <span class="directive">extends</span> StepExecutionListenerSupport {

    <span class="annotation">@Inject</span>
    BranchRepository branchRepository;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {   <span class="comment">// (2)</span>

        <span class="predefined-type">List</span>&lt;Branch&gt; branches = branchRepository.findAll(); <span class="comment">//(3)</span>

        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, Branch&gt; map = branches.stream()
                .collect(Collectors.toMap(Branch::getBranchId,
                        UnaryOperator.identity()));  <span class="comment">// (4)</span>

        stepExecution.getExecutionContext().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">branches</span><span class="delimiter">&quot;</span></span>, map); <span class="comment">// (5)</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">一括取得するListenerの定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outputAllCustomerList01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outputAllCustomerList01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retrieveBranchFromContextItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchMasterReadStepListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (6) --&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">一括取得したデータを後続ステップのItemProcessorで参照する例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">RetrieveBranchFromContextItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;Customer, CustomerWithBranch&gt; {

    <span class="directive">private</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, Branch&gt; branches;

    <span class="annotation">@BeforeStep</span>       <span class="comment">// (7)</span>
    <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        branches = (<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, Branch&gt;) stepExecution.getExecutionContext()
                .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">branches</span><span class="delimiter">&quot;</span></span>); <span class="comment">// (8)</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> CustomerWithBranch process(Customer item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        CustomerWithBranch newItem = <span class="keyword">new</span> CustomerWithBranch(item);
        newItem.setBranch(branches.get(item.getChargeBranchId()));    <span class="comment">// (9)</span>
        <span class="keyword">return</span> newItem;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecutionListener</code>インターフェースを実装する。<br>
ここでは実装を簡易にするため、<code>StepExecutionListener</code>インターフェースを実装した<code>StepExecutionListenerSupport</code>からの拡張としている。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップ実行前にデータを取得するため、<code>beforeStep</code>メソッドを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">マスタデータを取得する処理を実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">後続処理が利用しやすいようにList型からMap型へ変換を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップのコンテキストに取得したマスタデータを<code>branches</code>という名前で設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">対象となるジョブへ作成したListenerを登録する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessorのステップ実行前にマスタデータを取得するため、@BeforeStepアノテーションでListener設定を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@BeforeStepアノテーションが付与されたメソッド内で、ステップのコンテキストから(5)で設定されたマスタデータを取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessorのprocessメソッド内で、マスタデータからデータ取得を行う。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">コンテキストへ格納するオブジェクト</div>
<div class="paragraph">
<p>コンテキスト(<code>ExecutionContext</code>)へ格納するオブジェクトは、<code>java.io.Serializable</code>を実装したクラスでなければならない。
これは、<code>ExecutionContext</code>が<code>JobRepository</code>へ格納されるためである。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="Ch05_Transaction_HowToUse_MultiDataSource_Input_Sequential"><a class="anchor" href="#Ch05_Transaction_HowToUse_MultiDataSource_Input_Sequential"></a>処理対象レコードに応じて都度取得する場合</h7>
<div class="paragraph">
<p>業務処理のItemProcessorとは別に、都度取得専用のItemProcessorにて取得する。
これにより、各ItemProcessorの処理を簡素化する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>都度取得用のItemProcessorを定義し、業務処理と分離する。</p>
<div class="ulist">
<ul>
<li>
<p>この際、テーブルアクセス時はMyBatisをそのまま使う。</p>
</li>
</ul>
</div>
</li>
<li>
<p>複数のItemProcessorをCompositeItemProcessorを使用して連結する。</p>
<div class="ulist">
<ul>
<li>
<p>ItemProcessorはdelegates属性に指定した順番に処理されることに留意する。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">都度取得用のItemProcessorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">RetrieveBranchFromRepositoryItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;Customer, CustomerWithBranch&gt; {

    <span class="annotation">@Inject</span>
    BranchRepository branchRepository;  <span class="comment">// (1)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> CustomerWithBranch process(Customer item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        CustomerWithBranch newItem = <span class="keyword">new</span> CustomerWithBranch(item);
        newItem.setBranch(branchRepository.findOne(
                item.getChargeBranchId())); <span class="comment">// (2)</span>
        <span class="keyword">return</span> newItem; <span class="comment">// (3)</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">都度取得用と業務処理用のItemProcessorの定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">compositeItemProcessor</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.CompositeItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegates</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retrieveBranchFromRepositoryItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (4) --&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">businessLogicItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatisを利用した都度データ取得用のRepositoryをInjectする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力データ(処理対象レコード)に対して、Repositoryから付随データを取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理対象レコードと付随データを一緒にしたデータを返却する。<br>
このデータが次のItemProcessorへの入力データになることに注意する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">都度取得用のItemProcessorを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ビジネスロジックのItemProcessorを設定する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_HowToUse_MultiDataSource_IndividualTx"><a class="anchor" href="#Ch05_Transaction_HowToUse_MultiDataSource_IndividualTx"></a>5.1.3.2.2. 複数データソースへの出力(複数ステップ)</h6>
<div class="paragraph">
<p>データソースごとにステップを分割し、各ステップで単一データソースを処理することで、ジョブ全体で複数データソースを処理する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1ステップ目で加工したデータをテーブルに格納し、2ステップ目でファイルに出力する、といった要領となる。</p>
</li>
<li>
<p>各ステップがシンプルになりリカバリしやすい反面、2度手間になる可能性がある。</p>
<div class="ulist">
<ul>
<li>
<p>この結果、以下のような弊害を生む場合は、1ステップで複数データソースを処理することを検討する。</p>
<div class="ulist">
<ul>
<li>
<p>処理時間が伸びてしまう</p>
</li>
<li>
<p>ビジネスロジックが冗長となる</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_HowToUse_MultiDataSource_SingleTx"><a class="anchor" href="#Ch05_Transaction_HowToUse_MultiDataSource_SingleTx"></a>5.1.3.2.3. 複数データソースへの出力(1ステップ)</h6>
<div class="paragraph">
<p>一般的に、複数のデータソースに対するトランザクションを1つにまとめる場合は、2phase-commitによる分散トランザクションを利用する。
しかし、以下の様なデメリットがあることも同時に知られている。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>XAResourceなど分散トランザクションAPIにミドルウエアが対応している必要があり、それにもとづいた特殊な設定が必要になる</p>
</li>
<li>
<p>バッチプログラムのようなスタンドアロンJavaで、分散トランザクションのJTA実装ライブラリを追加する必要がある</p>
</li>
<li>
<p>障害時のリカバリが難しい</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring Batchでも分散トランザクションを活用することは可能だが、JTAによるグローバルトランザクションを使用する方法では、プロトコルの特性上、性能面のオーバーヘッドがかかる。
より簡易に複数データソースをまとめて処理する方法として、<strong>Best Efforts 1PCパターン</strong>による実現手段を推奨する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Best Efforts 1PCパターンとは</dt>
<dd>
<p>端的に言うと、複数データソースをローカルトランザクションで扱い、同じタイミングで逐次コミットを発行する、という手法を指す。
下図に概念図を示す。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_Best_Efforts_1PC.png" alt="Best Efforts 1PC Overview">
</div>
<div class="title">Best Efforts 1PCパターンの概念図</div>
</div>
<div class="olist arabic">
<div class="title">図の説明</div>
<ol class="arabic">
<li>
<p>ユーザが<code>ChainedTransactionManager</code>にトランザクション開始を指示する。</p>
</li>
<li>
<p><code>ChainedTransactionManager</code>は、登録されているトランザクションマネージャを逐次トランザクションを開始する。</p>
</li>
<li>
<p>ユーザは各リソースへトランザクショナルな操作を行う。</p>
</li>
<li>
<p>ユーザが<code>ChainedTransactionManager</code>にコミットを指示する。</p>
</li>
<li>
<p><code>ChainedTransactionManager</code>は、登録されているトランザクションマネージャを逐次コミットを発行する。</p>
<div class="ulist">
<ul>
<li>
<p>トランザクション開始と逆順にコミット(またはロールバック)される</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>この方法は分散トランザクションではないため、2番目以降のトランザクションマネージャにおけるcommit/rollback時に障害(例外)が発生した場合に、
データの整合性が保てない可能性がある。
そのため、トランザクション境界で障害が発生した場合のリカバリ方法を設計する必要があるが、リカバリ頻度を低減し、リカバリ手順を簡素しやすくなる効果がある。</p>
</div>
<div class="sect6">
<h7 id="Ch05_Transaction_HowToUse_MultiDataSource_SingleTx_MultiTxResource"><a class="anchor" href="#Ch05_Transaction_HowToUse_MultiDataSource_SingleTx_MultiTxResource"></a>複数のトランザクショナルリソースを同時に処理する場合</h7>
<div class="paragraph">
<p>複数のデータベースを同時に処理する場合や、データベースとMQを処理する場合などに活用する。</p>
</div>
<div class="paragraph">
<p>以下のように、<code>ChainedTransactionManager</code>を使用して複数トランザクションマネージャを1つにまとめて定義することで1phase-commitとして処理する。
なお、<code>ChainedTransactionManager</code>はSpring Dataが提供するクラスである。</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
    <span class="comment">&lt;!-- omitted --&gt;</span>
    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.springframework.data<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>spring-data-commons<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependencies&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">chainedTransactionManagerの使用例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Chained Transaction Manager --&gt;</span>
<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chainedTransactionManager</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.data.transaction.ChainedTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;constructor-arg&gt;</span>
        <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/constructor-arg&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chainedTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- omitted --&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ChainedTransactionManager</code>を利用するために、依存関係を追加する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ChainedTransactionManager</code>のBean定義を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">まとめたい複数のトランザクションマネージャをリストで定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブが利用するトランザクションマネージャに(1)で定義したBeanIDを指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch05_Transaction_HowToUse_MultiDataSource_SingleTx_TxResourceAndNonTx"><a class="anchor" href="#Ch05_Transaction_HowToUse_MultiDataSource_SingleTx_TxResourceAndNonTx"></a>トランザクショナルリソースと非トランザクショナルリソースを同時に処理する場合</h7>
<div class="paragraph">
<p>この方法は、データベースとファイルを同時に処理する場合に活用する。</p>
</div>
<div class="paragraph">
<p>データベースについては<a href="#Ch05_Transaction_HowToUse_SingleDataSource">単一データソースの場合</a>と同様。</p>
</div>
<div class="paragraph">
<p>ファイルについてはFlatFileItemWriterの<code>transactional</code>プロパティをtrueに設定することで、前述の「Best Efforts 1PCパターン」と同様の効果となる。<br>
詳細は<a href="#Ch05_Transaction_HowToUse_SingleDataSource_NonTx">非トランザクショナルなデータソースに対する補足</a>を参照。</p>
</div>
<div class="paragraph">
<p>この設定は、データベースのトランザクションをコミットする直前までファイルへの書き込みを遅延させるため、2つのデータソースで同期がとりやすくなる。
ただし、この場合でもデータベースへのコミット後、ファイル出力処理中に異常が発生した場合はデータの整合性が保てない可能性があるため、
リカバリ方法を設計する必要がある。</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_Transaction_HowToUse_Considerations"><a class="anchor" href="#Ch05_Transaction_HowToUse_Considerations"></a>5.1.3.3. 中間方式コミットでの注意点</h5>
<div class="paragraph">
<p>非推奨ではあるがItemWriterで処理データをスキップする場合は、チャンクサイズの設定値が強制変更される。
そのことがトランザクションに非常に大きく影響することに注意する。詳細は、
<a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip">スキップ</a>を参照。</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_DBAccess"><a class="anchor" href="#Ch05_DBAccess"></a>5.2. データベースアクセス</h3>
<div class="sect3">
<h4 id="Ch05_DBAccess_Overview"><a class="anchor" href="#Ch05_DBAccess_Overview"></a>5.2.1. Overview</h4>
<div class="paragraph">
<p>Macchinetta Batch 2.xでは、データベースアクセスの方法として、MyBatis3(以降、「MyBatis」と呼ぶ)を利用する。
MyBatisによるデータベースアクセスの基本的な利用方法は、Macchinetta Server 1.x 開発ガイドラインの以下を参照してほしい。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/DataAccessCommon.html">データベースアクセス(共通編)</a></p>
</li>
<li>
<p><a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.html">データベースアクセス(MyBatis3編)</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>本節では、Macchinetta Batch 2.x特有の使い方を中心に説明する。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Linux環境でのOracle JDBC利用時の留意事項について</div>
<div class="paragraph">
<p>Linux環境でのOracle JDBCを利用時は、Oracle JDBCが使用するOSの乱数生成器によるロックが発生する。
そのため、ジョブを並列実行しようとしても逐次実行になる事象や片方のコネクションがタイムアウトする事象が発生する。<br>
本事象に対する2パターンの回避策を以下に示す。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Javaコマンド実行時に、システムプロパティで以下を設定する。</p>
<div class="ulist">
<ul>
<li>
<p><code>-Djava.security.egd=file:///dev/urandom</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>${JAVA_HOME}/jre/lib/security/java.security</code>内の<code>securerandom.source=/dev/random</code>を<code>securerandom.source=/dev/urandom</code>に変更する。</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_DBAccess_HowToUse"><a class="anchor" href="#Ch05_DBAccess_HowToUse"></a>5.2.2. How to use</h4>
<div class="paragraph">
<p>Macchinetta Batch 2.xでのデータベースアクセス方法を説明する。</p>
</div>
<div class="paragraph">
<p>なお、チャンクモデルとタスクレットモデルにおけるデータベースアクセス方法の違いに留意する。</p>
</div>
<div class="paragraph">
<p>Macchinetta Batch 2.xでのデータベースアクセスは、以下の2つの方法がある。<br>
これらはデータベースアクセスするコンポーネントによって使い分ける。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>MyBatis用のItemReaderおよびItemWriterを利用する。</p>
<div class="ulist">
<ul>
<li>
<p>チャンクモデルでのデータベースアクセスによる入出力で使用する。</p>
<div class="ulist">
<ul>
<li>
<p>org.mybatis.spring.batch.MyBatisCursorItemReader</p>
</li>
<li>
<p>org.mybatis.spring.batch.MyBatisBatchItemWriter</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Mapperインターフェースを利用する</p>
<div class="ulist">
<ul>
<li>
<p>チャンクモデルでのビジネスロジック処理で使用する。</p>
<div class="ulist">
<ul>
<li>
<p>ItemProcessor実装で利用する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>タスクレットモデルでのデータベースアクセス全般で使用する。</p>
<div class="ulist">
<ul>
<li>
<p>Tasklet実装で利用する。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="Ch05_DBAccess_HowToUse_Config"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Config"></a>5.2.2.1. 共通設定</h5>
<div class="paragraph">
<p>データベースアクセスにおいて必要な共通設定について説明を行う。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Config_DataSource">データソースの設定</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Config_MyBatisConfig">MyBatisの設定</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Config_MapperXML">Mapper XMLの定義</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Config_Scan">MyBatis-Springの設定</a></p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Config_DataSource"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Config_DataSource"></a>5.2.2.1.1. データソースの設定</h6>
<div class="paragraph">
<p>Macchinetta Batch 2.xでは、2つのデータソースを前提としている。
<code>launch-context.xml</code>でデフォルト設定している2つのデータソースを示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">データソース一覧</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">データソース名</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>adminDataSource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring BatchやMacchinetta Batch 2.xが利用するデータソース<br>
JobRepositoryや<a href="#Ch04_AsyncJobWithDB">非同期実行(DBポーリング)</a>で利用している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jobDataSource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブが利用するデータソース</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>以下に、launch-context.xmlと接続情報のプロパティを示す。<br>
これらをユーザの環境に合わせて設定すること。</p>
</div>
<div class="listingblock">
<div class="title">resources\META-INF\spring\launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp2.BasicDataSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:driverClassName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.h2.jdbc.driver}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.h2.jdbc.url}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.h2.jdbc.username}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.h2.jdbc.password}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxTotal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:minIdle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxWaitMillis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:defaultAutoCommit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp2.BasicDataSource</span><span class="delimiter">&quot;</span></span><span class="error">　</span>
      <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:driverClassName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.driver}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.url}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.username}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.password}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxTotal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:minIdle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxWaitMillis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:defaultAutoCommit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">batch-application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># (3)
# Admin DataSource settings.
admin.h2.jdbc.driver=org.h2.Driver
admin.h2.jdbc.url=jdbc:h2:mem:batch;DB_CLOSE_DELAY=-1
admin.h2.jdbc.username=sa
admin.h2.jdbc.password=

# (4)
# Job DataSource settings.
jdbc.driver=org.postgresql.Driver
jdbc.url=jdbc:postgresql://localhost:5432/postgres
jdbc.username=postgres
jdbc.password=postgres</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>adminDataSource</code>の定義。(3)の接続情報が設定される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jobDataSource</code>の定義。(4)の接続情報が設定される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>adminDataSource</code>で利用するデータベースへの接続情報<br>
この例では、H2を利用している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jobDataSource</code>で利用するデータベースへの接続情報<br>
この例では、PostgreSQLを利用している。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Config_MyBatisConfig"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Config_MyBatisConfig"></a>5.2.2.1.2. MyBatisの設定</h6>
<div class="paragraph">
<p>Macchinetta Batch 2.xで、MyBatisの設定をする上で重要な点について説明をする。</p>
</div>
<div class="paragraph">
<p>バッチ処理を実装する際の重要なポイントの1つとして「大量のデータを一定のリソースで効率よく処理する」が挙げられる。<br>
これに関する設定を説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>fetchSize</code></p>
<div class="ulist">
<ul>
<li>
<p>一般的なバッチ処理では、大量のデータを処理する際の通信コストを低減するために、
JDBCドライバに適切な<code>fetchSize</code>を指定することが必須である。
<code>fetchSize</code>とは、JDBCドライバとデータベース間とで1回の通信で取得するデータ件数を設定するパラメータである。
この値は出来る限り大きい値を設定することが望ましいが、大きすぎるとメモリを圧迫するため、注意が必要である。
ユーザにてチューニングする必要がある箇所と言える。</p>
</li>
<li>
<p>MyBatisでは、全クエリ共通の設定として<code>defaultFetchSize</code>を設定することができ、さらにクエリごとの<code>fetchSize</code>設定で上書きできる。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>executorType</code></p>
<div class="ulist">
<ul>
<li>
<p>一般的なバッチ処理では、同一トランザクション内で同じSQLを<code>全データ件数/fetchSize</code>の回数分実行することになる。
この際、都度ステートメントを作成するのではなく再利用することで効率よく処理できる。</p>
</li>
<li>
<p>MyBatisの設定における、<code>defaultExecutorType</code>に<code>REUSE</code>を設定することでステートメントの再利用ができ、
処理スループット向上に寄与する。</p>
</li>
<li>
<p>大量のデータを一度に更新する場合、JDBCのバッチ更新を利用することで性能向上が期待できる。<br>
そのため、<code>MyBatisBatchItemWriter</code>で利用する<code>SqlSessionTemplate</code>には、<br>
<code>executorType</code>に(<code>REUSE</code>ではなく)<code>BATCH</code>が設定されている。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Macchinetta Batch 2.xでは、同時に2つの異なる<code>ExecutorType</code>が存在する。
一方の<code>ExecutorType</code>で実装する場合が多いと想定するが、併用時は特に注意が必要である。
この点は、<a href="#Ch05_DBAccess_HowToUse_Input_MapperInterface">Mapperインターフェース(入力)</a>にて詳しく説明する。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">MyBatisのその他のパラメータ</div>
<div class="paragraph">
<p>その他のパラメータに関しては以下リンクを参照し、 アプリケーションの特性にあった設定を行うこと。<br>
<a href="http://www.mybatis.org/mybatis-3/configuration.html" class="bare">http://www.mybatis.org/mybatis-3/configuration.html</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以下にデフォルト提供されている設定を示す。</p>
</div>
<div class="listingblock">
<div class="title">META-INF/spring/launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.SqlSessionFactoryBean</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:dataSource-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">configuration</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.ibatis.session.Configuration</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:localCacheScope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STATEMENT</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:lazyLoadingEnabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:aggressiveLazyLoading</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:defaultFetchSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:defaultExecutorType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REUSE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.SqlSessionTemplate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:executorType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BATCH</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatisの各種設定を行う。<br>
デフォルトでは、fetchSizeを1000に設定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MyBatisBatchItemWriter</code>のために、<code>executorType</code>が<code>BATCH</code>の<code>SqlSessionTemplate</code>を定義している。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">adminDataSourceを利用したSqlSessionFactoryの定義箇所について</div>
<div class="paragraph">
<p>同期実行をする場合は、adminDataSourceを利用した<code>SqlSessionFactory</code>は不要であるため、定義がされていない。
<a href="#Ch04_AsyncJobWithDB">非同期実行(DBポーリング)</a>を利用する場合、ジョブ要求テーブルへアクセスするために
<code>META-INF/spring/async-batch-daemon.xml</code>内に定義されている。</p>
</div>
<div class="listingblock">
<div class="title">META-INF/spring/async-batch-daemon.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminSqlSessionFactory</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.SqlSessionFactoryBean</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:dataSource-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminDataSource</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">configuration</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.ibatis.session.Configuration</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:localCacheScope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STATEMENT</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:lazyLoadingEnabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:aggressiveLazyLoading</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:defaultFetchSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:defaultExecutorType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REUSE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Config_MapperXML"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Config_MapperXML"></a>5.2.2.1.3. Mapper XMLの定義</h6>
<div class="paragraph">
<p>Macchinetta Batch 2.x特有の説明事項はないので、Macchinetta Server 1.x 開発ガイドラインの
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.html#dataaccessmybatis3howtodababaseaccess">データベースアクセス処理の実装</a>を参照してほしい。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Config_Scan"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Config_Scan"></a>5.2.2.1.4. MyBatis-Springの設定</h6>
<div class="paragraph">
<p>MyBatis-Springが提供するItemReaderおよびItemWriterを使用する場合、MapperのConfigで使用するMapper XMLを設定する必要がある。</p>
</div>
<div class="paragraph">
<p>設定方法としては、以下の2つが考えられる。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>共通設定として、すべてのジョブで使用するMapper XMLを登録する。</p>
<div class="ulist">
<ul>
<li>
<p><code>META-INF/spring/launch-context.xml</code>にすべてのMapper XMLを記述することになる。</p>
</li>
</ul>
</div>
</li>
<li>
<p>個別設定として、ジョブ単位で利用するMapper XMLを登録する。</p>
<div class="ulist">
<ul>
<li>
<p><code>META-INF/jobs/</code>配下のBean定義に、個々のジョブごとに必要なMapper XMLを記述することになる。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>共通設定をしてしまうと、同期実行をする際に実行するジョブのMapper XMLだけでなく、その他のジョブが使用するMapper XMLも読み込んでしまうために以下に示す弊害が生じる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ジョブの起動までに時間がかかる</p>
</li>
<li>
<p>メモリリソースの消費が大きくなる</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これを回避するために、Macchinetta Batch 2.xでは、個別設定として、個々のジョブ定義でそのジョブが必要とするMapper XMLだけを指定する設定方法を採用する。</p>
</div>
<div class="paragraph">
<p>基本的な設定方法については、Macchinetta Server 1.x 開発ガイドラインの
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.html#dataaccessmybatis3howtousesettingsmybatis-spring">MyBatis-Springの設定</a>を参照してほしい。</p>
</div>
<div class="paragraph">
<p>Macchinetta Batch 2.xでは、複数の<code>SqlSessionFactory</code>および<code>SqlSessionTemplate</code>が定義されているため、
どれを利用するか明示的に指定する必要がある。<br>
基本的には<code>jobSqlSessionFactory</code>を指定すればよい。</p>
</div>
<div class="paragraph">
<p>以下に設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">META-INF/jobs/common/jobCustomerList01.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.mst</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mybatis:scan&gt;</code>の<code>factory-ref</code>属性に<code>jobSqlSessionFactory</code>を設定する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_DBAccess_HowToUse_Input"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Input"></a>5.2.2.2. 入力</h5>
<div class="paragraph">
<p>データベースアクセスの入力について以下のとおり説明する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Input_MyBatisItemReader">MyBatisCursorItemReader</a></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Input_MyBatisItemReader_Overview">機能概要</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Input_MyBatisItemReader_Chunk">チャンクモデルにおける利用方法</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Input_MyBatisItemReader_Tasklet">タスクレットモデルにおける利用方法</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Input_MyBatisItemReader_SearchCondition">検索条件の指定方法</a></p>
</li>
</ol>
</div>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Input_MapperInterface">Mapperインターフェース(入力)</a></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Input_MapperInterface_Overview">機能概要</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Input_MapperInterface_Chunk">チャンクモデルにおける利用方法</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Input_MapperInterface_Tasklet">タスクレットモデルにおける利用方法</a></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Input_MyBatisItemReader"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Input_MyBatisItemReader"></a>5.2.2.2.1. MyBatisCursorItemReader</h6>
<div class="paragraph">
<p>ここではItemReaderとして
MyBatis-Springが提供する<code>MyBatisCursorItemReader</code>によるデータベースアクセスについて説明する。</p>
</div>
<div id="Ch05_DBAccess_HowToUse_Input_MyBatisItemReader_Overview" class="dlist">
<dl>
<dt class="hdlist1">機能概要</dt>
<dd>
<p>MyBatis-Springが提供するItemReaderとして下記の2つが存在する。</p>
<div class="ulist">
<ul>
<li>
<p><code>org.mybatis.spring.batch.MyBatisCursorItemReader</code></p>
</li>
<li>
<p><code>org.mybatis.spring.batch.MyBatisPagingItemReader</code></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>MyBatisPagingItemReader</code>は、Macchinetta Server 1.x 開発ガイドラインの
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.html#entity-sql">Entityのページネーション検索(SQL絞り込み方式)</a>で
説明している仕組みを利用したItemReaderである。<br>
一定件数を取得した後に再度SQLを発行するため、データの一貫性が保たれない可能性がある。
そのため、バッチ処理で利用するには危険であることから、Macchinetta Batch 2.xでは原則使用しない。<br>
Macchinetta Batch 2.xではMyBatisと連携して、Cursorを利用し取得データを返却する<code>MyBatisCursorItemReader</code>のみを利用する。</p>
</div>
<div class="paragraph">
<p>Macchinetta Batch 2.xでは、<a href="#Ch05_DBAccess_HowToUse_Config_Scan">MyBatis-Springの設定</a>で説明したとおり、
<code>mybatis:scan</code>によって動的にMapper XMLを登録する方法を採用している。
そのため、Mapper XMLに対応するインターフェースを用意する必要がある。
詳細については、Macchinetta Server 1.x 開発ガイドラインの
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.html#dataaccessmybatis3howtodababaseaccess">データベースアクセス処理の実装</a>を参照。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">MyBatisCursorItemReaderにおけるクローズ時の注意事項について</div>
<div class="paragraph">
<p><code>Mybatis-Spring1.3.1</code>までの不具合により、<code>MyBatisCursorItemReader</code>をオープンせずにクローズする場合（@BeforeStepアノテーションで異常終了する場合等）、<code>java.lang.NullPointerException</code>が発生する。
その場合は、<code>MyBatisCursorItemReader</code>を拡張するなどして、クローズ時に例外を捕捉し、正常終了するように実装する必要がある。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>MyBatisCursorItemReader</code>を利用してデータベースを参照するための実装例を処理モデルごとに以下に示す。</p>
</div>
<div id="Ch05_DBAccess_HowToUse_Input_MyBatisItemReader_Chunk" class="dlist">
<dl>
<dt class="hdlist1">チャンクモデルにおける利用方法</dt>
<dd>
<p>チャンクモデルで<code>MyBatisCursorItemReader</code>を利用してデータベースを参照する実装例を以下に示す。<br>
ここでは、<code>MyBatisCursorItemReader</code>の実装例と、実装した<code>MyBatisCursorItemReader</code>を利用してデータベースから取得したデータを処理する<code>ItemProcessor</code>の実装例を説明する。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.mst</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) (3) (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.mst.CustomerRepository.findAll</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outputAllCustomerList01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outputAllCustomerList01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retrieveBranchFromContextItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="comment">&lt;!-- omitted --&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Mapper XML</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (6) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.mst.CustomerRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>

    <span class="comment">&lt;!-- (7) --&gt;</span>
    <span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findAll</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.mst.Customer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="inline-delimiter">&lt;![CDATA[</span>
        SELECT
            customer_id AS customerId,
            customer_name AS customerName,
            customer_address AS customerAddress,
            customer_tel AS customerTel,
            charge_branch_id AS chargeBranchId,
            create_date AS createDate,
            update_date AS updateDate
        FROM
            customer_mst
        ORDER by
            charge_branch_id ASC, customer_id ASC
        <span class="inline-delimiter">]]&gt;</span>
    <span class="tag">&lt;/select&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Mapperインターフェース</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">CustomerRepository</span> {
    <span class="comment">// (8)</span>
    <span class="predefined-type">List</span>&lt;Customer&gt; findAll();

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ItemProcessor実装</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">RetrieveBranchFromContextItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;Customer, CustomerWithBranch&gt; {
    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> CustomerWithBranch process(Customer item) <span class="directive">throws</span> <span class="exception">Exception</span> { <span class="comment">// (9)</span>
        CustomerWithBranch newItem = <span class="keyword">new</span> CustomerWithBranch(item);
        newItem.setBranch(branches.get(item.getChargeBranchId())); <span class="comment">// (10)</span>
        <span class="keyword">return</span> newItem;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XMLの登録を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MyBatisCursorItemReader</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>queryId</code>のプロパティに、(7)で定義しているSQLのIDを(6)の<code>namespace</code> + <code>&lt;メソッド名&gt;</code>で指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sqlSessionFactory-ref</code>のプロパティに、アクセスするデータベースの<code>SqlSessionFactory</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)で定義した<code>MyBatisCursorItemReader</code>をreader属性に指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XMLを定義する。namespaceの値とインターフェースのFQCNを一致させること。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQLを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)で定義したSQLのIDに対応するメソッドをインターフェースに定義する。<br>
この例では検索条件のパラメータとして<code>branchId</code>を@Paramアノテーションにより渡している。条件が無い場合は不要である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数として受け取るitemの型は、
このクラスで実装しているItemProcessorインターフェースの型引数で指定した入力オブジェクトの型である<code>SalesPerformanceDetail</code>とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数に渡されたitemを利用して各カラムの値を取得する。</p></td>
</tr>
</tbody>
</table>
<div id="Ch05_DBAccess_HowToUse_Input_MyBatisItemReader_Tasklet" class="dlist">
<dl>
<dt class="hdlist1">タスクレットモデルにおける利用方法</dt>
<dd>
<p>タスクレットモデルで<code>MyBatisCursorItemReader</code>を利用してデータベースを参照する実装例を以下に示す。<br>
ここでは、<code>MyBatisCursorItemReader</code>の実装例と、実装した<code>MyBatisCursorItemReader</code>を利用してデータベースから取得したデータを処理する<code>Tasklet</code>の実装例を説明する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>タスクレットモデルでチャンクモデルのコンポーネントを利用する際の留意点については<a href="#Ch03_CreateTaskletJob_HowToUse_InOutImpl">チャンクモデルのコンポーネントを利用するTasklet実装</a>を参照。</p>
</div>
<div class="paragraph">
<p>タスクレットモデルではチャンクモデルと異なり、<code>Tasklet</code>実装においてリソースを明示的にオープン/クローズする必要がある。
また、入力データの読み込みも明示的に行う。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.plan</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) (3) (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">summarizeDetails</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.plan.SalesPlanDetailRepository.summarizeDetails</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customizedJobExitCodeTaskletJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customizedJobExitCodeTaskletJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">checkAmountTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Mapper XML</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.plan.SalesPlanDetailRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>

    <span class="comment">&lt;!-- (6) --&gt;</span>
    <span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">summarizeDetails</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.plan.SalesPlanSummary</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="inline-delimiter">&lt;![CDATA[</span>
        SELECT
            branch_id AS branchId, year, month, SUM(amount) AS amount
        FROM
            sales_plan_detail
        GROUP BY
            branch_id, year, month
        ORDER BY
            branch_id ASC, year ASC, month ASC
         <span class="inline-delimiter">]]&gt;</span>
    <span class="tag">&lt;/select&gt;</span>

<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Mapperインターフェース</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">SalesPlanDetailRepository</span> {
    <span class="comment">// (7)</span>
    <span class="predefined-type">List</span>&lt;SalesPlanSummary&gt; summarizeDetails();

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Tasklelet実装</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CheckAmountTasklet</span> <span class="directive">implements</span> Tasklet {
    <span class="comment">// (8)</span>
    <span class="annotation">@Inject</span>
    ItemStreamReader&lt;SalesPlanSummary&gt; reader;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {
        SalesPlanSummary item = <span class="predefined-constant">null</span>;

        <span class="predefined-type">List</span>&lt;SalesPlanSummary&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(CHUNK_SIZE);
        <span class="type">int</span> errorCount = <span class="integer">0</span>;

        <span class="keyword">try</span> {
            <span class="comment">// (9)</span>
            reader.open(chunkContext.getStepContext().getStepExecution().getExecutionContext());
            <span class="keyword">while</span> ((item = reader.read()) != <span class="predefined-constant">null</span>) { <span class="comment">// (10)</span>
                <span class="keyword">if</span> (item.getAmount().signum() == -<span class="integer">1</span>) {
                    logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">amount is negative. skip item [item: {}]</span><span class="delimiter">&quot;</span></span>, item);
                    errorCount++;
                    <span class="keyword">continue</span>;
                }

                <span class="comment">// omitted.</span>
            }

            <span class="comment">// catch block is omitted.</span>
        } <span class="keyword">finally</span> {
            <span class="comment">// (11)</span>
            reader.close();
        }
    }
    <span class="comment">// omitted.</span>

    <span class="keyword">return</span> RepeatStatus.FINISHED;
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XMLの登録を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MyBatisCursorItemReader</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>queryId</code>のプロパティに、(6)で定義しているSQLのIDを(5)の<code>namespace</code> + <code>&lt;メソッド名&gt;</code>で指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sqlSessionFactory-ref</code>のプロパティに、アクセスするデータベースの<code>SqlSessionFactory</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XMLを定義する。namespaceの値とインターフェースのFQCNを一致させること。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQLを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)で定義したSQLのIDに対応するメソッドをインターフェースに定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Inject</code>アノテーションを付与して、<code>ItemStreamReader</code>の実装をインジェクションする。<br>
対象となるリソースへのオープン・クローズを実施する必要があるため、
<code>ItemReader</code>にリソースのopen/closeメソッドを追加した<code>ItemStreamReader</code>インタフェースで実装をインジェクションする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力リソースをオープンする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力データを1件ずつ読み込む。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力リソースをクローズする。<br>
リソースは必ずクローズすること。なお、ここで例外が発生した場合、タスクレット全体のトランザクションがロールバックされ、
例外のスタックトレースを出力しジョブが異常終了する。そのため、必要に応じて例外処理を実装すること。</p></td>
</tr>
</tbody>
</table>
<div id="Ch05_DBAccess_HowToUse_Input_MyBatisItemReader_SearchCondition" class="dlist">
<dl>
<dt class="hdlist1">検索条件の指定方法</dt>
<dd>
<p>データベースアクセスの際に検索条件を指定して検索を行いたい場合は、
Bean定義にてMap形式でジョブパラメータから値を取得し、キーを設定することで検索条件を指定することができる。
以下にジョブパラメータを指定したジョブ起動コマンドの例と実装例を示す。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ジョブパラメータを指定した場合のジョブ起動コマンド</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">java -cp ${CLASSPATH} org.springframework.batch.core.launch.support.CommandLineJobRunner
 /META-INF/job/job001 job001 year=2017 month=12</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">MapperXMLの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findByYearAndMonth</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.performance.SalesPerformanceSummary</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    SELECT
        branch_id AS branchId, year, month, amount
    FROM
        sales_performance_summary
    WHERE
        year = #{year} AND month = #{month}
    ORDER BY
        branch_id ASC
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/select&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch08.parallelandmultiple.repository.SalesSummaryRepository.findByYearAndMonth</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameterValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="comment">&lt;!-- (4) --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">year</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['year']}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">month</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['month']}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

            <span class="comment">&lt;!-- omitted --&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索条件を指定して取得するSQLを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データベースからデータを取得するための<code>ItemReader</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロパティ名に<code>parameterValues</code>を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索条件にする値をジョブパラメータから取得し、キーに設定することで検索条件を指定する。
SQLの引数が数値型で定義されているため、<code>value-type</code>で<code>Integer</code>に変換して渡している。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">StepExectionContextによる検索指定方法について</div>
<div class="paragraph">
<p>@beforeStepなどジョブの前処理で検索条件を指定する場合は、<code>StepExecutionContext</code>に設定することで、<code>JobParameters</code>同様に取得することができる。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Input_MapperInterface"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Input_MapperInterface"></a>5.2.2.2.2. Mapperインターフェース(入力)</h6>
<div class="paragraph">
<p>ItemReader以外でデータベースの参照を行うにはMapperインターフェースを利用する。<br>
ここではMapperインターフェースを利用したデータベースの参照について説明する。</p>
</div>
<div id="Ch05_DBAccess_HowToUse_Input_MapperInterface_Overview" class="dlist">
<dl>
<dt class="hdlist1">機能概要</dt>
<dd>
<p>Mapperインターフェースを利用するにあたって、Macchinetta Batch 2.xでは以下の制約を設けている。</p>
</dd>
</dl>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Mapperインターフェースの利用可能な箇所</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">処理</th>
<th class="tableblock halign-left valign-top">ItemProcessor</th>
<th class="tableblock halign-left valign-top">Tasklet</th>
<th class="tableblock halign-left valign-top">リスナー</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">参照</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">利用可</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">利用可</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">利用可</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">条件付で利用可</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">利用可</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">利用不可</p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">ItemProcessorでの制約</dt>
<dd>
<p>MyBatisには、同一トランザクション内で2つ以上の<code>ExecutorType</code>で実行してはいけないという制約がある。<br>
「ItemWriterに<code>MyBatisBatchItemWriter</code>を使用する」と「ItemProcessorでMapperインターフェースを使用し参照更新をする」を
同時に満たす場合は、この制約に抵触する。<br>
制約を回避するには、ItemProcessorでは<code>ExecutorType</code>が<code>BATCH</code>のMapperインターフェースによって
データベースアクセスすることになる。<br>
加えて、<code>MyBatisBatchItemWriter</code>ではSQL実行後のステータスチェックにより、自身が発行したSQLかどうかチェックしているのだが、
当然ItemProcessorによるSQL実行は管理できないためエラーが発生してしまう。<br>
よって、<code>MyBatisBatchItemWriter</code>を利用している場合は、Mapperインターフェースによる更新はできなくなり、参照のみとなる。</p>
</dd>
</dl>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>MyBatisBatchItemWriter</code>のエラーチェックを無効化する設定ができるが、予期せぬ動作が起きる可能性があるため無効化は禁止する。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Taskletでの制約</dt>
<dd>
<p>Taskletでは、Mapperインターフェースを利用することが基本であるため、ItemProcessorのような影響はない。<br>
<code>MyBatisBatchItemWriter</code>をInjectして利用することも考えられるが、その場合はMapperインターフェース自体を
<code>BATCH</code>設定で処理すればよい。つまり、Taskletでは、<code>MyBatisBatchItemWriter</code>をInjectして使う必要は基本的にない。</p>
</dd>
</dl>
</div>
<div id="Ch05_DBAccess_HowToUse_Input_MapperInterface_Chunk" class="dlist">
<dl>
<dt class="hdlist1">チャンクモデルにおける利用方法</dt>
<dd>
<p>チャンクモデルでMapperインターフェースを利用してデータベースを参照する実装例を以下に示す。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ItemProcessorでの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UpdateItemFromDBProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPlanDetail&gt; {

    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    CustomerRepository customerRepository;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPerformanceDetail readItem) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// (2)</span>
        Customer customer = customerRepository.findOne(readItem.getCustomerId());

        <span class="comment">// omitted.</span>

        <span class="keyword">return</span> writeItem;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
        <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">template-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.performance.SalesPerformanceDetailRepository.findAll</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- omitted job definition --&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>MapperインターフェースとMapper XMLについては<a href="#Ch05_DBAccess_HowToUse_Input_MyBatisItemReader">MyBatisCursorItemReader</a>
で説明している内容以外に特筆すべきことがないため省略する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">項番</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">説明</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MapperインターフェースをInjectする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapperインターフェースで検索処理を実行する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XMLの登録を行う。<br>
<code>template-ref</code>属性に<code>BATCH</code>設定されている<code>batchModeSqlSessionTemplate</code>を指定することで、
ItemProcessorでのデータベースアクセスは<code>BATCH</code>となる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MyBatisCursorItemReader</code>を定義する。<br>
<code>sqlSessionFactory-ref</code>プロパティに、アクセスするデータベースの<code>SqlSessionFactory</code>を指定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">MyBatisCursorItemReader設定の補足</div>
<div class="paragraph">
<p>以下に示す定義例のように、MyBatisCursorItemReaderとMyBatisBatchItemWriterで異なる<code>ExecutorType</code>を使用しても問題ない。
これは、MyBatisCursorItemReaderによるトランザクションはItemWriterのトランザクションとは別であるからである。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xxx</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">yyy</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div id="Ch05_DBAccess_HowToUse_Input_MapperInterface_Tasklet" class="dlist">
<dl>
<dt class="hdlist1">タスクレットモデルにおける利用方法</dt>
<dd>
<p>タスクレットモデルでMapperインターフェースを利用してデータベースを参照する実装例を以下に示す。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Taskletでの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">OptimisticLockTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    ExclusiveControlRepository repository;

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        Branch branch = repository.branchFindOne(branchId); <span class="comment">// (2)</span>

        <span class="comment">// omitted.</span>

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
        <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.exclusivecontrol.repository</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletOptimisticLockCheckJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletOptimisticLockCheckJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">optimisticLockTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>MapperインターフェースとMapper XMLについては<a href="#Ch05_DBAccess_HowToUse_Input_MyBatisItemReader">MyBatisCursorItemReader</a>
で説明している内容以外に特筆すべきことがないため省略する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MapperインターフェースをInjectする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapperインターフェースで検索処理を実行する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XMLの登録を行う。<br>
<code>factory-ref</code>属性に<code>REUSE</code>設定されている<code>jobSqlSessionFactory</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MapperインターフェースをInjectしTaskletを設定する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_DBAccess_HowToUse_Output"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Output"></a>5.2.2.3. 出力</h5>
<div class="paragraph">
<p>データベースアクセスの出力について以下のとおり説明する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter">MyBatisBatchItemWriter</a></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter_Overview">機能概要</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter_Chunk">チャンクモデルにおける利用方法</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter_Tasklet">タスクレットモデルにおける利用方法</a></p>
</li>
</ol>
</div>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Output_MapperInterface">Mapperインターフェース(出力)</a></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Output_MapperInterface_Overview">機能概要</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Output_MapperInterface_Chunk">チャンクモデルにおける利用方法</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Output_MapperInterface_Tasklet">タスクレットモデルにおける利用方法</a></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter"></a>5.2.2.3.1. MyBatisBatchItemWriter</h6>
<div class="paragraph">
<p>ここではItemWriterとして
MyBatis-Springが提供する<code>MyBatisBatchItemWriter</code>によるデータベースアクセスについて説明する。</p>
</div>
<div id="Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter_Overview" class="dlist">
<dl>
<dt class="hdlist1">機能概要</dt>
<dd>
<p>MyBatis-Springが提供するItemWriterは以下の1つのみである。</p>
<div class="ulist">
<ul>
<li>
<p><code>org.mybatis.spring.batch.MyBatisBatchItemWriter</code></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>MyBatisBatchItemWriter</code>はMyBatisと連携してJDBCのバッチ更新機能を利用するItemWriterであり、
大量のデータを一度に更新する場合に性能向上が期待できる。<br>
基本的な設定については、<a href="#Ch05_DBAccess_HowToUse_Input_MyBatisItemReader">MyBatisCursorItemReader</a>と同じである。
<code>MyBatisBatchItemWriter</code>では、<a href="#Ch05_DBAccess_HowToUse_Config_MyBatisConfig">MyBatisの設定</a>で説明した
<code>batchModeSqlSessionTemplate</code>を指定する必要がある。</p>
</div>
<div class="paragraph">
<p><code>MyBatisBatchItemWriter</code>を利用してデータベースを更新するための実装例を以下に示す。</p>
</div>
<div id="Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter_Chunk" class="dlist">
<dl>
<dt class="hdlist1">チャンクモデルにおける利用方法</dt>
<dd>
<p>チャンクモデルで<code>MyBatisBatchItemWriter</code>を利用してデータベースを更新(登録)する実装例を以下に示す。<br>
ここでは、<code>MyBatisBatchItemWriter</code>の実装例と、実装した<code>MyBatisBatchItemWriter</code>を利用する<code>ItemProcessor</code>の実装例を説明する。
<code>ItemProcessor</code>実装では取得したデータを<code>MyBatisBatchItemWriter</code>を利用してデータベースの更新を行っている。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.exclusivecontrol.repository</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) (3) (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.exclusivecontrol.repository.ExclusiveControlRepository.branchExclusiveUpdate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:assertUpdates</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{new Boolean(jobParameters['assertUpdates'])}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkOptimisticLockCheckJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkOptimisticLockCheckJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchEditItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Mapper XML</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (6) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.plan.SalesPlanDetailRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (7) --&gt;</span>
    <span class="tag">&lt;insert</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">create</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="inline-delimiter">&lt;![CDATA[</span>
        INSERT INTO
            sales_plan_detail(branch_id, year, month, customer_id, amount)
        VALUES (
            #{branchId}, #{year}, #{month}, #{customerId}, #{amount}
        )
        <span class="inline-delimiter">]]&gt;</span>
    <span class="tag">&lt;/insert&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Mapperインターフェース</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">SalesPlanDetailRepository</span> {

    <span class="comment">// (8)</span>
    <span class="type">void</span> create(SalesPlanDetail salesPlanDetail);

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ItemProcessor実装</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">BranchEditItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;Branch, ExclusiveBranch&gt; {
    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ExclusiveBranch process(Branch item) <span class="directive">throws</span> <span class="exception">Exception</span> { <span class="comment">// (9)</span>
        ExclusiveBranch branch = <span class="keyword">new</span> ExclusiveBranch();
        branch.setBranchId(item.getBranchId());
        branch.setBranchName(item.getBranchName() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> - </span><span class="delimiter">&quot;</span></span> + identifier);
        branch.setBranchAddress(item.getBranchAddress() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> - </span><span class="delimiter">&quot;</span></span> + identifier);
        branch.setBranchTel(item.getBranchTel());
        branch.setCreateDate(item.getUpdateDate());
        branch.setUpdateDate(<span class="keyword">new</span> <span class="predefined-type">Timestamp</span>(clock.millis()));
        branch.setOldBranchName(item.getBranchName());

        <span class="comment">// (10)</span>
        <span class="keyword">return</span> branch;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XMLの登録を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MyBatisBatchItemWriter</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>statementId</code>のプロパティに、(7)で定義しているSQLのIDを(6)の<code>namespace</code> + <code>&lt;メソッド名&gt;</code>で指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sqlSessionTemplate-ref</code>のプロパティに、アクセスするデータベースの<code>SessionTemplate</code>を指定する。<br>
指定する<code>SessionTemplate</code>は、<code>executorType</code>が<code>BATCH</code>に設定されていることが必須である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)で定義した<code>MyBatisBatchItemWriter</code>をwriter属性に指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XMLを定義する。namespaceの値とインターフェースのFQCNを一致させること。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQLを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)で定義したSQLのIDに対応するメソッドをインターフェースに定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">返り値の型は、このクラスで実装しているItemProcessorインターフェースの型引数で指定した 出力オブジェクトの型である<code>ExclusiveBranch</code>とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新データを設定したDTOオブジェクトを返すことでデータベースへ出力する。</p></td>
</tr>
</tbody>
</table>
<div id="Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter_Tasklet" class="dlist">
<dl>
<dt class="hdlist1">タスクレットモデルにおける利用方法</dt>
<dd>
<p>タスクレットモデルで<code>MyBatisBatchItemWriter</code>を利用してデータベースを更新(登録)する実装例を以下に示す。<br>
ここでは、<code>MyBatisBatchItemWriter</code>の実装例と実装した<code>MyBatisBatchItemWriter</code>を利用する<code>Tasklet</code>の実装例を説明する。
タスクレットモデルでチャンクモデルのコンポーネントを利用する際の留意点については<a href="#Ch03_CreateTaskletJob_HowToUse_InOutImpl">チャンクモデルのコンポーネントを利用するTasklet実装</a>を参照。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.plan</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) (3) (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.plan.SalesPlanDetailRepository.create</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletJobWithListenerWithinJobScope</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletJobWithListenerWithinJobScope.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesPlanDetailRegisterTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="comment">&lt;!-- omitted. --&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Mapper XML</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.plan.SalesPlanDetailRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (6) --&gt;</span>
    <span class="tag">&lt;insert</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">create</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="inline-delimiter">&lt;![CDATA[</span>
        INSERT INTO
            sales_plan_detail(branch_id, year, month, customer_id, amount)
        VALUES (
            #{branchId}, #{year}, #{month}, #{customerId}, #{amount}
        )
        <span class="inline-delimiter">]]&gt;</span>
    <span class="tag">&lt;/insert&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Mapperインターフェース</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">SalesPlanDetailRepository</span> {
    <span class="comment">// (7)</span>
    <span class="type">void</span> create(SalesPlanDetail salesPlanDetail);

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Tasklet実装</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailRegisterTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="comment">// omitted.</span>

    <span class="comment">// (8)</span>
    <span class="annotation">@Inject</span>
    ItemWriter&lt;SalesPlanDetail&gt; writer;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {
        SalesPlanDetail item = <span class="predefined-constant">null</span>;

        <span class="keyword">try</span> {
            reader.open(chunkContext.getStepContext().getStepExecution().getExecutionContext());

            <span class="predefined-type">List</span>&lt;SalesPlanDetail&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(); <span class="comment">// (9)</span>

            <span class="keyword">while</span> ((item = reader.read()) != <span class="predefined-constant">null</span>) {

                items.add(processor.process(item)); <span class="comment">// (10)</span>
                <span class="keyword">if</span> (items.size() == <span class="integer">10</span>) {
                    writer.write(items); <span class="comment">// (11)</span>
                    items.clear();
                }
            }
            <span class="comment">// omitted.</span>
        }
        <span class="comment">// omitted.</span>

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>MapperインターフェースとMapper XMLについては<a href="#Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter">MyBatisBatchItemWriter</a>
で説明している内容以外に特筆すべきことがないため省略する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XMLの登録を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MyBatisBatchItemWriter</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>statementId</code>のプロパティに、(6)で定義しているSQLのIDを(5)の<code>namespace</code> + <code>&lt;メソッド名&gt;</code>で指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sqlSessionTemplate-ref</code>のプロパティに、アクセスするデータベースの<code>SessionTemplate</code>を指定する。<br>
指定する<code>SessionTemplate</code>は、<code>executorType</code>が<code>BATCH</code>に設定されていることが必須である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XMLを定義する。namespaceの値とインターフェースのFQCNを一致させること。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQLを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)で定義したSQLのIDに対応するメソッドをインターフェースに定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Inject</code>アノテーションを付与して、<code>ItemWriter</code>の実装をインジェクションする。<br>
<code>ItemReader</code>とは異なり、データベースの更新ではリソースのopen/closeが不要であるため、<code>ItemStreamWriter</code>ではなく<code>ItemWriter</code>インターフェースにインジェクションする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力データを格納するリストを定義する。<br>
<code>ItemWriter</code>では一定件数のデータをまとめて出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リストに更新データを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新データを設定したリストを引数に指定して、データベースへ出力する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Output_MapperInterface"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Output_MapperInterface"></a>5.2.2.3.2. Mapperインターフェース(出力)</h6>
<div class="paragraph">
<p>ItemWriter以外でデータベースの更新を行うにはMapperインターフェースを利用する。<br>
ここではMapperインターフェースを利用したデータベースの更新について説明する。</p>
</div>
<div id="Ch05_DBAccess_HowToUse_Output_MapperInterface_Overview" class="dlist">
<dl>
<dt class="hdlist1">機能概要</dt>
<dd>
<p>Mapperインターフェースを利用してデータベースアクセスするうえでのMacchinetta Batch 2.xとしての制約は<a href="#Ch05_DBAccess_HowToUse_Input_MapperInterface">Mapperインターフェース(入力)</a>を参照のこと。</p>
</dd>
</dl>
</div>
<div id="Ch05_DBAccess_HowToUse_Output_MapperInterface_Chunk" class="dlist">
<dl>
<dt class="hdlist1">チャンクモデルにおける利用方法</dt>
<dd>
<p>チャンクモデルでMapperインターフェースを利用してデータベースを更新(登録)する実装例を以下に示す。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ItemProcessorでの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UpdateCustomerItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;Customer, Customer&gt; {

    <span class="comment">// omitted.</span>

    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    DBAccessCustomerRepository customerRepository;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Customer process(Customer item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        item.setCustomerName(<span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">%s updated by mapper if</span><span class="delimiter">&quot;</span></span>, item.getCustomerName()));
        item.setCustomerAddress(<span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">%s updated by item writer</span><span class="delimiter">&quot;</span></span>, item.getCustomerAddress()));
        item.setUpdateDate(<span class="keyword">new</span> <span class="predefined-type">Timestamp</span>(clock.millis()));

        <span class="comment">// (2)</span>
        <span class="type">long</span> cnt = customerRepository.updateName(item);

        <span class="comment">// omitted.</span>

        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
        <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.dbaccess.repository;jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">template-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.plan.SalesPlanDetailRepository.create</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updateMapperAndItemWriterBatchModeJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updateMapperAndItemWriterBatchModeJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updateCustomerItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>MapperインターフェースとMapper XMLについては<a href="#Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter">MyBatisBatchItemWriter</a>
で説明している内容以外に特筆すべきことがないため省略する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">項番</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">説明</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MapperインターフェースをInjectする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTOオブジェクトを生成して更新データを設定し、DTOオブジェクトを返却することでデータベースの更新を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XMLの登録を行う。<br>
<code>template-ref</code>属性に<code>BATCH</code>設定されている<code>batchModeSqlSessionTemplate</code>を指定することで、ItemProcessorでのデータベースアクセスは<code>BATCH</code>となる。
ここで、<code>factory-ref="jobSqlSessionFactory"</code>としてしまうと、前述の制約に抵触し、<code>MyBatisBatchItemWriter</code>実行時に例外が発生してしまう。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MyBatisBatchItemWriter</code>を定義する。<br>
<code>sqlSessionTemplate-ref</code>プロパティに<code>BATCH</code>設定されている<code>batchModeSqlSessionTemplate</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)で定義した<code>MyBatisBatchItemWriter</code>をwriter属性に指定する。</p></td>
</tr>
</tbody>
</table>
<div id="Ch05_DBAccess_HowToUse_Output_MapperInterface_Tasklet" class="dlist">
<dl>
<dt class="hdlist1">タスクレットモデルにおける利用方法</dt>
<dd>
<p>タスクレットモデルでMapperインターフェースを利用してデータベースを更新(登録)する実装例を以下に示す。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Taskletでの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">OptimisticLockTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    ExclusiveControlRepository repository;

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        Branch branch = repository.branchFindOne(branchId);

        <span class="comment">// (2)</span>
        ExclusiveBranch exclusiveBranch = <span class="keyword">new</span> ExclusiveBranch();
        exclusiveBranch.setBranchId(branch.getBranchId());
        exclusiveBranch.setBranchName(branch.getBranchName() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> - </span><span class="delimiter">&quot;</span></span> + identifier);
        exclusiveBranch.setBranchAddress(branch.getBranchAddress() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> - </span><span class="delimiter">&quot;</span></span> + identifier);
        exclusiveBranch.setBranchTel(branch.getBranchTel());
        exclusiveBranch.setCreateDate(branch.getUpdateDate());
        exclusiveBranch.setUpdateDate(<span class="keyword">new</span> <span class="predefined-type">Timestamp</span>(clock.millis()));
        exclusiveBranch.setOldBranchName(branch.getBranchName());

        <span class="comment">// (3)</span>
        <span class="type">int</span> result = repository.branchExclusiveUpdate(exclusiveBranch);

        <span class="comment">// omitted.</span>

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
        <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.exclusivecontrol.repository</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletOptimisticLockCheckJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletOptimisticLockCheckJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">optimisticLockTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>MapperインターフェースとMapper XMLは省略する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MapperインターフェースをInjectする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTOオブジェクトを生成して、更新データを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新データを設定したDTOオブジェクトを引数に指定して、Mapperインターフェースで更新処理を実行する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XMLの登録を行う。<br>
<code>factory-ref</code>属性に<code>REUSE</code>設定されている<code>jobSqlSessionFactory</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MapperインターフェースをInjectしTaskletを設定する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_DBAccess_HowToUse_MapperInterface_Listener"><a class="anchor" href="#Ch05_DBAccess_HowToUse_MapperInterface_Listener"></a>5.2.2.4. リスナーでのデータベースアクセス</h5>
<div class="paragraph">
<p>リスナーでのデータベースアクセスは他のコンポーネントと連携することが多い。
使用するリスナー及び実装方法によっては、Mapperインターフェースで取得したデータを、
他のコンポーネントへ引き渡す仕組みを追加で用意する必要がある。</p>
</div>
<div class="paragraph">
<p>リスナーでMapperインターフェースを利用してデータベースアクセスを実装するにあたり、以下の制約がある。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">リスナーでの制約</dt>
<dd>
<p>リスナーでもItemProcessorでの制約と同じ制約が成立する。
加えて、リスナーでは、更新を必要とするユースケースが考えにくい。よって、リスナーでは、更新系処理を禁止する。</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">リスナーで想定される更新処理の代替</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ジョブの状態管理</dt>
<dd>
<p>Spring BatchのJobRepositoryによって行われている</p>
</dd>
<dt class="hdlist1">データベースへのログ出力</dt>
<dd>
<p>ログのAppenderで実施すべき。ジョブのトランザクションとも別管理する必要がある。</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ここでは一例として、<a href="#Ch04_Listener_Overview_Types_StepExecutionListener">StepExecutionListener</a>で
ステップ実行前にデータを取得して、ItemProcessorで取得したデータを利用する例を示す。</p>
</div>
<div class="listingblock">
<div class="title">リスナーでの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CacheSetListener</span> <span class="directive">extends</span> StepExecutionListenerSupport {

    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    CustomerRepository customerRepository;

    <span class="comment">// (2)</span>
    <span class="annotation">@Inject</span>
    CustomerCache cache;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="comment">// (3)</span>
        <span class="keyword">for</span>(Customer customer : customerRepository.findAll()) {
            cache.addCustomer(customer.getCustomerId(), customer);
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ItemProcessorでの利用例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UpdateItemFromCacheProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPlanDetail&gt; {

    <span class="comment">// (4)</span>
    <span class="annotation">@Inject</span>
    CustomerCache cache;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPerformanceDetail readItem) <span class="directive">throws</span> <span class="exception">Exception</span> {
        Customer customer = cache.getCustomer(readItem.getCustomerId());  <span class="comment">// (5)</span>

        SalesPlanDetail writeItem = <span class="keyword">new</span> SalesPlanDetail();

        <span class="comment">// omitted.</span>
        writerItem.setCustomerName(customer.getCustomerName); <span class="comment">// (6)</span>

        <span class="keyword">return</span> writeItem;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">キャッシュクラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// (7)</span>
<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerCache</span> {

    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, Customer&gt; customerMap = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();

    <span class="directive">public</span> Customer getCustomer(<span class="predefined-type">String</span> customerId) {
        <span class="keyword">return</span> customerMap.get(customerId);
    }

    <span class="directive">public</span> <span class="type">void</span> addCustomer(<span class="predefined-type">String</span> id, Customer customer) {
        customerMap.put(id, customer);
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="comment">&lt;!-- (8) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
        <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">template-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="comment">&lt;!-- (9) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cacheSetListener</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.dbaccess.CacheSetListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DBAccessByItemListener</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DBAccessByItemListener.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updateItemFromCacheProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (10) --&gt;</span>
            <span class="comment">&lt;!-- (11) --&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cacheSetListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">項番</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">説明</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MapperインターフェースをInjectする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapperインターフェースから取得したデータをキャッシュするためのBeanをInjectする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リスナーにて、Mapperインターフェースからデータを取得してキャッシュする。<br>
ここでは、<code>StepExecutionListener#beforeStep</code>にてステップ実行前にキャッシュを作成し、
以降の処理ではキャッシュを参照することで、I/Oを低減し処理効率を高めている。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)で設定したキャッシュと同じBeanをInjectする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">キャッシュから該当するデータを取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新データにキャッシュからのデータを反映する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">キャッシュクラスをコンポーネントとして実装する。<br>
ここではBeanスコープは<code>singleton</code>にしている。ジョブに応じて設定すること。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XMLの登録を行う。<br>
<code>template-ref</code>属性に<code>BATCH</code>が設定されている<code>batchModeSqlSessionTemplate</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapperインターフェースを利用するリスナーを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">キャッシュを利用するItemProcessorを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)で定義したリスナーを登録する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">リスナーでのSqlSessionFactoryの利用</div>
<div class="paragraph">
<p>上記の例では、<code>batchModeSqlSessionTemplate</code>を設定しているが、<code>jobSqlSessionFactory</code>を設定してもよい。</p>
</div>
<div class="paragraph">
<p>チャンクのスコープ外で動作するリスナーについては、トランザクション外で処理されるため、
<code>jobSqlSessionFactory</code>を設定しても問題ない。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_DBAccess_HowToExtend"><a class="anchor" href="#Ch05_DBAccess_HowToExtend"></a>5.2.3. How To Extend</h4>
<div class="sect4">
<h5 id="compositeitemwriterにおける複数テーブルの更新"><a class="anchor" href="#compositeitemwriterにおける複数テーブルの更新"></a>5.2.3.1. CompositeItemWriterにおける複数テーブルの更新</h5>
<div class="paragraph">
<p>チャンクモデルで、1つの入力データに対して複数のテーブルへ更新を行いたい場合は、Spring Batchが提供する<code>CompositeItemWriter</code>を利用し、
各テーブルに対応した<code>MyBatisBatchItemWriter</code>を連結することで実現できる。</p>
</div>
<div class="paragraph">
<p>ここでは、売上計画と売上実績の2つのテーブルを更新する場合の実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title"><code>ItemProcessor</code>の実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;SalesPlanDetail, SalesDTO&gt; {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesDTO process(SalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> { <span class="comment">// (1)</span>

        SalesDTO salesDTO = <span class="keyword">new</span> SalesDTO();

        <span class="comment">// (2)</span>
        SalesPerformanceDetail spd = <span class="keyword">new</span> SalesPerformanceDetail();
        spd.setBranchId(item.getBranchId());
        spd.setYear(item.getYear());
        spd.setMonth(item.getMonth());
        spd.setCustomerId(item.getCustomerId());
        spd.setAmount(<span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">0L</span>));
        salesDTO.setSalesPerformanceDetail(spd);

        <span class="comment">// (3)</span>
        item.setAmount(item.getAmount().add(<span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">1L</span>)));
        salesDTO.setSalesPlanDetail(item);

        <span class="keyword">return</span> salesDTO;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">DTOの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesDTO</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="comment">// (4)</span>
    <span class="directive">private</span> SalesPlanDetail salesPlanDetail;

    <span class="comment">// (5)</span>
    <span class="directive">private</span> SalesPerformanceDetail salesPerformanceDetail;

    <span class="comment">// omitted</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">MapperXMLの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.dbaccess.repository.SalesRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findAll</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="inline-delimiter">&lt;![CDATA[</span>
        SELECT
            branch_id AS branchId, year, month, customer_id AS customerId, amount
        FROM
            sales_plan_detail
        ORDER BY
            branch_id ASC, year ASC, month ASC, customer_id ASC
        <span class="inline-delimiter">]]&gt;</span>
    <span class="tag">&lt;/select&gt;</span>

    <span class="comment">&lt;!-- (6) --&gt;</span>
    <span class="tag">&lt;update</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">update</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.dbaccess.SalesDTO</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="inline-delimiter">&lt;![CDATA[</span>
        UPDATE
            sales_plan_detail
        SET
            amount = #{salesPlanDetail.amount}
        WHERE
            branch_id = #{salesPlanDetail.branchId}
        AND
            year = #{salesPlanDetail.year}
        AND
            month = #{salesPlanDetail.month}
        AND
            customer_id = #{salesPlanDetail.customerId}
        <span class="inline-delimiter">]]&gt;</span>
    <span class="tag">&lt;/update&gt;</span>

    <span class="comment">&lt;!-- (7) --&gt;</span>
    <span class="tag">&lt;insert</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">create</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.dbaccess.SalesDTO</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="inline-delimiter">&lt;![CDATA[</span>
        INSERT INTO
            sales_performance_detail(
                branch_id,
                year,
                month,
                customer_id,
                amount
            )
        VALUES (
            #{salesPerformanceDetail.branchId},
            #{salesPerformanceDetail.year},
            #{salesPerformanceDetail.month},
            #{salesPerformanceDetail.customerId},
            #{salesPerformanceDetail.amount}
        )
        <span class="inline-delimiter">]]&gt;</span>
    <span class="tag">&lt;/insert&gt;</span>

<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>CompositeItemWriter</code>の適用例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- reader using MyBatisCursorItemReader --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.dbaccess.repository.SalesRepository.findAll</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- writer MyBatisBatchItemWriter --&gt;</span>
<span class="comment">&lt;!-- (8) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">planWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.dbaccess.repository.SalesRepository.update</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (9) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">performanceWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.dbaccess.repository.SalesRepository.create</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (10) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.CompositeItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegates</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="comment">&lt;!-- (11)--&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">performanceWriter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">planWriter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (12) --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">useCompositeItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">useCompositeItemWriter.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">項番</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">説明</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力データに対して2つのテーブルを更新するための各エンティティを保持するDTOを出力とする<code>ItemProcessor</code>を実装する。<br>
<code>ItemWriter</code>には2つのテーブルを更新するために異なるオブジェクトを渡すことはできないため、更新に必要なオブジェクトを集約するDTOを定義している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">売上実績(SalesPerformanceDetail)を新規作成するためのエンティティを作成し、DTOに格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力データでもある売上計画(SalesPlanDetail)を更新するため、入力データを更新してDTOに格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">売上計画(SalesPlanDetail)を保持するようにDTOに定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">売上実績(SalesPerformanceDetail)を保持するようにDTOに定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTOから取得した売上計画(SalesPlanDetail)で、売上計画テーブル(sales_plan_detail)を更新するSQLを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTOから取得した売上実績(SalesPlanDetail)で、売上実績テーブル(sales_performance_detail)を新規作成するSQLを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">売上計画テーブル(sales_plan_detail)を更新する<code>MyBatisBatchItemWriter</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">売上実績テーブル(sales_performance_detail)を新規作成する<code>MyBatisBatchItemWriter</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8),(9)を順番に実行するために<code>CompositeItemWriter</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;list&gt;</code>タグ内に(8),(9)を設定する。指定した順番にItemWriterが実行される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンクの<code>writer</code>属性に(10)で定義したBeanを指定する。<code>processor</code>属性には(1)のItemProcessorを指定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#Ch05_Transaction_HowToUse_MultiDataSource_SingleTx">複数データソースへの出力(1ステップ)</a>で説明した
<code>org.springframework.data.transaction.ChainedTransactionManager</code>と同時に使用することで複数データソースに対しての更新もできる。</p>
</div>
<div class="paragraph">
<p>また、CompositeItemWriterは、ItemWriter実装であれば連結できるので、
MyBatisBatchItemWriterとFlatFileItemWriterを設定することで、データベース出力とファイル出力を同時に行うこともできる。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_DBAccess_HowToExtend_SearchCondition"><a class="anchor" href="#Ch05_DBAccess_HowToExtend_SearchCondition"></a>5.2.3.2. 検索条件の指定方法</h5>
<div class="paragraph">
<p>データベースアクセスの際に検索条件を指定して検索を行いたい場合は、
Bean定義にてMap形式でジョブパラメータから値を取得し、キーを設定することで検索条件を指定することができる。
以下にジョブパラメータを指定したジョブ起動コマンドの例と実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">ジョブパラメータを指定した場合のジョブ起動コマンド</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">java -cp ${CLASSPATH} org.springframework.batch.core.launch.support.CommandLineJobRunner
 /META-INF/job/job001 job001 year=2017 month=12</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">MapperXMLの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findByYearAndMonth</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.performance.SalesPerformanceSummary</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    SELECT
        branch_id AS branchId, year, month, amount
    FROM
        sales_performance_summary
    WHERE
        year = #{year} AND month = #{month}
    ORDER BY
        branch_id ASC
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/select&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch08.parallelandmultiple.repository.SalesSummaryRepository.findByYearAndMonth</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameterValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="comment">&lt;!-- (4) --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">year</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['year']}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">month</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['month']}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

            <span class="comment">&lt;!-- omitted --&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索条件を指定して取得するSQLを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データベースからデータを取得するための<code>ItemReader</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロパティ名に<code>parameterValues</code>を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索条件にする値をジョブパラメータから取得し、キーに設定することで検索条件を指定する。
SQLの引数が数値型で定義されているため、<code>value-type</code>で<code>Integer</code>に変換して渡している。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">StepExectionContextによる検索指定方法について</div>
<div class="paragraph">
<p>@beforeStepなどジョブの前処理で検索条件を指定する場合は、<code>StepExecutionContext</code>に設定することで、<code>JobParameters</code>同様に取得することができる。</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess"><a class="anchor" href="#Ch05_FileAccess"></a>5.3. ファイルアクセス</h3>
<div class="sect3">
<h4 id="Ch05_FileAccess_Overview"><a class="anchor" href="#Ch05_FileAccess_Overview"></a>5.3.1. Overview</h4>
<div class="paragraph">
<p>本節では、ファイルの入出力を行う方法について説明する。</p>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで同じ使い方になる。</p>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_Overview_FileType"><a class="anchor" href="#Ch05_FileAccess_Overview_FileType"></a>5.3.1.1. 扱えるファイルの種類</h5>
<div class="paragraph">
<div class="title">扱えるファイルの種類</div>
<p>Macchinetta Batch 2.xで扱えるファイルは以下のとおりである。<br>
これは、TERASOLUNA Batch 5.xにて扱えるものと同じである。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>フラットファイル</p>
</li>
<li>
<p>XML</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ここではフラットファイルの入出力を行うための方法について説明したのち、
XMLについて<a href="#Ch05_FileAccess_HowToExtend">How To Extend</a>で説明する。</p>
</div>
<div class="paragraph">
<p>まず、Macchinetta Batch 2.xで扱えるフラットファイルの種類を示す。<br>
フラットファイルにおける行をここでは<code>レコード</code>と呼び、
ファイルの種類はレコードの形式にもとづく、とする。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">レコード形式</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">形式</th>
<th class="tableblock halign-left valign-top">概要</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">可変長レコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CSVやTSVに代表される区切り文字により各項目を区切ったレコード形式。各項目の長さが可変である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">固定長レコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">項目の長さ(バイト数)により各項目を区切ったレコード形式。各項目の長さが固定である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">単一文字列レコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1レコードを1文字列として扱う形式。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">扱えるファイルの構造</div>
<p>フラットファイルの基本構造は以下の2点から構成される。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>レコード区分</p>
</li>
<li>
<p>レコードフォーマット</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">フラットファイルのフォーマットを構成する要素</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">要素</th>
<th class="tableblock halign-left valign-top">概要</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区分</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコードの種類、役割を指す。ヘッダ、データ、トレーラなどがある。<br>
詳しくは後述する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコードフォーマット</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ヘッダ、データ、トレーラレコードがそれぞれ何行あるのか、ヘッダ部～トレーラ部が複数回繰り返されるかなど、レコードの構造を指す。<br>
シングルフォーマットとマルチフォーマットがある。詳しくは後述する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Macchinetta Batch 2.xでは、各種レコード区分をもつシングルフォーマットおよびマルチフォーマットのフラットファイルを扱うことができる。</p>
</div>
<div class="paragraph">
<p>各種レコード区分およびレコードフォーマットについて説明する。</p>
</div>
<div class="paragraph">
<p>各種レコード区分の概要を以下に示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">レコード区分ごとの特徴</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">レコード区分</th>
<th class="tableblock halign-left valign-top">概要</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ヘッダレコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイル(データ部)の先頭に付与されるレコードである。<br>
フィールド名、ファイル共通の事項、データ部の集計情報などをもつ。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">データレコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイルの主な処理対象となるデータをもつレコードである。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">トレーラ/フッタレコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイル(データ部)の末尾に付与されるレコードである。<br>
ファイル共通の事項、データ部の集計情報などをもつ。<br>
シングルフォーマットの場合、フッタレコードと呼ばれることもある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">フッタ/エンドレコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">マルチフォーマットの場合にファイルの末尾に付与されるレコードである。<br>
ファイル共通の事項、ファイル全体の集計情報などをもつ。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">レコード区分を示すフィールドについて</div>
<div class="paragraph">
<p>ヘッダレコードやトレーラレコードをもつフラットファイルでは、レコード区分を示すフィールドをもたせる場合がある。<br>
Macchinetta Batch 2.xでは特にマルチフォーマットファイルの処理において、レコード区分ごとに異なる処理を実施する場合などにレコード区分のフィールドを活用する。<br>
レコード区分によって実行する処理を選択する場合の実装は、<a href="#Ch05_FileAccess_HowToExtend_MultiFormat">マルチフォーマット</a>を参考にすること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">ファイルフォーマット関連の名称について</div>
<div class="paragraph">
<p>個々のシステムにおけるファイルフォーマットの定義によっては、
フッタレコードをエンドレコードと呼ぶなど等ガイドラインとは異なる名称が使われている場合がある。<br>
適宜読み替えを行うこと。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>シングルフォーマットおよびマルチフォーマットの概要を以下に示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">シングルフォーマットおよびマルチフォーマットの概要</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">フォーマット</th>
<th class="tableblock halign-left valign-top">概要</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">シングルフォーマット</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ヘッダn行 + データn行 + トレーラn行 の形式である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">マルチフォーマット</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(ヘッダn行 + データn行 + トレーラn行)* n + フッタn行 の形式である。<br>
シングルフォーマットを複数回繰り返した後にフッタレコードが付与されている形式である。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>マルチフォーマットのレコード構成を図に表すと下記のようになる。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FileFormat_multi.png" alt="Multi format file layout">
</div>
<div class="title">マルチフォーマットのレコード構成図</div>
</div>
<div class="paragraph">
<p>シングルフォーマット、マルチフォーマットフラットファイルの例を以下に示す。<br>
なお、ファイルの内容説明に用いるコメントアウトを示す文字として<code>//</code>を使用する。</p>
</div>
<div class="listingblock">
<div class="title">シングルフォーマット、レコード区分なしフラットファイル(CSV形式)の例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">branchId,year,month,customerId,amount  // (1)
000001,2016,1,0000000001,100000000  // (2)
000001,2016,1,0000000002,200000000  // (2)
000001,2016,1,0000000003,300000000  // (2)
000001,3,600000000  // (3)</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">ファイルの内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ヘッダレコードである。<br>
データ部のフィールド名を示している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データレコードである。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トレーラレコードである。<br>
データ部の集計情報を保持している。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">マルチフォーマット、レコード区分ありのフラットファイル(CSV形式)の例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">// (1)
H,branchId,year,month,customerId,amount  // (2)
D,000001,2016,1,0000000001,100000000
D,000001,2016,1,0000000002,200000000
D,000001,2016,1,0000000003,300000000
T,000001,3,600000000
H,branchId,year,month,customerId,amount  // (2)
D,00002,2016,1,0000000004,400000000
D,00002,2016,1,0000000005,500000000
D,00002,2016,1,0000000006,600000000
T,00002,3,1500000000
H,branchId,year,month,customerId,amount  // (2)
D,00003,2016,1,0000000007,700000000
D,00003,2016,1,0000000008,800000000
D,00003,2016,1,0000000009,900000000
T,00003,3,2400000000
F,3,9,4500000000  // (3)</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">ファイルの内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコードの先頭にレコード区分を示すフィールドをもっている。<br>
それぞれ下記のレコード区分を示す。<br>
<code>H</code>：ヘッダレコード<br>
<code>D</code>：データレコード<br>
<code>T</code>：トレーラレコード<br>
<code>F</code>：フッタレコード</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchIdが変わるごとにヘッダ、データ、トレーラを3回繰り返している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フッタレコードである。<br>
ファイル全体の集計情報を保持している。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">データ部のフォーマットに関する前提</div>
<div class="paragraph">
<p><a href="#Ch05_FileAccess_HowToUse">How to use</a>では、データ部のレイアウトは同一のフォーマットである事を前提して説明する。<br>
これは、データ部のレコードはすべて同じ変換対象クラスへマッピングされることを意味する。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">マルチフォーマットファイルの説明について</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_HowToUse">How to use</a>では、シングルフォーマットファイルについて説明する。</p>
</li>
<li>
<p>マルチフォーマットや上記の構造にフッタ部を含む構造をもつフラットファイルについては、<a href="#Ch05_FileAccess_HowToExtend">How To Extend</a>を参照すること</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_Overview_FileAccessComponents"><a class="anchor" href="#Ch05_FileAccess_Overview_FileAccessComponents"></a>5.3.1.2. フラットファイルの入出力を行うコンポーネント</h5>
<div class="paragraph">
<p>フラットファイルを扱うためのクラスを示す。</p>
</div>
<div class="paragraph">
<div class="title">入力</div>
<p>フラットファイルの入力を行うために使用するクラスの関連は以下のとおりである。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemReader_component_relationship_class.png" alt="Component relationship FlatFileItemReader class diagram">
</div>
<div class="title">フラットファイルの入力を行うために使用するクラスの関連</div>
</div>
<div class="paragraph">
<p>各コンポーネントの呼び出し関係は以下のとおりである。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemReader_component_relationship_sequence.png" alt="Component relationship FlatFileItemReader sequence diagram">
</div>
<div class="title">各コンポーネントの呼び出し関係</div>
</div>
<div class="paragraph">
<p>各コンポーネントの詳細を以下に示す。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.FlatFileItemReader</dt>
<dd>
<p>フラットファイルを読み込みに使用する<code>ItemReader</code>の実装クラス。以下のコンポーネントを利用する。<br>
簡単な処理の流れは以下のとおり。<br>
1.<code>BufferedReaderFactory</code>を使用して<code>BufferedReader</code>を取得する。<br>
2.取得した<code>BufferedReader</code>を使用してフラットファイルから1レコードを読み込む。<br>
3.<code>LineMapper</code>を使用して1レコードを対象Beanへマッピングする。</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.BufferedReaderFactory</dt>
<dd>
<p>ファイルを読み込むための<code>BufferedReader</code>を生成する。</p>
</dd>
<dt class="hdlist1">org.springframework.batch.item.file.LineMapper</dt>
<dd>
<p>1レコードを対象Beanへマッピングする。以下のコンポーネントを利用する。<br>
簡単な処理の流れは以下のとおり。<br>
1.<code>LineTokenizer</code>を使用して1レコードを各項目に分割する。<br>
2.<code>FieldSetMapper</code>によって分割した項目をBeanのプロパティにマッピングする。</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.transform.LineTokenizer</dt>
<dd>
<p>ファイルから取得した1レコードを各項目に分割する。<br>
分割された各項目は<code>FieldSet</code>クラスに格納される。</p>
</dd>
<dt class="hdlist1">org.springframework.batch.item.file.mapping.FieldSetMapper</dt>
<dd>
<p>分割した1レコード内の各項目を対象Beanのプロパティへマッピングする。</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">出力</div>
<p>フラットファイルの出力を行うために使用するクラスの関連は以下のとおりである。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemWriter_component_relationship_class.png" alt="Component relationship FlatFileItemWriter class diagram">
</div>
<div class="title">フラットファイルの出力を行うために使用するクラスの関連</div>
</div>
<div class="paragraph">
<p>各コンポーネントの呼び出し関係は以下のとおりである。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemWriter_component_relationship_sequence.png" alt="Component relationship FlatFileItemWriter sequence diagram">
</div>
<div class="title">各コンポーネントの呼び出し関係</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.FlatFileItemWriter</dt>
<dd>
<p>フラットファイルへの書き出しに使用する<code>ItemWriter</code>の実装クラス。以下のコンポーネントを利用する。
<code>LineAggregator</code>対象Beanを1レコードへマッピングする。</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.transform.LineAggregator</dt>
<dd>
<p>対象Beanを1レコードへマッピングするために使う。
Beanのプロパティとレコード内の各項目とのマッピングは<code>FieldExtractor</code>で行う。</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.transform.FieldExtractor</dt>
<dd>
<p>対象Beanのプロパティを1レコード内の各項目へマッピングする。</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToUse"><a class="anchor" href="#Ch05_FileAccess_HowToUse"></a>5.3.2. How to use</h4>
<div class="paragraph">
<p>フラットファイルのレコード形式別に使い方を説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_HowToUse_VariableLength">可変長レコード</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_HowToUse_FixedLength">固定長レコード</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_HowToUse_SingleRecord">単一文字列レコード</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>その後、以下の項目について説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_HowToUse_HeaderFooter">ヘッダとフッタ</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_HowToUse_MultiFile">複数ファイル</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_HowToUse_ControlBreak">コントロールブレイク</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToUse_VariableLength"><a class="anchor" href="#Ch05_FileAccess_HowToUse_VariableLength"></a>5.3.2.1. 可変長レコード</h5>
<div class="paragraph">
<p>可変長レコードファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToUse_VariableLength_Input"><a class="anchor" href="#Ch05_FileAccess_HowToUse_VariableLength_Input"></a>5.3.2.1.1. 入力</h6>
<div class="paragraph">
<p>下記の入力ファイルを読み込むための設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="comment">&lt;!-- (6) (7) (8) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:quoteCharacter</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (9) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルの文字コードを設定する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Spring Batchが提供するコンポーネントの文字コードのデフォルト値はItemReaderとItemWriterで異なっている(ItemWriterのデフォルト値は「UTF-8」)。<br>
そのため、デフォルト値の値を使用する場合においても明示的に文字コードを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVMのデフォルト文字セット</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueを設定すると、入力ファイルが存在しない(開けない)場合に例外が発生する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.mapping.DefaultLineMapper</code>を設定する。<br>
<code>DefaultLineMapper</code>は、設定された<code>LineTokenizer</code>と<code>FieldSetMapper</code>を用いてレコードを変換対象クラスへ変換する基本的な動作を提供する<code>LineMapper</code>である。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineTokenizer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.transform.DelimitedLineTokenizer</code>を設定する。<br>
<code>DelimitedLineTokenizer</code>は、区切り文字を指定してレコードを分割する<code>LineTokenizer</code>の実装クラス。<br>
CSV形式の一般的書式とされるRFC-4180の仕様に定義されている、エスケープされた改行、区切り文字、囲み文字の読み込みに対応している。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1レコードの各項目に名前を付与する。<br>
<code>FieldSetMapper</code>で使われる<code>FieldSet</code>で設定した名前を用いて各項目を取り出すことができるようになる。<br>
レコードの先頭から各名前をカンマ区切りで設定する。<br>
<code>BeanWrapperFieldSetMapper</code>を利用する場合は、必須設定である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delimiter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">区切り文字を設定する</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">カンマ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">quoteCharacter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">囲み文字を設定する</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldSetMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列や数字など特別な変換処理が不要な場合は、<code>org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</code>を利用し、
プロパティ<code>targetType</code>に変換対象クラスを指定する。
これにより、(5)で設定した各項目の名前と一致するフィールドに値を自動的に設定したインスタンスを生成する。<br>
変換処理が必要な場合は、<code>org.springframework.batch.item.file.mapping.FieldSetMapper</code>の実装クラスを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">FieldSetMapperの独自実装について</div>
<div class="paragraph">
<p>FieldSetMapperを独自に実装する場合については、<a href="#Ch05_FileAccess_HowToExtend">How To Extend</a>を参照すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">TSV形式ファイルの入力方法</div>
<div class="paragraph">
<p>TSVファイルの読み込みを行う場合には、区切り文字にタブを設定することで実現可能である。</p>
</div>
<div class="listingblock">
<div class="title">TSVファイル読み込み時:区切り文字設定例(定数による設定)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;util:constant</span>
            <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer.DELIMITER_TAB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>または、以下のようにしてもよい。</p>
</div>
<div class="listingblock">
<div class="title">TSVファイル読み込み時:区切り文字設定例(文字参照による設定)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#09;</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToUse_VariableLength_Output"><a class="anchor" href="#Ch05_FileAccess_HowToUse_VariableLength_Output"></a>5.3.2.1.2. 出力</h6>
<div class="paragraph">
<p>下記の出力ファイルを書き出すための設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">001,CustomerName001,CustomerAddress001,11111111111,001
002,CustomerName002,CustomerAddress002,11111111111,002
003,CustomerName003,CustomerAddress003,11111111111,003</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Customer</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerName;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerAddress;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerTel;
    <span class="directive">private</span> <span class="predefined-type">String</span> chargeBranchId;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> createDate;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> updateDate;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のファイルを書き出すための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (9) --&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (10) --&gt;</span>
        <span class="comment">&lt;!-- (11) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId,customerName,customerAddress,customerTel,chargeBranchId</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルの文字コードを設定する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Spring Batchが提供するコンポーネントの文字コードのデフォルト値はItemReaderとItemWriterで異なっている(ItemReaderのデフォルト値は「JavaVMのデフォルト文字セット」)。<br>
そのため、デフォルト値の値を使用する場合においても明示的に文字コードを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区切り(改行コード)を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">システムプロパティの<code>line.separator</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appendAllowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、既存のファイルに追記をする。<br>
<span class="icon"><i class="fa fa-warning"></i></span> trueの場合、shouldDeleteIfExistsの設定値は無効化されるため、注意が必要である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> appendAllowedがtrueの場合は、このプロパティは無効化されるため、プロパティを指定しないことを推奨する。<br>
trueの場合、既にファイルが存在すれば削除する。<br>
falseの場合、既にファイルが存在すれば例外をスローする。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、出力件数が0件であれば出力対象ファイルを削除する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> 他のプロパティとの組み合わせによって意図しない動作をする場合があるため、trueは設定しないことを推奨する。詳細は<a href="#Ch05_FileAccess_HowToUse_VariableLength_Output_AboutShouldDeleteIfEmpty">後述</a>する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクション制御を行うかを設定する。詳細は、<a href="#Ch05_Transaction">トランザクション制御</a>を参照のこと。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.transform.DelimitedLineAggregator</code>を設定する。<br>
フィールドを囲み文字で囲む場合は、<code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code>を設定する。<br>
<code>EnclosableDelimitedLineAggregator</code>の使用方法は後述する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delimiter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">区切り文字を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">カンマ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldExtractor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列や数字など特別な変換処理が不要な場合は、<code>org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</code>が利用できる。<br>
変換処理が必要な場合は、<code>org.springframework.batch.item.file.transform.FieldExtractor</code>の実装クラスを設定する。<br>
<code>FieldExtractor</code>の実装例は<a href="#Ch05_FileAccess_HowToUse_FixedLength_Output">固定長レコードの出力</a>にて、全角文字のフォーマットを例に説明しているためそちらを参照すること。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1レコードの各項目に名前を付与する。 レコードの先頭から各名前をカンマ区切りで設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div id="Ch05_FileAccess_HowToUse_VariableLength_Output_AboutShouldDeleteIfEmpty" class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">FlatFileItemWriterのプロパティshouldDeleteIfEmptyにはtrueは設定しないことを推奨する</div>
<div class="paragraph">
<p>FlatFileItemWriterは、以下のような組み合わせでプロパティ設定を行った場合に意図しないファイル削除が行われてしまう。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>p:shouldDeleteIfEmpty="true"</code></p>
</li>
<li>
<p><code>p:shouldDeleteIfExists="false"</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>理由は以下の通りである。<br>
shouldDeleteIfEmptyにtrueを設定すると、出力件数が0件の場合に出力対象ファイルの削除が行われる。<br>
この「出力件数が0件の場合」には、shouldDeleteIfExistsにfalseを設定した状態で出力対象ファイルが既に存在していた場合も含まれる。</p>
</div>
<div class="paragraph">
<p>よって、上記の組み合わせでプロパティを指定すると既に出力対象ファイルが存在する場合に出力対象ファイルの削除が行われてしまう。<br>
これは、出力対象ファイルが既に存在する場合は例外をスローさせて処理を終了したい場合には意図しない動作である。</p>
</div>
<div class="paragraph">
<p>このような意図しない動作が行われるため、shouldDeleteIfEmptyにはtrueは設定しないことを推奨する。</p>
</div>
<div class="paragraph">
<p>また、出力件数が0件であった場合にファイル削除等の後処理を行う場合は、shouldDeleteIfEmptyではなくOSコマンドやListener等で実装すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">EnclosableDelimitedLineAggregatorの使用方法</div>
<p>フィールドを囲み文字で囲む場合は、TERASOLUNA Batch 5.xが提供する<code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code>を使用する。<br>
<code>EnclosableDelimitedLineAggregator</code>の仕様は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>囲み文字、区切り文字を任意に指定可能</p>
<div class="ulist">
<ul>
<li>
<p>デフォルトはCSV形式で一般的に使用される以下の値である</p>
<div class="ulist">
<ul>
<li>
<p>囲み文字：<code>"</code>(ダブルクォート)</p>
</li>
<li>
<p>区切り文字：<code>,</code>(カンマ)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>フィールドに行頭復帰、改行、囲み文字、区切り文字が含まれている場合、囲み文字でフィールドを囲む</p>
<div class="ulist">
<ul>
<li>
<p>囲み文字が含まれている場合、直前に囲み文字を付与しエスケープする</p>
</li>
<li>
<p>設定によってすべてのフィールドを囲み文字で囲むことが可能</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>EnclosableDelimitedLineAggregator</code>の使用方法を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">&quot;001&quot;,&quot;CustomerName&quot;&quot;001&quot;&quot;&quot;,&quot;CustomerAddress,001&quot;,&quot;11111111111&quot;,&quot;001&quot;
&quot;002&quot;,&quot;CustomerName&quot;&quot;002&quot;&quot;&quot;,&quot;CustomerAddress,002&quot;,&quot;11111111111&quot;,&quot;002&quot;
&quot;003&quot;,&quot;CustomerName&quot;&quot;003&quot;&quot;&quot;,&quot;CustomerAddress,003&quot;,&quot;11111111111&quot;,&quot;003&quot;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// 上記の例と同様</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義例(lineAggregatorの設定のみ)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
  <span class="comment">&lt;!-- (2) (3) (4) --&gt;</span>
  <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">p:enclosure</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span>
        <span class="attribute-name">p:allEnclosing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delimiter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">区切り文字を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">カンマ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">enclosure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">囲み文字を設定する。<br>
囲み文字がフィールドに含まれる場合は、エスケープ処理として囲み文字を2つ連結されたものへ置換される。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ダブルクォート</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allEnclosing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、すべてのフィールドが囲み文字で囲まれる。<br>
falseの場合フィールド内に行頭復帰(CR)、改行(LF)、区切り文字、囲み文字が含まれるフィールドのみ囲み文字で囲まれる。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">EnclosableDelimitedLineAggregatorの提供について</div>
<div class="paragraph">
<p>TERASOLUNA Batch 5.xでは、RFC-4180の仕様を満たすことを目的として拡張クラス<code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code>を提供している。</p>
</div>
<div class="paragraph">
<p>Spring Batchが提供している<code>org.springframework.batch.item.file.transform.DelimitedLineAggregator</code>はフィールドを囲み文字で囲む処理に対応しておらず、RFC-4180の仕様を満たすことができないためである。
<a href="https://jira.spring.io/browse/BATCH-2463">Spring Batch/BATCH-2463</a> を参照のこと。</p>
</div>
<div class="paragraph">
<p>CSV形式のフォーマットについて、CSV形式の一般的書式とされるRFC-4180では下記のように定義されている。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>フィールドに改行、囲み文字、区切り文字が含まれていない場合、各フィールドはダブルクォート(囲み文字)で囲んでも囲わなくてもよい</p>
</li>
<li>
<p>改行(CRLF)、ダブルクォート(囲み文字)、カンマ(区切り文字)を含むフィールドは、ダブルクォートで囲むべきである</p>
</li>
<li>
<p>フィールドがダブルクォート(囲み文字)で囲まれている場合、フィールドの値に含まれるダブルクォートは、その直前に1つダブルクォートを付加して、エスケープしなければならない</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">TSV形式ファイルの出力方法</div>
<div class="paragraph">
<p>TSVファイルの出力を行う場合には、区切り文字にタブを設定することで実現可能である。</p>
</div>
<div class="listingblock">
<div class="title">TSVファイル出力時の区切り文字設定例(定数による設定)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;util:constant</span>
            <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer.DELIMITER_TAB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>または、以下のようにしてもよい。</p>
</div>
<div class="listingblock">
<div class="title">TSVファイル出力時の区切り文字設定例(文字参照による設定)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#09;</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToUse_FixedLength"><a class="anchor" href="#Ch05_FileAccess_HowToUse_FixedLength"></a>5.3.2.2. 固定長レコード</h5>
<div class="paragraph">
<p>固定長レコードファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToUse_FixedLength_Input"><a class="anchor" href="#Ch05_FileAccess_HowToUse_FixedLength_Input"></a>5.3.2.2.1. 入力</h6>
<div class="paragraph">
<p>下記の入力ファイルを読み込むための設定例を示す。</p>
</div>
<div class="paragraph">
<p>Macchinetta Batch 2.xでは、レコードの区切りを改行で判断する形式とバイト数で判断する形式
に対応している。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例1(レコードの区切りは改行)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">売上012016 1   00000011000000000
売上022017 2   00000022000000000
売上032018 3   00000033000000000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">入力ファイル例2(レコードの区切りはバイト数、32バイトで1レコード)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">売上012016 1   00000011000000000売上022017 2   00000022000000000売上032018 3   00000033000000000</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">入力ファイル仕様</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 35%;">
<col style="width: 35%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">フィールド名</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">バイト数</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">year</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">customerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bufferedReaderFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.DefaultBufferedReaderFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (6) --&gt;</span>
                <span class="comment">&lt;!-- (7) --&gt;</span>
                <span class="comment">&lt;!-- (8) --&gt;</span>
                <span class="comment">&lt;!-- (9) --&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.transform.FixedByteLengthLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">c:ranges</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1-6, 7-10, 11-12, 13-22, 23-32</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">c:charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (10) --&gt;</span>
              <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルの文字コードを設定する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Spring Batchが提供するコンポーネントの文字コードのデフォルト値はItemReaderとItemWriterで異なっている(ItemWriterのデフォルト値は「UTF-8」)。<br>
そのため、デフォルト値の値を使用する場合においても明示的に文字コードを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVMのデフォルト文字セット</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueを設定すると、入力ファイルが存在しない(開けない)場合に例外が発生する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bufferedReaderFactory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコードの区切りを改行で判断する場合は、デフォルト値である<code>org.springframework.batch.item.file.DefaultBufferedReaderFactory</code>を使用する。
<code>DefaultBufferedReaderFactory</code>が生成する<code>BufferedReader</code>は改行までを1レコードとして取得する。</p>
<p class="tableblock">レコードの区切りをバイト数で判断する場合は、TERASOLUNA Batch 5.xが提供する<code>org.terasoluna.batch.item.file.FixedByteLengthBufferedReaderFactory</code>を設定する。
<code>FixedByteLengthBufferedReaderFactory</code>が生成する<code>BufferedReader</code>は指定したバイト数までを1レコードとして取得する。<br>
<code>FixedByteLengthBufferedReaderFactory</code>の詳しい仕様および使用方法は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DefaultBufferedReaderFactory</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.mapping.DefaultLineMapper</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineTokenizer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TERASOLUNA Batch 5.xが提供する<code>org.terasoluna.batch.item.file.transform.FixedByteLengthLineTokenizer</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1レコードの各項目に名前を付与する。<br>
<code>FieldSetMapper</code>で使われる<code>FieldSet</code>で設定した名前を用いて各項目を取り出すことができるようになる。<br>
レコードの先頭から各名前をカンマ区切りで設定する。<br>
<code>BeanWrapperFieldSetMapper</code>を利用する場合は、必須設定である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ranges<br>
(コンストラクタ引数)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">区切り位置を設定する。レコードの先頭から区切り位置をカンマ区切りで設定する。<br>
各区切り位置の単位はバイトであり、<code>開始位置-終了位置</code>形式で指定する。<br>
区切り位置を設定した順番でレコードから指定された範囲を取得し、<code>FieldSet</code>に格納される。<br>
(6)のnamesを指定した場合は区切り位置を設定した順番でnamesと対応付けて<code>FieldSet</code>に格納される。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">charset<br>
(コンストラクタ引数)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)で指定した文字コードと同じ値を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldSetMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列や数字など特別な変換処理が不要な場合は、<code>org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</code>を利用し、
プロパティ<code>targetType</code>に変換対象クラスを指定する。
これにより、(6)で設定した各項目の名前と一致するフィールドに値を自動的に設定したインスタンスを生成する。<br>
変換処理が必要な場合は、<code>org.springframework.batch.item.file.mapping.FieldSetMapper</code>の実装クラスを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">FieldSetMapperの独自実装について</div>
<div class="paragraph">
<p>FieldSetMapperを独自に実装する場合については、<a href="#Ch05_FileAccess_HowToExtend">How To Extend</a>を参照すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">FixedByteLengthBufferedReaderFactoryの使用方法</div>
<p>レコードの区切りをバイト数で判断するファイルを読み込む場合は、TERASOLUNA Batch 5.xが提供する<code>org.terasoluna.batch.item.file.FixedByteLengthBufferedReaderFactory</code>を使用する。</p>
</div>
<div class="paragraph">
<p><code>FixedByteLengthBufferedReaderFactory</code>を使用することで指定したバイト数までを1レコードとして取得することができる。<br>
<code>FixedByteLengthBufferedReaderFactory</code>の仕様は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>コンストラクタ引数としてレコードのバイト数を指定する</p>
</li>
<li>
<p>指定されたバイト数を1レコードとしてファイルを読み込む<code>FixedByteLengthBufferedReader</code>を生成する</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>FixedByteLengthBufferedReader</code>の使用は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>インスタンス生成時に指定されたバイト長を1レコードとしてファイルを読み込む</p>
</li>
<li>
<p>改行コードが存在する場合、破棄せず1レコードのバイト長に含めて読み込みを行う</p>
</li>
<li>
<p>読み込み時に使用するファイルエンコーディングは<code>FlatFileItemWriter</code>に設定したものが<code>BufferedReader</code>生成時に設定される</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>FixedByteLengthBufferedReaderFactory</code>の定義方法を以下に示す。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bufferedReaderFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.FixedByteLengthBufferedReaderFactory</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">c:byteLength</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">32</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>

<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">byteLength<br>
(コンストラクタ引数)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1レコードあたりのバイト数を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">固定長ファイルを扱う場合に使用するコンポーネント</div>
<div class="paragraph">
<p>固定長ファイルを扱う場合は、Macchinetta Batch 2.xが提供するコンポーネントを使うことを前提にしている。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">FixedByteLengthBufferedReaderFactory</dt>
<dd>
<p>改行なし固定長ファイルから、指定した文字コードのバイト数で1レコードを読み込む<code>BufferedReader</code>生成クラス</p>
</dd>
<dt class="hdlist1">FixedByteLengthLineTokenizer</dt>
<dd>
<p>マルチバイト文字列に対応したバイト数区切りの<code>FixedLengthTokenizer</code>拡張クラス</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">マルチバイト文字列を含むレコードを処理する場合</div>
<div class="paragraph">
<p>マルチバイト文字列を含むレコードを処理する場合は、<code>FixedByteLengthLineTokenizer</code>を必ず利用する。<br>
Spring Batchが提供する<code>FixedLengthTokenizer</code>は、レコードをバイト数ではなく文字数で区切ってしまうため、期待どおりの項目切り出しが行われない恐れがある。
この点についてはJIRAの <a href="https://jira.spring.io/browse/BATCH-2540">Spring Batch/BATCH-2540</a> で報告しているため、今後不要になる可能性がある。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
FieldSetMapperの実装については、<a href="#Ch05_FileAccess_HowToExtend">How To Extend</a>を参照すること。
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToUse_FixedLength_Output"><a class="anchor" href="#Ch05_FileAccess_HowToUse_FixedLength_Output"></a>5.3.2.2.2. 出力</h6>
<div class="paragraph">
<p>下記の出力ファイルを書き出すための設定例を示す。</p>
</div>
<div class="paragraph">
<p>固定長ファイルを書き出すためには、Beanから取得した値をフィールドのバイト数にあわせてフォーマットを行う必要がある。<br>
フォーマットの実行方法は全角文字が含まれるか否かによって下記のように異なる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>全角文字が含まれない場合(半角文字のみであり文字のバイト数が一定)</p>
<div class="ulist">
<ul>
<li>
<p><code>FormatterLineAggregator</code>にてフォーマットを行う。</p>
</li>
<li>
<p>フォーマットは、<code>String.format</code>メソッドで使用する書式で設定する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>全角文字が含まれる場合(文字コードによって文字のバイト数が一定ではない)</p>
<div class="ulist">
<ul>
<li>
<p><code>FieldExtractor</code>の実装クラスにてフォーマットを行う。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>まず、出力ファイルに全角文字が含まれない場合の設定例を示し、その後全角文字が含まれる場合の設定例を示す。</p>
</div>
<div class="paragraph">
<p>出力ファイルに全角文字が含まれない場合の設定について下記に示す。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">   0012016 10000000001  10000000
   0022017 20000000002  20000000
   0032018 30000000003  30000000</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">出力ファイル仕様</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 35%;">
<col style="width: 35%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">フィールド名</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">バイト数</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">year</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">customerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>フィールドのバイト数に満たない部分は半角スペース埋めとしている。</p>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のファイルを書き出すための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.FormatterLineAggregator</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:format</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">%6s%4s%2s%10s%10s</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (9) --&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (10) --&gt;</span>
              <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (11) --&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルの文字コードを設定する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Spring Batchが提供するコンポーネントの文字コードのデフォルト値はItemReaderとItemWriterで異なっている(ItemReaderのデフォルト値は「JavaVMのデフォルト文字セット」)。<br>
そのため、デフォルト値の値を使用する場合においても明示的に文字コードを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区切り(改行コード)を設定する。<br>
改行なしにする場合は、空文字を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">システムプロパティの<code>line.separator</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appendAllowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、既存のファイルに追記をする。<br>
<span class="icon"><i class="fa fa-warning"></i></span> trueの場合、shouldDeleteIfExistsの設定値は無効化されるため、注意が必要である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> appendAllowedがtrueの場合は、このプロパティは無効化されるため、プロパティを指定しないことを推奨する。<br>
trueの場合、既にファイルが存在すれば削除する。<br>
falseの場合、既にファイルが存在すれば例外をスローする。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、出力件数が0件であれば出力対象ファイルを削除する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> 他のプロパティとの組み合わせによって意図しない動作をする場合があるため、trueは設定しないことを推奨する。詳細は<a href="#Ch05_FileAccess_HowToUse_VariableLength_Output_AboutShouldDeleteIfEmpty">可変長レコードの出力の注意書き</a>を参照すること。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクション制御を行うかを設定する。詳細は、<a href="#Ch05_Transaction">トランザクション制御</a>を参照</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.transform.FormatterLineAggregator</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String.format</code>メソッドで使用する書式で出力フォーマットを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldExtractor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列や数字など特別な変換処理、全角文字のフォーマットが不要な場合は、<code>org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</code>が利用できる。</p>
<p class="tableblock">値の変換処理や全角文字をフォーマットする等の対応が必要な場合は、<code>org.springframework.batch.item.file.transform.FieldExtractor</code>の実装クラスを設定する。<br>
全角文字をフォーマットする場合における<code>FieldExtractor</code>の実装例は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PassThroughFieldExtractor</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1レコードの各項目に名前を付与する。 レコードの先頭から各フィールドの名前をカンマ区切りで設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">PassThroughFieldExtractorとは</div>
<div class="paragraph">
<p><code>FormatterLineAggregator</code>がもつプロパティ<code>fieldExtractor</code>のデフォルト値は<code>org.springframework.batch.item.file.transform.PassThroughFieldExtractor</code>である。</p>
</div>
<div class="paragraph">
<p><code>PassThroughFieldExtractor</code>は、元のアイテムに対して処理を行わずに返すクラスであり、<code>FieldExtractor</code>にて何も処理を行わない場合に使用する。</p>
</div>
<div class="paragraph">
<p>アイテムが配列またはコレクションの場合はそのまま返されるが、それ以外の場合は、単一要素の配列にラップされる。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">全角文字が含まれるフィールドに対してフォーマットを行う際の設定例</div>
<p>全角文字に対するフォーマットを行う場合、文字コードにより1文字あたりのバイト数が異なるため、<code>FormatterLineAggregator</code>ではなく、<code>FieldExtractor</code>の実装クラスを使用する。</p>
</div>
<div class="paragraph">
<p><code>FieldExtractor</code>の実装クラスは以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FieldExtractor</code>クラスを実装し、<code>extract</code>メソッドをオーバーライドする</p>
</li>
<li>
<p><code>extract</code>メソッドは以下の要領で実装する</p>
<div class="ulist">
<ul>
<li>
<p>item(処理対象のBean)から値を取得し、適宜変換処理等を行う</p>
</li>
<li>
<p>Object型の配列に格納し返す</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>FieldExtractor</code>の実装クラスで行う全角文字を含むフィールドのフォーマットは以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>文字コードに対するバイト数を取得する</p>
</li>
<li>
<p>取得したバイト数を元にパディング・トリム処理で整形する</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以下に全角文字を含むフィールドをフォーマットする場合の設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">   0012016 10000000001  10000000
  番号2017 2 売上高002  20000000
 番号32018 3   売上003  30000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力ファイルの使用は上記の例と同様。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義(lineAggregatorの設定のみ)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.FormatterLineAggregator</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:format</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">%s%4s%2s%s%10s</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.plan.SalesPlanFixedLengthFieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.transform.FormatterLineAggregator</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String.format</code>メソッドで使用する書式で出力フォーマットを設定する。<br>
全角文字が含まれないフィールドに対してのみ桁数の指定をしている。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldExtractor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FieldExtractor</code>の実装クラスを設定する。<br>
実装例は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PassThroughFieldExtractor</code></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">全角文字をフォーマットするFieldExtractorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanFixedLengthFieldExtractor</span> <span class="directive">implements</span> FieldExtractor&lt;SalesPlanDetail&gt; {
    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Object</span><span class="type">[]</span> extract(SalesPlanDetail item) {
        <span class="predefined-type">Object</span><span class="type">[]</span> values = <span class="keyword">new</span> <span class="predefined-type">Object</span>[<span class="integer">5</span>];  <span class="comment">// (2)</span>

        <span class="comment">// (3)</span>
        values[<span class="integer">0</span>] = fillUpSpace(item.getBranchId(), <span class="integer">6</span>);  <span class="comment">// (4)</span>
        values[<span class="integer">1</span>] = item.getYear();
        values[<span class="integer">2</span>] = item.getMonth();
        values[<span class="integer">3</span>] = fillUpSpace(item.getCustomerId(), <span class="integer">10</span>);  <span class="comment">// (4)</span>
        values[<span class="integer">4</span>] = item.getAmount();

        <span class="keyword">return</span> values; <span class="comment">// (8)</span>
    }

    <span class="comment">// It is a simple impl for example</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> fillUpSpace(<span class="predefined-type">String</span> val, <span class="type">int</span> num) {
        <span class="predefined-type">String</span> charsetName = <span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>;
        <span class="type">int</span> len;
        <span class="keyword">try</span> {
            len = val.getBytes(charsetName).length;  <span class="comment">// (5)</span>
        } <span class="keyword">catch</span> (<span class="exception">UnsupportedEncodingException</span> e) {
            <span class="comment">// omitted exception handling</span>
        }

        <span class="comment">// (6)</span>
        <span class="keyword">if</span> (len &gt; num) {
            <span class="keyword">throw</span> <span class="keyword">new</span> IncorrectFieldLengthException(<span class="string"><span class="delimiter">&quot;</span><span class="content">The length of field is invalid. </span><span class="delimiter">&quot;</span></span> + <span class="string"><span class="delimiter">&quot;</span><span class="content">[value:</span><span class="delimiter">&quot;</span></span> + val + <span class="string"><span class="delimiter">&quot;</span><span class="content">][length:</span><span class="delimiter">&quot;</span></span>
                    + len + <span class="string"><span class="delimiter">&quot;</span><span class="content">][expect length:</span><span class="delimiter">&quot;</span></span> + num + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>);
        }

        <span class="keyword">if</span> (num == len) {
            <span class="keyword">return</span> val;
        }

        <span class="predefined-type">StringBuilder</span> filledVal = <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>();
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; (num - len); i++) {  <span class="comment">// (7)</span>
            filledVal.append(<span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span>);
        }
        filledVal.append(val);

        <span class="keyword">return</span> filledVal.toString();
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FieldExtractor</code>クラスを実装し、<code>extract</code>メソッドをオーバーライドする。<br>
<code>FieldExtractor</code>の型引数には変換対象クラスを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">変換処理等を行ったデータを格納するためのObject型配列を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受けたitem(処理対象のBean)から値を取得し、適宜変換処理を行い、Object型の配列に格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">全角文字が含まれるフィールドに対してフォーマット処理を行う。<br>
フォーマット処理の詳細は(5)、(6)を参照すること。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字コードに対するバイト数を取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">取得したバイト数が最大長を超えている場合は、例外をスローする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">取得したバイト数を元にパディング・トリム処理で整形する。<br>
実装例では指定されたバイト数まで文字列の前に空白を付与している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理結果を保持しているObject型の配列を返す。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToUse_SingleRecord"><a class="anchor" href="#Ch05_FileAccess_HowToUse_SingleRecord"></a>5.3.2.3. 単一文字列レコード</h5>
<div class="paragraph">
<p>単一文字列レコードファイルを扱う場合の定義方法を説明する</p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToUse_SingleRecord_Input"><a class="anchor" href="#Ch05_FileAccess_HowToUse_SingleRecord_Input"></a>5.3.2.3.1. 入力</h6>
<div class="paragraph">
<p>下記の入力ファイルを読み込むための設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Summary1:4,000,000,000
Summary2:5,000,000,000
Summary3:6,000,000,000</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.PassThroughLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルの文字コードを設定する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Spring Batchが提供するコンポーネントの文字コードのデフォルト値はItemReaderとItemWriterで異なっている(ItemWriterのデフォルト値は「UTF-8」)。<br>
そのため、デフォルト値の値を使用する場合においても明示的に文字コードを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVMのデフォルト文字セット</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueを設定すると、入力ファイルが存在しない(開けない)場合に例外が発生する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.mapping.PassThroughLineMapper</code>を設定する。<br>
<code>PassThroughLineMapper</code>は渡されたレコードをそのまま文字列として返す<code>LineMapper</code>の実装クラスである。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToUse_SingleRecord_Output"><a class="anchor" href="#Ch05_FileAccess_HowToUse_SingleRecord_Output"></a>5.3.2.3.2. 出力</h6>
<div class="paragraph">
<p>下記の出力ファイルを書き出すための設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Summary1:4,000,000,000
Summary2:5,000,000,000
Summary3:6,000,000,000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.PassThroughLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルの文字コードを設定する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Spring Batchが提供するコンポーネントの文字コードのデフォルト値はItemReaderとItemWriterで異なっている(ItemReaderのデフォルト値は「JavaVMのデフォルト文字セット」)。<br>
そのため、デフォルト値の値を使用する場合においても明示的に文字コードを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区切り(改行コード)を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">システムプロパティの<code>line.separator</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appendAllowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、既存のファイルに追記をする。<br>
<span class="icon"><i class="fa fa-warning"></i></span> trueの場合、shouldDeleteIfExistsの設定値は無効化されるため、注意が必要である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> appendAllowedがtrueの場合は、このプロパティは無効化されるため、プロパティを指定しないことを推奨する。<br>
trueの場合、既にファイルが存在すれば削除する。<br>
falseの場合、既にファイルが存在すれば例外をスローする。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、出力件数が0件であれば出力対象ファイルを削除する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> 他のプロパティとの組み合わせによって意図しない動作をする場合があるため、trueは設定しないことを推奨する。詳細は<a href="#Ch05_FileAccess_HowToUse_VariableLength_Output_AboutShouldDeleteIfEmpty">可変長レコードの出力の注意書き</a>を参照すること。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクション制御を行うかを設定する。詳細は、<a href="#Ch05_Transaction">トランザクション制御</a>を参照。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.transform.PassThroughLineAggregator</code>を設定する。<br>
<code>PassThroughLineAggregator</code>はitem(処理対象のBean)をそのまま文字列へ変換(<code>item.toString()</code>を実行)する<code>LineAggregator</code>の実装クラスである。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToUse_HeaderFooter"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter"></a>5.3.2.4. ヘッダとフッタ</h5>
<div class="paragraph">
<p>ヘッダ・フッタがある場合の入出力方法を説明する。</p>
</div>
<div class="paragraph">
<p>ここでは行数指定にてヘッダ・フッタを読み飛ばす方法を説明する。<br>
ヘッダ・フッタのレコード数が可変であり行数指定ができない場合は、<a href="#Ch05_FileAccess_HowToExtend_MultiFormat_Input">マルチフォーマットの入力</a>を参考に<code>PatternMatchingCompositeLineMapper</code>を使用すること。</p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToUse_HeaderFooter_Input"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input"></a>5.3.2.4.1. 入力</h6>
<div class="sect6">
<h7 id="Ch05_FileAccess_HowToUse_HeaderFooter_Input_SkipHeaders"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_SkipHeaders"></a>ヘッダの読み飛ばし</h7>
<div class="paragraph">
<p>ヘッダレコードを読み飛ばす方法には以下に示す2パターンがある。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FlatFileItemReader</code>の<code>linesToSkip</code>にファイルの先頭から読み飛ばす行数を設定</p>
</li>
<li>
<p>OSコマンドによる前処理でヘッダレコードを取り除く</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">sales_plan_detail_11
branchId,year,month,customerId,amount
000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>先頭から2行がヘッダレコードである。</p>
</div>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">linesToSkipによる読み飛ばし</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:linesToSkip</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">linesToSkip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">読み飛ばすヘッダ行数を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">OSコマンドによる読み飛ばし処理</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Remove number of lines in header from the top of input file
tail -n +`expr 2 + 1` input.txt &gt; output.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>tailコマンドを利用し、入力ファイルinput.txtの3行目以降を取得し、output.txtに出力している。
tailコマンドのオプション<code>-n +K</code>に指定する値はヘッダレコードの数+1となるため注意すること。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">ヘッダレコードとフッタレコードを読み飛ばすOSコマンド</div>
<div class="paragraph">
<p>headコマンドとtailコマンドをうまく活用することでヘッダレコードとフッタレコードを行数指定をして読み飛ばすことが可能である。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ヘッダレコードの読み飛ばし方</dt>
<dd>
<p>tailコマンドをオプション<code>-n +K</code>を付与して実行することで、処理対象の<code>K</code>行目以降を取得する。</p>
</dd>
<dt class="hdlist1">フッタレコードの読み飛ばし方</dt>
<dd>
<p>headコマンドをオプション<code>-n -K</code>を付与して実行することで、処理対象の末尾から<code>K</code>行目より前を取得する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>ヘッダレコードとフッタレコードをそれぞれ読み飛ばすシェルスクリプト例を下記に示す。<br></p>
</div>
<div class="listingblock">
<div class="title">ヘッダ/フッタから指定行数を取り除くシェルスクリプトの例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">#!/bin/bash

if [ $# -ne 4 ]; then
  echo &quot;The number of arguments must be 4, given is $#.&quot; 1&gt;&amp;2
  exit 1
fi

# Input file.
input=$1

# Output file.
output=$2

# Number of lines in header.
header=$3

# Number of lines in footer.
footer=$4

# Remove number of lines in header from the top of input file
# and number of lines in footer from the end,
# and save to output file.
tail -n +`expr ${header} + 1` ${input} | head -n -${footer} &gt; ${output}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">引数</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイル</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイル</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">読み飛ばすヘッダの行数</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">読み飛ばすフッタの行数</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders"></a>ヘッダ情報の取り出し</h7>
<div class="paragraph">
<p>ヘッダレコードを認識し、ヘッダレコードの情報を取り出す方法を示す。</p>
</div>
<div class="paragraph">
<p>ヘッダ情報の取り出しは以下の要領で実装する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">設定</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.item.file.LineCallbackHandler</code>の実装クラスにヘッダに対する処理を実装する</p>
<div class="ulist">
<ul>
<li>
<p><code>LineCallbackHandler#handleLine()</code>内で取得したヘッダ情報を<code>stepExecutionContext</code>に格納する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>FlatFileItemReader</code>の<code>skippedLinesCallback</code>に<code>LineCallbackHandler</code>の実装クラスを設定する</p>
</li>
<li>
<p><code>FlatFileItemReader</code>の<code>linesToSkip</code>にヘッダの行数を指定する</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">ファイル読み込みおよびヘッダ情報の取り出し</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>linesToSkip</code>の設定によってスキップされるヘッダレコード1行ごとに<code>LineCallbackHandler#handleLine()</code>が呼び出される</p>
<div class="ulist">
<ul>
<li>
<p>ヘッダ情報が<code>stepExecutionContext</code>に格納される</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">取得したヘッダ情報を利用する</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>ヘッダ情報を<code>stepExecutionContext</code>から取得してデータ部の処理で利用する</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>ヘッダレコードの情報を取り出す際の実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.module.HoldHeaderLineCallbackHandler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:linesToSkip</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:skippedLinesCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingHeaderRecordItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">linesToSkip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">読み飛ばすヘッダ行数を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">skippedLinesCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LineCallbackHandler</code>の実装クラスを設定する。<br>
実装例は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">listener</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecutionListener</code>の実装クラスを設定する。<br>
<code>FlatFileItemReader</code>の<code>skippedLinesCallback</code>に指定する<code>LineCallbackHandler</code>は自動で<code>Listener</code>として登録されないため設定が必須となる。<br>
詳しい理由は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">リスナー設定について</div>
<div class="paragraph">
<p>下記の2つの場合は自動で<code>Listener</code>として登録されないため、ジョブ定義時に<code>Listeners</code>にも定義を追加する必要がある。<br>
(リスナの定義を追加しないと、<code>StepExecutionListener#beforeStep()</code>が実行されない)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FlatFileItemReader</code>の<code>skippedLinesCallback</code>に指定する<code>LineCallbackHandler</code>の<code>StepExecutionListener</code></p>
</li>
<li>
<p><code>Tasklet</code>の実装クラスに実装する<code>StepExecutionListener</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingHeaderRecordItemProcessor</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;batch:listeners&gt;</span>
                    <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingItemReaderListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="comment">&lt;!-- mandatory --&gt;</span>
                    <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/batch:listeners&gt;</span>
            <span class="tag">&lt;/batch:tasklet&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>LineCallbackHandler</code>は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>StepExecutionListener#beforeStep()</code>の実装</p>
<div class="ulist">
<ul>
<li>
<p>下記のいずれかの方法で<code>StepExecutionListener#beforeStep()</code>を実装する</p>
<div class="ulist">
<ul>
<li>
<p><code>StepExecutionListener</code>クラスを実装し、<code>beforeStep</code>メソッドをオーバーライドする</p>
</li>
<li>
<p>beforeStepメソッドを実装し、<code>@BeforeStep</code>アノテーションを付与する</p>
</li>
</ul>
</div>
</li>
<li>
<p>beforeStepメソッドにて<code>StepExecution</code>を取得してクラスフィールドに保持する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>LineCallbackHandler#handleLine()</code>の実装</p>
<div class="ulist">
<ul>
<li>
<p><code>LineCallbackHandler</code>クラスを実装し、<code>handleLine</code>メソッドをオーバーライドする</p>
<div class="ulist">
<ul>
<li>
<p><code>handleLine</code>メソッドはスキップする1行ごとに1回呼ばれる点に注意すること。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>StepExecution</code>から<code>stepExecutionContext</code>を取得し、<code>stepExecutionContext</code>にヘッダ情報を格納する。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">LineCallbackHandlerの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HoldHeaderLineCallbackHandler</span> <span class="directive">implements</span> LineCallbackHandler {  <span class="comment">// (1)</span>
    <span class="directive">private</span> StepExecution stepExecution;  <span class="comment">// (2)</span>

    <span class="annotation">@BeforeStep</span>  <span class="comment">// (3)</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="local-variable">this</span>.stepExecution = stepExecution;  <span class="comment">// (4)</span>
    }

    <span class="annotation">@Override</span>  <span class="comment">// (5)</span>
    <span class="directive">public</span> <span class="type">void</span> handleLine(<span class="predefined-type">String</span> line) {
        <span class="local-variable">this</span>.stepExecution.getExecutionContext().putString(<span class="string"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>, line);  <span class="comment">// (6)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LineCallbackHandler</code>クラスを実装し、<code>handleLine</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code>を保持するためのフィールドを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>beforeStep</code>メソッドを実装し、<code>@BeforeStep</code>アノテーションを付与する。<br>
シグネチャは<code>void beforeStep(StepExecution stepExecution)</code>とする。<br>
<code>StepExecutionListener</code>クラスを実装し、<code>beforeStep</code>メソッドをオーバーライドする方法でもよい。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code>を取得してクラスフィールドに保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LineCallbackHandler</code>クラスを実装し、<code>handleLine</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code>から<code>stepExecutionContext</code>を取得し、<code>header</code>というキーを指定して<code>stepExecutionContext</code>にヘッダ情報を格納する。<br>
ここでは簡単のため、スキップする2行のうち、最後の1行だけを格納している。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>ヘッダ情報を<code>stepExecutionContext</code>から取得してデータ部の処理で利用する例を示す。<br>
<code>ItemProcessor</code>にてヘッダ情報を利用する場合を例にあげて説明する。<br>
他のコンポーネントでヘッダ情報を利用する際も同じ要領で実現することができる。</p>
</div>
<div class="paragraph">
<p>ヘッダ情報を利用する処理は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>LineCallbackHandler</code>の実装例と同様に<code>StepExecutionListener#beforeStep()</code>を実装する</p>
</li>
<li>
<p><code>beforeStep</code>メソッドにて<code>StepExecution</code>を取得してクラスフィールドに保持する</p>
</li>
<li>
<p><code>StepExecution</code>から<code>stepExecutionContext</code>およびヘッダ情報を取得して利用する</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">ヘッダ情報の利用例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">LoggingHeaderRecordItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetail, SalesPlanDetail&gt; {
    <span class="directive">private</span> StepExecution stepExecution;  <span class="comment">// (1)</span>

    <span class="annotation">@BeforeStep</span>  <span class="comment">// (2)</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="local-variable">this</span>.stepExecution = stepExecution;  <span class="comment">// (3)</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">String</span> headerData = <span class="local-variable">this</span>.stepExecution.getExecutionContext()
                .getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// (4)</span>
        <span class="comment">// omitted business logic</span>
        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code>を保持するためのフィールドを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>beforeStep</code>メソッドを実装し、<code>@BeforeStep</code>アノテーションを付与する。<br>
シグネチャは<code>void beforeStep(StepExecution stepExecution)</code>とする。<br>
<code>StepExecutionListener</code>クラスを実装し、<code>beforeStep</code>メソッドをオーバーライドする方法でもよい。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code>を取得してクラスフィールドに保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code>から<code>stepExecutionContext</code>を取得し、<code>header</code>というキーを指定して<code>stepExecutionContext</code>からヘッダ情報を取得する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Job/StepのExecutionContextの使用について</div>
<div class="paragraph">
<p>ヘッダ(フッタ)情報の取出しでは、読み込んだヘッダ情報を<code>StepExecution</code>の<code>ExecutionContext</code>に格納しておき、使用する際に<code>ExecutionContext</code>から取り出す方式をとる。</p>
</div>
<div class="paragraph">
<p>下記の例では1つのステップ内でヘッダ情報の取得および利用を行うため<code>StepExecution</code>の<code>ExecutionContext</code>へヘッダ情報を格納している。
ヘッダ情報の取得および利用にてステップが分かれる場合は<code>JobExecution</code>の<code>ExecutionContext</code>を利用すること。</p>
</div>
<div class="paragraph">
<p>Job/Stepの<code>ExecutionContext</code>に関する詳細は、<a href="#Ch02_SpringBatchArch">Spring Batchのアーキテクチャ</a>を参照すること。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="Ch05_FileAccess_HowToUse_HeaderFooter_Input_SkipFooters"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_SkipFooters"></a>フッタの読み飛ばし</h7>
<div class="paragraph">
<p>TERASOLUNA Batch 5.xおよびMacchinetta Batch 2.xでは、フッタレコードの読み飛ばし機能は提供していないため、OSコマンドで対応する。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000
number of items,3
total of amounts,6000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>末尾から2行がフッタレコードである。</p>
</div>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">OSコマンドによる読み飛ばし処理</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Remove number of lines in footer from the end of input file
head -n -2 input.txt &gt; output.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>headコマンドを利用し、入力ファイルinput.txtの末尾から2行目より前を取得し、output.txtに出力している。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>フッタレコードを読み飛ばすことは、Spring Batchでは機能をもっていないため、JIRAの  <a href="https://jira.spring.io/browse/BATCH-2539">Spring Batch/BATCH-2539</a>  にて報告している。<br>
よって、今後OSコマンドによる読み飛ばしだけではなく、Spring Batchでも対応できるようになる可能性がある。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessFooters"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessFooters"></a>フッタ情報の取り出し</h7>
<div class="paragraph">
<p>TERASOLUNA Batch 5.xおよびMacchinetta Batch 2.xでは、フッタレコードの読み飛ばし機能、フッタ情報の取得機能は提供していない。</p>
</div>
<div class="paragraph">
<p>そのため、処理を下記ようにOSコマンドによる前処理と2つのステップに分割することで対応する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OSコマンドによってフッタレコードを分割する</p>
</li>
<li>
<p>1つめのステップにてフッタレコードを読み込み、フッタ情報を<code>ExecutionContext</code>に格納する</p>
</li>
<li>
<p>2つめのステップにて<code>ExecutionContext</code>からフッタ情報を取得し、利用する</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>フッタ情報を取り出しは以下の要領で実装する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">OSコマンドによるフッタレコードの分割</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>OSコマンドを利用して入力ファイルをフッタ部とフッタ部以外に分割する</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">1つめのステップでフッタレコードを読み込み、フッタ情報を取得する</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>フッタレコードを読み込み<code>jobExecutionContext</code>に格納する</p>
<div class="ulist">
<ul>
<li>
<p>フッタ情報の格納と利用にてステップが異なるため、<code>jobExecutionContext</code>に格納する。</p>
</li>
<li>
<p><code>jobExecutionContext</code>を利用する方法は、JobとStepのスコープに関する違い以外は、<a href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders">ヘッダ情報の取り出し</a>にて説明した<code>stepExecutionContext</code>と同様である。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">2つめのステップにて取得したフッタ情報を利用する</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>フッタ情報を<code>jobExecutionContext</code>から取得してデータ部の処理で利用する</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>以下に示すファイルのフッタ情報を取り出して利用する場合を例にあげて説明する。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000
number of items,3
total of amounts,6000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>末尾から2行がフッタレコードである。</p>
</div>
<div class="paragraph">
<div class="title">OSコマンドによるフッタレコードの分割</div>
<p>上記のファイルをOSコマンドを利用してフッタ部とフッタ部以外に分割する設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">OSコマンドによる読み飛ばし処理</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Extract non-footer record from input file and save to output file.
head -n -2 input.txt &gt; input_data.txt

# Extract footer record from input file and save to output file.
tail -n 2 input.txt &gt; input_footer.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>headコマンドを利用し、入力ファイルinput.txtのフッタ部以外をinput_data.txtへ、フッタ部をinput_footer.txtに出力している。</p>
</div>
<div class="paragraph">
<p>出力ファイル例は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例(input_data.txt)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">出力ファイル例(input_footer.txt)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">number of items,3
total of amounts,6000000000</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">フッタ情報の取得、利用</div>
<p>OSコマンドにて分割したフッタレコードからフッタ情報を取得、利用する方法を説明する。<br></p>
</div>
<div class="paragraph">
<p>フッタレコードを読み込むステップを前処理として主処理とステップを分割している。<br>
ステップの分割に関する詳細は、<a href="#Ch08_FlowControll">フロー制御</a>を参照すること。</p>
</div>
<div class="paragraph">
<p>下記の例ではフッタ情報を取得し、<code>jobExecutionContext</code>へフッタ情報を格納するまでの例を示す。<br>
<code>jobExecutionContext</code>からフッタ情報を取得し利用する方法は<a href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders">ヘッダ情報の取り出し</a>と同じ要領で実現可能である。</p>
</div>
<div class="listingblock">
<div class="title">データレコードの情報を保持するクラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">フッタレコードの情報を保持するクラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailFooter</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="comment">// omitted serialVersionUID</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="directive">private</span> <span class="predefined-type">String</span> value;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>下記の要領でBean定義を行う。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>フッタレコードを読み込む<code>ItemReader</code>を定義する</p>
</li>
<li>
<p>データレコードを読み込む<code>ItemReader</code>を定義する</p>
</li>
<li>
<p>フッタレコードを取得するビジネスロジックを定義する</p>
<div class="ulist">
<ul>
<li>
<p>下記の例では<code>Tasklet</code>の実装クラスで実現している</p>
</li>
</ul>
</div>
</li>
<li>
<p>ジョブを定義する</p>
<div class="ulist">
<ul>
<li>
<p>フッタ情報を取得する前処理ステップとデータレコードを読み込み主処理を行うステップを定義する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- ItemReader for reading footer records --&gt;</span>
<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footerReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['footerInputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted other settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- ItemReader for reading data records --&gt;</span>
<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['dataInputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted other settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="comment">&lt;!-- omitted settings --&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- Tasklet for reading footer records --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">readFooterTasklet</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.module.ReadFooterTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter.step01</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter.step02</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">readFooterTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="comment">&lt;!-- (4) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter.step02</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">readFooterTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">項目</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">footerReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フッタレコードを保持するファイルを読み込むための<code>ItemReader</code>を定義する。<br>
フッタ情報を取得するステップで実行される<code>readFooterTasklet</code>にてインジェクトして使用する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dataReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データレコードを保持するファイルを読み込むための<code>ItemReader</code>を定義する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">前処理ステップ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フッタ情報を取得するステップを定義する。<br>
処理は<code>readFooterTasklet</code>に実装している。実装例は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">主処理ステップ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データ情報を取得するとともにフッタ情報を利用するステップを定義する。<br>
<code>reader</code>には<code>dataReader</code>を使用する。<br>
例ではフッタ情報を<code>jobExecutionContext</code>から取得し利用する処理(<code>ItemProcessor</code>等)は実装していない。<br>
フッタ情報を取得し利用する方法は<a href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders">ヘッダ情報の取り出し</a>と同じ要領で実現可能である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">listeners</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>readFooterTasklet</code>を設定する。<br>
この設定を行わないと<code>readFooterTasklet</code>内に実装する<code>JobExecutionListener#beforeJob()</code>が実行されない。<br>
詳しい理由は、<a href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders">ヘッダ情報の取り出し</a>を参照すること。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>フッタレコードを保持するファイルを読み込み、<code>jobExecutionContext</code>に格納する処理を行う処理の例を示す。</p>
</div>
<div class="paragraph">
<p><code>Tasklet</code>の実装クラスとして実現する際の要領は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bean定義した<code>footerReader</code>を<code>@Inject</code>アノテーションと<code>@Named</code>アノテーションを使用し名前指定でインジェクトする。</p>
</li>
<li>
<p>読み込んだフッタ情報を<code>jobExecutionContext</code>に格納する</p>
<div class="ulist">
<ul>
<li>
<p>実現方法は<a href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders">ヘッダ情報の取り出し</a>と同様である</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">フッタ情報の取得</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ReadFooterTasklet</span> <span class="directive">implements</span> Tasklet {
    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">footerReader</span><span class="delimiter">&quot;</span></span>)
    ItemStreamReader&lt;SalesPlanDetailFooter&gt; itemReader;

    <span class="directive">private</span> JobExecution jobExecution;

    <span class="annotation">@BeforeJob</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="local-variable">this</span>.jobExecution = jobExecution;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">ArrayList</span>&lt;SalesPlanDetailFooter&gt; footers = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

        <span class="comment">// (2)</span>
        itemReader.open(chunkContext.getStepContext().getStepExecution()
                .getExecutionContext());

        SalesPlanDetailFooter footer;
        <span class="keyword">while</span> ((footer = itemReader.read()) != <span class="predefined-constant">null</span>) {
            footers.add(footer);
        }

        <span class="comment">// (3)</span>
        jobExecution.getExecutionContext().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">footers</span><span class="delimiter">&quot;</span></span>, footers);

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean定義した<code>footerReader</code>を<code>@Inject</code>アノテーションと<code>@Named</code>アノテーションを使用し名前指定でインジェクトする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>footerReader</code>を使用してフッタレコードを保持したファイルを読み込みフッタ情報を取得する。<br>
<code>Tasklet</code>の実装クラス内でBean定義した<code>ItemReader</code>を使用する方法は<a href="#Ch03_CreateTaskletJob_HowToUse_Impl">タスクレット指向ジョブの作成</a>を参照すること。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecution</code>から<code>jobExecutionContext</code>を取得し、<code>footers</code>というキーを指定して<code>jobExecutionContext</code>へフッタ情報を格納する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToUse_HeaderFooter_Output"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Output"></a>5.3.2.4.2. 出力</h6>
<div class="sect6">
<h7 id="Ch05_FileAccess_HowToUse_HeaderFooter_Output_Headers"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Output_Headers"></a>ヘッダ情報の出力</h7>
<div class="paragraph">
<p>フラットファイルでヘッダ情報を出力する際は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.item.file.FlatFileHeaderCallback</code>の実装を行う</p>
</li>
<li>
<p>実装した<code>FlatFileHeaderCallback</code>を<code>FlatFileItemWriter</code>の<code>headerCallback</code>に設定する</p>
<div class="ulist">
<ul>
<li>
<p><code>headerCallback</code>を設定すると<code>FlatFileItemWriter</code>の出力処理で、最初に<code>FlatFileHeaderCallback#writeHeader()</code>が実行される</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>FlatFileHeaderCallback</code>は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FlatFileHeaderCallback</code>クラスを実装し、<code>writeHeader</code>メソッドをオーバーライドする</p>
</li>
<li>
<p>引数で受ける<code>Writer</code>を用いてヘッダ情報を出力する。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記に<code>FlatFileHeaderCallback</code>クラスの実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">FlatFileHeaderCallbackの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WriteHeaderFlatFileFooterCallback</span> <span class="directive">implements</span> FlatFileHeaderCallback {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> writeHeader(<span class="predefined-type">Writer</span> writer) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="comment">// (2)</span>
        writer.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">omitted</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FlatFileHeaderCallback</code>クラスを実装し、<code>writeHeader</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受ける<code>Writer</code>を用いてヘッダ情報を出力する。<br>
<code>FlatFileHeaderCallback#writeHeader()</code>の実行直後に<code>FlatFileItemWriter</code>が出力する処理を実行する。<br>
そのため、ヘッダ情報末尾の改行は出力不要である。
出力される改行は、Bean定義時に<code>FlatFileItemWriter</code>に指定したものである。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:headerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeHeaderFlatFileFooterCallback</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">headerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FlatFileHeaderCallback</code>の実装クラスを設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区切り(改行コード)を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">システムプロパティの<code>line.separator</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">FlatFileHeaderCallback実装時にヘッダ情報末尾の改行は出力不要</div>
<div class="paragraph">
<p><code>FlatFileItemWriter</code>内で<code>FlatFileHeaderCallback#writeHeader()</code>の実行直後にBean定義時に指定した改行を出力する処理が実行されるため、ヘッダ情報末尾の改行は出力不要である。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="Ch05_FileAccess_HowToUse_HeaderFooter_Output_Footers"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Output_Footers"></a>フッタ情報の出力</h7>
<div class="paragraph">
<p>フラットファイルでフッタ情報を出力する際は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.item.file.FlatFileFooterCallback</code>の実装を行う</p>
</li>
<li>
<p>実装した<code>FlatFileFooterCallback</code>を<code>FlatFileItemWriter</code>の<code>footerCallback</code>に設定する</p>
<div class="ulist">
<ul>
<li>
<p><code>footerCallback</code>を設定すると<code>FlatFileItemWriter</code>の出力処理で、最後に<code>FlatFileFooterCallback#writeFooter()</code>が実行される</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>フラットファイルでフッタ情報を出力する方法について説明する。</p>
</div>
<div class="paragraph">
<p><code>FlatFileFooterCallback</code>は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>引数で受ける<code>Writer</code>を用いてフッタ情報を出力する。</p>
</li>
<li>
<p><code>FlatFileFooterCallback</code>クラスを実装し、<code>writeFooter</code>メソッドをオーバーライドする</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記にJobの<code>ExecutionContext</code>からフッタ情報を取得し、ファイルへ出力する<code>FlatFileFooterCallback</code>クラスの実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">フッタレコードの情報を保持するクラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailFooter</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="comment">// omitted serialVersionUID</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="directive">private</span> <span class="predefined-type">String</span> value;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">FlatFileFooterCallbackの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WriteFooterFlatFileFooterCallback</span> <span class="directive">implements</span> FlatFileFooterCallback {  <span class="comment">// (1)</span>
    <span class="directive">private</span> JobExecution jobExecution;

    <span class="annotation">@BeforeJob</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="local-variable">this</span>.jobExecution = jobExecution;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> writeFooter(<span class="predefined-type">Writer</span> writer) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
        <span class="predefined-type">ArrayList</span>&lt;SalesPlanDetailFooter&gt; footers = (<span class="predefined-type">ArrayList</span>&lt;SalesPlanDetailFooter&gt;) <span class="local-variable">this</span>.jobExecution.getExecutionContext().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">footers</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// (2)</span>

        <span class="predefined-type">BufferedWriter</span> bufferedWriter = <span class="keyword">new</span> <span class="predefined-type">BufferedWriter</span>(writer);  <span class="comment">// (3)</span>
        <span class="comment">// (4)</span>
        <span class="keyword">for</span> (SalesPlanDetailFooter footer : footers) {
            bufferedWriter.write(footer.getName() +<span class="string"><span class="delimiter">&quot;</span><span class="content"> is </span><span class="delimiter">&quot;</span></span> + footer.getValue());
            bufferedWriter.newLine();
            bufferedWriter.flush();
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FlatFileFooterCallback</code>クラスを実装し、<code>writeFooter</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jobの<code>ExecutionContext</code>から<code>footers</code>というkeyを指定してフッタ情報を取得する。<br>
例ではArrayListで複数のフッタ情報を取得している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例では改行の出力に<code>BufferedWriter.newLine()</code>を使用するため、引数で受ける<code>Writer</code>を引数として<code>BufferedWriter</code>を生成する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受ける<code>Writer</code>を用いてフッタ情報を出力する。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:footerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeFooterFlatFileFooterCallback</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">footerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FlatFileFooterCallback</code>の実装クラスを設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToUse_MultiFile"><a class="anchor" href="#Ch05_FileAccess_HowToUse_MultiFile"></a>5.3.2.5. 複数ファイル</h5>
<div class="paragraph">
<p>複数ファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToUse_MultiFile_Input"><a class="anchor" href="#Ch05_FileAccess_HowToUse_MultiFile_Input"></a>5.3.2.5.1. 入力</h6>
<div class="paragraph">
<p>同一レコード形式の複数ファイルを読み込む場合は、<code>org.springframework.batch.item.file.MultiResourceItemReader</code>を利用する。<br>
<code>MultiResourceItemReader</code>は指定された<code>ItemReader</code>を使用し正規表現で指定された複数のファイルを読み込むことができる。</p>
</div>
<div class="paragraph">
<p><code>MultiResourceItemReader</code>は以下の要領で定義する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>MultiResourceItemReader</code>のBeanを定義する</p>
<div class="ulist">
<ul>
<li>
<p>プロパティ<code>resources</code>に読み込み対象のファイルを指定する</p>
<div class="ulist">
<ul>
<li>
<p>正規表現で複数ファイルを指定する</p>
</li>
</ul>
</div>
</li>
<li>
<p>プロパティ<code>delegate</code>にファイル読み込みに利用する<code>ItemReader</code>を指定する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記に示す複数のファイルを読み込む<code>MultiResourceItemReader</code>の定義例は以下のとおりである。</p>
</div>
<div class="listingblock">
<div class="title">読み込み対象ファイル(ファイル名)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">sales_plan_detail_01.csv
sales_plan_detail_02.csv
sales_plan_detail_03.csv</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multiResourceReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.MultiResourceItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resources</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:input/sales_plan_detail_*.csv</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:delegate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">正規表現で複数の入力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">実際にファイルを読み込み処理する<code>ItemReader</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">実際にファイルを読み込み処理する<code>ItemReader</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロパティ<code>resource</code>は、<code>MultiResourceItemReader</code>から自動的に設定されるため、Bean定義に設定は不要である。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">MultiResourceItemReaderが使用するItemReaderにresourceの指定は不要である</div>
<div class="paragraph">
<p><code>MultiResourceItemReader</code>から委譲される<code>ItemReader</code>の<code>resource</code>は、<code>MultiResourceItemReader</code>から自動的に設定されるため、Bean定義に設定は不要である。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToUse_MultiFile_Output"><a class="anchor" href="#Ch05_FileAccess_HowToUse_MultiFile_Output"></a>5.3.2.5.2. 出力</h6>
<div class="paragraph">
<p>複数ファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="paragraph">
<p>一定の件数ごとに異なるファイルへ出力する場合は、<code>org.springframework.batch.item.file.MultiResourceItemWriter</code>を利用する。</p>
</div>
<div class="paragraph">
<p><code>MultiResourceItemWriter</code>は指定された<code>ItemWriter</code>を使用して指定した件数ごとに複数ファイルへ出力することができる。<br>
出力対象のファイル名は重複しないように一意にする必要があるが、そのための仕組みとして<code>ResourceSuffixCreator</code>が提供されている。<br>
<code>ResourceSuffixCreator</code>はファイル名が一意となるようなサフィックスを生成するクラスである。<br></p>
</div>
<div class="paragraph">
<p>たとえば、出力対象ファイルを<code>outputDir/customer_list_01.csv</code>(<code>01</code>の部分は連番)というファイル名にしたい場合は下記のように設定する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>MultiResourceItemWriter</code>に<code>outputDir/customer_list_</code>と設定する</p>
</li>
<li>
<p>サフィックス<code>01.csv</code>(<code>01</code>の部分は連番)を生成する処理を<code>ResourceSuffixCreator</code>に実装する</p>
<div class="ulist">
<ul>
<li>
<p>連番は<code>MultiResourceItemWriter</code>から自動で増分されて渡される値を使用することができる</p>
</li>
</ul>
</div>
</li>
<li>
<p>実施に使用される<code>ItemWriter</code>には<code>outputDir/customer_list_01.csv</code>が設定される</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>MultiResourceItemWriter</code>は以下の要領で定義する。<code>ResourceSuffixCreator</code>の実装方法は後述する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ResourceSuffixCreator</code>の実装クラスを定義する</p>
</li>
<li>
<p><code>MultiResourceItemWriter</code>のBeanを定義する</p>
<div class="ulist">
<ul>
<li>
<p>プロパティ<code>resources</code>に出力対象のファイルを指定する</p>
<div class="ulist">
<ul>
<li>
<p><code>ResourceSuffixCreator</code>の実装クラスで付与するサフィックスまでを設定</p>
</li>
</ul>
</div>
</li>
<li>
<p>プロパティ<code>resourceSuffixCreator</code>にサフィックスを生成する<code>ResourceSuffixCreator</code>の実装クラスを指定する</p>
</li>
<li>
<p>プロパティ<code>delegate</code>にファイル読み込みに利用する<code>ItemWriter</code>を指定する</p>
</li>
<li>
<p>プロパティ<code>itemCountLimitPerResource</code>に1ファイルあたりの出力件数を指定する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multiResourceItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.MultiResourceItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputDir']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resourceSuffixCreator-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerListResourceSuffixCreator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:delegate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:itemCountLimitPerResource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerListResourceSuffixCreator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.module.CustomerListResourceSuffixCreator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (6) --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力対象ファイルのサフィックスを付与する前の状態を設定する。<br>
<code>ItemWriter</code>には、<code>MultiResourceItemWriter</code>が自動でサフィックスを付与したものが設定される。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resourceSuffixCreator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResourceSuffixCreator</code>の実装クラスを設定する。<br>
デフォルト値は<code>"." + index</code>というサフィックスを生成する<code>org.springframework.batch.item.file.SimpleResourceSuffixCreator</code>である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SimpleResourceSuffixCreator</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">実際にファイルを読み込み処理する<code>ItemWriter</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">itemCountLimitPerResource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1ファイルあたりの出力件数を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Integer.MAX_VALUE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">実際にファイルを読み込み処理する<code>ItemWriter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロパティ<code>resource</code>は、<code>MultiResourceItemWriter</code>から自動的に設定されるため、Bean定義に設定は不要である。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResourceSuffixCreator</code>の実装クラス</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">サフィックスを生成する<code>ResourceSuffixCreator</code>の実装クラスを定義する。<br>
実装方法は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">MultiResourceItemWriterが使用するItemWriterにresourceの指定は不要である</div>
<div class="paragraph">
<p><code>MultiResourceItemWriter</code>から委譲される<code>ItemWriter</code>の<code>resource</code>は、<code>MultiResourceItemWriter</code>から自動的に設定されるため、Bean定義に設定は不要である。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>ResourceSuffixCreator</code>は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ResourceSuffixCreator</code>クラスを実装し、<code>getSuffix</code>メソッドをオーバーライドする</p>
</li>
<li>
<p>引数で受ける<code>index</code>を用いてサフィックスを生成して返り値として返す</p>
<div class="ulist">
<ul>
<li>
<p><code>index</code>は初期値<code>1</code>で始まり出力対象ファイルごとにインクリメントされる<code>int</code>型の値である</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">ResourceSuffixCreatorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerListResourceSuffixCreator</span> <span class="directive">implements</span> ResourceSuffixCreator {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getSuffix(<span class="type">int</span> index) {
        <span class="keyword">return</span> <span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">%02d</span><span class="delimiter">&quot;</span></span>, index) + <span class="string"><span class="delimiter">&quot;</span><span class="content">.csv</span><span class="delimiter">&quot;</span></span>;  <span class="comment">// (2)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResourceSuffixCreator</code>クラスを実装し、<code>getSuffix</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受ける<code>index</code>を用いてサフィックスを生成して返り値として返す。
<code>index</code>は初期値<code>1</code>で始まり出力対象ファイルごとにインクリメントされる<code>int</code>型の値である。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToUse_ControlBreak"><a class="anchor" href="#Ch05_FileAccess_HowToUse_ControlBreak"></a>5.3.2.6. コントロールブレイク</h5>
<div class="paragraph">
<p>コントロールブレイクの実現方法について説明する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">コントロールブレイクとは</dt>
<dd>
<p>コントロールブレイク処理(またはキーブレイク処理)とは、ソート済みのレコードを順次読み込み、
レコード内にある特定の項目(キー項目)が同じレコードを1つのグループとして処理する手法のことを指す。<br>
主にデータを集計するときに用いられ、
キー項目が同じ値の間は集計を続け、キー項目が異なる値になる際に集計値を出力する、
というアルゴリズムになる。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>コントロールブレイク処理をするためには、グループの変わり目を判定するために、レコードを先読みする必要がある。
<code>org.springframework.batch.item.support.SingleItemPeekableItemReader</code>を使うことで先読みを実現できる。<br>
また、コントロールブレイクはタスクレットモデルでのみ処理可能とする。
これは、チャンクが前提とする「1行で定義するデータ構造をN行処理する」や「一定件数ごとのトランザクション境界」といった点が、
コントロールブレイクの「グループの変わり目で処理をする」という点と合わないためである。</p>
</div>
<div class="paragraph">
<p>コントロールブレイク処理の実行タイミングと比較条件を以下に示す。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>対象レコード処理前にコントロールブレイク実施</p>
<div class="ulist">
<ul>
<li>
<p>前回読み取ったレコードを保持し、前回レコードと現在読み込んだレコードとの比較</p>
</li>
</ul>
</div>
</li>
<li>
<p>対象レコード処理後にコントロールブレイク実施</p>
<div class="ulist">
<ul>
<li>
<p><code>SingleItemPeekableItemReader</code>により次のレコードを先読みし、次レコードと現在読み込んだレコードとの比較</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記にの入力データから処理結果を出力するコントロールブレイクの実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">入力データ</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">01,2016,10,1000
01,2016,11,1500
01,2016,12,1300
02,2016,12,900
02,2016,12,1200</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">処理結果</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">Header Branch Id : 01,,,
01,2016,10,1000
01,2016,11,1500
01,2016,12,1300
Summary Branch Id : 01,,,3800
Header Branch Id : 02,,,
02,2016,12,900
02,2016,12,1200
Summary Branch Id : 02,,,2100</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">コントロールブレイクの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ControlBreakTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="annotation">@Inject</span>
    SingleItemPeekableItemReader&lt;SalesPerformanceDetail&gt; reader; <span class="comment">// (1)</span>

    <span class="annotation">@Inject</span>
    ItemStreamWriter&lt;SalesPerformanceDetail&gt; writer;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// omitted.</span>

        SalesPerformanceDetail previousData = <span class="predefined-constant">null</span>;   <span class="comment">// (2)</span>
        <span class="predefined-type">BigDecimal</span> summary = <span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">0</span>);  <span class="comment">//(3)</span>

        <span class="predefined-type">List</span>&lt;SalesPerformanceDetail&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();   <span class="comment">// (4)</span>

        <span class="keyword">try</span> {
            reader.open(executionContext);
            writer.open(executionContext);

            <span class="keyword">while</span> (reader.peek() != <span class="predefined-constant">null</span>) {   <span class="comment">// (5)</span>
                SalesPerformanceDetail data = reader.read(); <span class="comment">// (6)</span>

                <span class="comment">// (7)</span>
                <span class="keyword">if</span> (isBreakByBranchId(previousData, data)) {
                    SalesPerformanceDetail beforeBreakData =
                            <span class="keyword">new</span> SalesPerformanceDetail();
                    beforeBreakData.setBranchId(<span class="string"><span class="delimiter">&quot;</span><span class="content">Header Branch Id : </span><span class="delimiter">&quot;</span></span>
                              + currentData.getBranchId());
                    items.add(beforeBreakData);
                }

                <span class="comment">// omitted.</span>
                items.add(data);  <span class="comment">// (8)</span>

                SalesPerformanceDetail nextData = reader.peek();  <span class="comment">// (9)</span>
                summary = summary.add(data.getAmount());

                <span class="comment">// (10)</span>
                SalesPerformanceDetail afterBreakData = <span class="predefined-constant">null</span>;
                <span class="keyword">if</span> (isBreakByBranchId(nextData, data)) {
                    afterBreakData = <span class="keyword">new</span> SalesPerformanceDetail();
                    afterBreakData.setBranchId(<span class="string"><span class="delimiter">&quot;</span><span class="content">Summary Branch Id : </span><span class="delimiter">&quot;</span></span>
                            + currentData.getBranchId());
                    afterBreakData.setAmount(summary);
                    items.add(afterBreakData);
                    summary = <span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">0</span>);
                    writer.write(items);  <span class="comment">// (11)</span>
                    items.clear();
                }
                previousData = data;  <span class="comment">// (12)</span>
            }
        } <span class="keyword">finally</span> {
            <span class="keyword">try</span> {
                reader.close();
            } <span class="keyword">catch</span> (ItemStreamException e) {
            }
            <span class="keyword">try</span> {
                writer.close();
            } <span class="keyword">catch</span> (ItemStreamException e) {
            }
        }
        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
    <span class="comment">// (13)</span>
    <span class="directive">private</span> <span class="type">boolean</span> isBreakByBranchId(SalesPerformanceDetail o1,
            SalesPerformanceDetail o2) {
        <span class="keyword">return</span> (o1 == <span class="predefined-constant">null</span> || !o1.getBranchId().equals(o2.getBranchId()));
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SingleItemPeekableItemReader</code>をInjectする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">前回読み取ったレコードを保持する変数を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">グループごとの集計値を格納する変数を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コントロールブレイクの処理結果を含めたグループ単位のレコードを格納する変数を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力データが無くなるまで処理を繰り返す。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理対象のレコードを読み込む。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">対象レコード処理前にコントロールブレイクを実施する。<br>
ここではグループの先頭であれば見出しを設定して、(4)で定義した変数に格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">対象レコードへの処理結果を(4)で定義した変数に格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">次のレコードを先読みする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">対象レコード処理後にコントロールブレイクを実施する。
ここではグループの末尾であれば集計データをトレーラに設定して、(4)で定義した変数に格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">グループ単位で処理結果を出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理レコードを(2)で定義した変数に格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(13)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">キー項目が切り替わったか判定する。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.SingleItemPeekableItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:delegate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegateReader</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>

<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegateReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.performance.SalesPerformanceDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SingleItemPeekableItemReader</code>をBean定義する。TaskletへのInject対象。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delegate</code>プロパティに実際にファイルを読み込むItemReaderのBeanを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">実際にファイルを読み込むItemReaderのBeanを定義する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToExtend"><a class="anchor" href="#Ch05_FileAccess_HowToExtend"></a>5.3.3. How To Extend</h4>
<div class="paragraph">
<p>ここでは、以下のケースについて説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_FieldSetMapper">FieldSetMapperの実装</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_HowToExtend_Xml">XMLファイル</a>の入出力</p>
</li>
<li>
<p><a href="#Ch05_FileAccess_HowToExtend_MultiFormat">マルチフォーマット</a>の入出力</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_FieldSetMapper"><a class="anchor" href="#Ch05_FileAccess_FieldSetMapper"></a>5.3.3.1. FieldSetMapperの実装</h5>
<div class="paragraph">
<p><code>FieldSetMapper</code>を自作で実装する方法について説明する。</p>
</div>
<div class="paragraph">
<p><code>FieldSetMapper</code>の実装クラスは下記の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FieldSetMapper</code>クラスを実装し、<code>mapFieldSet</code>メソッドをオーバーライドする</p>
</li>
<li>
<p>引数で受けた<code>FieldSet</code>から値を取得し、適宜変換処理を行い、変換対象のBeanに格納し返り値として返す</p>
<div class="ulist">
<ul>
<li>
<p><code>FieldSet</code>クラスはJDBCにある<code>ResultSet</code>クラスのようにインデックスまたは名前と関連付けてデータを保持するクラスである</p>
</li>
<li>
<p><code>FieldSet</code>クラスは<code>LineTokenizer</code>によって分割されたレコードの各フィールドの値を保持する</p>
</li>
<li>
<p>インデックスまたは名前を指定して値を格納および取得することができる</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記のような和暦フォーマットのDate型やカンマを含むBigDecimal型の変換を行うファイルを読み込む場合の実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">&quot;000001&quot;,&quot;平成28年1月1日&quot;,&quot;000000001&quot;,&quot;1,000,000,000&quot;
&quot;000002&quot;,&quot;平成29年2月2日&quot;,&quot;000000002&quot;,&quot;2,000,000,000&quot;
&quot;000003&quot;,&quot;平成30年3月3日&quot;,&quot;000000003&quot;,&quot;3,000,000,000&quot;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">入力ファイル仕様</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 35%;">
<col style="width: 35%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">フィールド名</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日付</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">和暦フォーマット</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">customerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">カンマを含む</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">UseDateSalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="predefined-type">Date</span> date;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">FieldSetMapperの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UseDateSalesPlanDetailFieldSetMapper</span> <span class="directive">implements</span> FieldSetMapper&lt;UseDateSalesPlanDetail&gt; {  <span class="comment">// (1)</span>
    <span class="comment">/**
     * {@inheritDoc}
     *
     * @param fieldSet {@inheritDoc}
     * @return Sales performance detail.
     * @throws BindException {@inheritDoc}
     */</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> UseDateSalesPlanDetail mapFieldSet(FieldSet fieldSet) <span class="directive">throws</span> <span class="exception">BindException</span> {
        UseDateSalesPlanDetail item = <span class="keyword">new</span> UseDateSalesPlanDetail();  <span class="comment">// (2)</span>

        item.setBranchId(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId</span><span class="delimiter">&quot;</span></span>));  <span class="comment">// (3)</span>

        <span class="comment">// (4)</span>
        <span class="predefined-type">DateFormat</span> japaneseFormat = <span class="keyword">new</span> <span class="predefined-type">SimpleDateFormat</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">GGGGy年M月d日</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Locale</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">ja</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JP</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JP</span><span class="delimiter">&quot;</span></span>));
        <span class="keyword">try</span> {
            item.setDate(japaneseFormat.parse(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>)));
        } <span class="keyword">catch</span> (<span class="exception">ParseException</span> e) {
            <span class="comment">// omitted exception handling</span>
        }

        <span class="comment">// (5)</span>
        item.setCustomerId(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId</span><span class="delimiter">&quot;</span></span>));

        <span class="comment">// (6)</span>
        <span class="predefined-type">DecimalFormat</span> decimalFormat = <span class="keyword">new</span> <span class="predefined-type">DecimalFormat</span>();
        decimalFormat.setParseBigDecimal(<span class="predefined-constant">true</span>);
        <span class="keyword">try</span> {
            item.setAmount((<span class="predefined-type">BigDecimal</span>) decimalFormat.parse(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">amount</span><span class="delimiter">&quot;</span></span>)));
        } <span class="keyword">catch</span> (<span class="exception">ParseException</span> e) {
            <span class="comment">// omitted exception handling</span>
        }

        <span class="keyword">return</span> item;  <span class="comment">// (7)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FieldSetMapper</code>クラスを実装し、<code>mapFieldSet</code>メソッドをオーバーライドする。
<code>FieldSetMapper</code>の型引数には変換対象クラスを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">変換処理等を行ったデータを格納するために変換対象クラスの変数を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受けた<code>FieldSet</code>から<code>branchId</code>を取得し、変換対象クラスの変数へ格納する。<br>
<code>branchId</code>は変換処理が不要であるため、変換処理等は行っていない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受けた<code>FieldSet</code>から<code>date</code>を取得し、変換対象クラスの変数へ格納する。<br>
和暦フォーマットの日付をDate型へ変換するため、<code>SimpleDateFormat</code>でフォーマットを指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受けた<code>FieldSet</code>から<code>customerId</code>を取得し、変換対象クラスの変数へ格納する。<br>
<code>customerId</code>は変換処理が不要であるため、変換処理等は行っていない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受けた<code>FieldSet</code>から<code>amount</code>を取得し、変換対象クラスの変数へ格納する。<br>
カンマを含む値をBigDecimal型へ変換するため、<code>DecimalFormat</code>を使用している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理結果を保持している変換対象クラスを返す。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">FieldSetクラスからの値取得</div>
<div class="paragraph">
<p><code>FieldSet</code>クラスは、下記のような格納された値を取得するための様々なデータ型に対応したメソッドをもつ。<br>
また、<code>FieldSet</code>生成時にフィールドの名前と関連付けられてデータを格納した場合は、名前指定でのデータ取得、名前を指定しない場合ではインデックスを指定してのデータ取得が可能である。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>readString()</code></p>
</li>
<li>
<p><code>readInt()</code></p>
</li>
<li>
<p><code>readBigDecimal()</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>など</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToExtend_Xml"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_Xml"></a>5.3.3.2. XMLファイル</h5>
<div class="paragraph">
<p>XMLファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="paragraph">
<p>BeanとXML間の変換処理(O/X (Object/XML) マッピング)にはSpring Frameworkが提供するライブラリを使用する。<br>
XMLファイルとオブジェクト間の変換処理を行うライブラリとして、XStreamやJAXBなどを利用した<code>Marshaller</code>および<code>Unmarshaller</code>を実装クラスが提供されている。<br>
状況に応じて適しているものを使用すること。</p>
</div>
<div class="paragraph">
<p>JAXBとXStreamを例に特徴と採用する際のポイントを説明する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">JAXB</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>変換対象のBeanはBean定義にて指定する</p>
</li>
<li>
<p>スキーマファイルを用いたバリデーションを行うことができる</p>
</li>
<li>
<p>対外的にスキーマを定義しており、入力ファイルの仕様が厳密に決まっている場合に有用である</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">XStream</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Bean定義にて柔軟にXMLの要素とBeanのフィールドをマッピングすることができる</p>
</li>
<li>
<p>柔軟にBeanマッピングする必要がある場合に有用である</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>ここでは、JAXBを利用する例を示す。</p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToExtend_Xml_Input"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_Xml_Input"></a>5.3.3.2.1. 入力</h6>
<div class="paragraph">
<p>XMLファイルの入力にはSpring Batchが提供する<code>org.springframework.batch.item.xml.StaxEventItemReader</code>を使用する。<br>
<code>StaxEventItemReader</code>は指定した<code>Unmarshaller</code>を使用してXMLファイルをBeanにマッピングすることでXMLファイルを読み込むことができる。</p>
</div>
<div class="paragraph">
<p><code>StaxEventItemReader</code>は以下の要領で定義する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>XMLのルートエレメントとなる変換対象クラスに<code>@XmlRootElement</code>を付与する</p>
</li>
<li>
<p><code>StaxEventItemReader</code>に以下のプロパティを設定する</p>
<div class="ulist">
<ul>
<li>
<p>プロパティ<code>resource</code>に読み込み対象ファイルを設定する</p>
</li>
<li>
<p>プロパティ<code>fragmentRootElementName</code>にルートエレメントとなる要素の名前を設定する</p>
</li>
<li>
<p>プロパティ<code>unmarshaller</code>に<code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>を設定する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>Jaxb2Marshaller</code>には以下のプロパティを設定する</p>
<div class="ulist">
<ul>
<li>
<p>プロパティ<code>classesToBeBound</code>に変換対象のクラスをリスト形式で設定する</p>
</li>
<li>
<p>スキーマファイルを用いたバリデーションを行う場合は、以下に示す2つのプロパティを設定する</p>
<div class="ulist">
<ul>
<li>
<p>プロパティ<code>schema</code>にバリデーションにて使用するスキーマファイルを設定する</p>
</li>
<li>
<p>プロパティ<code>validationEventHandler</code>にバリデーションにて発生したイベントを処理する<code>ValidationEventHandler</code>の実装クラスを設定する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記の入力ファイルを読み込むための設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;records&gt;</span>
    <span class="tag">&lt;SalesPlanDetail&gt;</span>
        <span class="tag">&lt;branchId&gt;</span>000001<span class="tag">&lt;/branchId&gt;</span>
        <span class="tag">&lt;year&gt;</span>2016<span class="tag">&lt;/year&gt;</span>
        <span class="tag">&lt;month&gt;</span>1<span class="tag">&lt;/month&gt;</span>
        <span class="tag">&lt;customerId&gt;</span>0000000001<span class="tag">&lt;/customerId&gt;</span>
        <span class="tag">&lt;amount&gt;</span>1000000000<span class="tag">&lt;/amount&gt;</span>
    <span class="tag">&lt;/SalesPlanDetail&gt;</span>
    <span class="tag">&lt;SalesPlanDetail&gt;</span>
        <span class="tag">&lt;branchId&gt;</span>000002<span class="tag">&lt;/branchId&gt;</span>
        <span class="tag">&lt;year&gt;</span>2017<span class="tag">&lt;/year&gt;</span>
        <span class="tag">&lt;month&gt;</span>2<span class="tag">&lt;/month&gt;</span>
        <span class="tag">&lt;customerId&gt;</span>0000000002<span class="tag">&lt;/customerId&gt;</span>
        <span class="tag">&lt;amount&gt;</span>2000000000<span class="tag">&lt;/amount&gt;</span>
    <span class="tag">&lt;/SalesPlanDetail&gt;</span>
    <span class="tag">&lt;SalesPlanDetail&gt;</span>
        <span class="tag">&lt;branchId&gt;</span>000003<span class="tag">&lt;/branchId&gt;</span>
        <span class="tag">&lt;year&gt;</span>2018<span class="tag">&lt;/year&gt;</span>
        <span class="tag">&lt;month&gt;</span>3<span class="tag">&lt;/month&gt;</span>
        <span class="tag">&lt;customerId&gt;</span>0000000003<span class="tag">&lt;/customerId&gt;</span>
        <span class="tag">&lt;amount&gt;</span>3000000000<span class="tag">&lt;/amount&gt;</span>
    <span class="tag">&lt;/SalesPlanDetail&gt;</span>
<span class="tag">&lt;/records&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@XmlRootElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">SalesPlanDetail</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailToJaxb</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XML のルートタグとするため、<code>@XmlRootElement</code>アノテーションを付与する。<br>
タグの名前に<code>SalesPlanDetail</code>を設定する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:fragmentRootElementName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SalesPlanDetail</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unmarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="comment">&lt;!-- (5) (6) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jaxb.Jaxb2Marshaller</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:schema</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:files/test/input/ch05/fileaccess/SalesPlanDetail.xsd</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:validationEventHandler-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesPlanDetailValidationEventHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classesToBeBound</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (7) --&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="tag">&lt;value&gt;</span>jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailToJaxb<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fragmentRootElementName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ルートエレメントとなる要素の名前を設定する。<br>
対象となるオブジェクトが複数ある場合には、<code>fragmentRootElementNames</code>を利用する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueを設定すると、入力ファイルが存在しない(開けない)場合に例外が発生する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unmarshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">アンマーシャラを設定する。<br>
JAXBを利用する場合は、<code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>のBeanを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">schema</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バリデーションにて使用するスキーマファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">validationEventHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バリデーションにて発生したイベントを処理する<code>ValidationEventHandler</code>の実装クラスを設定する。<br>
<code>ValidationEventHandler</code>の実装例は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">classesToBeBound</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">変換対象のクラスをリスト形式で設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">ValidationEventHandlerの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailValidationEventHandler</span> <span class="directive">implements</span> ValidationEventHandler {
    <span class="comment">/**
     * Logger.
     */</span>
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(SalesPlanDetailValidationEventHandler.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> handleEvent(ValidationEvent event) {
        <span class="comment">// (2)</span>
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">[EVENT [SEVERITY:{}] [MESSAGE:{}] [LINKED EXCEPTION:{}]</span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content"> [LOCATOR: [LINE NUMBER:{}] [COLUMN NUMBER:{}] [OFFSET:{}]</span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content"> [OBJECT:{}] [NODE:{}] [URL:{}] ] ]</span><span class="delimiter">&quot;</span></span>,
                event.getSeverity(),
                event.getMessage(),
                event.getLinkedException(),
                event.getLocator().getLineNumber(),
                event.getLocator().getColumnNumber(),
                event.getLocator().getOffset(),
                event.getLocator().getObject(),
                event.getLocator().getNode(),
                event.getLocator().getURL());
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;  <span class="comment">// (3)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ValidationEventHandler</code>クラスを実装し、<code>handleEvent</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受けたevent(<code>ValidationEvent</code>)からイベントの情報を取得し、適宜処理を行う。<br>
例ではイベントの情報をログ出力している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検証処理を終了させるためfalseを返す。
検証処理を続行する場合はtrueを返す。<br>
適切な<code>UnmarshalException</code>、<code>ValidationException</code>、または<code>MarshalException</code>を生成して現在の操作を終了させる場合はfalseを返す。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">依存ライブラリの追加</div>
<div class="paragraph">
<p><code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>など、
Spring Frameworkが提供するライブラリであるSpring Object/XML Marshallingを使用する場合は、
ライブラリの依存関係に以下の設定を追加する必要がある。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-oxm<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToExtend_Xml_Output"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_Xml_Output"></a>5.3.3.2.2. 出力</h6>
<div class="paragraph">
<p>XMLファイルの出力にはSpring Batchが提供する<code>org.springframework.batch.item.xml.StaxEventItemWriter</code>を使用する。<br>
<code>StaxEventItemWriter</code>は指定した<code>Marshaller</code>を使用してBeanをXMLにマッピングすることでXMLファイルを出力することができる。</p>
</div>
<div class="paragraph">
<p><code>StaxEventItemWriter</code>は以下の要領で定義する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>変換対象クラスに以下の設定を行う</p>
<div class="ulist">
<ul>
<li>
<p>XMLのルートエレメントとなるためクラスに<code>@XmlRootElement</code>を付与する</p>
</li>
<li>
<p><code>@XmlType</code>アノテーションを使用してフィールドを出力する順番を設定する</p>
</li>
<li>
<p>XMLへの変換対象外とするフィールドがある場合、対象フィールドのgetterに<code>@XmlTransient</code>アノテーションを付与する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>StaxEventItemWriter</code>に以下のプロパティを設定する</p>
<div class="ulist">
<ul>
<li>
<p>プロパティ<code>resource</code>に出力対象ファイルを設定する</p>
</li>
<li>
<p>プロパティ<code>marshaller</code>に<code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>を設定する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>Jaxb2Marshaller</code>には以下のプロパティを設定する</p>
<div class="ulist">
<ul>
<li>
<p>プロパティ<code>classesToBeBound</code>に変換対象のクラスをリスト形式で設定する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記の出力ファイルを書き出すための設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;records&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>001<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName001<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress001<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>001<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>002<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName002<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress002<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>002<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>003<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName003<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress003<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>003<span class="tag">&lt;/chargeBranchId&gt;</span>
  <span class="tag">&lt;/Customer&gt;</span>
<span class="tag">&lt;/records&gt;</span></code></pre>
</div>
</div>
<div id="Ch05_FileAccess_HowToExtend_Xml_Output_format" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">XMLファイル出力時のフォーマット処理(改行およびインデント)について</div>
<div class="paragraph">
<p>上記の出力ファイル例ではフォーマット処理(改行およびインデント)済みのXMLを例示しているが、実際にはフォーマットされていないファイルが出力される。</p>
</div>
<div class="paragraph">
<p><code>Jaxb2Marshaller</code>にはXML出力時にフォーマットを行う機能があるが期待どおり動作しない。<br>
この件に関してはSpring Forumにて議論されているため、今後期待どおり動作するようになる可能性がある。</p>
</div>
<div class="paragraph">
<p>これを回避し、フォーマット済みの出力を行うためには、以下のように<code>marshallerProperties</code>に設定すればよい。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jaxb.Jaxb2Marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classesToBeBound</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- omitted settings --&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshallerProperties</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;map&gt;</span>
                <span class="tag">&lt;entry&gt;</span>
                    <span class="tag">&lt;key&gt;</span>
                        <span class="tag">&lt;util:constant</span>
                            <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.xml.bind.Marshaller.JAXB_FORMATTED_OUTPUT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;/key&gt;</span>
                    <span class="tag">&lt;value</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Boolean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/entry&gt;</span>
            <span class="tag">&lt;/map&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@XmlRootElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="annotation">@XmlType</span>(propOrder={<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">customerName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">customerAddress</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">customerTel</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">chargeBranchId</span><span class="delimiter">&quot;</span></span>})  <span class="comment">// (2)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerToJaxb</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerName;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerAddress;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerTel;
    <span class="directive">private</span> <span class="predefined-type">String</span> chargeBranchId;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> createDate;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> updateDate;

    <span class="comment">// omitted getter/setter</span>

    <span class="annotation">@XmlTransient</span>  <span class="comment">// (3)</span>
    <span class="directive">public</span> <span class="predefined-type">Timestamp</span> getCreateDate() { <span class="keyword">return</span> createDate; }

    <span class="annotation">@XmlTransient</span>  <span class="comment">// (3)</span>
    <span class="directive">public</span> <span class="predefined-type">Timestamp</span> getUpdateDate() { <span class="keyword">return</span> updateDate; }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XML のルートタグとするため、<code>@XmlRootElement</code>アノテーションを付与する。<br>
タグの名前に<code>Customer</code>を設定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@XmlType</code>アノテーションを使用してフィールドを出力する順番を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XMLへの変換対象外とするフィールドのgetterに<code>@XmlTransient</code>アノテーションを付与する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>上記のファイルを書き出すための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:rootTagName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">records</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:overwriteOutput</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (7) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jaxb.Jaxb2Marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classesToBeBound</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="tag">&lt;value&gt;</span>jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.model.mst.CustomerToJaxb<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルを設定する</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルの文字コードを設定する<br>
<span class="icon"><i class="fa fa-warning"></i></span> Spring Batchが提供するコンポーネントの文字コードのデフォルト値はItemReaderとItemWriterで異なっている(ItemReaderのデフォルト値は「JavaVMのデフォルト文字セット」)。<br>
そのため、デフォルト値の値を使用する場合においても明示的に文字コードを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rootTagName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XMLのルートタグを設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">overwriteOutput</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、既にファイルが存在すれば削除する。<br>
falseの場合、既にファイルが存在すれば例外をスローする。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、出力件数が0件であれば出力対象ファイルを削除する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> 他のプロパティとの組み合わせによって意図しない動作をする場合があるため、trueは設定しないことを推奨する。詳細は<a href="#Ch05_FileAccess_HowToUse_VariableLength_Output_AboutShouldDeleteIfEmpty">可変長レコードの出力の注意書き</a>を参照すること。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクション制御を行うかを設定する。詳細は、<a href="#Ch05_Transaction">トランザクション制御</a>を参照。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">marshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">マーシャラを設定する。
JAXBを利用する場合は、<code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">classesToBeBound</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">変換対象のクラスをリスト形式で設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">依存ライブラリの追加</div>
<div class="paragraph">
<p><code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>など、
Spring Frameworkが提供するライブラリであるSpring Object/XML Marshallingを使用する場合は、
ライブラリの依存関係に以下の設定を追加する必要がある。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-oxm<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect6">
<h7 id="Ch05_FileAccess_HowToExtend_Xml_HeaderFooter"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_Xml_HeaderFooter"></a>ヘッダ・フッタの出力</h7>
<div class="paragraph">
<p>ヘッダとフッタの出力には、<code>org.springframework.batch.item.xml.StaxWriterCallback</code>の実装クラスを使用する。</p>
</div>
<div class="paragraph">
<p>ヘッダの出力は、<code>headerCallback</code>、フッタの出力は、<code>footerCallback</code>に<code>StaxWriterCallback</code>の実装を設定する。</p>
</div>
<div class="paragraph">
<p>以下に出力されるファイルの例を示す。<br>
ヘッダはルートエレメント開始タグの直後、フッタはルートエレメント終了タグの直前に出力される。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;records&gt;</span>
<span class="comment">&lt;!-- Customer list header --&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>001<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName001<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress001<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>001<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>002<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName002<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress002<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>002<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>003<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName003<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress003<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>003<span class="tag">&lt;/chargeBranchId&gt;</span>
  <span class="tag">&lt;/Customer&gt;</span>
<span class="comment">&lt;!-- Customer list footer --&gt;</span>
<span class="tag">&lt;/records&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">XMLファイル出力時のフォーマット処理(改行およびインデント)について</div>
<div class="paragraph">
<p>上記の出力ファイル例ではフォーマット処理(改行およびインデント)済みのXMLを例示しているが、実際にはフォーマットされていないファイルが出力される。</p>
</div>
<div class="paragraph">
<p>詳細は、<a href="#Ch05_FileAccess_HowToExtend_Xml_Output">出力</a>を参照すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>上記のようなファイルを出力する設定を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:headerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeHeaderStaxWriterCallback</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:footerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeFooterStaxWriterCallback</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">headerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StaxWriterCallback</code>の実装クラスを設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">footerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StaxWriterCallback</code>の実装クラスを設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>StaxWriterCallback</code>は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>StaxWriterCallback</code>クラスを実装し、<code>write</code>メソッドをオーバーライドする</p>
</li>
<li>
<p>引数で受ける<code>XMLEventWriter</code>を用いてヘッダ/フッタを出力する</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">StaxWriterCallbackの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WriteHeaderStaxWriterCallback</span> <span class="directive">implements</span> StaxWriterCallback { <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> write(XMLEventWriter writer) <span class="directive">throws</span> <span class="exception">IOException</span> {
        XMLEventFactory factory = XMLEventFactory.newInstance();
        <span class="keyword">try</span> {
            writer.add(factory.createComment(<span class="string"><span class="delimiter">&quot;</span><span class="content"> Customer list header </span><span class="delimiter">&quot;</span></span>)); <span class="comment">// (2)</span>
        } <span class="keyword">catch</span> (XMLStreamException e) {
            <span class="comment">// omitted exception handling</span>
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StaxWriterCallback</code>クラスを実装し、<code>write</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受ける<code>XMLEventWriter</code>を用いてヘッダ/フッタを出力する。<br></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">XMLEventFactoryを使用したXMLの出力</div>
<div class="paragraph">
<p><code>XMLEventWriter</code>クラスを用いたXMLファイルの出力では<code>XMLEventFactory</code>クラスを使用することで効率的に<code>XMLEvent</code>を生成することができる。</p>
</div>
<div class="paragraph">
<p><code>XMLEventWriter</code>クラスには<code>add</code>メソッドが定義されており、<code>XMLEvent</code>オブジェクトを引数に取りXMLファイルの出力を行う。<br>
<code>XMLEvent</code>オブジェクトを都度生成するのは非常に手間が掛かるため、<code>XMLEvent</code>を容易に生成することができる<code>XMLEventFactory</code>クラスを使用する。<br>
<code>XMLEventFactory</code>クラスには <code>createStartDocument</code>メソッドや<code>createStartElement</code>メソッドなど、作成するイベントに対応したメソッドが定義してある。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToExtend_MultiFormat"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_MultiFormat"></a>5.3.3.3. マルチフォーマット</h5>
<div class="paragraph">
<p>マルチフォーマットファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="paragraph">
<p>マルチフォーマットは、<a href="#Ch05_FileAccess_Overview">Overview</a>で説明したとおり(ヘッダn行 + データn行 + トレーラn行)* n + フッタn行 の形式を基本とするが以下のようなパターンも存在する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>フッタレコードがある場合、ない場合</p>
</li>
<li>
<p>同一レコード区分内でフォーマットが異なるレコードがある場合</p>
<div class="ulist">
<ul>
<li>
<p>例)データ部は項目数が5と6のデータレコードが混在する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>マルチフォーマットのパターンはいくつかあるが、実現方式は同じになる。</p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToExtend_MultiFormat_Input"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_MultiFormat_Input"></a>5.3.3.3.1. 入力</h6>
<div class="paragraph">
<p>マルチフォーマットファイルの読み込みには、Spring Batchが提供する<code>org.springframework.batch.item.file.mapping.PatternMatchingCompositeLineMapper</code>を使用する。<br>
マルチフォーマットファイルでは各レコードのフォーマットごとに異なるBeanにマッピングする必要がある。<br>
<code>PatternMatchingCompositeLineMapper</code>は、正規表現によってレコードに対して使用する<code>LineTokenizer</code>および<code>FieldSetMapper</code>を選択することができる。</p>
</div>
<div class="paragraph">
<p>たとえば、以下のような形で使用する<code>LineTokenizers</code>を選択することが可能である。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>正規表現<code>USER*</code>(レコードの先頭が<code>USER</code>である)にマッチする場合は<code>userTokenizer</code>を使用する</p>
</li>
<li>
<p>正規表現<code>LINEA*</code>(レコードの先頭が<code>LINEA</code>である)にマッチする場合は<code>lineATokenizer</code>を使用する</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">マルチフォーマットファイルを読み込む際のレコードにかかるフォーマットの制約</div>
<div class="paragraph">
<p>マルチフォーマットファイルの読み込みを行うためには、正規表現でレコード区分を判別可能なフォーマットでなければならない。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>PatternMatchingCompositeLineMapper</code>は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>変換対象クラスはレコード区分をもつクラスを定義し、各レコード区分のクラスに継承させる</p>
</li>
<li>
<p>各レコードをBeanにマッピングするための<code>LineTokenizer</code>および<code>FieldSetMapper</code>を定義する</p>
</li>
<li>
<p><code>PatternMatchingCompositeLineMapper</code>を定義する</p>
<div class="ulist">
<ul>
<li>
<p>プロパティ<code>tokenizers</code>に各レコード区分に対応する<code>LineTokenizer</code>を設定する</p>
</li>
<li>
<p>プロパティ<code>fieldSetMappers</code>に各レコード区分に対応する<code>FieldSetMapper</code>を設定する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">変換対象クラスはレコード区分をもつクラスを定義し、各レコード区分のクラスに継承させる</div>
<div class="paragraph">
<p><code>ItemProcessor</code>は1つの型を引数に取る仕様である。</p>
</div>
<div class="paragraph">
<p>しかし、単純に<code>PatternMatchingCompositeLineMapper</code>にてマルチフォーマットのファイルをレコード区分ごとに異なるBeanにマッピングすると、<code>ItemProcessor</code>は1つの型を引数に取るため複数の型を処理することができない。</p>
</div>
<div class="paragraph">
<p>そのため、変換対象のクラスに継承関係をもたせ、<code>ItemProcessor</code>の引数の型にスーパークラスを指定することで解決が可能である。</p>
</div>
<div class="paragraph">
<p>以下に変換対象クラスのクラス図と<code>ItemProcessor</code>の定義例を示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_Conversion_target_class_with_inheritance_relationship.png" alt="Conversion target class definition when loading multiple formats">
</div>
<div class="title">変換対象クラスのクラス図</div>
</div>
<div class="listingblock">
<div class="title">ItemProcessorの定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MultiLayoutItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetailMultiLayoutRecord, <span class="predefined-type">String</span>&gt; {
    <span class="annotation">@Override</span>
    <span class="comment">// (1)</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(SalesPlanDetailMultiLayoutRecord item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">String</span> record = item.getRecord();  <span class="comment">// (2)</span>

        <span class="keyword">switch</span> (record) {  <span class="comment">// (3)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">H</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">T</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">E</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">default</span>:
            <span class="comment">// omitted exception handling</span>
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemProcessor</code>の引数に継承関係をもたせた変換対象クラスのスーパークラスを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">itemからレコード区分を取得する。<br>
各レコード区分によって実態のクラスは異なるが、ポリモーフィズムによってレコード区分を取得できる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区分を判定し、各レコード区分ごとの処理を行う。<br>
適宜、クラスの変換処理等を行うこと。</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以下に下記の入力ファイルを読み込むための設定例を示す。実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">H,Sales_plan_detail header No.1
D,000001,2016,1,0000000001,100000000
D,000001,2016,1,0000000002,200000000
D,000001,2016,1,0000000003,300000000
T,000001,3,600000000
H,Sales_plan_detail header No.2
D,00002,2016,1,0000000004,400000000
D,00002,2016,1,0000000005,500000000
D,00002,2016,1,0000000006,600000000
T,00002,3,1500000000
H,Sales_plan_detail header No.3
D,00003,2016,1,0000000007,700000000
D,00003,2016,1,0000000008,800000000
D,00003,2016,1,0000000009,900000000
T,00003,3,2400000000
E,3,9,4500000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>下記に変換対象クラスのBean定義例を示す。</p>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * Model of record indicator of sales plan detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailMultiLayoutRecord</span> {

    <span class="directive">protected</span> <span class="predefined-type">String</span> record;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of sales plan detail header.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailHeader</span> <span class="directive">extends</span> SalesPlanDetailMultiLayoutRecord {

    <span class="directive">private</span> <span class="predefined-type">String</span> description;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of Sales plan Detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailData</span> <span class="directive">extends</span> SalesPlanDetailMultiLayoutRecord {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of Sales plan Detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailTrailer</span> <span class="directive">extends</span> SalesPlanDetailMultiLayoutRecord {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> number;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> total;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of Sales plan Detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailEnd</span> <span class="directive">extends</span> SalesPlanDetailMultiLayoutRecord {
    <span class="comment">// omitted getter/setter</span>

    <span class="directive">private</span> <span class="type">int</span> headNum;
    <span class="directive">private</span> <span class="type">int</span> trailerNum;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> total;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,description</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,number,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,headNum,trailerNum,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailHeader</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailData</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailTrailer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailEnd</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.PatternMatchingCompositeLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tokenizers</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
                <span class="tag">&lt;map&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">H*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">D*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">T*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">E*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/map&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMappers</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
                <span class="tag">&lt;map&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">H*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">D*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">T*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">E*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/map&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコードに対応する<code>LineTokenizer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコード区分に対応する<code>LineTokenizer</code>を定義する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコードに対応する<code>FieldSetMapper</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコード区分に対応する<code>FieldSetMapper</code>を定義する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.mapping.PatternMatchingCompositeLineMapper</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tokenizers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map形式で各レコード区分に対応する<code>LineTokenizer</code>を設定する。<br>
<code>key</code>にレコードを判別する正規表現を設定し、<code>value-ref</code>に使用する<code>LineTokenizer</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldSetMappers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map形式で各レコード区分に対応する<code>FieldSetMapper</code>を設定する。<br>
<code>key</code>にレコードを判別する正規表現を設定し、<code>value-ref</code>に使用する<code>FieldSetMapper</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HowToExtend_MultiFormat_Output"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_MultiFormat_Output"></a>5.3.3.3.2. 出力</h6>
<div class="paragraph">
<p>マルチフォーマットファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="paragraph">
<p>マルチフォーマットファイル読み込みではレコード区分によって使用する<code>LineTokenizer</code>および<code>FieldSetMapper</code>を判別する<code>PatternMatchingCompositeLineMapper</code>を使用することで実現可能である。<br>
しかし、書き込み時に同様の機能をもつコンポーネントは提供されていない。<br></p>
</div>
<div class="paragraph">
<p>そのため、<code>ItemProcessor</code>内で変換対象クラスをレコード(文字列)に変換する処理までを行い、<code>ItemWriter</code>では受け取った文字列をそのまま書き込みを行うことでマルチフォーマットファイルの書き込みを実現する。</p>
</div>
<div class="paragraph">
<p>マルチフォーマットファイルの書き込みは以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ItemProcessor</code>にて変換対象クラスをレコード(文字列)に変換して<code>ItemWriter</code>に渡す</p>
<div class="ulist">
<ul>
<li>
<p>例では、各レコード区分ごとの<code>LineAggregator</code>および<code>FieldExtractor</code>を定義し、<code>ItemProcessor</code>でインジェクトして使用する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ItemWriter</code>では受け取った文字列をそのままファイルへ書き込みを行う</p>
<div class="ulist">
<ul>
<li>
<p><code>ItemWriter</code>のプロパティ<code>lineAggregator</code>に<code>PassThroughLineAggregator</code>を設定する</p>
</li>
<li>
<p><code>PassThroughLineAggregator</code>は受け取ったitemの<code>item.toString()</code>した結果を返す<code>LineAggregator</code>である</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>以下に下記の出力ファイルを書き出すための設定例を示す。実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">H,Sales_plan_detail header No.1
D,000001,2016,1,0000000001,100000000
D,000001,2016,1,0000000002,200000000
D,000001,2016,1,0000000003,300000000
T,000001,3,600000000
H,Sales_plan_detail header No.2
D,00002,2016,1,0000000004,400000000
D,00002,2016,1,0000000005,500000000
D,00002,2016,1,0000000006,600000000
T,00002,3,1500000000
H,Sales_plan_detail header No.3
D,00003,2016,1,0000000007,700000000
D,00003,2016,1,0000000008,800000000
D,00003,2016,1,0000000009,900000000
T,00003,3,2400000000
E,3,9,4500000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>変換対象クラスの定義および<code>ItemProcessor</code>定義例、注意点は<a href="#Ch05_FileAccess_HowToExtend_MultiFormat_Input">マルチフォーマットの入力</a>と同様である。</p>
</div>
<div class="paragraph">
<p>上記のファイルを出力するための設定は以下のとおり。
<code>ItemProcessor</code>の定義例をBean定義例の後に示す。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,description</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,number,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,headNum,trailerNum,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>


<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.PassThroughLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコード区分に対応する<code>LineAggregator</code>および<code>FieldExtractor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LineAggregator</code>および<code>FieldExtractor</code>を定義する。<br>
<code>ItemProcessor</code>で<code>LineAggregator</code>をインジェクトして使用する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.transform.PassThroughLineAggregator</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>ItemProcessor</code>の実装例を以下に示す。<br>
例で実装しているのは、受け取ったitemを文字列に変換して<code>ItemWriter</code>に渡す処理のみである。</p>
</div>
<div class="listingblock">
<div class="title">ItemProcessorの定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MultiLayoutItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetailMultiLayoutRecord, <span class="predefined-type">String</span>&gt; {

    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiLayoutRecord&gt; headerDelimitedLineAggregator;

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiLayoutRecord&gt; dataDelimitedLineAggregator;

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiLayoutRecord&gt; trailerDelimitedLineAggregator;

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiLayoutRecord&gt; endDelimitedLineAggregator;

    <span class="annotation">@Override</span>
    <span class="comment">// (2)</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(SalesPlanDetailMultiLayoutRecord item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">String</span> record = item.getRecord();  <span class="comment">// (3)</span>

        <span class="keyword">switch</span> (record) {  <span class="comment">// (4)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">H</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> headerDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> dataDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">T</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> trailerDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">E</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> endDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">default</span>:
            <span class="keyword">throw</span> <span class="keyword">new</span> IncorrectRecordClassificationException(
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">Record classification is incorrect.[value:</span><span class="delimiter">&quot;</span></span> + record + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>);
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコード区分に対応する<code>LineAggregator</code>をインジェクトする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemProcessor</code>の引数に継承関係をもたせた変換対象クラスのスーパークラスを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">itemからレコード区分を取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区分を判定し、各レコード区分ごとの処理を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコード区分に対応する<code>LineAggregator</code>を使用し変換対象クラスをレコード(文字列)に変換して<code>ItemWriter</code>に渡す。</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_ExclusiveControl"><a class="anchor" href="#Ch05_ExclusiveControl"></a>5.4. 排他制御</h3>
<div class="sect3">
<h4 id="Ch05_ExclusiveControl_Overview"><a class="anchor" href="#Ch05_ExclusiveControl_Overview"></a>5.4.1. Overview</h4>
<div class="paragraph">
<p>排他制御とは、複数のトランザクションから同じリソースに対して、同時に更新処理が行われる際に、データの整合性を保つために行う処理のことである。
複数のトランザクションから同じリソースに対して、同時に更新処理が行われる可能性がある場合は、基本的に排他制御を行う必要がある。</p>
</div>
<div class="paragraph">
<p>ここでの複数トランザクションとは以下のことを指す。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>複数ジョブの同時実行時におけるトランザクション</p>
</li>
<li>
<p>オンライン処理との同時実行時におけるトランザクション</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">複数ジョブの排他制御</div>
<div class="paragraph">
<p>複数ジョブを同時実行する場合は、排他制御の必要がないようにジョブ設計を行うことが基本である。
これは、アクセスするリソースや処理対象をジョブごとに分割することが基本であることを意味する。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>排他制御に関する概念は、オンライン処理と同様であるため、Macchinetta Server 1.x 開発ガイドラインにある
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/ExclusionControl.html">排他制御</a>を参照してほしい。</p>
</div>
<div class="paragraph">
<p>ここでは、Macchinetta Server 1.xでは説明されていない部分を中心に説明をする。</p>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで同じ使い方になる。</p>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_Overview_Necessity"><a class="anchor" href="#Ch05_ExclusiveControl_Overview_Necessity"></a>5.4.1.1. 排他制御の必要性</h5>
<div class="paragraph">
<p>排他制御の必要性に関しては、Macchinetta Server 1.x 開発ガイドラインにある
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#exclusioncontrol-necessity">排他制御の必要性</a>を参照。</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_Overview_File"><a class="anchor" href="#Ch05_ExclusiveControl_Overview_File"></a>5.4.1.2. ファイルの排他制御</h5>
<div class="paragraph">
<p>ファイルでの排他制御はファイルロックにより実現するのが一般的である。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ファイルロックとは</dt>
<dd>
<p>ファイルロックとは、ファイルをあるプログラムで使用している間、ほかのプログラムからの読み書きを制限する仕組みである。
ファイルロックの処理概要を以下に示す。</p>
</dd>
</dl>
</div>
<div class="ulist">
<div class="title">シナリオ</div>
<ul>
<li>
<p>バッチ処理Aがファイルのロックを取得し、ファイルの更新処理を開始する。</p>
</li>
<li>
<p>バッチ処理Bが同一のファイルの更新を試みファイルのロック取得を試みるが失敗する。</p>
</li>
<li>
<p>バッチ処理Aが処理を終了し、ファイルのロックを解除する</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_ExclusiveControl_File_Senario.png" alt="ExclusiveControl_File_Senario">
</div>
<div class="title">ファイルロックの処理概要</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>バッチ処理A(Batch ProcessA)が対象ファイル(TargetFile)のロック取得を試みる。</p>
</li>
<li>
<p>バッチ処理Aが、対象ファイルのロック取得に成功する</p>
</li>
<li>
<p>バッチ処理B(Batch ProcessB)が、対象ファイルのロック取得を試みる</p>
</li>
<li>
<p>バッチ処理Aが、対象ファイルに書き込みを行う</p>
</li>
<li>
<p>バッチ処理Bは、バッチ処理Aがロック中であるため、対象ファイルのロック取得に失敗する</p>
</li>
<li>
<p>バッチ処理Bが、ファイル更新失敗の処理を行う。</p>
</li>
<li>
<p>バッチ処理Aが、対象ファイルのロックを開放する。</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">デッドロックの予防</div>
<div class="paragraph">
<p>ファイルにおいてもデータベースと同様に複数のファイルに対してロックを取得する場合、デッドロックとなる場合がある。
そのため、ファイルの更新順序をルール化することが重要である。<br>
デッドロックの予防に関してはデータベースのテーブル間でのデッドロック防止と同様である。
詳細については、Macchinetta Server 1.x 開発ガイドラインの
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#id9">デッドロックの予防</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_Overview_DB"><a class="anchor" href="#Ch05_ExclusiveControl_Overview_DB"></a>5.4.1.3. データベースの排他制御</h5>
<div class="paragraph">
<p>データベースの排他制御に関しては、Macchinetta Server 1.x 開発ガイドラインにある
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#id5">データベースのロック機能による排他制御</a>
で詳しく説明されているため、そちらを参照のこと。</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_Overview_Usecase"><a class="anchor" href="#Ch05_ExclusiveControl_Overview_Usecase"></a>5.4.1.4. 排他制御方式の使い分け</h5>
<div class="paragraph">
<p>Macchinetta Batch 2.xでのロック方式と向いているシチュエーションを示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">排他制御方式の使い分け</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ロック方式</th>
<th class="tableblock halign-left valign-top">向いているシチュエーション</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#id7">楽観ロック</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">同時実行時におけるトランザクションで、別トランザクションの更新結果を処理対象外にして処理を継続できる場合</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#id8">悲観ロック</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理時間が長く、処理中に対象データの状況が変化したことによるやり直しが難しい処理<br>
ファイルに対する排他制御が必要な処理</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_Overview_Component"><a class="anchor" href="#Ch05_ExclusiveControl_Overview_Component"></a>5.4.1.5. 排他制御とコンポーネントの関係</h5>
<div class="paragraph">
<p>Macchinetta Batch 2.xが提供する各コンポーネントと排他制御との関係は以下のとおり。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">楽観ロック</dt>
</dl>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">排他制御とコンポーネントの関係</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 35%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">処理モデル</th>
<th class="tableblock halign-left valign-top">コンポーネント</th>
<th class="tableblock halign-left valign-top">ファイル</th>
<th class="tableblock halign-left valign-top">データベース</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock">チャンク</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Versionカラムなど取得時と更新時とで同じデータであることが確認できるカラムを含めてデータ取得を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">排他制御は不要である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">取得時と更新時との差分を確認し、他の処理で更新されていないことを確認した上で更新を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">タスクレット</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tasklet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データ取得時にはItemReader、データ更新時はItemWriterで説明した処理を実施する。<br>
Mapperインターフェースを直接利用する場合も考え方は同じである。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">ファイルに対する楽観ロック</div>
<div class="paragraph">
<p>ファイルの特性上、ファイルに対して楽観ロックを適用することがない。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">悲観ロック</dt>
</dl>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">排他制御とコンポーネントの関係</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 35%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">処理モデル</th>
<th class="tableblock halign-left valign-top">コンポーネント</th>
<th class="tableblock halign-left valign-top">ファイル</th>
<th class="tableblock halign-left valign-top">データベース</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock">チャンク</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">悲観ロックを用いずにSELECT文を発行する。<br>
ItemProcessorやItemWriterとは別コネクションになるため、ItemReaderでは排他制御は行わない。<br>
SELECTで取得するデータは、ItemProcessorでデータを取得する条件とする必要最低限のデータ(キー情報)とすることで性能が向上する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapperインターフェースを利用して、ItemReaderで取得したデータ(キー情報)を条件とするSQL文でSELECT FOR UPDATEを発行する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">悲観ロックを行ったItemProcessorと同トランザクションとなるため、ItemWriterでは排他制御を意識することなくデータを更新する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">タスクレット</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tasklet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemStreamReaderでファイルをオープンした直後にファイルロックを取得する。<br>
ItemStreamWriterをクローズする直前にファイルロックを開放する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データ取得時にはSELECT FOR UPDATE文を発行するItemReaderかMapperインターフェースを直接利用する。<br>
データ更新時はItemWriterで説明した処理を実施する。Mapperインターフェースを直接利用する場合も考え方は同じである。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">チャンクモデルでのデータベースでの悲観ロックによる注意事項</div>
<div class="paragraph">
<p>ItemReaderで取得したデータ(キー情報)がItemProcessorへ渡される間は排他制御されず、他のトランザクションにより元のデータが更新されている可能性がある。
そのため、ItemProcessorがデータを取得する条件は、ItemReaderと同じデータ(キー情報)を取得する条件を含む必要がある。<br>
ItemProcessorでデータが取得できない場合は、他のトランザクションにより更新されている可能性を考慮して、処理の継続または中断を検討し実装する必要がある。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">ファイルに対する悲観ロック</div>
<div class="paragraph">
<p>ファイルに対する悲観ロックはタスクレットモデルで実装すること。
チャンクモデルではその構造上、チャンク処理の隙間で排他できない期間が存在してしまうためである。
また、ファイルアクセスはItemStreamReader/ItemStreamWriterをInjectして利用することを前提とする。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">データベースでの悲観ロックによる待ち時間</div>
<div class="paragraph">
<p>悲観ロックを行う場合、競合により処理が待たされる時間が長くなる可能性がある。
その場合、NO WAITオプションやタイムアウト時間を指定して、悲観ロックを使用するのが妥当である。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_ExclusiveControl_HowToUse"><a class="anchor" href="#Ch05_ExclusiveControl_HowToUse"></a>5.4.2. How to use</h4>
<div class="paragraph">
<p>排他制御の使い方をリソース別に説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_ExclusiveControl_HowToUse_File">ファイルの排他制御</a></p>
</li>
<li>
<p><a href="#Ch05_ExclusiveControl_HowToUse_DB">データベースの排他制御</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_HowToUse_File"><a class="anchor" href="#Ch05_ExclusiveControl_HowToUse_File"></a>5.4.2.1. ファイルの排他制御</h5>
<div class="paragraph">
<p>Macchinetta Batch 2.xにおけるファイルの排他制御はタスクレットを実装することで実現する。
排他の実現手段としては、<code>java.nio.channels.FileChannel</code>クラスを使用したファイルロック取得で排他制御を行う。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">FileChannelクラスの詳細</div>
<div class="paragraph">
<p><code>FileChannel</code>クラスの詳細、使用方法については
<a href="https://docs.oracle.com/javase/8/docs/api/java/nio/channels/FileChannel.html">Javadoc</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>FileChannel</code>クラスを使用しファイルのロックを取得する例を示す。</p>
</div>
<div class="listingblock">
<div class="title">Tasklet実装</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">FileExclusiveTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="directive">private</span> <span class="predefined-type">String</span> targetPath = <span class="predefined-constant">null</span>; <span class="comment">// (1)</span>

    <span class="annotation">@Inject</span>
    ItemStreamReader&lt;SalesPlanDetail&gt; reader;

    <span class="annotation">@Inject</span>
    ItemStreamWriter&lt;SalesPlanDetailWithProcessName&gt; writer;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// omitted.</span>

        <span class="predefined-type">FileChannel</span> fc = <span class="predefined-constant">null</span>;
        <span class="predefined-type">FileLock</span> fileLock = <span class="predefined-constant">null</span>;

        <span class="keyword">try</span> {
            <span class="keyword">try</span> {
                <span class="predefined-type">File</span> file = <span class="keyword">new</span> <span class="predefined-type">File</span>(targetPath);
                fc = <span class="predefined-type">FileChannel</span>.open(file.toPath(), StandardOpenOption.WRITE,
                        StandardOpenOption.CREATE,
                        StandardOpenOption.APPEND); <span class="comment">// (2)</span>
                fileLock = fc.tryLock();  <span class="comment">// (3)</span>
            } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
                logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Failure other than lock acquisition</span><span class="delimiter">&quot;</span></span>, e);
                <span class="keyword">throw</span> <span class="keyword">new</span> FailedOtherAcquireLockException(
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">Failure other than lock acquisition</span><span class="delimiter">&quot;</span></span>, e);
            }
            <span class="keyword">if</span> (fileLock == <span class="predefined-constant">null</span>) {
                logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to acquire lock. [processName={}]</span><span class="delimiter">&quot;</span></span>, processName);
                <span class="keyword">throw</span> <span class="keyword">new</span> FailedAcquireLockException(<span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to acquire lock</span><span class="delimiter">&quot;</span></span>);
            }

            reader.open(executionConetxt);
            writer.open(executionConetxt);  <span class="comment">// (4)</span>

            <span class="comment">// (5)</span>
            SalesPlanDetail item;
            <span class="predefined-type">List</span>&lt;SalesPlanDetailWithProcessName&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
            <span class="keyword">while</span> ((item = reader.read()) != <span class="predefined-constant">null</span>) {

                <span class="comment">// omitted.</span>

                items.add(item);
                <span class="keyword">if</span> (items.size() &gt;= <span class="integer">10</span>) {
                    writer.write(items);
                    items.clear();
                }
            }
            <span class="keyword">if</span> (items.size() &gt; <span class="integer">0</span>) {
                writer.write(items);
            }

        } <span class="keyword">finally</span> {
            <span class="keyword">if</span> (fileLock != <span class="predefined-constant">null</span>) {
                <span class="keyword">try</span> {
                    fileLock.release();  <span class="comment">// (6)</span>
                } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
                    logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Lock release failed.</span><span class="delimiter">&quot;</span></span>, e);
                }
            }
            <span class="keyword">if</span> (fc != <span class="predefined-constant">null</span>) {
                <span class="keyword">try</span> {
                    fc.close();
                } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
                    <span class="comment">// do nothing.</span>
                }
            }
            <span class="keyword">try</span> {
                writer.close(); <span class="comment">// (7)</span>
            } <span class="keyword">catch</span> (ItemStreamException e) {
                <span class="comment">// ignore</span>
            }
            <span class="keyword">try</span> {
                reader.close();
            } <span class="keyword">catch</span> (ItemStreamException e) {
                <span class="comment">// ignore</span>
            }
        }
        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }

    <span class="comment">// (8)</span>
    <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> setTargetPath(<span class="predefined-type">String</span> targetPath) {
        <span class="local-variable">this</span>.targetPath = targetPath;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">排他対象のファイルパス。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイルチャネルを取得する。<br>
この例では、ファイルの新規作成・追記・書き込みに対するチャネルを取得している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイルロックを取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイロックの取得に成功した場合、排他対象のファイルをオープンする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイル出力を伴うビジネスロジックを実行する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイルロックを開放する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">排他対象のファイルをクローズする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイルパスを設定する。<br>
この例では、ジョブパラメータから受け取るようにしている。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">ロック取得に用いるFileChannelのメソッドについて</div>
<div class="paragraph">
<p><code>lock()</code>メソッドは対象ファイルがロック済みの場合ロックが解除されるまで待機するため、待機されない<code>tryLock()</code>メソッドを使用することを推奨する。
なおtrylock()は共有ロックと排他ロックが選択できるが、バッチ処理においては、通常は排他ロックを用いる。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">同一VMでのスレッド間の排他制御</div>
<div class="paragraph">
<p>同一VMにおけるスレッド間の排他制御は注意が必要である。
同一VMでのスレッド間でファイルに対する処理を行う場合、<code>FileChannel</code>クラスを用いたのロック機能では、ファイルが別スレッドの処理にてロックされているかの判定ができない。<br>
そのため、スレッド間での排他制御は機能しない。これを回避するには、ファイルへの書き込みを行う部分で同期化処理をすることでスレッド間の排他制御が行える。<br>
しかし、同期化を行うことで並列処理のメリットが薄れてしまい、単一スレッドで処理することと差異がなくなってしまう。
結果、同一のファイルに対して異なるスレッドで排他制御をして処理することは適していないため、そのような処理設計・実装を行わないこと。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">FlatFileItemWriterのappendAllowedプロパティについて</div>
<div class="paragraph">
<p>ファイルを新規作成(上書き)する場合は、<code>appendAllowed</code>プロパティを<code>false</code>(デフォルト)にすることで、排他制御が実現できる。
これは、<code>FlatFileItemWriter</code>の内部で<code>FileChannel</code>を使って制御しているためである。
しかし、ファイルの追記(<code>appendAllowed</code>プロパティが<code>true</code>)の場合は、開発者が<code>FileChannel</code>による排他制御を実装する必要がある。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_HowToUse_DB"><a class="anchor" href="#Ch05_ExclusiveControl_HowToUse_DB"></a>5.4.2.2. データベースの排他制御</h5>
<div class="paragraph">
<p>Macchinetta Batch 2.xにおけるデータベースの排他制御について説明する。</p>
</div>
<div class="paragraph">
<p>データベースの排他制御実装は、Macchinetta Server 1.x 開発ガイドラインにある
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#mybatis3">MyBatis3使用時の実装方法</a>が基本である。
本ガイドラインでは、
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#mybatis3">MyBatis3使用時の実装方法</a>ができている前提で説明を行う。</p>
</div>
<div class="paragraph">
<p><a href="#Ch05_ExclusiveControl_Overview_Component">排他制御とコンポーネントの関係</a>にあるとおり、処理モデル・コンポーネントの組み合わせによるバリエーションがある。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">データベースの排他制御のバリエーション</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 30%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">排他方式</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理モデル</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネント</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock">楽観ロック</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンクモデル</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader/ItemWriter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">タスクレットモデル</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader/ItemWriter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapperインターフェース</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock">悲観ロック</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンクモデル</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader/ItemProcessor/ItemWriter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">タスクレットモデル</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader/ItemWriter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapperインターフェース</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>タスクレットモデルでMapperインターフェースを使用する場合は、
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#mybatis3">MyBatis3使用時の実装方法</a>のとおりであるため、説明を割愛する。</p>
</div>
<div class="paragraph">
<p>タスクレットモデルでItemReader/ItemWriterを使用する場合は、Mapperインターフェースでの呼び出し部分がItemReader/ItemWriterに代わるだけなので、これも説明を割愛する。</p>
</div>
<div class="paragraph">
<p>よって、ここではチャンクモデルの排他制御について説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch05_ExclusiveControl_HowToUse_DB_OptimisticLock"><a class="anchor" href="#Ch05_ExclusiveControl_HowToUse_DB_OptimisticLock"></a>5.4.2.2.1. 楽観ロック</h6>
<div class="paragraph">
<p>チャンクモデルでの楽観ロックについて説明する。</p>
</div>
<div class="paragraph">
<p>MyBatisBatchItemWriterがもつ<code>assertUpdates</code>プロパティの設定により、ジョブの振る舞いが変化するので業務要件に合わせて、適切に設定をする必要がある。</p>
</div>
<div class="paragraph">
<p>楽観ロックを行うジョブ定義を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">ジョブ定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.exclusivecontrol.repository.ExclusiveControlRepository.branchFindOne</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameterValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['branchId']}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (2) ---&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.exclusivecontrol.repository.ExclusiveControlRepository.branchExclusiveUpdate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:assertUpdates</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkOptimisticLockCheckJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkOptimisticLockCheckJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchEditItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">楽観ロックによるデータ取得のSQLIDを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">楽観ロックによるデータ更新のSQLIDを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バッチ更新の件数を検証有無を設定する。<br>
<code>true</code>(デフォルト)に設定すると、更新件数が0件の場合に例外をスローする。<br>
<code>false</code>に設定すると、更新件数が0件の場合でも正常処理とする。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch05_ExclusiveControl_HowToUse_DB_PessimisticLock"><a class="anchor" href="#Ch05_ExclusiveControl_HowToUse_DB_PessimisticLock"></a>5.4.2.2.2. 悲観ロック</h6>
<div class="paragraph">
<p>チャンクモデルでの悲観ロックについて説明する。</p>
</div>
<div class="paragraph">
<p>悲観ロックを行うジョブ定義とItemProcessorを以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">ジョブ定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
        <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.exclusivecontrol.repository</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">template-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.exclusivecontrol.repository.ExclusiveControlRepository.branchIdFindByName</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameterValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['branchName']}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.exclusivecontrol.repository.ExclusiveControlRepository.branchUpdate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:assertUpdates</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{new Boolean(jobParameters['assertUpdates'])}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkPessimisticLockCheckJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkPessimisticLockCheckJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- (4) --&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchEditWithkPessimisticLockItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">悲観ロックを行うItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">BranchEditWithkPessimisticLockItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;<span class="predefined-type">String</span>, ExclusiveBranch&gt; {

    <span class="comment">// (5)</span>
    <span class="annotation">@Inject</span>
    ExclusiveControlRepository exclusiveControlRepository;

    <span class="comment">// (6)</span>
    <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['branchName']}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> branchName;

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ExclusiveBranch process(<span class="predefined-type">String</span> item) <span class="directive">throws</span> <span class="exception">Exception</span> {

      <span class="comment">// (7)</span>
        Branch branch = exclusiveControlRepository.branchFindOneByNameWithNowWaitLock(item, branchName);

        <span class="keyword">if</span> (branch != <span class="predefined-constant">null</span>) {
            ExclusiveBranch updatedBranch = <span class="keyword">new</span> ExclusiveBranch();

            updatedBranch.setBranchId(branch.getBranchId());
            updatedBranch.setBranchName(branch.getBranchName() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> - </span><span class="delimiter">&quot;</span></span> + identifier);
            updatedBranch.setBranchAddress(branch.getBranchAddress() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> - </span><span class="delimiter">&quot;</span></span> + identifier);
            updatedBranch.setBranchTel(branch.getBranchTel());
            updatedBranch.setCreateDate(branch.getUpdateDate());
            updatedBranch.setUpdateDate(<span class="keyword">new</span> <span class="predefined-type">Timestamp</span>(clock.millis()));
            updatedBranch.setOldBranchName(branch.getBranchName());

            <span class="keyword">return</span> updatedBranch;
        } <span class="keyword">else</span> {
            <span class="comment">// (8)</span>
            logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">An update by another user occurred. [branchId: {}]</span><span class="delimiter">&quot;</span></span>, item);
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MapperインターフェースがItemWriterと同じ更新モードになるように、<code>batchModeSqlSessionTemplate</code>を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">悲観ロックを用いないデータ取得のSQLIDを設定する。<br>
抽出条件として、ジョブ起動パラメータから、<code>branchName</code>を設定する。
このSQLによる取得項目は、(6)でデータを一意に特定するのに必要最低限に絞り込むことで性能を向上させることができる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">排他制御をしないデータ更新のSQLと同じSQLIDを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">悲観ロックによるデータ取得を行うItemProcessorを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">悲観ロックによるデータ取得を行うMapperインターフェースをインジェクションする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">悲観ロックの抽出条件とするため、ジョブ起動パラメータから、<code>branchName</code>を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">悲観ロックによるデータ取得のメソッドを呼び出す。<br>
(2)の抽出条件と同じ条件を設定しているため、キー情報(id)の他にジョブ起動パラメータ``branchName`を引数に渡している。<br>
NO WAITやタイムアウトを設定して悲観ロックを行い、他のトランザクションにより排他された時は、ここで例外が発生する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">他のトランザクションにより対象データが先に更新されて対象データを取得できない場合、悲観ロックによるデータ取得のメソッドがnullを返却する。<br>
悲観ロックによるデータ取得のメソッドがnullを返却した場合、例外を発生させて処理を中断するなど業務要件に合せた処理が必要となる。<br>
ここでは、WARNログを出力してnullを返却することで後続の処理を継続させる。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">タスクレットモデルでの悲観ロックを行うコンポーネントについて</div>
<div class="paragraph">
<p>タスクレットモデルで悲観ロックを行う場合は、悲観ロックを行うSQL発行するItemReaderを用いる。Mapperインターフェースを直接利用する場合も同様である。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch06"><a class="anchor" href="#Ch06"></a>6. 異常系への対応</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch06_InputValidation"><a class="anchor" href="#Ch06_InputValidation"></a>6.1. 入力チェック</h3>
<div class="sect3">
<h4 id="Ch06_InputValidation_Overview"><a class="anchor" href="#Ch06_InputValidation_Overview"></a>6.1.1. Overview</h4>
<div class="paragraph">
<p>本節では、ジョブの入力データに対する妥当性のチェック(以降、入力チェックと呼ぶ)について説明する。</p>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで同じ使い方になる。</p>
</div>
<div class="paragraph">
<p>一般的に、バッチ処理における入力チェックは、他システム等から受領したデータに対して、
自システムにおいて妥当であることを確認するために実施する事が多い。<br>
反対に、自システム内の信頼できるデータ(たとえば、データベースに格納されたデータ)に対して、
入力チェックを実施することは不要と言える。</p>
</div>
<div class="paragraph">
<p>入力チェックはMacchinetta Server 1.xの内容と重複するため、Macchinetta Server 1.x 開発ガイドラインの
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebApplicationDetail/Validation.html">入力チェック</a>
も合わせて参照すること。
以下に、主な比較について示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">主な比較一覧</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 35%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">比較対象</th>
<th class="tableblock halign-left valign-top">Macchinetta Server 1.x</th>
<th class="tableblock halign-left valign-top">Macchinetta Batch 2.x</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">使用できる入力チェックルール</p></td>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock">Macchinetta Server 1.xと同様</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ルールを付与する対象</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>フォームクラス</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DTO</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">チェックの実行方法</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Controllerに@Validatedアノテーションを付与する</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ValidatorクラスのAPIをコールする</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">エラーメッセージの設定</p></td>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock">Macchinetta Server 1.x 開発ガイドラインの
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebApplicationDetail/Validation.html#validation-message-def">エラーメッセージの定義</a>と同様</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">エラーメッセージの出力先</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">画面</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ログ等</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>なお、本節で説明対象とする入力チェックは、主にステップが処理する入力データを対象とする。<br>
ジョブパラメータのチェックについては<a href="#Ch04_JobParameter_HowToUse_ParamsValidation">パラメータの妥当性検証</a>を参照のこと。</p>
</div>
<div class="sect4">
<h5 id="Ch06_InputValidation_Overview_Category"><a class="anchor" href="#Ch06_InputValidation_Overview_Category"></a>6.1.1.1. 入力チェックの分類</h5>
<div class="paragraph">
<p>入力チェックは、単項目チェック、相関項目チェックに分類される。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 30%;">
<col style="width: 25%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">種類</th>
<th class="tableblock halign-left valign-top">説明</th>
<th class="tableblock halign-left valign-top">例</th>
<th class="tableblock halign-left valign-top">実現方法</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">単項目チェック</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">単一のフィールドで完結するチェック</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力必須チェック<br>
桁チェック<br>
型チェック</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean Validation(実装ライブラリとしてHibernate Validatorを使用)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">相関項目チェック</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">複数のフィールドを比較するチェック</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">数値の大小比較<br>
日付の前後比較</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.validation.Validator</code>インターフェースを実装した<code>Validation</code>クラス<br>
または Bean Validation</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Springは、Java標準であるBean Validationをサポートしている。
単項目チェックには、このBean Validationを利用する。
相関項目チェックの場合は、Bean ValidationまたはSpringが提供している<code>org.springframework.validation.Validator</code>インターフェースを利用する。</p>
</div>
<div class="paragraph">
<p>この点は、
Macchinetta Server 1.x 開発ガイドラインの <a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebApplicationDetail/Validation.html#id3">入力チェックの分類</a>
と同様である。</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_InputValidation_Overview_Arch"><a class="anchor" href="#Ch06_InputValidation_Overview_Arch"></a>6.1.1.2. 入力チェックの全体像</h5>
<div class="paragraph">
<p>チャンクモデル、タスクレットモデルにて入力チェックを行うタイミングは以下のとおりである。<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>チャンクモデルの場合は<code>ItemProcessor</code>で行う。</p>
</li>
<li>
<p>タスクレットモデルの場合は<code>Tasklet#execute()</code>にて、任意のタイミングで行う。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>チャンクモデル、タスクレットモデルにおいて入力チェックの実装方法は同様となるため、
ここではチャンクモデルの<code>ItemProcessor</code>で入力チェックを行う場合について説明する。</p>
</div>
<div class="paragraph">
<p>まず、入力チェックの全体像を説明する。入力チェックに関連するクラスの関係は以下のとおりである。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch06_InputValidation_Architecture_classes.png" alt="InputValidation architecture">
</div>
<div class="title">入力チェックの関連クラス</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ItemProcessor</code>に、<code>org.springframework.batch.item.validator.Validator</code>の実装である
<code>org.springframework.batch.item.validator.SpringValidator</code>をインジェクションしvalidateメソッドを実行する。</p>
<div class="ulist">
<ul>
<li>
<p><code>SpringValidator</code>は内部に<code>org.springframework.validation.Validator</code>を保持し、validateメソッドを実行する。<br>
いわば、<code>org.springframework.validation.Validator</code>のラッパーといえる。<br>
<code>org.springframework.validation.Validator</code>の実装は、
<code>org.springframework.validation.beanvalidation.LocalValidatorFactoryBean</code>となる。
このクラスを通じてHibernate Validatorを使用する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>何件目のデータで入力チェックエラーになったのかを判別するために<code>org.springframework.batch.item.ItemCountAware</code>を入力DTOに実装する。</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">データ件数の設定</div>
<div class="paragraph">
<p><code>ItemCountAware#setItemCount</code>は<code>AbstractItemCountingItemStreamItemReader</code>によって設定される。
よって、タスクレットモデルで<code>ItemReader</code>を使わない場合、更新されない。
この場合は何件目のデータでエラーになったかはユーザにて設定すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">javax.validation.Validatorやorg.springframework.validation.Validatorといったバリデータは直接使用しない。</div>
<div class="paragraph">
<p><code>javax.validation.Validator</code>や<code>org.springframework.validation.Validator</code>といったバリデータは直接使用せず、
<code>org.springframework.batch.item.validator.SpringValidator</code>を使用する。</p>
</div>
<div class="paragraph">
<p><code>SpringValidator</code>は<code>org.springframework.validation.Validator</code>のラッパーである。<br>
<code>SpringValidator</code>は発生した例外を<code>BindException</code>にラップし、<code>ValidationException</code>としてスローする。<br>
そのため、<code>ValidationException</code>を通して<code>BindException</code>にアクセスでき、柔軟なハンドリングがしやすくなる。</p>
</div>
<div class="paragraph">
<p>一方、<code>javax.validation.Validator</code>や<code>org.springframework.validation.Validator</code>といったバリデータを直接使用すると、バリデーションエラーになった情報を処理する際に煩雑なロジックになってしまう。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">org.springframework.batch.item.validator.ValidatingItemProcessorは使用しない</div>
<div class="paragraph">
<p><code>org.springframework.validation.Validator</code>による入力チェックは、
Spring Batchが提供する<code>ValidatingItemProcessor</code>を使用しても実現可能である。</p>
</div>
<div class="paragraph">
<p>しかし、以下の理由により状況によっては拡張を必要としてしまうため、
実装方法を統一する観点より使用しないこととする。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>入力チェックエラーをハンドリングし処理を継続することができない。</p>
</li>
<li>
<p>入力チェックエラーとなったデータに対して柔軟な対応を行うことができない。</p>
<div class="ulist">
<ul>
<li>
<p>入力チェックエラーとなったデータに対しての処理は、利用者によって多種多様(ログ出力のみ、エラーデータを別ファイルに退避する、など)となると想定される。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch06_InputValidation_HowToUse"><a class="anchor" href="#Ch06_InputValidation_HowToUse"></a>6.1.2. How to use</h4>
<div class="paragraph">
<p>先にも述べたが、入力チェックの実現方法は以下のとおりMacchinetta Server 1.xと同様である。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>単項目チェックは、Bean Validationを利用する。</p>
</li>
<li>
<p>相関項目チェックは、Bean ValidationまたはSpringが提供している<code>org.springframework.validation.Validator</code>インターフェースを利用する。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>入力チェックの方法について以下の順序で説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch06_InputValidation_HowToUse_Settings">各種設定</a></p>
</li>
<li>
<p><a href="#Ch06_InputValidation_HowToUse_defRules">入力チェックルールの定義</a></p>
</li>
<li>
<p><a href="#Ch06_InputValidation_HowToUse_Execution">入力チェックの実施</a></p>
</li>
<li>
<p><a href="#Ch06_InputValidation_HowToUse_ErrorHandling">入力チェックエラーのハンドリング</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch06_InputValidation_HowToUse_Settings"><a class="anchor" href="#Ch06_InputValidation_HowToUse_Settings"></a>6.1.2.1. 各種設定</h5>
<div class="paragraph">
<p>入力チェックにはHibernate Validatorを使用する。
ライブラリの依存関係にHibernate Validatorの定義があり、必要なBean定義が存在することを確認する。
これらは、Macchinetta Batch 2.xが提供するブランクプロジェクトではすでに設定済である。</p>
</div>
<div class="listingblock">
<div class="title">依存ライブラリの設定例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.hibernate<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>hibernate-validator<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">validator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.validator.SpringValidator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:validator-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">beanValidator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">beanValidator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.validation.beanvalidation.LocalValidatorFactoryBean</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">エラーメッセージの設定</div>
<p>先にも述べたが、エラーメッセージの設定については、
Macchinetta Server 1.x 開発ガイドラインの <a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebApplicationDetail/Validation.html#validation-message-def">エラーメッセージの定義</a>
を参照すること。</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_InputValidation_HowToUse_defRules"><a class="anchor" href="#Ch06_InputValidation_HowToUse_defRules"></a>6.1.2.2. 入力チェックルールの定義</h5>
<div class="paragraph">
<p>入力チェックのルールを実装する対象は<code>ItemReader</code>を通じて取得するDTOである。
<code>ItemReader</code>を通じて取得するDTOは以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>何件目のデータで入力チェックエラーになったのかを判別するために、<code>org.springframework.batch.item.ItemCountAware</code>を実装する。</p>
<div class="ulist">
<ul>
<li>
<p><code>setItemCount</code>メソッドにて引数で受けた現在処理中のitemが読み込み何件目であるかをあらわす数値をクラスフィールドに保持する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>入力チェックルールを定義する。</p>
<div class="ulist">
<ul>
<li>
<p>Macchinetta Server 1.x 開発ガイドラインの <a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebApplicationDetail/Validation.html">入力チェック</a> を参照。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>以下に、入力チェックルールを定義したDTOの例を示す。</p>
</div>
<div class="listingblock">
<div class="title">入力チェックルールを定義したDTOの例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">VerificationSalesPlanDetail</span> <span class="directive">implements</span> ItemCountAware {  <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="type">int</span> count;

    <span class="annotation">@NotEmpty</span>
    <span class="annotation">@Size</span>(min = <span class="integer">1</span>, max = <span class="integer">6</span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;

    <span class="annotation">@NotNull</span>
    <span class="annotation">@Min</span>(<span class="integer">1</span>)
    <span class="annotation">@Max</span>(<span class="integer">9999</span>)
    <span class="directive">private</span> <span class="type">int</span> year;

    <span class="annotation">@NotNull</span>
    <span class="annotation">@Min</span>(<span class="integer">1</span>)
    <span class="annotation">@Max</span>(<span class="integer">12</span>)
    <span class="directive">private</span> <span class="type">int</span> month;

    <span class="annotation">@NotEmpty</span>
    <span class="annotation">@Size</span>(min = <span class="integer">1</span>, max = <span class="integer">10</span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;

    <span class="annotation">@NotNull</span>
    <span class="annotation">@DecimalMin</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@DecimalMax</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">9999999999</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> setItemCount(<span class="type">int</span> count) {
        <span class="local-variable">this</span>.count = count;  <span class="comment">// (2)</span>
    }

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemCountAware</code>クラスを実装し、<code>setItemCount</code>メソッドをオーバーライドする。<br>
<code>ItemCountAware#setItemCount()</code>は、<code>ItemReader</code>が読み込んだデータが何件目であるかを引数に渡される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受ける<code>count</code>をクラスフィールドに保持する。<br>
この値は、何件目のデータで入力チェックエラーになったのかを判別するため使用する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch06_InputValidation_HowToUse_Execution"><a class="anchor" href="#Ch06_InputValidation_HowToUse_Execution"></a>6.1.2.3. 入力チェックの実施</h5>
<div class="paragraph">
<p>入力チェックの実施方法について説明する。
入力チェック実施は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ItemProcessor</code>の実装にて、<code>org.springframework.batch.item.validator.Validator#validate()</code>を実行する。</p>
<div class="ulist">
<ul>
<li>
<p><code>Validator</code>には<code>SpringValidator</code>のインスタンスをインジェクトして使用する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>入力チェックエラーをハンドリングする。詳細は<a href="#Ch06_InputValidation_HowToUse_ErrorHandling">入力チェックエラーのハンドリング</a>を参照すること。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>入力チェックの実施例を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">入力チェックを実施する例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ValidateAndContinueItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;VerificationSalesPlanDetail, SalesPlanDetail&gt; {
    <span class="annotation">@Inject</span>  <span class="comment">// (1)</span>
    <span class="predefined-type">Validator</span>&lt;VerificationSalesPlanDetail&gt; validator;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(VerificationSalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">try</span> {  <span class="comment">// (2)</span>
            validator.validate(item);  <span class="comment">// (3)</span>
        } <span class="keyword">catch</span> (ValidationException e) {
          <span class="comment">// omitted exception handling</span>
        }

        SalesPlanDetail salesPlanDetail = <span class="keyword">new</span> SalesPlanDetail();
        <span class="comment">// omitted business logic</span>

        <span class="keyword">return</span> salesPlanDetail;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SpringValidator</code>のインスタンスをインジェクトする。<br>
<code>org.springframework.batch.item.validator.Validator</code>の型引数には、<code>ItemReader</code>を通じて取得するDTOを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力チェックエラーをハンドリングする。<br>
例では例外をtry/catchで捕捉する方法で処理している。<br>
詳細は<a href="#Ch06_InputValidation_HowToUse_ErrorHandling">入力チェックエラーのハンドリング</a>を参照すること。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemReader</code>を通じて取得するDTOを引数として<code>Validator#validate()</code>を実行する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch06_InputValidation_HowToUse_ErrorHandling"><a class="anchor" href="#Ch06_InputValidation_HowToUse_ErrorHandling"></a>6.1.2.4. 入力チェックエラーのハンドリング</h5>
<div class="paragraph">
<p>入力チェックエラーが発生した場合の選択肢は以下の2択となる。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>入力チェックエラーが発生した時点で処理を打ち切り、ジョブを異常終了させる。</p>
</li>
<li>
<p>入力チェックエラーが発生したことをログ等に残し、後続データの処理は継続する。その後、ジョブ終了時に、ジョブを警告終了させる。</p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch06_InputValidation_HowToUse_ErrorHandling_Abend"><a class="anchor" href="#Ch06_InputValidation_HowToUse_ErrorHandling_Abend"></a>6.1.2.4.1. 処理を異常終了する場合</h6>
<div class="paragraph">
<p>例外発生時に処理を異常終了するためには、<code>java.lang.RuntimeException</code>またはそのサブクラスをスローする。</p>
</div>
<div class="paragraph">
<p>例外発生時にログ出力等の処理を行う方法は以下の2とおりがある。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>例外をtry/catchで捕捉し、例外をスローする前に行う。</p>
</li>
<li>
<p>例外をtry/catchで捕捉せず、<code>ItemProcessListener</code>を実装しonProcessErrorメソッドにて行う。</p>
<div class="ulist">
<ul>
<li>
<p><code>ItemProcessListener#onProcessError()</code>は<code>@OnProcessError</code>アノテーションを使用して実装してもよい。
詳細は、<a href="#Ch04_Listener">リスナー</a>を参照のこと。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>例外発生時に、例外情報をログ出力し、処理を異常終了する例を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">try/catchによるハンドリング例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ValidateAndAbortItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;VerificationSalesPlanDetail, SalesPlanDetail&gt; {
    <span class="comment">/**
     * Logger.
     */</span>
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(ValidateAndAbortItemProcessor.class);

    <span class="annotation">@Inject</span>
    <span class="predefined-type">Validator</span>&lt;VerificationSalesPlanDetail&gt; validator;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(VerificationSalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">try</span> {  <span class="comment">// (1)</span>
            validator.validate(item);  <span class="comment">// (2)</span>
        } <span class="keyword">catch</span> (ValidationException e) {
            <span class="comment">// (3)</span>
            logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred in input validation at the {} th item. [message:{}]</span><span class="delimiter">&quot;</span></span>,
                    item.getCount(), e.getMessage());
            <span class="keyword">throw</span> e;  <span class="comment">// (4)</span>
        }

        SalesPlanDetail salesPlanDetail = <span class="keyword">new</span> SalesPlanDetail();
        <span class="comment">// omitted business logic</span>

        <span class="keyword">return</span> salesPlanDetail;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">try/catchにて例外を捕捉する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力チェックを実行する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外をスローする前にログ出力処理を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外をスローする。<br>
<code>org.springframework.batch.item.validator.ValidationException</code>は<code>RuntimeException</code>のサブクラスであるため、
そのままスローしなおしてよい。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">ItemProcessListener#OnProcessErrorによるハンドリング例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ValidateAndAbortItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;VerificationSalesPlanDetail, SalesPlanDetail&gt; {

    <span class="comment">/**
     * Logger.
     */</span>
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(ValidateAndAbortItemProcessor.class);

    <span class="annotation">@Inject</span>
    <span class="predefined-type">Validator</span>&lt;VerificationSalesPlanDetail&gt; validator;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(VerificationSalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        validator.validate(item);  <span class="comment">// (1)</span>

        SalesPlanDetail salesPlanDetail = <span class="keyword">new</span> SalesPlanDetail();
        <span class="comment">// omitted business logic</span>

        <span class="keyword">return</span> salesPlanDetail;
    }

    <span class="annotation">@OnProcessError</span>  <span class="comment">// (2)</span>
    <span class="type">void</span> onProcessError(VerificationSalesPlanDetail item, <span class="exception">Exception</span> e) {
        <span class="comment">// (3)</span>
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred in input validation at the {} th item. [message:{}]</span><span class="delimiter">&quot;</span></span>, item.getCount() ,e.getMessage());
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力チェックを実行する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemProcessListener#onProcessError()</code>を<code>@OnProcessError</code>アノテーションを使用して実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外をスローする前にログ出力処理を行う。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">ItemProcessListener#onProcessError()使用時の注意点</div>
<div class="paragraph">
<p>onProcessErrorメソッドの利用は業務処理と例外ハンドリングを切り離すことができるためソースコードの可読性、保守性の向上等に有用である。<br>
しかし、上記の例でハンドリング処理を行っている<code>ValidationException</code>以外の例外が発生した場合も同じメソッドが実行されるため注意が必要である。</p>
</div>
<div class="paragraph">
<p><code>ItemProcessor#process()</code>におけるログ出力を例外によって出力し分ける場合は、
onProcessErrorメソッドにて発生した例外の種類を判定して例外処理を行う必要がある。
これが煩雑である場合は、try/catchによるハンドリングにて入力チェックエラーのみを処理し、それ以外はリスナーに移譲するように責務を分担するとよい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_InputValidation_HowToUse_ErrorHandling_Skip"><a class="anchor" href="#Ch06_InputValidation_HowToUse_ErrorHandling_Skip"></a>6.1.2.4.2. エラーレコードをスキップする場合</h6>
<div class="paragraph">
<p>入力チェックエラーが発生したレコードの情報をログ出力等を行った後、エラーが発生したレコードをスキップして後続データの処理を継続する場合は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>例外をtry/catchで捕捉する。</p>
</li>
<li>
<p>例外発生時のログ出力等を行う。</p>
</li>
<li>
<p><code>ItemProcessor#process()</code>の返り値として<code>null</code>を返却する。</p>
<div class="ulist">
<ul>
<li>
<p><code>null</code>を返却することで入力チェックエラーが発生したレコードは後続の処理対象(<code>ItemWriter</code>による出力)に含まれなくなる。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">ItemProcessorによるスキップ例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ValidateAndContinueItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;VerificationSalesPlanDetail, SalesPlanDetail&gt; {
    <span class="comment">/**
     * Logger.
     */</span>
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(ValidateAndContinueItemProcessor.class);

    <span class="annotation">@Inject</span>
    <span class="predefined-type">Validator</span>&lt;VerificationSalesPlanDetail&gt; validator;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(VerificationSalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">try</span> {  <span class="comment">// (1)</span>
            validator.validate(item);  <span class="comment">// (2)</span>
        } <span class="keyword">catch</span> (ValidationException e) {
            <span class="comment">// (3)</span>
            logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Skipping item because exception occurred in input validation at the {} th item. [message:{}]</span><span class="delimiter">&quot;</span></span>,
                    item.getCount(), e.getMessage());
            <span class="comment">// (4)</span>
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;  <span class="comment">// skipping item</span>
        }

        SalesPlanDetail salesPlanDetail = <span class="keyword">new</span> SalesPlanDetail();
        <span class="comment">// omitted business logic</span>

        <span class="keyword">return</span> salesPlanDetail;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">try/catchにて例外を捕捉する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力チェックを実行する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code>を返却する前にログ出力処理を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code>を返却することで当該データをスキップし次のデータ処理へ移る。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch06_InputValidation_HowToUse_ErrorHandling_ExitCode"><a class="anchor" href="#Ch06_InputValidation_HowToUse_ErrorHandling_ExitCode"></a>6.1.2.4.3. 終了コードの設定</h6>
<div class="paragraph">
<p>入力チェックエラーが発生した場合、入力チェックエラーが発生しなかった場合とジョブの状態を区別するために必ず正常終了ではない終了コードを設定すること。<br>
入力チェックエラーが発生したデータをスキップした場合、異常終了した場合においても終了コードの設定は必須である。</p>
</div>
<div class="paragraph">
<p>終了コードの設定方法については、<a href="#Ch07_JobManagement">ジョブの管理</a>を参照すること。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_InputValidation_HowToUse_ErrorHandling_ErrorMessage"><a class="anchor" href="#Ch06_InputValidation_HowToUse_ErrorHandling_ErrorMessage"></a>6.1.2.4.4. エラーメッセージの出力</h6>
<div class="paragraph">
<p>入力チェックエラーが発生した場合にMessageSourceを使用することで、任意のエラーメッセージを出力することができる。
エラーメッセージの設定については、
Macchinetta Server 1.x 開発ガイドラインの <a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebApplicationDetail/Validation.html#validation-message-def">エラーメッセージの定義</a>
を参照すること。エラーメッセージを出力する場合は以下の要領で実装する。</p>
</div>
<div class="paragraph">
<p>1レコード内におけるエラーメッセージを出力する方法として、以下の2とおりがある。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>まとめて1つのエラーメッセージとして出力する。</p>
</li>
<li>
<p>レコード内の各項目について、エラーメッセージを出力する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>例では、各項目のエラーメッセージを出力する方法で実装している。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>入力チェックエラーで発生する例外<code>ValidationException</code>を<code>try/catch</code>で捕捉する。</p>
</li>
<li>
<p><code>ValidationException</code>の<code>getCause</code>メソッドにより<code>org.springframework.validation.BindException</code>を取得する。</p>
<div class="ulist">
<ul>
<li>
<p><code>BindException</code>は<code>BindResult</code>を<code>implements</code>しているため、<code>FiledError</code>を取得することができる。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>getFieldErrors</code>メソッドにより<code>FiledError</code>をエラーの件数分、1件ずつ繰り返し取得する。</p>
</li>
<li>
<p>取得した<code>FieldError</code>を引数として、<code>MessageSource</code>により1件ずつエラーメッセージの出力を行う。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">MessageSourceによるエラーメッセージ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ValidateAndMessageItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;VerificationSalesPlanDetail, SalesPlanDetail&gt; {
    <span class="comment">/**
     * Logger.
     */</span>
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(ValidateAndMessageItemProcessor.class);

    <span class="annotation">@Inject</span>
    <span class="predefined-type">Validator</span>&lt;VerificationSalesPlanDetail&gt; validator;

    <span class="annotation">@Inject</span>
    MessageSource messageSource;  <span class="comment">// (1)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(VerificationSalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">try</span> {  <span class="comment">// (2)</span>
            validator.validate(item);  <span class="comment">// (3)</span>
        } <span class="keyword">catch</span> (ValidationException e) {
            <span class="comment">// (4)</span>
            <span class="exception">BindException</span> errors = (<span class="exception">BindException</span>) e.getCause();

            <span class="comment">// (5)</span>
            <span class="keyword">for</span> (FieldError fieldError : errors.getFieldErrors()) {
                <span class="comment">// (6)</span>
                logger.warn(messageSource.getMessage(fieldError, <span class="predefined-constant">null</span>) +
                                <span class="string"><span class="delimiter">&quot;</span><span class="content">Skipping item because exception occurred in input validation at the {} th item. [message:{}]</span><span class="delimiter">&quot;</span></span>,
                                    item.getCount(), e.getMessage());
            <span class="comment">// (7)</span>
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;  <span class="comment">// skipping item</span>
        }

        SalesPlanDetail salesPlanDetail = <span class="keyword">new</span> SalesPlanDetail();
        <span class="comment">// omitted business logic</span>

        <span class="keyword">return</span> salesPlanDetail;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResourceBundleMessageSource</code>のインスタンスをインジェクトする。<br>
<code>MassageSorce</code>のBean定義は<a href="#Ch07_JobManagement_HowToUse_MessageManagement">メッセージ管理</a>を参照すること。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">try/catchにて例外を捕捉する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力チェックを実行する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getCause()</code>で<code>org.springframework.validation.BindException</code>を取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getFieldErrors()</code>で1件分の<code>FiledError</code>を取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">取得した<code>FieldError</code>を引数にして、<code>messageSource</code>でエラーメッセージの出力処理を行う。<br>
1レコード内に3項目のエラーがある場合、3件のエラーメッセージを繰り返し出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code>を返却することで当該データをスキップし次のデータ処理へ移る。</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch06_ExceptionHandling"><a class="anchor" href="#Ch06_ExceptionHandling"></a>6.2. 例外ハンドリング</h3>
<div class="sect3">
<h4 id="Ch06_ExceptionHandling_Overview"><a class="anchor" href="#Ch06_ExceptionHandling_Overview"></a>6.2.1. Overview</h4>
<div class="paragraph">
<p>ジョブ実行時に発生する例外のハンドリング方法について説明する。</p>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで使い方が異なるため、それぞれについて説明する。</p>
</div>
<div class="paragraph">
<p>まず、例外の分類について説明し、例外の種類に応じたハンドリング方法を説明する。</p>
</div>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_Overview_Classification"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Classification"></a>6.2.1.1. 例外の分類</h5>
<div class="paragraph">
<p>ジョブ実行時に発生する例外は、以下の3つに分類される。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">例外の分類一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 30%;">
<col style="width: 35%;">
<col style="width: 30%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">項番</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">分類</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">説明</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Type">例外の種類</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの再実行(パラメータ、入力データの変更/修正など)によって発生原因が解消できる例外</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの再実行で発生原因が解消できる例外は、アプリケーションコードで例外をハンドリングし、例外処理を行う。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Type_BusinessEx">ビジネス例外</a><br>
<a href="#Ch06_ExceptionHandling_Overview_Type_LibraryEx">正常稼働時に発生するライブラリ例外</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの再実行によって発生原因が解消できない例外</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの再実行で発生原因が解消できる例外は、以下のパターンにてハンドリングする。</p>
<p class="tableblock">1. <a href="#Ch04_Listener_Overview_Types_StepListener">StepListener</a>で例外の捕捉が可能な場合は、
アプリケーションコードで例外をハンドリングする。<br></p>
<p class="tableblock">2. <a href="#Ch04_Listener_Overview_Types_StepListener">StepListener</a>で例外の捕捉が不可能な場合は、
フレームワークで例外処理をハンドリングする。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Type_SystemEx">システム例外</a><br>
<a href="#Ch06_ExceptionHandling_Overview_Type_UnexpectedSystemEx">予期しないシステム例外</a><br>
<a href="#Ch06_ExceptionHandling_Overview_Type_FatalErrors">致命的なエラー</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(非同期実行時に)ジョブ要求のリクエスト不正により発生する例外</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ要求のリクエスト不正により発生する例外は、フレームワークで例外処理をハンドリングし、例外処理を行う。</p>
<p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> <a href="#Ch04_AsyncJobWithDB">非同期実行(DBポーリング)</a>の場合は、
ポーリング処理ではジョブ要求に対する妥当性検証をしない。そのため、ジョブ要求を登録するアプリケーションで事前にリクエストに対する入力チェックが行われていることが望ましい。</p>
<p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> <a href="#Ch04_AsyncJobWithWeb">非同期実行(Webコンテナ)</a>の場合は、
Webアプリケーションにより事前にリクエストに対する入力チェックが行われていることを前提としている。</p>
<p class="tableblock">そのため、ジョブ要求やリクエストを受け付けるアプリケーションで例外ハンドリングを行う。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Type_IllegalRequest">ジョブ要求リクエスト不正エラー</a></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">例外処理内でトランザクショナルな処理は避ける</div>
<div class="paragraph">
<p>例外処理内でデータベースへの書き込みを始めとするトランザクショナルな処理を行うと、
二次例外を引き起こしてしまう可能性がある。
例外処理は、解析用ログ出力と終了コード設定を基本とすること。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_Overview_Type"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type"></a>6.2.1.2. 例外の種類</h5>
<div class="paragraph">
<p>例外の種類について説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Type_BusinessEx"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type_BusinessEx"></a>6.2.1.2.1. ビジネス例外</h6>
<div class="paragraph">
<p>ビジネス例外とは、<strong>ビジネスルールの違反を検知したことを通知する例外</strong>である。<br>
本例外は、ステップのロジック内で発生させる。<br>
アプリケーションとして想定される状態なので、システム運用者による対処は不要である。</p>
</div>
<div class="ulist">
<div class="title">ビジネス例外の例</div>
<ul>
<li>
<p>在庫引当時に在庫切れの場合</p>
</li>
<li>
<p>予定日より日数が超過した場合</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">該当する例外クラス</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.RuntimeException</code>またはそのサブクラス</p>
<div class="ulist">
<ul>
<li>
<p>ビジネス例外クラスをユーザにて作成することを推奨する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Type_LibraryEx"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type_LibraryEx"></a>6.2.1.2.2. 正常稼働時に発生するライブラリ例外</h6>
<div class="paragraph">
<p>正常稼働時に発生するライブラリ例外とは、フレームワーク、およびライブラリ内で発生する例外のうち、<strong>システムが正常稼働している時に発生する可能性のある例外</strong>のことを指す。<br>
フレームワーク、およびライブラリ内で発生する例外とは、Spring Frameworkや、その他のライブラリ内で発生する例外クラスを対象とする。<br>
アプリケーションとして想定される状態なので、システム運用者による対処は不要である。</p>
</div>
<div class="ulist">
<div class="title">正常稼働時に発生するライブラリ例外の例</div>
<ul>
<li>
<p>オンライン処理との<a href="#Ch05_ExclusiveControl">排他制御</a>で発生する楽観ロック例外</p>
</li>
<li>
<p>複数ジョブやオンライン処理からの同一データを同時登録する際に発生する一意制約例外</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">該当する例外クラス</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.dao.EmptyResultDataAccessException</code> (楽観ロックをした時、データ更新件数が0件の場合に発生する例外)</p>
</li>
<li>
<p><code>org.springframework.dao.DuplicateKeyException</code> (一意制約違反となった場合に発生する例外)</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Type_SystemEx"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type_SystemEx"></a>6.2.1.2.3. システム例外</h6>
<div class="paragraph">
<p>システム例外とは、<strong>システムが正常稼働している時に、発生してはいけない状態を検知したことを通知する例外</strong>である。<br>
本例外は、ステップのロジック内で発生させる。<br>
システム運用者による対処が必要となる。</p>
</div>
<div class="ulist">
<div class="title">システム例外の例</div>
<ul>
<li>
<p>事前に存在しているはずのマスタデータ、ディレクトリ、ファイルなどが存在しない場合。</p>
</li>
<li>
<p>フレームワーク、ライブラリ内で発生する検査例外のうち、システム異常に分類される例外を捕捉した場合(ファイル操作時のIOExceptionなど)。</p>
</li>
<li>
<p>etc&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">該当する例外クラス</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.RuntimeException</code>またはそのサブクラス</p>
<div class="ulist">
<ul>
<li>
<p>システム例外クラスを作成することを推奨する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Type_UnexpectedSystemEx"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type_UnexpectedSystemEx"></a>6.2.1.2.4. 予期しないシステム例外</h6>
<div class="paragraph">
<p>予期しないシステム例外とは、<strong>システムが正常稼働している時には発生しない非検査例外</strong>である。<br>
システム運用者による対処、またはシステム開発者による解析が必要となる。</p>
</div>
<div class="paragraph">
<p>予期しないシステム例外は、以下の処理をする以外はハンドリングしない。ハンドリングした場合は、例外を再度スローすること。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>捕捉例外を解析用にログ出力を行い、該当する終了コードの設定する。</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">予期しないシステム例外の例</div>
<ul>
<li>
<p>アプリケーション、フレームワーク、ライブラリにバグが潜んでいる場合。</p>
</li>
<li>
<p>データベースサーバなどがダウンしている場合。</p>
</li>
<li>
<p>etc&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">該当する例外クラス</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.NullPointerException</code> (バグ起因で発生する例外)</p>
</li>
<li>
<p><code>org.springframework.dao.DataAccessResourceFailureException</code>(データベースサーバがダウンしている場合に発生する例外)</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Type_FatalErrors"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type_FatalErrors"></a>6.2.1.2.5. 致命的なエラー</h6>
<div class="paragraph">
<p>致命的なエラーとは、<strong>システム(アプリケーション)全体に影響を及ぼす、致命的な問題が発生している事を通知するエラー</strong>である。<br>
システム運用者、またはシステム開発者による対処・リカバリが必要となる。</p>
</div>
<div class="paragraph">
<p>致命的なエラーは、以下の処理をする以外はハンドリングしない。ハンドリングした場合は、例外を再度スローすること。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>捕捉例外を解析用にログ出力を行い、該当する終了コードの設定する。</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">致命的なエラーの例</div>
<ul>
<li>
<p>Java仮想マシンで使用できるメモリが不足している場合。</p>
</li>
<li>
<p>etc&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">該当する例外クラス</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Error</code>を継承しているクラス</p>
<div class="ulist">
<ul>
<li>
<p>java.lang.OutOfMemoryError (メモリ不足時に発生するエラー)など</p>
</li>
</ul>
</div>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Type_IllegalRequest"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type_IllegalRequest"></a>6.2.1.2.6. ジョブ要求リクエスト不正エラー</h6>
<div class="paragraph">
<p>ジョブ要求リクエスト不正エラーとは、<strong>非同期実行時にジョブ要求のリクエストに問題が発生していることを通知するエラー</strong>である。<br>
システム運用者による対処・リカバリが必要となる。</p>
</div>
<div class="paragraph">
<p>ジョブ要求リクエスト不正エラーは、ジョブ要求のリクエストを処理するアプリケーションでの例外ハンドリングを前提にするため、
本ガイドラインでは説明はしない。</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_Overview_Deal"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Deal"></a>6.2.1.3. 例外への対応方法</h5>
<div class="paragraph">
<p>例外への対応方法について説明する。</p>
</div>
<div class="paragraph">
<p>例外への対応パターンは次のとおり。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>例外発生時にジョブの継続可否を決める (3種類)</p>
</li>
<li>
<p>中断したジョブの再実行方法を決める (2種類)</p>
</li>
</ol>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">ジョブの継続可否を決定する方法</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 25%;">
<col style="width: 65%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">例外への対応方法</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Deal_Skip">スキップ</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">エラーレコードをスキップし、処理を継続する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Deal_Retry">リトライ</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">エラーレコードを指定した条件(回数、時間等)に達するまで再処理する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Deal_Interruption">処理中断</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理を中断する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>例外が発生していなくても、ジョブが想定以上の処理時間になったため処理途中で停止する場合がある。<br>
この場合は、<a href="#Ch07_JobManagement_HowToUse_JobStatusManagement_JobStop">ジョブの停止</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">中断したジョブの再実行方法</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 25%;">
<col style="width: 65%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">例外への対応方法</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_RerunRestart_HowToUse_Rerun">ジョブのリラン</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">中断したジョブを最初から再実行する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_RerunRestart_HowToUse_Restart">ジョブのリスタート</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">中断したジョブを中断した箇所から再実行する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>中断したジョブの再実行方法についての詳細は、<a href="#Ch06_RerunRestart">処理の再実行</a>を参照してほしい。</p>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Deal_Skip"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Deal_Skip"></a>6.2.1.3.1. スキップ</h6>
<div class="paragraph">
<p>スキップとは、バッチ処理を止めずにエラーデータを飛ばして処理を継続する方法である。</p>
</div>
<div class="ulist">
<div class="title">スキップを行う例</div>
<ul>
<li>
<p>入力データ内に不正なレコードが存在する場合</p>
</li>
<li>
<p>ビジネス例外が発生した場合</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">スキップレコードの再処理</div>
<div class="paragraph">
<p>スキップを行う場合は、スキップした不正なレコードについてどのように対応するか設計すること。
不正なレコードを抽出して再処理する場合、次回実行時に含めて処理する場合、などといった方法が考えられる。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Deal_Retry"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Deal_Retry"></a>6.2.1.3.2. リトライ</h6>
<div class="paragraph">
<p>リトライとは、特定の処理に失敗したレコードに対して指定した回数や時間に達するまで再試行を繰り返す対応方法である。<br>
処理失敗の原因が実行環境に依存しており、かつ、時間の経過により解決される見込みのある場合にのみ用いる。</p>
</div>
<div class="ulist">
<div class="title">リトライを行う例</div>
<ul>
<li>
<p>排他制御により、処理対象のレコードがロックされている場合</p>
</li>
<li>
<p>ネットワークの瞬断によりメッセージ送信が失敗する場合</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">リトライの適用</div>
<div class="paragraph">
<p>リトライをあらゆる場面で適用してしまうと、異常発生時に処理時間がむやみに伸びてしまい、異常の検出が遅れる危険がある。<br>
よって、リトライは処理のごく一部に適用することが望ましく、
その対象は外部システム連携など信頼性が担保しにくいものに限定するとよい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Deal_Interruption"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Deal_Interruption"></a>6.2.1.3.3. 処理中断</h6>
<div class="paragraph">
<p>処理中断とは、文字どおり処理を途中で中断する対応方式である。<br>
処理の継続が不可能な内容のエラーが検知された場合や、レコードのスキップを許容しない要件の場合に用いる。</p>
</div>
<div class="ulist">
<div class="title">処理中断を行う例</div>
<ul>
<li>
<p>入力データ内に不正なレコードが存在する場合</p>
</li>
<li>
<p>ビジネス例外が発生した場合</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch06_ExceptionHandling_HowToUse"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse"></a>6.2.2. How to use</h4>
<div class="paragraph">
<p>例外ハンドリングの実現方法について説明をする。</p>
</div>
<div class="paragraph">
<p>バッチアプリケーション運用時のユーザインターフェースはログが主体である。よって、例外発生の監視もログを通じて行うことになる。</p>
</div>
<div class="paragraph">
<p>Spring Batch では、ステップ実行時に例外が発生した場合はログを出力し異常終了するため、ユーザにて追加実装をせずとも要件を満たせる可能性がある。
以降の説明は、ユーザにてシステムに応じたログ出力を行う必要があるときのみ、ピンポイントに実装するとよい。
すべての処理を実装しなくてはならないケースは基本的にはない。</p>
</div>
<div class="paragraph">
<p>例外ハンドリングの共通であるログ設定については、<a href="#Ch07_JobManagement_HowToUse_Logging">ロギング</a>を参照。</p>
</div>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_HowToUse_StepExceptionHandling"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling"></a>6.2.2.1. ステップ単位の例外ハンドリング</h5>
<div class="paragraph">
<p>ステップ単位での例外ハンドリング方法について説明する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_ChunkListener">ChunkListenerインターフェースによる例外ハンドリング</a></dt>
<dd>
<p>処理モデルによらず、発生した例外を統一的にハンドリングしたい場合は、
<a href="#Ch04_Listener_Overview_Types_ChunkListener">ChunkListener</a>インターフェースを利用する。<br>
チャンクよりスコープの広い、ステップやジョブのリスナーを利用しても実現できるが、
出来る限り発生した直後にハンドリングすることを重視し、<code>ChunkListener</code>を採用する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>各処理モデルごとの例外ハンドリング方法は以下のとおり。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk">チャンクモデルにおける例外ハンドリング</a></dt>
<dd>
<p>Spring Batch提供の各種Listenerインターフェースを使用して機能を実現する。</p>
</dd>
<dt class="hdlist1"><a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Tasklet">タスクレットモデルにおける例外ハンドリング</a></dt>
<dd>
<p>タスクレット実装内にて独自に例外ハンドリングを実装する。</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">ChunkListenerで統一的にハンドリングできるのはなぜか</div>
<div class="paragraph">
<p><code>ChunkListener</code>によってタスクレット実装内で発生した例外をハンドリングできることに違和感を感じるかもしれない。
これは、Spring Batch においてビジネスロジックの実行はチャンクを基準に考えられており、
1回のタスクレット実行は、1つのチャンク処理として扱われているためである。</p>
</div>
<div class="paragraph">
<p>この点は<code>org.springframework.batch.core.step.tasklet.Tasklet</code>のインターフェースにも表れている。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Tasklet</span> {
  RepeatStatus execute(StepContribution contribution,
          ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_ChunkListener"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_ChunkListener"></a>6.2.2.1.1. ChunkListenerインターフェースによる例外ハンドリング</h6>
<div class="paragraph">
<p><a href="#Ch04_Listener_Overview_Types_ChunkListener">ChunkListener</a>インターフェースの<code>afterChunkError</code>メソッドを実装する。<br>
<code>afterChunkError</code>メソッドの引数である<code>ChunkContext</code>から<code>ChunkListener.ROLLBACK_EXCEPTION_KEY</code>をキーにしてエラー情報を取得する。</p>
</div>
<div class="paragraph">
<p>リスナーの設定方法については、<a href="#Ch04_Listener_HowToUse_Configuration">リスナーの設定</a>を参照。</p>
</div>
<div class="listingblock">
<div class="title">ChunkListenerの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ChunkAroundListener</span> <span class="directive">implements</span> ChunkListener {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(ChunkAroundListener.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeChunk(ChunkContext context) {
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">before chunk. [context:{}]</span><span class="delimiter">&quot;</span></span>, context);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterChunk(ChunkContext context) {
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">after chunk. [context:{}]</span><span class="delimiter">&quot;</span></span>, context);
    }

    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterChunkError(ChunkContext context) {
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while chunk. [context:{}]</span><span class="delimiter">&quot;</span></span>, context,
                context.getAttribute(ChunkListener.ROLLBACK_EXCEPTION_KEY)); <span class="comment">// (2)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>afterChunkError</code>メソッドを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ChunkContext</code>から<code>ChunkListener.ROLLBACK_EXCEPTION_KEY</code>をキーにしてエラー情報を取得する。<br>
この例では、取得した例外のスタックトレースをログ出力している。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">処理モデルの違いによるChunkListenerの挙動の違い</div>
<div class="paragraph">
<p>チャンクモデルでは、リソースのオープン･クローズで発生した例外は、ChunkListenerインターフェースが捕捉するスコープ外となる。
そのため、afterChunkErrorメソッドでハンドリングが行われない。
概略図を以下に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch06_ExceptionHandling_DiffTimingOpenResourceByChunkModel.png" alt="Difference in resource open timing by chunk model">
</div>
<div class="title">チャンクモデルでの例外ハンドリング概略図</div>
</div>
<div class="paragraph">
<p>タスクレットモデルでは、リソースのオープン･クローズで発生した例外は、ChunkListenerインターフェースが捕捉するスコープ内となる。
そのため、afterChunkErrorメソッドでハンドリングが行わる。
概略図を以下に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch06_ExceptionHandling_DiffTimingOpenResourceByTaskletModel.png" alt="Difference in resource open timing by tasklet model">
</div>
<div class="title">タスクレットモデルでの例外ハンドリング概略図</div>
</div>
<div class="paragraph">
<p>この挙動の差を吸収して統一的に例外をハンドリングしたい場合は、
<a href="#Ch04_Listener_Overview_Types_StepExecutionListener">StepExecutionListener</a>インターフェースで例外の発生有無をチェックすることで実現できる。
ただし、<code>ChunkListener</code>よりも実装が少々複雑になる。</p>
</div>
<div class="listingblock">
<div class="title">StepExecutionListenerの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">StepErrorLoggingListener</span> <span class="directive">implements</span> StepExecutionListener {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(StepErrorLoggingListener.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="comment">// do nothing.</span>
    }

    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> ExitStatus afterStep(StepExecution stepExecution) {
        <span class="comment">// (2)</span>
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">Throwable</span>&gt; exceptions = stepExecution.getFailureExceptions();
        <span class="comment">// (3)</span>
        <span class="keyword">if</span> (exceptions.isEmpty()) {
            <span class="keyword">return</span> ExitStatus.COMPLETED;
        }

        <span class="comment">// (4)</span>
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">This step has occurred some exceptions as follow. </span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content">[step-name:{}] [size:{}]</span><span class="delimiter">&quot;</span></span>,
                stepExecution.getStepName(), exceptions.size());
        <span class="keyword">for</span> (<span class="predefined-type">Throwable</span> th : exceptions) {
            logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">exception has occurred in job.</span><span class="delimiter">&quot;</span></span>, th);
        }
        <span class="keyword">return</span> ExitStatus.FAILED;
    }</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>afterStep</code>メソッドを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数の<code>stepExecution</code>からエラー情報を取得する。複数の例外をまとめて扱う必要がある点に注意する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">エラー情報がない場合は、正常終了とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">エラー情報がある場合は、例外ハンドリングを行う。<br>
この例では、発生した例外をすべてスタックトレース付きのログ出力を行っている。</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk"></a>6.2.2.1.2. チャンクモデルにおける例外ハンドリング</h6>
<div class="paragraph">
<p>チャンクモデルでは、
<a href="#Ch04_Listener_Overview_Types_StepListener">StepListener</a>を継承したListenerで例外ハンドリングする。</p>
</div>
<div class="paragraph">
<p>リスナーの設定方法については、<a href="#Ch04_Listener_HowToUse_Configuration">リスナーの設定</a>を参照。</p>
</div>
<div class="sect6">
<h7 id="Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk_ItemReader"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk_ItemReader"></a>コーディングポイント(ItemReader編)</h7>
<div class="paragraph">
<p><a href="#Ch04_Listener_Overview_Types_ItemReadListener">ItemReadListener</a>インターフェースの
<code>onReadError</code>メソッドを実装することで、ItemReader内で発生した例外をハンドリングする。</p>
</div>
<div class="listingblock">
<div class="title">ItemReadListener#onReadErrorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CommonItemReadListener</span> <span class="directive">implements</span> ItemReadListener&lt;<span class="predefined-type">Object</span>&gt; {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(CommonItemReadListener.class);

    <span class="comment">// omitted.</span>

    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> onReadError(<span class="exception">Exception</span> ex) {
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while reading.</span><span class="delimiter">&quot;</span></span>, ex);  <span class="comment">// (2)</span>
    }

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onReadError</code>メソッドを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外ハンドリングを実装する<br>
この例では、引数から取得した例外のスタックトレースをログ出力している。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk_ItemProcessor"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk_ItemProcessor"></a>コーディングポイント(ItemProcessor編)</h7>
<div class="paragraph">
<p>ItemProcessorでの例外ハンドリングには、2つの方法があり、要件に応じて使い分ける。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ItemProcessor 内でtry～catchをする方法</p>
</li>
<li>
<p><a href="#Ch04_Listener_Overview_Types_ItemProcessListener">ItemProcessListener</a>インターフェースを使用する方法</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>使い分ける理由について説明する。<br>
ItemProcessorの処理内で例外発生時に実行される<code>onProcessError</code>メソッドの引数は、処理対処のアイテムと例外の2つである。<br>
システムの要件によっては、<code>ItemProcessListener</code>インターフェース内でログ出力等の例外をハンドリングする際に、この2つの引数で要件を満たせない場合が出てくる。
その場合は、ItemProcessor内でtry～catchにて例外をcatchし例外ハンドリング処理を行うことを推奨する。<br>
注意点として、ItemProcessor内でtry～catchを実装した上で、<code>ItemProcessListener</code>インターフェースを実装すると二重処理になる場合があるため、注意が必要である。<br>
きめ細かい例外ハンドリングを行いたい場合は、ItemProcessor内でtry～catchをする方法を採用すること。</p>
</div>
<div class="paragraph">
<p>それぞれの方法について説明する。</p>
</div>
<div id="Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk_ItemProcessor_TryCatchExample" class="dlist">
<dl>
<dt class="hdlist1">ItemProcessor 内でtry～catchする方法</dt>
<dd>
<p>きめ細かい例外ハンドリングが必要になる場合はこちらを使用する。<br>
後述するスキップの項で説明するが、エラーレコードの<a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip">スキップ</a>を行う際にはこちらを使用することとなる。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ItemProcessor内でtry～catchする実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AmountCheckProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPerformanceDetail&gt; {

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPerformanceDetail process(SalesPerformanceDetail item)
            <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">// (1)</span>
        <span class="keyword">try</span> {
            checkAmount(item.getAmount(), amountLimit);
        } <span class="keyword">catch</span> (<span class="exception">ArithmeticException</span> ae) {
            <span class="comment">// (2)</span>
            logger.error(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while processing. [item:{}]</span><span class="delimiter">&quot;</span></span>, item, ae);
            <span class="comment">// (3)</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">check error at processor.</span><span class="delimiter">&quot;</span></span>, ae);
        }
        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>try～catch</code>で実装する。ここでは、特定の例外(<code>ArithmeticException</code>)のみ特別なハンドリングをしている。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外ハンドリングを実装する<br>
この例では、引数から取得した例外のスタックトレースをログ出力している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクションのロールバック例外をスローする。<br>
また、この例外スローにより<code>ItemProcessListener</code>で共通の例外ハンドリングをすることもできる。</p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>ItemProcessListener</code>インターフェースを使用する方法</dt>
<dd>
<p>業務例外に対するハンドリングが共通化できる場合はこちらを使用する。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ItemProcessListener#onProcessErrorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CommonItemProcessListener</span> <span class="directive">implements</span> ItemProcessListener&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(CommonItemProcessListener.class);

    <span class="comment">// omitted.</span>

    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> onProcessError(<span class="predefined-type">Object</span> item, <span class="exception">Exception</span> e) {
        <span class="comment">// (2)</span>
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while processing. [item:{}]</span><span class="delimiter">&quot;</span></span>, item, e);
    }

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onProcessError</code>メソッドを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外ハンドリングを実装する<br>
この例では、引数から取得した処理対象データと例外のスタックトレースをログ出力している。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk_ItemWriter"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk_ItemWriter"></a>コーディングポイント(ItemWriter編)</h7>
<div class="paragraph">
<p><a href="#Ch04_Listener_Overview_Types_ItemWriteListener">ItemWriteListener</a>インターフェースの
<code>onWriteError</code>メソッドを実装することで、ItemWriter内で発生した例外をハンドリングする。</p>
</div>
<div class="listingblock">
<div class="title">ItemWriteListener#onWriteErrorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CommonItemWriteListener</span> <span class="directive">implements</span> ItemWriteListener&lt;<span class="predefined-type">Object</span>&gt; {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(CommonItemWriteListener.class);

    <span class="comment">// omitted.</span>

    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> onWriteError(<span class="exception">Exception</span> ex, <span class="predefined-type">List</span> item) {
        <span class="comment">// (2)</span>
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while processing. [items:{}]</span><span class="delimiter">&quot;</span></span>, item, ex);
    }

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onWriteError</code>メソッドを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外ハンドリングを実装する<br>
この例では、引数から取得した出力対象のチャンクと例外のスタックトレースをログ出力している。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Tasklet"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Tasklet"></a>6.2.2.1.3. タスクレットモデルにおける例外ハンドリング</h6>
<div class="paragraph">
<p>タスクレットモデルの例外ハンドリングはタスクレット内で独自に実装する。</p>
</div>
<div class="paragraph">
<p>トランザクション処理を行う場合は、ロールバックさせるために必ず例外を再度スローすること。</p>
</div>
<div id="Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Tasklet_TaskletExample" class="listingblock">
<div class="title">タスクレットモデルでの例外ハンドリング実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPerformanceTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(SalesPerformanceTasklet.class);

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// (1)</span>
        <span class="keyword">try</span> {
            reader.open(chunkContext.getStepContext().getStepExecution()
                    .getExecutionContext());

            <span class="predefined-type">List</span>&lt;SalesPerformanceDetail&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(<span class="integer">10</span>);
            SalesPerformanceDetail item = <span class="predefined-constant">null</span>;
            <span class="keyword">do</span> {
                <span class="comment">// Pseudo operation of ItemReader</span>
                <span class="comment">// omitted.</span>

                <span class="comment">// Pseudo operation of ItemProcessor</span>
                checkAmount(item.getAmount(), amountLimit);


                <span class="comment">// Pseudo operation of ItemWriter</span>
                <span class="comment">// omitted.</span>

            } <span class="keyword">while</span> (item != <span class="predefined-constant">null</span>);
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">exception in tasklet.</span><span class="delimiter">&quot;</span></span>, e);   <span class="comment">// (2)</span>
            <span class="keyword">throw</span> e;    <span class="comment">// (3)</span>
        } <span class="keyword">finally</span> {
            <span class="keyword">try</span> {
                reader.close();
            } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
                <span class="comment">// do nothing.</span>
            }
        }

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>try-catch</code>を実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外ハンドリングを実装する<br>
この例では、発生した例外のスタックトレースをログ出力している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクションをロールバックするため、例外を再度スローする。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_HowToUse_JobExceptionHandling"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_JobExceptionHandling"></a>6.2.2.2. ジョブ単位の例外ハンドリング</h5>
<div class="paragraph">
<p>ジョブ単位に例外ハンドリング方法を説明する。<br>
チャンクモデルとタスクレットモデルとで共通のハンドリング方法となる。</p>
</div>
<div class="paragraph">
<p>システム例外や致命的エラー等エラーはジョブ単位に
<a href="#Ch04_Listener_Overview_Types_JobExecutionListener">JobExecutionListener</a>インターフェースの実装を行う。</p>
</div>
<div class="paragraph">
<p>例外ハンドリング処理を集約して定義するために、ステップごとにハンドリング処理を定義はせずジョブ単位でハンドリングを行う。<br>
ここでの例外ハンドリングは、ログ出力、およびExitCodeの設定を行い、トランザクション処理は実装しないこと。</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">トランザクション処理の禁止</div>
<div class="paragraph">
<p><code>JobExecutionListener</code>で行われる処理は、業務トランザクション管理の範囲外となる。
よってジョブ単位の例外ハンドリングでトランザクション処理を実施することは禁止する。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ここでは、ItemProcessorで例外が発生したときのハンドリング例を示す。
リスナーの設定方法については、<a href="#Ch04_Listener_HowToUse_Configuration">リスナーの設定</a>を参照。</p>
</div>
<div class="listingblock">
<div class="title">ItemProcessorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AmountCheckProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPerformanceDetail&gt; {

    <span class="comment">// omitted.</span>

    <span class="directive">private</span> StepExecution stepExecution;

    <span class="comment">// (1)</span>
    <span class="annotation">@BeforeStep</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="local-variable">this</span>.stepExecution = stepExecution;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPerformanceDetail process(SalesPerformanceDetail item)
            <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">// (2)</span>
        <span class="keyword">try</span> {
            checkAmount(item.getAmount(), amountLimit);
        } <span class="keyword">catch</span> (<span class="exception">ArithmeticException</span> ae) {
            <span class="comment">// (3)</span>
            stepExecution.getExecutionContext().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR_ITEM</span><span class="delimiter">&quot;</span></span>, item);
            <span class="comment">// (4)</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">check error at processor.</span><span class="delimiter">&quot;</span></span>, ae);
        }
        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">JobExecutionListenerでの例外ハンドリング実装</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobErrorLoggingListener</span> <span class="directive">implements</span> JobExecutionListener {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(JobErrorLoggingListener.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="comment">// do nothing.</span>
    }

    <span class="comment">// (5)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterJob(JobExecution jobExecution) {

        <span class="comment">// whole job execution</span>
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">Throwable</span>&gt; exceptions = jobExecution.getAllFailureExceptions(); <span class="comment">// (6)</span>
        <span class="comment">// (7)</span>
        <span class="keyword">if</span> (exceptions.isEmpty()) {
            <span class="keyword">return</span>;
        }
        <span class="comment">// (8)</span>
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">This job has occurred some exceptions as follow. </span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content">[job-name:{}] [size:{}]</span><span class="delimiter">&quot;</span></span>,
                jobExecution.getJobInstance().getJobName(), exceptions.size());
        <span class="keyword">for</span> (<span class="predefined-type">Throwable</span> th : exceptions) {
            logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">exception has occurred in job.</span><span class="delimiter">&quot;</span></span>, th);
        }
        <span class="comment">// (9)</span>
        <span class="keyword">for</span> (StepExecution stepExecution : jobExecution.getStepExecutions()) {
            <span class="predefined-type">Object</span> errorItem = stepExecution.getExecutionContext()
                    .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR_ITEM</span><span class="delimiter">&quot;</span></span>); <span class="comment">// (10)</span>
            <span class="keyword">if</span> (errorItem != <span class="predefined-constant">null</span>) {
                logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">detected error on this item processing. </span><span class="delimiter">&quot;</span></span> +
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">[step:{}] [item:{}]</span><span class="delimiter">&quot;</span></span>, stepExecution.getStepName(),
                        errorItem);
            }
        }

    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecutionListener</code>でエラーデータを出力するため、ステップ実行前に<code>StepExecution</code>インスタンスを取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>try-catch</code>を実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外ハンドリングを実装する<br>
この例では、<code>StepExecution</code>インスタンスのコンテキストにエラーデータを<code>ERROR_ITEM</code>というキーで格納している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecutionListener</code>で例外ハンドリングをするために、例外をスローする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>afterJob</code>メソッドに例外ハンドリングを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数の<code>jobExecution</code>からジョブ全体で発生したエラー情報を取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">エラー情報がない場合は、正常終了とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">エラー情報がある場合は、例外ハンドリングを行う。<br>
この例では、発生した例外をすべてスタックトレース付きのログ出力を行っている。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">この例では、エラーデータがある場合はログ出力を行うようにしている。<br>
ジョブで定義されたすべてのステップから<code>StepExecution</code>インスタンスを取得し、<code>ERROR_ITEM</code>というキーでエラーデータが格納されているかチェックする。
格納されていた場合は、エラーデータとしてログ出力する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">ExecutionContextへ格納するオブジェクト</div>
<div class="paragraph">
<p><code>ExecutionContext</code>へ格納するオブジェクトは、<code>java.io.Serializable</code>を実装したクラスでなければならない。
これは、<code>ExecutionContext</code>が<code>JobRepository</code>へ格納されるためである。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_HowToUse_ContinuationPropriety"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety"></a>6.2.2.3. 処理継続可否の決定</h5>
<div class="paragraph">
<p>例外発生時にジョブの処理継続可否を決定する実装方法を説明する。</p>
</div>
<div class="ulist">
<div class="title">処理継続可否方法一覧</div>
<ul>
<li>
<p><a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip">スキップ</a></p>
</li>
<li>
<p><a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Retry">リトライ</a></p>
</li>
<li>
<p><a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Interruption">処理中断</a></p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip"></a>6.2.2.3.1. スキップ</h6>
<div class="paragraph">
<p>エラーレコードをスキップして、処理を継続する方法を説明する。</p>
</div>
<div class="sect6">
<h7 id="Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk"></a>チャンクモデル</h7>
<div class="paragraph">
<p>チャンクモデルでは、各処理のコンポーネントで実装方法が異なる。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ここで説明する内容を適用する前に、必ず<a href="#Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses">&lt;skippable-exception-classes&gt;を使わない理由について</a>を一読すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_ItemReader">ItemReaderでのスキップ</a></p>
</li>
<li>
<p><a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_ItemProcessor">ItemProcessorでのスキップ</a></p>
</li>
<li>
<p><a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_ItemWriter">ItemWriterでのスキップ</a></p>
</li>
</ul>
</div>
<div id="Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_ItemReader" class="dlist">
<dl>
<dt class="hdlist1">ItemReaderでのスキップ</dt>
<dd>
<p><code>&lt;batch:chunk&gt;</code>の<code>skip-policy</code>属性にスキップ方法を指定する。
<code>&lt;batch:skippable-exception-classes&gt;</code>に、スキップ対象とするItemReaderで発生する例外クラスを指定する。<br>
<code>skip-policy</code>属性には、Spring Batchが提供している下記に示すいづれかのクラスを使用する。</p>
</dd>
</dl>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">skip-policy一覧</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">クラス名</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_AlwaysSkipItemSkipPolicy">AlwaysSkipItemSkipPolicy</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">常にスキップをする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_NeverSkipItemSkipPolicy">NeverSkipItemSkipPolicy</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">スキップをしない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_LimitCheckingItemSkipPolicy">LimitCheckingItemSkipPolicy</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">指定したスキップ数の上限に達するまでスキップをする。<br>
上限値に達した場合は、以下の例外が発生する。<br>
<code>org.springframework.batch.core.step.skip.SkipLimitExceededException</code></p>
<p class="tableblock"><code>skip-policy</code>を省略した時にデフォルトで使われるスキップ方法である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_ExceptionClassifierSkipPolicy">ExceptionClassifierSkipPolicy</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外ごとに適用する<code>skip-policy</code>を変えたい場合に利用する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>スキップの実装例を説明する。</p>
</div>
<div class="paragraph">
<p><code>FlatFileItemReader</code>でCSVファイルを読み込む際、不正なレコードが存在するケースを扱う。<br>
なお、この時以下の例外が発生する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.item.ItemReaderException</code>(ベースとなる例外クラス)</p>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.item.file.FlatFileParseException</code> (発生する例外クラス)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>skip-policy</code>別に定義方法を示す。</p>
</div>
<div class="listingblock">
<div class="title">前提とするItemReaderの定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.performance.SalesPerformanceDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div id="Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_AlwaysSkipItemSkipPolicy" class="dlist">
<dl>
<dt class="hdlist1">AlwaysSkipItemSkipPolicy</dt>
</dl>
</div>
<div class="listingblock">
<div class="title">AlwaysSkipItemSkipPolicyの指定例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">skipPolicy</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.step.skip.AlwaysSkipItemSkipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtSkipAllReadError</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtSkipAllReadError.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">skip-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">skipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;/batch:chunk&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AlwaysSkipItemSkipPolicy</code>をBean定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:chunk&gt;</code>の<code>skip-policy</code>属性に(1)で定義したBeanを設定する。</p></td>
</tr>
</tbody>
</table>
<div id="Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_NeverSkipItemSkipPolicy" class="dlist">
<dl>
<dt class="hdlist1">NeverSkipItemSkipPolicy</dt>
</dl>
</div>
<div class="listingblock">
<div class="title">NeverSkipItemSkipPolicyの指定例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">skipPolicy</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.step.skip.NeverSkipItemSkipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtSkipNeverReadError</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtSkipNeverReadError.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">skip-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">skipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;/batch:chunk&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NeverSkipItemSkipPolicy</code>をBean定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:chunk&gt;</code>の<code>skip-policy</code>属性に(1)で定義したBeanを設定する。</p></td>
</tr>
</tbody>
</table>
<div id="Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_LimitCheckingItemSkipPolicy" class="dlist">
<dl>
<dt class="hdlist1">LimitCheckingItemSkipPolicy</dt>
</dl>
</div>
<div class="listingblock">
<div class="title">LimitCheckingItemSkipPolicyの指定例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">(1)
<span class="comment">&lt;!--
&lt;bean id=&quot;skipPolicy&quot;
      class=&quot;org.springframework.batch.core.step.skip.LimitCheckingItemSkipPolicy&quot;/&gt;
--&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtValidSkipReadError</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtValidSkipReadError.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">skip-limit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
                <span class="comment">&lt;!-- (3) --&gt;</span>
                <span class="tag">&lt;batch:skippable-exception-classes&gt;</span>
                    <span class="comment">&lt;!-- (4) --&gt;</span>
                    <span class="tag">&lt;batch:include</span>
                        <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.ItemReaderException</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/batch:skippable-exception-classes&gt;</span>
            <span class="tag">&lt;/batch:chunk&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LimitCheckingItemSkipPolicy</code>をBean定義する。<br>
<code>skip-policy</code>属性省略時のデフォルトであるため、定義しなくてもよい。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:chunk&gt;</code>の<code>skip-limit</code>属性にスキップ数の上限値を設定する。<br>
<code>skip-policy</code>属性はデフォルトを使用ため省略。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:skippable-exception-classes&gt;</code>を定義し、タグ内に対象となる例外を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemReaderException</code>をスキップ対象クラスとして設定を行う。</p></td>
</tr>
</tbody>
</table>
<div id="Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_ExceptionClassifierSkipPolicy" class="dlist">
<dl>
<dt class="hdlist1">ExceptionClassifierSkipPolicy</dt>
</dl>
</div>
<div class="listingblock">
<div class="title">ExceptionClassifierSkipPolicyの指定例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">skipPolicy</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.step.skip.ExceptionClassifierSkipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">policyMap</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.ItemReaderException</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">alwaysSkip</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>
<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">alwaysSkip</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.step.skip.AlwaysSkipItemSkipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtValidNolimitSkipReadError</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtValidNolimitSkipReadError.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- skip-limit value is dummy. --&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">skip-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">skipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (4) --&gt;</span>
            <span class="tag">&lt;/batch:chunk&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ExceptionClassifierSkipPolicy</code>をBean定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>policyMap</code>プロパティに、キーを例外クラス、値をスキップ方法にしたマップを設定する。<br>
この例では、<code>ItemReaderException</code>が発生したときに(3)で定義したスキップ方法になるように設定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外別に実行したいスキップ方法を定義する。<br>
この例では、<code>AlwaysSkipItemSkipPolicy</code>を定義している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:chunk&gt;</code>の<code>skip-policy</code>属性に(1)で定義したBeanを設定する。</p></td>
</tr>
</tbody>
</table>
<div id="Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_ItemProcessor" class="dlist">
<dl>
<dt class="hdlist1">ItemProcessorでのスキップ</dt>
<dd>
<p>ItemProcessor内でtry～catchをして、nullを返却する。<br>
<code>skip-policy</code>によるスキップは、ItemProcessorで再処理が発生するため利用しない。
詳細は、<a href="#Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses">&lt;skippable-exception-classes&gt;を使わない理由について</a>を参照すること。</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">ItemProcessorにおける例外ハンドリンクの制約</div>
<div class="paragraph">
<p><a href="#Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses">&lt;skippable-exception-classes&gt;を使わない理由について</a>にあるように、
ItemProcessorでは、<code>&lt;batch:skippable-exception-classes&gt;</code>を利用したスキップは禁止している。
そのため、<a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk_ItemProcessor">コーディングポイント(ItemProcessor編)</a>で説明している
「<a href="#Ch04_Listener_Overview_Types_ItemProcessListener">ItemProcessListener</a>インターフェースを使用する方法」を応用したスキップはできない。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>スキップの実装例を説明する。</p>
</div>
<div class="paragraph">
<p><a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk_ItemProcessor">コーディングポイント(ItemProcessor編)</a>の
<a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk_ItemProcessor_TryCatchExample">ItemProcessor内でtry～catchする実装例</a>を
スキップに対応させる。</p>
</div>
<div class="listingblock">
<div class="title">ItemProcessor 内でtry～catchする例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AmountCheckProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPerformanceDetail&gt; {

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPerformanceDetail process(SalesPerformanceDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">// (1)</span>
        <span class="keyword">try</span> {
            checkAmount(item.getAmount(), amountLimit);
        } <span class="keyword">catch</span> (<span class="exception">ArithmeticException</span> ae) {
            logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while processing. Skipped. [item:{}]</span><span class="delimiter">&quot;</span></span>,
                    item, ae); <span class="comment">// (2)</span>
            <span class="keyword">return</span> <span class="predefined-constant">null</span>; <span class="comment">// (3)</span>
        }
        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>try～catch</code>で実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外ハンドリングを実装する<br>
この例では、引数から取得した例外のスタックトレースをログ出力している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">nullを返却することでエラーデータをスキップする。</p></td>
</tr>
</tbody>
</table>
<div id="Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_ItemWriter" class="dlist">
<dl>
<dt class="hdlist1">ItemWriterでのスキップ</dt>
<dd>
<p>ItemWriterにおいてスキップ処理は原則として行わない。<br>
スキップが必要な場合でも、  <code>skip-policy</code>によるスキップは、チャンクサイズが変動するので利用しない。
詳細は、<a href="#Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses">&lt;skippable-exception-classes&gt;を使わない理由について</a>を参照すること。</p>
</dd>
</dl>
</div>
</div>
<div class="sect6">
<h7 id="Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Tasklet"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Tasklet"></a>タスクレットモデル</h7>
<div class="paragraph">
<p>ビジネスロジック内で例外をハンドリングし、独自にエラーレコードをスキップする処理を実装する。</p>
</div>
<div class="paragraph">
<p><a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Tasklet">タスクレットモデルにおける例外ハンドリング</a>の
<a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Tasklet_TaskletExample">実装例</a>を
スキップ対応させる。</p>
</div>
<div class="listingblock">
<div class="title">タスクレットモデルでの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPerformanceTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(SalesPerformanceTasklet.class);

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// (1)</span>
        <span class="keyword">try</span> {
            reader.open(chunkContext.getStepContext().getStepExecution()
                    .getExecutionContext());

            <span class="predefined-type">List</span>&lt;SalesPerformanceDetail&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(<span class="integer">10</span>);
            SalesPerformanceDetail item = <span class="predefined-constant">null</span>;
            <span class="keyword">do</span> {
                <span class="comment">// Pseudo operation of ItemReader</span>
                <span class="comment">// omitted.</span>

                <span class="comment">// Pseudo operation of ItemProcessor</span>
                checkAmount(item.getAmount(), amountLimit);


                <span class="comment">// Pseudo operation of ItemWriter</span>
                <span class="comment">// omitted.</span>

            } <span class="keyword">while</span> (item != <span class="predefined-constant">null</span>);
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">exception in tasklet. Skipped.</span><span class="delimiter">&quot;</span></span>, e);   <span class="comment">// (2)</span>
            <span class="keyword">continue</span>;    <span class="comment">// (3)</span>
        } <span class="keyword">finally</span> {
            <span class="keyword">try</span> {
                reader.close();
            } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
                <span class="comment">// do nothing.</span>
            }
        }

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>try-catch</code>を実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外ハンドリングを実装する<br>
この例では、発生した例外のスタックトレースをログ出力している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">continueにより、エラーデータの処理をスキップする。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Retry"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Retry"></a>6.2.2.3.2. リトライ</h6>
<div class="paragraph">
<p>例外を検知した場合に、規定回数に達するまで再処理する方法を説明する。</p>
</div>
<div class="paragraph">
<p>リトライには、状態管理の有無やリトライが発生するシチュエーションなどさまざまな要素を考慮する必要があり、
確実な方法は存在しないうえに、むやみにリトライするとかえって状況を悪化させてしまう。</p>
</div>
<div class="paragraph">
<p>そのため、本ガイドラインでは、局所的なリトライを実現する<code>org.springframework.retry.support.RetryTemplate</code>を利用する方法を説明する。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>スキップと同様に<code>&lt;retryable-exception-classes&gt;</code>で対象となる例外クラスを指定する方法もある。
しかし、<a href="#Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses">&lt;skippable-exception-classes&gt;を使わない理由について</a>と同様に
性能劣化を招く副作用があるため、Macchinetta Batch 2.xでは利用しない。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">RetryTemplate実装コード</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">RetryableAmountCheckProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPerformanceDetail&gt; {

    <span class="comment">// omitted.</span>

    <span class="comment">// (1)</span>
    <span class="directive">private</span> RetryPolicy retryPolicy;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPerformanceDetail process(SalesPerformanceDetail item)
            <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// (2)</span>
        RetryTemplate rt = <span class="keyword">new</span> RetryTemplate();
        <span class="keyword">if</span> (retryPolicy != <span class="predefined-constant">null</span>) {
            rt.setRetryPolicy(retryPolicy);
        }

        <span class="keyword">try</span> {
            <span class="comment">// (3)</span>
            rt.execute(<span class="keyword">new</span> RetryCallback&lt;SalesPerformanceDetail, <span class="exception">Exception</span>&gt;() {
                <span class="annotation">@Override</span>
                <span class="directive">public</span> SalesPerformanceDetail doWithRetry(RetryContext context) <span class="directive">throws</span> <span class="exception">Exception</span> {
                    logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">execute with retry. [retry-count:{}]</span><span class="delimiter">&quot;</span></span>, context.getRetryCount());
                    <span class="comment">// retry mocking</span>
                    <span class="keyword">if</span> (context.getRetryCount() == adjustTimes) {
                        item.setAmount(item.getAmount().divide(<span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">10</span>)));
                    }
                    checkAmount(item.getAmount(), amountLimit);
                    <span class="keyword">return</span> <span class="predefined-constant">null</span>;
                }
            });
        } <span class="keyword">catch</span> (<span class="exception">ArithmeticException</span> ae) {
            <span class="comment">// (4)</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">check error at processor.</span><span class="delimiter">&quot;</span></span>, ae);
        }
        <span class="keyword">return</span> item;
    }

    <span class="directive">public</span> <span class="type">void</span> setRetryPolicy(RetryPolicy retryPolicy) {
        <span class="local-variable">this</span>.retryPolicy = retryPolicy;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch06.exceptionhandling.RetryableAmountCheckProcessor</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:retryPolicy-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retryPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>

<span class="comment">&lt;!-- (6) (7) (8)--&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retryPolicy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.retry.policy.SimpleRetryPolicy</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:maxAttempts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:retryableExceptions-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exceptionMap</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (9) --&gt;</span>
<span class="tag">&lt;util:map</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exceptionMap</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.ArithmeticException</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/util:map&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfWithRetryPolicy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfWithRetryPolicy.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リトライ条件を格納する</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RetryTemplateのインスタンスを作成する。<br>
デフォルトは、リトライ回数=3、すべての例外がリトライ対象である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>RetryTemplate#execute</code>メソッドで、リトライを行いたいビジネスロジックを実行するようにする。 <br>
ビジネスロジック全体ではなく、リトライしたい部分のみを<code>RetryTemplate#execute</code>メソッドで実行するようにする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リトライ回数が規定回数を超えた場合の例外ハンドリング。<br>
ビジネスロジックで発生する例外がそのままスローされてくる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)で定義するリトライ条件を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リトライ条件を、<code>org.springframework.retry.RetryPolicy</code>を実装したクラスで定義する。<br>
この例では、Spring Batchから提供されている<code>SimpleRetryPolicy</code>を利用している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンストラクタ引数の<code>maxAttempts</code>にリトライ回数の指定をする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンストラクタ引数の<code>retryableExceptions</code>に(9)で定義するリトライ対象の例外を定義したマップを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">キーにリトライ対象の例外クラス、値に真偽値を設定したマップを定義する。<br>
真偽値が<code>true</code>であれば、リトライ対象の例外となる。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Interruption"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Interruption"></a>6.2.2.3.3. 処理中断</h6>
<div class="paragraph">
<p>ステップ実行を打ち切りたい場合、スキップ・リトライ対象以外のRuntimeExceptionもしくはそのサブクラスをスローする。</p>
</div>
<div class="paragraph">
<p>スキップの実装例を<a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip_Chunk_LimitCheckingItemSkipPolicy">LimitCheckingItemSkipPolicy</a>を元に示す。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtValidSkipReadError</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtValidSkipReadError.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">skip-limit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:skippable-exception-classes&gt;</span>
                    <span class="comment">&lt;!-- (1) --&gt;</span>
                    <span class="tag">&lt;batch:include</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.validator.ValidationException</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/batch:skippable-exception-classes&gt;</span>
            <span class="tag">&lt;/batch:chunk&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ValidationException</code>以外の例外が発生すれば処理が中断される。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>リトライの実装例を<a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Retry">リトライ</a>を元に示す。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retryPolicy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.retry.policy.SimpleRetryPolicy</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:maxAttempts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:retryableExceptions-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exceptionMap</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;util:map</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exceptionMap</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.UnsupportedOperationException</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/util:map&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfWithRetryPolicy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfWithRetryPolicy.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UnsupportedOperationException</code>以外の例外が発生すれば処理が中断される。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch06_ExceptionHandling_Appendix"><a class="anchor" href="#Ch06_ExceptionHandling_Appendix"></a>6.2.3. Appendix</h4>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses"><a class="anchor" href="#Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses"></a>6.2.3.1. &lt;skippable-exception-classes&gt;を使わない理由について</h5>
<div class="paragraph">
<p>Spring Batchでは、ジョブ全体を対象としてスキップする例外を指定し、例外が発生したアイテムへの処理をスキップして処理を継続させる機能を提供している。</p>
</div>
<div class="paragraph">
<p>その機能は、以下のように<code>&lt;chunk&gt;</code>タグ配下に<code>&lt;skippable-exception-classes&gt;</code>タグを設定し、スキップ対象の例外を指定する形で実装する。</p>
</div>
<div class="listingblock">
<div class="title">&lt;skippable-exception-classes&gt;の使用例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flowJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retryStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tasklet&gt;</span>
            <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemProcessor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">skip-limit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;skippable-exception-classes&gt;</span>
                    <span class="comment">&lt;!-- specify exceptions to the skipped --&gt;</span>
                    <span class="tag">&lt;include</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Exception</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;exclude</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.NullPointerException</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/skippable-exception-classes&gt;</span>
            <span class="tag">&lt;/chunk&gt;</span>
        <span class="tag">&lt;/tasklet&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>この機能を利用することによって、入力チェックエラーが発生したレコードをスキップして後続データの処理を継続することは可能だが、
Macchinetta Batch 2.xでは以下の理由により使用しない。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;skippable-exception-classes&gt;</code>タグを利用して例外をスキップした場合、
1つのチャンクに含まれるデータ件数が変動するため、性能劣化を引き起こす可能性がある。</p>
<div class="ulist">
<ul>
<li>
<p>これは、例外の発生箇所(<code>ItemReader</code>/<code>ItemProcessor</code>/<code>ItemWriter</code>)によって変わる。詳細は後述する。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">&lt;skippable-exception-classes&gt;を定義せずにSkipPolicyを利用することは必ず避ける</div>
<div class="paragraph">
<p>暗黙的にすべての例外が登録された状況になり、性能劣化の可能性が飛躍的に高まる。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>例外発生箇所(<code>ItemReader</code>/<code>ItemProcessor</code>/<code>ItemWriter</code>)ごとの挙動についてそれぞれ説明する。<br>
なお、トランザクションの動作は例外の発生箇所によらず、例外が発生した場合は必ずロールバックした後、再度処理される。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ItemReaderで例外が発生した場合</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>ItemReader</code>の処理内で例外が発生した場合は、次のitemへ処理対象が移る。</p>
</li>
<li>
<p>これによる副作用はない</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">ItemProcessorで例外が発生した場合</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>ItemProcessor</code>の処理内で例外が発生した場合は、チャンクの最初に戻り1件目から再処理する。</p>
</li>
<li>
<p>再処理の対象にスキップされるitemは含まれない。</p>
</li>
<li>
<p>1度目の処理と再処理時のチャンクサイズは変わらない。</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">ItemWriterで例外が発生した場合</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>ItemWriter</code>の処理内で例外が発生した場合は、チャンクの最初に戻り1件目から再処理する。</p>
</li>
<li>
<p>再処理は<code>ChunkSize=1</code>に固定し、1件ずつ実行される。</p>
</li>
<li>
<p>再処理対象にスキップされるitemも含まれる。</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>ItemProcessor</code>にて例外が発生した場合、<code>ChunkSize=1000</code>の場合を例に考えると、
1000件目で例外が発生すると1件目から再処理が行われ、合計で1999件分の処理が実行されてしまう。</p>
</div>
<div class="paragraph">
<p><code>ItemWriter</code>にて例外が発生した場合、<code>ChunkSize=1</code>に固定し再処理される。
仮に<code>ChunkSize=1000</code>の場合を例に考えると、
本来1回のトランザクションにも関わらず1000回のトランザクションに分割し処理されてしまう。</p>
</div>
<div class="paragraph">
<p>これらはジョブ全体の処理時間が長期化することを意味し、異常時に状況を悪化させる可能性が高い。
また、二重処理すること自体が問題化する可能性を秘めており、設計製造に追加の考慮事項を産む。</p>
</div>
<div class="paragraph">
<p>よって、<code>&lt;skippable-exception-classes&gt;</code>を使用することは推奨しない。
<code>ItemReader</code>でエラーになったデータをスキップすることはこれらの問題を引き起こさないが、
事故を未然に防ぐためには基本的に避けるようにし、どうしても必要な場合に限定的に適用すること。</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch06_RerunRestart"><a class="anchor" href="#Ch06_RerunRestart"></a>6.3. 処理の再実行</h3>
<div class="sect3">
<h4 id="Ch06_RerunRestart_Overview"><a class="anchor" href="#Ch06_RerunRestart_Overview"></a>6.3.1. Overview</h4>
<div class="paragraph">
<p>障害発生などに起因してジョブが異常終了した後に、ジョブを再実行することで回復する手段について説明する。</p>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで使い方が異なるため、それぞれについて説明する。</p>
</div>
<div class="paragraph">
<p>ジョブの再実行には、以下の方法がある。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ジョブのリラン</p>
</li>
<li>
<p>ジョブのリスタート</p>
<div class="ulist">
<ul>
<li>
<p>ステートレスリスタート</p>
<div class="ulist">
<ul>
<li>
<p>件数ベースリスタート</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステートフルリスタート</p>
<div class="ulist">
<ul>
<li>
<p>処理状態を判断し、未処理のデータを抽出して処理するリスタート</p>
<div class="ulist">
<ul>
<li>
<p>処理状態を識別するための処理を別途実装する必要がある</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>以下に用語を定義する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">リラン</dt>
<dd>
<p>ジョブを最初からやり直すこと。<br>
事前作業として、データ初期化など障害発生前のジョブ開始時点に状態を回復する必要がある。</p>
</dd>
<dt class="hdlist1">リスタート</dt>
<dd>
<p>ジョブが中断した箇所から処理を再開すること。<br>
処理再開位置の保持・取得方法、再開位置までのデータスキップ方法などをあらかじめ設計/実装する必要がある。<br>
リスタートには、ステートレスとステートフルの2種類がある。</p>
</dd>
<dt class="hdlist1">ステートレスリスタート</dt>
<dd>
<p>個々の入力データに対する状態(未処理/処理済)を考慮しないリスタート方法。</p>
</dd>
<dt class="hdlist1">件数ベースリスタート</dt>
<dd>
<p>ステートレスリスタートの1つ。<br>
処理した入力データ件数を保持し、リスタート時にその件数分入力データをスキップする方法。<br>
出力が非トランザクショナルなリソースの場合は、出力位置を保持し、リスタート時にその位置まで書き込み位置を移動することも必要になる。</p>
</dd>
<dt class="hdlist1">ステートフルリスタート</dt>
<dd>
<p>個々の入力データに対する状態(未処理/処理済)を判断し、未処理のデータのみを取得条件とするリスタート方法。<br>
出力が非トランザクショナルなリソースの場合は、リソースを追記可能にして、リスタート時には前回の結果へ追記していくようにする。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>一般的に、再実行の方法はリランがもっとも簡単である。
リラン &lt; ステートレスリスタート &lt; ステートフルリスタートの順に、設計や実装が難しくなる。
無論、可能であれば常にリランとすることが好ましいが、
ユーザが実装するジョブ1つ1つに対して、許容するバッチウィンドウや処理特性に応じてどの方法を適用するか検討してほしい。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch06_RerunRestart_HowToUse"><a class="anchor" href="#Ch06_RerunRestart_HowToUse"></a>6.3.2. How to use</h4>
<div class="paragraph">
<p>リランとリスタートの実現方法について説明する。</p>
</div>
<div class="sect4">
<h5 id="Ch06_RerunRestart_HowToUse_Rerun"><a class="anchor" href="#Ch06_RerunRestart_HowToUse_Rerun"></a>6.3.2.1. ジョブのリラン</h5>
<div class="paragraph">
<p>ジョブのリランを実現する方法を説明する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>リラン前にデータの初期化などデータ回復の事前作業を実施する。</p>
</li>
<li>
<p>失敗したジョブを同じ条件(同じパラメータ)で再度実行する。</p>
<div class="ulist">
<ul>
<li>
<p>Spring Batchでは同じパラメータでジョブを実行すると二重実行と扱われるが、Macchinetta Batch 2.xでは別ジョブとして扱う。<br>
詳細は、<a href="#Ch04_JobParameter_HowToUse_Converter">"パラメータ変換クラスについて"</a>を参照のこと。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_RerunRestart_HowToUse_Restart"><a class="anchor" href="#Ch06_RerunRestart_HowToUse_Restart"></a>6.3.2.2. ジョブのリスタート</h5>
<div class="paragraph">
<p>ジョブのリスタート方法を説明する。</p>
</div>
<div class="paragraph">
<p>ジョブのリスタートを行う場合は、同期実行したジョブに対して行うことを基本とする。</p>
</div>
<div class="paragraph">
<p>非同期実行したジョブは、リスタートではなくリランで対応するジョブ設計にすることを推奨する。
これは、<strong>「意図したリスタート実行」</strong>なのか<strong>「意図しない重複実行」</strong>であるかの判断が難しく、
運用で混乱をきたす可能性があるからである。</p>
</div>
<div class="paragraph">
<p>非同期実行ジョブでリスタート要件がどうしても外せない場合は、
<strong>「意図したリスタート実行」</strong>を明確にするために、以下の方法を利用できる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CommandLineJobRunner</code>の<code>-restart</code>によるリスタート</p>
<div class="ulist">
<ul>
<li>
<p>非同期実行したジョブを別途同期実行によりリスタートする。逐次で回復処理を進めていく際に有効となる。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>JobOperator#restart(JobExecutionId)</code>によるリスタート</p>
<div class="ulist">
<ul>
<li>
<p>非同期実行したジョブを、再度非同期実行の仕組み上でリスタートする。一括で回復処理を進めていく際に有効となる。</p>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch04_AsyncJobWithDB">非同期実行(DBポーリング)</a>はリスタートをサポートしていない。そのため、別途ユーザにて実装する必要がある。</p>
</li>
<li>
<p><a href="#Ch04_AsyncJobWithWeb">非同期実行(Webコンテナ)</a>はリスタートの実現方法をガイドしている。この記述にしたがって、ユーザにて実装すること。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">入力チェックがある場合のリスタートについて</div>
<div class="paragraph">
<p>入力チェックエラーは、チェックエラーの原因となる入力リソースを修正しない限り回復不可能である。
参考までに、入力チェックエラーが発生した際の入力リソース修正例を以下に示す。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>入力チェックエラーが発生した場合は、対象データが特定できるようにログ出力を行う。</p>
</li>
<li>
<p>出力されたログ情報にもとづいて、入力データの修正を行う。</p>
<div class="ulist">
<ul>
<li>
<p>入力データの順番が変わらないようにする。</p>
</li>
<li>
<p>修正方法は入力リソースの生成方法により対応が異なる。</p>
<div class="ulist">
<ul>
<li>
<p>手動で修正</p>
</li>
<li>
<p>ジョブなどで再作成</p>
</li>
<li>
<p>連携元からの再送</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>修正した入力データを配備して、リスタートを実行する。</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">多重処理(Partition Step)の場合について</div>
<div class="paragraph">
<p><a href="#Ch08_ParallelAndMultiple_HowToUse_Partitioning">"多重処理(Partition Step)"</a>でリスタートする場合、
再び<strong>分割処理から</strong>処理が実施される。
データを分割した結果、すべて処理済みであった場合、無駄な分割処理が行われ<code>JobRepository</code>上には記録されるが、
これによるデータ不整合などの問題は発生しない。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_RerunRestart_HowToUse_StatelessRestart"><a class="anchor" href="#Ch06_RerunRestart_HowToUse_StatelessRestart"></a>6.3.2.3. ステートレスリスタート</h5>
<div class="paragraph">
<p>ステートレスリスタートを実現する方法を説明する。</p>
</div>
<div class="paragraph">
<p>Macchinetta Batch 2.xでのステートレスリスタートは、件数ベースのリスタートを指す。これは、Spring Batchの仕組みをそのまま利用することで実現する。<br>
件数ベースのリスタートは、チャンクモデルのジョブ実行で使用できる。
また、件数ベースのリスタートは、<code>JobRepository</code>に登録される入出力に関するコンテキスト情報を利用する。
よって、件数ベースのリスタートでは、<code>JobRepository</code>はインメモリデータベースではなく、永続性が担保されているデータベースを使用することを前提とする。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">JobRepositoryの障害発生時について</div>
<div class="paragraph">
<p><code>JobRepository</code>への更新は、ユーザが使用するデータベースのトランザクションとは独立したトランザクションで行われる。
つまり、業務処理に対する障害のみがリカバリ対象となる。
これは、<code>JobRepository</code>に障害が発生した場合は実際の処理件数とずれる可能性があり、
リスタート時に二重処理の危険性があることを意味する。
よって、<code>JobRepository</code>の可用性を検討したり、次点の方法としてリランの方法を検討しておいたりといった、
障害時の対処方法を検討する必要がある。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">リスタート時の入力</dt>
<dd>
<p>Spring Batchが提供しているItemReaderのほとんどが件数ベースのリスタートに対応しているため、特別な対応は不要である。<br>
件数ベースのリスタート可能なItemReaderを自作する場合は、リスタート処理が実装されている以下の抽象クラスを拡張すればよい。</p>
<div class="dlist">
<dl>
<dt class="hdlist1"></dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.item.support.AbstractItemCountingItemStreamItemReader</code></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1"></dt>
<dd>
<p>件数ベースリスタートは、あくまで件数のみを基準としてリスタート開始点を決定するため、入力データの変更/追加/削除を検出することができない。
ジョブが異常終了した後、回復するために入力データを補正することはしばしばあるが、
以下のようなデータの変更を行った場合は、ジョブが正常終了した結果と、ジョブが異常終了した後リスタートして回復できた結果、
の間で出力に差が出るため注意すること。</p>
<div class="dlist">
<dl>
<dt class="hdlist1"></dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>データの取得順を変更する</p>
<div class="ulist">
<ul>
<li>
<p>リスタート時に、重複処理や未処理となるデータが発生してしまい、リランした結果と異なる回復結果になるため、決して行ってはいけない。</p>
</li>
</ul>
</div>
</li>
<li>
<p>処理済みデータを更新する</p>
<div class="ulist">
<ul>
<li>
<p>リスタート時に更新したデータは読み飛ばされるので、リランした結果とリスタートした結果で回復結果が変わるため好ましくない場合がある。</p>
</li>
</ul>
</div>
</li>
<li>
<p>未処理データを更新または追加する</p>
<div class="ulist">
<ul>
<li>
<p>リランした結果と同じ回復結果になるため許容する。ただし、初回実行で正常終了した結果とは異なる。
これは異常なデータを緊急対処的にパッチする場合や、実行時点で受領したデータを可能な限り多く処理する際に限定して使うとよい。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">リスタート時の出力</dt>
<dd>
<p>非トランザクショナルなリソースへの出力には注意が必要である。たとえば、ファイルではどの位置まで出力していたかを把握し、その位置から出力を行わなければいけない。<br>
Spring Batchが提供している<code>FlatFileItemWriter</code>は、コンテキストから前回の出力位置を取得して、リスタート時にはその位置から出力を行ため、特別な対応は不要である。<br>
トランザクショナルなリソースについては、失敗時にロールバックが行われているため、リスタート時には特に対処することなく処理を行うことができる。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>上記の条件を満たしていれば、失敗したジョブに<code>-restart</code>のオプションを付加して再度実行すればよい。
以下にジョブのリスタート例を示す。</p>
</div>
<div class="listingblock">
<div class="title">同期実行したジョブのリスタート例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># (1)
java -cp dependency/* org.springframework.batch.core.launch.support.CommandLineJobRunner &lt;jobPath&gt; &lt;jobName&gt; -restart</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">項番</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">説明</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CommandLineJobRunner</code>へ失敗したジョブと同じジョブBeanのパスとジョブ名を指定し、<code>-restart</code>を付加して実行する。<br>
ジョブパラメータは、<code>JobRepository</code>から復元されるため指定は不要。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>非同期実行(DBポーリング)で実行したジョブのリスタート例を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">非同期実行(DBポーリング)で実行したジョブのリスタート例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># (1)
java -cp dependency/* org.springframework.batch.core.launch.support.CommandLineJobRunner &lt;JobExecutionId&gt; -restart</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">項番</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">説明</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CommandLineJobRunner</code>へ失敗したジョブと同じジョブ実行ID(JobExecutionId)を指定し、<code>-restart</code>を付加して実行する。<br>
ジョブパラメータは、<code>JobRepository</code>から復元されるため指定は不要。</p>
<p class="tableblock">ジョブ実行IDは、ジョブ要求テーブルから取得することができる。
ジョブ要求テーブルについては、<a href="#Ch04_AsyncJobWithDB_Arch_RequireTable">"ポーリングするテーブルについて"</a>を参照。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">ジョブ実行IDのログ出力</div>
<div class="paragraph">
<p>異常終了したジョブのジョブ実行IDを迅速に特定するため、
ジョブ終了時や例外発生時にジョブ実行IDをログ出力するリスナーや例外ハンドリングクラスを実装することを推奨する。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>非同期実行(Webコンテナ)でのリスタート例を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">非同期実行(Webコンテナ)で実行したジョブのリスタート例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">long</span> restart(<span class="type">long</span> JobExecutionId) <span class="directive">throws</span> Execption {
  <span class="keyword">return</span> jobOperator.restart(JobExecutionId); <span class="comment">// (1)</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">項番</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">説明</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobOperator</code>へ失敗したジョブと同じジョブ実行ID(JobExecutionId)を指定し、<code>restart</code>メソッドで実行する。<br>
ジョブパラメータは、<code>JobRepository</code>から復元される。</p>
<p class="tableblock">ジョブ実行IDは、WebAPでジョブ実行した際に取得したIDを利用するか、<code>JobRepository</code>から取得することができる。
取得方法は、<a href="#Ch07_JobManagement_HowToUse_JobStatusManagement">"ジョブの状態管理"</a>を参照。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch06_RerunRestart_HowToUse_StatefullRestart"><a class="anchor" href="#Ch06_RerunRestart_HowToUse_StatefullRestart"></a>6.3.2.4. ステートフルリスタート</h5>
<div class="paragraph">
<p>ステートフルリスタートを実現する方法を説明する。</p>
</div>
<div class="paragraph">
<p>ステートフルリスタートとは、実行時に入出力結果を付きあわせて未処理データだけ取得することで再処理する方法である。
この方法は、状態保持･未処理判定など設計が難しいが、データの変更に強い特徴があるため、時々用いられることがある。</p>
</div>
<div class="paragraph">
<p>ステートフルリスタートでは、リスタート条件を入出力リソースから判定するため、<code>JobRepository</code>の永続化は不要となる。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">リスタート時の入力</dt>
<dd>
<p>入出力結果を付きあわせて未処理データだけ取得するロジックを実装したItemReaderを用意する。</p>
</dd>
<dt class="hdlist1">リスタート時の出力</dt>
<dd>
<p><a href="#Ch06_RerunRestart_HowToUse_StatelessRestart">ステートレスリスタート</a>と同様に非トランザクショナルなリソースへ出力には注意が必要になる。<br>
ファイルの場合、コンテキストを使用しないことを前提にすると、ファイルの追記を許可するような設計が必要になる。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>ステートフルリスタートは、<a href="#Ch06_RerunRestart_HowToUse_Rerun">ジョブのリラン</a>と同様に失敗時のジョブと同じ条件でジョブを再実行する。<br>
ステートレスリスタートとは異なり、<code>-restart</code>のオプションは使用しない。</p>
</div>
<div class="paragraph">
<p>簡単ステートフルなリスタートの実現例を下記に示す。</p>
</div>
<div class="olist arabic">
<div class="title">処理仕様</div>
<ol class="arabic">
<li>
<p>入力対象のテーブルに処理済カラムを定義し、処理が成功したらNULL以外の値で更新する。</p>
<div class="ulist">
<ul>
<li>
<p>未処理データの抽出条件は、処理済カラムの値がNULLとなる。</p>
</li>
</ul>
</div>
</li>
<li>
<p>処理結果をファイルに出力する。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">RestartOnConditionRepository.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findByProcessedIsNull</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    SELECT
        branch_id AS branchId, year, month, customer_id AS customerId, amount
    FROM
        sales_plan_detail
    WHERE
        processed IS NULL
    ORDER BY
        branch_id ASC, year ASC, month ASC, customer_id ASC
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/select&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;update</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">update</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    UPDATE
        sales_plan_detail
    SET
        processed = '1'
    WHERE
        branch_id = #{branchId}
    AND
        year = #{year}
    AND
        month = #{month}
    AND
        customer_id = #{customerId}
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/update&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">restartOnConditionBasisJob.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch06.reprocessing.repository.RestartOnConditionRepository.findByZeroOrLessAmount</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dbWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch06.reprocessing.repository.RestartOnConditionRepository.update</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>
<span class="comment">&lt;!-- (6) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">compositeWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.CompositeItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegates</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileWriter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dbWriter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">restartOnConditionBasisJob</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restartable</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (7) --&gt;</span>

    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">restartOnConditionBasisJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountUpdateItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">compositeWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>

<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">リスタートのコマンド実行例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># (8)
java -cp dependency/* org.springframework.batch.core.launch.support.CommandLineJobRunner &lt;jobPath&gt; &lt;jobName&gt; &lt;jobParameters&gt; ...</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理済カラムがNULLのデータのみ抽出するようにSQLを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理済カラムをNULL以外で更新するSQLを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReaderには、(1)で定義したSQLIDを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データベースへ更新は、(2)で定義したSQLIDを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リスタート時に前回中断箇所から書き込み可能にするため、ファイルの追記を許可する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイル出力 &#8594; データベース更新の順序で処理されるように<code>CompositeItemWriter</code>を定し、chunkのwriterに設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">必須ではないが、誤って<code>-restart</code>オプションをつけて起動された場合にエラーになるように<code>restartable</code>属性をfalseに設定しておく。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">失敗したジョブの実行条件で再度実行を行う。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">ジョブのrestartable属性について</div>
<div class="paragraph">
<p><code>restartable</code>がtrueの場合、<a href="#Ch06_RerunRestart_HowToUse_StatelessRestart">ステートレスリスタート</a>で説明したとおり、コンテキスト情報を使い入出力データの読み飛ばしを行う。
ステートフルリスタートでSpring Batch提供のItemReaderやItemWriterを使用している場合、この動作により期待した処理が行われなくなる可能性がある。
そのため、<code>restartable</code>をfalseにすることで、<code>-restart</code>オプションによる起動はエラーとなり、誤動作を防止することができる。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch07_JobManagement"><a class="anchor" href="#Ch07_JobManagement"></a>7. ジョブの管理</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch07_JobManagement_Overview"><a class="anchor" href="#Ch07_JobManagement_Overview"></a>7.1. Overview</h3>
<div class="paragraph">
<p>ジョブの実行を管理する方法について説明する。</p>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで同じ使い方になる。</p>
</div>
<div class="sect3">
<h4 id="Ch07_JobManagement_Overview_JobExecutionManagement"><a class="anchor" href="#Ch07_JobManagement_Overview_JobExecutionManagement"></a>7.1.1. ジョブの実行管理とは</h4>
<div class="paragraph">
<p>ジョブの起動状態や実行結果を記録しバッチシステムを維持することを指す。
特に、異常発生時の検知や次に行うべき行動(異常終了後のリラン・リスタート等)を判断するために、必要な情報を確保することが重要である。<br>
バッチアプリケーションの特性上、起動直後にその結果をユーザインターフェースで確認できることは稀である。
よって、ジョブスケジューラ/RDBMS/アプリケーションログといった、ジョブの実行とは別に実行状態・結果の記録を行う仕組みが必要となる。</p>
</div>
<div class="sect4">
<h5 id="Ch07_JobManagement_Overview_JobExecutionManagement_Function"><a class="anchor" href="#Ch07_JobManagement_Overview_JobExecutionManagement_Function"></a>7.1.1.1. Spring Batch が提供する機能</h5>
<div class="paragraph">
<p>Spring Batchは、ジョブの実行管理向けに以下のインターフェースを提供している。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">ジョブの管理機能一覧</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">機能</th>
<th class="tableblock halign-left valign-top">対応するインターフェース</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの実行状態・結果の記録</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.core.repository.JobRepository</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの終了コードとプロセス終了コードの変換</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.core.launch.support.ExitCodeMapper</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Spring Batch はジョブの起動状態・実行結果の記録に<code>JobRepository</code>を使用する。
Macchinetta Batch 2.xでは、以下のすべてに該当する場合は永続化は任意としてよい。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>同期型ジョブ実行のみでMacchinetta Batch 2.xを使用する。</p>
</li>
<li>
<p>ジョブの停止・リスタートを含め、ジョブの実行管理はすべてジョブスケジューラに委ねる。</p>
<div class="ulist">
<ul>
<li>
<p>Spring Batchがもつ<code>JobRepository</code>を前提としたリスタートを利用しない。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>これらに該当する場合は<code>JobRepository</code>が使用するRDBMSの選択肢として、インメモリ・組み込み型データベースである<code>H2</code>を利用する。<br>
一方で非同期実行を利用する場合や、Spring Batchの停止・リスタートを活用する場合は、ジョブの実行状態・結果を永続化可能なRDBMSが必要となる。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">デフォルトのトランザクション分離レベル</div>
<div class="paragraph">
<p>Spring Batchが提供するxsdでは、<code>JobRepository</code>のトランザクション分離レベルは<code>SERIALIZABLE</code>をデフォルト値としている。
しかし、この場合、同期/非同期にかかわらず複数のジョブを同時に実行した際に<code>JobRepository</code>の更新で例外が発生してしまう。
そのため、Macchinetta Batch 2.xでは、あらかじめ<code>JobRepository</code>のトランザクション分離レベルを<code>READ_COMMITTED</code>に設定している。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">インメモリJobRepositoryの選択肢</div>
<div class="paragraph">
<p>Spring Batch にはインメモリでジョブの実行管理を行う
<code>org.springframework.batch.core.repository.support.MapJobRepositoryFactoryBean</code>
が用意されているが、本ガイドラインでは使用しない。<br>
このクラスのJavadocにあるとおり、
<code>This repository is only really intended for use in testing and rapid prototyping.</code>
とテスト用であることが示されており、また、
<code>Not suited for use in multi-threaded jobs with splits</code>
と並列処理には不適切であると示されているためである。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ジョブスケジューラを使用したジョブの実行管理については各製品のマニュアルを参照のこと。<br>
本ガイドラインではMacchinetta Batch 2.x内部で<code>JobRepository</code>を用いたジョブの状態を管理するうえで関連する、
以下の項目について説明する。</p>
</div>
<div class="ulist">
<div class="title">Macchinetta Batch内部での状態管理に関する項目</div>
<ul>
<li>
<p><a href="#Ch07_JobManagement_HowToUse_JobStatusManagement">ジョブの状態管理</a></p>
<div class="ulist">
<ul>
<li>
<p>状態を永続化する方法</p>
</li>
<li>
<p>状態を確認する方法</p>
</li>
<li>
<p>ジョブを手動停止する方法</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch07_JobManagement_HowToUse_ExitCode">終了コードのカスタマイズ</a></p>
</li>
<li>
<p><a href="#Ch07_JobManagement_HowToUse_DuplicateSafe">二重起動防止</a></p>
</li>
<li>
<p><a href="#Ch07_JobManagement_HowToUse_Logging">ロギング</a></p>
</li>
<li>
<p><a href="#Ch07_JobManagement_HowToUse_MessageManagement">メッセージ管理</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch07_JobManagement_HowToUse"><a class="anchor" href="#Ch07_JobManagement_HowToUse"></a>7.2. How to use</h3>
<div class="paragraph">
<p><code>JobRepository</code>はSpring BatchによりRDBMSへ自動的に新規登録・更新を行う。<br>
ジョブの状態・実行結果の確認を行う場合は、意図しない変更処理がバッチアプリケーションの内外から行われることのないよう、以下のいずれかの方法を選択する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch07_JobManagement_HowToUse_JobStatusManagement">ジョブの状態管理</a>に関するテーブルに対しクエリを発行する</p>
</li>
<li>
<p><code>org.springframework.batch.core.explore.JobExplorer</code>を使用する</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="Ch07_JobManagement_HowToUse_JobStatusManagement"><a class="anchor" href="#Ch07_JobManagement_HowToUse_JobStatusManagement"></a>7.2.1. ジョブの状態管理</h4>
<div class="paragraph">
<p><code>JobRepository</code>を用いたジョブの状態管理方法を説明する。<br>
Spring Batchにより、以下のEntityがRDBMSのテーブルに登録される。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">JobRepositoryで管理されるEntityクラスとテーブル名</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">Entityクラス</th>
<th class="tableblock halign-left valign-top">テーブル名</th>
<th class="tableblock halign-left valign-top">生成単位</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecution</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BATCH_JOB_EXECUTION</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1回のジョブ実行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの状態・実行結果を保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecutionContext</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BATCH_JOB_EXECUTION_CONTEXT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1回のジョブ実行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ内部のコンテキストを保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecutionParams</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BATCH_JOB_EXECUTION_PARAMS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1回のジョブ実行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">起動時に与えられたジョブパラメータを保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BATCH_STEP_EXECUTION</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1回のステップ実行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの状態・実行結果、コミット・ロールバック件数を保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecutionContext</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BATCH_STEP_EXECUTION_CONTEXT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1回のステップ実行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップ内部のコンテキストを保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobInstance</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BATCH_JOB_INSTANCE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ名とジョブパラメータの組み合わせ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブ名、およびジョブパラメータをシリアライズした文字列を保持する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>たとえば、1回のジョブ起動で3つのステップを実行した場合、以下の差が生じる</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JobExecution</code>、<code>JobExecutionContext</code>、<code>JobExecutionParams</code>は1レコード登録される</p>
</li>
<li>
<p><code>StepExecution</code>、<code>StepExecutionContext</code>は3レコード登録される</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>また、<code>JobInstance</code>は過去に起動した同名ジョブ・同一パラメータよる二重実行を抑止するために使用されるが、
Macchinetta Batch 2.xではこのチェックを行わない。詳細は<a href="#Ch07_JobManagement_HowToUse_DuplicateSafe">二重起動防止</a>を参照。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>JobRepository</code>による各テーブルの構成は、
<a href="#Ch02_SpringBatchArch">Spring Batchのアーキテクチャ</a>にて説明している。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">チャンク方式におけるStepExecutionの件数項目について</div>
<div class="paragraph">
<p>以下のように、不整合が発生しているように見えるが、仕様上妥当なケースがある。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>StepExecution(BATCH_STEP_EXECUTIONテーブル)</code>のトランザクション発行回数が入力データ件数と一致しない場合がある。</p>
<div class="ulist">
<ul>
<li>
<p>トランザクション発行回数は<code>BATCH_STEP_EXECUTION</code>の<code>COMMIT_COUNT</code>と<code>ROLLBACK_COUNT</code>の総和を指す。<br>
ただし、入力データ件数がチャンクサイズで割り切れる場合<code>COMMIT_COUNT</code>が+1となる。<br>
これは入力データ件数分を読み込んだ後、終端を表すnullも入力データとカウントされて空処理されるためである。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>BATCH_STEP_EXECUTION</code>と<code>BATCH_STEP_EXECUTION_CONTEXT</code>の処理件数が異なることがある。</p>
<div class="ulist">
<ul>
<li>
<p><code>BATCH_STEP_EXECUTION</code>テーブルの<code>READ_COUNT</code>、<code>WRITE_COUNT</code>はそれぞれ<code>ItemReader</code>、<code>ItemWriter</code>による読み込み・書き込みを行った件数が記録される。</p>
</li>
<li>
<p><code>BATCH_STEP_EXECUTION_CONTEXT</code>テーブルの<code>SHORT_CONTEXT</code>カラムはJSON形式で
<code>ItemReader</code>による読み込み処理件数が記録される。しかし、必ずしも<code>BATCH_STEP_EXECUTION</code>による処理件数と一致しない。<br></p>
</li>
<li>
<p>これはチャンク方式による<code>BATCH_STEP_EXECUTION</code>テーブルが成功・失敗を問わず読み込み・書き込み件数を記録するのに対し、
<code>BATCH_STEP_EXECUTION_CONTEXT</code>テーブルは処理途中で失敗した場合のリスタートで再開される位置として記録するためである。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="Ch07_JobManagement_HowToUse_JobStatusManagement_Persistence"><a class="anchor" href="#Ch07_JobManagement_HowToUse_JobStatusManagement_Persistence"></a>7.2.1.1. 状態の永続化</h5>
<div class="paragraph">
<p>外部RDBMSを使用することで<code>JobRepository</code>によるジョブの実行管理情報を永続化させることができる。
batch-application.propertiesの以下項目を外部RDBMS向けのデータソース、スキーマ設定となるよう修正する。</p>
</div>
<div class="listingblock">
<div class="title">batch-application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># (1)
# Admin DataSource settings.
admin.jdbc.driver=org.postgresql.Driver
admin.jdbc.url=jdbc:postgresql://serverhost:5432/admin
admin.jdbc.username=postgres
admin.jdbc.password=postgres

# (2)
spring-batch.schema.script=classpath:org/springframework/batch/core/schema-postgresql.sql</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧(PostgreSQL)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">接頭辞<code>admin</code>が付与されているプロパティの値として、接続する外部RDBMSの設定をそれぞれ記述する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">アプリケーション起動時に<code>JobRepository</code>としてスキーマの自動生成を行うスクリプトファイルを指定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">管理用/業務用データソースの補足</div>
<div class="ulist">
<ul>
<li>
<p>データベースへの接続設定は、管理用と業務用データソースとして別々に定義する。<br>
Macchinetta Batch 2.xでは別々に定義した上で、
<code>JobRepository</code>は、プロパティ接頭辞に<code>admin</code>が付与された管理用データソースを使用するよう設定済みである。</p>
</li>
<li>
<p>非同期実行(DBポーリング)を使用する場合は、ジョブ要求テーブルも同じ管理用データソース、スキーマ生成スクリプトを指定すること。<br>
詳細は<a href="#Ch04_AsyncJobWithDB">非同期実行(DBポーリング)</a>を参照。</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch07_JobManagement_HowToUse_JobStatusManagement_Retrieve"><a class="anchor" href="#Ch07_JobManagement_HowToUse_JobStatusManagement_Retrieve"></a>7.2.1.2. ジョブの状態・実行結果の確認</h5>
<div class="paragraph">
<p><code>JobRepository</code>からジョブの実行状態を確認する方法について説明する。<br>
いずれの方法も、あらかじめ確認対象のジョブ実行IDが既知であること。</p>
</div>
<div class="sect5">
<h6 id="Ch07_JobManagement_HowToUse_JobStatusManagement_Retrieve_Query"><a class="anchor" href="#Ch07_JobManagement_HowToUse_JobStatusManagement_Retrieve_Query"></a>7.2.1.2.1. クエリを直接発行する</h6>
<div class="paragraph">
<p>RDBMSコンソールを用い、<code>JobRepository</code>が永続化されたテーブルに対して直接クエリを発行する。</p>
</div>
<div class="listingblock">
<div class="title">SQLサンプル</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">admin=<span class="comment"># select JOB_EXECUTION_ID, START_TIME, END_TIME, STATUS, EXIT_CODE from BATCH_JOB_EXECUTION where JOB_EXECUTION_ID = 1;</span>
 job_execution_id |       start_time        |        end_time         |  status   | exit_code
<span class="comment">------------------+-------------------------+-------------------------+-----------+-----------</span>
                <span class="integer">1</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-14</span> <span class="integer">17</span>:<span class="integer">57</span>:<span class="float">38.486</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-14</span> <span class="integer">18</span>:<span class="integer">19</span>:<span class="float">45.421</span> | COMPLETED | COMPLETED
(<span class="integer">1</span> <span class="type">row</span>)
admin=<span class="comment"># select JOB_EXECUTION_ID, STEP_EXECUTION_ID, START_TIME, END_TIME, STATUS, EXIT_CODE from BATCH_STEP_EXECUTION where JOB_EXECUTION_ID = 1;</span>
 job_execution_id | step_execution_id |       start_time        |        end_time        |  status   | exit_code
<span class="comment">------------------+-------------------+-------------------------+------------------------+-----------+-----------</span>
                <span class="integer">1</span> |                 <span class="integer">1</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-14</span> <span class="integer">17</span>:<span class="integer">57</span>:<span class="float">38.524</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-14</span> <span class="integer">18</span>:<span class="integer">19</span>:<span class="float">45.41</span> | COMPLETED | COMPLETED
(<span class="integer">1</span> <span class="type">row</span>)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch07_JobManagement_HowToUse_JobStatusManagement_Retrieve_JobExplorer"><a class="anchor" href="#Ch07_JobManagement_HowToUse_JobStatusManagement_Retrieve_JobExplorer"></a>7.2.1.2.2. <code>JobExplorer</code>を利用する</h6>
<div class="paragraph">
<p>バッチアプリケーションと同じアプリケーションコンテキストを共有可能な環境下で、<code>JobExplorer</code>をインジェクションすることでジョブの実行状態を確認する。</p>
</div>
<div class="listingblock">
<div class="title">APIコールサンプル</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// omitted.</span>

<span class="annotation">@Inject</span>
<span class="directive">private</span> JobExplorer jobExplorer;

<span class="directive">private</span> <span class="type">void</span> monitor(<span class="type">long</span> jobExecutionId) {

    <span class="comment">// (1)</span>
    JobExecution jobExecution = jobExplorer.getJobExecution(jobExecutionId);

    <span class="comment">// (2)</span>
    <span class="predefined-type">String</span> jobName = jobExecution.getJobInstance().getJobName();
    <span class="predefined-type">Date</span> jobStartTime = jobExecution.getStartTime();
    <span class="predefined-type">Date</span> jobEndTime = jobExecution.getEndTime();
    BatchStatus jobBatchStatus = jobExecution.getStatus();
    <span class="predefined-type">String</span> jobExitCode = jobExecution.getExitStatus().getExitCode();

    <span class="comment">// omitted.</span>

    <span class="comment">// (3)</span>
    <span class="keyword">for</span> (StepExecution stepExecution : jobExecution.getStepExecutions()) {
        <span class="predefined-type">String</span> stepName = stepExecution.getStepName();
        <span class="predefined-type">Date</span> stepStartTime = stepExecution.getStartTime();
        <span class="predefined-type">Date</span> stepEndTime = stepExecution.getEndTime();
        BatchStatus stepStatus = stepExecution.getStatus();
        <span class="predefined-type">String</span> stepExitCode = stepExecution.getExitStatus().getExitCode();

        <span class="comment">// omitted.</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">設定内容の項目一覧(PostgreSQL)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">インジェクションされた<code>JobExplorer</code>からジョブ実行IDを指定し<code>JobExecution</code>を取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecution</code>によるジョブの実行結果を取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecution</code>から、ジョブ内で実行されたステップのコレクションを取得し、個々の実行結果を取得する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch07_JobManagement_HowToUse_JobStatusManagement_JobStop"><a class="anchor" href="#Ch07_JobManagement_HowToUse_JobStatusManagement_JobStop"></a>7.2.1.3. ジョブの停止</h5>
<div class="paragraph">
<p>ジョブの停止とは<code>JobRepository</code>の実行中ステータスを停止中ステータスに更新し、ステップの境界や
チャンク方式によるチャンクコミット時にジョブを停止させる機能である。<br>
リスタートと組み合わせることで、停止された位置からの処理を再開させることができる。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>リスタートの詳細は<a href="#Ch06_RerunRestart_HowToUse_Restart">"ジョブのリスタート"</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>「ジョブの停止」は仕掛かり中のジョブを直ちに中止する機能ではなく、<code>JobRepository</code>の実行中ステータスを停止中に更新する機能である。<br>
ジョブに対して即座に仕掛かり中スレッドに対して割り込みするといったような、何らかの停止処理を行うわけではない。</p>
</div>
<div class="paragraph">
<p>このため、ジョブの停止は「チャンクの切れ目など、節目となる処理が完了した際に停止するよう予約する」ことともいえる。
たとえば以下の状況下でジョブ停止を行っても、期待する動作とはならない。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>単一ステップで<code>Tasklet</code>により構成されたジョブ実行。</p>
</li>
<li>
<p>チャンク方式で、データ入力件数 &lt; <code>commit-interval</code>のとき。</p>
</li>
<li>
<p>処理内で無限ループが発生している場合。</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以下、ジョブの停止方法を説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>コマンドラインからの停止</p>
<div class="ulist">
<ul>
<li>
<p>同期型ジョブ・非同期型ジョブのどちらでも利用できる</p>
</li>
<li>
<p><code>CommandLineJobRunner</code>の<code>-stop</code>を利用する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">起動時のジョブ名を指定する方法</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    classpath:/META-INF/jobs/job01.xml job01 -stop</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>ジョブ名指定によるジョブ停止は同名のジョブが並列で起動することが少ない同期バッチ実行時に適している。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">ジョブ実行ID(jobExecutionId)を指定する方法</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    classpath:/META-INF/jobs/job01.xml 3 -stop</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>ジョブ実行ID指定によるジョブ停止は同名のジョブが並列で起動することの多い非同期バッチ実行時に適している。</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>JobExecutionIdの確認方法は<a href="#Ch07_JobManagement_HowToUse_JobStatusManagement_Retrieve">ジョブの状態・実行結果の確認</a>を参照のこと。</p>
</li>
<li>
<p>ジョブ実行IDを元にジョブ停止を行う場合は<code>JobOpertion#stop()</code>を利用してもよい。<br>
<code>JobOperation#stop()</code>を用いたジョブの停止は
<a href="#Ch04_AsyncJobWithWeb_HowToExtend_StopAndRestart">"非同期実行ジョブの停止とリスタート"</a>
を参照のこと。</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch07_JobManagement_HowToUse_ExitCode"><a class="anchor" href="#Ch07_JobManagement_HowToUse_ExitCode"></a>7.2.2. 終了コードのカスタマイズ</h4>
<div class="paragraph">
<p>同期実行によりジョブ終了時、javaプロセスの終了コードをジョブやステップの終了コードに合わせてカスタマイズできる。
javaプロセスの終了コードをカスタマイズするのに必要な作業を以下に示す。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ステップの終了コードを変更する。</p>
</li>
<li>
<p>ステップの終了コードに合わせて、ジョブの終了コードを変更する。</p>
</li>
<li>
<p>ジョブの終了コードとjavaプロセスの終了コードをマッピングする。</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">終了コードの意味合いについて</div>
<div class="paragraph">
<p>本節では、終了コードは2つの意味合いで扱われており、それぞれの説明を以下に示す。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>COMPLETED、FAILEDなどの文字列の終了コードは、ジョブやステップの終了コードである。</p>
</li>
<li>
<p>0、255などの数値の終了コードは、Javaプロセスの終了コードである。</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="Ch07_JobManagement_HowToUse_ExitCode_StepExitCode"><a class="anchor" href="#Ch07_JobManagement_HowToUse_ExitCode_StepExitCode"></a>7.2.2.1. ステップの終了コードの変更</h5>
<div class="paragraph">
<p>処理モデルごとにステップの終了コードを変更する方法を以下に示す。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンクモデルにおけるステップの終了コードの変更</dt>
<dd>
<p>ステップ終了時の処理としてStepExecutionListenerのafterStepメソッドを実装し、任意のステップの終了コードを返却する。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">StepExecutionListener実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ExitStatusChangeListener</span> <span class="directive">implements</span> StepExecutionListener {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ExitStatus afterStep(StepExecution stepExecution) {

        ExitStatus exitStatus = stepExecution.getExitStatus();
        <span class="keyword">if</span> (conditionalCheck(stepExecution)) {
            <span class="comment">// (1)</span>
            exitStatus = <span class="keyword">new</span> ExitStatus(<span class="string"><span class="delimiter">&quot;</span><span class="content">CUSTOM STEP FAILED</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="keyword">return</span> exitStatus;
    }

    <span class="directive">private</span> <span class="type">boolean</span> conditionalCheck(StepExecution stepExecution) {
        <span class="comment">// omitted.</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ジョブ定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitstatusjob.step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitStatusChangeListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:step&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">実装内容の一覧</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの実行結果に応じて独自の終了コードを設定する。</p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">タスクレットモデルにおけるステップの終了コードの変更</dt>
<dd>
<p>Taskletのexecuteメソッドの引数であるStepContributionに任意のステップの終了コードを設定する。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Tasklet実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

    <span class="comment">// omitted.</span>
    <span class="keyword">if</span> (errorCount &gt; <span class="integer">0</span>) {
        contribution.setExitStatus(<span class="keyword">new</span> ExitStatus(<span class="string"><span class="delimiter">&quot;</span><span class="content">STEP COMPLETED WITH SKIPS</span><span class="delimiter">&quot;</span></span>));  <span class="comment">// (1)</span>
    }
    <span class="keyword">return</span> RepeatStatus.FINISHED;
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">実装内容の一覧</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">タスクレットの実行結果に応じて独自の終了コードを設定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch07_JobManagement_HowToUse_ExitCode_JobExitCode"><a class="anchor" href="#Ch07_JobManagement_HowToUse_ExitCode_JobExitCode"></a>7.2.2.2. ジョブの終了コードの変更</h5>
<div class="paragraph">
<p>ジョブ終了時の処理としてJobExecutionListenerのafterJobメソッドを実装し、最終的なジョブの終了コードを各ステップの終了コードによって設定する。</p>
</div>
<div class="listingblock">
<div class="title">JobExecutionListener実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobExitCodeChangeListener</span> <span class="directive">extends</span> JobExecutionListenerSupport {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterJob(JobExecution jobExecution) {
        <span class="comment">// (1)</span>
        <span class="keyword">for</span> (StepExecution stepExecution : jobExecution.getStepExecutions()) {
            <span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">STEP COMPLETED WITH SKIPS</span><span class="delimiter">&quot;</span></span>.equals(stepExecution.getExitStatus().getExitCode())) {
                jobExecution.setExitStatus(<span class="keyword">new</span> ExitStatus(<span class="string"><span class="delimiter">&quot;</span><span class="content">JOB COMPLETED WITH SKIPS</span><span class="delimiter">&quot;</span></span>));
                logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">Change status 'JOB COMPLETED WITH SKIPS'</span><span class="delimiter">&quot;</span></span>);
                <span class="keyword">break</span>;
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ジョブ定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitstatusjob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitstatusjob.step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted --&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExitCodeChangeListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">実装内容の一覧</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの実行結果に応じて、最終的なジョブの終了コードを<code>JobExecution</code>に設定する。<br>
ここではステップから返却された終了コードのいずれかに<code>CUSTOM STEP FAILED</code>が含まれている場合、
終了コード<code>CUSTOM FAILED</code>としている。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch07_JobManagement_HowToUse_ExitCode_Mapping"><a class="anchor" href="#Ch07_JobManagement_HowToUse_ExitCode_Mapping"></a>7.2.2.3. 終了コードのマッピング</h5>
<div class="paragraph">
<p>ジョブの終了コードとプロセスの終了コードをマッピング定義を行う。</p>
</div>
<div class="listingblock">
<div class="title">launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- exitCodeMapper --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitCodeMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.launch.support.SimpleJvmExitCodeMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mapping</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;util:map</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitCodeMapper</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">key-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.String</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">value-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- ExitStatus --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NOOP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STOPPED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">255</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">255</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UNKNOWN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">255</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CUSTOM FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- Custom Exit Status --&gt;</span>
        <span class="tag">&lt;/util:map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">プロセスの終了コードに1は厳禁</div>
<div class="paragraph">
<p>一般的にJavaプロセスはVMクラッシュやSIGKILLシグナル受信などによりプロセスが強制終了した際、
終了コードとして1を返却することがある。
正常・異常を問わずバッチアプリケーションの終了コードとは明確に区別すべきであるため、
アプリケーション内ではプロセスの終了コードとして1を定義しないこと。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">終了ステータスと終了コードの違いについて</div>
<div class="paragraph">
<p><code>JobRepository</code>で管理されるジョブとステップの状態として、「ステータス(<code>STATUS</code>)」と「終了コード(<code>EXIT_CODE</code>)」があるが、以下の点で異なる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ステータスはSpring Batchの内部制御で用いられ enum型の<code>BatchStatus</code>による具体値が定義されているためカスタマイズできない。</p>
</li>
<li>
<p>終了コードはジョブのフロー制御やプロセス終了コードの変更で使用することができ、カスタマイズできる。</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch07_JobManagement_HowToUse_DuplicateSafe"><a class="anchor" href="#Ch07_JobManagement_HowToUse_DuplicateSafe"></a>7.2.3. 二重起動防止</h4>
<div class="paragraph">
<p>Spring Batchではジョブを起動する際、<code>JobRepositry</code>から<code>JobInstance(BATCH_JOB_INSTANCEテーブル)</code>に対して
以下の組み合わせが存在するか確認する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>起動対象となるジョブ名</p>
</li>
<li>
<p>ジョブパラメータ</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Macchinetta Batch 2.xではジョブ・ジョブパラメータの組み合わせが一致しても複数回起動可能としている。<br>
つまり、二重起動を許容する。
詳細は、<a href="#Ch04_JobParameter">ジョブの起動パラメータ</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p>二重起動を防止する場合は、ジョブスケジューラやアプリケーション内で実施する必要がある。<br>
詳細な手段については、ジョブスケジューラ製品や業務要件に強く依存するため割愛する。<br>
個々のジョブについて、二重起動を抑止する必要があるかについて、検討すること。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch07_JobManagement_HowToUse_Logging"><a class="anchor" href="#Ch07_JobManagement_HowToUse_Logging"></a>7.2.4. ロギング</h4>
<div class="paragraph">
<p>ログの設定方法について説明する。</p>
</div>
<div class="paragraph">
<p>ログの出力、設定、考慮事項はMacchinetta Server 1.xと共通点が多い。まずは、
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/GeneralFuncDetail/Logging.html">ロギング</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p>ここでは、Macchinetta Batch 2.x特有の考慮点について説明する。</p>
</div>
<div class="sect4">
<h5 id="Ch07_JobManagement_HowToUse_Logging_Clarification"><a class="anchor" href="#Ch07_JobManagement_HowToUse_Logging_Clarification"></a>7.2.4.1. ログ出力元の明確化</h5>
<div class="paragraph">
<p>バッチ実行時のログは出力元のジョブやジョブ実行を明確に特定できるようにしておく必要がある。
そのため、スレッド名、ジョブ名、実行ジョブIDを出力するとよい。
特に非同期実行時は同名のジョブが異なるスレッドで並列に動作することになるため、
ジョブ名のみの記録はログ出力元を特定しにくくなる恐れがある。</p>
</div>
<div class="paragraph">
<p>それぞれの要素は、以下の要領で実現できる。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">スレッド名</dt>
<dd>
<p><code>logback.xml</code>の出力パターンである<code>%thread</code>を指定する</p>
</dd>
<dt class="hdlist1">ジョブ名・実行ジョブID</dt>
<dd>
<p><code>JobExecutionListener</code>を実装したコンポーネントを作成し、ジョブの開始・終了時に記録する</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">JobExecutionListener実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and import omitted.</span>

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobExecutionLoggingListener</span> <span class="directive">implements</span> JobExecutionListener {
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(JobExecutionLoggingListener.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="comment">// (1)</span>
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">job started. [JobName:{}][jobExecutionId:{}]</span><span class="delimiter">&quot;</span></span>,
            jobExecution.getJobInstance().getJobName(), jobExecution.getId());
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterJob(JobExecution jobExecution) {
        <span class="comment">// (2)</span>
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">job finished.[JobName:{}][jobExecutionId:{}][ExitStatus:{}]</span><span class="delimiter">&quot;</span></span>
                , jobExecution.getJobInstance().getJobName(),
                , jobExecution.getId(), jobExecution.getExitStatus().getExitCode());
    }

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ジョブBean定義ファイル</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted. --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- omitted. --&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExecutionLoggingListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>
<span class="comment">&lt;!-- omitted. --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">ジョブ名、ジョブ実行IDのログ出力実装例</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの開始前にジョブ名とジョブ実行IDをINFOログに出力している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの終了時は(1)に加えて終了コードも出力している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントとして登録されている<code>JobExecutionLoggingListener</code>を特定ジョブのBean定義に関連づけている。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch07_JobManagement_HowToUse_Logging_Monitoring"><a class="anchor" href="#Ch07_JobManagement_HowToUse_Logging_Monitoring"></a>7.2.4.2. ログ監視</h5>
<div class="paragraph">
<p>バッチアプリケーションは運用時のユーザインターフェースはログが主体となる。
監視対象と発生時のアクションを明確に設計しておかないと、
フィルタリングが困難となり、対処に必要なログが埋もれてしまう危険がある。
このため、ログの監視対象としてキーワードとなるメッセージやコード体系をあらかじめ決めておくとよい。
ログに出力するメッセージ管理については、後述の<a href="#Ch07_JobManagement_HowToUse_MessageManagement">"メッセージ管理"</a>を参照。</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch07_JobManagement_HowToUse_Logging_OutputLocation"><a class="anchor" href="#Ch07_JobManagement_HowToUse_Logging_OutputLocation"></a>7.2.4.3. ログ出力先</h5>
<div class="paragraph">
<p>バッチアプリケーションにおけるログの出力先について、どの単位でログを分散/集約するのかを設計するとよい。
たとえばフラットファイルにログを出力する場合でも以下のように複数パターンが考えられる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1ジョブあたり1ファイルに出力する</p>
</li>
<li>
<p>複数ジョブを1グループにまとめた単位で1ファイルに出力する</p>
</li>
<li>
<p>1サーバあたり1ファイルに出力する</p>
</li>
<li>
<p>複数サーバをまとめて1ファイルに出力する</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>いずれも対象システムにおける、ジョブ総数/ログ総量/発生するI/Oレートなどによって、
どの単位でまとめるのが最適かが分かれる。
また、ログを確認する方法にも依存する。ジョブスケジューラ上から参照することが多いか、コンソールから参照することが多いか、
といった活用方法によっても選択肢が変わると想定する。</p>
</div>
<div class="paragraph">
<p>重要なことは、運用設計にてログ出力を十分検討し、試験にてログの有用性を確認することに尽きる。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch07_JobManagement_HowToUse_MessageManagement"><a class="anchor" href="#Ch07_JobManagement_HowToUse_MessageManagement"></a>7.2.5. メッセージ管理</h4>
<div class="paragraph">
<p>メッセージ管理について説明する。</p>
</div>
<div class="paragraph">
<p>コード体系のばらつき防止や、監視対象のキーワードとしての抽出を設計しやすくするため、
一定のルールに従ってメッセージを付与することが望ましい。</p>
</div>
<div class="paragraph">
<p>なお、ログと同様、メッセージ管理についても基本的にはMacchinetta Server 1.xと同様である。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">MessageSourceの活用について</div>
<div class="paragraph">
<p>プロパティファイルからメッセージを使用するには<code>MessageSource</code>を使用することができる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>具体的な設定・実装例については
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/GeneralFuncDetail/Logging.html#id8">ログメッセージの一元管理</a>
を参照のこと。</p>
<div class="ulist">
<ul>
<li>
<p>ここではログ出力のサンプルとして Spring MVC のコントローラー のケースにそって例示されているが、
Spring Batchの任意のコンポーネントに読み換えてほしい。</p>
</li>
<li>
<p>ここでは<code>MessageSource</code>のインスタンスを独自に生成しているが、Macchinetta Batch 2.xではその必要はない。
<code>ApplicationContext</code>が生成された後でのみ、各コンポーネントにアクセスされるためである。
なお、Macchinetta Batch 2.xでは以下のとおり設定済みである。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">messageSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.context.support.ResourceBundleMessageSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:basenames</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">i18n/application-messages</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch08"><a class="anchor" href="#Ch08"></a>8. フロー制御と並列･多重処理</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch08_FlowControll"><a class="anchor" href="#Ch08_FlowControll"></a>8.1. フロー制御</h3>
<div class="sect3">
<h4 id="Ch08_FlowControll_Overview"><a class="anchor" href="#Ch08_FlowControll_Overview"></a>8.1.1. Overview</h4>
<div class="paragraph">
<p>1つの業務処理を実装する方法として、1つのジョブに集約して実装するのではなく、
複数のジョブに分割し組み合わせることで実装することがある。
このとき、ジョブ間の依存関係を定義したものをジョブネットと呼ぶ。</p>
</div>
<div class="paragraph">
<p>ジョブネットを定義することのメリットを下記に挙げる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>処理の進行状況が可視化しやすくなる</p>
</li>
<li>
<p>ジョブの部分再実行、実行保留、実行中止が可能になる</p>
</li>
<li>
<p>ジョブの並列実行が容易になる</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以上より、バッチ処理を設計する場合はジョブネットも併せてジョブ設計を行うことが一般的である。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">処理内容とジョブネットの適性</div>
<div class="paragraph">
<p>分割するまでもないシンプルな業務処理やオンライン処理と連携する処理に対して、ジョブネットは適さないことが多い。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>本ガイドラインでは、ジョブネットでジョブ同士の流れを制御することをフロー制御と呼ぶ。
また処理の流れにおける前のジョブを先行ジョブ、後のジョブを後続ジョブと呼び、
先行ジョブと後続ジョブの依存関係を、先行後続関係と呼ぶ。</p>
</div>
<div class="paragraph">
<p>フロー制御の概念図を以下に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_FlowControl_Overview.png" alt="Flow Control Overview">
</div>
<div class="title">フロー制御の概念図</div>
</div>
<div class="paragraph">
<p>上図のとおり、フロー制御はジョブスケジューラ、Macchinetta Batch 2.xのどちらでも実施可能である。
しかし、以下の理由によりできる限りジョブスケジューラを活用することが望ましい。</p>
</div>
<div class="ulist">
<div class="title">Macchinetta Batch 2.xで実現した場合</div>
<ul>
<li>
<p>1ジョブの処理や状態が多岐に渡る傾向が強まり、ブラックボックス化しやすい。</p>
</li>
<li>
<p>ジョブスケジューラとジョブの境界があいまいになってしまう</p>
</li>
<li>
<p>ジョブスケジューラ上から異常時の状況がみえにくくなってしまう</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ただし、ジョブスケジューラに定義するジョブ数が多くなると、以下の様なデメリットが生じることも一般に知られている。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ジョブスケジューラによる以下のようなコストが累積し、システム全体の処理時間が伸びる</p>
<div class="ulist">
<ul>
<li>
<p>ジョブスケジューラ製品固有の通信、実行ノードの制御、など</p>
</li>
<li>
<p>ジョブごとのJavaプロセス起動に伴うオーバーヘッド</p>
</li>
</ul>
</div>
</li>
<li>
<p>ジョブ登録数の限界</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>このため、以下を方針とする。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>基本的にはジョブスケジューラによりフロー制御を行う。</p>
</li>
<li>
<p>ジョブ数が多いことによる弊害がある場合に限り、以下のとおり対処する。</p>
<div class="ulist">
<ul>
<li>
<p>Macchinetta Batch 2.xにてシーケンシャルな複数の処理を1ジョブにまとめる。</p>
<div class="ulist">
<ul>
<li>
<p>シンプルな先行後続関係を1ジョブに集約するのみとする。</p>
</li>
<li>
<p>ステップ終了コードの変更と、この終了コードに基づく後続ステップ起動の条件分岐は機能上利用可能だが、
ジョブの実行管理が複雑化するため、ジョブ終了時のプロセス終了コード決定に限り原則利用する。<br>
どうしても条件分岐を使わないと問題を解消できない場合に限り使用を許容するが、
シンプルな先行後続関係を維持するよう配慮すること。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ジョブの終了コードの決定について、詳細は<a href="#Ch07_JobManagement_HowToUse_ExitCode">"終了コードのカスタマイズ"</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>また、以下に先行後続を実現する上で意識すべきポイントを示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch08/FlowControl/Ch08_FlowControl_Jobnet.png" alt="Jobnet">
</div>
<div class="title">ジョブスケジューラによるフロー制御</div>
</div>
<div class="ulist">
<div class="title">意識すべきポイント</div>
<ul>
<li>
<p>ジョブスケジューラがシェル等を介してjavaプロセスを起動する。</p>
</li>
<li>
<p>1ジョブが1javaプロセスとなる。</p>
<div class="ulist">
<ul>
<li>
<p>処理全体では、4つのjavaプロセスが起動する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ジョブスケジューラが各処理の起動順序を制御する。ぞれぞれのjavaプロセスは独立している。</p>
</li>
<li>
<p>後続ジョブの起動判定として、先行ジョブのプロセス終了コードが用いられる。</p>
</li>
<li>
<p>ジョブ間のデータ受け渡しは、ファイルやデータベースなど外部リソースを使用する必要がある。</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch08/FlowControl/Ch08_FlowControl_StepExecution.png" alt="FlowControl">
</div>
<div class="title">Macchinetta Batch 2.xによるフロー制御</div>
</div>
<div class="ulist">
<div class="title">意識すべきポイント</div>
<ul>
<li>
<p>ジョブスケジューラがシェル等を介してjavaプロセスを起動する。</p>
</li>
<li>
<p>1ジョブが1javaプロセスとなる。</p>
<div class="ulist">
<ul>
<li>
<p>処理全体では、1つのjavaプロセスしか使わない。</p>
</li>
</ul>
</div>
</li>
<li>
<p>1javaプロセス内で各ステップの起動順序を制御する。それぞれのステップは独立している。</p>
</li>
<li>
<p>後続ステップの起動判定として、先行ステップの終了コードが用いられる。</p>
</li>
<li>
<p>ステップ間のデータはインメモリで受け渡しが可能である。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以降、Macchinetta Batch 2.xによるフロー制御の実現方法について説明する。<br>
ジョブスケジューラでのフロー制御は製品仕様に強く依存するためここでは割愛する。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">フロー制御の応用例</div>
<div class="paragraph">
<p>複数ジョブの並列化・多重化は、一般的にジョブスケジューラとジョブネットによって実現することが多い。<br>
しかし、Macchinetta Batch 2.xではフロー制御の機能を応用し、複数ジョブの並列化、多重化を実現する方法を説明している。
詳細は、<a href="#Ch08_ParallelAndMultiple">"並列処理と多重処理"</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで同じ使い方になる。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch08_FlowControll_HowToUse"><a class="anchor" href="#Ch08_FlowControll_HowToUse"></a>8.1.2. How to use</h4>
<div class="paragraph">
<p>Macchinetta Batch 2.xでのフロー制御方法を説明する。</p>
</div>
<div class="sect4">
<h5 id="Ch08_FlowControll_HowToUse_SequencialFlow"><a class="anchor" href="#Ch08_FlowControll_HowToUse_SequencialFlow"></a>8.1.2.1. シーケンシャルフロー</h5>
<div class="paragraph">
<p>シーケンシャルフローとは先行ステップと後続ステップを直列に連結したフローである。<br>
何らかの業務処理がシーケンシャルフロー内のステップで異常終了した場合、後続ステップは実行されずにジョブが中断する。
このとき、<code>JobRepository</code>によりジョブ実行IDに紐付けられる当該のステップとジョブのステータス・終了コードは
<code>FAILED</code>として記録される。<br>
失敗原因の回復後にリスタートを実施することで、異常終了したステップから処理をやり直すことができる。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ジョブのリスタート方法については<a href="#Ch06_RerunRestart_HowToUse_Restart">"ジョブのリスタート"</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ここでは3つのステップからなるジョブのシーケンシャルフローを設定する。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sequentialFlowTasklet</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch08.flowcontrol.SequentialFlowTasklet</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">p:failExecutionStep</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['failExecutionStep']}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sequentialFlowTasklet</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:step&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step1</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step2</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>   <span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:step&gt;</code>で、このステップの正常終了後に起動する後続ステップを指定する。<br>
<code>next</code>属性に後続ステップの<code>id</code>を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フローの末端になるステップには、<code>next</code>属性は不要となる。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>これにより、 以下の順でステップが直列に起動する。<br>
<code>jobSequentialFlow.step1</code> &#8594; <code>jobSequentialFlow.step2</code> &#8594; <code>jobSequentialFlow.step3</code><br></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">&lt;batch:flow&gt;を使った定義方法</div>
<div class="paragraph">
<p>前述の例では<code>&lt;batch:job&gt;</code>内に直接フローを定義した。
<code>&lt;batch:flow&gt;</code>を利用して、フロー定義を外部に切り出すこともできる。
以下に<code>&lt;batch:flow&gt;</code>を利用した場合の例を示す。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:flow</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">innerFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outerFlow</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;batch:flow</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outerFlow</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step1</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step2</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step2</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step3</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step3</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:flow&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">parent属性に(2)で定義したフローのidを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">シーケンシャルフローを定義する。</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch08_FlowControll_HowToUse_PassingDataToFutureSteps"><a class="anchor" href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps"></a>8.1.2.2. ステップ間のデータの受け渡し</h5>
<div class="paragraph">
<p>Spring Batchには、ステップ、ジョブそれぞれのスコープで利用できる実行コンテキストの<code>ExecutionContext</code>が用意されている。
ステップ実行コンテキストを利用することでステップ内のコンポーネント間でデータを共有できる。
このとき、ステップ実行コンテキストはステップ間で共有できないため、先行のステップ実行コンテキストは後続のステップ実行コンテキストからは参照できない。
ジョブ実行コンテキストを利用すれば実現可能だが、すべてのステップから参照可能になるため、慎重に扱う必要がある。
ステップ間の情報を引き継ぐ必要があるときは、以下の手順により対応できる。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>先行ステップの後処理で、ステップ実行コンテキストに格納した情報をジョブ実行コンテキストに移す。</p>
</li>
<li>
<p>後続ステップがジョブ実行コンテキストから情報を取得する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>最初の手順は、Spring Batchから提供されている<code>ExecutionContextPromotionListener</code>を利用することで、
実装をせずとも、引き継ぎたい情報をリスナーに指定するだけ実現できる。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">ExecutionContextを使用する上での注意点</div>
<div class="paragraph">
<p>データの受け渡しに使用する<code>ExecutionContext</code>は<code>JobRepository</code>によりRDBMSの
<code>BATCH_JOB_EXECUTION_CONTEXT</code>、<code>BATCH_JOB_STEP_EXECUTION_CONTEXT</code>に
シリアライズされた状態で保存されるため、以下3点に注意すること。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>受け渡しデータはシリアライズ可能な形式のオブジェクトであること。</p>
<div class="ulist">
<ul>
<li>
<p><code>java.io.Serializable</code>を実装している必要がある。</p>
</li>
</ul>
</div>
</li>
<li>
<p>受け渡しデータは必要最小限に留めること。<br>
<code>ExecutionContext</code>はSpring Batchによる実行制御情報の保存でも利用しており、
受け渡しデータが大きくなればそれだけシリアライズコストが増大する。<br></p>
</li>
<li>
<p>データ受け渡しに直接ジョブ実行コンテキストに保存させず、上述の<code>ExecutionContextPromotionListener</code>を使用すること。<br>
ジョブ実行コンテキストはステップ実行コンテキストよりスコープが広いため、無用なシリアライズデータが蓄積しやすいため。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>また、実行コンテキストを経由せず、SingletonやJobスコープのBeanを共有することでも情報のやり取りは可能だが、
この方法もサイズが大きすぎるとメモリリソースを圧迫する可能性があるので注意すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以下、タスクレットモデルとチャンクモデルについて、それぞれステップ間のデータ受け渡しについて説明する。</p>
</div>
<div class="sect5">
<h6 id="Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Tasklet"><a class="anchor" href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Tasklet"></a>8.1.2.2.1. タスクレットモデルを用いたステップ間のデータ受け渡し</h6>
<div class="paragraph">
<p>受け渡しデータの保存・取得に、<code>ChunkContext</code>から<code>ExecutionContext</code>を取得し、ステップ間のデータ受け渡しを行う。</p>
</div>
<div class="listingblock">
<div class="title">データ受け渡し元タスクレットの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package, imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SavePromotionalTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// (1)</span>
        chunkContext.getStepContext().getStepExecution().getExecutionContext()
                .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>);

        <span class="comment">// omitted.</span>

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">データ受け渡し先のタスクレット実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ConfirmPromotionalTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) {
        <span class="comment">// (2)</span>
        <span class="predefined-type">Object</span> promotion = chunkContext.getStepContext().getJobExecutionContext()
                .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>);

        <span class="comment">// omitted.</span>

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ジョブBean定義の記述例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- import,annotation,component-scan definitions are omitted --&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">savePromotionalTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:listeners&gt;</span>
            <span class="tag">&lt;batch:listener&gt;</span>
                <span class="comment">&lt;!-- (3) --&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.listener.ExecutionContextPromotionListener</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:keys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listener&gt;</span>
        <span class="tag">&lt;/batch:listeners&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">confirmPromotionalTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>
<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">実装内容の説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップ実行コンテキストの<code>ExecutionContext</code>に後続ステップに受け渡す値を設定する。
ここでは一連のデータ受け渡しに必要なキーとして、<code>promotion</code>を指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">先行ステップの(1)で設定された受け渡しデータを<code>ExecutionContext</code>から、
受け渡し元で指定されたキー<code>promotion</code>を用いて取得する。<br>
ここで使用している<code>ExecutionContext</code>は(1)のステップ実行コンテキストではなく、
ジョブ実行コンテキストである点に注意する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ExecutionContextPromotionListener</code>を用い、
ステップ実行コンテキストからジョブ実行コンテキストに受け渡しデータを移す。<br>
<code>keys</code>プロパティには(1)で指定した受け渡しキーを指定する。<br>
<code>strict=true</code>プロパティにより、ステップ実行コンテキストに存在しない場合は<code>IllegalArgumentException</code>がスローされる。
<code>false</code>の場合は受け渡しデータがなくても処理が継続する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">ExecutionContextPromotionListenerとステップ終了コードについて</div>
<div class="paragraph">
<p><code>ExecutionContextPromotionListener</code>はデータ受け渡し元のステップ終了コードが正常終了時(<code>COMPLETED</code>)の場合のみ、
ステップ実行コンテキストからジョブ実行コンテキストへデータを移す。<br>
後続ステップが継続して実行される終了コードのカスタマイズを行う場合、
<code>status</code>プロパティに終了コードを配列形式で指定すること。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Chunk"><a class="anchor" href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Chunk"></a>8.1.2.2.2. チャンクモデルを用いたステップ間のデータ受け渡し</h6>
<div class="paragraph">
<p><code>ItemProcessor</code>に<code>@AfterStep</code>、<code>@BeforeStep</code>アノテーションを付与したメソッドを使用する。
データ受け渡しに使用するリスナーと、<code>ExecutionContext</code>の使用方法はタスクレットと同様である。</p>
</div>
<div class="listingblock">
<div class="title">データ受け渡し元ItemProcessorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PromotionSourceItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(<span class="predefined-type">String</span> item) {
        <span class="comment">// omitted.</span>
    }

    <span class="annotation">@AfterStep</span>
    <span class="directive">public</span> ExitStatus afterStep(StepExecution stepExecution) {
        <span class="comment">// (1)</span>
        stepExecution.getExecutionContext().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">データ受け渡し先ItemProcessorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PromotionTargetItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(<span class="predefined-type">String</span> item) {
        <span class="comment">// omitted.</span>
    }

    <span class="annotation">@BeforeStep</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="comment">// (2)</span>
        <span class="predefined-type">Object</span> promotion = stepExecution.getJobExecution().getExecutionContext()
                .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>);
        <span class="comment">// omitted.</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ジョブBean定義の記述例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- import,annotation,component-scan definitions are omitted --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sourceStep</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:listeners&gt;</span>
            <span class="tag">&lt;batch:listener&gt;</span>
                <span class="comment">&lt;!-- (3) --&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.listener.ExecutionContextPromotionListener</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:keys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listener&gt;</span>
        <span class="tag">&lt;/batch:listeners&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">targetStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- step definitions are omitted. --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">実装内容の説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップ実行コンテキストの<code>ExecutionContext</code>に後続ステップに受け渡す値を設定する。
ここでは一連のデータ受け渡しに必要なキーとして、<code>promotion</code>を指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">先行ステップの(1)で設定された受け渡しデータを<code>ExecutionContext</code>から、
受け渡し元で指定されたキー<code>promotion</code>を用いて取得する。<br>
ここで使用している<code>ExecutionContext</code>は(1)のステップ実行コンテキストではなく、
ジョブ実行コンテキストである点に注意する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ExecutionContextPromotionListener</code>を用い、
ステップ実行コンテキストからジョブ実行コンテキストに受け渡しデータを移す。<br>
プロパティの指定はタスクレットと同様である。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch08_FlowControll_HowToExtend"><a class="anchor" href="#Ch08_FlowControll_HowToExtend"></a>8.1.3. How to extend</h4>
<div class="paragraph">
<p>ここでは後続ステップの条件分岐と、条件により後続ステップ実行前にジョブを停止させる停止条件について説明する。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">ジョブ・ステップの終了コードとステータスの違い。</div>
<div class="paragraph">
<p>以降の説明では「ステータス」と「終了コード」という言葉が頻繁に登場する。<br>
これらの判別がつかない場合混乱を招く恐れがあるため、
まず<a href="#Ch07_JobManagement_HowToUse_ExitCode">"終了コードのカスタマイズ"</a>を参照してほしい。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="Ch08_FlowControll_HowToExtend_ConditionFlow"><a class="anchor" href="#Ch08_FlowControll_HowToExtend_ConditionFlow"></a>8.1.3.1. 条件分岐</h5>
<div class="paragraph">
<p>条件分岐は先行ステップの実行結果となる終了コードを受けて、複数の後続ステップから1つを選択して継続実行させることを言う。<br>
いずれの後続ステップを実行させずにジョブを停止させる場合は後述の<a href="#Ch08_FlowControll_HowToExtend_StopConfig">"停止条件"</a>を参照。</p>
</div>
<div class="listingblock">
<div class="title">ジョブBean定義記述例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepA</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">conditionalFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepB</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepB</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">conditionalFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">conditionalFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">実装内容の説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">シーケンシャルフローのように<code>&lt;batch:step&gt;</code>要素内に<code>next</code>属性を指定させず、
<code>&lt;batch:next&gt;</code>を複数置くことで、<code>to</code>属性で指定される後続ステップに振り分けることができる。<br>
<code>on</code>には遷移条件となるステップの終了コードを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)のステップ終了コードが<code>COMPLETED</code>の場合のみに実行される後続ステップとなる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)のステップ終了コードが<code>FAILED</code>の場合のみに実行される後続ステップとなる。<br>
この指定が行われることで先行ステップ処理失敗時にジョブが停止せず、回復処理などの後続ステップが実行される。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">後続ステップによる回復処理の注意点</div>
<div class="paragraph">
<p>先行ステップの処理失敗(終了コードが<code>FAILED</code>)により後続ステップの回復処理が行われた場合、
回復処理の成否を問わず先行ステップのステータスは<code>ABANDONED</code>となり、リスタート不能となる。</p>
</div>
<div class="paragraph">
<p>後続ステップの回復処理が失敗した場合にジョブをリスタートすると、回復処理のみが再実行される。<br>
このため、先行ステップを含めて処理をやり直す場合は別のジョブ実行としてリランさせる必要がある。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch08_FlowControll_HowToExtend_StopConfig"><a class="anchor" href="#Ch08_FlowControll_HowToExtend_StopConfig"></a>8.1.3.2. 停止条件</h5>
<div class="paragraph">
<p>先行ステップの終了コードに応じ、ジョブを停止させる方法を説明する。<br>
停止の手段として、以下の3つの要素を指定する方法がある。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>end</code></p>
</li>
<li>
<p><code>fail</code></p>
</li>
<li>
<p><code>stop</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>これらの終了コードが先行ステップに該当する場合は後続ステップが実行されない。<br>
また、同一ステップ内にそれぞれ複数指定が可能である。</p>
</div>
<div class="listingblock">
<div class="title">ジョブBean定義記述例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;batch:end</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">END_WITH_NO_EXIT_CODE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:end</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">END_WITH_EXIT_CODE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exit-code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED_CUSTOM</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;batch:fail</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_FAIL_WITH_NO_EXIT_CODE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:fail</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_FAIL_WITH_EXIT_CODE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exit-code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED_CUSTOM</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;batch:stop</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_STOP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restart</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exit-code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">ジョブの停止の設定内容説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:end&gt;</code>の<code>on</code>属性とステップ終了コードが一致した場合、ジョブは正常終了
(ステータス：<code>COMPLETED</code>)として<code>JobRepository</code>に記録される。<br>
<code>exit-code</code>属性を付与した場合、ジョブの終了コードをデフォルトの<code>COMPLETED</code>からカスタマイズすることができる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:next&gt;</code>の<code>on</code>属性にワイルドカード(<code>*</code>)を指定することで、<code>end</code>、<code>fail</code>、
<code>stop</code>いずれの終了コードにも該当しない場合に後続ジョブを継続させることができる。<br>
ここではステップ要素内の最後に記述しているが、終了コードの一致条件が先に評価されるため、
要素の並び順はステップ要素内であれば任意である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:fail&gt;</code>を使用した場合、ジョブは異常終了(ステータス：<code>FAILED</code>)として<code>JobRepository</code>に記録される。<br>
<code>&lt;batch:end&gt;</code>と同様、<code>exit-code</code>属性を付与することで、ジョブの終了コードをデフォルトの<code>FAILED</code>からカスタマイズすることができる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:stop&gt;</code>を使用した場合、ステップの正常終了時にジョブは中断(ステータス：<code>STOPPED</code>)として<code>JobRepository</code>に記録される。<br>
<code>restart</code>属性はリスタート時に中断状態からジョブが再開されるステップを指定する。<br>
<code>&lt;batch:end&gt;</code>と同様、<code>exit-code</code>属性を付与することができるが、空白文字列を指定すること。(後述のコラムを参照)</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">exit-code属性による終了コードのカスタマイズ時は漏れなくプロセス終了コードにマッピングさせること。</div>
<div class="paragraph">
<p>詳細は<a href="#Ch07_JobManagement_HowToUse_ExitCode">"終了コードのカスタマイズ"</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">&lt;batch:stop&gt;でexit-codeに空文字列を指定すること。</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;stop</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restart</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/step&gt;</span>

<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>上記はstep1が正常終了した際ジョブは停止状態となり、再度リスタート実行時にstep2を実行させることを意図したフロー制御になっている。<br>
しかし、Spring Batchの不具合により、現在意図したとおりに動作しない。<br>
リスタート後にstep2が実行されることがなく、ジョブの終了コードは<code>NOOP</code>となり、ステータスが<code>COMPLETED</code>となる。</p>
</div>
<div class="paragraph">
<p>これを回避するためには上述で示したように<code>exit-code</code>で""(空文字)を付与すること。</p>
</div>
<div class="paragraph">
<p>不具合の詳細は
<a href="https://jira.spring.io/browse/BATCH-2315">Spring Batch/BATCH-2315</a>
を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch08_ParallelAndMultiple"><a class="anchor" href="#Ch08_ParallelAndMultiple"></a>8.2. 並列処理と多重処理</h3>
<div class="sect3">
<h4 id="Ch08_ParallelAndMultiple_Overview"><a class="anchor" href="#Ch08_ParallelAndMultiple_Overview"></a>8.2.1. Overview</h4>
<div class="paragraph">
<p>一般的に、バッチウィンドウ(バッチ処理のために使用できる時間)がシビアなバッチシステムでは、
複数ジョブを並列に動作させる(以降、並列処理と呼ぶ)ことで全体の処理時間を可能な限り短くするように設計する。<br>
しかし、1ジョブの処理データが大量であるために処理時間がバッチウィンドウに収まらない場合がある。<br>
その際は、1ジョブの処理データを分割して多重走行させる(以降、多重処理と呼ぶ)ことで処理時間を短縮させる手法が用いられる。<br>
この、並列処理と多重処理は同じような意味合いで扱われることもあるが、ここでは以下の定義とする。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">並列処理</dt>
<dd>
<p>複数の異なるジョブを、同時に実行する。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_ParallelAndMultiple_Overview_Parallel.png" alt="Parallel Step">
</div>
<div class="title">並列処理の概略図</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">多重処理</dt>
<dd>
<p>1ジョブの処理対象を分割して、同時に実行する。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_ParallelAndMultiple_Overview_Multiple.png" alt="Partition Step">
</div>
<div class="title">多重処理の概略図</div>
</div>
<div class="paragraph">
<p>並列処理と多重処理ともにジョブスケジューラで行う方法とMacchinetta Batch 2.xで行う方法がある。<br>
なお、Macchinetta Batch 2.xでの並列処理および多重処理は
<a href="#Ch08_FlowControll">フロー制御</a>の上に成り立っている。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">並列処理および多重処理の実現方法</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">実現方法</th>
<th class="tableblock halign-left valign-top">並列処理</th>
<th class="tableblock halign-left valign-top">多重処理</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブスケジューラ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">依存関係がない複数の異なるジョブを同時に実行するように定義する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">複数の同じジョブを異なるデータ範囲で実行するように定義する。各ジョブに処理対象のデータを絞るための情報を引数などで渡す。<br>
たとえば、1年間のデータを月ごとに分割する、エリアや支店などの単位で分割する、など</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Macchinetta Batch 2.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch08_ParallelAndMultiple_HowToUse_ParallelStep">Parallel Step (並列処理)</a><br>
ステップ単位で並列処理を行う。<br>
各ステップは同じ処理である必要はなく、データベースとファイルというような種類が異なるリソースに対して並列で処理を行う事も可能である。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch08_ParallelAndMultiple_HowToUse_Partitioning">Partitioning Step (多重処理)</a><br>
マスタステップでは対象データを分割するためのキーを取得し、
スレーブステップではこのキーにもとづいて分割したデータを処理する。<br>
Parallel Stepとは異なりスレーブステップの処理は同一処理となる。</p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">ジョブスケジューラを使用する場合</dt>
<dd>
<p>1ジョブに1プロセスが割り当てられるため複数プロセスで起動される。 そのため、1つのジョブを設計・実装する難易度は低い。<br>
しかし、複数プロセスで起動するため、同時実行数が増えるとマシンリソースへの負荷が高くなる。<br>
よって、同時実行数が3、4程度であれば、ジョブスケジューラを利用するとよい。<br>
もちろん、この数値は絶対的なものではない。実行環境やジョブの実装に依存するため目安としてほしい。</p>
</dd>
<dt class="hdlist1">Macchinetta Batch 2.xを使用する場合</dt>
<dd>
<p>各ステップがスレッドに割り当てられるため、1プロセス複数スレッドで動作する。そのため、1つのジョブへの設計・実装の難易度はジョブスケジューラを使用する場合より高くなる。<br>
しかし、複数スレッドで起動するため、同時実行数が増えてもマシンリソースへの負荷がジョブスケジューラを使用する場合ほど高くはならない。
よって、同時実行数が多い(5以上の)場合であれば、Macchinetta Batch 2.xを利用するのがよい。<br>
もちろん、この数値は絶対的なものではない。実行環境やシステム特性に依存するため目安としてほしい。</p>
</dd>
</dl>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Spring Batchで実行可能な並列処理方法の1つに<code>Multi Thread Step</code>があるが、以下の理由によりMacchinetta Batch 2.xでの利用は非推奨とする。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Multi Thread Stepとは</dt>
<dd>
<p>チャンク単位で複数スレッドで並列処理を行う方法。</p>
</dd>
<dt class="hdlist1">非推奨理由</dt>
<dd>
<p>Spring Batchが提供しているReaderやWriterのほとんどが、マルチスレッドでの利用を想定して設計されていない。
そのため、データロストや重複処理が発生する可能性があり、処理の信頼性が低い。また、複数スレッドで動作するため、一定の処理順序とならない。<br>
ItemReader/ItemProcessor/ItemWriterを自作する場合でもスレッドセーフなど<code>Multi Thread Step</code>を使うためには考慮すべき点が多く実装および運用の難易度が高くなる。
これらの理由により、<code>Multi Thread Step</code>は非推奨としている。<br>
代わりに<a href="#Ch08_ParallelAndMultiple_HowToUse_Partitioning">Partitioning Step (多重処理)</a>を利用することを推奨する。</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>org.springframework.batch.item.support.SynchronizedItemStreamReader</code>を利用することで、既存のItemReaderをスレッドセーフにすることは可能である。
それでも処理順序の課題は残るため、Macchinetta Batch 2.xでは<code>Multi Thread Step</code>は利用しないこと。</p>
</div>
</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>並列処理・多重処理で1つのデータベースに対して更新する場合は、リソース競合とデッドロックが発生する可能性がある。
ジョブ設計の段階から潜在的な競合発生を排除すること。</p>
</div>
<div class="paragraph">
<p>マルチプロセスや複数筐体への分散処理は、Spring Batchに機能があるが、Macchinetta Batch 2.xとしては障害設計が困難になるため扱わないこととする。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで同じ使い方になる</p>
</div>
<div class="sect4">
<h5 id="Ch08_ParallelAndMultiple_Overview_Scheduler"><a class="anchor" href="#Ch08_ParallelAndMultiple_Overview_Scheduler"></a>8.2.1.1. ジョブスケジューラによる並列処理と多重処理</h5>
<div class="paragraph">
<p>ここでは、ジョブスケジューラによる並列処理と多重処理の概念について説明を行う。</p>
</div>
<div class="paragraph">
<p>ジョブ登録、スケジュール設定などについては、使用するジョブスケジューラのマニュアルを参照してほしい。</p>
</div>
<div class="sect5">
<h6 id="Ch08_ParallelAndMultiple_Overview_Scheduler_ParallelJob"><a class="anchor" href="#Ch08_ParallelAndMultiple_Overview_Scheduler_ParallelJob"></a>8.2.1.1.1. ジョブスケジューラによるジョブの並列化</h6>
<div class="paragraph">
<p>並列実行させたい処理をそれぞれジョブとして登録、それぞれのジョブが同時に開始するようにスケジュールを設定する。
各々のジョブは異なる処理として登録してよい。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch08_ParallelAndMultiple_Overview_Scheduler_MultiplelJob"><a class="anchor" href="#Ch08_ParallelAndMultiple_Overview_Scheduler_MultiplelJob"></a>8.2.1.1.2. ジョブスケジューラによるジョブの多重化</h6>
<div class="paragraph">
<p>多重実行させたい処理を複数登録し、パラメータにより対象データの抽出範囲を指定する。
その上で、それぞれのジョブが同時に開始するようにスケジュールを設定する。
各々のジョブは同じ処理ではあるが、処理対象データ範囲は独立していることが必要となる。</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch08_ParallelAndMultiple_HowToUse"><a class="anchor" href="#Ch08_ParallelAndMultiple_HowToUse"></a>8.2.2. How to use</h4>
<div class="paragraph">
<p>Macchinetta Batch 2.xでの並列処理および多重処理を行う方法を説明する。</p>
</div>
<div class="sect4">
<h5 id="Ch08_ParallelAndMultiple_HowToUse_ParallelStep"><a class="anchor" href="#Ch08_ParallelAndMultiple_HowToUse_ParallelStep"></a>8.2.2.1. Parallel Step (並列処理)</h5>
<div class="paragraph">
<p>Parallel Step (並列処理)の方法を説明する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_ParallelAndMultiple_Parallel_Step.png" alt="Parallel Step">
</div>
<div class="title">Parallel Stepの概要図</div>
</div>
<div class="paragraph">
<div class="title">概要図の説明</div>
<p>各ステップに別々な処理を定義することができ、それらを並列に実行することができる。
各ステップごとにスレッドが割り当てられる。</p>
</div>
<div class="paragraph">
<p>Parallel Stepの概要図を例にしたParallel Stepの定義方法を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">Parallel Stepのジョブ定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Task Executor --&gt;</span>
<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;task:executor</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">queue-capacity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- Job Definition --&gt;</span>
<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelStepJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;batch:split</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelStepJob.split</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;batch:flow&gt;</span>  <span class="comment">&lt;!-- (3)  --&gt;</span>
          <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelStepJob.step.chunk.db</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
               <span class="comment">&lt;!-- (4) --&gt;</span>
              <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                  <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">databaseWriter</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
              <span class="tag">&lt;/batch:tasklet&gt;</span>
          <span class="tag">&lt;/batch:step&gt;</span>
      <span class="tag">&lt;/batch:flow&gt;</span>

      <span class="tag">&lt;batch:flow&gt;</span>  <span class="comment">&lt;!-- (3)  --&gt;</span>
          <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelStepJob.step.tasklet.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
               <span class="comment">&lt;!-- (5) --&gt;</span>
              <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkTransactionTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/batch:step&gt;</span>
      <span class="tag">&lt;/batch:flow&gt;</span>

      <span class="tag">&lt;batch:flow&gt;</span>  <span class="comment">&lt;!-- (3)  --&gt;</span>
          <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelStepJob.step.tasklet.single</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
               <span class="comment">&lt;!-- (6) --&gt;</span>
              <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">singleTransactionTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/batch:step&gt;</span>
      <span class="tag">&lt;/batch:flow&gt;</span>

      <span class="tag">&lt;batch:flow&gt;</span>  <span class="comment">&lt;!-- (3)  --&gt;</span>
          <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelStepJob.step.chunk.file</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                   <span class="comment">&lt;!-- (7) --&gt;</span>
                  <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">databaseReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileWriter</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
              <span class="tag">&lt;/batch:tasklet&gt;</span>
          <span class="tag">&lt;/batch:step&gt;</span>
      <span class="tag">&lt;/batch:flow&gt;</span>

  <span class="tag">&lt;/batch:split&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">並列処理のために、各スレッドに割り当てるためのスレッドプールを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:split&gt;</code>タグ内に並列実行するステップを<code>&lt;batch:flow&gt;</code>タグを使用した形式で定義をする。<br>
<code>task-executor</code>属性に(1)で定義したスレッドプールのBeanを設定する</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batch:flow&gt;</code>ごとに並列位処理したい<code>&lt;batch:step&gt;</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">概要図のStep1：チャンクモデルの中間コミット方式処理を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">概要図のStep2：タスクレットモデルの中間コミット方式処理を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">概要図のStep3：タスクレットモデルの一括コミット方式処理を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">概要図のStep4：チャンクモデルの非トランザクショナルなリソースに対する中間コミット方式処理を定義する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">並列処理したために処理性能が低下するケース</div>
<div class="paragraph">
<p>並列処理では多重処理同様にデータ範囲を変えて同じ処理を並列走行させることが可能である。この場合、データ範囲はパラメータなどで与える。<br>
この際に、個々の処理ごとに対象となるデータ量が小さい場合、
稼働時に占有するリソース量や処理時間などのフットプリントが並列処理では不利に働き、
かえって処理性能が低下することがある。</p>
</div>
<div class="ulist">
<div class="title">フットプリントの例</div>
<ul>
<li>
<p>入力リソースに対するオープンから最初のデータ範囲を取得するまでの処理</p>
<div class="ulist">
<ul>
<li>
<p>リソースオープンは、データ取得に比べて処理時間がかかる</p>
</li>
<li>
<p>データ範囲のメモリ領域を初期化する処理も同様に時間がかかる</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>また、Parallel Stepの前後に共通処理のステップを定義することも可能である。</p>
</div>
<div class="listingblock">
<div class="title">共通処理ステップを含むParallel Stepの例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelRegisterJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelRegisterJob.step.preprocess</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelRegisterJob.split</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">deleteDetailTasklet</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>

    <span class="comment">&lt;!--(2) --&gt;</span>
    <span class="tag">&lt;batch:split</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelRegisterJob.split</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:flow&gt;</span>
            <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelRegisterJob.step.plan</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">planReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">planWriter</span><span class="delimiter">&quot;</span></span>
                            <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                <span class="tag">&lt;/batch:tasklet&gt;</span>
            <span class="tag">&lt;/batch:step&gt;</span>
        <span class="tag">&lt;/batch:flow&gt;</span>
        <span class="tag">&lt;batch:flow&gt;</span>
            <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelRegisterJob.step.performance</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">performanceReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">performanceWriter</span><span class="delimiter">&quot;</span></span>
                            <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                <span class="tag">&lt;/batch:tasklet&gt;</span>
            <span class="tag">&lt;/batch:step&gt;</span>
        <span class="tag">&lt;/batch:flow&gt;</span>
    <span class="tag">&lt;/batch:split&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">前処理として処理するステップを定義する。<code>next</code>属性に<code>&lt;batch:split&gt;</code>に設定したidを指定する。<br>
<code>next</code>属性による後続ステップの指定に関する詳細は<a href="#Ch08_FlowControll_HowToUse_SequencialFlow">"シーケンシャルフロー"</a>を参照。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parallel Stepを定義する。<br>
<code>&lt;batch:flow&gt;</code>ごとに並列処理したい<code>&lt;batch:step&gt;</code>を定義する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch08_ParallelAndMultiple_HowToUse_Partitioning"><a class="anchor" href="#Ch08_ParallelAndMultiple_HowToUse_Partitioning"></a>8.2.2.2. Partitioning Step (多重処理)</h5>
<div class="paragraph">
<p>Partitioning Step(多重処理)の方法を説明する</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_ParallelAndMultiple_Partitioing_Step.png" alt="Partitioning Step">
</div>
<div class="title">Partitioning Stepの概要図</div>
</div>
<div class="paragraph">
<div class="title">概要図の説明</div>
<p>Partitioning Stepでは、MasterステップとSlaveステップの処理フェーズに分割される。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Masterステップでは、<code>Partitioner</code>により各Slaveステップが処理するデータ範囲を特定するための<code>Parition Key</code>を生成する。
<code>Parition Key</code>はステップコンテキストに格納される。</p>
</li>
<li>
<p>Slaveステップでは、ステップコンテキストから自身に割り当てられた<code>Parition Key</code>を取得し、それを使い処理対象データを特定する。
特定した処理対象データに対して定義したステップの処理を実行する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Partitioning Stepでは処理データを分割必要があるが、分割数については可変数と固定数のどちらにも対応できる。</p>
</div>
<div class="dlist">
<div class="title">分割数</div>
<dl>
<dt class="hdlist1">可変数の場合</dt>
<dd>
<p>部門別で分割や、特定のディレクトリに存在するファイル単位での処理</p>
</dd>
<dt class="hdlist1">固定数の場合</dt>
<dd>
<p>全データを個定数で分割してデータを処理</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Spring Batchでは、固定数のことを<code>grid-size</code>といい、<code>Partitioner</code>で<code>grid-size</code>になるようにデータ分割範囲を決定する。</p>
</div>
<div class="paragraph">
<p>Partitioning Stepでは、分割数をスレッドサイズより大きくすることができる。
この場合、スレッド数分で多重実行され、スレッドに空きが出るまで、処理が未実行のまま保留となるステップが発生する。</p>
</div>
<div class="paragraph">
<p>以下にPartitioning Stepのユースケースを示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Partitioning Stepのユースケース</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 10%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ユースケース</th>
<th class="tableblock halign-left valign-top">Master(Patitioner)</th>
<th class="tableblock halign-left valign-top">Slave</th>
<th class="tableblock halign-left valign-top">分割数</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">マスタ情報からトランザクション情報を分割・多重化するケース<br>
部門別や月別の集計処理など</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB(マスタ情報)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB(トランザクション情報)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">可変</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">複数ファイルのリストから1ファイル単位に多重化するケース<br>
各支店からの転送データを支店別に多重処理(支店別集計処理など)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">複数ファイル</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">単一ファイル</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">可変</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">大量データを一定数で分割・多重化するケース</p>
<p class="tableblock">障害発生時にリラン以外のリカバリ設計が難しくなるため、実運用では利用されることはあまりないケース。<br>
リランする場合は、全件やり直しなので分割したメリットが薄れてしまう。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>grid-size</code>とトランザクション情報件数からデータ範囲を特定</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB(トランザクション情報)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">固定</p></td>
</tr>
</tbody>
</table>
<div class="sect5">
<h6 id="Ch08_ParallelAndMultiple_HowToUse_Partitioning_VariablePartitonNumber"><a class="anchor" href="#Ch08_ParallelAndMultiple_HowToUse_Partitioning_VariablePartitonNumber"></a>8.2.2.2.1. 分割数が可変の場合</h6>
<div class="paragraph">
<p>Partitioning Stepで分割数を可変とする方法を説明する。<br>
下記に処理イメージ図を示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_ParallelAndMultiple_Partitioing_variable.png" alt="Variable Partiton Number">
</div>
<div class="title">処理イメージ図</div>
</div>
<div class="paragraph">
<p>処理イメージを例とした実装方法を示す。</p>
</div>
<div class="listingblock">
<div class="title">Repository(SQLMapper)の定義 (PostgreSQL)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findAll</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.mst.Branch</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    SELECT
        branch_id AS branchId,
        branch_name AS branchName,
        branch_address AS branchAddrss,
        branch_tel AS branchTel,
        create_date AS createDate,
        update_date AS updateDate
    FROM
        branch_mst
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/select&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">summarizeInvoice</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.performance.SalesPerformanceDetail</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    SELECT
        branchId, year, month, customerId, SUM(amount) AS amount
    FROM (
        SELECT
            t2.charge_branch_id AS branchId,
            date_part('year', t1.invoice_date) AS year,
            date_part('month', t1.invoice_date) AS month,
            t1.customer_id AS customerId,
            t1.invoice_amount AS amount
        FROM invoice t1
        INNER JOIN customer_mst t2 ON t1.customer_id = t2.customer_id
        WHERE
            t2.charge_branch_id = #{branchId}
        ) t3
    GROUP BY branchId, year, month, customerId
    ORDER BY branchId ASC, year ASC, month ASC, customerId ASC
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/select&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Partitionerの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BranchPartitioner</span> <span class="directive">implements</span> Partitioner {

    <span class="annotation">@Inject</span>
    BranchRepository branchRepository; <span class="comment">// (3)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ExecutionContext&gt; partition(<span class="type">int</span> gridSize) {

        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ExecutionContext&gt; map = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
        <span class="predefined-type">List</span>&lt;Branch&gt; branches = branchRepository.findAll();

        <span class="type">int</span> index = <span class="integer">0</span>;
        <span class="keyword">for</span> (Branch branch : branches) {
            ExecutionContext context = <span class="keyword">new</span> ExecutionContext();
            context.putString(<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId</span><span class="delimiter">&quot;</span></span>, branch.getBranchId()); <span class="comment">// (4)</span>
            map.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span> + index, context);  <span class="comment">// (5)</span>
            index++;
        }

        <span class="keyword">return</span> map;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (6) --&gt;</span>
<span class="tag">&lt;task:executor</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${thread.size}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">queue-capacity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.repository.performance.InvoiceRepository.summarizeInvoice</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameterValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="comment">&lt;!-- (8) --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{stepExecutionContext['branchId']}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleInvoiceSummarizeJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (9) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleInvoiceSummarizeJob.master</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (10) --&gt;</span>
        <span class="tag">&lt;batch:partition</span> <span class="attribute-name">partitioner</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchPartitioner</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">step</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleInvoiceSummarizeJob.slave</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- (11) --&gt;</span>
            <span class="tag">&lt;batch:handler</span> <span class="attribute-name">grid-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:partition&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- (12) --&gt;</span>
<span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleInvoiceSummarizeJob.slave</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:tasklet&gt;</span>
<span class="tag">&lt;/batch:step&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">マスタデータから処理対象を取得するSQLを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">マスタデータからの取得値を検索条件とするSQLを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定義したRepository(SQLMapper)をInjectする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1つのSlaveステップが処理するマスタ値をステップコンテキストに格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各Slaveが該当するコンテキストを取得できるようMapに格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">多重処理でSlaveステップの各スレッドに割り当てるためのスレッドプールを定義する。<br>
Masterステップはメインスレッドで処理される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">マスタ値によるデータ取得のItemReaderを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)で設定したマスタ値をステップコンテキストから取得し、検索条件に追加する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Masterステップを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの分割条件を生成する処理を定義する。<br>
<code>partitioner</code>属性には、<code>Partitioner</code>インターフェース実装を設定する。<br>
<code>step</code>属性には、(12)で定義するSlaveステップのBeanIDを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>partitioner</code>では<code>grid-size</code>を使用しないため、<code>grid-size</code>属性には任意の値を設定する。
<code>task-executor</code>属性に(6)で定義したスレッドプールのBeanIDを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Slaveステップを定義する。<br>
<code>reader</code>属性に(7)で定義したItemReaderを設定する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>複数ファイルのリストから1ファイル単位に多重化する場合は、Spring Batchが提供している以下の<code>Partitioner</code>を利用することができる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.core.partition.support.MultiResourcePartitioner</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>MultiResourcePartitioner</code>の利用例を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">ファイル処理を多重化する例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;task:executor</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">queue-capacity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{stepExecutionContext['fileName']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:fieldSetMapper-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invoiceFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invoiceNo,salesDate,productId,customerId,quant,price</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">patitioner</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.partition.support.MultiResourcePartitioner</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resources</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['basedir']}/input/invoice-*.csv</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>

<span class="comment">&lt;!--(6) --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inspectPartitioninglStepFileJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inspectPartitioninglStepFileJob.step.master</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:partition</span> <span class="attribute-name">partitioner</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">patitioner</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">step</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inspectPartitioninglStepFileJob.step.slave</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:handler</span> <span class="attribute-name">grid-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:partition&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- (7) --&gt;</span>
<span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inspectPartitioninglStepFileJob.step.slave</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet&gt;</span>
        <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:tasklet&gt;</span>
<span class="tag">&lt;/batch:step&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">多重処理でSlaveステップの各スレッドに割り当てるためのスレッドプールを定義する。<br>
Masterステップはメインスレッドで処理される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1つのファイルを読み込むためのItemReaderを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resouce</code>プロパティに、<code>MultiResourcePartitioner</code>で分割されたファイルを入力ファイルに指定する。<br>
<code>MultiResourcePartitioner</code>は、"fileName"というキーでステップコンテキストにファイルパスを格納している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MultiResourcePartitioner</code>を<code>Partitioner</code>として定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*を用いたパターンを使用することで、複数ファイルを対象にすることができる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Masterステップを定義する。<br>
定義内容は上記で説明したPartitioning Stepの内容と同じ。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Slaveステップを定義する。<br>
<code>reader</code>属性に(2)で定義したItemReaderを設定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch08_ParallelAndMultiple_HowToUse_Partitioning_FixingPartitonNumber"><a class="anchor" href="#Ch08_ParallelAndMultiple_HowToUse_Partitioning_FixingPartitonNumber"></a>8.2.2.2.2. 分割数が固定の場合</h6>
<div class="paragraph">
<p>Partitioning Stepで分割数を固定する方法を説明する。<br>
下記に処理イメージ図を示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_ParallelAndMultiple_Partitioing_fixed.png" alt="Fixing Partiton Number">
</div>
<div class="title">処理イメージ図</div>
</div>
<div class="paragraph">
<p>処理イメージを例とした実装方法を示す。</p>
</div>
<div class="listingblock">
<div class="title">Repository(SQLMapper)の定義 (PostgreSQL)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findByYearAndMonth</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.performance.SalesPerformanceSummary</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    SELECT
        branch_id AS branchId, year, month, amount
    FROM
        sales_performance_summary
    WHERE
        year = #{year} AND month = #{month}
    ORDER BY
        branch_id ASC
    LIMIT
        #{dataSize}
    OFFSET
        #{offset}
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/select&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">countByYearAndMonth</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">_int</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    SELECT
        count(*)
    FROM
        sales_performance_summary
    WHERE
        year = #{year} AND month = #{month}
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/select&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Partitionerの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesDataPartitioner</span> <span class="directive">implements</span> Partitioner {

    <span class="annotation">@Inject</span>
    SalesSummaryRepository repository;  <span class="comment">// (3)</span>

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ExecutionContext&gt; partition(<span class="type">int</span> gridSize) {

        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ExecutionContext&gt; map = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
        <span class="type">int</span> count = repository.countByYearAndMonth(year, month);
        <span class="type">int</span> dataSize = (count / gridSize) + <span class="integer">1</span>;        <span class="comment">// (4)</span>
        <span class="type">int</span> offset = <span class="integer">0</span>;

        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; gridSize; i++) {
            ExecutionContext context = <span class="keyword">new</span> ExecutionContext();
            context.putInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSize</span><span class="delimiter">&quot;</span></span>, dataSize);     <span class="comment">// (5)</span>
            context.putInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">offset</span><span class="delimiter">&quot;</span></span>, offset);         <span class="comment">// (6)</span>
            offset += dataSize;
            map.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">partition:</span><span class="delimiter">&quot;</span></span> + i, context);       <span class="comment">// (7)</span>
        }

        <span class="keyword">return</span> map;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (8) --&gt;</span>
<span class="tag">&lt;task:executor</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${thread.size}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">queue-capacity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (9) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch08.parallelandmultiple.repository.SalesSummaryRepository.findByYearAndMonth</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameterValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">year</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['year']}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">month</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['month']}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="comment">&lt;!-- (10) --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSize</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{stepExecutionContext['dataSize']}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="comment">&lt;!-- (11) --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">offset</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{stepExecutionContext['offset']}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleCreateSalesPlanSummaryJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (12) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleCreateSalesPlanSummaryJob.master</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (13) --&gt;</span>
        <span class="tag">&lt;batch:partition</span> <span class="attribute-name">partitioner</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesDataPartitioner</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">step</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleCreateSalesPlanSummaryJob.slave</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- (14) --&gt;</span>
            <span class="tag">&lt;batch:handler</span> <span class="attribute-name">grid-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:partition&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- (15) --&gt;</span>
<span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleCreateSalesPlanSummaryJob.slave</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">addProfitsItemProcessor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:tasklet&gt;</span>
<span class="tag">&lt;/batch:step&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">特定のデータ範囲を取得するためにページネーション検索(SQL絞り込み方式)を定義する。<br>
ページネーション検索(SQL絞り込み方式)の詳細は、Macchinetta Server 1.x 開発ガイドラインの
<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.html#entity-sql">Entityのページネーション検索(SQL絞り込み方式)</a>を参照。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理対象の全件数を取得するSQLを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定義したRepository(SQLMapper)をInjectする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1つのSlaveステップが処理するデータ件数を算出する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)のデータ件数をステップコンテキストに格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各Slaveステップの検索開始位置をステップコンテキストに格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各Slaveが該当するコンテキストを取得できるようMapに格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">多重処理でSlaveステップの各スレッドに割り当てるためのスレッドプールを定義する。<br>
Masterステップはメインスレッドで処理される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ページネーション検索(SQL絞り込み方式)によるデータ取得のItemReaderを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)で設定したデータ件数をステップコンテキストから取得し、検索条件に追加する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)で設定した検索開始位置をステップコンテキストから取得し、検索条件に追加する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Masterステップを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(13)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの分割条件を生成する処理を定義する。<br>
<code>partitioner</code>属性には、<code>Partitioner</code>インターフェース実装を設定する。<br>
<code>step</code>属性には、(15)で定義するSlaveステップのBeanIDを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(14)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>grid-size</code>属性に分割数(固定値)を設定する。<br>
<code>task-executor</code>属性に(8)で定義したスレッドプールのBeanIDを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(15)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Slaveステップを定義する。<br>
<code>reader</code>属性に(9)で定義したItemReaderを設定する。</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch09"><a class="anchor" href="#Ch09"></a>9. チュートリアル</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch09_Introduction"><a class="anchor" href="#Ch09_Introduction"></a>9.1. はじめに</h3>
<div class="sect3">
<h4 id="Ch09_Introduction_Purpose"><a class="anchor" href="#Ch09_Introduction_Purpose"></a>9.1.1. チュートリアルの目的</h4>
<div class="paragraph">
<p>本チュートリアルは、Macchinetta Batch 2.x 開発ガイドラインに記載されている内容について、実際にアプリケーションの開発を体験することで、
Macchinetta Batch 2.xの基本的な知識を習得することを目的としている。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Introduction_Target"><a class="anchor" href="#Ch09_Introduction_Target"></a>9.1.2. 対象読者</h4>
<div class="paragraph">
<p>本チュートリアルはソフトウェア開発経験のあるアーキテクトやプログラマ向けに書かれており、
以下の知識があることを前提としている。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring FrameworkのDIやAOPに関する基礎的な知識がある</p>
</li>
<li>
<p>SQLに関する基礎的な知識がある</p>
</li>
<li>
<p>Javaを主体としたアプリケーションの開発経験がある</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Introduction_Environment"><a class="anchor" href="#Ch09_Introduction_Environment"></a>9.1.3. 検証環境</h4>
<div class="paragraph">
<p>本チュートリアルの検証を行った環境条件を以下に示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">環境条件</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ソフトウェア分類</th>
<th class="tableblock halign-left valign-top">製品名</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Windows 7 Professional SP1 (64bit)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">openjdk-1.8.0.131.x86_64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IDE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Tool Suite 3.8.2 released</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Build Tool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apache Maven 3.3.9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RDBMS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">H2 Database 1.4.193</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch09_Introduction_AboutFrameWork"><a class="anchor" href="#Ch09_Introduction_AboutFrameWork"></a>9.1.4. フレームワークの概要</h4>
<div class="paragraph">
<p>ここでは、フレームワークの概要として処理モデルの概要およびアーキテクチャの違いについて説明する。<br>
Spring Batchについて、詳細はMacchinetta Batch 2.x 開発ガイドラインの<a href="#Ch02_SpringBatchArch">Spring Batchのアーキテクチャ</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p>Macchinetta Batch 2.xが提供する処理モデルには、チャンクモデルとタスクレットモデルがある。<br>
それぞれの特徴について以下に示す。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンクモデル</dt>
<dd>
<p>一定件数のデータごとにまとめて入力／加工／出力する方式。このデータのまとまりをチャンクと呼ぶ。
データの入力／加工／出力といった処理の流れを定型化し、一部を実装するだけでジョブが実装できる。
大量データを効率よく処理する場合に用いる。<br>
詳細は<a href="#Ch02_SpringBatchArch_Arch_BusinessLogic_Chunk">チャンクモデル</a>を参照のこと。</p>
</dd>
<dt class="hdlist1">タスクレットモデル</dt>
<dd>
<p>自由に処理を記述する方式。SQLを1回発行するだけ、コマンドを発行するだけ、といった簡素なケースや
複数のデータベースやファイルにアクセスしながら処理するような複雑で定型化しにくい場合に用いる。<br>
詳細は<a href="#Ch02_SpringBatchArch_Arch_BusinessLogic_Tasklet">タスクレットモデル</a>を参照のこと。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>処理モデルについて、構成要素や機能的な差異を下表に示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">処理モデルの機能差</caption>
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">機能</th>
<th class="tableblock halign-left valign-top">チャンクモデル</th>
<th class="tableblock halign-left valign-top">タスクレットモデル</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">構成要素</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader、ItemProcessor、ItemWriter、ChunkOrientedTaskletで構成される。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Taksletのみで構成される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクション</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンク単位にトランザクションが発生する。トランザクション制御は中間コミットのみ。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1トランザクションで処理する。トランザクション制御は、一括コミット方式と中間コミット方式のいずれかを利用可能。
前者はSpring Batchが持つトランザクション制御の仕組みを利用するが、後者はユーザにてトランザクションを直接操作する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">推奨する再処理方式</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リラン、リスタートを利用できる。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リランのみ利用することを原則とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外ハンドリング</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リスナーを使うことでハンドリング処理が容易になっている。try-catchによる独自実装も可能。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">try-catchによる独自実装が必要。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>本チュートリアルでは、基本的な機能を利用したアプリケーションについてチャンクモデル、タスクレットモデルそれぞれの実装方法を説明している。
チャンクモデル、タスクレットモデルのアーキテクチャの違いによって実装方法も異なってくるため、
ここでそれぞれの特徴をしっかり理解してから進めることを推奨する。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Introduction_HowToProceed"><a class="anchor" href="#Ch09_Introduction_HowToProceed"></a>9.1.5. チュートリアルの進め方</h4>
<div class="paragraph">
<p>本チュートリアルで作成するアプリケーション(ジョブ)においては、
作成済みのジョブに実装を追加して作成するジョブがあるため、作成する順序を考慮しなければならない。</p>
</div>
<div class="paragraph">
<p>本チュートリアルの読み進め方を作成するジョブの順序関係も含めて図を以下に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/Introduction/Ch09_Introduction_HowToProceed.png" alt="How to Proceed with the Tutorial">
</div>
<div class="title">チュートリアルの進め方</div>
</div>
<div class="paragraph">
<div class="title">非同期実行方式のジョブの実施タイミング</div>
<p>非同期実行方式のジョブは、本チュートリアルの進め方の順序では最後のジョブとしているが、
チャンクモデルまたはタスクレットモデルで1つでもジョブを作成済みであれば、非同期実行方式のジョブを実施してもよい。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">ファイルアクセスでデータ入出力を行うジョブへの追加実装について</div>
<div class="paragraph">
<p><a href="#Ch09_Impl_FileAccessJob">ファイルアクセスでデータ入出力を行うジョブ</a>の説明以外は、
<a href="#Ch09_Impl_DBAccessJob">データベースアクセスでデータ入出力を行うジョブ</a>を元に実装を追加したり、実行例を表示させている。
ファイルアクセスでデータ入出力を行うジョブを元に実装を追加する場合は、読み替える必要があるため留意すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_TutorialApplication"><a class="anchor" href="#Ch09_TutorialApplication"></a>9.2. 作成するアプリケーションの説明</h3>
<div class="sect3">
<h4 id="Ch09_Application_Overview"><a class="anchor" href="#Ch09_Application_Overview"></a>9.2.1. 背景</h4>
<div class="paragraph">
<p>とある量販店では会員に対してポイントカードを発行している。<br>
会員には「ゴールド会員」「一般会員」の会員種別が存在し、会員種別に応じたサービスを提供している。<br>
今回そのサービスの一環として、月内に商品を購入した会員のうち、 会員種別が「ゴールド会員」の場合は100ポイント、「一般会員」の場合は10ポイントを月末に加算することにした。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Application_ProcessingOverview"><a class="anchor" href="#Ch09_Application_ProcessingOverview"></a>9.2.2. 処理概要</h4>
<div class="paragraph">
<p>会員種別に応じてポイント加算を行うアプリケーションを月次バッチ処理としてMacchinetta Batch 2.xを使用して実装する。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Application_BusinessRequirements"><a class="anchor" href="#Ch09_Application_BusinessRequirements"></a>9.2.3. 業務仕様</h4>
<div class="paragraph">
<p>業務仕様を以下に示す。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>「月内に商品を購入した会員」は商品購入フラグで示す</p>
<div class="ulist">
<ul>
<li>
<p>商品購入フラグは、"0"の場合に初期状態、"1"の場合に処理対象を表す</p>
</li>
</ul>
</div>
</li>
<li>
<p>商品購入フラグが"1"(処理対象)の場合に、会員種別に応じてポイントを加算する</p>
<div class="ulist">
<ul>
<li>
<p>会員種別が"G"(ゴールド会員)の場合は100ポイント、"N"(一般会員)の場合は10ポイントを加算する</p>
</li>
</ul>
</div>
</li>
<li>
<p>商品購入フラグはポイント加算後に、"0"(初期状態)に更新する</p>
</li>
<li>
<p>ポイントの上限値は1,000,000ポイントとする</p>
</li>
<li>
<p>ポイント加算後に1,000,000ポイントを超えた場合は、1,000,000ポイントに補正する</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Application_ImplementationMethod"><a class="anchor" href="#Ch09_Application_ImplementationMethod"></a>9.2.4. 学習コンテンツ</h4>
<div class="paragraph">
<p>簡単な業務仕様のアプリケーション(ジョブ)の作成を通して、ジョブに関する様々な機能や処理方式を学習する。<br>
なお、ジョブはタスクレットモデルとチャンクモデルをそれぞれ実装する。<br>
各ジョブで主に学習することとそのジョブで利用する機能や処理方式を以下に示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">チュートリアルで作成するジョブ</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 30%;">
<col style="width: 65%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">ジョブ</th>
<th class="tableblock halign-left valign-top">学習内容</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch09_Impl_DBAccessJob">データベースアクセスでデータ入出力を行うジョブ</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatis用のItemReaderおよびItemWriterを利用したデータベースアクセスの手法を学ぶ。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch09_Impl_FileAccessJob">ファイルアクセスでデータ入出力を行うジョブ</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フラットファイルの入出力用のItemReaderおよびItemWriterを利用したファイルアクセスの手法を学ぶ。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch09_Impl_ValidationJob">入力データの妥当性検証を行うジョブ</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean Validationを利用した入力チェックの手法を学ぶ。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">D</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob">ChunkListenerで例外ハンドリングを行うジョブ</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リスナーとしてChunkListenerを利用した例外ハンドリングの手法を学ぶ。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">E</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob">try-catchで例外ハンドリングを行うジョブ</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">try-catchを利用した例外ハンドリングとスキップ、およびカスタマイズした終了コードを出力する手法を学ぶ。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch09_Impl_AsyncExecutionJob">非同期実行方式のジョブ</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Macchinetta Batch 2.xが提供するDBポーリング機能を利用した非同期実行の手法を学ぶ。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A～Fのジョブで利用している機能や処理方式とMacchinetta Batch 2.x 開発ガイドラインの説明の対応表を以下に示す。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">A～FのジョブとMacchinetta Batch 2.x 開発ガイドラインの説明の対応表</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 41%;">
<col style="width: 9%;">
<col style="width: 9%;">
<col style="width: 9%;">
<col style="width: 9%;">
<col style="width: 9%;">
<col style="width: 9%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">機能</th>
<th class="tableblock halign-left valign-top">A</th>
<th class="tableblock halign-left valign-top">B</th>
<th class="tableblock halign-left valign-top">C</th>
<th class="tableblock halign-left valign-top">D</th>
<th class="tableblock halign-left valign-top">E</th>
<th class="tableblock halign-left valign-top">F</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの起動 &gt; 起動方式 &gt; <a href="#Ch04_SyncJob">同期実行</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの起動 &gt; 起動方式 &gt; <a href="#Ch04_AsyncJobWithDB">非同期実行(DBポーリング)</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの起動 &gt; ジョブの起動パラメータ &gt; <a href="#Ch04_JobParameter_HowToUse_CLIArgs">コマンドライン引数から与える</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの起動 &gt; <a href="#Ch04_Listener">リスナー</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの入出力 &gt; トランザクション制御 &gt; <a href="#Ch05_Transaction_Arch_UnderSpringBatch">Spring Batchにおけるトランザクション制御</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの入出力 &gt; トランザクション制御 &gt; 単一データソースの場合 &gt; <a href="#Ch05_Transaction_HowToUse_SingleDataSource_Tx">トランザクション制御の実施</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの入出力 &gt; データベースアクセス &gt; <a href="#Ch05_DBAccess_HowToUse_Input">入力</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの入出力 &gt; データベースアクセス &gt; <a href="#Ch05_DBAccess_HowToUse_Output">出力</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの入出力 &gt; ファイルアクセス &gt; 可変長レコード &gt; <a href="#Ch05_FileAccess_HowToUse_FixedLength_Input">入力</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの入出力 &gt; ファイルアクセス &gt; 可変長レコード &gt; <a href="#Ch05_FileAccess_HowToUse_FixedLength_Output">出力</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">異常系への対応 &gt; <a href="#Ch06_InputValidation">入力チェック</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">異常系への対応 &gt; 例外ハンドリング &gt; ステップ単位の例外ハンドリング &gt; <a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_ChunkListener">ChunkListenerインターフェースによる例外ハンドリング</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">異常系への対応 &gt; 例外ハンドリング &gt; ステップ単位の例外ハンドリング &gt; <a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk">チャンクモデルにおける例外ハンドリング</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">異常系への対応 &gt; 例外ハンドリング &gt; ステップ単位の例外ハンドリング &gt; <a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Tasklet">タスクレットモデルにおける例外ハンドリング</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">異常系への対応 &gt; 例外ハンドリング &gt; 処理継続可否の決定 &gt; <a href="#Ch06_ExceptionHandling_Overview_Deal_Skip">スキップ</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの管理 &gt; ジョブの状態管理 &gt; <a href="#Ch07_JobManagement_HowToUse_JobStatusManagement_Retrieve">ジョブの状態・実行結果の確認</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの管理 &gt; <a href="#Ch07_JobManagement_HowToUse_ExitCode">終了コードのカスタマイズ</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの管理 &gt; <a href="#Ch07_JobManagement_HowToUse_Logging">ロギング</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの管理 &gt; <a href="#Ch07_JobManagement_HowToUse_MessageManagement">メッセージ管理</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_EnvironmentConstruction"><a class="anchor" href="#Ch09_EnvironmentConstruction"></a>9.3. 環境構築</h3>
<div class="paragraph">
<p>以下の流れでチュートリアルを実施するための環境構築を行う。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_EnvironmentConstruction_BlankProject">プロジェクトの作成</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_Import">プロジェクトのインポート</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_BlankProjectConstruction">プロジェクトの構成</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_Setting">設定ファイルの確認・編集</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_InputDataPreparation">入力データの準備</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_DataSourceExplorer">STSからデータベースを参照する準備</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_OperationCheck">プロジェクトの動作確認</a></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_BlankProject"><a class="anchor" href="#Ch09_EnvironmentConstruction_BlankProject"></a>9.3.1. プロジェクトの作成</h4>
<div class="paragraph">
<p>まず、<code>Maven Archetype Plugin</code>の<code>mvn archetype:generate</code>を利用して、プロジェクトを作成する。<br>
ここでは、Windowsのコマンドプロンプトを使用してプロジェクトを作成する手順となっている。</p>
</div>
<div class="paragraph">
<p><code>mvn archetype:generate</code>を利用してプロジェクトを作成する方法の詳細については、<a href="#Ch03_CreateProject_HowToCreate">プロジェクトの作成</a>を参照すること。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">プロキシサーバの経由について</div>
<div class="paragraph">
<p>インターネット接続するためにプロキシサーバを経由する必要がある場合、STSのProxy設定と <a href="http://maven.apache.org/guides/mini/guide-proxies.html">MavenのProxy設定</a>をする。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>プロジェクトを作成するディレクトリにて、以下のコマンドを実行する。</p>
</div>
<div class="listingblock">
<div class="title">コマンドプロンプト(Windows)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;mvn archetype:generate ^
  -DarchetypeGroupId=com.github.macchinetta.blank ^
  -DarchetypeArtifactId=macchinetta-batch-archetype ^
  -DarchetypeVersion=2.0.1.RELEASE</code></pre>
</div>
</div>
<div class="paragraph">
<p>その後、以下を対話式に設定する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">プロジェクト作成時に設定する値</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項目名</th>
<th class="tableblock halign-left valign-top">設定例</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">groupId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.example.batch.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">artifactId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">macchinetta-batch-tutorial</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0.0-SNAPSHOT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.example.batch.tutorial</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>以下のとおり、mvnコマンドに対して「BUILD SUCCESS」が表示されることを確認する。</p>
</div>
<div class="listingblock">
<div class="title">実行例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;mvn archetype:generate -DarchetypeGroupId=com.github.macchinetta.blank -Darchetyp
eArtifactId=macchinetta-batch-archetype -DarchetypeVersion=2.0.1.RELEASE
[INFO] Scanning for projects&#8230;&#8203;
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Maven Stub Project (No POM) 1
[INFO] ------------------------------------------------------------------------

(.. omitted)

Define value for property 'groupId': com.example.batch
Define value for property 'artifactId': macchinetta-batch-tutorial
Define value for property 'version' 1.0-SNAPSHOT: : 1.0.0-SNAPSHOT
Define value for property 'package':  com.example.batch: : com.example.batch.tutorial
Confirm properties configuration:
groupId: com.example.batch
artifactId: macchinetta-batch-tutorial
version: 1.0.0-SNAPSHOT
package: com.example.batch.tutorial
 Y: : y
[INFO] -------------------------------------------------------------------------
---
[INFO] Using following parameters for creating project from Archetype: macchinet
ta-batch-archetype:2.0.1.RELEASE
[INFO] -------------------------------------------------------------------------
---
[INFO] Parameter: groupId, Value: com.example.batch
[INFO] Parameter: artifactId, Value: macchinetta-batch-tutorial
[INFO] Parameter: version, Value: 1.0.0-SNAPSHOT
[INFO] Parameter: package, Value: com.example.batch.tutorial
[INFO] Parameter: packageInPathFormat, Value: com/example/batch/tutorial
[INFO] Parameter: package, Value: com.example.batch.tutorial
[INFO] Parameter: version, Value: 1.0.0-SNAPSHOT
[INFO] Parameter: groupId, Value: com.example.batch
[INFO] Parameter: artifactId, Value: macchinetta-batch-tutorial
[INFO] Project created from Archetype in dir: C:\xxx\macchinetta-batch-tutorial
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 45.293 s
[INFO] Finished at: 2017-08-22T09:03:01+09:00
[INFO] Final Memory: 16M/197M
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>サンプルジョブを実行し、プロジェクトが正しく作成できたことを確認する。</p>
</div>
<div id="Ch09_EnvironmentConstruction_BlankProject_ExecSample" class="listingblock">
<div class="title">サンプルジョブの実行(正しく作成できたことの確認)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;cd macchinetta-batch-tutorial
C:\xxx&gt;mvn clean dependency:copy-dependencies -DoutputDirectory=lib package
C:\xxx&gt;java -cp &quot;lib/*;target/*&quot; ^
org.springframework.batch.core.launch.support.CommandLineJobRunner ^
META-INF/jobs/job01.xml job01</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のとおり、mvnコマンドに対して「BUILD SUCCESS」、javaコマンドに対して「COMPLETED」が表示されることを確認する。</p>
</div>
<div class="listingblock">
<div class="title">出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;cd macchinetta-batch-tutorial

C:\xxx\macchinetta-batch-tutorial&gt;mvn clean dependency:copy-dependencies -Doutput
Directory=lib package
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Maccinetta Batch Framework for Java (2.x) Blank Project 1.0.0-SN
APSHOT
[INFO] ------------------------------------------------------------------------

(.. omitted)

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 9.462 s
[INFO] Finished at: 2017-08-22T09:12:22+09:00
[INFO] Final Memory: 26M/211M
[INFO] ------------------------------------------------------------------------

C:\xxx\macchinetta-batch-tutorial&gt;java -cp &quot;lib/*;target/*&quot; org.springframework.b
atch.core.launch.support.CommandLineJobRunner META-INF/jobs/job01.xml job01
[2017/08/22 09:17:32] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Re
freshing org.springframework.context.support.ClassPathXmlApplicationContext@6204
3840: startup date [Tue Aug 22 09:17:32 JST 2017]; root of context hierarchy

(.. ommited)

[2017/08/22 09:17:35] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJ
ob: [name=job01]] launched with the following parameters: [{jsr_batch_run_id=1}]

[2017/08/22 09:17:35] [main] [o.s.b.c.j.SimpleStepHandler] [INFO ] Executing ste
p: [job01.step01]
[2017/08/22 09:17:35] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJ
ob: [name=job01]] completed with the following parameters: [{jsr_batch_run_id=1}
] and the following status: [COMPLETED]
[2017/08/22 09:17:35] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Cl
osing org.springframework.context.support.ClassPathXmlApplicationContext@6204384
0: startup date [Tue Aug 22 09:17:32 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_Import"><a class="anchor" href="#Ch09_EnvironmentConstruction_Import"></a>9.3.2. プロジェクトのインポート</h4>
<div class="paragraph">
<p>作成したプロジェクトをSTSへインポートする。<br>
STSのメニューから、[File] &#8594; [Import] &#8594; [Maven] &#8594; [Existing Maven Projects] &#8594; [Next]を選択し、archetypeで作成したプロジェクトを選択する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_Import_ImportMavenProjects.png" alt="Import Existing Maven Projects">
</div>
</div>
<div class="paragraph">
<p>Root Directoryに<code>C:\xxx\macchinetta-batch-tutorial</code>を設定し、Projectsにcom.example.batchのpom.xmlが選択された状態で、 [Finish]を押下する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_Import_Import.png" alt="Select Maven Projects">
</div>
</div>
<div class="paragraph">
<p>インポートが完了すると、Package Explorerに次のようなプロジェクトが表示される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_Import_PackageExplorer.png" alt="Package Explorer">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">インポート後にビルドエラーが発生する場合</div>
<div class="paragraph">
<p>インポート後にビルドエラーが発生する場合は、プロジェクト名を右クリックし、「Maven」&#8594;「Update Project&#8230;&#8203;」をクリックし、 「OK」ボタンをクリックすることでエラーが解消されるケースがある。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">パッケージの表示形式の設定</div>
<div class="paragraph">
<p>パッケージの表示形式は、デフォルトは「Flat」だが、「Hierarchical」にしたほうが見通しがよい。<br>
Package Explorerの「View Menu」 (右端の下矢印)をクリックし、「Package Presentation」&#8594;「Hierarchical」を選択する。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_BlankProjectConstruction"><a class="anchor" href="#Ch09_EnvironmentConstruction_BlankProjectConstruction"></a>9.3.3. プロジェクトの構成</h4>
<div class="paragraph">
<p>プロジェクトの構成については、<a href="#Ch03_CreateProject_ProjectStructure">プロジェクトの構成</a>を参照すること。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_Setting"><a class="anchor" href="#Ch09_EnvironmentConstruction_Setting"></a>9.3.4. 設定ファイルの確認・編集</h4>
<div class="sect4">
<h5 id="Ch09_EnvironmentConstruction_Setting_Check"><a class="anchor" href="#Ch09_EnvironmentConstruction_Setting_Check"></a>9.3.4.1. 設定ファイルの確認</h5>
<div class="paragraph">
<p>作成したプロジェクトにはSpring BatchやMyBatisなどの設定のほとんどが既に設定済みである。<br>
作成したプロジェクトの設定ファイルについては<a href="#Ch03_CreateProject_ProjectStructure">プロジェクトの構成</a>を参照のこと。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">設定値のカスタマイズについて</div>
<div class="paragraph">
<p>チュートリアルを実施する場合にユーザの状況に応じてカスタマイズが必要な設定値について理解する必要はないが、チュートリアルを実施する前または後に一読するとよい。
詳細については<a href="#Ch03_CreateProject_Make_Setting">アプリケーション全体の設定</a>を参照のこと。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_EnvironmentConstruction_Setting_Edit"><a class="anchor" href="#Ch09_EnvironmentConstruction_Setting_Edit"></a>9.3.4.2. 設定ファイルの編集</h5>
<div class="paragraph">
<p>チュートリアルを実施するため、H2 Databaseの設定を変更する。設定の変更点を以下に示す。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>手動でサーバを起動することなく複数のバッチアプリケーションのプロセスからデータベースへ接続可能とする。</p>
</li>
<li>
<p>バッチアプリケーションのプロセスの終了後でもデータを保持した状態のデータベースへ接続可能とする。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>なお、H2 Databaseの設定の詳細については <a href="http://www.h2database.com/html/features.html">H2の公式ドキュメントのFeatures</a> を参照すること。</p>
</div>
<div class="paragraph">
<p>具体的な編集内容を以下に示す。</p>
</div>
<div class="paragraph">
<p>batch-application.propertiesを開き、<code>admin.jdbc.url</code>及び<code>jdbc.url</code>を以下のように編集する。<br>
下記の例は分かりやすさのために編集対象行のみ記載し、上書きではなくコメントアウトをした上で新たに行を追加している。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/batch-application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt">##  Application settings.

# Admin DataSource settings.
#admin.jdbc.url=jdbc:h2:mem:batch-admin;DB_CLOSE_DELAY=-1
admin.jdbc.url=jdbc:h2:~/batch-admin;AUTO_SERVER=TRUE

# Job DataSource settings.
#jdbc.url=jdbc:h2:mem:batch;DB_CLOSE_DELAY=-1
jdbc.url=jdbc:h2:~/batch-admin;AUTO_SERVER=TRUE</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">admin.jdbc.urlとjdbc.urlにおいて同じdatabaseName(batch-admin)を指定している理由</div>
<div class="paragraph">
<p>チュートリアルを実施する際のJDBCドライバの接続設定では、<code>admin.jdbc.url</code>と<code>jdbc.url</code>において同じdatabaseNameを指定している。</p>
</div>
<div class="paragraph">
<p><a href="#Ch03_CreateProject_Make_Setting">アプリケーション全体の設定</a>に記載してあるとおり、<code>admin.jdbc.url</code>はFW(Spring BatchやMacchinetta Batch 2.x)が利用するURLであり、<code>jdbc.url</code>はジョブ個別が利用するURLである。</p>
</div>
<div class="paragraph">
<p>本来はFWとジョブ個別が使用するデータベースは分けるのが好ましい。<br>
しかし、チュートリアルではデータベースを切替る手間をなくし、より簡単にFWとチュートリアルで使用するテーブルを参照するため、このような設定にしている。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_InputDataPreparation"><a class="anchor" href="#Ch09_EnvironmentConstruction_InputDataPreparation"></a>9.3.5. 入力データの準備</h4>
<div class="sect4">
<h5 id="Ch09_EnvironmentConstruction_InputDataPreparation_DB"><a class="anchor" href="#Ch09_EnvironmentConstruction_InputDataPreparation_DB"></a>9.3.5.1. データベースアクセスでデータ入出力を行うジョブの入力データ</h5>
<div class="paragraph">
<p><a href="#Ch09_Impl_DBAccessJob">データベースアクセスでデータ入出力を行うジョブ</a>で使用する入力データの準備を行う。<br>
なお、データベースアクセスでデータ入出力を行うジョブを作成しない場合は実施する必要はない。</p>
</div>
<div class="paragraph">
<p>入力データの準備は以下の流れで行う。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_EnvironmentConstruction_InputDataPreparation_DB_SQL">テーブル作成・初期データ挿入スクリプト作成</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_InputDataPreparation_DB_Setting">ジョブ実行時にスクリプトを自動実行する設定の追加</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>これらの設定を行うことにより、ジョブ実行時(ApplicationContext生成時)にスクリプトを実行し、データベースの初期化を行う。</p>
</div>
<div class="sect5">
<h6 id="Ch09_EnvironmentConstruction_InputDataPreparation_DB_SQL"><a class="anchor" href="#Ch09_EnvironmentConstruction_InputDataPreparation_DB_SQL"></a>9.3.5.1.1. テーブル作成・初期データ挿入スクリプト作成</h6>
<div class="paragraph">
<p>テーブル作成・初期データ挿入スクリプトの作成を行う。</p>
</div>
<div class="paragraph">
<p>プロジェクトルートディレクトリに<code>sqls</code>ディレクトリを作成し、下記の3つのスクリプトを格納する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>テーブル作成スクリプト(<code>create-member-info-table.sql</code>)</p>
</li>
<li>
<p>初期データ(正常)挿入スクリプト(<code>insert-member-info-data.sql</code>)</p>
</li>
<li>
<p>初期データ(異常)挿入スクリプト(<code>insert-member-info-error-data.sql</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>作成するファイルの内容を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">sqls/create-member-info-table.sql</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> member_info (
    id <span class="predefined-type">CHAR</span>(<span class="integer">8</span>),
    type <span class="predefined-type">CHAR</span>(<span class="integer">1</span>),
    status <span class="predefined-type">CHAR</span>(<span class="integer">1</span>),
    point <span class="predefined-type">INT</span>,
    <span class="directive">PRIMARY</span> <span class="type">KEY</span>(id)
);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">sqls/insert-member-info-data.sql</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">TRUNCATE</span> <span class="type">TABLE</span> member_info;
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000001</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">0</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000002</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">0</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000003</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">10</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000004</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">10</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000005</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">100</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000006</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">100</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000007</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">1000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000008</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">1000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000009</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">10000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000010</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">10000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000011</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">100000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000012</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">100000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000013</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">999901</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000014</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">999991</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000015</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">999900</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000016</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">999990</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000017</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">10</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000018</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">10</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000019</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">100</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000020</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">100</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000021</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">1000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000022</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">1000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000023</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">10000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000024</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">10000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000025</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">100000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000026</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">100000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000027</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">1000000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000028</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">1000000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000029</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">999899</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000030</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">999989</span>);
<span class="class">COMMIT</span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">sqls/insert-member-info-error-data.sql</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">TRUNCATE</span> <span class="type">TABLE</span> member_info;
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000001</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">0</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000002</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">0</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000003</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">10</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000004</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">10</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000005</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">100</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000006</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">100</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000007</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">1000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000008</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">1000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000009</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">10000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000010</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">10000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000011</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">100000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000012</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">100000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000013</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">1000001</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000014</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">999991</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000015</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">999901</span>);
<span class="class">COMMIT</span>;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_EnvironmentConstruction_InputDataPreparation_DB_Setting"><a class="anchor" href="#Ch09_EnvironmentConstruction_InputDataPreparation_DB_Setting"></a>9.3.5.1.2. ジョブ実行時にスクリプトを自動実行する設定の追加</h6>
<div class="paragraph">
<p>ジョブ実行時(ApplicationContext生成時)にスクリプトを実行し、データベースの初期化を行うため、<code>&lt;jdbc:initialize-database&gt;</code>タグの定義を追加する。<br></p>
</div>
<div class="paragraph">
<p>以下の2つのファイルの編集を実施する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>batch-application.propertiesに実行対象スクリプトのパスの設定を追加する</p>
</li>
<li>
<p>launch-context.xmlに<code>&lt;jdbc:initialize-database&gt;</code>タグの定義を追加する</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>具体的な設定内容を以下に示す。</p>
</div>
<div class="paragraph">
<p>batch-application.propertiesを開き、末尾に以下の実行対象スクリプトのパスの設定を追加する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tutorial.create-table.script(テーブル作成スクリプトのパス)</p>
</li>
<li>
<p>tutorial.insert-data.script(初期データ挿入スクリプトのパス)<br></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>初期データ挿入スクリプトのパスは、実行するスクリプトの切替を容易にするために正常データと異常データを同じプロパティ名で定義し、コメントアウトしている。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/batch-application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt"># Database Initialize
tutorial.create-table.script=file:sqls/create-member-info-table.sql
tutorial.insert-data.script=file:sqls/insert-member-info-data.sql
#tutorial.insert-data.script=file:sqls/insert-member-info-error-data.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>launch-context.xmlを開き、<code>&lt;beans&gt;</code>タグ内に<code>&lt;jdbc:initialize-database&gt;</code>タグの定義を追加する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/spring/launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- database initialize definition --&gt;</span>
<span class="tag">&lt;jdbc:initialize-database</span> <span class="attribute-name">data-source</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${data-source.initialize.enabled:false}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ignore-failures</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${tutorial.create-table.script}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${tutorial.insert-data.script}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/jdbc:initialize-database&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_EnvironmentConstruction_InputDataPreparation_File"><a class="anchor" href="#Ch09_EnvironmentConstruction_InputDataPreparation_File"></a>9.3.5.2. ファイルアクセスでデータ入出力を行うジョブの入力データ</h5>
<div class="paragraph">
<p><a href="#Ch09_Impl_FileAccessJob">ファイルアクセスでデータ入出力を行うジョブ</a>で使用する入力データの準備を行う。<br>
なお、ファイルアクセスでデータ入出力を行うジョブを作成しない場合は実施する必要はない。</p>
</div>
<div class="paragraph">
<p>入力データの準備は入出力ファイルを格納ディレクトリの作成及び入力ファイルの作成を行う。</p>
</div>
<div class="paragraph">
<p>プロジェクトルートディレクトリに入出力ファイル格納用として以下の2ディレクトリを作成する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>files/input</code></p>
</li>
<li>
<p><code>files/output</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>files/input</code>配下に以下の2ファイルを作成する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>正常データ入力ファイル(<code>input-member-info-data.csv</code>)</p>
</li>
<li>
<p>異常データ入力ファイル(<code>input-member-info-error-data.csv</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>作成した入力ファイル格納ディレクトリに以下の内容で入力ファイルを格納する。</p>
</div>
<div class="paragraph">
<p>作成するファイルの内容を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">files/input/input-member-info-data.csv</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">00000001,G,1,0
00000002,N,1,0
00000003,G,0,10
00000004,N,0,10
00000005,G,1,100
00000006,N,1,100
00000007,G,0,1000
00000008,N,0,1000
00000009,G,1,10000
00000010,N,1,10000
00000011,G,0,100000
00000012,N,0,100000
00000013,G,1,999901
00000014,N,1,999991
00000015,G,0,999900
00000016,N,0,999990
00000017,G,1,10
00000018,N,1,10
00000019,G,0,100
00000020,N,0,100
00000021,G,1,1000
00000022,N,1,1000
00000023,G,0,10000
00000024,N,0,10000
00000025,G,1,100000
00000026,N,1,100000
00000027,G,0,1000000
00000028,N,0,1000000
00000029,G,1,999899
00000030,N,1,999989</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">files/input/input-member-info-error-data.csv</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">00000001,G,0,0
00000002,N,0,0
00000003,G,1,10
00000004,N,1,10
00000005,G,0,100
00000006,N,0,100
00000007,G,1,1000
00000008,N,1,1000
00000009,G,0,10000
00000010,N,0,10000
00000011,G,1,100000
00000012,N,1,100000
00000013,G,1,1000001
00000014,N,1,999991
00000015,G,1,999901</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_DataSourceExplorer"><a class="anchor" href="#Ch09_EnvironmentConstruction_DataSourceExplorer"></a>9.3.6. STSからデータベースを参照する準備</h4>
<div class="paragraph">
<p>チュートリアルではデータベースを参照するためにData Source Explorerを使用するため、Data Source Explorerの設定を実施する。<br>
Data Source Explorerを使用することでSTS上でデータベースの参照やSQL実行が可能となる。</p>
</div>
<div class="paragraph">
<p>チュートリアルで参照するデータベースの対象は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JobRepositoryに永続化されているバッチアプリケーション実行結果や状態を管理するためのデータ</p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob">データベースアクセスでデータ入出力を行うジョブ</a>が使用するデータ</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>まず、Data Source Explorer Viewを表示する。<br>
STSのメニューから、[Window] &#8594; [Show View] &#8594; [Other&#8230;&#8203;]を選択し、Data Management配下のData Source Explorerが選択された状態で、 [OK]を押下する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_ShowView.png" alt="Show View">
</div>
</div>
<div class="paragraph">
<p>ワークベンチ上にData Source Explorer Viewが表示される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_DataSourceExplorerView.png" alt="Data Source Explorer View">
</div>
</div>
<div class="paragraph">
<p>次に、データベースへ接続するためのConnection Profileを作成する。<br>
Data Source Explorer ViewのDatabase Connectionsを右クリックし、[New&#8230;&#8203;]を押下し、Connection Profileを表示する。<br>
そして、Generic JDBCを選択し、Nameに<code>H2 Database</code>と入力した状態で、[Next]を押下する。<br>
(Nameに入力する値は任意である。)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_NewConnectionProfileType.png" alt="New Conenction Profile Type">
</div>
</div>
<div class="paragraph">
<p>初期状態ではDriverが設定されていないためH2 Databaseへ接続するためのDriverの追加を行う。<br>
Driversのドロップダウンの右にあるNew Driver Definitionボタンを押下し、Driverの定義ウィンドウを表示する。</p>
</div>
<div class="paragraph">
<p>Name/Typeタブの、Available driver templatesにてGeneric JDBC Driverを選択する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_NewDriverDifinitionName.png" alt="New Driver Difinition Name/Type">
</div>
</div>
<div class="paragraph">
<p>次に、JAR Listタブを開き、[Add Jar/Zip&#8230;&#8203;]を押下し、H2 Databaseのjarファイルを選択し、[開く]を押下する。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">H2 Databaseのjarが格納されている場所</div>
<div class="paragraph">
<p>H2 Databaseのjarは、プロジェクトのルートディレクトリの<code>lib</code>ディレクトリ配下に格納されている。<br>
これは、<a href="#Ch09_EnvironmentConstruction_BlankProject_ExecSample">サンプルジョブの実行(正しく作成できたことの確認)</a>の下記のコマンドの実行によって依存ライブラリが<code>lib</code>ディレクトリ配下にコピーされたからである。
<code>lib</code>ディレクトリは以下にH2 Databaseのjarが格納されていない場合は下記のコマンドを実行すること。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;mvn clean dependency:copy-dependencies -DoutputDirectory=lib package</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_NewDriverDifinitionJARList.png" alt="New Driver Difinition JAR List">
</div>
</div>
<div class="paragraph">
<p>次に、Propertiesタブを開き下記の内容を設定し[OK]を押下し、Driverを追加する。</p>
</div>
<div class="paragraph">
<p>Database Nameに設定する値は任意である。その他の設定値はbatch-application.propertiesに設定されている値と同じになる。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Propertiesタブで設定する値</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jdbc:h2:~/batch-admin;AUTO_SERVER=TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">macchinetta-batch-tutorial</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Driver Class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.h2.Driver</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sa</p></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_NewDriverDifinitionProperties.png" alt="New Driver Difinition Properties">
</div>
</div>
<div class="paragraph">
<p>設定した内容でDriverが追加されていることを確認し、[Finish]を押下する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_NewConnectionProfileDetails.png" alt="New Conenction Profile Details">
</div>
</div>
<div class="paragraph">
<p>Connection Profileの作成が完了すると、Data Source Explorer ViewにH2 DatabaseへのConnectionが表示される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_DataSourceExplorerAddedConnection.png" alt="Data Source Explorer added Connection">
</div>
</div>
<div class="paragraph">
<p>以上でSTSからデータベースを参照する準備が完了した。<br>
Data Source Explorerの設定確認は<a href="#Ch09_EnvironmentConstruction_OperationCheck">プロジェクトの動作確認</a>にて実施する。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_OperationCheck"><a class="anchor" href="#Ch09_EnvironmentConstruction_OperationCheck"></a>9.3.7. プロジェクトの動作確認</h4>
<div class="paragraph">
<p>プロジェクトの動作確認の手順を以下に示す。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob">STSでジョブを実行する</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_OperationCheck_RefDB">Data Source Explorerを使用してデータベースを参照する</a></p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="Ch09_EnvironmentConstruction_OperationCheck_ExecJob"><a class="anchor" href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob"></a>9.3.7.1. STSでジョブを実行する</h5>
<div class="paragraph">
<p>STSでジョブを実行する手順を以下に示す。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_RunConf">Run Configuration(実行構成)の作成</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">ジョブの実行方法について</div>
<div class="paragraph">
<p>本来であればジョブはシェルスクリプトなどから実行するが、本チュートリアルでは説明のしやすさからSTSでジョブを実行する手順としている。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_EnvironmentConstruction_OperationCheck_ExecJob_RunConf"><a class="anchor" href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_RunConf"></a>9.3.7.1.1. Run Configuration(実行構成)の作成</h6>
<div class="paragraph">
<p>Run Configuration(実行構成)を作成する方法についてサンプルジョブの実行を例にして説明する。</p>
</div>
<div class="paragraph">
<p>STSのメニューから、[Run] &#8594; [Run Configurations&#8230;&#8203;] &#8594; タイプの一覧からJava Applicationを選択して右クリック &#8594; [New]を選択しRun Configuration作成画面を表示し、以下の値を設定する。<br></p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Run ConfigurationsのMainタブで設定する値</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項目名</th>
<th class="tableblock halign-left valign-top">値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute Job01<br>
(任意の値を設定する)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Project</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">macchinetta-batch-tutorial</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Main class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch.core.launch.support.CommandLineJobRunner</p></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_ExecJob_RunConf_Main.png" alt="Run Configurations Main tab">
</div>
</div>
<div class="paragraph">
<p>次にArgumentsタブを開き、以下の値を設定する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Run ConfigurationsのArgumentsタブで設定する値</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項目名</th>
<th class="tableblock halign-left valign-top">値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Program arguments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF/jobs/job01.xml job01</p></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_ExecJob_RunConf_Arg.png" alt="Run Configurations Arguments tab">
</div>
</div>
<div class="paragraph">
<p>設定が完了したら[Apply]を押下する。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Run Configurationの作成で設定する値について</div>
<div class="paragraph">
<p>Run Configurationに<a href="#Ch09_EnvironmentConstruction_BlankProject_ExecSample">サンプルジョブの実行(正しく作成できたことの確認)</a>のコマンドと同様のパラメータを設定する。<br>
ただし、クラスパスはMainタブのProjectへプロジェクトを設定するとSTSによって自動的に解決される。<br>
Run Configurationに設定するパラメータは、実行するジョブによってパラメータを変更してほしい。<br>
なお、ファイルアクセスするジョブの場合はinputFileやoutputFileのパラメータも必要になるため留意すること。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run"><a class="anchor" href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run"></a>9.3.7.1.2. ジョブの実行と結果の確認</h6>
<div class="paragraph">
<p>ジョブの実行及び結果の確認方法について説明する。<br>
ここで説明するジョブの実行結果の確認とはコンソールログの確認及びジョブ実行の終了コードの確認である。</p>
</div>
<div class="paragraph">
<p>チュートリアルではジョブ実行の終了コードを確認するため、Debug Viewを使用する。Debug Viewの表示方法は後述する。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Debug Viewを表示する理由</div>
<div class="paragraph">
<p>STSでDebug Viewを表示しないとジョブの実行時の終了コードを確認することはできない。<br>
<a href="#Ch09_ExceptionHandlingWithTryCatchJob">try-catchで例外ハンドリングを行うジョブ</a>ではリスナーにてジョブの終了コードの変換するため、Debug Viewを表示して結果を確認する必要がある。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>はじめにジョブを実行する方法について説明する。</p>
</div>
<div class="paragraph">
<p>STSのメニューから、[Run] &#8594; [Run Configurations&#8230;&#8203;] &#8594; タイプの一覧からJava Application配下にある<a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_RunConf">Run Configuration(実行構成)の作成</a>にて作成したExecute Job01を選択して[Run]を押下することでジョブが実行される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run_Job01.png" alt="Run Job01">
</div>
</div>
<div class="paragraph">
<p>ジョブの実行結果はコンソールログにて確認する。<br>
以下のように表示されていれば正常にジョブが実行されている。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run_Job01Console.png" alt="Run Job01 console">
</div>
</div>
<div class="paragraph">
<p>次に、Debug Viewを表示させてジョブ実行の終了コードを確認する。</p>
</div>
<div class="paragraph">
<p>STSのメニューから、[Window] &#8594; [Show View] &#8594; [Other&#8230;&#8203;]を選択し、Debug配下のDebugが選択された状態で、 [OK]を押下する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run_ShowView.png" alt="Show View">
</div>
</div>
<div class="paragraph">
<p>ワークベンチ上にDebugが表示される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run_DebugView.png" alt="Debug View">
</div>
</div>
<div class="paragraph">
<p><code>&lt;terminated, exit value: 0&gt;</code>という表示により、ジョブ実行の終了コードが<code>0</code>であることが確認できる。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">STSでジョブの実行が失敗する場合について</div>
<div class="paragraph">
<p>正しいソースコードにもかかわらずSTSでジョブの実行が失敗する場合、不完全なビルド状態を解消することによりジョブの実行が成功する可能性がある。手順を以下に示す。<br>
STSのメニューから、[project] &#8594; [clean]を選択する。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_EnvironmentConstruction_OperationCheck_RefDB"><a class="anchor" href="#Ch09_EnvironmentConstruction_OperationCheck_RefDB"></a>9.3.7.2. Data Source Explorerを使用してデータベースを参照する</h5>
<div class="paragraph">
<p>Data Source Explorer Viewを使用してデータベースを参照する方法について説明する。</p>
</div>
<div class="paragraph">
<p>Data Source Explorerにてデータベース<code>BATCH-ADMIN</code>を下記の階層で開くとテーブルの一覧を確認することができる。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_RefDB_Tables.png" alt="Show Tables">
</div>
</div>
<div class="paragraph">
<p>Spring Batchメタデータテーブル(詳細は<a href="#Ch02_SpringBatchArch_Arch_MetadataSchema">JobRepositoryのメタデータスキーマ</a>を参照)及び、
<a href="#Ch09_EnvironmentConstruction_InputDataPreparation_DB">データベースアクセスでデータ入出力を行うジョブの入力データの準備</a>を実施した場合には<code>MEMBER_INFO</code>テーブルが作成されていることが確認できる。</p>
</div>
<div class="paragraph">
<p>次に、テーブルに格納されているレコードは以下の方法で参照することができる。</p>
</div>
<div class="paragraph">
<p>参照したいテーブルを右クリック、[Data] &#8594; [Edit]と選択することでテーブル形式でテーブルに格納されているレコードを参照することができる。<br>
以下は<code>BATCH_JOB_INSTANCE</code>テーブルを参照した例である。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_RefDB_BATCH_JOB_INSTANCE.png" alt="Show BATCH_JOB_INSTANCE">
</div>
</div>
<div class="paragraph">
<p><code>job01</code>という名前のジョブが実行されたことがわかる。</p>
</div>
<div class="paragraph">
<p>以上でチュートリアルの環境構築は完了である。</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_single_index"><a class="anchor" href="#Ch09_Impl_single_index"></a>9.4. バッチジョブの実装</h3>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob"><a class="anchor" href="#Ch09_Impl_DBAccessJob"></a>9.4.1. データベースアクセスでデータ入出力を行うジョブ</h4>
<div class="sect4">
<h5 id="Ch09_Impl_DBAccessJob_Overview"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Overview"></a>9.4.1.1. 概要</h5>
<div class="paragraph">
<p>データベースアクセスを行うジョブを作成する。</p>
</div>
<div class="paragraph">
<p>なお、本節はMacchinetta Batch 2.x 開発ガイドラインを元に説明しているため、
詳細については<a href="#Ch05_DBAccess">データベースアクセス</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p><a href="#Ch09_TutorialApplication">作成するアプリケーションの説明</a>の
背景、処理概要、業務仕様を以下に再掲する。</p>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Overview_Background"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Overview_Background"></a>9.4.1.1.1. 背景</h6>
<div class="paragraph">
<p>とある量販店では、会員に対してポイントカードを発行している。<br>
会員には「ゴールド会員」「一般会員」の会員種別が存在し、会員種別に応じたサービスを提供している。<br>
今回そのサービスの一環として、月内に商品を購入した会員のうち、
会員種別が「ゴールド会員」の場合は100ポイント、「一般会員」の場合は10ポイントを月末に加算することにした。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Overview_ProcessOverview"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Overview_ProcessOverview"></a>9.4.1.1.2. 処理概要</h6>
<div class="paragraph">
<p>会員種別に応じてポイント加算を行うアプリケーションを
月次バッチ処理としてMacchinetta Batch 2.xを使用して実装する。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Overview_BusinessSpecification"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Overview_BusinessSpecification"></a>9.4.1.1.3. 業務仕様</h6>
<div class="paragraph">
<p>業務仕様は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>商品購入フラグが"1"(処理対象)の場合に、会員種別に応じてポイントを加算する</p>
<div class="ulist">
<ul>
<li>
<p>会員種別が"G"(ゴールド会員)の場合は100ポイント、"N"(一般会員)の場合は10ポイント加算する</p>
</li>
</ul>
</div>
</li>
<li>
<p>商品購入フラグはポイント加算後に"0"(初期状態)に更新する</p>
</li>
<li>
<p>ポイントの上限値は1,000,000ポイントとする</p>
</li>
<li>
<p>ポイント加算後に1,000,000ポイントを超えた場合は、1,000,000ポイントに補正する</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Overview_TableSpecification"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Overview_TableSpecification"></a>9.4.1.1.4. テーブル仕様</h6>
<div class="paragraph">
<p>入出力リソースとなる会員情報テーブルの仕様は以下のとおり。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">会員情報テーブル(member_info)</caption>
<colgroup>
<col style="width: 3.0927%;">
<col style="width: 15.4639%;">
<col style="width: 10.3092%;">
<col style="width: 4.1237%;">
<col style="width: 12.3711%;">
<col style="width: 8.2474%;">
<col style="width: 46.392%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">属性名</th>
<th class="tableblock halign-left valign-top">カラム名</th>
<th class="tableblock halign-left valign-top">PK</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">桁数</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員を一意に示す8桁固定の番号を表す。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の種別を以下のとおり表す。<br>
"G"(ゴールド会員)、"N"(一般会員)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">月内に商品を買ったかどうかを表す。<br>
商品購入で"1"(処理対象)、月次バッチ処理で"0"(初期状態)に更新される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイント</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">point</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の保有するポイントを表す。<br>
初期値は0。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">テーブル仕様について</div>
<div class="paragraph">
<p>チュートリアルを実施するうえでの便宜を図り、
実際の業務に即したテーブル設計は行っていないため留意すること。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Overview_JobOverview"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Overview_JobOverview"></a>9.4.1.1.5. ジョブの概要</h6>
<div class="paragraph">
<p>ここで作成するデータベースアクセスするジョブの概要を把握するために、
処理フローおよび処理シーケンスを以下に示す。</p>
</div>
<div class="paragraph">
<p>処理シーケンスではトランザクション制御の範囲について触れている。
ジョブのトランザクション制御はSpring Batchがもつ仕組みを利用しており、これをフレームワークトランザクションと定義して説明する。
トランザクション制御の詳細は<a href="#Ch05_Transaction">トランザクション制御</a>を参照のこと。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">処理フロー概要</dt>
<dd>
<p>処理フローの概要を以下に示す。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/DBAccess/Ch09_DBAccessJob_ProcessFlow.png" alt="ProcessFlow of DBAccess Job">
</div>
<div class="title">データベースアクセスジョブの処理フロー</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンクモデルの場合の処理シーケンス</dt>
<dd>
<p>チャンクモデルの場合の処理シーケンスを説明する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_DBAccessJob_ProcessSequence_ChunkModel.png" alt="ProcessSequence of DBAccess Job by ChunkModel">
</div>
<div class="title">チャンクモデルのシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
</li>
<li>
<p>ステップは、リソースをオープンする。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから会員情報をすべて取得(select文の発行)する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで、以降の処理を繰り返す。</p>
</li>
<li>
<p>チャンク単位で、フレームワークトランザクションを開始する。</p>
</li>
<li>
<p>チャンクサイズに達するまで4から10までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは、<code>MyBatisCursorItemReader</code>から入力データを1件取得する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから入力データを1件取得する。</p>
</li>
<li>
<p>member_infoテーブルは、<code>MyBatisCursorItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、ステップに入力データを返却する。</p>
</li>
<li>
<p>ステップは、<code>PointAddItemProcessor</code>で入力データに対して処理を行う。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、入力データを読み込んでポイント加算処理を行う。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、ステップに処理結果を返却する。</p>
</li>
<li>
<p>ステップは、チャンクサイズ分のデータを<code>MyBatisBatchItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>MyBatisBatchItemWriter</code>は、member_infoテーブルに対して会員情報の更新(update文の発行)を行う。</p>
</li>
<li>
<p>ステップはフレームワークトランザクションをコミットする。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは正常終了:0)を返却する。</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">タスクレットモデルの場合の処理シーケンス</dt>
<dd>
<p>タスクレットモデルの場合の処理シーケンスについて説明する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>このチュートリアルでは、タスクレットモデルでもチャンクモデルのように一定件数のデータをまとめて処理する方式としている。
大量データを効率的に処理できるなどのメリットがある。詳細は<a href="#Ch03_CreateTaskletJob_HowToUse_InOutImpl">チャンクモデルのコンポーネントを利用するTasklet実装</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_DBAccessJob_ProcessSequence_TaskletModel.png" alt="ProcessSequence of DBAccess Job by TaskletModel">
</div>
<div class="title">タスクレットモデルのシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
<div class="ulist">
<ul>
<li>
<p>ステップはフレームワークトランザクションを開始する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは<code>PointAddTasklet</code>を実行する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、リソースをオープンする。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから会員情報をすべて取得(select文の発行)する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで5から9までの処理を繰り返す。</p>
</li>
<li>
<p>一定件数に達するまで5から11までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>PointAddTasklet</code>は、<code>MyBatisCursorItemReader</code>から入力データを1件取得する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから入力データを1件取得する。</p>
</li>
<li>
<p>member_infoテーブルは、<code>MyBatisCursorItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、タスクレットに入力データを返却する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、入力データを読み込んでポイント加算処理を行う。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、一定件数分のデータを<code>MyBatisBatchItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>MyBatisBatchItemWriter</code>は、member_infoテーブルに対して会員情報の更新(update文の発行)を行う。</p>
</li>
<li>
<p><code>PointAddTasklet</code>はステップへ処理終了を返却する。</p>
</li>
<li>
<p>ステップはフレームワークトランザクションをコミットする。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは正常終了:0)を返却する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>以降で、チャンクモデル、タスクレットモデルそれぞれの実装方法を説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk">チャンクモデルでの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet">タスクレットモデルでの実装</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_DBAccessJob_Chunk"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk"></a>9.4.1.2. チャンクモデルでの実装</h5>
<div class="paragraph">
<p>チャンクモデルでデータベースアクセスするジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_JobDefinition">ジョブBean定義ファイルの作成</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_Dto">DTOの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis">MyBatisによるデータベースアクセスの定義</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_Logic">ロジックの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Chunk_JobDefinition"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_JobDefinition"></a>9.4.1.2.1. ジョブBean定義ファイルの作成</h6>
<div class="paragraph">
<p>Bean定義ファイルにて、チャンクモデルでデータベースアクセスを行うジョブを構成する要素の組み合わせ方を設定する。<br>
ここでは、Bean定義ファイルの枠および共通的な設定のみ記述し、以降の項で各構成要素の設定を行う。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Macchinetta Batch 2.xを利用する際に、常に必要なBean定義を読み込む設定をインポートする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャンの設定を行う。<br>
<code>base-package</code>属性に、使用するコンポーネント(ItemProcessorの実装クラスなど)が格納されているパッケージを指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Chunk_Dto"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Dto"></a>9.4.1.2.2. DTOの実装</h6>
<div class="paragraph">
<p>業務データを保持するためのクラスとしてDTOクラスを実装する。<br>
DTOクラスはテーブルごとに作成する。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.dto.MemberInfoDTO</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.dto</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MemberInfoDto</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> id; <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> type; <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> status; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="type">int</span> point; <span class="comment">// (4)</span>

    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> id;
    }

    <span class="directive">public</span> <span class="type">void</span> setId(<span class="predefined-type">String</span> id) {
        <span class="local-variable">this</span>.id = id;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getType() {
        <span class="keyword">return</span> type;
    }

    <span class="directive">public</span> <span class="type">void</span> setType(<span class="predefined-type">String</span> type) {
        <span class="local-variable">this</span>.type = type;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getStatus() {
        <span class="keyword">return</span> status;
    }

    <span class="directive">public</span> <span class="type">void</span> setStatus(<span class="predefined-type">String</span> status) {
        <span class="local-variable">this</span>.status = status;
    }

    <span class="directive">public</span> <span class="type">int</span> getPoint() {
        <span class="keyword">return</span> point;
    }

    <span class="directive">public</span> <span class="type">void</span> setPoint(<span class="type">int</span> point) {
        <span class="local-variable">this</span>.point = point;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号に対応するフィールドとして<code>id</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別に対応するフィールドとして<code>type</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグに対応するフィールドとして<code>status</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイントに対応するフィールドとして<code>point</code>を定義する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Chunk_MyBatis"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis"></a>9.4.1.2.3. MyBatisによるデータベースアクセスの定義</h6>
<div class="paragraph">
<p>MyBatisを利用してデータベースアクセスするための実装・設定を行う。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_Repository">Repositoryインターフェースの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_MapperXML">MapperXMLファイルの作成</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Chunk_MyBatis_Repository"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_Repository"></a>Repositoryインターフェースの実装</h7>
<div class="paragraph">
<p>MapperXMLファイルに定義したSQLを呼び出すためのインターフェースを実装する。<br>
このインターフェースに対する実装クラスは、MyBatisが自動で生成するため、開発者はインターフェースのみ作成すればよい。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.repository.MemberInfoRepository</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.repository</span>;

<span class="keyword">import</span> <span class="include">com.example.batch.tutorial.common.dto.MemberInfoDto</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">MemberInfoRepository</span> {
  <span class="predefined-type">List</span>&lt;MemberInfoDto&gt; findAll(); <span class="comment">// (1)</span>

  <span class="type">int</span> updatePointAndStatus(MemberInfoDto memberInfo); <span class="comment">// (2)</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MapperXMLファイルに定義するSQLのIDに対応するメソッドを定義する。<br>
ここでは、member_infoテーブルからすべてのレコードを取得するためのメソッドを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ここでは、member_infoテーブルのpointカラムとstatusカラムを更新するためのメソッドを定義する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Chunk_MyBatis_MapperXML"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_MapperXML"></a>MapperXMLファイルの作成</h7>
<div class="paragraph">
<p>SQLとO/Rマッピングの設定を記載するMapperXMLファイルを作成する。<br>
MapperXMLファイルは、Repositoryインターフェースごとに作成する。</p>
</div>
<div class="paragraph">
<p>MyBatisが定めたルールに則ったディレクトリに格納することで、自動的にMapperXMLファイルを読み込むことができる。
MapperXMLファイルを自動的に読み込ませるために、Repositoryインターフェースのパッケージ階層と同じ階層のディレクトリにMapperXMLファイルを格納する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/com/example/batch/tutorial/common/repository/MemberInfoRepository.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="doctype">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findAll</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        SELECT
            id,
            type,
            status,
            point
        FROM
            member_info
        ORDER BY
            id ASC
    <span class="tag">&lt;/select&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;update</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updatePointAndStatus</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        UPDATE
            member_info
        SET
            status = #{status},
            point = #{point}
        WHERE
            id = #{id}
    <span class="tag">&lt;/update&gt;</span>
<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mapper要素のnamespace属性に、Repositoryインターフェースの完全修飾クラス名(FQCN)を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">参照系のSQLの設定を行う。<br>
ここでは、member_infoテーブルからすべてのレコードを取得するSQLを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新系のSQLの設定を行う。<br>
ここでは、member_infoテーブルの指定したidに一致するレコードについて、
ステータスとポイントを更新するSQLを設定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Chunk_MyBatis_Bean"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_Bean"></a>ジョブBean定義ファイルの設定</h7>
<div class="paragraph">
<p>MyBatisによるデータベースアクセスするための設定として、ジョブBean定義ファイルに以下の(1)～(3)を追記する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;mybatis:scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.findAll</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.updatePointAndStatus</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repositoryインターフェースをスキャンするための設定を行う。<br>
<code>base-package</code>属性に、Repositoryインターフェースが格納されている基底パッケージを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReaderの設定を行う。<br>
<code>class</code>属性に、MyBatisが提供しているSpring連携ライブラリであるMyBatis-Springから提供されている<code>org.mybatis.spring.batch.MyBatisCursorItemReader</code>を指定する。
データベースから大量データを取得する際は、この<code>MyBatisCursorItemReader</code>を使用する。
詳細は<a href="#Ch05_DBAccess_HowToUse_Input">入力</a>を参照のこと。<br>
<code>queryId</code>属性に、MapperXMLファイルに設定するSQLの<code>namespace</code>+<code>id</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriterの設定を行う。<br>
<code>class</code>属性に、MyBatisが提供しているSpring連携ライブラリであるMyBatis-Springから提供されている<code>org.mybatis.spring.batch.MyBatisBatchItemWriter</code>を指定する。<br>
<code>statementId</code>属性に、MapperXMLファイルに設定するSQLの<code>namespace</code>+<code>id</code>を指定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">ItemReader・ItemWriter以外のデータベースアクセス</div>
<div class="paragraph">
<p>ItemReader・ItemWriter以外でデータベースアクセスする方法として、Mapperインターフェースを利用する方法がある。
Mapperインターフェースを利用するにあたっては、Macchinetta Batch 2.xとして制約を設けているため、
<a href="#Ch05_DBAccess_HowToUse_Input_MapperInterface">Mapperインターフェース(入力)</a>、<a href="#Ch05_DBAccess_HowToUse_Output_MapperInterface">Mapperインターフェース(出力)</a>を参照してほしい。
ItemProcessorの実装例は、<a href="#Ch05_DBAccess_HowToUse_Input_MapperInterface_Chunk">チャンクモデルにおける利用方法</a>(入力)、
<a href="#Ch05_DBAccess_HowToUse_Output_MapperInterface_Chunk">チャンクモデルにおける利用方法</a>(出力)を参照のこと。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Chunk_Logic"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Logic"></a>9.4.1.2.4. ロジックの実装</h6>
<div class="paragraph">
<p>ポイント加算処理を行うビジネスロジッククラスを実装する。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_Logic_ItemProcessor">PointAddItemProcessorクラスの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_Logic_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Chunk_Logic_ItemProcessor"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Logic_ItemProcessor"></a>PointAddItemProcessorクラスの実装</h7>
<div class="paragraph">
<p>ItemProcessorインターフェースを実装したPointAddItemProcessorクラスを実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.dbaccess.chunk.PointAddItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.dbaccess.chunk</span>;

<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemProcessor</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;
<span class="keyword">import</span> <span class="include">com.example.batch.tutorial.common.dto.MemberInfoDto</span>;

<span class="annotation">@Component</span> <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PointAddItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;MemberInfoDto, MemberInfoDto&gt; { <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> TARGET_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> INITIAL_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (4)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> GOLD_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">G</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (5)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NORMAL_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">N</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (6)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> MAX_POINT = <span class="integer">1000000</span>; <span class="comment">// (7)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> MemberInfoDto process(MemberInfoDto item) <span class="directive">throws</span> <span class="exception">Exception</span> { <span class="comment">// (8) (9) (10)</span>
        <span class="keyword">if</span> (TARGET_STATUS.equals(item.getStatus())) {
            <span class="keyword">if</span> (GOLD_MEMBER.equals(item.getType())) {
                item.setPoint(item.getPoint() + <span class="integer">100</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (NORMAL_MEMBER.equals(item.getType())) {
                item.setPoint(item.getPoint() + <span class="integer">10</span>);
            }

            <span class="keyword">if</span> (item.getPoint() &gt; MAX_POINT) {
                item.setPoint(MAX_POINT);
            }

            item.setStatus(INITIAL_STATUS);
        }

        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャンの対象とするため、<code>@Component</code>アノテーションを付与してBean定義を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入出力で使用するオブジェクトの型をそれぞれ型引数に指定した<code>ItemProcessor</code>インターフェースを実装する。<br>
ここでは、入出力で使用するオブジェクトは共に<a href="#Ch09_Impl_DBAccessJob_Chunk_Dto">DTOの実装</a>で作成した<code>MemberInfoDTO</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイント加算対象とする商品購入フラグ:1を定義する。<br>
本来、このようなフィールド定数は定数クラスなどに定義し、ロジックに定義することはあまりない。
このチュートリアルでは、便宜上、定数として定義していることを留意すること。(以降の定数も同様)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、商品購入フラグの初期値:0を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員種別:G(ゴールド会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員種別:N(一般会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイントの上限値:1000000を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグおよび、会員種別に応じてポイント加算するビジネスロジックを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">返り値の型は、このクラスで実装している<code>ItemProcessor</code>インターフェースの型引数で指定した
出力オブジェクトの型である<code>MemberInfoDTO</code>とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数として受け取る<code>item</code>の型は、
このクラスで実装している<code>ItemProcessor</code>インターフェースの型引数で指定した入力オブジェクトの型である<code>MemberInfoDTO</code>とする。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Chunk_Logic_Bean"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Logic_Bean"></a>ジョブBean定義ファイルの設定</h7>
<div class="paragraph">
<p>作成したビジネスロジックをジョブとして設定するため、ジョブBean定義ファイルに以下の(1)以降を追記する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;mybatis:scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.findAll</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.updatePointAndStatus</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddChunk</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddChunk.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pointAddItemProcessor</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;/batch:tasklet&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要がある。<br>
ここでは、チャンクモデルのジョブ名として<code>jobPointAddChunk</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要はないが、障害発生時に追跡しやすくなる等の様々なメリットがあるため一意とする。<br>
特別な理由がない限り、(1)で指定したid属性に[step+連番]を付加する形式とする。<br>
ここでは、チャンクモデルのジョブのステップ名として<code>jobPointAddChunk.step01</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンクモデルジョブの設定を行う。<br>
<code>reader</code>、<code>writer</code>それぞれの属性に、前項までに定義した<code>ItemReader</code>、<code>ItemWriter</code>のBeanIDを指定する。<br>
<code>processor</code>属性に、ItemProcessorの実装クラスのBeanIDである<code>pointAddItemProcessor</code>を指定する。<br>
<code>commit-interval</code>属性に、1チャンクあたりの入力データ件数を10件として設定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">commit-intervalのチューニング</div>
<div class="paragraph">
<p>commit-intervalはチャンクモデルジョブにおける、性能上のチューニングポイントである。</p>
</div>
<div class="paragraph">
<p>このチュートリアルでは10件としているが、利用できるマシンリソースやジョブの特性によって適切な件数は異なる。
複数のリソースにアクセスしてデータを加工するジョブであれば10件から100件程度で処理スループットが頭打ちになることもある。
一方、入出力リソースが1:1対応しておりデータを移し替える程度のジョブであれば5,000件や10,000件でも処理スループットが伸びることがある。</p>
</div>
<div class="paragraph">
<p>ジョブ実装時のcommit-intervalは100件程度で仮置きしておき、 その後に実施した性能測定の結果に応じてジョブごとにチューニングするとよい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Chunk_Execution"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Execution"></a>9.4.1.2.5. ジョブの実行と結果の確認</h6>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Chunk_Execution_Run"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Run"></a>実行構成からジョブを実行</h7>
<div class="paragraph">
<p>以下のとおり実行構成を作成し、ジョブを実行する。<br>
実行構成の作成手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck">プロジェクトの動作確認</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">実行構成の設定値</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Name: 任意の名称(例: Run DBAccessJob for ChunkModel)</p>
</li>
<li>
<p>Mainタブ</p>
<div class="ulist">
<ul>
<li>
<p>Project: <code>macchinetta-batch-tutorial</code></p>
</li>
<li>
<p>Main class: <code>org.springframework.batch.core.launch.support.CommandLineJobRunner</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Argumentsタブ</p>
<div class="ulist">
<ul>
<li>
<p>Program arguments: <code>META-INF/jobs/dbaccess/jobPointAddChunk.xml jobPointAddChunk</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Chunk_Execution_Console"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Console"></a>コンソールログの確認</h7>
<div class="paragraph">
<p>Consoleに以下の内容のログが出力されていることを確認する。</p>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/09/12 13:32:32] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddChunk]] completed with the following parameters: [{jsr_batch_run_id=484}] and the following status: [COMPLETED]
[2017/09/12 13:32:32] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@735f7ae5: startup date [Tue Sep 12 13:32:29 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Chunk_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Exitcode"></a>終了コードの確認</h7>
<div class="paragraph">
<p>終了コードにより、正常終了したことを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が0(正常終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/DBAccess/Ch09_DBAccessJob_Confirm_ExitCode_ChunkModel.png" alt="Confiｒm the Exit Code of DBAccessJob for ChunkModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Chunk_Execution_Table"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Table"></a>会員情報テーブルの確認</h7>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容を比較し、確認内容のとおりとなっていることを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_RefDB">Data Source Explorerを使用してデータベースを参照する</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>statusカラム</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointカラム</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeカラムが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeカラムが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
<li>
<p>1,000,000(上限値)を超えたレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容は以下のとおり。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/DBAccess/Ch09_DBAccessJob_Result_MemberInfoTable.png" alt="Table of member_info">
</div>
<div class="title">更新前後の会員情報テーブルの内容</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_DBAccessJob_Tasklet"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet"></a>9.4.1.3. タスクレットモデルでの実装</h5>
<div class="paragraph">
<p>タスクレットモデルでデータベースアクセスするジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_JobDefinition">ジョブBean定義ファイルの作成</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_Dto">DTOの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis">MyBatisによるデータベースアクセスの定義</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_Logic">ロジックの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Tasklet_JobDefinition"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_JobDefinition"></a>9.4.1.3.1. ジョブBean定義ファイルの作成</h6>
<div class="paragraph">
<p>Bean定義ファイルにて、タスクレットモデルでデータベースアクセスを行うジョブを構成する要素の組み合わせ方を設定する。<br>
ここでは、Bean定義ファイルの枠および共通的な設定のみ記述し、以降の項で各構成要素の設定を行う。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddtasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.tasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Macchinetta Batch 2.xを利用する際に、常に必要なBean定義を読み込む設定をインポートする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャンの設定を行う。<br>
<code>base-package</code>属性に、使用するコンポーネント(Taskletの実装クラスなど)が格納されているパッケージを指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Tasklet_Dto"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Dto"></a>9.4.1.3.2. DTOの実装</h6>
<div class="paragraph">
<p>業務データを保持するためのクラスとしてDTOクラスを作成する。<br>
DTOクラスはテーブルごとに作成する。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.dto.MemberInfoDTO</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.dto</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MemberInfoDto</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> id; <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> type; <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> status; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="type">int</span> point; <span class="comment">// (4)</span>

    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> id;
    }

    <span class="directive">public</span> <span class="type">void</span> setId(<span class="predefined-type">String</span> id) {
        <span class="local-variable">this</span>.id = id;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getType() {
        <span class="keyword">return</span> type;
    }

    <span class="directive">public</span> <span class="type">void</span> setType(<span class="predefined-type">String</span> type) {
        <span class="local-variable">this</span>.type = type;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getStatus() {
        <span class="keyword">return</span> status;
    }

    <span class="directive">public</span> <span class="type">void</span> setStatus(<span class="predefined-type">String</span> status) {
        <span class="local-variable">this</span>.status = status;
    }

    <span class="directive">public</span> <span class="type">int</span> getPoint() {
        <span class="keyword">return</span> point;
    }

    <span class="directive">public</span> <span class="type">void</span> setPoint(<span class="type">int</span> point) {
        <span class="local-variable">this</span>.point = point;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号に対応するフィールドとして<code>id</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別に対応するフィールドとして<code>type</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグに対応するフィールドとして<code>status</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイントに対応するフィールドとして<code>point</code>を定義する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Tasklet_MyBatis"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis"></a>9.4.1.3.3. MyBatisによるデータベースアクセスの定義</h6>
<div class="paragraph">
<p>MyBatisを利用してデータベースアクセスするための実装・設定を行う。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Repository">Repositoryインターフェースの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_MapperXML">MapperXMLファイルの作成</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Repository"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Repository"></a>Repositoryインターフェースの実装</h7>
<div class="paragraph">
<p>MapperXMLファイルに定義したSQLを呼び出すためのインターフェースを作成する。<br>
このインターフェースに対する実装クラスは、MyBatisが自動で生成するため、開発者はインターフェースのみ作成すればよい。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.repository.MemberInfoRepository</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.repository</span>;

<span class="keyword">import</span> <span class="include">com.example.batch.tutorial.common.dto.MemberInfoDto</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">MemberInfoRepository</span> {
    <span class="predefined-type">List</span>&lt;MemberInfoDto&gt; findAll(); <span class="comment">// (1)</span>

    <span class="type">int</span> updatePointAndStatus(MemberInfoDto memberInfo); <span class="comment">// (2)</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MapperXMLファイルに定義するSQLのIDに対応するメソッドを定義する。<br>
ここでは、member_infoテーブルからすべてのレコードを取得するためのメソッドを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ここでは、member_infoテーブルのpointカラムとstatusカラムを更新するためのメソッドを定義する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Tasklet_MyBatis_MapperXML"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_MapperXML"></a>MapperXMLファイルの作成</h7>
<div class="paragraph">
<p>SQLとO/Rマッピングの設定を記載するMapperXMLファイルを作成する。<br>
MapperXMLファイルは、Repositoryインターフェースごとに作成する。</p>
</div>
<div class="paragraph">
<p>MyBatisが定めたルールに則ったディレクトリに格納することで、自動的にMapperXMLファイルを読み込むことができる。
MapperXMLファイルを自動的に読み込ませるために、Repositoryインターフェースのパッケージ階層と同じ階層のディレクトリにMapperXMLファイルを格納する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/com/example/batch/tutorial/common/repository/MemberInfoRepository.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="doctype">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findAll</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        SELECT
            id,
            type,
            status,
            point
        FROM
            member_info
        ORDER BY
            id ASC
    <span class="tag">&lt;/select&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;update</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updatePointAndStatus</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        UPDATE
            member_info
        SET
            status = #{status},
            point = #{point}
        WHERE
            id = #{id}
    <span class="tag">&lt;/update&gt;</span>
<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mapper要素のnamespace属性に、Repositoryインターフェースの完全修飾クラス名(FQCN)を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">参照系のSQLの定義を行う。<br>
ここでは、member_infoテーブルからすべてのレコードを取得するSQLを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新系のSQLの定義を行う。<br>
ここでは、member_infoテーブルの指定したidに一致するレコードについて、
statusとpointを更新するSQLを設定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Bean"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Bean"></a>ジョブBean定義ファイルの設定</h7>
<div class="paragraph">
<p>MyBatisによるデータベースアクセスするための設定として、ジョブBean定義ファイルに以下の(1)～(3)を追記する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddTasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.tasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;mybatis:scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.findAll</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.updatePointAndStatus</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repositoryインターフェースをスキャンするための設定を行う。<br>
<code>base-package</code>属性に、Repositoryインターフェースが格納されている基底パッケージを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReaderの設定を行う。<br>
<code>class</code>属性に、MyBatisが提供しているSpring連携ライブラリMyBatis-Springから提供されている<code>org.mybatis.spring.batch.MyBatisCursorItemReader</code>を指定する。<br>
<code>queryId</code>属性に、MapperXMLファイルに設定するSQLの<code>namespace</code>+<code>id</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriterの設定を行う。<br>
<code>class</code>属性に、MyBatisが提供しているSpring連携ライブラリMyBatis-Springから提供されている<code>org.mybatis.spring.batch.MyBatisBatchItemWriter</code>を指定する。<br>
<code>statementId</code>属性に、MapperXMLファイルに設定するSQLの<code>namespace</code>+<code>id</code>を指定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">チャンクモデルのコンポーネントを利用するTasklet実装</div>
<div class="paragraph">
<p>このチュートリアルでは、タスクレットモデルでデータベースアクセスするジョブの作成を容易に実現するために、
チャンクモデルのコンポーネントであるItemReader・ItemWriterを利用している。</p>
</div>
<div class="paragraph">
<p>Tasklet実装の中でチャンクモデルの各種コンポーネントを利用するかどうかは、
<a href="#Ch03_CreateTaskletJob_HowToUse_InOutImpl">チャンクモデルのコンポーネントを利用するTasklet実装</a>を参照して適宜判断してほしい。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">ItemReader・ItemWriter以外のデータベースアクセス</div>
<div class="paragraph">
<p>ItemReader・ItemWriter以外でデータベースアクセスする方法として、Mapperインターフェースを利用する方法がある。
Mapperインターフェースを利用するにあたっては、Macchinetta Batch 2.xとして制約を設けているため、
<a href="#Ch05_DBAccess_HowToUse_Input_MapperInterface">Mapperインターフェース(入力)</a>、<a href="#Ch05_DBAccess_HowToUse_Output_MapperInterface">Mapperインターフェース(出力)</a>を参照してほしい。
Taskletの実装例は、<a href="#Ch05_DBAccess_HowToUse_Input_MapperInterface_Tasklet">タスクレットモデルにおける利用方法</a>(入力)、
<a href="#Ch05_DBAccess_HowToUse_Output_MapperInterface_Tasklet">タスクレットモデルにおける利用方法</a>(出力)を参照のこと。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Tasklet_Logic"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Logic"></a>9.4.1.3.4. ロジックの実装</h6>
<div class="paragraph">
<p>ポイント加算処理を行うビジネスロジッククラスを実装する。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_Logic_Tasklet">PointAddTaskletクラスの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_Logic_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Tasklet_Logic_Tasklet"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Logic_Tasklet"></a>PointAddTaskletクラスの実装</h7>
<div class="paragraph">
<p>Taskletインターフェースを実装したPointAddTaskletクラスを実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.dbaccess.tasklet.PointAddTasklet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.dbaccess.tasklet</span>;

<span class="keyword">import</span> <span class="include">org.springframework.batch.core.StepContribution</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.scope.context.ChunkContext</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.step.tasklet.Tasklet</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemStreamReader</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemWriter</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.repeat.RepeatStatus</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;
<span class="keyword">import</span> <span class="include">com.example.batch.tutorial.common.dto.MemberInfoDto</span>;

<span class="keyword">import</span> <span class="include">javax.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Component</span> <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PointAddTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> TARGET_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> INITIAL_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> GOLD_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">G</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (4)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NORMAL_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">N</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (5)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> MAX_POINT = <span class="integer">1000000</span>; <span class="comment">// (6)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> CHUNK_SIZE = <span class="integer">10</span>; <span class="comment">// (7)</span>

    <span class="annotation">@Inject</span> <span class="comment">// (8)</span>
    ItemStreamReader&lt;MemberInfoDto&gt; reader; <span class="comment">// (9)</span>

    <span class="annotation">@Inject</span> <span class="comment">// (8)</span>
    ItemWriter&lt;MemberInfoDto&gt; writer; <span class="comment">// (10)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> { <span class="comment">// (11)</span>
        MemberInfoDto item = <span class="predefined-constant">null</span>;

        <span class="predefined-type">List</span>&lt;MemberInfoDto&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(CHUNK_SIZE); <span class="comment">// (12)</span>

        <span class="keyword">try</span> {
            reader.open(chunkContext.getStepContext().getStepExecution().getExecutionContext()); <span class="comment">// (13)</span>

            <span class="keyword">while</span> ((item = reader.read()) != <span class="predefined-constant">null</span>) { <span class="comment">// (14)</span>

                <span class="keyword">if</span> (TARGET_STATUS.equals(item.getStatus())) {
                    <span class="keyword">if</span> (GOLD_MEMBER.equals(item.getType())) {
                        item.setPoint(item.getPoint() + <span class="integer">100</span>);
                    } <span class="keyword">else</span> <span class="keyword">if</span> (NORMAL_MEMBER.equals(item.getType())) {
                        item.setPoint(item.getPoint() + <span class="integer">10</span>);
                    }

                    <span class="keyword">if</span> (item.getPoint() &gt; MAX_POINT) {
                        item.setPoint(MAX_POINT);
                    }

                    item.setStatus(INITIAL_STATUS);
                }

                items.add(item);

                <span class="keyword">if</span> (items.size() == CHUNK_SIZE) { <span class="comment">// (15)</span>
                    writer.write(items); <span class="comment">// (16)</span>
                    items.clear();
                }
            }

            writer.write(items); <span class="comment">// (17)</span>
        } <span class="keyword">finally</span> {
            reader.close(); <span class="comment">// (18)</span>
        }

        <span class="keyword">return</span> RepeatStatus.FINISHED; <span class="comment">// (19)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャンの対象とするため、<code>@Component</code>アノテーションを付与してBean定義を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイント加算対象とする商品購入フラグ:1を定義する。<br>
本来、このようなフィールド定数は定数クラスなどに定義し、ロジックに定義することはあまりない。
このチュートリアルでは、便宜上、定数として定義していることを留意すること。(以降の定数も同様)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、商品購入フラグの初期値:0を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員種別:G(ゴールド会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員種別:N(一般会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイントの上限値:1000000を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、まとめて処理する単位(一定件数):10を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Inject</code>アノテーションを付与して、<code>ItemStreamReader/ItemWriter</code>の実装をインジェクションする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データベースアクセスするために<code>ItemReader</code>のサブインターフェースである、<code>ItemStreamReader</code>として型を定義する。<br>
<code>ItemStreamReader</code>はリソースのオープン/クローズを実行する必要がある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemWriter</code>を定義する。<br>
<code>ItemStreamReader</code>とは異なり、リソースのオープン/クローズを実行する必要はない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグおよび、会員種別に応じてポイント加算するビジネスロジックを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">一定件数分の<code>item</code>を格納するためのリストを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(13)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力リソースをオープンする。<br>
このタイミングでSQLが発行される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(14)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力リソース全件を逐次ループ処理する。<br>
<code>ItemReader#read</code>は、入力データがすべて読み取り末端に到達した場合、<code>null</code>を返却する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(15)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リストに追加した<code>item</code>の数が一定件数に達したかどうかを判定する。<br>
一定件数に達した場合は、(16)でデータベースへ出力し、リストを<code>clear</code>する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(16)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データベースへ出力する。<br>
このタイミングでコミットするわけではないため留意すること。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(17)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">全体の処理件数/一定件数の余り分をデータベースへ出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(18)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リソースをクローズする。<br>
なお、ここでは実装を簡易にするため例外処理を実装していない。例外処理は必要に応じて実装すること。<br>
ここで例外が発生した場合、タスクレット全体のトランザクションがロールバックされ、例外のスタックトレースを出力し、ジョブが異常終了する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(19)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Taskletの処理が完了したかどうかを返却する。<br>
常に<code>return RepeatStatus.FINISHED;</code>と明示する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Tasklet_Logic_Bean"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Logic_Bean"></a>ジョブBean定義ファイルの設定</h7>
<div class="paragraph">
<p>作成したビジネスロジックをジョブとして設定するため、ジョブBean定義ファイルに以下の(1)以降を追記する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddTasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.tasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;mybatis:scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.findAll</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.updatePointAndStatus</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddTasklet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddTasklet.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                           <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pointAddTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要がある。<br>
ここでは、タスクレットモデルのジョブ名として<code>jobPointAddTasklet</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要はないが、障害発生時に追跡しやすくなる等の様々なメリットがあるため一意とする。<br>
 特別な理由がない限り、(1)で指定したid属性に[step+連番]を付加する形式とする。<br>
ここでは、タスクレットモデルのジョブのステップ名として<code>jobPointAddTasklet.step01</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">タスクレットの設定を行う。<br>
<code>ref</code>属性に、Taskletの実装クラスのBeanIDである<code>pointAddTasklet</code>を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_DBAccessJob_Tasklet_Execution"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Execution"></a>9.4.1.3.5. ジョブの実行と結果の確認</h6>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Tasklet_Execution_Run"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Execution_Run"></a>実行構成からジョブを実行</h7>
<div class="paragraph">
<p>以下のとおり実行構成を作成し、ジョブを実行する。<br>
実行構成の作成手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck">プロジェクトの動作確認</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">実行構成の設定値</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Name: 任意の名称(例: Run DBAccessJob for TaskletModel)</p>
</li>
<li>
<p>Mainタブ</p>
<div class="ulist">
<ul>
<li>
<p>Project: <code>macchinetta-batch-tutorial</code></p>
</li>
<li>
<p>Main class: <code>org.springframework.batch.core.launch.support.CommandLineJobRunner</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Argumentsタブ</p>
<div class="ulist">
<ul>
<li>
<p>Program arguments: <code>META-INF/jobs/dbaccess/jobPointAddTasklet.xml jobPointAddTasklet</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Tasklet_Execution_Console"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Execution_Console"></a>コンソールログの確認</h7>
<div class="paragraph">
<p>Consoleに以下の内容のログが出力されていることを確認する。</p>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/09/12 10:09:56] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddTasklet]] completed with the following parameters: [{jsr_batch_run_id=472}] and the following status: [COMPLETED]
[2017/09/12 10:09:56] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@735f7ae5: startup date [Tue Sep 12 10:09:54 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Tasklet_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Execution_Exitcode"></a>終了コードの確認</h7>
<div class="paragraph">
<p>終了コードにより、正常終了したことを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が0(正常終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/DBAccess/Ch09_DBAccessJob_Confirm_ExitCode_TaskletModel.png" alt="Confiｒm the Exit Code of DBAccessJob for TaskletModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_DBAccessJob_Tasklet_Execution_Table"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Execution_Table"></a>会員情報テーブルの確認</h7>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容を比較し、確認内容のとおりとなっていることを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_RefDB">Data Source Explorerを使用してデータベースを参照する</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>statusカラム</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointカラム</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeカラムが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeカラムが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
<li>
<p>1,000,000(上限値)を超えたレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容は以下のとおり。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/DBAccess/Ch09_DBAccessJob_Result_MemberInfoTable.png" alt="Table of member_info">
</div>
<div class="title">更新前後の会員情報テーブルの内容</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_FileAccessJob"><a class="anchor" href="#Ch09_Impl_FileAccessJob"></a>9.4.2. ファイルアクセスでデータ入出力を行うジョブ</h4>
<div class="sect4">
<h5 id="Ch09_Impl_FileAccessJob_Overview"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Overview"></a>9.4.2.1. 概要</h5>
<div class="paragraph">
<p>ファイルアクセスでデータ入出力を行うジョブを作成する。</p>
</div>
<div class="paragraph">
<p>なお、本節はMacchinetta Batch 2.x 開発ガイドラインを元に説明しているため、
詳細については<a href="#Ch05_FileAccess">ファイルアクセス</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p><a href="#Ch09_TutorialApplication">作成するアプリケーションの説明</a>の
背景、処理概要、業務仕様を以下に再掲する。</p>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Overview_Background"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Overview_Background"></a>9.4.2.1.1. 背景</h6>
<div class="paragraph">
<p>とある量販店では、会員に対してポイントカードを発行している。<br>
会員には「ゴールド会員」「一般会員」の会員種別が存在し、会員種別に応じたサービスを提供している。<br>
今回そのサービスの一環として、月内に商品を購入した会員のうち、
会員種別が「ゴールド会員」の場合は100ポイント、「一般会員」の場合は10ポイントを月末に加算することにした。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Overview_ProcessOverview"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Overview_ProcessOverview"></a>9.4.2.1.2. 処理概要</h6>
<div class="paragraph">
<p>会員種別に応じてポイント加算を行うアプリケーションを
月次バッチ処理としてMacchinetta Batch 2.xを使用して実装する。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Overview_BusinessSpecification"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Overview_BusinessSpecification"></a>9.4.2.1.3. 業務仕様</h6>
<div class="paragraph">
<p>業務仕様は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>商品購入フラグが"1"(処理対象)の場合に、会員種別に応じてポイントを加算する</p>
<div class="ulist">
<ul>
<li>
<p>会員種別が"G"(ゴールド会員)の場合は100ポイント、"N"(一般会員)の場合は10ポイント加算する</p>
</li>
</ul>
</div>
</li>
<li>
<p>商品購入フラグはポイント加算後に"0"(初期状態)に更新する</p>
</li>
<li>
<p>ポイントの上限値は1,000,000ポイントとする</p>
</li>
<li>
<p>ポイント加算後に1,000,000ポイントを超えた場合は、1,000,000ポイントに補正する</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Overview_FileSpecification"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Overview_FileSpecification"></a>9.4.2.1.4. ファイル仕様</h6>
<div class="paragraph">
<p>入出力リソースとなる会員情報ファイルの仕様は以下のとおり。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">会員情報ファイル(可変長CSV形式)</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 15%;">
<col style="width: 10%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">フィールド名</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">桁数</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員を一意に示す8桁固定の番号を表す。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の種別を以下のとおり表す。<br>
"G"(ゴールド会員)、"N"(一般会員)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">月内に商品を買ったかどうかを表す。<br>
商品購入で"1"(処理対象)、月次バッチ処理で"0"(初期状態)に更新される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイント</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">数値</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の保有するポイントを表す。<br>
初期値は0。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>このチュートリアルではヘッダレコード、フッタレコードは扱わないこととしているため、
ヘッダレコード、フッタレコードの扱いやファイルフォーマットについては、
<a href="#Ch05_FileAccess">ファイルアクセス</a>を参照してほしい。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Overview_JobOverview"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Overview_JobOverview"></a>9.4.2.1.5. ジョブの概要</h6>
<div class="paragraph">
<p>ここで作成するファイルアクセスでデータ入出力を行うジョブの概要を把握するために、
処理フローおよび処理シーケンスを以下に示す。</p>
</div>
<div class="paragraph">
<p>処理シーケンスではトランザクション制御の範囲について触れているが、ファイルの場合は擬似的なトランザクション制御を行うことで実現している。
詳細は、<a href="#Ch05_Transaction_HowToUse_SingleDataSource_NonTx">非トランザクショナルなデータソースに対する補足</a>を参照のこと。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">処理フロー概要</dt>
<dd>
<p>処理フローの概要を以下に示す。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/FileAccess/Ch09_FileAccessJob_ProcessFlow.png" alt="ProcessFlow of FileAccess Job">
</div>
<div class="title">ファイルアクセスジョブの処理フロー</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンクモデルの場合の処理シーケンス</dt>
<dd>
<p>チャンクモデルの場合の処理シーケンスを説明する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_FileAccessJob_ProcessSequence_ChunkModel.png" alt="ProcessSequence of FileAccess Job by ChunkModel">
</div>
<div class="title">チャンクモデルのシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
</li>
<li>
<p>ステップは、入力リソースをオープンする。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、member_info(input)ファイルをオープンする。</p>
</li>
<li>
<p>ステップは、出力リソースをオープンする。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、member_info(output)ファイルをオープンする。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで6から16の処理を繰り返す。</p>
</li>
<li>
<p>チャンク単位で、フレームワークトランザクション(擬似的)を開始する。</p>
</li>
<li>
<p>チャンクサイズに達するまで6から12までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは、<code>FlatFileItemReader</code>から入力データを1レコード取得する。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、member_info(input)ファイルから入力データを1レコード取得する。</p>
</li>
<li>
<p>member_info(input)ファイルは、<code>FlatFileItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、ステップに入力データを返却する。</p>
</li>
<li>
<p>ステップは、<code>PointAddItemProcessor</code>で入力データに対して処理を行う。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、入力データを読み込んでポイント加算処理を行う。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、ステップに処理結果を返却する。</p>
</li>
<li>
<p>ステップは、チャンクサイズ分のデータを<code>FlatFileItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、処理結果をバッファリングする。</p>
</li>
<li>
<p>ステップは、フレームワークトランザクション(擬似的)をコミットする。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、フラッシュしてバッファ内のデータをmember_info(output)ファイルに書き込む。</p>
</li>
<li>
<p>ステップは、入力リソースをクローズする。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、member_info(input)ファイルをクローズする。</p>
</li>
<li>
<p>ステップは、出力リソースをクローズする。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、member_info(output)ファイルをクローズする。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは正常終了:0)を返却する。</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">タスクレットモデルの場合の処理シーケンス</dt>
<dd>
<p>タスクレットモデルの場合の処理シーケンスについて説明する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_FileAccessJob_ProcessSequence_TaskletModel.png" alt="ProcessSequence of FileAccess Job by TaskletModel">
</div>
<div class="title">タスクレットモデルのシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
<div class="ulist">
<ul>
<li>
<p>ステップはフレームワークトランザクション(擬似的)を開始する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは<code>PointAddTasklet</code>を実行する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、入力リソースをオープンする。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、member_info(input)ファイルをオープンする。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、出力リソースをオープンする。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、member_info(output)ファイルをオープンする。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで7から13までの処理を繰り返す。</p>
</li>
<li>
<p>一定件数に達するまで7から11までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>PointAddTasklet</code>は、<code>FlatFileItemReader</code>から入力データを1レコード取得する。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、member_info(input)ファイルから入力データを1レコード取得する。</p>
</li>
<li>
<p>member_info(input)ファイルは、<code>FlatFileItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、タスクレットに入力データを返却する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、入力データを読み込んでポイント加算処理を行う。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、一定件数分のデータを<code>FlatFileItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、処理結果をバッファリングする。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、入力リソースをクローズする。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、member_info(input)ファイルをクローズする。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、出力リソースをクローズする。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、ステップへ処理終了を返却する。</p>
</li>
<li>
<p>ステップは、フレームワークトランザクション(擬似的)をコミットする。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、フラッシュしてバッファ内のデータをmember_info(output)ファイルに書き込む。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、member_info(output)ファイルをクローズする。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは正常終了:0)を返却する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>以降で、チャンクモデル、タスクレットモデルそれぞれの実装方法を説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk">チャンクモデルでの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet">タスクレットモデルでの実装</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_FileAccessJob_Chunk"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk"></a>9.4.2.2. チャンクモデルでの実装</h5>
<div class="paragraph">
<p>チャンクモデルでのファイルアクセスでデータ入出力を行うジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_JobDefinition">ジョブBean定義ファイルの作成</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_Dto">DTOの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_FileAccess">ファイルアクセスの定義</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_Logic">ロジックの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Chunk_JobDefinition"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_JobDefinition"></a>9.4.2.2.1. ジョブBean定義ファイルの作成</h6>
<div class="paragraph">
<p>Bean定義ファイルにて、チャンクモデルでのファイルアクセスでデータ入出力を行うジョブを構成する要素の組み合わせ方を設定する。<br>
ここでは、Bean定義ファイルの枠および共通的な設定のみ記述し、以降の項で各構成要素の設定を行う。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/fileaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.fileaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Macchinetta Batch 2.xを利用する際に、常に必要なBean定義を読み込む設定をインポートする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャン対象とするベースパッケージの設定を行う。<br>
<code>base-package</code>属性に、使用するコンポーネント(ItemProcessorの実装クラスなど)が格納されているパッケージを指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Chunk_Dto"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Dto"></a>9.4.2.2.2. DTOの実装</h6>
<div class="paragraph">
<p>業務データを保持するためのクラスとしてDTOクラスを実装する。<br>
DTOクラスはファイルごとに作成する。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="paragraph">
<p>以下のとおり、変換対象クラスとしてDTOクラスを実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.dto.MemberInfoDTO</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.dto</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MemberInfoDto</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> id; <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> type; <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> status; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="type">int</span> point; <span class="comment">// (4)</span>

    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> id;
    }

    <span class="directive">public</span> <span class="type">void</span> setId(<span class="predefined-type">String</span> id) {
        <span class="local-variable">this</span>.id = id;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getType() {
        <span class="keyword">return</span> type;
    }

    <span class="directive">public</span> <span class="type">void</span> setType(<span class="predefined-type">String</span> type) {
        <span class="local-variable">this</span>.type = type;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getStatus() {
        <span class="keyword">return</span> status;
    }

    <span class="directive">public</span> <span class="type">void</span> setStatus(<span class="predefined-type">String</span> status) {
        <span class="local-variable">this</span>.status = status;
    }

    <span class="directive">public</span> <span class="type">int</span> getPoint() {
        <span class="keyword">return</span> point;
    }

    <span class="directive">public</span> <span class="type">void</span> setPoint(<span class="type">int</span> point) {
        <span class="local-variable">this</span>.point = point;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号に対応するフィールドとして<code>id</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別に対応するフィールドとして<code>type</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグに対応するフィールドとして<code>status</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイントに対応するフィールドとして<code>point</code>を定義する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Chunk_FileAccess"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_FileAccess"></a>9.4.2.2.3. ファイルアクセスの定義</h6>
<div class="paragraph">
<p>ファイルアクセスでデータ入出力するためのジョブBean定義ファイルの設定を行う。</p>
</div>
<div class="paragraph">
<p>ItemReader、ItemWriterの設定として、ジョブBean定義ファイルに以下の(1)以降を追記する。<br>
ここで触れていない設定内容については、<a href="#Ch05_FileAccess_HowToUse_VariableLength_Input">可変長レコードの入力</a>
および<a href="#Ch05_FileAccess_HowToUse_VariableLength_Output">可変長レコードの出力</a>を参照のこと。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/fileaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.fileaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (1) (2) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:quoteCharacter</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (4) (5) --&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (6) --&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- (7) (8) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (9) --&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (10) --&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (11) --&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (12) --&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReaderの設定を行う。<br>
<code>class</code>属性に、Spring Batchが提供するフラットファイルを読み込むための<code>ItemReader</code>の実装クラスである
<code>org.springframework.batch.item.file.FlatFileItemReader</code>を指定する。<br>
<code>scope</code>属性に、<code>step</code>スコープを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource</code>属性に入力ファイルのパスを設定する。<br>
パスは直接指定することも可能であるが、ここでは、ジョブ起動時にパラメータで渡すようにするため、
入力ファイルパスのパラメータ名を指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineTokenizerの設定を行う。<br>
<code>class</code>属性に、Spring Batchが提供する区切り文字を指定してレコードを分割する<code>LineTokenizer</code>の実装クラスである
<code>org.springframework.batch.item.file.transform.DelimitedLineTokenizer</code>を指定する。<br>
CSV形式の一般的書式とされるRFC-4180の仕様に定義されている、エスケープされた改行、区切り文字、囲み文字の読み込みに対応している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>names</code>属性に、1レコードの各項目に付与する名前を設定する。<br>
<code>FieldSetMapper</code>で使われる<code>FieldSet</code>で設定した名前を用いて各項目を取り出すことができるようになる。<br>
レコードの先頭から各名前をカンマ区切りで指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delimiter</code>属性に、区切り文字としてカンマを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fieldSetMapper</code>の設定を行う。<br>
今回は文字列や数字など特別な変換処理が不要なため、
<code>class</code>属性に、<code>org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</code>を指定する。<br>
<code>targetType</code>属性には、変換対象クラスとして<a href="#Ch09_Impl_FileAccessJob_Chunk_Dto">DTOの実装</a>で作成したDTOクラスを指定する。
これにより、(4)で設定した各項目の名前と一致するフィールドに値を自動的に設定したインスタンスを生成する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriterの設定を行う。<br>
<code>class</code>属性に、Spring Batchが提供するフラットファイルへ書き込むための<code>ItemWriter</code>の実装クラスである
<code>org.springframework.batch.item.file.FlatFileItemWriter</code>を指定する。<br>
<code>scope</code>属性に、<code>step</code>スコープを指定する。<br>
このチュートリアルでは、<code>appendAllowed</code>属性は<code>false</code>(追記しない)、<code>shouldDeleteIfExists</code>属性は<code>true</code>(既存ファイルを削除する)を指定して
ジョブを何度実行しても新規にファイルが作成されるようにする。<br>
<code>transactional</code>属性に、<code>true</code>を指定して、擬似的トランザクション制御を有効にする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource</code>属性に出力ファイルのパスを設定する。<br>
ジョブ起動時にパラメータで渡すようにするため、出力ファイルパスのパラメータ名を指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lineAggregator</code>の設定を行う。<br>
<code>class</code>属性に、対象Beanを1レコードへマッピングするための<code>org.springframework.batch.item.file.transform.LineAggregator</code>を指定する。<br>
Beanのプロパティとレコード内の各項目とのマッピングは<code>FieldExtractor</code>で行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delimiter</code>属性に、区切り文字としてカンマを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fieldExtractor</code>の設定を行う。<br>
 (12)で指定する各項目の名前に(6)で指定したDTOクラスのフィールドと一致する値をマッピングする。 <br>
<code>class</code>属性に、<code>org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</code>を指定する。<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>names</code>属性に、1レコードの各項目に付与する名前を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Chunk_Logic"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Logic"></a>9.4.2.2.4. ロジックの実装</h6>
<div class="paragraph">
<p>ポイント加算処理を行うビジネスロジッククラスを実装する。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_Logic_ItemProcessor">PointAddItemProcessorクラスの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_Logic_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_FileAccessJob_Chunk_Logic_ItemProcessor"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Logic_ItemProcessor"></a>PointAddItemProcessorクラスの実装</h7>
<div class="paragraph">
<p>ItemProcessorインターフェースを実装したPointAddItemProcessorクラスを実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.fileaccess.chunk.PointAddItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.fileaccess.chunk</span>;

<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemProcessor</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;
<span class="keyword">import</span> <span class="include">com.example.batch.tutorial.common.dto.MemberInfoDto</span>;

<span class="annotation">@Component</span> <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PointAddItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;MemberInfoDto, MemberInfoDto&gt; { <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> TARGET_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> INITIAL_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (4)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> GOLD_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">G</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (5)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NORMAL_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">N</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (6)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> MAX_POINT = <span class="integer">1000000</span>; <span class="comment">// (7)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> MemberInfoDto process(MemberInfoDto item) <span class="directive">throws</span> <span class="exception">Exception</span> { <span class="comment">// (8) (9) (10)</span>
        <span class="keyword">if</span> (TARGET_STATUS.equals(item.getStatus())) {
            <span class="keyword">if</span> (GOLD_MEMBER.equals(item.getType())) {
                item.setPoint(item.getPoint() + <span class="integer">100</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (NORMAL_MEMBER.equals(item.getType())) {
                item.setPoint(item.getPoint() + <span class="integer">10</span>);
            }

            <span class="keyword">if</span> (item.getPoint() &gt; MAX_POINT) {
                item.setPoint(MAX_POINT);
            }

            item.setStatus(INITIAL_STATUS);
        }

        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャンの対象とするため、<code>@Component</code>アノテーションを付与してBean定義を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入出力で使用するオブジェクトの型をそれぞれ型引数に指定した<code>ItemProcessor</code>インターフェースを実装する。<br>
ここでは、入出力で使用するオブジェクトは共に<a href="#Ch09_Impl_FileAccessJob_Chunk_Dto">DTOの実装</a>で作成した<code>MemberInfoDTO</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイント加算対象とする商品購入フラグ:1を定義する。<br>
本来、このようなフィールド定数は定数クラスなどに定義し、ロジックに定義することはあまりない。
このチュートリアルでは、便宜上、定数として定義していることを留意すること。(以降の定数も同様)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、商品購入フラグの初期値:0を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員区分:G(ゴールド会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員区分:N(一般会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイントの上限値:1000000を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグおよび、会員種別に応じてポイント加算するビジネスロジックを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">返り値の型は、このクラスで実装している<code>ItemProcessor</code>インターフェースの型引数で指定した
出力オブジェクトの型である<code>MemberInfoDTO</code>とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数として受け取る<code>item</code>の型は、
このクラスで実装している<code>ItemProcessor</code>インターフェースの型引数で指定した入力オブジェクトの型である<code>MemberInfoDTO</code>とする。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_FileAccessJob_Chunk_Logic_Bean"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Logic_Bean"></a>ジョブBean定義ファイルの設定</h7>
<div class="paragraph">
<p>作成したビジネスロジックをジョブとして設定するため、ジョブBean定義ファイルに以下の(1)以降を追記する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/fileaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.fileaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:quoteCharacter</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddChunk</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddChunk.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pointAddItemProcessor</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;/batch:tasklet&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要がある。<br>
ここでは、チャンクモデルのジョブ名として<code>jobPointAddChunk</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要はないが、障害発生時に追跡しやすくなる等の様々なメリットがあるため一意とする。<br>
特別な理由がない限り、(1)で指定したid属性に[step+連番]を付加する形式とする。<br>
ここでは、チャンクモデルのジョブのステップ名として<code>jobPointAddChunk.step01</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンクモデルジョブの設定を行う。<br>
<code>reader</code>、<code>writer</code>それぞれの属性に、前項までに定義した<code>ItemReader</code>、<code>ItemWriter</code>のBeanIDを指定する。<br>
<code>processor</code>属性に、ItemProcessorの実装クラスのBeanIDである<code>pointAddItemProcessor</code>を指定する。<br>
<code>commit-interval</code>属性に、1チャンクあたりの入力データ件数を10件として設定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">commit-intervalのチューニング</div>
<div class="paragraph">
<p>commit-intervalはチャンクモデルジョブにおける、性能上のチューニングポイントである。</p>
</div>
<div class="paragraph">
<p>このチュートリアルでは10件としているが、利用できるマシンリソースやジョブの特性によって適切な件数は異なる。
複数のリソースにアクセスしてデータを加工するジョブであれば10件から100件程度で処理スループットが頭打ちになることもある。
一方、入出力リソースが1:1対応しておりデータを移し替える程度のジョブであれば5,000件や10,000件でも処理スループットが伸びることがある。</p>
</div>
<div class="paragraph">
<p>ジョブ実装時のcommit-intervalは100件程度で仮置きしておき、 その後に実施した性能測定の結果に応じてジョブごとにチューニングするとよい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Chunk_Execution"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Execution"></a>9.4.2.2.5. ジョブの実行と結果の確認</h6>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_FileAccessJob_Chunk_Execution_Run"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Run"></a>実行構成からジョブを実行</h7>
<div class="paragraph">
<p>以下のとおり実行構成を作成し、ジョブを実行する。<br>
実行構成の作成手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck">動作確認</a>を参照。</p>
</div>
<div class="paragraph">
<p>ここでは、正常系データを利用してジョブを実行する。<br>
Argumentsタブに入出力ファイルのパラメータを引数として追加する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">実行構成の設定値</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Name: 任意の名称(例: Run FileAccessJob for ChunkModel)</p>
</li>
<li>
<p>Mainタブ</p>
<div class="ulist">
<ul>
<li>
<p>Project: <code>macchinetta-batch-tutorial</code></p>
</li>
<li>
<p>Main class: <code>org.springframework.batch.core.launch.support.CommandLineJobRunner</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Argumentsタブ</p>
<div class="ulist">
<ul>
<li>
<p>Program arguments: <code>META-INF/jobs/fileaccess/jobPointAddChunk.xml jobPointAddChunk inputFile=files/input/input-member-info-data.csv outputFile=files/output/output-member-info-data.csv</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_FileAccessJob_Chunk_Execution_Console"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Console"></a>コンソールログの確認</h7>
<div class="paragraph">
<p>Consoleに以下の内容のログが出力されていることを確認する。</p>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/08/18 11:09:19] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddChunk]] completed with the following parameters: [{inputFile=files/input/input-member-info-data.csv, outputFile=files/output/output-member-info-data.csv, jsr_batch_run_id=386}] and the following status: [COMPLETED]
[2017/08/18 11:09:19] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@735f7ae5: startup date [Fri Aug 18 11:09:12 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_FileAccessJob_Chunk_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Exitcode"></a>終了コードの確認</h7>
<div class="paragraph">
<p>終了コードにより、正常終了したことを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が0(正常終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/FileAccess/Ch09_FileAccessJob_Confirm_ExitCode_ChunkModel.png" alt="Confirm the Exit Code of FileAccess for ChunkModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_FileAccessJob_Chunk_Execution_OutputFile"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Execution_OutputFile"></a>会員情報ファイルの確認</h7>
<div class="paragraph">
<p>会員情報ファイルの入出力内容を比較し、確認内容のとおりとなっていることを確認する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>出力ディレクトリに会員情報ファイルが出力されていること</p>
<div class="ulist">
<ul>
<li>
<p>出力ファイル: files/output/output-member-info-data.csv</p>
</li>
</ul>
</div>
</li>
<li>
<p>statusフィールド</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointフィールド</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeフィールドが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeフィールドが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
<li>
<p>1,000,000(上限値)を超えたレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>会員情報ファイルの入出力内容は以下のとおり。<br>
ファイルのフィールドはid(会員番号)、type(会員種別)、status(商品購入フラグ)、point(ポイント)の順で出力される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/FileAccess/Ch09_FileAccessJob_Result_MemberInfoFile.png" alt="File of member_info">
</div>
<div class="title">会員情報ファイルの入出力内容</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_FileAccessJob_Tasklet"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet"></a>9.4.2.3. タスクレットモデルでの実装</h5>
<div class="paragraph">
<p>タスクレットモデルでのファイルアクセスでデータ入出力を行うジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_JobDefinition">ジョブBean定義ファイルの作成</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_Dto">DTOの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_FileAccess">ファイルアクセスの定義</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_Logic">ロジックの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Tasklet_JobDefinition"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_JobDefinition"></a>9.4.2.3.1. ジョブBean定義ファイルの作成</h6>
<div class="paragraph">
<p>Bean定義ファイルにて、タスクレットモデルでのファイルアクセスでデータ入出力を行うジョブを構成する要素の組み合わせ方を設定する。<br>
ここでは、Bean定義ファイルの枠および共通的な設定のみ記述し、以降の項で各構成要素の設定を行う。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/fileaccess/jobPointAddTasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.fileaccess.tasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Macchinetta Batch 2.xを利用する際に、常に必要なBean定義を読み込む設定をインポートする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>base-package</code>属性に、使用するコンポーネント(Taskletの実装クラスなど)が格納されているパッケージを指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Tasklet_Dto"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Dto"></a>9.4.2.3.2. DTOの実装</h6>
<div class="paragraph">
<p>業務データを保持するためのクラスとしてDTOクラスを実装する。<br>
DTOクラスはファイルごとに作成する。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="paragraph">
<p>以下のとおり、変換対象クラスとしてDTOクラスを実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.dto.MemberInfoDTO</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.dto</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MemberInfoDto</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> id; <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> type; <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> status; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="type">int</span> point; <span class="comment">// (4)</span>

    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> id;
    }

    <span class="directive">public</span> <span class="type">void</span> setId(<span class="predefined-type">String</span> id) {
        <span class="local-variable">this</span>.id = id;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getType() {
        <span class="keyword">return</span> type;
    }

    <span class="directive">public</span> <span class="type">void</span> setType(<span class="predefined-type">String</span> type) {
        <span class="local-variable">this</span>.type = type;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getStatus() {
        <span class="keyword">return</span> status;
    }

    <span class="directive">public</span> <span class="type">void</span> setStatus(<span class="predefined-type">String</span> status) {
        <span class="local-variable">this</span>.status = status;
    }

    <span class="directive">public</span> <span class="type">int</span> getPoint() {
        <span class="keyword">return</span> point;
    }

    <span class="directive">public</span> <span class="type">void</span> setPoint(<span class="type">int</span> point) {
        <span class="local-variable">this</span>.point = point;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号に対応するフィールドとして<code>id</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別に対応するフィールドとして<code>type</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグに対応するフィールドとして<code>status</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイントに対応するフィールドとして<code>point</code>を定義する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Tasklet_FileAccess"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_FileAccess"></a>9.4.2.3.3. ファイルアクセスの定義</h6>
<div class="paragraph">
<p>ファイルアクセスでデータ入出力するためのジョブBean定義ファイルの設定を行う。</p>
</div>
<div class="paragraph">
<p>ItemReader、ItemWriterの設定として、ジョブBean定義ファイルに以下の(1)以降を追記する。<br>
ここで触れていない設定内容については、<a href="#Ch05_FileAccess_HowToUse_VariableLength_Input">可変長レコードの入力</a>
および<a href="#Ch05_FileAccess_HowToUse_VariableLength_Output">可変長レコードの出力</a>を参照のこと。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/fileaccess/jobPointAddTasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.fileaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (1) (2) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:quoteCharacter</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (4) (5) --&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (6) --&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- (7) (8) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (9) --&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (10) --&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (11) --&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (12) --&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReaderの設定を行う。<br>
<code>class</code>属性に、Spring Batchが提供するフラットファイルを読み込むための<code>ItemReader</code>の実装クラスである
<code>org.springframework.batch.item.file.FlatFileItemReader</code>を指定する。<br>
<code>scope</code>属性に、<code>step</code>スコープを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource</code>属性に入力ファイルのパスを設定する。<br>
パスは直接指定することも可能であるが、ここでは、ジョブ起動時にパラメータで渡すようにするため、
入力ファイルパスのパラメータ名を指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineTokenizerの設定を行う。<br>
<code>class</code>属性に、Spring Batchが提供する区切り文字を指定してレコードを分割する<code>LineTokenizer</code>の実装クラスである
<code>org.springframework.batch.item.file.transform.DelimitedLineTokenizer</code>を指定する。<br>
CSV形式の一般的書式とされるRFC-4180の仕様に定義されている、エスケープされた改行、区切り文字、囲み文字の読み込みに対応している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>names</code>属性に、1レコードの各項目に付与する名前を設定する。<br>
<code>FieldSetMapper</code>で使われる<code>FieldSet</code>で設定した名前を用いて各項目を取り出すことができるようになる。<br>
レコードの先頭から各名前をカンマ区切りで指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delimiter</code>属性に、区切り文字としてカンマを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fieldSetMapper</code>の設定を行う。<br>
今回は文字列や数字など特別な変換処理が不要なため、
<code>class</code>属性に、<code>org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</code>を指定する。<br>
<code>targetType</code>属性には、変換対象クラスとして<a href="#Ch09_Impl_FileAccessJob_Tasklet_Dto">DTOの実装</a>で作成したDTOクラスを指定する。
これにより、(4)で設定した各項目の名前と一致するフィールドに値を自動的に設定したインスタンスを生成する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriterの設定を行う。<br>
<code>class</code>属性に、Spring Batchが提供するフラットファイルへ書き込むための<code>ItemWriter</code>の実装クラスである
<code>org.springframework.batch.item.file.FlatFileItemWriter</code>を指定する。<br>
<code>scope</code>属性に、<code>step</code>スコープを指定する。<br>
このチュートリアルでは、<code>appendAllowed</code>属性は<code>false</code>(追記しない)、<code>shouldDeleteIfExists</code>属性は<code>true</code>(既存ファイルを削除する)を指定して
ジョブを何度実行しても新規にファイルが作成されるようにする。<br>
<code>transactional</code>属性に、<code>true</code>を指定して、擬似的トランザクション制御を有効にする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource</code>属性に出力ファイルのパスを設定する。<br>
ジョブ起動時にパラメータで渡すようにするため、出力ファイルパスのパラメータ名を指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lineAggregator</code>の設定を行う。<br>
<code>class</code>属性に、対象Beanを1レコードへマッピングするための<code>org.springframework.batch.item.file.transform.LineAggregator</code>を指定する。<br>
Beanのプロパティとレコード内の各項目とのマッピングは<code>FieldExtractor</code>で行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delimiter</code>属性に、区切り文字としてカンマを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fieldExtractor</code>の設定を行う。<br>
 (12)で指定する各項目の名前に(6)で指定したDTOクラスのフィールドと一致する値をマッピングする。 <br>
<code>class</code>属性に、<code>org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</code>を指定する。<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>names</code>属性に、1レコードの各項目に付与する名前を設定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">チャンクモデルのコンポーネントを利用するTasklet実装</div>
<div class="paragraph">
<p>このチュートリアルでは、タスクレットモデルでファイルアクセスするジョブの作成を容易に実現するために、
チャンクモデルのコンポーネントであるItemReader・ItemWriterを利用している。</p>
</div>
<div class="paragraph">
<p>Tasklet実装の中でチャンクモデルの各種コンポーネントを利用するかどうかは、
<a href="#Ch03_CreateTaskletJob_HowToUse_InOutImpl">チャンクモデルのコンポーネントを利用するTasklet実装</a>を参照して適宜判断してほしい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Tasklet_Logic"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Logic"></a>9.4.2.3.4. ロジックの実装</h6>
<div class="paragraph">
<p>ポイント加算処理を行うビジネスロジッククラスを実装する。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_Logic_Tasklet">PointAddTaskletクラスの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_Logic_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_FileAccessJob_Tasklet_Logic_Tasklet"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Logic_Tasklet"></a>PointAddTaskletクラスの実装</h7>
<div class="paragraph">
<p>Taskletインターフェースを実装したPointAddTaskletクラスを作成する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.fileaccess.tasklet.PointAddTasklet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.fileaccess.tasklet</span>;

<span class="keyword">import</span> <span class="include">org.springframework.batch.core.StepContribution</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.scope.context.ChunkContext</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.step.tasklet.Tasklet</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemStreamException</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemStreamReader</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemStreamWriter</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.repeat.RepeatStatus</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Scope</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;
<span class="keyword">import</span> <span class="include">com.example.batch.tutorial.common.dto.MemberInfoDto</span>;

<span class="keyword">import</span> <span class="include">javax.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Component</span> <span class="comment">// (1)</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>) <span class="comment">// (2)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PointAddTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> TARGET_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> INITIAL_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (4)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> GOLD_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">G</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (5)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NORMAL_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">N</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (6)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> MAX_POINT = <span class="integer">1000000</span>; <span class="comment">// (7)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> CHUNK_SIZE = <span class="integer">10</span>; <span class="comment">// (8)</span>

    <span class="annotation">@Inject</span> <span class="comment">// (9)</span>
    ItemStreamReader&lt;MemberInfoDto&gt; reader; <span class="comment">// (10)</span>

    <span class="annotation">@Inject</span> <span class="comment">// (9)</span>
    ItemStreamWriter&lt;MemberInfoDto&gt; writer; <span class="comment">// (11)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> { <span class="comment">// (12)</span>
        MemberInfoDto item = <span class="predefined-constant">null</span>;

        <span class="predefined-type">List</span>&lt;MemberInfoDto&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(CHUNK_SIZE); <span class="comment">// (13)</span>
        <span class="keyword">try</span> {

            reader.open(chunkContext.getStepContext().getStepExecution().getExecutionContext()); <span class="comment">// (14)</span>
            writer.open(chunkContext.getStepContext().getStepExecution().getExecutionContext()); <span class="comment">// (14)</span>

            <span class="keyword">while</span> ((item = reader.read()) != <span class="predefined-constant">null</span>) { <span class="comment">// (15)</span>

                <span class="keyword">if</span> (TARGET_STATUS.equals(item.getStatus())) {
                    <span class="keyword">if</span> (GOLD_MEMBER.equals(item.getType())) {
                        item.setPoint(item.getPoint() + <span class="integer">100</span>);
                    } <span class="keyword">else</span> <span class="keyword">if</span> (NORMAL_MEMBER.equals(item.getType())) {
                        item.setPoint(item.getPoint() + <span class="integer">10</span>);
                    }

                    <span class="keyword">if</span> (item.getPoint() &gt; MAX_POINT) {
                        item.setPoint(MAX_POINT);
                    }

                    item.setStatus(INITIAL_STATUS);
                }

                items.add(item);

                <span class="keyword">if</span> (items.size() == CHUNK_SIZE) { <span class="comment">// (16)</span>
                    writer.write(items); <span class="comment">// (17)</span>
                    items.clear();
                }
            }

            writer.write(items); <span class="comment">// (18)</span>
        } <span class="keyword">finally</span> {
            <span class="keyword">try</span> {
                reader.close(); <span class="comment">// (19)</span>
            } <span class="keyword">catch</span> (ItemStreamException e) {
                <span class="comment">// do nothing.</span>
            }
            <span class="keyword">try</span> {
                writer.close(); <span class="comment">// (19)</span>
            } <span class="keyword">catch</span> (ItemStreamException e) {
                <span class="comment">// do nothing.</span>
            }
        }

        <span class="keyword">return</span> RepeatStatus.FINISHED; <span class="comment">// (20)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャンの対象とするため、<code>@Component</code>アノテーションを付与してBean定義を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">クラスに@Scopeアノテーションを付与して<code>step</code>スコープを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイント加算対象とする商品購入フラグ:1を定義する。<br>
本来、このようなフィールド定数は定数クラスなどに定義し、ロジックに定義することはあまりない。
このチュートリアルでは、便宜上、定数として定義していることを留意すること。(以降の定数も同様)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、商品購入フラグの初期値:0を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員種別:G(ゴールド会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員種別:N(一般会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイントの上限値:1000000を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、まとめて処理する単位(一定件数):10を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Inject</code>アノテーションを付与して、<code>ItemStreamReader/ItemStreamWriter</code>の実装をインジェクションする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイルアクセスするために<code>ItemReader</code>のサブインターフェースである、<code>ItemStreamReader</code>として型を定義する。<br>
<code>ItemStreamReader</code>はリソースのオープン/クローズを実行する必要がある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイルアクセスするために<code>ItemWriter</code>のサブインターフェースである、<code>ItemStreamWriter</code>として型を定義する。<br>
<code>ItemStreamWriter</code>はリソースのオープン/クローズを実行する必要がある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグおよび、会員種別に応じてポイント加算するビジネスロジックを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(13)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">一定件数分の<code>item</code>を格納するためのリストを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(14)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入出力リソースをオープンする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(15)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力リソース全件を逐次ループ処理する。<br>
<code>ItemReader#read</code>は、入力データがすべて読み取り末端に到達した場合、<code>null</code>を返却する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(16)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リストに追加した<code>item</code>の数が一定件数に達したかどうかを判定する。<br>
一定件数に達した場合は、(17)でファイルへ出力し、リストを<code>clear</code>する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(17)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理したデータをファイルへ出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(18)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">全体の処理件数/一定件数の余り分をファイルへ出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(19)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入出力リソースをクローズする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(20)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Taskletの処理が完了したかどうかを返却する。<br>
常に<code>return RepeatStatus.FINISHED;</code>と明示する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_FileAccessJob_Tasklet_Logic_Bean"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Logic_Bean"></a>ジョブBean定義ファイルの設定</h7>
<div class="paragraph">
<p>作成したビジネスロジックをジョブとして設定するため、ジョブBean定義ファイルに以下の(1)以降を追記する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/fileaccess/jobPointAddTasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.fileaccess.tasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:quoteCharacter</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddTasklet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddTasklet.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                           <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pointAddTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要がある。<br>
ここでは、タスクレットモデルのジョブ名として<code>jobPointAddTasklet</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要はないが、障害発生時に追跡しやすくなる等の様々なメリットがあるため一意とする。<br>
 特別な理由がない限り、(1)で指定したid属性に[step+連番]を付加する形式とする。<br>
ここでは、タスクレットモデルのジョブのステップ名として<code>jobPointAddTasklet.step01</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">タスクレットの設定を行う。<br>
<code>ref</code>属性に、Taskletの実装クラスのBeanIDである<code>pointAddTasklet</code>を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_FileAccessJob_Tasklet_Execution"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Execution"></a>9.4.2.3.5. ジョブの実行と結果の確認</h6>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_FileAccessJob_Tasklet_Execution_Run"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Execution_Run"></a>実行構成からジョブを実行</h7>
<div class="paragraph">
<p>以下のとおり実行構成を作成し、ジョブを実行する。<br>
実行構成の作成手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck">動作確認</a>を参照。</p>
</div>
<div class="paragraph">
<p>ここでは、正常系データを利用してジョブを実行する。<br>
Argumentsタブに入出力ファイルのパラメータを引数として追加する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">実行構成の設定値</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Name: 任意の名称(例: Run FileAccessJob for TaskletModel)</p>
</li>
<li>
<p>Mainタブ</p>
<div class="ulist">
<ul>
<li>
<p>Project: <code>macchinetta-batch-tutorial</code></p>
</li>
<li>
<p>Main class: <code>org.springframework.batch.core.launch.support.CommandLineJobRunner</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Argumentsタブ</p>
<div class="ulist">
<ul>
<li>
<p>Program arguments: <code>META-INF/jobs/fileaccess/jobPointAddTasklet.xml jobPointAddTasklet inputFile=files/input/input-member-info-data.csv outputFile=files/output/output-member-info-data.csv</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_FileAccessJob_Tasklet_Execution_Console"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Execution_Console"></a>コンソールログの確認</h7>
<div class="paragraph">
<p>Consoleに以下の内容のログが出力されていることを確認する。</p>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/09/12 10:13:18] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddTasklet]] completed with the following parameters: [{inputFile=files/input/input-member-info-data.csv, outputFile=files/output/output-member-info-data.csv, jsr_batch_run_id=474}] and the following status: [COMPLETED]
[2017/09/12 10:13:18] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@735f7ae5: startup date [Tue Sep 12 10:13:16 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_FileAccessJob_Tasklet_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Execution_Exitcode"></a>終了コードの確認</h7>
<div class="paragraph">
<p>終了コードにより、正常終了したことを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が0(正常終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/FileAccess/Ch09_FileAccessJob_Confirm_ExitCode_TaskletModel.png" alt="Confirm the Exit Code of FileAccessJob for TaskletModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_FileAccessJob_Tasklet_Execution_OutputFile"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Execution_OutputFile"></a>会員情報ファイルの確認</h7>
<div class="paragraph">
<p>会員情報ファイルの入出力内容を比較し、確認内容のとおりとなっていることを確認する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>出力ディレクトリに会員情報ファイルが出力されていること</p>
<div class="ulist">
<ul>
<li>
<p>出力ファイル: files/output/output-member-info-data.csv</p>
</li>
</ul>
</div>
</li>
<li>
<p>statusフィールド</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointフィールド</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeフィールドが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeフィールドが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
<li>
<p>1,000,000(上限値)を超えたレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>会員情報ファイルの入出力内容は以下のとおり。<br>
ファイルのフィールドはid(会員番号)、type(会員種別)、status(商品購入フラグ)、point(ポイント)の順で出力される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/FileAccess/Ch09_FileAccessJob_Result_MemberInfoFile.png" alt="File of member_info">
</div>
<div class="title">会員情報ファイルの入出力内容</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_ValidationJob"><a class="anchor" href="#Ch09_Impl_ValidationJob"></a>9.4.3. 入力データの妥当性検証を行うジョブ</h4>
<div id="Ch09_Impl_ValidationJob_Prerequisite" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">前提</div>
<div class="paragraph">
<p><a href="#Ch09_Introduction_HowToProceed">チュートリアルの進め方</a>で説明しているとおり、
<a href="#Ch09_Impl_DBAccessJob">データベースアクセスでデータ入出力を行うジョブ</a>、<a href="#Ch09_Impl_FileAccessJob">ファイルアクセスでデータ入出力を行うジョブ</a>に対して、
本ジョブの実装を追加していく形式とする。<br>
ただし、記述はデータベースアクセスするジョブに実装を追加した場合の説明としているため留意すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_ValidationJob_Overview"><a class="anchor" href="#Ch09_Impl_ValidationJob_Overview"></a>9.4.3.1. 概要</h5>
<div class="paragraph">
<p>入力データの妥当性検証(以降、入力チェックと呼ぶ)を行うジョブを作成する。</p>
</div>
<div class="paragraph">
<p>なお、本節はMacchinetta Batch 2.x 開発ガイドラインを元に説明しているため、詳細については
<a href="#Ch06_InputValidation">入力チェック</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p><a href="#Ch09_TutorialApplication">作成するアプリケーションの説明</a>の
背景、処理概要、業務仕様を以下に再掲する。</p>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ValidationJob_Overview_Background"><a class="anchor" href="#Ch09_Impl_ValidationJob_Overview_Background"></a>9.4.3.1.1. 背景</h6>
<div class="paragraph">
<p>とある量販店では、会員に対してポイントカードを発行している。<br>
会員には「ゴールド会員」「一般会員」の会員種別が存在し、会員種別に応じたサービスを提供している。<br>
今回そのサービスの一環として、月内に商品を購入した会員のうち、
会員種別が「ゴールド会員」の場合は100ポイント、「一般会員」の場合は10ポイントを月末に加算することにした。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ValidationJob_Overview_ProcessOverview"><a class="anchor" href="#Ch09_Impl_ValidationJob_Overview_ProcessOverview"></a>9.4.3.1.2. 処理概要</h6>
<div class="paragraph">
<p>会員種別に応じてポイント加算を行うアプリケーションを
月次バッチ処理としてMacchinetta Batch 2.xを使用して実装する。<br>
入力データにポイントの上限値を超えるデータが存在するか妥当性検証を行う処理を追加実装する。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ValidationJob_Overview_BusinessSpecification"><a class="anchor" href="#Ch09_Impl_ValidationJob_Overview_BusinessSpecification"></a>9.4.3.1.3. 業務仕様</h6>
<div class="paragraph">
<p>業務仕様は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>入力データのポイントが1,000,000ポイントを超過していないことをチェックする</p>
<div class="ulist">
<ul>
<li>
<p>チェックエラーとなる場合は、処理を異常終了する(例外ハンドリングは行わない)</p>
</li>
</ul>
</div>
</li>
<li>
<p>商品購入フラグが"1"(処理対象)の場合に、会員種別に応じてポイントを加算する</p>
<div class="ulist">
<ul>
<li>
<p>会員種別が"G"(ゴールド会員)の場合は100ポイント、"N"(一般会員)の場合は10ポイント加算する</p>
</li>
</ul>
</div>
</li>
<li>
<p>商品購入フラグはポイント加算後に"0"(初期状態)に更新する</p>
</li>
<li>
<p>ポイントの上限値は1,000,000ポイントとする</p>
</li>
<li>
<p>ポイント加算後に1,000,000ポイントを超えた場合は、1,000,000ポイントに補正する</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ValidationJob_Overview_TableSpecification"><a class="anchor" href="#Ch09_Impl_ValidationJob_Overview_TableSpecification"></a>9.4.3.1.4. テーブル仕様</h6>
<div class="paragraph">
<p>入出力リソースとなる会員情報テーブルの仕様は以下のとおり。<br>
<a href="#Ch09_Impl_ValidationJob_Prerequisite">前提</a>のとおりデータベースアクセスするジョブの場合の説明となるため、ファイルアクセスするジョブの場合の
入出力のリソース仕様は<a href="#Ch09_Impl_FileAccessJob_Overview_FileSpecification">ファイル仕様</a>を参照する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">会員情報テーブル(member_info)</caption>
<colgroup>
<col style="width: 3.0927%;">
<col style="width: 15.4639%;">
<col style="width: 10.3092%;">
<col style="width: 4.1237%;">
<col style="width: 12.3711%;">
<col style="width: 8.2474%;">
<col style="width: 46.392%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">属性名</th>
<th class="tableblock halign-left valign-top">カラム名</th>
<th class="tableblock halign-left valign-top">PK</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">桁数</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員を一意に示す8桁固定の番号を表す。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の種別を以下のとおり表す。<br>
"G"(ゴールド会員)、"N"(一般会員)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">月内に商品を買ったかどうかを表す。<br>
商品購入で"1"(処理対象)、月次バッチ処理で"0"(初期状態)に更新される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイント</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">point</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の保有するポイントを表す。<br>
初期値は0。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ValidationJob_Overview_JobOverview"><a class="anchor" href="#Ch09_Impl_ValidationJob_Overview_JobOverview"></a>9.4.3.1.5. ジョブの概要</h6>
<div class="paragraph">
<p>ここで作成する入力チェックを行うジョブの概要を把握するために、
処理フローおよび処理シーケンスを以下に示す。</p>
</div>
<div class="paragraph">
<p><a href="#Ch09_Impl_ValidationJob_Prerequisite">前提</a>のとおりデータベースアクセスするジョブの場合の説明となるため、
ファイルアクセスするジョブの場合の処理フローおよび処理シーケンスとは異なる部分があるため留意する。</p>
</div>
<div class="paragraph">
<p>入力チェックは、単項目チェック、相関項目チェックに分類されるが、ここでは単項目チェックのみを扱う。<br>
単項目チェックは、Bean Validationを利用する。
詳細は<a href="#Ch06_InputValidation_Overview_Category">入力チェックの分類</a>を参照のこと。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">処理フロー概要</dt>
<dd>
<p>処理フローの概要を以下に示す。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/Validation/Ch09_ValidationJob_ProcessFlow.png" alt="ProcessFlow of Validation Job">
</div>
<div class="title">入力データの妥当性検証を行うジョブの処理フロー</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンクモデルの場合の処理シーケンス</dt>
<dd>
<p>チャンクモデルの場合の処理シーケンスを説明する。<br>
本ジョブは異常系データを利用することを前提として説明しているため、
このシーケンス図は入力チェックでエラー(異常終了)となった場合を示している。<br>
入力チェックが正常の場合、入力チェック以降の処理シーケンスはデータベースアクセスのシーケンス図
(<a href="#Ch09_Impl_DBAccessJob_Overview_JobOverview">ジョブの概要</a>を参照)と同じである。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>チャンクモデルの場合、入力チェックは<code>ItemProcessor</code>にデータが渡されたタイミングで行う。</p>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_ValidationJob_ProcessSequence_ChunkModel.png" alt="ProcessSequence of Validation Job by ChunkModel">
</div>
<div class="title">チャンクモデルのシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
</li>
<li>
<p>ステップは、リソースをオープンする。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから会員情報をすべて取得(select文の発行)する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで、以降の処理を繰り返す。</p>
</li>
<li>
<p>チャンク単位で、フレームワークトランザクションを開始する。</p>
</li>
<li>
<p>チャンクサイズに達するまで4から12までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは、<code>MyBatisCursorItemReader</code>から入力データを1件取得する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから入力データを1件取得する。</p>
</li>
<li>
<p>member_infoテーブルは、<code>MyBatisCursorItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、ステップに入力データを返却する。</p>
</li>
<li>
<p>ステップは、<code>PointAddItemProcessor</code>で入力データに対して処理を行う。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、<code>SpringValidator</code>に入力チェック処理を依頼する。</p>
</li>
<li>
<p><code>SpringValidator</code>は、入力チェックルールに基づき入力チェックを行い、チェックエラーの場合は例外(ValidationException)をスローする。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、入力データを読み込んでポイント加算処理を行う。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、ステップに処理結果を返却する。</p>
</li>
<li>
<p>ステップは、チャンクサイズ分のデータを<code>MyBatisBatchItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>MyBatisBatchItemWriter</code>は、member_infoテーブルに対して会員情報の更新(update文の発行)を行う。</p>
<div class="ulist">
<ul>
<li>
<p>4から14までの処理過程で<strong>例外が発生</strong>すると、以降の処理を行う。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="15">
<li>
<p>ステップはフレームワークトランザクションをロールバックする。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは異常終了:255)を返却する。</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">タスクレットモデルの場合の処理シーケンス</dt>
<dd>
<p>タスクレットモデルの場合の処理シーケンスについて説明する。<br>
本ジョブは異常系データを利用することを前提として説明しているため、
このシーケンス図は入力チェックでエラー(異常終了)となった場合を示している。<br>
入力チェックが正常の場合、入力チェック以降の処理シーケンスはデータベースアクセスのシーケンス図
(<a href="#Ch09_Impl_DBAccessJob_Overview_JobOverview">ジョブの概要</a>を参照)と同じである。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>タスクレットモデルの場合、入力チェックは<code>Tasklet#execute()</code>にて任意のタイミングで行う。<br>
ここでは、データを取得した直後に行っている。</p>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_ValidationJob_ProcessSequence_TaskletModel.png" alt="ProcessSequence of Validation Job by TaskletModel">
</div>
<div class="title">タスクレットモデルのシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
<div class="ulist">
<ul>
<li>
<p>ステップはフレームワークトランザクションを開始する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは<code>PointAddTasklet</code>を実行する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、リソースをオープンする。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから会員情報をすべて取得(select文の発行)する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで5から13までの処理を繰り返す。</p>
</li>
<li>
<p>一定件数に達するまで5から11までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>PointAddTasklet</code>は、<code>MyBatisCursorItemReader</code>から入力データを1件取得する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから入力データを1件取得する。</p>
</li>
<li>
<p>member_infoテーブルは、<code>MyBatisCursorItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、タスクレットに入力データを返却する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、<code>SpringValidator</code>に入力チェック処理を依頼する。</p>
</li>
<li>
<p><code>SpringValidator</code>は、入力チェックルールに基づき入力チェックを行い、チェックエラーの場合は例外(ValidationException)をスローする。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、入力データを読み込んでポイント加算処理を行う。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、一定件数分のデータを<code>MyBatisBatchItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>MyBatisBatchItemWriter</code>は、member_infoテーブルに対して会員情報の更新(update文の発行)を行う。</p>
<div class="ulist">
<ul>
<li>
<p>2から13までの処理過程で<strong>例外が発生</strong>すると、以降の処理を行う。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="14">
<li>
<p><code>PointAddTasklet</code>はステップへ例外(ここではValidationException)をスローする。</p>
</li>
<li>
<p>ステップはフレームワークトランザクションをロールバックする。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは異常終了:255)を返却する。</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">入力チェック処理を実装するための設定</div>
<div class="paragraph">
<p>入力チェックにはHibernate Validatorを使用する。Macchinetta Batch 2.xでは既に設定済みであるが、
ライブラリの依存関係にHibernate Validatorの定義、およびBean定義が必要となる。</p>
</div>
<div class="listingblock">
<div class="title">依存ライブラリの設定例(pom.xml)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.hibernate<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>hibernate-validator<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/spring/launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">validator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.validator.SpringValidator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:validator-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">beanValidator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">beanValidator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.validation.beanvalidation.LocalValidatorFactoryBean</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以降で、チャンクモデル、タスクレットモデルそれぞれの実装方法を説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch09_Impl_ValidationJob_Chunk">チャンクモデルでの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ValidationJob_Tasklet">タスクレットモデルでの実装</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_ValidationJob_Chunk"><a class="anchor" href="#Ch09_Impl_ValidationJob_Chunk"></a>9.4.3.2. チャンクモデルでの実装</h5>
<div class="paragraph">
<p>チャンクモデルで入力チェックを行うジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_ValidationJob_Chunk_ValidationRulesDefinition">入力チェックルールの定義</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ValidationJob_Chunk_Coding">入力チェック処理の実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ValidationJob_Chunk_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ValidationJob_Chunk_ValidationRulesDefinition"><a class="anchor" href="#Ch09_Impl_ValidationJob_Chunk_ValidationRulesDefinition"></a>9.4.3.2.1. 入力チェックルールの定義</h6>
<div class="paragraph">
<p>入力チェックを行うために、DTOクラスのチェック対象のフィールドにBean Validationのアノテーションを付与する。<br>
入力チェック用のアノテーションについては、Macchinetta Server 1.x 開発ガイドラインの<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebApplicationDetail/Validation.html#validation-jsr303-doc">Bean Validationのチェックルール</a>
および<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebApplicationDetail/Validation.html#validation-validator-list">Hibernate Validatorのチェックルール</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に実施している場合は読み飛ばしてよい。</p>
</div>
<div class="paragraph">
<p>ここでは、ポイントが1,000,000(上限値)を超過していないかチェックするためのチェックルールを定義する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.dto.MemberInfoDTO</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.dto</span>;

<span class="keyword">import</span> <span class="include">javax.validation.constraints.Max</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MemberInfoDto</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> type;

    <span class="directive">private</span> <span class="predefined-type">String</span> status;

    <span class="annotation">@Max</span>(<span class="integer">1000000</span>) <span class="comment">// (1)</span>
    <span class="directive">private</span> <span class="type">int</span> point;

    <span class="comment">// Getter and setter are omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">対象のフィールドが指定した数値以下であることを示す@Maxアノテーションを付与する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ValidationJob_Chunk_Coding"><a class="anchor" href="#Ch09_Impl_ValidationJob_Chunk_Coding"></a>9.4.3.2.2. 入力チェック処理の実装</h6>
<div class="paragraph">
<p>ポイント加算処理を行うビジネスロジッククラスに入力チェック処理を実装する。</p>
</div>
<div class="paragraph">
<p>既に実装してある<code>PointAddItemProcessor</code>クラスに入力チェック処理の実装を追加する。<br>
<a href="#Ch09_Impl_ValidationJob_Prerequisite">前提</a>のとおりデータベースアクセスするジョブの場合の説明となるため、ファイルアクセスするジョブの場合の
実装は以下の(1)～(3)のみ追加する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.dbaccess.chunk.PointAddItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Package and the other import are omitted.</span>

<span class="keyword">import</span> <span class="include">javax.inject.Inject</span>;

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PointAddItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;MemberInfoDto, MemberInfoDto&gt; {
    <span class="comment">// Definition of constans are omitted.</span>

    <span class="annotation">@Inject</span> <span class="comment">// (1)</span>
    <span class="predefined-type">Validator</span>&lt;MemberInfoDto&gt; validator; <span class="comment">// (2)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> MemberInfoDto process(MemberInfoDto item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        validator.validate(item); <span class="comment">// (3)</span>

        <span class="comment">// The other codes of bussiness logic are omitted.</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SpringValidator</code>のインスタンスをインジェクトする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.validator.Validator</code>の型引数には、
<code>ItemReader</code>を通じて取得するDTOを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemReader</code>を通じて取得するDTOを引数として<code>Validator#validate()</code>を実行する。<br>
本来、<code>validate()</code>を実行する際は入力チェックエラーをハンドリングするためにtry-catchを実装して例外を捕捉するが、
try-catchを利用した例外ハンドリングは<a href="#Ch09_ExceptionHandlingWithTryCatchJob">try-catchで例外ハンドリングを行うジョブ</a>で説明するため、
ここでは、例外ハンドリングは実装しない。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ValidationJob_Chunk_Execution"><a class="anchor" href="#Ch09_Impl_ValidationJob_Chunk_Execution"></a>9.4.3.2.3. ジョブの実行と結果の確認</h6>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ValidationJob_Chunk_Execution_Run"><a class="anchor" href="#Ch09_Impl_ValidationJob_Chunk_Execution_Run"></a>実行構成からジョブを実行</h7>
<div class="paragraph">
<p>既に作成してある実行構成から、ジョブを実行する。</p>
</div>
<div class="paragraph">
<p>ここでは、異常系データを利用してジョブを実行する。<br>
入力チェックを実装したジョブが扱うリソース(データベース or ファイル)によって
入力データの切替方法が異なるため、以下のとおり実行すること。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">データベースアクセスでデータ入出力を行うジョブに対して入力チェックを実装した場合</dt>
<dd>
<p>データベースアクセスでデータ入出力を行うジョブの<a href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a>
で作成した実行構成を使ってジョブを実行する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>異常系データを利用するために、<code>batch-application.proeprties</code>のDatabase Initializeで
正常系データのスクリプトをコメントアウトし、異常系データのスクリプトのコメントアウトを解除する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/batch-application.proeprties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"># Database Initialize
tutorial.create-table.script=file:sqls/create-member-info-table.sql
#tutorial.insert-data.script=file:sqls/insert-member-info-data.sql
tutorial.insert-data.script=file:sqls/insert-member-info-error-data.sql</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ファイルアクセスでデータ入出力を行うジョブに対して入力チェックを実装した場合</dt>
<dd>
<p>ファイルアクセスでデータ入出力を行うジョブの<a href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a>
で作成した実行構成を使ってジョブを実行する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>異常系データを利用するために、実行構成で設定する引数のうち、
入力ファイル(inputFile)のパスを正常系データ(insert-member-info-data.csv)から異常系データ(insert-member-info-error-data.csv)に変更する。</p>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ValidationJob_Chunk_Execution_Console"><a class="anchor" href="#Ch09_Impl_ValidationJob_Chunk_Execution_Console"></a>コンソールログの確認</h7>
<div class="paragraph">
<p>Console Viewを開き、以下の内容のログが出力されていることを確認する。<br>
ここでは、処理が異常終了(FAILED)し、
<code>org.springframework.batch.item.validator.ValidationException</code>が発生していることを確認する。</p>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/08/28 10:53:21] [main] [o.s.b.c.s.AbstractStep] [ERROR] Encountered an error executing step jobPointAddChunk.step01 in job jobPointAddChunk
org.springframework.batch.item.validator.ValidationException: Validation failed for com.example.batch.tutorial.common.dto.MemberInfoDto@1fde4f40:
Field error in object 'item' on field 'point': rejected value [1000001]; codes [Max.item.point,Max.point,Max.int,Max]; arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [item.point,point]; arguments []; default message [point],1000000]; default message [must be less than or equal to 1000000]
        at org.springframework.batch.item.validator.SpringValidator.validate(SpringValidator.java:54)

(.. omitted)

Caused by: org.springframework.validation.BindException: org.springframework.validation.BeanPropertyBindingResult: 1 errors
Field error in object 'item' on field 'point': rejected value [1000001]; codes [Max.item.point,Max.point,Max.int,Max]; arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [item.point,point]; arguments []; default message [point],1000000]; default message [must be less than or equal to 1000000]
        ... 29 common frames omitted
[2017/08/28 10:53:21] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddChunk]] completed with the following parameters: [{jsr_batch_run_id=408}] and the following status: [FAILED]
[2017/08/28 10:53:21] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@2145433b: startup date [Mon Aug 28 10:53:18 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ValidationJob_Chunk_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_ValidationJob_Chunk_Execution_Exitcode"></a>終了コードの確認</h7>
<div class="paragraph">
<p>終了コードにより、異常終了したことを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が255(異常終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/Validation/Ch09_ValidationJob_Confirm_ExitCode_ChunkModel.png" alt="Confiｒm the Exit Code of ValidationJob for ChunkModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ValidationJob_Chunk_Execution_Output"><a class="anchor" href="#Ch09_Impl_ValidationJob_Chunk_Execution_Output"></a>出力リソースの確認</h7>
<div class="paragraph">
<p>入力チェックを実装したジョブによって出力リソース(データベース or ファイル)を確認する。</p>
</div>
<div class="paragraph">
<p>チャンクモデルの場合、中間コミット方式をとっているため、エラー箇所直前のチャンクまで更新が確定していることを確認する。</p>
</div>
<div class="sect7">
<h8 id="Ch09_Impl_ValidationJob_Chunk_Execution_Output_Table"><a class="anchor" href="#Ch09_Impl_ValidationJob_Chunk_Execution_Output_Table"></a>会員情報テーブルの確認</h8>
<div class="paragraph">
<p>Data Source Explorerを使用して会員情報テーブルの確認を行う。<br>
更新前後の会員情報テーブルの内容を比較し、確認内容のとおりとなっていることを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_RefDB">Data Source Explorerを使用してデータベースを参照する</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>1から10番目のレコード(会員番号が"00000001"から"00000010"のレコード)について</p>
<div class="ulist">
<ul>
<li>
<p>statusカラム</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointカラム</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeカラムが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeカラムが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>11から15番目のレコード(会員番号が"00000011"から"00000015"のレコード)について</p>
<div class="ulist">
<ul>
<li>
<p>更新されていないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容を以下に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/Validation/Ch09_ValidationJob_Result_MemberInfoTable.png" alt="Table of member_info">
</div>
<div class="title">更新前後の会員情報テーブルの内容</div>
</div>
</div>
<div class="sect7">
<h8 id="Ch09_Impl_ValidationJob_Chunk_Execution_Output_File"><a class="anchor" href="#Ch09_Impl_ValidationJob_Chunk_Execution_Output_File"></a>会員情報ファイルの確認</h8>
<div class="paragraph">
<p>会員情報ファイルの入出力内容を比較し、確認内容のとおりとなっていることを確認する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>出力ディレクトリに会員情報ファイルが出力されていること</p>
<div class="ulist">
<ul>
<li>
<p>出力ファイル: files/output/output-member-info-data.csv</p>
</li>
</ul>
</div>
</li>
<li>
<p>出力されたレコードは、1から10番目のレコード(会員番号が"00000001"から"00000010"のレコード)のみであること</p>
</li>
<li>
<p>出力されたレコードについて</p>
<div class="ulist">
<ul>
<li>
<p>statusカラム</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointカラム</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeカラムが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeカラムが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>会員情報ファイルの入出力内容を以下に示す。<br>
ファイルのフィールドはid(会員番号)、type(会員種別)、status(商品購入フラグ)、point(ポイント)の順で出力される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/Validation/Ch09_ValidationJob_Result_MemberInfoFile.png" alt="File of member_info">
</div>
<div class="title">会員情報ファイルの入出力内容</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_ValidationJob_Tasklet"><a class="anchor" href="#Ch09_Impl_ValidationJob_Tasklet"></a>9.4.3.3. タスクレットモデルでの実装</h5>
<div class="paragraph">
<p>タスクレットモデルで入力チェックを行うジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_ValidationJob_Tasklet_ValidationRulesDefinition">入力チェックルールの定義</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ValidationJob_Tasklet_Coding">入力チェック処理の実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ValidationJob_Tasklet_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ValidationJob_Tasklet_ValidationRulesDefinition"><a class="anchor" href="#Ch09_Impl_ValidationJob_Tasklet_ValidationRulesDefinition"></a>9.4.3.3.1. 入力チェックルールの定義</h6>
<div class="paragraph">
<p>入力チェックを行うために、DTOクラスのチェック対象のフィールドにBean Validationのアノテーションを付与する。<br>
入力チェック用のアノテーションについては、Macchinetta Server 1.x 開発ガイドラインの<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebApplicationDetail/Validation.html#validation-jsr303-doc">Bean Validationのチェックルール</a>
および<a href="https://macchinetta.github.io/server-guideline/current/ja//ArchitectureInDetail/WebApplicationDetail/Validation.html#validation-validator-list">Hibernate Validatorのチェックルール</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に実施している場合は読み飛ばしてよい。</p>
</div>
<div class="paragraph">
<p>ここでは、ポイントが1,000,000(上限値)を超過していないかチェックするためのチェックルールを定義する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.dto.MemberInfoDTO</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.dto</span>;

<span class="keyword">import</span> <span class="include">javax.validation.constraints.Max</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MemberInfoDto</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> type;

    <span class="directive">private</span> <span class="predefined-type">String</span> status;

    <span class="annotation">@Max</span>(<span class="integer">1000000</span>) <span class="comment">// (1)</span>
    <span class="directive">private</span> <span class="type">int</span> point;

    <span class="comment">// Getter and setter are omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">対象のフィールドが指定した数値以下であることを示す@Maxアノテーションを付与する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ValidationJob_Tasklet_Coding"><a class="anchor" href="#Ch09_Impl_ValidationJob_Tasklet_Coding"></a>9.4.3.3.2. 入力チェック処理の実装</h6>
<div class="paragraph">
<p>ポイント加算処理を行うビジネスロジッククラスに入力チェック処理を実装する。</p>
</div>
<div class="paragraph">
<p>既に実装してある<code>PointAddTasklet</code>クラスに入力チェック処理の実装を追加する。<br>
<a href="#Ch09_Impl_ValidationJob_Prerequisite">前提</a>のとおりデータベースアクセスするジョブの場合の説明となるため、
ファイルアクセスするジョブの場合の実装は以下の(1)～(3)のみ追加する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.dbaccess.tasklet.PointAddTasklet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Package and the other import are omitted.</span>

<span class="keyword">import</span> <span class="include">javax.inject.Inject</span>;

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PointAddTasklet</span> <span class="directive">implements</span> Tasklet {
    <span class="comment">// Definition of constans, ItemStreamReader and ItemWriter are omitted.</span>

    <span class="annotation">@Inject</span> <span class="comment">// (1)</span>
    <span class="predefined-type">Validator</span>&lt;MemberInfoDto&gt; validator; <span class="comment">// (2)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {
        MemberInfoDto item = <span class="predefined-constant">null</span>;

        <span class="predefined-type">List</span>&lt;MemberInfoDto&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(CHUNK_SIZE);

        <span class="keyword">try</span> {
            reader.open(chunkContext.getStepContext().getStepExecution().getExecutionContext());

            <span class="keyword">while</span> ((item = reader.read()) != <span class="predefined-constant">null</span>) {
                validator.validate(item); <span class="comment">// (3)</span>

                <span class="comment">// The other codes of bussiness logic are omitted.</span>
            }

            writer.write(items);
        } <span class="keyword">finally</span> {
            reader.close();
        }

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SpringValidator</code>のインスタンスをインジェクトする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.validator.Validator</code>の型引数には、
<code>ItemReader</code>を通じて取得するDTOを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemReader</code>を通じて取得するDTOを引数として<code>Validator#validate()</code>を実行する。<br>
本来、<code>validate()</code>を実行する際は入力チェックエラーをハンドリングするためにtry-catchを実装して例外を捕捉するが、
try-catchを利用した例外ハンドリングは<a href="#Ch09_ExceptionHandlingWithTryCatchJob">try-catchで例外ハンドリングを行うジョブ</a>で説明するため、
ここでは、例外ハンドリングは実装しない。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ValidationJob_Tasklet_Execution"><a class="anchor" href="#Ch09_Impl_ValidationJob_Tasklet_Execution"></a>9.4.3.3.3. ジョブの実行と結果の確認</h6>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ValidationJob_Tasklet_Execution_Run"><a class="anchor" href="#Ch09_Impl_ValidationJob_Tasklet_Execution_Run"></a>実行構成からジョブを実行</h7>
<div class="paragraph">
<p>既に作成してある実行構成から、ジョブを実行する。</p>
</div>
<div class="paragraph">
<p>ここでは、異常系データを利用してジョブを実行する。<br>
入力チェックを実装したジョブが扱うリソース(データベース or ファイル)によって
入力データの切替方法が異なるため、以下のとおり実行すること。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">データベースアクセスでデータ入出力を行うジョブに対して入力チェックを実装した場合</dt>
<dd>
<p>データベースアクセスでデータ入出力を行うジョブの<a href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a>
で作成した実行構成を使ってジョブを実行する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>異常系データを利用するために、<code>batch-application.proeprties</code>のDatabase Initializeで
正常系データのスクリプトをコメントアウトし、異常系データのスクリプトのコメントアウトを解除する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/batch-application.proeprties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"># Database Initialize
tutorial.create-table.script=file:sqls/create-member-info-table.sql
#tutorial.insert-data.script=file:sqls/insert-member-info-data.sql
tutorial.insert-data.script=file:sqls/insert-member-info-error-data.sql</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ファイルアクセスでデータ入出力を行うジョブに対して入力チェックを実装した場合</dt>
<dd>
<p>ファイルアクセスでデータ入出力を行うジョブの<a href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a>
で作成した実行構成を使ってジョブを実行する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>異常系データを利用するために、実行構成で設定する引数のうち、
入力ファイル(inputFile)のパスを正常系データ(insert-member-info-data.csv)から異常系データ(insert-member-info-error-data.csv)に変更する。</p>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ValidationJob_Tasklet_Execution_Console"><a class="anchor" href="#Ch09_Impl_ValidationJob_Tasklet_Execution_Console"></a>コンソールログの確認</h7>
<div class="paragraph">
<p>Console Viewを開き、以下の内容のログが出力されていることを確認する。<br>
ここでは、処理が異常終了(FAILED)し、
<code>org.springframework.batch.item.validator.ValidationException</code>が発生していることを確認する。</p>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/09/12 10:18:49] [main] [o.s.b.c.s.AbstractStep] [ERROR] Encountered an error executing step jobPointAddTasklet.step01 in job jobPointAddTasklet
org.springframework.batch.item.validator.ValidationException: Validation failed for com.example.batch.tutorial.common.dto.MemberInfoDto@2c383e33:
Field error in object 'item' on field 'point': rejected value [1000001]; codes [Max.item.point,Max.point,Max.int,Max]; arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [item.point,point]; arguments []; default message [point],1000000]; default message [must be less than or equal to 1000000]
        at org.springframework.batch.item.validator.SpringValidator.validate(SpringValidator.java:54)

(.. omitted)

Caused by: org.springframework.validation.BindException: org.springframework.validation.BeanPropertyBindingResult: 1 errors
Field error in object 'item' on field 'point': rejected value [1000001]; codes [Max.item.point,Max.point,Max.int,Max]; arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [item.point,point]; arguments []; default message [point],1000000]; default message [must be less than or equal to 1000000]
        ... 24 common frames omitted
[2017/09/12 10:18:49] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddTasklet]] completed with the following parameters: [{jsr_batch_run_id=476}] and the following status: [FAILED]
[2017/09/12 10:18:49] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@735f7ae5: startup date [Tue Sep 12 10:18:47 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ValidationJob_Tasklet_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_ValidationJob_Tasklet_Execution_Exitcode"></a>終了コードの確認</h7>
<div class="paragraph">
<p>終了コードにより、異常終了したことを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が255(異常終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/Validation/Ch09_ValidationJob_Confirm_ExitCode_TaskletModel.png" alt="Confiｒm the Exit Code of ValidationJob for TaskletModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ValidationJob_Tasklet_Execution_Output"><a class="anchor" href="#Ch09_Impl_ValidationJob_Tasklet_Execution_Output"></a>出力リソースの確認</h7>
<div class="paragraph">
<p>入力チェックを実装したジョブによって出力リソース(データベース or ファイル)を確認する。</p>
</div>
<div class="paragraph">
<p>タスクレットモデルの場合、一括コミット方式をとっているため、エラーが発生した場合は一切更新されていないことを確認してほしい。</p>
</div>
<div class="sect7">
<h8 id="Ch09_Impl_ValidationJob_Tasklet_Execution_Output_Table"><a class="anchor" href="#Ch09_Impl_ValidationJob_Tasklet_Execution_Output_Table"></a>会員情報テーブルの確認</h8>
<div class="paragraph">
<p>Data Source Explorerを使用して会員情報テーブルの確認を行う。<br>
更新前後の会員情報テーブルの内容を比較し、確認内容のとおりとなっていることを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_RefDB">Data Source Explorerを使用してデータベースを参照する</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>すべてのレコードについて、データが更新されていないこと</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/Validation/Ch09_ValidationJob_Initial_MemberInfoTable.png" alt="member_info table in the initial state">
</div>
<div class="title">初期状態の会員情報テーブルの内容</div>
</div>
</div>
<div class="sect7">
<h8 id="Ch09_Impl_ValidationJob_Tasklet_Execution_Output_File"><a class="anchor" href="#Ch09_Impl_ValidationJob_Tasklet_Execution_Output_File"></a>会員情報ファイルの確認</h8>
<div class="paragraph">
<p>会員情報ファイルの入出力内容を比較し、確認内容のとおりとなっていることを確認する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>出力ディレクトリに会員情報ファイルが<strong>空ファイル</strong>で出力されていること</p>
<div class="ulist">
<ul>
<li>
<p>出力ファイル: files/output/output-member-info-data.csv</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_ExceptionHandlingWithListenerJob"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob"></a>9.4.4. ChunkListenerで例外ハンドリングを行うジョブ</h4>
<div id="Ch09_Impl_ExceptionHandlingWithListenerJob_Prerequisite" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">前提</div>
<div class="paragraph">
<p><a href="#Ch09_Introduction_HowToProceed">チュートリアルの進め方</a>で説明しているとおり、
<a href="#Ch09_Impl_ValidationJob">入力データの妥当性検証を行うジョブ</a>に対して、
例外ハンドリングの実装を追加していく形式とする。なお、例外ハンドリング方式にはtry-catchやChunkListenerなど様々な方式がある。<br>
ただし、記述はデータベースアクセスするジョブに実装を追加した場合の説明としているため留意すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Overview"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Overview"></a>9.4.4.1. 概要</h5>
<div class="paragraph">
<p>ChunkListenerで例外ハンドリングを行うジョブを作成する。</p>
</div>
<div class="paragraph">
<p>なお、本節はMacchinetta Batch 2.x 開発ガイドラインを元に説明しているため、
詳細については<a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_ChunkListener">ChunkListenerインターフェースによる例外ハンドリング</a>を参照のこと。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">リスナーの用途について</div>
<div class="paragraph">
<p>ここでは、リスナーによりステップの実行後に例外発生の有無をチェックすることで例外ハンドリングを実現するが、
リスナーの用途は例外ハンドリングに限定されてはいないため、
詳細については<a href="#Ch04_Listener">リスナー</a>を参照のこと。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#Ch09_TutorialApplication">作成するアプリケーションの説明</a>の
背景、処理概要、業務仕様を以下に再掲する。</p>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Overview_Background"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Overview_Background"></a>9.4.4.1.1. 背景</h6>
<div class="paragraph">
<p>とある量販店では、会員に対してポイントカードを発行している。<br>
会員には「ゴールド会員」「一般会員」の会員種別が存在し、会員種別に応じたサービスを提供している。<br>
今回そのサービスの一環として、月内に商品を購入した会員のうち、
会員種別が「ゴールド会員」の場合は100ポイント、「一般会員」の場合は10ポイントを月末に加算することにした。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Overview_ProcessOverview"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Overview_ProcessOverview"></a>9.4.4.1.2. 処理概要</h6>
<div class="paragraph">
<p>会員種別に応じてポイント加算を行うアプリケーションを
月次バッチ処理としてMacchinetta Batch 2.xを使用して実装する。<br>
入力データにポイントの上限値を超えるデータが存在するか妥当性検証を行う処理を追加実装し、
エラーの場合ログを出力し、異常終了させる。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Overview_BusinessSpecification"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Overview_BusinessSpecification"></a>9.4.4.1.3. 業務仕様</h6>
<div class="paragraph">
<p>業務仕様は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>入力データのポイントが1,000,000ポイントを超過していないことをチェックする</p>
<div class="ulist">
<ul>
<li>
<p>チェックエラーとなる場合は、エラーメッセージをログに出力して処理を異常終了する</p>
</li>
<li>
<p>エラーメッセージはリスナーによる後処理で実現する</p>
</li>
<li>
<p>メッセージ内容は「The Point exceeds 1000000.」(ポイントが1,000,000を超えています)とする</p>
</li>
</ul>
</div>
</li>
<li>
<p>商品購入フラグが"1"(処理対象)の場合に、会員種別に応じてポイントを加算する</p>
<div class="ulist">
<ul>
<li>
<p>会員種別が"G"(ゴールド会員)の場合は100ポイント、"N"(一般会員)の場合は10ポイント加算する</p>
</li>
</ul>
</div>
</li>
<li>
<p>商品購入フラグはポイント加算後に"0"(初期状態)に更新する</p>
</li>
<li>
<p>ポイントの上限値は1,000,000ポイントとする</p>
</li>
<li>
<p>ポイント加算後に1,000,000ポイントを超えた場合は、1,000,000ポイントに補正する</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Overview_TableSpecification"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Overview_TableSpecification"></a>9.4.4.1.4. テーブル仕様</h6>
<div class="paragraph">
<p>入出力リソースとなる会員情報テーブルの仕様は以下のとおり。<br>
<a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Prerequisite">前提</a>のとおりデータベースアクセスするジョブの場合の説明となるため、ファイルアクセスするジョブの場合の
入出力のリソース仕様は<a href="#Ch09_Impl_FileAccessJob_Overview_FileSpecification">ファイル仕様</a>を参照する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">会員情報テーブル(member_info)</caption>
<colgroup>
<col style="width: 3.0927%;">
<col style="width: 15.4639%;">
<col style="width: 10.3092%;">
<col style="width: 4.1237%;">
<col style="width: 12.3711%;">
<col style="width: 8.2474%;">
<col style="width: 46.392%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">属性名</th>
<th class="tableblock halign-left valign-top">カラム名</th>
<th class="tableblock halign-left valign-top">PK</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">桁数</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員を一意に示す8桁固定の番号を表す。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の種別を以下のとおり表す。<br>
"G"(ゴールド会員)、"N"(一般会員)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">月内に商品を買ったかどうかを表す。<br>
商品購入で"1"(処理対象)、月次バッチ処理で"0"(初期状態)に更新される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイント</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">point</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の保有するポイントを表す。<br>
初期値は0。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Overview_JobOverview"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Overview_JobOverview"></a>9.4.4.1.5. ジョブの概要</h6>
<div class="paragraph">
<p>ここで作成する入力チェックを行うジョブの概要を把握するために、
処理フローおよび処理シーケンスを以下に示す。</p>
</div>
<div class="paragraph">
<p><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Prerequisite">前提</a>のとおりデータベースアクセスするジョブの場合の説明となるため、
ファイルアクセスするジョブの場合の処理フローおよび処理シーケンスとは異なる部分があるため留意する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">処理フロー概要</dt>
<dd>
<p>処理フローの概要を以下に示す。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/ExceptionHandlingWithListener/Ch09_ExceptionHandlingWithListenerJob_ProcessFlow.png" alt="ProcessFlow of ExceptionHandlingWithListener Job">
</div>
<div class="title">例外ハンドリングを行うジョブの処理フロー</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンクモデルの場合の処理シーケンス</dt>
<dd>
<p>チャンクモデルの場合の処理シーケンスを説明する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>チャンクモデルの場合の処理シーケンスを説明する。<br>
本ジョブは異常系データを利用することを前提として説明しているため、
このシーケンス図は入力チェックでエラー(異常終了)となった場合を示している。<br>
入力チェックが正常の場合、入力チェック以降の処理シーケンスはデータベースアクセスのシーケンス図
(<a href="#Ch09_Impl_DBAccessJob_Overview_JobOverview">ジョブの概要</a>を参照)と同じである。</p>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_ExceptionHandlingWithListenerJob_ProcessSequence_ChunkModel.png" alt="ProcessSequence of ExceptionHandlingWithListener Job by ChunkModel">
</div>
<div class="title">チャンクモデルのシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
</li>
<li>
<p>ステップは、リソースをオープンする。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから会員情報をすべて取得(select文の発行)する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで、以降の処理を繰り返す。</p>
</li>
<li>
<p>チャンク単位で、フレームワークトランザクションを開始する。</p>
</li>
<li>
<p>チャンクサイズに達するまで4から12までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは、<code>MyBatisCursorItemReader</code>から入力データを1件取得する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから入力データを1件取得する。</p>
</li>
<li>
<p>member_infoテーブルは、<code>MyBatisCursorItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、ステップに入力データを返却する。</p>
</li>
<li>
<p>ステップは、<code>PointAddItemProcessor</code>で入力データに対して処理を行う。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、<code>SpringValidator</code>に入力チェック処理を依頼する。</p>
</li>
<li>
<p><code>SpringValidator</code>は、入力チェックルールに基づき入力チェックを行い、チェックエラーの場合は例外(ValidationException)をスローする。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、入力データを読み込んでポイント加算処理を行う。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、ステップに処理結果を返却する。</p>
</li>
<li>
<p>ステップは、チャンクサイズ分のデータを<code>MyBatisBatchItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>MyBatisBatchItemWriter</code>は、member_infoテーブルに対して会員情報の更新(update文の発行)を行う。</p>
<div class="ulist">
<ul>
<li>
<p>4から14までの処理過程で<strong>例外が発生</strong>すると、以降の処理を行う。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="15">
<li>
<p>ステップはフレームワークトランザクションをロールバックする。</p>
</li>
<li>
<p>ステップは<code>ChunkErrorLoggingListener</code>を実行する。</p>
</li>
<li>
<p><code>ChunkErrorLoggingListener</code>はERRORログ出力処理を行う。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは異常終了:255)を返却する。</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">タスクレットモデルの場合の処理シーケンス</dt>
<dd>
<p>タスクレットモデルの場合の処理シーケンスについて説明する。<br>
本ジョブは異常系データを利用することを前提として説明しているため、
このシーケンス図は入力チェックでエラー(異常終了)となった場合を示している。<br>
入力チェックが正常の場合、入力チェック以降の処理シーケンスはデータベースアクセスのシーケンス図
(<a href="#Ch09_Impl_DBAccessJob_Overview_JobOverview">ジョブの概要</a>を参照)と同じである。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_ExceptionHandlingWithListenerJob_ProcessSequence_TaskletModel.png" alt="ProcessSequence of ExceptionHandlingWithListener Job by TaskletModel">
</div>
<div class="title">タスクレットモデルのシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
<div class="ulist">
<ul>
<li>
<p>ステップはフレームワークトランザクションを開始する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは<code>PointAddTasklet</code>を実行する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、リソースをオープンする。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから会員情報をすべて取得(select文の発行)する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで5から13までの処理を繰り返す。</p>
</li>
<li>
<p>一定件数に達するまで5から11までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>PointAddTasklet</code>は、<code>MyBatisCursorItemReader</code>から入力データを1件取得する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから入力データを1件取得する。</p>
</li>
<li>
<p>member_infoテーブルは、<code>MyBatisCursorItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、タスクレットに入力データを返却する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、<code>SpringValidator</code>に入力チェック処理を依頼する。</p>
</li>
<li>
<p><code>SpringValidator</code>は、入力チェックルールに基づき入力チェックを行い、チェックエラーの場合は例外(ValidationException)をスローする。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、入力データを読み込んでポイント加算処理を行う。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、一定件数分のデータを<code>MyBatisBatchItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>MyBatisBatchItemWriter</code>は、member_infoテーブルに対して会員情報の更新(update文の発行)を行う。</p>
<div class="ulist">
<ul>
<li>
<p>2から13までの処理過程で<strong>例外が発生</strong>すると、以降の処理を行う。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="14">
<li>
<p><code>PointAddTasklet</code>はステップへ例外(ここではValidationException)をスローする。</p>
</li>
<li>
<p>ステップはフレームワークトランザクションをロールバックする。</p>
</li>
<li>
<p>ステップは<code>ChunkErrorLoggingListener</code>を実行する。</p>
</li>
<li>
<p><code>ChunkErrorLoggingListener</code>はERRORログ出力処理を行う。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは異常終了:255)を返却する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>以降で、チャンクモデル、タスクレットモデルそれぞれの実装方法を説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk">チャンクモデルでの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet">タスクレットモデルでの実装</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk"></a>9.4.4.2. チャンクモデルでの実装</h5>
<div class="paragraph">
<p>チャンクモデルで入力チェックを行うジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_MessageDefinition">メッセージ定義の追加</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Coding">例外ハンドリングの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_MessageDefinition"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_MessageDefinition"></a>9.4.4.2.1. メッセージ定義の追加</h6>
<div class="paragraph">
<p>コード体系のばらつき防止や、監視対象のキーワードとしての抽出を設計しやすくするため、
ログメッセージはメッセージ定義を使用し、ログ出力時に使用する。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="paragraph">
<p><code>application-messages.properties</code>および<code>launch-context.xml</code>を以下のとおり設定する。<br>
<code>launch-context.xml</code>はMacchinetta Batch 2.xでは設定済みである。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/i18n/application-messages.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"># (1)
errors.maxInteger=The {0} exceeds {1}.</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/spring/launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">messageSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.context.support.ResourceBundleMessageSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:basenames</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">i18n/application-messages</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイント上限超過時に出力するメッセージを設定する。<br>
{0)に項目名、{1}に上限値を割り当てる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロパティファイルからメッセージを使用するために、<code>MessageSource</code>を設定する。<br>
<code>basenames</code>に、プロパティファイルの格納場所を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Coding"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Coding"></a>9.4.4.2.2. 例外ハンドリングの実装</h6>
<div class="paragraph">
<p>例外ハンドリング処理を実装する。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Coding_Listener">ChunkErrorLoggingListenerクラスの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Coding_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Coding_Listener"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Coding_Listener"></a>ChunkErrorLoggingListenerクラスの実装</h7>
<div class="paragraph">
<p>ChunkListenerインターフェースを利用して例外ハンドリングする。<br>
ここでは、ChunkListenerインターフェースの実装クラスとして、例外発生時にERRORログを出力する処理を実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.listener.ChunkErrorLoggingListener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.listener</span>;

<span class="keyword">import</span> <span class="include">org.slf4j.Logger</span>;
<span class="keyword">import</span> <span class="include">org.slf4j.LoggerFactory</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.ChunkListener</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.scope.context.ChunkContext</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.validator.ValidationException</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.MessageSource</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;

<span class="keyword">import</span> <span class="include">javax.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">java.util.Locale</span>;

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ChunkErrorLoggingListener</span> <span class="directive">implements</span> ChunkListener {
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(ChunkErrorLoggingListener.class);

    <span class="annotation">@Inject</span>
    MessageSource messageSource; <span class="comment">// (1)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeChunk(ChunkContext chunkContext) {
        <span class="comment">// do nothing.</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterChunk(ChunkContext chunkContext) {
        <span class="comment">// do nothing.</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterChunkError(ChunkContext chunkContext) {
        <span class="exception">Exception</span> e = (<span class="exception">Exception</span>) chunkContext.getAttribute(ChunkListener.ROLLBACK_EXCEPTION_KEY); <span class="comment">// (2)</span>
        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ValidationException) {
            logger.error(messageSource
                    .getMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">errors.maxInteger</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> { <span class="string"><span class="delimiter">&quot;</span><span class="content">Point</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">1000000</span><span class="delimiter">&quot;</span></span> }, <span class="predefined-type">Locale</span>.getDefault())); <span class="comment">// (3)</span>
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResourceBundleMessageSource</code>のインスタンスをインジェクトする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ROLLBACK_EXCEPTION_KEY</code>に設定された値をキーにして発生した例外を取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロパティファイルからメッセージIDが<code>errors.maxInteger</code>のメッセージを取得し、ログに出力する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Coding_Bean"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Coding_Bean"></a>ジョブBean定義ファイルの設定</h7>
<div class="paragraph">
<p>例外ハンドリングをChunkListenerで行うためのジョブBean定義ファイルの設定を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.chunk,</span>
            <span class="content">com.example.batch.tutorial.common.listener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>

    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddChunk</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddChunk.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pointAddItemProcessor</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;batch:listeners&gt;</span>
                    <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkErrorLoggingListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!--(2)--&gt;</span>
                <span class="tag">&lt;/batch:listeners&gt;</span>
            <span class="tag">&lt;/batch:tasklet&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャン対象とするベースパッケージの設定を行う。<br>
<code>base-package</code>属性に、<code>ChunkListener</code>の実装クラスが格納されているパッケージを追加で指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepListener</code>の実装クラスを設定する。
なお、<code>ChunkListener</code>は<code>StepListener</code>の拡張インターフェースである。<br>
ここでは、ChunkListenerの実装クラスのBeanIDである<code>chunkErrorLoggingListener</code>を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution"></a>9.4.4.2.3. ジョブの実行と結果の確認</h6>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution_Run"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution_Run"></a>実行構成からジョブを実行</h7>
<div class="paragraph">
<p>既に作成してある実行構成から、ジョブを実行する。</p>
</div>
<div class="paragraph">
<p>ここでは、異常系データを利用してジョブを実行する。<br>
入力チェックを実装したジョブが扱うリソース(データベース or ファイル)によって、
入力データの切替方法が異なるため、以下のとおり実行すること。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">データベースアクセスでデータ入出力を行うジョブに対して入力チェックを実装した場合</dt>
<dd>
<p>データベースアクセスでデータ入出力を行うジョブの<a href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a>
で作成した実行構成を使ってジョブを実行する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>異常系データを利用するために、<code>batch-application.proeprties</code>のDatabase Initializeで
正常系データのスクリプトをコメントアウトし、異常系データのスクリプトのコメントアウトを解除する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/batch-application.proeprties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"># Database Initialize
tutorial.create-table.script=file:sqls/create-member-info-table.sql
#tutorial.insert-data.script=file:sqls/insert-member-info-data.sql
tutorial.insert-data.script=file:sqls/insert-member-info-error-data.sql</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ファイルアクセスでデータ入出力を行うジョブに対して入力チェックを実装した場合</dt>
<dd>
<p>ファイルアクセスでデータ入出力を行うジョブの<a href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a>
で作成した実行構成を使ってジョブを実行する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>異常系データを利用するために、実行構成で設定する引数のうち、
入力ファイル(inputFile)のパスを正常系データ(insert-member-info-data.csv)から異常系データ(insert-member-info-error-data.csv)に変更する。</p>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution_Console"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution_Console"></a>コンソールログの確認</h7>
<div class="paragraph">
<p>Console Viewを開き、以下の内容のログが出力されていることを確認する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>処理が異常終了(FAILED)していること</p>
</li>
<li>
<p><code>org.springframework.batch.item.validator.ValidationException</code>が発生していること</p>
</li>
<li>
<p><code>com.example.batch.tutorial.common.listener.ChunkErrorLoggingListener</code>が次のERRORログとして次のメッセージを出力していること</p>
<div class="ulist">
<ul>
<li>
<p>「The Point exceeds 1000000.」</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/09/12 11:13:52] [main] [o.t.b.t.c.l.ChunkErrorLoggingListener] [ERROR] The Point exceeds 1000000.
[2017/09/12 11:13:52] [main] [o.s.b.c.s.AbstractStep] [ERROR] Encountered an error executing step jobPointAddChunk.step01 in job jobPointAddChunk
org.springframework.batch.item.validator.ValidationException: Validation failed for com.example.batch.tutorial.common.dto.MemberInfoDto@6c8a68c1:
Field error in object 'item' on field 'point': rejected value [1000001]; codes [Max.item.point,Max.point,Max.int,Max]; arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [item.point,point]; arguments []; default message [point],1000000]; default message [must be less than or equal to 1000000]
        at org.springframework.batch.item.validator.SpringValidator.validate(SpringValidator.java:54)

(.. omitted)

[2017/09/12 11:13:52] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddChunk]] completed with the following parameters: [{jsr_batch_run_id=480}] and the following status: [FAILED]
[2017/09/12 11:13:52] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@735f7ae5: startup date [Tue Sep 12 11:13:50 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution_Exitcode"></a>終了コードの確認</h7>
<div class="paragraph">
<p>終了コードにより、異常終了したことを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が255(異常終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/ExceptionHandlingWithListener/Ch09_ExceptionHandlingWithListenerJob_ExitCode_ChunkModel.png" alt="Confirm the Exit Code of ExceptionHandlingWithListenerJob for ChunkModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution_Output"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution_Output"></a>出力リソースの確認</h7>
<div class="paragraph">
<p>入力チェックを実装したジョブによって出力リソース(データベース or ファイル)を確認する。</p>
</div>
<div class="paragraph">
<p>チャンクモデルの場合、中間コミット方式をとっているため、エラー箇所直前のチャンクまで更新が確定していることを確認する。</p>
</div>
<div class="sect7">
<h8 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution_Output_Table"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution_Output_Table"></a>会員情報テーブルの確認</h8>
<div class="paragraph">
<p>Data Source Explorerを使用して会員情報テーブルの確認を行う。<br>
更新前後の会員情報テーブルの内容を比較し、確認内容のとおりとなっていることを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_RefDB">Data Source Explorerを使用してデータベースを参照する</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>1から10番目のレコード(会員番号が"00000001"から"00000010"のレコード)について</p>
<div class="ulist">
<ul>
<li>
<p>statusカラム</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointカラム</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeカラムが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeカラムが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>11から15番目のレコード(会員番号が"00000011"から"00000015"のレコード)について</p>
<div class="ulist">
<ul>
<li>
<p>更新されていないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容は以下のとおり。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/ExceptionHandlingWithListener/Ch09_ExceptionHandlingWithListenerJob_Result_MemberInfoTable.png" alt="Table of member_info">
</div>
<div class="title">更新前後の会員情報テーブルの内容</div>
</div>
</div>
<div class="sect7">
<h8 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution_Output_File"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Chunk_Execution_Output_File"></a>会員情報ファイルの確認</h8>
<div class="paragraph">
<p>会員情報ファイルの入出力内容を比較し、確認内容のとおりとなっていることを確認する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>出力ディレクトリに会員情報ファイルが出力されていること</p>
<div class="ulist">
<ul>
<li>
<p>出力ファイル: files/output/output-member-info-data.csv</p>
</li>
</ul>
</div>
</li>
<li>
<p>出力されたレコードは、1から10番目のレコード(会員番号が"00000001"から"00000010"のレコード)のみであること</p>
</li>
<li>
<p>出力されたレコードについて</p>
<div class="ulist">
<ul>
<li>
<p>statusカラム</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointカラム</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeカラムが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeカラムが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>会員情報ファイルの入出力内容は以下のとおり。<br>
ファイルのフィールドはid(会員番号)、type(会員種別)、status(商品購入フラグ)、point(ポイント)の順で出力される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/ExceptionHandlingWithListener/Ch09_ExceptionHandlingWithListenerJob_Result_MemberInfoFile.png" alt="File of member_info">
</div>
<div class="title">会員情報ファイルの入出力内容</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet"></a>9.4.4.3. タスクレットモデルでの実装</h5>
<div class="paragraph">
<p>タスクレットモデルで入力チェックを行うジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_MessageDefinition">メッセージ定義の追加</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Coding">例外ハンドリングの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_MessageDefinition"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_MessageDefinition"></a>9.4.4.3.1. メッセージ定義の追加</h6>
<div class="paragraph">
<p>コード体系のばらつき防止や、監視対象のキーワードとしての抽出を設計しやすくするため、
ログメッセージはメッセージ定義を使用し、ログ出力時に使用する。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="paragraph">
<p><code>application-messages.properties</code>および<code>launch-context.xml</code>を以下のとおり設定する。<br>
<code>launch-context.xml</code>はMacchinetta Batch 2.xでは設定済みである。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/i18n/application-messages.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"># (1)
errors.maxInteger=The {0} exceeds {1}.</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/spring/launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">messageSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.context.support.ResourceBundleMessageSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:basenames</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">i18n/application-messages</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイント上限超過時に出力するメッセージを設定する。<br>
{0)に項目名、{1}に上限値を割り当てる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロパティファイルからメッセージを使用するために、<code>MessageSource</code>を設定する。<br>
<code>basenames</code>に、プロパティファイルの格納場所を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Coding"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Coding"></a>9.4.4.3.2. 例外ハンドリングの実装</h6>
<div class="paragraph">
<p>例外ハンドリング処理を実装する。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Coding_Listener">ChunkErrorLoggingListenerクラスの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Coding_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Coding_Listener"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Coding_Listener"></a>ChunkErrorLoggingListenerクラスの実装</h7>
<div class="paragraph">
<p>ChunkListenerインターフェースを利用して例外ハンドリングする。<br>
ここでは、ChunkListenerインターフェースの実装クラスとして、例外発生時にERRORログを出力する処理を実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.listener.ChunkErrorLoggingListener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.listener</span>;

<span class="keyword">import</span> <span class="include">org.slf4j.Logger</span>;
<span class="keyword">import</span> <span class="include">org.slf4j.LoggerFactory</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.ChunkListener</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.scope.context.ChunkContext</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.validator.ValidationException</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.MessageSource</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;

<span class="keyword">import</span> <span class="include">javax.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">java.util.Locale</span>;

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ChunkErrorLoggingListener</span> <span class="directive">implements</span> ChunkListener {
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(ChunkErrorLoggingListener.class);

    <span class="annotation">@Inject</span>
    MessageSource messageSource; <span class="comment">// (1)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeChunk(ChunkContext chunkContext) {
        <span class="comment">// do nothing.</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterChunk(ChunkContext chunkContext) {
        <span class="comment">// do nothing.</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterChunkError(ChunkContext chunkContext) {
        <span class="exception">Exception</span> e = (<span class="exception">Exception</span>) chunkContext.getAttribute(ChunkListener.ROLLBACK_EXCEPTION_KEY); <span class="comment">// (2)</span>
        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ValidationException) {
            logger.error(messageSource
                    .getMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">errors.maxInteger</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> { <span class="string"><span class="delimiter">&quot;</span><span class="content">Point</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">1000000</span><span class="delimiter">&quot;</span></span> }, <span class="predefined-type">Locale</span>.getDefault())); <span class="comment">// (3)</span>
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResourceBundleMessageSource</code>のインスタンスをインジェクトする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ROLLBACK_EXCEPTION_KEY</code>に設定された値をキーにして発生した例外を取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロパティファイルからメッセージIDが<code>errors.maxInteger</code>のメッセージを取得し、ログに出力する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Coding_Bean"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Coding_Bean"></a>ジョブBean定義ファイルの設定</h7>
<div class="paragraph">
<p>例外ハンドリングをChunkListenerで行うためのジョブBean定義ファイルの設定を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddTasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.tasklet,</span>
            <span class="content">com.example.batch.tutorial.common.listener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>

    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddTasklet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddTasklet.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                           <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pointAddTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:listeners&gt;</span>
                    <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkErrorLoggingListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
                <span class="tag">&lt;/batch:listeners&gt;</span>
            <span class="tag">&lt;/batch:tasklet&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャン対象とするベースパッケージの設定を行う。<br>
<code>base-package</code>属性に、<code>ChunkListener</code>の実装クラスが格納されているパッケージを追加で指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepListener</code>の実装クラスを設定する。
なお、<code>ChunkListener</code>は<code>StepListener</code>の拡張インターフェースである。<br>
ここでは、ChunkListenerの実装クラスのBeanIDである<code>chunkErrorLoggingListener</code>を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution"></a>9.4.4.3.3. ジョブの実行と結果の確認</h6>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution_Run"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution_Run"></a>実行構成からジョブを実行</h7>
<div class="paragraph">
<p>既に作成してある実行構成から、ジョブを実行する。</p>
</div>
<div class="paragraph">
<p>ここでは、異常系データを利用してジョブを実行する。<br>
入力チェックを実装したジョブが扱うリソース(データベース or ファイル)によって
入力データの切替方法が異なるため、以下のとおり実行すること。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">データベースアクセスでデータ入出力を行うジョブに対して入力チェックを実装した場合</dt>
<dd>
<p>データベースアクセスでデータ入出力を行うジョブの<a href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a>
で作成した実行構成を使ってジョブを実行する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>異常系データを利用するために、<code>batch-application.proeprties</code>のDatabase Initializeで
正常系データのスクリプトをコメントアウトし、異常系データのスクリプトのコメントアウトを解除する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/batch-application.proeprties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"># Database Initialize
tutorial.create-table.script=file:sqls/create-member-info-table.sql
#tutorial.insert-data.script=file:sqls/insert-member-info-data.sql
tutorial.insert-data.script=file:sqls/insert-member-info-error-data.sql</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ファイルアクセスでデータ入出力を行うジョブに対して入力チェックを実装した場合</dt>
<dd>
<p>ファイルアクセスでデータ入出力を行うジョブの<a href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a>
で作成した実行構成を使ってジョブを実行する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>異常系データを利用するために、実行構成で設定する引数のうち、
入力ファイル(inputFile)のパスを正常系データ(insert-member-info-data.csv)から異常系データ(insert-member-info-error-data.csv)に変更する。</p>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution_Console"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution_Console"></a>コンソールログの確認</h7>
<div class="paragraph">
<p>Console Viewを開き、以下の内容のログが出力されていることを確認する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>処理が異常終了(FAILED)していること</p>
</li>
<li>
<p><code>org.springframework.batch.item.validator.ValidationException</code>が発生していること</p>
</li>
<li>
<p><code>com.example.batch.tutorial.common.listener.ChunkErrorLoggingListener</code>が次のERRORログとして次のメッセージを出力していること</p>
<div class="ulist">
<ul>
<li>
<p>「The Point exceeds 1000000.」</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/09/12 10:22:22] [main] [o.t.b.t.c.l.ChunkErrorLoggingListener] [ERROR] The Point exceeds 1000000.
[2017/09/12 10:22:22] [main] [o.s.b.c.s.AbstractStep] [ERROR] Encountered an error executing step jobPointAddTasklet.step01 in job jobPointAddTasklet
org.springframework.batch.item.validator.ValidationException: Validation failed for com.example.batch.tutorial.common.dto.MemberInfoDto@6e4ea0bd:
Field error in object 'item' on field 'point': rejected value [1000001]; codes [Max.item.point,Max.point,Max.int,Max]; arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [item.point,point]; arguments []; default message [point],1000000]; default message [must be less than or equal to 1000000]
        at org.springframework.batch.item.validator.SpringValidator.validate(SpringValidator.java:54)

(.. omitted)

[2017/09/12 10:22:22] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddTasklet]] completed with the following parameters: [{jsr_batch_run_id=478}] and the following status: [FAILED]
[2017/09/12 10:22:22] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@735f7ae5: startup date [Tue Sep 12 10:22:20 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution_Exitcode"></a>終了コードの確認</h7>
<div class="paragraph">
<p>終了コードにより、異常終了したことを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が255(異常終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/ExceptionHandlingWithListener/Ch09_ExceptionHandlingWithListenerJob_ExitCode_TaskletModel.png" alt="Confirm the Exit Code of ExceptionHandlingWithListenerJob for TaskletModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution_Output"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution_Output"></a>出力リソースの確認</h7>
<div class="paragraph">
<p>入力チェックを実装したジョブによって出力リソース(データベース or ファイル)を確認する。</p>
</div>
<div class="paragraph">
<p>タスクレットモデルの場合、一括コミット方式をとっているため、エラーが発生した場合は一切更新されていないことを確認してほしい。</p>
</div>
<div class="sect7">
<h8 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution_Output_Table"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution_Output_Table"></a>会員情報テーブルの確認</h8>
<div class="paragraph">
<p>Data Source Explorerを使用して会員情報テーブルの確認を行う。<br>
更新前後の会員情報テーブルの内容を比較し、確認内容のとおりとなっていることを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_RefDB">Data Source Explorerを使用してデータベースを参照する</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>すべてのレコードについて、データが更新されていないこと</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>初期状態の会員情報テーブルの内容を以下に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/ExceptionHandlingWithListener/Ch09_ExceptionHandlingWithListenerJob_Initial_MemberInfoTable.png" alt="member_info table in the initial state">
</div>
<div class="title">初期状態の会員情報テーブルの内容</div>
</div>
</div>
<div class="sect7">
<h8 id="Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution_Output_File"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithListenerJob_Tasklet_Execution_Output_File"></a>会員情報ファイルの確認</h8>
<div class="paragraph">
<p>会員情報ファイルの入出力内容を比較し、確認内容のとおりとなっていることを確認する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>出力ディレクトリに会員情報ファイルが<strong>空ファイル</strong>で出力されていること</p>
<div class="ulist">
<ul>
<li>
<p>出力ファイル: files/output/output-member-info-data.csv</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob"></a>9.4.5. try-catchで例外ハンドリングを行うジョブ</h4>
<div id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Prerequisite" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">前提</div>
<div class="paragraph">
<p><a href="#Ch09_Introduction_HowToProceed">チュートリアルの進め方</a>で説明しているとおり、
<a href="#Ch09_Impl_ValidationJob">入力データの妥当性検証を行うジョブ</a>に対して、
例外ハンドリングの実装を追加していく形式とする。なお、例外ハンドリング方式にはtry-catchやChunkListenerなど様々な方式がある。<br>
ただし、記述はデータベースアクセスするジョブに実装を追加した場合の説明としているため留意すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Overview"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Overview"></a>9.4.5.1. 概要</h5>
<div class="paragraph">
<p>try-catchで例外ハンドリングを行うジョブを作成する。</p>
</div>
<div class="paragraph">
<p>なお、本節はMacchinetta Batch 2.x 開発ガイドラインを元に説明しているため、
詳細については<a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Chunk_ItemProcessor_TryCatchExample">ItemProcessor内でtry～catchする方法</a>および
<a href="#Ch06_ExceptionHandling_HowToUse_StepExceptionHandling_Tasklet">タスクレットモデルにおける例外ハンドリング</a>を参照のこと。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">終了コードの意味合いについて</div>
<div class="paragraph">
<p>本節では、終了コードは2つの意味合いで扱われており、それぞれの説明を以下に示す。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>COMPLETED、FAILEDなどの文字列の終了コードは、ジョブやステップの終了コードである。</p>
</li>
<li>
<p>0、255などの数値の終了コードは、Javaプロセスの終了コードである。</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#Ch09_TutorialApplication">作成するアプリケーションの説明</a>の
背景、処理概要、業務仕様を以下に再掲する。</p>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Overview_Background"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Overview_Background"></a>9.4.5.1.1. 背景</h6>
<div class="paragraph">
<p>とある量販店では、会員に対してポイントカードを発行している。<br>
会員には「ゴールド会員」「一般会員」の会員種別が存在し、会員種別に応じたサービスを提供している。<br>
今回そのサービスの一環として、月内に商品を購入した会員のうち、
会員種別が「ゴールド会員」の場合は100ポイント、「一般会員」の場合は10ポイントを月末に加算することにした。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Overview_ProcessOverview"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Overview_ProcessOverview"></a>9.4.5.1.2. 処理概要</h6>
<div class="paragraph">
<p>会員種別に応じてポイント加算を行うアプリケーションを
月次バッチ処理としてMacchinetta Batch 2.xを使用して実装する。<br>
入力データにポイントの上限値を超えるデータが存在するか妥当性検証を行う処理を追加実装し、
エラーの場合は警告メッセージを出力し、スキップして処理を継続する。その際にスキップしたことを示す終了コードを出力する。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Overview_BusinessSpecification"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Overview_BusinessSpecification"></a>9.4.5.1.3. 業務仕様</h6>
<div class="paragraph">
<p>業務仕様は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>入力データのポイントが1,000,000ポイントを超過していないことをチェックする</p>
<div class="ulist">
<ul>
<li>
<p>チェックエラーとなる場合は、警告メッセージをログに出力し、対象レコードはスキップして処理を継続する</p>
</li>
<li>
<p>スキップした場合は、スキップしたことを示すために終了コードを"200"(SKIPPED)に変換する</p>
</li>
</ul>
</div>
</li>
<li>
<p>商品購入フラグが"1"(処理対象)の場合に、会員種別に応じてポイントを加算する</p>
<div class="ulist">
<ul>
<li>
<p>会員種別が"G"(ゴールド会員)の場合は100ポイント、"N"(一般会員)の場合は10ポイント加算する</p>
</li>
</ul>
</div>
</li>
<li>
<p>商品購入フラグはポイント加算後に"0"(初期状態)に更新する</p>
</li>
<li>
<p>ポイントの上限値は1,000,000ポイントとする</p>
</li>
<li>
<p>ポイント加算後に1,000,000ポイントを超えた場合は、1,000,000ポイントに補正する</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Overview_TableSpecification"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Overview_TableSpecification"></a>9.4.5.1.4. テーブル仕様</h6>
<div class="paragraph">
<p>入出力リソースとなる会員情報テーブルの仕様は以下のとおり。<br>
<a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Prerequisite">前提</a>のとおりデータベースアクセスするジョブの場合の説明となるため、ファイルアクセスするジョブの場合の
入出力のリソース仕様は<a href="#Ch09_Impl_FileAccessJob_Overview_FileSpecification">ファイル仕様</a>を参照する。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">会員情報テーブル(member_info)</caption>
<colgroup>
<col style="width: 3.0927%;">
<col style="width: 15.4639%;">
<col style="width: 10.3092%;">
<col style="width: 4.1237%;">
<col style="width: 12.3711%;">
<col style="width: 8.2474%;">
<col style="width: 46.392%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">属性名</th>
<th class="tableblock halign-left valign-top">カラム名</th>
<th class="tableblock halign-left valign-top">PK</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">桁数</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員を一意に示す8桁固定の番号を表す。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の種別を以下のとおり表す。<br>
"G"(ゴールド会員)、"N"(一般会員)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">月内に商品を買ったかどうかを表す。<br>
商品購入で"1"(処理対象)、月次バッチ処理で"0"(初期状態)に更新される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイント</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">point</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の保有するポイントを表す。<br>
初期値は0。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Overview_JobOverview"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Overview_JobOverview"></a>9.4.5.1.5. ジョブの概要</h6>
<div class="paragraph">
<p>ここで作成する入力チェックを行うジョブの概要を把握するために、
処理フローおよび処理シーケンスを以下に示す。</p>
</div>
<div class="paragraph">
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Prerequisite">前提</a>のとおりデータベースアクセスするジョブの場合の説明となるため、
ファイルアクセスするジョブの場合の処理フローおよび処理シーケンスとは異なる部分があるため留意する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">処理フロー概要</dt>
<dd>
<p>処理フローの概要を以下に示す。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/ExceptionHandlingWithTryCatch/Ch09_ExceptionHandlingWithTryCatchJob_ProcessFlow.png" alt="ProcessFlow of ExceptionHandlingWithTryCatch Job">
</div>
<div class="title">例外ハンドリングを行うジョブの処理フロー</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンクモデルの場合の処理シーケンス</dt>
<dd>
<p>チャンクモデルの場合の処理シーケンスを説明する。<br>
本ジョブは異常系データを利用することを前提として説明しているため、
このシーケンス図は入力チェックでエラー(警告終了)となった場合を示している。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_ExceptionHandlingWithTryCatchJob_ProcessSequence_ChunkModel.png" alt="ProcessSequence of ExceptionHandlingWithTryCatch Job by ChunkModel">
</div>
<div class="title">チャンクモデルのシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
</li>
<li>
<p>ステップは、リソースをオープンする。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから会員情報をすべて取得(select文の発行)する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで、以降の処理を繰り返す。</p>
</li>
<li>
<p>チャンク単位で、フレームワークトランザクションを開始する。</p>
</li>
<li>
<p>チャンクサイズに達するまで4から12までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは、<code>MyBatisCursorItemReader</code>から入力データを1件取得する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから入力データを1件取得する。</p>
</li>
<li>
<p>member_infoテーブルは、<code>MyBatisCursorItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、ステップに入力データを返却する。</p>
</li>
<li>
<p>ステップは、<code>PointAddItemProcessor</code>で入力データに対して処理を行う。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、<code>SpringValidator</code>に入力チェック処理を依頼する。</p>
</li>
<li>
<p><code>SpringValidator</code>は、入力チェックルールに基づき入力チェックを行い、チェックエラーの場合は例外(ValidationException)をスローする。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、入力データを読み込んでポイント加算処理を行う。例外(ValidationException)をキャッチした場合はnullを返却してエラーレコードをスキップする。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、ステップに処理結果を返却する。</p>
</li>
<li>
<p>ステップは、チャンクサイズ分のデータを<code>MyBatisBatchItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>MyBatisBatchItemWriter</code>は、member_infoテーブルに対して会員情報の更新(update文の発行)を行う。</p>
</li>
<li>
<p>ステップはフレームワークトランザクションをコミットする。</p>
</li>
<li>
<p>ステップは<code>ExitStatusChangeListener</code>を実行する。</p>
</li>
<li>
<p><code>ExitStatusChangeListener</code>は、入力データと出力データの件数が異なる場合に<code>StepExecution</code>に独自の終了コードとして<code>SKIPPED</code>を設定する。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは正常終了:0)を返却する。</p>
</li>
<li>
<p>ジョブは<code>JobExitCodeChangeListener</code>を実行する。</p>
</li>
<li>
<p><code>JobExitCodeChangeListener</code>は<code>StepExecution</code>から終了コードを取得する。</p>
</li>
<li>
<p><code>StepExecution</code>は<code>JobExitCodeChangeListener</code>に終了コードを返却する。</p>
</li>
<li>
<p><code>JobExitCodeChangeListener</code>は最終的なジョブの終了コードとして、ジョブに<code>SKIPPED</code>(ここでは警告終了:200)を返却する。</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">タスクレットモデルの場合の処理シーケンス</dt>
<dd>
<p>タスクレットモデルの場合の処理シーケンスについて説明する。<br>
本ジョブは異常系データを利用することを前提として説明しているため、
このシーケンス図は入力チェックでエラー(警告終了)となった場合を示している。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_ExceptionHandlingWithTryCatchJob_ProcessSequence_TaskletModel.png" alt="ProcessSequence of ExceptionHandlingWithTryCatch Job by TaskletModel">
</div>
<div class="title">タスクレットモデルの処理シーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
<div class="ulist">
<ul>
<li>
<p>ステップはフレームワークトランザクションを開始する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは<code>PointAddTasklet</code>を実行する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、リソースをオープンする。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから会員情報をすべて取得(select文の発行)する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで5から13までの処理を繰り返す。</p>
</li>
<li>
<p>一定件数に達するまで5から11までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>PointAddTasklet</code>は、<code>MyBatisCursorItemReader</code>から入力データを1件取得する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから入力データを1件取得する。</p>
</li>
<li>
<p>member_infoテーブルは、<code>MyBatisCursorItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、タスクレットに入力データを返却する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、<code>SpringValidator</code>に入力チェック処理を依頼する。</p>
</li>
<li>
<p><code>SpringValidator</code>は、入力チェックルールに基づき入力チェックを行い、チェックエラーの場合は例外(ValidationException)をスローする。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、入力データを読み込んでポイント加算処理を行う。例外(ValidationException)をキャッチした場合はcontinueで処理を継続してエラーレコードをスキップする。</p>
<div class="ulist">
<ul>
<li>
<p>スキップした場合、以降の処理はせず5から処理を行う。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>PointAddTasklet</code>は、一定件数分のデータを<code>MyBatisBatchItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>MyBatisBatchItemWriter</code>は、member_infoテーブルに対して会員情報の更新(update文の発行)を行う。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、<code>StepExecution</code>に独自の終了コードとして<code>SKIPPED</code>を設定する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>はステップへ処理終了を返却する。</p>
</li>
<li>
<p>ステップはフレームワークトランザクションをコミットする。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは正常終了:0)を返却する。</p>
</li>
<li>
<p>ステップは<code>JobExitCodeChangeListener</code>を実行する。</p>
</li>
<li>
<p><code>JobExitCodeChangeListener</code>は<code>StepExecution</code>から終了コードを取得する。</p>
</li>
<li>
<p><code>StepExecution</code>は<code>JobExitCodeChangeListener</code>に終了コードを返却する。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは警告終了:200)を返却する。</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">処理モデルによるスキップ実装について</div>
<div class="paragraph">
<p>チャンクモデルとタスクレットモデルではスキップ処理の実装方法が異なる。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンクモデル</dt>
<dd>
<p>ItemProcessor内でtry-catchを実装し、catchブロック内でnullを返却することでエラーデータをスキップする。
ItemReader、ItemWriterでのスキップは<a href="#Ch06_ExceptionHandling_HowToUse_ContinuationPropriety_Skip">スキップ</a>を参照のこと。</p>
</dd>
<dt class="hdlist1">タスクレットモデル</dt>
<dd>
<p>ビジネスロジック内でtry-catchを実装し、catchブロック内でcontinueにより処理を継続することでエラーデータをスキップする。</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以降で、チャンクモデル、タスクレットモデルそれぞれの実装方法を説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk">チャンクモデルでの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet">タスクレットモデルでの実装</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk"></a>9.4.5.2. チャンクモデルでの実装</h5>
<div class="paragraph">
<p>チャンクモデルで入力チェックを行うジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_MessageDefinition">メッセージ定義の追加</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode">終了コードのカスタマイズ</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Coding">例外ハンドリングの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_MessageDefinition"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_MessageDefinition"></a>9.4.5.2.1. メッセージ定義の追加</h6>
<div class="paragraph">
<p>コード体系のばらつき防止や、監視対象のキーワードとしての抽出を設計しやすくするため、
ログメッセージはメッセージ定義を使用し、ログ出力時に使用する。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="paragraph">
<p><code>application-messages.properties</code>および<code>launch-context.xml</code>を以下のとおり設定する。<br>
<code>launch-context.xml</code>はMacchinetta Batch 2.xでは設定済みである。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/i18n/application-messages.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"># (1)
errors.maxInteger=The {0} exceeds {1}.</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/spring/launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">messageSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.context.support.ResourceBundleMessageSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:basenames</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">i18n/application-messages</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイント上限超過時に出力するメッセージを設定する。<br>
{0)に項目名、{1}に上限値を割り当てる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロパティファイルからメッセージを使用するために、<code>MessageSource</code>を設定する。<br>
<code>basenames</code>に、プロパティファイルの格納場所を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode"></a>9.4.5.2.2. 終了コードのカスタマイズ</h6>
<div class="paragraph">
<p>ジョブ終了時のjavaプロセスの終了コードをカスタマイズする。<br>
詳細は<a href="#Ch07_JobManagement_HowToUse_ExitCode">終了コードのカスタマイズ</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode_StepExecutionListener">StepExecutionListenerの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode_JobExecutionListener">JobExecutionListenerの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode_Context">終了コードのマッピング定義</a></p>
</li>
</ol>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode_StepExecutionListener"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode_StepExecutionListener"></a>StepExecutionListenerの実装</h7>
<div class="paragraph">
<p><code>StepExecutionListener</code>インターフェースを利用してステップの終了コードを条件により変更する。<br>
ここでは、<code>StepExecutionListener</code>インターフェースの実装クラスとして、
入力データと出力データの件数が異なる場合に終了コードを<code>SKIPPED</code>に変更する処理を実装する。</p>
</div>
<div class="paragraph">
<p>なお、このクラスはタスクレットモデルでは作成する必要がない。
タスクレットモデルではTaskletの実装クラス内で<code>StepExecution</code>クラスに独自の終了コードを設定することができるためである。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.listener.ExitStatusChangeListener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.listener</span>;

<span class="keyword">import</span> <span class="include">org.springframework.batch.core.ExitStatus</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.StepExecution</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.StepExecutionListener</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ExitStatusChangeListener</span> <span class="directive">implements</span> StepExecutionListener {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="comment">// do nothing.</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ExitStatus afterStep(StepExecution stepExecution) {
        ExitStatus exitStatus = stepExecution.getExitStatus();
        <span class="keyword">if</span> (conditionalCheck(stepExecution)) {
            exitStatus = <span class="keyword">new</span> ExitStatus(<span class="string"><span class="delimiter">&quot;</span><span class="content">SKIPPED</span><span class="delimiter">&quot;</span></span>); <span class="comment">// (1)</span>
        }
        <span class="keyword">return</span> exitStatus;
    }

    <span class="directive">private</span> <span class="type">boolean</span> conditionalCheck(StepExecution stepExecution) {
        <span class="keyword">return</span> (stepExecution.getWriteCount() != stepExecution.getReadCount()); <span class="comment">// (2)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの実行結果に応じて独自の終了コードを設定する。<br>
ここでは、スキップした場合に終了コードとして<code>SKIPPED</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">スキップしたことを判定するため、入力データと出力データの件数の比較を行う。<br>
スキップした場合、入力データと出力データの件数が異なるため、件数の差を利用してスキップの判定を行っている。
ここで件数に差があった場合に(1)が実行される。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode_JobExecutionListener"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode_JobExecutionListener"></a>JobExecutionListenerの実装</h7>
<div class="paragraph">
<p><code>JobExecutionListener</code>インターフェースを利用してジョブの終了コードを条件により変更する。<br>
ここでは、<code>JobExecutionListener</code>インターフェースの実装クラスとして、
最終的なジョブの終了コードを各ステップの終了コードに合わせて変更する処理を実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.listener.JobExitCodeChangeListener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.listener</span>;

<span class="keyword">import</span> <span class="include">org.springframework.batch.core.ExitStatus</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.JobExecution</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.JobExecutionListener</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.StepExecution</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;

<span class="keyword">import</span> <span class="include">java.util.Collection</span>;

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobExitCodeChangeListener</span> <span class="directive">implements</span> JobExecutionListener {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="comment">// do nothing.</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterJob(JobExecution jobExecution) {
        <span class="predefined-type">Collection</span>&lt;StepExecution&gt; stepExecutions = jobExecution.getStepExecutions();
        <span class="keyword">for</span> (StepExecution stepExecution : stepExecutions) { <span class="comment">// (1)</span>
            <span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">SKIPPED</span><span class="delimiter">&quot;</span></span>.equals(stepExecution.getExitStatus().getExitCode())) {
                jobExecution.setExitStatus(<span class="keyword">new</span> ExitStatus(<span class="string"><span class="delimiter">&quot;</span><span class="content">SKIPPED</span><span class="delimiter">&quot;</span></span>));
                <span class="keyword">break</span>;
            }
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの実行結果に応じて、最終的なジョブの終了コードを<code>JobExecution</code>に設定する。<br>
ここではステップから返却された終了コードのいずれかに<code>SKIPPED</code>が含まれている場合、
終了コードを<code>SKIPPED</code>としている。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode_Bean"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode_Bean"></a>ジョブBean定義ファイルの設定</h7>
<div class="paragraph">
<p>作成したリスナーを利用するためのジョブBean定義ファイルの設定を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.chunk,</span>
            <span class="content">com.example.batch.tutorial.common.listener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>

    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddChunk</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddChunk.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pointAddItemProcessor</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:tasklet&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitStatusChangeListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
        <span class="tag">&lt;batch:listeners&gt;</span>
            <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExitCodeChangeListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;/batch:listeners&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャン対象とするベースパッケージの設定を行う。<br>
<code>base-package</code>属性に、<code>StepExecutionListener</code>および<code>JobExecutionListener</code>の実装クラスが格納されているパッケージを追加で指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecutionListener</code>の実装クラスを設定する。
なお、<code>StepExecutionListener</code>は<code>StepListener</code>の拡張インターフェースである。<br>
ここでは、<code>StepExecutionListener</code>の実装クラスのBeanIDである<code>exitStatusChangeListener</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecutionListener</code>の実装クラスを設定する。<br>
ここでは、<code>JobExecutionListener</code>の実装クラスのBeanIDである<code>jobExitCodeChangeListener</code>を指定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">ExitStatusChangeListenerとJobExitCodeChangeListenerの設定箇所の違いについて</div>
<div class="paragraph">
<p><code>ExitStatusChangeListener</code>はステップの実行前後に処理を割り込める<code>StepListener</code>に属するため、<code>&lt;batch:tasklet&gt;</code>タグ内に<code>&lt;batch:listeners&gt;</code>.<code>&lt;batch:listener&gt;</code>タグによって設定する。<br>
<code>JobExitCodeChangeListener</code>はジョブの実行前後に処理を割り込める<code>JobListener</code>に属するため、<code>&lt;batch:job&gt;</code>タグ内に<code>&lt;batch:listeners&gt;</code>.<code>&lt;batch:listener&gt;</code>タグによって設定する。</p>
</div>
<div class="paragraph">
<p>詳細は<a href="#Ch04_Listener_HowToUse_Configuration">リスナーの設定</a>を参照のこと。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode_Context"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_ExitCode_Context"></a>終了コードのマッピング定義</h7>
<div class="paragraph">
<p>終了コードのマッピングを追加で設定する。</p>
</div>
<div class="paragraph">
<p><code>launch-context.xml</code>に以下のとおり、独自の終了コードを追加する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/spring/launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitCodeMapper</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.launch.support.SimpleJvmExitCodeMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mapping</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;util:map</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitCodeMapper</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">key-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.String</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">value-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- ExitStatus --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NOOP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STOPPED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">255</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">255</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UNKNOWN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">255</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SKIPPED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;/util:map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">独自の終了コードを追加する。<br>
マッピングするためのキーに<code>SKIPPED</code>、コード値として<code>200</code>を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Coding"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Coding"></a>9.4.5.2.3. 例外ハンドリングの実装</h6>
<div class="paragraph">
<p>ポイント加算処理を行うビジネスロジッククラスにtry-catch処理を実装する。<br>
既に実装してある<code>PointAddItemProcessor</code>クラスにtry-catch処理の実装を追加する。</p>
</div>
<div class="paragraph">
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Prerequisite">前提</a>のとおりデータベースアクセスするジョブの場合の説明となるため、
ファイルアクセスするジョブの場合の実装は以下の(1)～(5)のみ追加する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.dbaccess.chunk.PointAddItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Package and the other import are omitted.</span>

<span class="keyword">import</span> <span class="include">org.slf4j.Logger</span>;
<span class="keyword">import</span> <span class="include">org.slf4j.LoggerFactory</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.validator.ValidationException</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.MessageSource</span>;

<span class="keyword">import</span> <span class="include">java.util.Locale</span>;

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PointAddItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;MemberInfoDto, MemberInfoDto&gt; {
    <span class="comment">// Definition of constans are omitted.</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(PointAddItemProcessor.class); <span class="comment">// (1)</span>

    <span class="annotation">@Inject</span>
    <span class="predefined-type">Validator</span>&lt;MemberInfoDto&gt; validator;

    <span class="annotation">@Inject</span>
    MessageSource messageSource; <span class="comment">// (2)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> MemberInfoDto process(MemberInfoDto item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">try</span> { <span class="comment">// (3)</span>
            validator.validate(item);
        } <span class="keyword">catch</span> (ValidationException e) {
            logger.warn(messageSource
                    .getMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">errors.maxInteger</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> { <span class="string"><span class="delimiter">&quot;</span><span class="content">point</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">1000000</span><span class="delimiter">&quot;</span></span> }, <span class="predefined-type">Locale</span>.getDefault())); <span class="comment">// (4)</span>
            <span class="keyword">return</span> <span class="predefined-constant">null</span>; <span class="comment">// (5)</span>
        }

        <span class="comment">// The other codes of bussiness logic are omitted.</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ログを出力するために<code>LoggerFactory</code>のインスタンスを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MessageSource</code>のインスタンスをインジェクトする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外ハンドリングを実装する。<br>
入力チェック処理をtry-catchで囲み、<code>ValidationException</code>をハンドリングする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロパティファイルからメッセージIDが<code>errors.maxInteger</code>のメッセージを取得し、ログに出力している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">エラーレコードをスキップするためにnullを返却する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution"></a>9.4.5.2.4. ジョブの実行と結果の確認</h6>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution_Run"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution_Run"></a>実行構成からジョブを実行</h7>
<div class="paragraph">
<p>既に作成してある実行構成からジョブを実行し、結果を確認する。</p>
</div>
<div class="paragraph">
<p>ここでは、異常系データを利用してジョブを実行する。<br>
例外ハンドリングを実装したジョブが扱うリソース(データベース or ファイル)によって、
入力データの切替方法が異なるため、以下のとおり実行すること。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">データベースアクセスでデータ入出力を行うジョブに対して例外ハンドリングを実装した場合</dt>
<dd>
<p>データベースアクセスでデータ入出力を行うジョブの<a href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a>
で作成した実行構成を使ってジョブを実行する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>異常系データを利用するために、<code>batch-application.proeprties</code>のDatabase Initializeで
正常系データのスクリプトをコメントアウトし、異常系データのスクリプトのコメントアウトを解除する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/batch-application.proeprties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"># Database Initialize
tutorial.create-table.script=file:sqls/create-member-info-table.sql
#tutorial.insert-data.script=file:sqls/insert-member-info-data.sql
tutorial.insert-data.script=file:sqls/insert-member-info-error-data.sql</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ファイルアクセスでデータ入出力を行うジョブに対して例外ハンドリングを実装した場合</dt>
<dd>
<p>ファイルアクセスでデータ入出力を行うジョブの<a href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a>
で作成した実行構成を使ってジョブを実行する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>異常系データを利用するために、実行構成で設定する引数のうち、
入力ファイル(inputFile)のパスを正常系データ(insert-member-info-data.csv)から異常系データ(insert-member-info-error-data.csv)に変更する。</p>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution_Console"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution_Console"></a>コンソールログの確認</h7>
<div class="paragraph">
<p>Console Viewを開き、以下の内容のログが出力されていることを確認する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>例外が発生していないこと</p>
</li>
<li>
<p>WARNログとして次のメッセージを出力していること</p>
<div class="ulist">
<ul>
<li>
<p>「The Point exceeds 1000000.」</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/09/05 18:27:01] [main] [o.t.b.t.e.c.PointAddItemProcessor] [WARN ] The point exceeds 1000000.
[2017/09/05 18:27:01] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddChunk]] completed with the following parameters: [{jsr_batch_run_id=450}] and the following status: [COMPLETED]
[2017/09/05 18:27:01] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@2145433b: startup date [Tue Sep 05 18:26:57 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution_Exitcode"></a>終了コードの確認</h7>
<div class="paragraph">
<p>終了コードにより、警告終了したことを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が200(警告終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/ExceptionHandlingWithTryCatch/Ch09_ExceptionHandlingWithTryCatchJob_Confirm_ExitCode_ChunkModel.png" alt="Confirm the Exit Code of ExceptionHandlingWithTryCatchJob for ChunkModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution_Output"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution_Output"></a>出力リソースの確認</h7>
<div class="paragraph">
<p>例外ハンドリングを実装したジョブによって出力リソース(データベース or ファイル)を確認する。</p>
</div>
<div class="paragraph">
<p>スキップを実装しているため、エラーレコード以外の更新対象レコードについては
正常に更新されていることを確認する。</p>
</div>
<div class="sect7">
<h8 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution_Output_Table"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution_Output_Table"></a>会員情報テーブルの確認</h8>
<div class="paragraph">
<p>Data Source Explorerを使用して会員情報テーブルの確認を行う。<br>
更新前後の会員情報テーブルの内容を比較し、確認内容のとおりとなっていることを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_RefDB">Data Source Explorerを使用してデータベースを参照する</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>エラーレコード(会員番号が"000000013")を除くすべてのレコードについて</p>
<div class="ulist">
<ul>
<li>
<p>statusカラム</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointカラム</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeカラムが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeカラムが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>エラーレコード(会員番号が"000000013")について</p>
<div class="ulist">
<ul>
<li>
<p>更新されていないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容は以下のとおり。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/ExceptionHandlingWithTryCatch/Ch09_ExceptionHandlingWithTryCatchJob_Result_MemberInfoTable.png" alt="Table of member_info">
</div>
<div class="title">更新前後の会員情報テーブルの内容</div>
</div>
</div>
<div class="sect7">
<h8 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution_Output_File"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Chunk_Execution_Output_File"></a>会員情報ファイルの確認</h8>
<div class="paragraph">
<p>会員情報ファイルの入出力内容を比較し、確認内容のとおりとなっていることを確認する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>出力ディレクトリに会員情報ファイルが出力されていること</p>
<div class="ulist">
<ul>
<li>
<p>出力ファイル: files/output/output-member-info-data.csv</p>
</li>
</ul>
</div>
</li>
<li>
<p>エラーレコード(会員番号が"00000013")を除くすべてのレコードについて</p>
<div class="ulist">
<ul>
<li>
<p>statusカラム</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointカラム</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeカラムが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeカラムが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>エラーレコード(会員番号が"00000013")が出力されていないこと</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>会員情報ファイルの入出力内容は以下のとおり。<br>
ファイルのフィールドはid(会員番号)、type(会員種別)、status(商品購入フラグ)、point(ポイント)の順で出力される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/ExceptionHandlingWithTryCatch/Ch09_ExceptionHandlingWithTryCatchJob_Result_MemberInfoFile.png" alt="File of member_info">
</div>
<div class="title">会員情報ファイルの入出力内容</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet"></a>9.4.5.3. タスクレットモデルでの実装</h5>
<div class="paragraph">
<p>タスクレットモデルで入力チェックを行うジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_MessageDefinition">メッセージ定義の追加</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_ExitCode">終了コードのカスタマイズ</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Coding">例外ハンドリングの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_MessageDefinition"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_MessageDefinition"></a>9.4.5.3.1. メッセージ定義の追加</h6>
<div class="paragraph">
<p>コード体系のばらつき防止や、監視対象のキーワードとしての抽出を設計しやすくするため、
ログメッセージはメッセージ定義を使用し、ログ出力時に使用する。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="paragraph">
<p><code>application-messages.properties</code>および<code>launch-context.xml</code>を以下のとおり設定する。<br>
<code>launch-context.xml</code>はMacchinetta Batch 2.xでは設定済みである。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/i18n/application-messages.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"># (1)
errors.maxInteger=The {0} exceeds {1}.</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/spring/launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">messageSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.context.support.ResourceBundleMessageSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:basenames</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">i18n/application-messages</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイント上限超過時に出力するメッセージを設定する。<br>
{0)に項目名、{1}に上限値を割り当てる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロパティファイルからメッセージを使用するために、<code>MessageSource</code>を設定する。<br>
<code>basenames</code>に、プロパティファイルの格納場所を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_ExitCode"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_ExitCode"></a>9.4.5.3.2. 終了コードのカスタマイズ</h6>
<div class="paragraph">
<p>ジョブ終了時のjavaプロセスの終了コードをカスタマイズする。<br>
詳細は<a href="#Ch07_JobManagement_HowToUse_ExitCode">終了コードのカスタマイズ</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_ExitCode_JobExecutionListener">JobExecutionListenerの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_ExitCode_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_ExitCode_Context">終了コードのマッピング定義</a></p>
</li>
</ol>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_ExitCode_JobExecutionListener"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_ExitCode_JobExecutionListener"></a>JobExecutionListenerの実装</h7>
<div class="paragraph">
<p><code>JobExecutionListener</code>インターフェースを利用してジョブの終了コードを条件により変更する。<br>
ここでは、<code>JobExecutionListener</code>インターフェースの実装クラスとして、
最終的なジョブの終了コードを各ステップの終了コードに合わせて変更する処理を実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.listener.JobExitCodeChangeListener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.listener</span>;

<span class="keyword">import</span> <span class="include">org.springframework.batch.core.ExitStatus</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.JobExecution</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.JobExecutionListener</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.StepExecution</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;

<span class="keyword">import</span> <span class="include">java.util.Collection</span>;

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobExitCodeChangeListener</span> <span class="directive">implements</span> JobExecutionListener {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="comment">// do nothing.</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterJob(JobExecution jobExecution) {
        <span class="predefined-type">Collection</span>&lt;StepExecution&gt; stepExecutions = jobExecution.getStepExecutions();
        <span class="keyword">for</span> (StepExecution stepExecution : stepExecutions) { <span class="comment">// (1)</span>
            <span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">SKIPPED</span><span class="delimiter">&quot;</span></span>.equals(stepExecution.getExitStatus().getExitCode())) {
                jobExecution.setExitStatus(<span class="keyword">new</span> ExitStatus(<span class="string"><span class="delimiter">&quot;</span><span class="content">SKIPPED</span><span class="delimiter">&quot;</span></span>));
                <span class="keyword">break</span>;
            }
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの実行結果に応じて、最終的なジョブの終了コードを<code>JobExecution</code>に設定する。<br>
ここではステップから返却された終了コードのいずれかに<code>SKIPPED</code>が含まれている場合、
終了コードを<code>SKIPPED</code>としている。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_ExitCode_Bean"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_ExitCode_Bean"></a>ジョブBean定義ファイルの設定</h7>
<div class="paragraph">
<p>作成したリスナーを利用するためのジョブBean定義ファイルの設定を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddTasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.tasklet,</span>
            <span class="content">com.example.batch.tutorial.common.listener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>

    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddTasklet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddTasklet.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                           <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pointAddTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
        <span class="tag">&lt;batch:listeners&gt;</span>
            <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExitCodeChangeListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;/batch:listeners&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャン対象とするベースパッケージの設定を行う。<br>
<code>base-package</code>属性に、<code>StepExecutionListener</code>および<code>JobExecutionListener</code>の実装クラスが格納されているパッケージを追加で指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecutionListener</code>の実装クラスを設定する。
なお、<code>JobExecutionListener</code>は<code>JobListener</code>の拡張インターフェースである。<br>
ここでは、<code>JobExecutionListener</code>の実装クラスのBeanIDである<code>jobExitCodeChangeListener</code>を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_ExitCode_Context"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_ExitCode_Context"></a>終了コードのマッピング定義</h7>
<div class="paragraph">
<p>終了コードのマッピングを追加で設定する。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に実施している場合は読み飛ばしてよい。</p>
</div>
<div class="paragraph">
<p><code>launch-context.xml</code>に以下のとおり、独自の終了コードを追加する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/spring/launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitCodeMapper</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.launch.support.SimpleJvmExitCodeMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mapping</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;util:map</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitCodeMapper</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">key-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.String</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">value-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- ExitStatus --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NOOP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STOPPED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">255</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">255</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UNKNOWN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">255</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SKIPPED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;/util:map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">独自の終了コードを追加する。<br>
マッピングするためのキーに<code>SKIPPED</code>、コード値として<code>200</code>を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Coding"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Coding"></a>9.4.5.3.3. 例外ハンドリングの実装</h6>
<div class="paragraph">
<p>ポイント加算処理を行うビジネスロジッククラスにtry-catch処理を実装する。<br>
既に実装してある<code>PointAddItemProcessor</code>クラスにtry-catch処理の実装を追加する。</p>
</div>
<div class="paragraph">
<p><a href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Prerequisite">前提</a>のとおりデータベースアクセスするジョブの場合の説明となるため、
ファイルアクセスするジョブの場合の実装は以下の(1)～(5)のみ追加する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.dbaccess.tasklet.PointAddTasklet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Package and the other import are omitted.</span>

<span class="keyword">import</span> <span class="include">org.slf4j.Logger</span>;
<span class="keyword">import</span> <span class="include">org.slf4j.LoggerFactory</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.ExitStatus</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.validator.ValidationException</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.MessageSource</span>;

<span class="keyword">import</span> <span class="include">java.util.Locale</span>;

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PointAddTasklet</span> <span class="directive">implements</span> Tasklet {
    <span class="comment">// Definition of constans, ItemStreamReader and ItemWriter are omitted.</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(PointAddTasklet.class); <span class="comment">// (1)</span>

    <span class="annotation">@Inject</span>
    <span class="predefined-type">Validator</span>&lt;MemberInfoDto&gt; validator;

    <span class="annotation">@Inject</span>
    MessageSource messageSource; <span class="comment">// (2)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {
        MemberInfoDto item = <span class="predefined-constant">null</span>;

        <span class="predefined-type">List</span>&lt;MemberInfoDto&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(CHUNK_SIZE);
        <span class="type">int</span> errorCount = <span class="integer">0</span>; <span class="comment">// (3)</span>

        <span class="keyword">try</span> {
            reader.open(chunkContext.getStepContext().getStepExecution().getExecutionContext());
            <span class="keyword">while</span> ((item = reader.read()) != <span class="predefined-constant">null</span>) {
                <span class="keyword">try</span> { <span class="comment">// (4)</span>
                    validator.validate(item);
                } <span class="keyword">catch</span> (ValidationException e) {
                    logger.warn(messageSource
                            .getMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">errors.maxInteger</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> { <span class="string"><span class="delimiter">&quot;</span><span class="content">point</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">1000000</span><span class="delimiter">&quot;</span></span> }, <span class="predefined-type">Locale</span>.getDefault()));  <span class="comment">// (5)</span>
                    errorCount++;
                    <span class="keyword">continue</span>; <span class="comment">// (6)</span>
                }

                <span class="comment">// The other codes of bussiness logic are omitted.</span>
            }

            writer.write(items);
        } <span class="keyword">finally</span> {
            reader.close();
        }
        <span class="keyword">if</span> (errorCount &gt; <span class="integer">0</span>) {
            contribution.setExitStatus(<span class="keyword">new</span> ExitStatus(<span class="string"><span class="delimiter">&quot;</span><span class="content">SKIPPED</span><span class="delimiter">&quot;</span></span>)); <span class="comment">// (7)</span>
        }
        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ログを出力するために<code>LoggerFactory</code>のインスタンスを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MessageSource</code>のインスタンスをインジェクトする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外の発生を判定するためのカウンターを用意する。<br>
<code>ValidationException</code>をキャッチした際にインクリメントする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例外ハンドリングを実装する。<br>
入力チェック処理をtry-catchで囲み、<code>ValidationException</code>をハンドリングする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロパティファイルからメッセージIDが<code>errors.maxInteger</code>のメッセージを取得し、ログに出力している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">エラーレコードをスキップするためにcontinueで処理を継続する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">独自の終了コードとして<code>SKIPPED</code>を設定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution"></a>9.4.5.3.4. ジョブの実行と結果の確認</h6>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution_Run"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution_Run"></a>実行構成からジョブを実行</h7>
<div class="paragraph">
<p>既に作成してある実行構成からジョブを実行し、結果を確認する。</p>
</div>
<div class="paragraph">
<p>ここでは、異常系データを利用してジョブを実行する。<br>
例外ハンドリングを実装したジョブが扱うリソース(データベース or ファイル)によって、
入力データの切替方法が異なるため、以下のとおり実行すること。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">データベースアクセスでデータ入出力を行うジョブに対して例外ハンドリングを実装した場合</dt>
<dd>
<p>データベースアクセスでデータ入出力を行うジョブの<a href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a>
で作成した実行構成を使ってジョブを実行する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>異常系データを利用するために、<code>batch-application.proeprties</code>のDatabase Initializeで
正常系データのスクリプトをコメントアウトし、異常系データのスクリプトのコメントアウトを解除する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/batch-application.proeprties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"># Database Initialize
tutorial.create-table.script=file:sqls/create-member-info-table.sql
#tutorial.insert-data.script=file:sqls/insert-member-info-data.sql
tutorial.insert-data.script=file:sqls/insert-member-info-error-data.sql</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ファイルアクセスでデータ入出力を行うジョブに対して例外ハンドリングを実装した場合</dt>
<dd>
<p>ファイルアクセスでデータ入出力を行うジョブの<a href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a>
で作成した実行構成を使ってジョブを実行する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>異常系データを利用するために、実行構成で設定する引数のうち、
入力ファイル(inputFile)のパスを正常系データ(insert-member-info-data.csv)から異常系データ(insert-member-info-error-data.csv)に変更する。</p>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution_Console"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution_Console"></a>コンソールログの確認</h7>
<div class="paragraph">
<p>Console Viewを開き、以下の内容のログが出力されていることを確認する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>例外が発生していないこと</p>
</li>
<li>
<p>WARNログとして次のメッセージを出力していること</p>
<div class="ulist">
<ul>
<li>
<p>「The Point exceeds 1000000.」</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/09/11 15:36:29] [main] [o.t.b.t.e.t.PointAddTasklet] [WARN ] The point exceeds 1000000.
[2017/09/11 15:36:29] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddTasklet]] completed with the following parameters: [{jsr_batch_run_id=468}] and the following status: [COMPLETED]
[2017/09/11 15:36:29] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@735f7ae5: startup date [Mon Sep 11 15:36:27 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution_Exitcode"></a>終了コードの確認</h7>
<div class="paragraph">
<p>終了コードにより、警告終了したことを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が200(警告終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/ExceptionHandlingWithTryCatch/Ch09_ExceptionHandlingWithTryCatchJob_Confirm_ExitCode_TaskletModel.png" alt="Confirm the Exit Code of ExceptionHandlingWithTryCatchJob for TaskletModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution_Output"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution_Output"></a>出力リソースの確認</h7>
<div class="paragraph">
<p>例外ハンドリングを実装したジョブによって出力リソース(データベース or ファイル)を確認する。</p>
</div>
<div class="paragraph">
<p>スキップを実装しているため、エラーレコード以外の更新対象レコードについては
正常に更新されていることを確認する。</p>
</div>
<div class="sect7">
<h8 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution_Output_Table"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution_Output_Table"></a>会員情報テーブルの確認</h8>
<div class="paragraph">
<p>Data Source Explorerを使用して会員情報テーブルの確認を行う。<br>
更新前後の会員情報テーブルの内容を比較し、確認内容のとおりとなっていることを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_RefDB">Data Source Explorerを使用してデータベースを参照する</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>エラーレコード(会員番号が"000000013")を除くすべてのレコードについて</p>
<div class="ulist">
<ul>
<li>
<p>statusカラム</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointカラム</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeカラムが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeカラムが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>エラーレコード(会員番号が"000000013")について</p>
<div class="ulist">
<ul>
<li>
<p>更新されていないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容は以下のとおり。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/ExceptionHandlingWithTryCatch/Ch09_ExceptionHandlingWithTryCatchJob_Result_MemberInfoTable.png" alt="Table of member_info">
</div>
<div class="title">更新前後の会員情報テーブルの内容</div>
</div>
</div>
<div class="sect7">
<h8 id="Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution_Output_File"><a class="anchor" href="#Ch09_Impl_ExceptionHandlingWithTryCatchJob_Tasklet_Execution_Output_File"></a>会員情報ファイルの確認</h8>
<div class="paragraph">
<p>会員情報ファイルの入出力内容を比較し、確認内容のとおりとなっていることを確認する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>出力ディレクトリに会員情報ファイルが出力されていること</p>
<div class="ulist">
<ul>
<li>
<p>出力ファイル: files/output/output-member-info-data.csv</p>
</li>
</ul>
</div>
</li>
<li>
<p>エラーレコード(会員番号が"00000013")を除くすべてのレコードについて</p>
<div class="ulist">
<ul>
<li>
<p>statusカラム</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointカラム</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeカラムが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeカラムが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>エラーレコード(会員番号が"00000013")が出力されていないこと</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>会員情報ファイルの入出力内容は以下のとおり。<br>
ファイルのフィールドはid(会員番号)、type(会員種別)、status(商品購入フラグ)、point(ポイント)の順で出力される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/ExceptionHandlingWithTryCatch/Ch09_ExceptionHandlingWithTryCatchJob_Result_MemberInfoFile.png" alt="File of member_info">
</div>
<div class="title">会員情報ファイルの入出力内容</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_AsyncExecutionJob"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob"></a>9.4.6. 非同期実行方式のジョブ</h4>
<div id="Ch09_Impl_AsyncExecutionJob_Prerequisite" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">前提</div>
<div class="paragraph">
<p><a href="#Ch09_Introduction_HowToProceed">チュートリアルの進め方</a>で説明しているとおり、
既に作成済みのジョブに対して、非同期実行していく形式とする。
なお、非同期実行方式には<a href="#Ch04_AsyncJobWithDB">DBポーリングを利用する方式</a>と
<a href="#Ch04_AsyncJobWithWeb">Webコンテナを利用する方式</a>がある。<br>
ただし、記述はDBポーリングを利用してジョブを非同期実行する場合の説明としているため留意すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_AsyncExecutionJob_Overview"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_Overview"></a>9.4.6.1. 概要</h5>
<div class="paragraph">
<p>DBポーリングを利用してジョブを非同期実行する。</p>
</div>
<div class="paragraph">
<p>なお、本節はMacchinetta Batch 2.x 開発ガイドラインを元に説明しているため、
詳細については<a href="#Ch04_AsyncJobWithDB">非同期実行(DBポーリング)</a>を参照のこと。<br>
<a href="#Ch09_Impl_AsyncExecutionJob_Prerequisite">前提</a>のとおり既に作成済みのジョブがあるため、作成するアプリケーションの背景、処理概要、業務仕様は説明は割愛する。</p>
</div>
<div class="paragraph">
<p>以降では、DBポーリングによるジョブの非同期実行方法を以下の手順で説明する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_AsyncExecutionJob_Preparation">準備</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_AsyncExecutionJob_StartAsyncBatchDeamon">非同期バッチデーモンを起動</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_AsyncExecutionJob_JobRegistration">ジョブ要求テーブルにジョブ情報を登録</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_AsyncExecutionJob_ExecutionResultCheck">ジョブの実行と結果の確認</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_AsyncExecutionJob_StopAsyncBatchDeamon">非同期バッチデーモンの停止</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_AsyncExecutionJob_ExecutionStatusCheck">ジョブ実行状態の確認</a></p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_AsyncExecutionJob_Preparation"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_Preparation"></a>9.4.6.2. 準備</h5>
<div class="paragraph">
<p>非同期実行(DBポーリング)を行うための準備作業を実施する。</p>
</div>
<div class="paragraph">
<p>実施する作業は以下のとおり。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_AsyncExecutionJob_Preparation_Properties">ポーリング処理の設定</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_AsyncExecutionJob_Preparation_Bean">ジョブの設定</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_AsyncExecutionJob_Preparation_Input">入力リソースの設定</a></p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_AsyncExecutionJob_Preparation_Properties"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_Preparation_Properties"></a>9.4.6.2.1. ポーリング処理の設定</h6>
<div class="paragraph">
<p>非同期実行に必要な設定は、<code>batch-application.properties</code>で行う。<br>
Macchinetta Batch 2.xでは既に設定済みであるため、詳細な説明は割愛する。
各項目の説明は<a href="#Ch04_AsyncJobWithDB_HowToUse_Config">各種設定</a>のポーリング処理の設定を参照のこと。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/batch-application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># TERASOLUNA AsyncBatchDaemon settings.
async-batch-daemon.scheduler.size=1
async-batch-daemon.schema.script=classpath:org/terasoluna/batch/async/db/schema-h2.sql
async-batch-daemon.job-concurrency-num=3
# (1)
async-batch-daemon.polling-interval=5000
async-batch-daemon.polling-initial-delay=1000
# (2)
async-batch-daemon.polling-stop-file-path=/tmp/stop-async-batch-daemon</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポーリング周期(ミリ秒単位)を設定する。<br>
ここでは、5000ミリ秒(5秒)を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">非同期バッチデーモンを停止させるための終了ファイルパスを設定する。<br>
本チュートリアルは、Windows環境で実施することを前提としているため、
この設定の場合はC:\tmp配下にstop-async-batch-daemonファイルを置くことになる。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_AsyncExecutionJob_Preparation_Bean"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_Preparation_Bean"></a>9.4.6.2.2. ジョブの設定</h6>
<div class="paragraph">
<p>非同期実行する対象のジョブは、<code>async-batch-daemon.xml</code>の<code>automaticJobRegistrar</code>に設定する。</p>
</div>
<div class="paragraph">
<p>例として<a href="#Ch09_Impl_DBAccessJob">データベースアクセスでデータ入出力を行うジョブ</a>(チャンクモデル)を指定した設定を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/spring/async-batch-daemon.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:jdbc</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/jdbc</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:c</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/c</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:task</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/task</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
            <span class="content">http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd</span>
            <span class="content">http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd</span>
            <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">automaticJobRegistrar</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.AutomaticJobRegistrar</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">applicationContextFactories</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.ClasspathXmlApplicationContextsFactoryBean</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">p:resources</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:/META-INF/jobs/dbaccess/jobPointAddChunk.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLoader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.DefaultJobLoader</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">p:jobRegistry-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">非同期実行する対象ジョブのBean定義ファイルを指定する。<br>
ワイルドカード(**/*)の利用も可能である。ジョブの指定に際しては
<a href="#Ch04_AsyncJobWithDB_HowToUse_Config_Job">ジョブの設定</a>に
注意事項等の記載があるため参照してほしい。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">ジョブ設計上の留意点</div>
<div class="paragraph">
<p>非同期実行(DBポーリング)の特性上、同一ジョブの並列実行が可能になっているので、並列実行した場合に同一ジョブが影響を与えないようにする必要がある。</p>
</div>
<div class="paragraph">
<p>本チュートリアルでは、データベースアクセスのジョブとファイルアクセスのジョブで同じジョブIDを用いている。
チュートリアルの中で、これらのジョブを並列実行することはないが、同じジョブIDのジョブを複数指定する場合はエラーとなってしまうため、
ジョブの設計時に留意する必要がある。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_AsyncExecutionJob_Preparation_Input"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_Preparation_Input"></a>9.4.6.2.3. 入力リソースの設定</h6>
<div class="paragraph">
<p>非同期実行でジョブを実行する際の入力リソース(データベース or ファイル)の設定を行う。<br>
ここでは、正常系データを利用するジョブを実行する。</p>
</div>
<div class="paragraph">
<p>データベースアクセスするジョブとファイルアクセスするジョブの場合の入力リソースの設定を以下に示す。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">データベースアクセスするジョブの場合</dt>
<dd>
<p><code>batch-application.proeprties</code>のDatabase Initializeのスクリプトを以下のとおり設定する。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">src/main/resources/batch-application.proeprties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"># Database Initialize
tutorial.create-table.script=file:sqls/create-member-info-table.sql
tutorial.insert-data.script=file:sqls/insert-member-info-data.sql
#tutorial.insert-data.script=file:sqls/insert-member-info-error-data.sql</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ファイルアクセスするジョブの場合</dt>
<dd>
<p>事前に、入力ファイルが配備されていること、および出力ディレクトリが存在することを確認しておくこと。</p>
<div class="ulist">
<ul>
<li>
<p>入力ファイル</p>
<div class="ulist">
<ul>
<li>
<p>files/input/input-member-info-data.csv</p>
</li>
</ul>
</div>
</li>
<li>
<p>出力ディレクトリ</p>
<div class="ulist">
<ul>
<li>
<p>files/output/</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">本チュートリアルにおける入力リソースのデータ準備について</div>
<div class="paragraph">
<p>データベースアクセスするジョブの場合、非同期バッチデーモン起動時(ApplicationContext生成時)にINSERTのSQLを実行し、
データベースにデータを準備している。</p>
</div>
<div class="paragraph">
<p>ファイルアクセスするジョブの場合、入力ファイルをディレクトリに配置し、
ジョブ要求テーブルへジョブ情報の登録時にそのジョブ情報のパラメータ部として入出力ファイルのパスを指定する。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_AsyncExecutionJob_StartAsyncBatchDeamon"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_StartAsyncBatchDeamon"></a>9.4.6.3. 非同期バッチデーモンを起動</h5>
<div class="paragraph">
<p>Macchinetta Batch 2.xが提供する<code>AsyncBatchDaemon</code>を起動する。</p>
</div>
<div class="paragraph">
<p>実行構成を以下のとおり作成し、非同期バッチデーモンを起動する。<br>
作成手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_RunConf">Run Configuration(実行構成)の作成</a>を参照。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Run ConfigurationsのMainタブで設定する値</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項目名</th>
<th class="tableblock halign-left valign-top">値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run Job With AsyncBatchDaemon<br>
(任意の値を設定する)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Project</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">macchinetta-batch-tutorial</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Main class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.terasoluna.batch.async.db.AsyncBatchDaemon</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>非同期バッチデーモンを起動すると、ポーリングプロセスが5秒間隔(<code>batch-application.properties</code>の<code>async-batch-daemon.polling-interval</code>に指定したミリ秒)で実行される。<br>
ログの出力例を以下に示す。<br>
このログではポーリングプロセスが3回実行されたことがわかる。</p>
</div>
<div class="listingblock">
<div class="title">コンソールログの出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/09/06 18:53:23][main] [o.t.b.a.d.AsyncBatchDaemon] [INFO ] Async Batch Daemon start.

(.. omitted)

[2017/09/06 18:53:27] [main] [o.t.b.a.d.AsyncBatchDaemon] [INFO ] Async Batch Daemon will start watching the creation of a polling stop file. [Path:\tmp\stop-async-batch-daemon]
[2017/09/06 18:53:27] [daemonTaskScheduler-1] [o.t.b.a.d.JobRequestPollTask] [INFO ] Polling processing.
[2017/09/06 18:53:33] [daemonTaskScheduler-1] [o.t.b.a.d.JobRequestPollTask] [INFO ] Polling processing.
[2017/09/06 18:53:38] [daemonTaskScheduler-1] [o.t.b.a.d.JobRequestPollTask] [INFO ] Polling processing.</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_AsyncExecutionJob_JobRegistration"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_JobRegistration"></a>9.4.6.4. ジョブ要求テーブルにジョブ情報を登録</h5>
<div class="paragraph">
<p>ジョブ要求テーブル(batch_job_request)にジョブを実行するための情報を登録するため、
SQL(INSERT文)を発行する。</p>
</div>
<div class="paragraph">
<p>ジョブ要求テーブルのテーブル仕様は<a href="#Ch04_AsyncJobWithDB_Arch_RequireTable">ポーリングするテーブルについて</a>のジョブ要求テーブルの構造を参照のこと。</p>
</div>
<div class="paragraph">
<p>STS上でSQLを実行する方法を以下に記す。</p>
</div>
<div class="olist arabic">
<div class="title">SQL実行手順</div>
<ol class="arabic">
<li>
<p>Data Source Explorer Viewを表示<br>
Viewの表示手順は<a href="#Ch09_EnvironmentConstruction_DataSourceExplorer">STSからデータベースを参照する準備</a>を参照。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/AsyncExecution/Ch09_AsyncExecutionJob_DataSourceExplorer.png" alt="Data Source Explorer View">
</div>
<div class="title">Data Source Explorer View</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>SQL Scrapbookを開く<br>
データソースを右クリックし、「Open SQL Scrapbook」を押下する。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/AsyncExecution/Ch09_AsyncExecutionJob_SQLScrapbook.png" alt="Open SQL Scrapbook">
</div>
<div class="title">SQL Scrapbook</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>SQLを記述する<br>
データベースアクセスするジョブとファイルアクセスするジョブを実行するためのSQLをチャンクモデルの例で以下に示す。</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">データベースアクセスするジョブの場合</dt>
<dd>
<p>記述するSQLを以下に示す。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">データベースアクセスするジョブの実行要求用SQL</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">INSERT</span> <span class="class">INTO</span> batch_job_request(job_name,job_parameter,polling_status,create_date)
<span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">jobPointAddChunk</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">INIT</span><span class="delimiter">'</span></span>, current_timestamp);</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ファイルアクセスするジョブの場合</dt>
<dd>
<p>記述するSQLを以下に示す。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ファイルアクセスするジョブの実行要求用SQL</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">INSERT</span> <span class="class">INTO</span> batch_job_request(job_name,job_parameter,polling_status,create_date)
<span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">jobPointAddChunk</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">inputFile=files/input/input-member-info-data.csv,outputFile=files/output/output-member_info_out.csv</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">INIT</span><span class="delimiter">'</span></span>, current_timestamp);</code></pre>
</div>
</div>
<div class="paragraph">
<p>SQL記述後のイメージを以下に記す。<br>
ここでは、データベースアクセスするジョブの実行要求用SQLを記述している。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/AsyncExecution/Ch09_AsyncExecutionJob_EnteringSQL.png" alt="Entering SQL">
</div>
<div class="title">SQL入力</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>SQLを実行する<br>
下図のとおり、SQL ScrapbookのConnection Profileを設定し、
余白部分を右クリック → [Execute All]を押下する。<br>
Connection Profileの内容は、
<a href="#Ch09_EnvironmentConstruction_DataSourceExplorer">STSからデータベースを参照する準備</a>で設定した内容を元にしている。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/AsyncExecution/Ch09_AsyncExecutionJob_ExecuteSQL.png" alt="Execute SQL">
</div>
<div class="title">SQL実行</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>SQLの実行結果を確認する<br>
下図のとおり、SQL Results Viewで実行したSQLの<code>Status</code>が<code>Succeeded</code>となっていることを確認する。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/AsyncExecution/Ch09_AsyncExecutionJob_SQLResults.png" alt="Confirm SQL Results">
</div>
<div class="title">SQL実行結果確認</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>ジョブ要求テーブルを確認する<br>
下図のとおり、ジョブ要求テーブルにジョブを実行するための情報が登録されていることを確認する。<br>
<code>POLLING_STATUS</code>は<code>INIT</code>で登録したが、既にポーリングが行われた場合は、<code>POLLING_STATUS</code>が<code>POLLED</code>もしくは<code>EXECUTED</code>となっている。<br>
<code>POLLING_STATUS</code>の詳細については<a href="#Ch04_AsyncJobWithDB_Arch_RequireTable_PollingStatus">ポーリングステータス(polling_status)の遷移パターン</a>を参照。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/AsyncExecution/Ch09_AsyncExecutionJob_BatchJobRequestTable.png" alt="Confrim batch_job_Request Table">
</div>
<div class="title">ジョブ要求テーブルの確認</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_AsyncExecutionJob_ExecutionResultCheck"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_ExecutionResultCheck"></a>9.4.6.5. ジョブの実行と結果の確認</h5>
<div class="paragraph">
<p>非同期実行対象ジョブの実行結果を確認する。</p>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_AsyncExecutionJob_ExecutionResultCheck_Console"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_ExecutionResultCheck_Console"></a>9.4.6.5.1. コンソールログの確認</h6>
<div class="paragraph">
<p>Console Viewを開き、以下の内容のログが出力されていることを確認する。<br>
ここでは、処理が完了(COMPLETED)し、例外が発生しないことを確認する。</p>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">(.. omitted)

[2017/09/06 18:59:50] [daemonTaskScheduler-1] [o.t.b.a.d.JobRequestPollTask] [INFO ] Polling processing.
[2017/09/06 18:59:55] [daemonTaskScheduler-1] [o.t.b.a.d.JobRequestPollTask] [INFO ] Polling processing.
[2017/09/06 18:59:55] [daemonTaskExecutor-1] [o.s.b.c.l.s.SimpleJobOperator] [INFO ] Checking status of job with name=jobPointAddChunk
[2017/09/06 18:59:55] [daemonTaskExecutor-1] [o.s.b.c.l.s.SimpleJobOperator] [INFO ] Attempting to launch job with name=jobPointAddChunk and parameters=
[2017/09/06 18:59:55] [daemonTaskExecutor-1] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddChunk]] launched with the following parameters: [{jsr_batch_run_id=117}]
[2017/09/06 18:59:55] [daemonTaskExecutor-1] [o.s.b.c.j.SimpleStepHandler] [INFO ] Executing step: [jobPointAddChunk.step01]
[2017/09/06 18:59:55] [daemonTaskExecutor-1] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddChunk]] completed with the following parameters: [{jsr_batch_run_id=117}] and the following status: [COMPLETED]
[2017/09/06 19:00:00] [daemonTaskScheduler-1] [o.t.b.a.d.JobRequestPollTask] [INFO ] Polling processing.
[2017/09/06 19:00:05] [daemonTaskScheduler-1] [o.t.b.a.d.JobRequestPollTask] [INFO ] Polling processing</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_AsyncExecutionJob_ExecutionResultCheck_ExitCode"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_ExecutionResultCheck_ExitCode"></a>9.4.6.5.2. 終了コードの確認</h6>
<div class="paragraph">
<p>非同期実行の場合、STS上で実行対象ジョブの終了コードを確認することはできない。<br>
ジョブの実行状態は<a href="#Ch09_Impl_AsyncExecutionJob_ExecutionStatusCheck">ジョブ実行状態の確認</a>で確認する。</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_Impl_AsyncExecutionJob_ExecutionResultCheck_Output"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_ExecutionResultCheck_Output"></a>9.4.6.5.3. 出力リソースの確認</h6>
<div class="paragraph">
<p>実行したジョブによって出力リソース(データベース or ファイル)を確認する。</p>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_AsyncExecutionJob_ExecutionResultCheck_Output_Table"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_ExecutionResultCheck_Output_Table"></a>データベースアクセスするジョブの場合</h7>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容を比較し、確認内容のとおりとなっていることを確認する。<br>
確認手順は<a href="#Ch09_EnvironmentConstruction_OperationCheck_RefDB">Data Source Explorerを使用してデータベースを参照する</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>statusカラム</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointカラム</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeカラムが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeカラムが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
<li>
<p>1,000,000(上限値)を超えたレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容を以下に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/AsyncExecution/Ch09_AsyncExecutionJob_Result_MemberInfoTable.png" alt="Table of member_info">
</div>
<div class="title">更新前後の会員情報テーブルの内容</div>
</div>
</div>
<div class="sect6">
<h7 id="Ch09_Impl_AsyncExecutionJob_ExecutionResultCheck_Output_File"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_ExecutionResultCheck_Output_File"></a>ファイルアクセスするジョブの場合</h7>
<div class="paragraph">
<p>会員情報ファイルの入出力内容を比較し、確認内容のとおりとなっていることを確認する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>出力ディレクトリに会員情報ファイルが出力されていること</p>
<div class="ulist">
<ul>
<li>
<p>出力ファイル: files/output/output-member-info-data.csv</p>
</li>
</ul>
</div>
</li>
<li>
<p>statusフィールド</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointフィールド</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeフィールドが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeフィールドが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
<li>
<p>1,000,000(上限値)を超えたレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>会員情報ファイルの入出力内容を以下に示す。<br>
ファイルのフィールドはid(会員番号)、type(会員種別)、status(商品購入フラグ)、point(ポイント)の順で出力される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/AsyncExecution/Ch09_AsyncExecutionJob_Result_MemberInfoFile.png" alt="File of member_info">
</div>
<div class="title">会員情報ファイルの入出力内容</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_AsyncExecutionJob_StopAsyncBatchDeamon"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_StopAsyncBatchDeamon"></a>9.4.6.6. 非同期バッチデーモンの停止</h5>
<div class="paragraph">
<p>終了ファイルを作成し、非同期バッチデーモンを停止する。</p>
</div>
<div class="paragraph">
<p><a href="#Ch09_Impl_AsyncExecutionJob_Preparation_Properties">ポーリング処理の設定</a>で設定したとおり、
C:\tmpにstop-async-batch-daemonファイル(空ファイル)を作成する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/AsyncExecution/Ch09_AsyncExecutionJob_StopAsyncBatchDaemon.png" alt="Stop AsyncBatchDeamon">
</div>
<div class="title">終了ファイル作成</div>
</div>
<div class="paragraph">
<p>STSのコンソールで以下のとおり非同期バッチデーモンが停止していることを確認する。</p>
</div>
<div class="listingblock">
<div class="title">非同期バッチデーモンの停止を確認</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">(.. omitted)

[2017/09/08 21:41:41] [daemonTaskScheduler-1] [o.t.b.a.d.JobRequestPollTask] [INFO ] Polling processing.
[2017/09/08 21:41:44] [main] [o.t.b.a.d.AsyncBatchDaemon] [INFO ] Async Batch Daemon has detected the polling stop file, and then shutdown now!
[2017/09/08 21:41:44] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@6b2fad11: startup date [Fri Sep 08 21:41:01 JST 2017]; root of context hierarchy
[2017/09/08 21:41:44] [main] [o.s.b.c.c.s.GenericApplicationContextFactory$ResourceXmlApplicationContext] [INFO ] Closing ResourceXmlApplicationContext:file:/C:/dev/workspace/tutorial/Maccinetta-batch-tutorial/target/classes/META-INF/jobs/dbaccess/jobPointAddChunk.xml
[2017/09/08 21:41:44] [main] [o.s.c.s.DefaultLifecycleProcessor] [INFO ] Stopping beans in phase 0
[2017/09/08 21:41:44] [main] [o.t.b.a.d.JobRequestPollTask] [INFO ] JobRequestPollTask is called shutdown.
[2017/09/08 21:41:44] [main] [o.s.s.c.ThreadPoolTaskScheduler] [INFO ] Shutting down ExecutorService 'daemonTaskScheduler'
[2017/09/08 21:41:44] [main] [o.s.s.c.ThreadPoolTaskExecutor] [INFO ] Shutting down ExecutorService
[2017/09/08 21:41:44] [main] [o.t.b.a.d.AsyncBatchDaemon] [INFO ] Async Batch Daemon stopped after all jobs completed.</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_Impl_AsyncExecutionJob_ExecutionStatusCheck"><a class="anchor" href="#Ch09_Impl_AsyncExecutionJob_ExecutionStatusCheck"></a>9.4.6.7. ジョブ実行状態の確認</h5>
<div class="paragraph">
<p>JobRepositoryのメタデータテーブルでジョブの状態・実行結果を確認する。ここでは、<code>batch_job_execution</code>を参照する。</p>
</div>
<div class="paragraph">
<p>ジョブの状態を確認するためのSQLを以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">ジョブの状態確認用SQL</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> job_execution_id,start_time,end_time,exit_code <span class="keyword">FROM</span> batch_job_execution <span class="keyword">WHERE</span> job_execution_id =
(<span class="class">SELECT</span> <span class="predefined">max</span>(job_execution_id) <span class="keyword">FROM</span> batch_job_request <span class="keyword">WHERE</span> job_execution_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>このSQLでは、最後に実行されたジョブの実行状態を取得するようにしている。</p>
</div>
<div class="paragraph">
<p>SQLの実行結果は、STS上でSQL実行後に表示されるSQL Results Viewにて確認できる。<br>
下図のとおり、<code>EXIT_CODE</code>が<code>COMPLETED</code>となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/AsyncExecution/Ch09_AsyncExecutionJob_Confirm_JobStatus.png" alt="SQL Results View">
</div>
<div class="title">ジョブの状態確認</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Conclusion"><a class="anchor" href="#Ch09_Conclusion"></a>9.5. おわりに</h3>
<div class="paragraph">
<p>このチュートリアルでは、以下の内容を学習した。</p>
</div>
<div class="paragraph">
<p>Macchinetta Batch 2.xによる基本的なバッチジョブの実装方法</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch09_DBAccessJob">データベースアクセスでデータ入出力を行うジョブ</a></p>
</li>
<li>
<p><a href="#Ch09_FileAccessJob">ファイルアクセスでデータ入出力を行うジョブ</a></p>
</li>
<li>
<p><a href="#Ch09_ValidationJob">入力データの妥当性検証を行うジョブ</a></p>
</li>
<li>
<p><a href="#Ch09_ExceptionHandlingWithListenerJob">ChunkListenerで例外ハンドリングを行うジョブ</a></p>
</li>
<li>
<p><a href="#Ch09_ExceptionHandlingWithTryCatchJob">try-catchで例外ハンドリングを行うジョブ</a></p>
</li>
<li>
<p><a href="#Ch09_AsyncExecutionJob">非同期実行方式のジョブ</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>なお、Macchinetta Batch 2.xを利用し、バッチアプリケーションを開発する際は<a href="#Ch99_SummaryOfPoints_AboutThis">利用時の注意点</a>に示す指針に沿って進めてほしい。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch99_SummaryOfPoints"><a class="anchor" href="#Ch99_SummaryOfPoints"></a>10. 利用時の注意点</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch99_SummaryOfPoints_AboutThis"><a class="anchor" href="#Ch99_SummaryOfPoints_AboutThis"></a>10.1. Macchinetta Batch 2.xの注意点について</h3>
<div class="paragraph">
<p>ここでは、各節で説明しているMacchinetta Batch 2.xを利用する際の、ルールや注意点についてリストにまとめる。
ユーザはバッチアプリケーションを開発する際、以降に示すポイントに留意して進めてほしい。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ここでは、特に重要な注意点を挙げているのみであり、あらゆる検討事項を網羅しているわけではない。
ユーザは必ず利用する機能を一読すること。</p>
</div>
</td>
</tr>
</table>
</div>
<hr>
<div class="ulist">
<div class="title">バッチ処理で考慮する原則と注意点</div>
<ul>
<li>
<p>単一のバッチ処理は可能な限り簡素化し、複雑な論理構造を避ける。</p>
</li>
<li>
<p>複数のジョブで同じことを何度もしない。</p>
</li>
<li>
<p>システムリソースの利用を最小限にし、不要な物理I/Oを避け、メモリ上での操作を活用する。</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">Macchinetta Batch 2.xの指針</div>
<ul>
<li>
<p><a href="#Ch03_CreateProject">バッチアプリケーションの開発</a></p>
<div class="ulist">
<ul>
<li>
<p>1ジョブ=1Bean定義(1ジョブ定義) として作成する</p>
</li>
<li>
<p>1ステップ=1バッチ処理=1ビジネスロジック として作成する</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch03_CreateChunkJob">チャンクモデル</a></p>
<div class="ulist">
<ul>
<li>
<p>大量データを効率よく処理したい場合に利用する。</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch03_CreateTaskletJob">タスクレットモデル</a></p>
<div class="ulist">
<ul>
<li>
<p>シンプルな処理や、定型化しにくい処理、データを一括で処理したい場合に利用する。</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch04_SyncJob">同期実行</a></p>
<div class="ulist">
<ul>
<li>
<p>スケジュールどおりにジョブを起動したり、複数のジョブを組み合わせてバッチ処理行う場合に利用する。</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch04_AsyncJobWithDB">非同期実行(DBポーリング)</a></p>
<div class="ulist">
<ul>
<li>
<p>ディレード処理、処理時間が短いジョブの連続実行、大量ジョブの集約などに利用する。</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch04_AsyncJobWithWeb">非同期実行(Webコンテナ)</a></p>
<div class="ulist">
<ul>
<li>
<p>DBポーリングと同様だが、起動までの即時性が求められる場合にはこちらを利用する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>JobRepositoryの管理</p>
<div class="ulist">
<ul>
<li>
<p>Spring Batch はジョブの起動状態・実行結果の記録に<code>JobRepository</code>を使用する。</p>
</li>
<li>
<p>Macchinetta Batch 2.xでは、以下のすべてに該当する場合は永続化は任意としてよい。</p>
<div class="ulist">
<ul>
<li>
<p>同期型ジョブ実行のみでMacchinetta Batch 2.xを使用する。</p>
</li>
<li>
<p>ジョブの停止・リスタートを含め、ジョブの実行管理はすべてジョブスケジューラに委ねる。</p>
<div class="ulist">
<ul>
<li>
<p>Spring Batchがもつ<code>JobRepository</code>を前提としたリスタートを利用しない。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>これらに該当する場合は<code>JobRepository</code>が使用するRDBMSの選択肢として、インメモリ・組み込み型データベースである<code>H2</code>を利用する。
一方で非同期実行を利用する場合や、Spring Batchの停止・リスタートを活用する場合は、ジョブの実行状態・結果を永続化可能なRDBMSが必要となる。<br>
この点については、<a href="#Ch07_JobManagement">ジョブの管理</a>も一読のこと。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">チャンクモデルとタスクレットモデルの使い分け</div>
<ul>
<li>
<p><a href="#Ch03_CreateChunkJob">チャンクモデル</a></p>
<div class="ulist">
<ul>
<li>
<p>大量のデータを安定して処理したい場合</p>
</li>
<li>
<p>件数ベースリスタートをしたい場合</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch03_CreateTaskletJob">タスクレットモデル</a></p>
<div class="ulist">
<ul>
<li>
<p>リカバリを限りなくシンプルにしたい場合</p>
</li>
<li>
<p>処理の内容をまとめたい場合</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Ch03_ChunkOrTasklet">チャンクモデルとタスクレットモデルの使い分け</a>も一読のこと。</p>
</div>
<hr>
<div class="ulist">
<div class="title">Beanスコープの統一</div>
<ul>
<li>
<p>Tasklet実装では、Injectされるコンポーネントのスコープに合わせる。</p>
</li>
<li>
<p>Composite系コンポーネントは、委譲するコンポーネントのスコープに合わせる。</p>
</li>
<li>
<p>JobParameterを使用する場合は、<code>step</code>のスコープにする。</p>
</li>
<li>
<p>Step単位でインスタンス変数を確保したい場合は、<code>step</code>のスコープにする。</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">性能チューニングポイント</div>
<ul>
<li>
<p>チャンクサイズを調整する</p>
<div class="ulist">
<ul>
<li>
<p>チャンクを利用するときは、コミット件数を適度なサイズにする。サイズを大きくしすぎない。</p>
</li>
</ul>
</div>
</li>
<li>
<p>フェッチサイズを調整する</p>
<div class="ulist">
<ul>
<li>
<p>データベースアクセスでは、フェッチサイズを適度なサイズにする。サイズを大きくしすぎない。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ファイル読み込みを効率化する</p>
<div class="ulist">
<ul>
<li>
<p>専用のFieldSetMapperインターフェース実装を用意する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>並列処理・多重処理</p>
<div class="ulist">
<ul>
<li>
<p>出来る限りジョブスケジューラによって実現する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>分散処理</p>
<div class="ulist">
<ul>
<li>
<p>出来る限りジョブスケジューラによって実現する。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
<div id="Ch99_SummaryOfPoints_dbpolling" class="ulist">
<div class="title">非同期実行(DBポーリング)</div>
<ul>
<li>
<p>インメモリデータベースの使用</p>
<div class="ulist">
<ul>
<li>
<p>長期連続運用するには向かず、定期的に再起動する運用が望ましい。</p>
</li>
<li>
<p>長期連続運用で利用したい場合は、定期的に<code>JobRepository</code>からデータを削除するなどのメンテナンス作業が必須である。</p>
</li>
</ul>
</div>
</li>
<li>
<p>登録ジョブの絞込み</p>
<div class="ulist">
<ul>
<li>
<p>非同期実行することを前提に設計・実装されたジョブを指定する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>性能劣化もあり得るため、超ショートバッチの大量処理は向いていない。</p>
</li>
<li>
<p>同一ジョブの並列実行が可能になっているので、並列実行した場合に同一ジョブが影響を与えないようにする必要がある</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">非同期実行(Webコンテナ)</div>
<ul>
<li>
<p>基本的な検討事項は、<a href="#Ch99_SummaryOfPoints_dbpolling">非同期実行(DBポーリング)</a>と同じ。</p>
</li>
<li>
<p>スレッドプールの調整をする。</p>
<div class="ulist">
<ul>
<li>
<p>非同期実行のスレッドプールとは別に、Webコンテナのリクエストスレッドや同一筐体内で動作している他のアプリケーションも含めて検討する必要がある。</p>
</li>
</ul>
</div>
</li>
<li>
<p>Webとバッチとでは、データソース、MyBatis設定、Mapperインターフェースは相互参照はできない。</p>
</li>
<li>
<p>スレッドプール枯渇によるジョブの起動失敗はジョブ起動時に捕捉できないので、別途確認する手段を用意しておく。</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">データベースアクセスとトランザクション</div>
<ul>
<li>
<p>「ItemWriterに<code>MyBatisBatchItemWriter</code>を使用する」と「ItemProcessorでMapperインターフェースを使用し参照更新をする」は同時にできない。</p>
<div class="ulist">
<ul>
<li>
<p>MyBatisには、同一トランザクション内で2つ以上の<code>ExecutorType</code>で実行してはいけないという制約があるため。
<a href="#Ch05_DBAccess_HowToUse_Input_MapperInterface">Mapperインターフェース(入力)</a>を参照。</p>
</li>
</ul>
</div>
</li>
<li>
<p>データベースの同一テーブルへ入出力する際の注意点</p>
<div class="ulist">
<ul>
<li>
<p>読み取り一貫性を担保するための情報が出力(UPDATEの発行)により失われた結果、入力(SELECT)にてエラーが発生することがある。 以下の対策を検討する。</p>
<div class="ulist">
<ul>
<li>
<p>データベースに依存になるが、情報を確保する領域を大きくする。</p>
</li>
<li>
<p>入力データを分割し多重処理を行う。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">ファイルアクセス</div>
<ul>
<li>
<p>以下の固定長ファイルを扱う場合は、TERASOLUNA Batch 5.xが提供する部品を必ず使う。</p>
<div class="ulist">
<ul>
<li>
<p>マルチバイト文字を含む固定長ファイル</p>
</li>
<li>
<p>改行なし固定長ファイル</p>
</li>
</ul>
</div>
</li>
<li>
<p>フッタレコードを読み飛ばす場合は、OSコマンドによる対応が必要。</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">排他制御</div>
<ul>
<li>
<p>複数ジョブを同時実行する場合は、排他制御の必要がないようにジョブ設計を行う。</p>
<div class="ulist">
<ul>
<li>
<p>アクセスするリソースや処理対象をジョブごとに分割することが基本である。</p>
</li>
</ul>
</div>
</li>
<li>
<p>デッドロックが発生しないように設計を行う。</p>
</li>
<li>
<p>ファイルの排他制御は、タスクレットモデルで実装すること。</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">異常系への対応</div>
<ul>
<li>
<p>例外ハンドリングではトランザクション処理を行わない。</p>
</li>
<li>
<p>処理モデルでChunkListenerの挙動が異なることに注意する。</p>
<div class="ulist">
<ul>
<li>
<p>リソースのオープン･クローズで発生した例外は、</p>
<div class="ulist">
<ul>
<li>
<p>チャンクモデル…ChunkListenerインターフェースが捕捉するスコープ外となる。</p>
</li>
<li>
<p>タスクレットモデル…ChunkListenerインターフェースが捕捉するスコープ内となる。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>入力チェックエラーは、チェックエラーの原因となる入力リソースを修正しない限り、リスタートしても回復不可能である</p>
</li>
<li>
<p>JobRepositoryに障害が発生した時の対処方法を検討する必要がある。</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">ExecutionContextについて</div>
<ul>
<li>
<p><code>ExecutionContext</code>は<code>JobRepository</code>へ格納されるため、以下の制約がある。</p>
<div class="ulist">
<ul>
<li>
<p><code>ExecutionContext</code>へ格納するオブジェクトは、<code>java.io.Serializable</code>を実装したクラスでなければならない。</p>
</li>
<li>
<p>格納できるサイズに制限がある。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">終了コード</div>
<ul>
<li>
<p>Javaプロセス強制終了時の終了コードとバッチアプリケーションの終了コードとは明確に区別する。</p>
<div class="ulist">
<ul>
<li>
<p>バッチアプリケーションによるプロセスの終了コードを1に設定することは厳禁とする。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">並列処理と多重処理</div>
<ul>
<li>
<p><code>Multi Thread Step</code>は利用しない。</p>
</li>
<li>
<p>処理内容によっては、リソース競合とデッドロックが発生する可能性に注意する。</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="container">

  <div class="common-bg">
    <div class="information">
      Macchinetta Batch Framework (2.x) Development Guideline - version 2.0.1.RELEASE, 2018-3-9
    </div>
    <div class="index">
      <a href="#">&gt; INDEX</a>
    </div>
  </div>

  <div class="footer-bg">
    <div class="copyright">
      &copy; Copyright 2018 NTT Corporation.
    </div>
  </div>

</div>
</body>
</html>

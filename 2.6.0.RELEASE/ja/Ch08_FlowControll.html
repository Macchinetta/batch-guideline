<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>フロー制御</title>
<link rel="stylesheet" href="./theme/css/readthedocs.css">
<link rel="stylesheet" href="./theme/css/font-awesome.min.css">
<link rel="stylesheet" href="./theme/css/coderay-asciidoctor.css">
<link rel="stylesheet" href="./theme/css/coderay-asciidoctor.css">
<link rel="stylesheet" href="./theme/css/header-footer.css">
<title>Macchinetta Batch Framework (2.x) Development Guideline</title>

<div class="common-bg">
  <div class="information">
    Macchinetta Batch Framework (2.x) Development Guideline - version 2.6.0.RELEASE, 2025-3-28
  </div>
  <div class="index">
    <a href="index.html">&gt; INDEX</a>
  </div>
</div>
<style>
.hidden {
	display: none;
}

.switch {
	border-width: 1px 1px 0 1px;
	border-style: solid;
	border-color: #7a2518;
	display: inline-block;
}

.switch--item {
	padding: 10px;
	background-color: #ffffff;
	color: #7a2518;
	display: inline-block;
	cursor: pointer;
}

.switch--item:not(:first-child) {
	border-width: 0 0 0 1px;
	border-style: solid;
	border-color: #7a2518;
}

.switch--item.selected {
	background-color: #7a2519;
	color: #ffffff;
}

</style>
<script type="text/javascript">
function addBlockSwitches() {
	for (var primary of document.querySelectorAll('.primary')) {
		var switchItem = createSwitchItem(primary, createBlockSwitch(primary));
		switchItem.item.classList.add("selected");
		var title = primary.querySelector('.title')
		title.remove();
	}
	for (var secondary of document.querySelectorAll('.secondary')) {
		var primary = findPrimary(secondary);
		if (primary === null) {
			console.error("Found secondary block with no primary sibling");
		}
		else {
			var switchItem = createSwitchItem(secondary, primary.querySelector('.switch'));
			switchItem.content.classList.add("hidden");
			primary.append(switchItem.content);
			secondary.remove();
		}
	}
}

function createElementFromHtml(html) {
	var template = document.createElement('template');
    template.innerHTML = html;
    return template.content.firstChild;
}

function createBlockSwitch(primary) {
    var blockSwitch = createElementFromHtml('<div class="switch"></div>');
    primary.prepend(blockSwitch)
	return blockSwitch;
}

function findPrimary(secondary) {
	var candidate = secondary.previousElementSibling;
	while (candidate != null && !candidate.classList.contains('primary')) {
		candidate = candidate.previousElementSibling;
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	var blockName = block.querySelector('.title').textContent;
	var content = block.querySelectorAll('.content').item(0);
	var colist = nextSibling(block, '.colist');
	if (colist != null) {
		content.append(colist);
	}
	var item = createElementFromHtml('<div class="switch--item">' + blockName + '</div>');
	item.dataset.blockName = blockName;
	content.dataset.blockName = blockName;
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function nextSibling(element, selector) {
	var sibling = element.nextElementSibling;
	while (sibling) {
		if (sibling.matches(selector)) {
			return sibling;
		}
		sibling = sibling.nextElementSibling;
	}
}

function globalSwitch() {
	document.querySelectorAll(".switch--item").forEach(function(item) {
		var blockId = blockIdForSwitchItem(item);
		var handler = function(event) {
			selectedText = event.target.textContent;
			window.localStorage.setItem(blockId, selectedText);
			for (var switchItem of document.querySelectorAll(".switch--item")) {
				if (blockIdForSwitchItem(switchItem) === blockId && switchItem.textContent === selectedText) {
					select(switchItem);
				}
			}
		}
		item.addEventListener("click", handler);
		if (item.textContent === window.localStorage.getItem(blockId)) {
			select(item);
		}
	});
}

function select(selected) {
	for (var child of selected.parentNode.children) {
		child.classList.remove("selected");
	}
	selected.classList.add("selected");
	for (var child of selected.parentNode.parentNode.children) {
		if (child.classList.contains("content")) {
			if (selected.dataset.blockName === child.dataset.blockName) {
				child.classList.remove("hidden");
			}
			else {
				child.classList.add("hidden");
			}
		}
	}	
}

function blockIdForSwitchItem(item) {
	idComponents = []
	for (var switchItem of item.parentNode.querySelectorAll(".switch--item")) {
		idComponents.push(switchItem.textContent.toLowerCase());
	}
	return idComponents.sort().join("-")
}

window.onload = function() {
	addBlockSwitches();
	globalSwitch();
};

</script>

</head>
<body id="Ch08_FlowControll" class="book toc2 toc-left">
<div id="header">
<h1>フロー制御</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#Ch08_FlowControll_Overview">Overview</a></li>
<li><a href="#Ch08_FlowControll_HowToUse">How to use</a>
<ul class="sectlevel2">
<li><a href="#Ch08_FlowControll_HowToUse_SequencialFlow">シーケンシャルフロー</a></li>
<li><a href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps">ステップ間のデータの受け渡し</a>
<ul class="sectlevel3">
<li><a href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Tasklet">タスクレットモデルを用いたステップ間のデータ受け渡し</a></li>
<li><a href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Chunk">チャンクモデルを用いたステップ間のデータ受け渡し</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch08_FlowControll_HowToExtend">How to extend</a>
<ul class="sectlevel2">
<li><a href="#Ch08_FlowControll_HowToExtend_ConditionFlow">条件分岐</a></li>
<li><a href="#Ch08_FlowControll_HowToExtend_StopConfig">停止条件</a></li>
</ul>
</li>
<li><a href="#Ch08_FlowControll_Appendix">Appendix</a>
<ul class="sectlevel3">
<li><a href="#Ch08_FlowControll_Appendix_FlowDefinition">外部でのフロー定義方法</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="Ch08_FlowControll_Overview"><a class="anchor" href="#Ch08_FlowControll_Overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>1つの業務処理を実装する方法として、1つのジョブに集約して実装するのではなく、
複数のジョブに分割し組み合わせることで実装することがある。
このとき、ジョブ間の依存関係を定義したものをジョブネットと呼ぶ。</p>
</div>
<div class="paragraph">
<p>ジョブネットを定義することのメリットを下記に挙げる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>処理の進行状況が可視化しやすくなる</p>
</li>
<li>
<p>ジョブの部分再実行、実行保留、実行中止が可能になる</p>
</li>
<li>
<p>ジョブの並列実行が容易になる</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以上より、バッチ処理を設計する場合はジョブネットも併せてジョブ設計を行うことが一般的である。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">処理内容とジョブネットの適性</div>
<div class="paragraph">
<p>分割するまでもないシンプルな業務処理やオンライン処理と連携する処理に対して、ジョブネットは適さないことが多い。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>本ガイドラインでは、ジョブネットでジョブ同士の流れを制御することをフロー制御と呼ぶ。
また処理の流れにおける前のジョブを先行ジョブ、後のジョブを後続ジョブと呼び、
先行ジョブと後続ジョブの依存関係を、先行後続関係と呼ぶ。</p>
</div>
<div class="paragraph">
<p>フロー制御の概念図を以下に示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_FlowControl_Overview.png" alt="Flow Control Overview">
</div>
<div class="title">図 1. フロー制御の概念図</div>
</div>
<div class="paragraph">
<p>上図のとおり、フロー制御はジョブスケジューラ、Macchinetta Batch 2.xのどちらでも実施可能である。
しかし、以下の理由によりできる限りジョブスケジューラを活用することが望ましい。</p>
</div>
<div class="ulist">
<div class="title">Macchinetta Batch 2.xで実現した場合</div>
<ul>
<li>
<p>1ジョブの処理や状態が多岐に渡る傾向が強まり、ブラックボックス化しやすい。</p>
</li>
<li>
<p>ジョブスケジューラとジョブの境界があいまいになってしまう</p>
</li>
<li>
<p>ジョブスケジューラ上から異常時の状況がみえにくくなってしまう</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ただし、ジョブスケジューラに定義するジョブ数が多くなると、以下の様なデメリットが生じることも一般に知られている。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ジョブスケジューラによる以下のようなコストが累積し、システム全体の処理時間が伸びる</p>
<div class="ulist">
<ul>
<li>
<p>ジョブスケジューラ製品固有の通信、実行ノードの制御、など</p>
</li>
<li>
<p>ジョブごとのJavaプロセス起動に伴うオーバーヘッド</p>
</li>
</ul>
</div>
</li>
<li>
<p>ジョブ登録数の限界</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>このため、以下を方針とする。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>基本的にはジョブスケジューラによりフロー制御を行う。</p>
</li>
<li>
<p>ジョブ数が多いことによる弊害がある場合に限り、以下のとおり対処する。</p>
<div class="ulist">
<ul>
<li>
<p>Macchinetta Batch 2.xにてシーケンシャルな複数の処理を1ジョブにまとめる。</p>
<div class="ulist">
<ul>
<li>
<p>シンプルな先行後続関係を1ジョブに集約するのみとする。</p>
</li>
<li>
<p>ステップ終了コードの変更と、この終了コードに基づく後続ステップ起動の条件分岐は機能上利用可能だが、
ジョブの実行管理が複雑化するため、ジョブ終了時のプロセス終了コード決定に限り原則利用する。<br>
どうしても条件分岐を使わないと問題を解消できない場合に限り使用を許容するが、
シンプルな先行後続関係を維持するよう配慮すること。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ジョブの終了コードの決定について、詳細は<a href="Ch07_JobManagement.html#Ch07_JobManagement_HowToUse_ExitCode">"終了コードのカスタマイズ"</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>また、以下に先行後続を実現する上で意識すべきポイントを示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch08/FlowControl/Ch08_FlowControl_Jobnet.png" alt="Jobnet">
</div>
<div class="title">図 2. ジョブスケジューラによるフロー制御</div>
</div>
<div class="ulist">
<div class="title">意識すべきポイント</div>
<ul>
<li>
<p>ジョブスケジューラがシェル等を介してjavaプロセスを起動する。</p>
</li>
<li>
<p>1ジョブが1javaプロセスとなる。</p>
<div class="ulist">
<ul>
<li>
<p>処理全体では、4つのjavaプロセスが起動する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ジョブスケジューラが各処理の起動順序を制御する。ぞれぞれのjavaプロセスは独立している。</p>
</li>
<li>
<p>後続ジョブの起動判定として、先行ジョブのプロセス終了コードが用いられる。</p>
</li>
<li>
<p>ジョブ間のデータ受け渡しは、ファイルやデータベースなど外部リソースを使用する必要がある。</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch08/FlowControl/Ch08_FlowControl_StepExecution.png" alt="FlowControl">
</div>
<div class="title">図 3. Macchinetta Batch 2.xによるフロー制御</div>
</div>
<div class="ulist">
<div class="title">意識すべきポイント</div>
<ul>
<li>
<p>ジョブスケジューラがシェル等を介してjavaプロセスを起動する。</p>
</li>
<li>
<p>1ジョブが1javaプロセスとなる。</p>
<div class="ulist">
<ul>
<li>
<p>処理全体では、1つのjavaプロセスしか使わない。</p>
</li>
</ul>
</div>
</li>
<li>
<p>1javaプロセス内で各ステップの起動順序を制御する。それぞれのステップは独立している。</p>
</li>
<li>
<p>後続ステップの起動判定として、先行ステップの終了コードが用いられる。</p>
</li>
<li>
<p>ステップ間のデータはインメモリで受け渡しが可能である。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以降、Macchinetta Batch 2.xによるフロー制御の実現方法について説明する。<br>
ジョブスケジューラでのフロー制御は製品仕様に強く依存するためここでは割愛する。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">フロー制御の応用例</div>
<div class="paragraph">
<p>複数ジョブの並列化・多重化は、一般的にジョブスケジューラとジョブネットによって実現することが多い。<br>
しかし、Macchinetta Batch 2.xではフロー制御の機能を応用し、複数ジョブの並列化、多重化を実現する方法を説明している。
詳細は、<a href="Ch08_ParallelAndMultiple.html#Ch08_ParallelAndMultiple">並列処理と多重処理</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで同じ使い方になる。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch08_FlowControll_HowToUse"><a class="anchor" href="#Ch08_FlowControll_HowToUse"></a>How to use</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Macchinetta Batch 2.xでのフロー制御方法を説明する。</p>
</div>
<div class="sect2">
<h3 id="Ch08_FlowControll_HowToUse_SequencialFlow"><a class="anchor" href="#Ch08_FlowControll_HowToUse_SequencialFlow"></a>シーケンシャルフロー</h3>
<div class="paragraph">
<p>シーケンシャルフローとは先行ステップと後続ステップを直列に連結したフローである。<br>
何らかの業務処理がシーケンシャルフロー内のステップで異常終了した場合、後続ステップは実行されずにジョブが中断する。
このとき、<code>JobRepository</code>によりジョブ実行IDに紐付けられる当該のステップとジョブのステータス・終了コードは
<code>FAILED</code>として記録される。<br>
失敗原因の回復後にリスタートを実施することで、異常終了したステップから処理をやり直すことができる。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ジョブのリスタート方法については<a href="Ch06_ReProcessing.html#Ch06_RerunRestart_HowToUse_Restart">ジョブのリスタート</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ここでは3つのステップからなるジョブのシーケンシャルフローを設定する。</p>
</div>
<div class="exampleblock primary">
<div class="title">JavaConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// tasklet definition is omitted.</span>

TaskletStepBuilder parentStepBuilder(<span class="predefined-type">String</span> stepName,
                                     JobRepository jobRepository,
                                     SequentialFlowTasklet tasklet,
                                     PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> <span class="keyword">new</span> StepBuilder(stepName, jobRepository)
            .tasklet(tasklet, transactionManager);
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step01(JobRepository jobRepository,
                   SequentialFlowTasklet tasklet,
                   <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step1</span><span class="delimiter">&quot;</span></span>, jobRepository,
            tasklet, transactionManager)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step02(JobRepository jobRepository,
                   SequentialFlowTasklet tasklet,
                   <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step2</span><span class="delimiter">&quot;</span></span>, jobRepository,
            tasklet, transactionManager)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step03(JobRepository jobRepository,
                   SequentialFlowTasklet tasklet,
                   <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step3</span><span class="delimiter">&quot;</span></span>, jobRepository,
            tasklet, transactionManager)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Job jobSequentialFlow(JobRepository jobRepository,
                             Step step01, Step step02, Step step03) {
    Flow flow = <span class="keyword">new</span> FlowBuilder&lt;Flow&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow</span><span class="delimiter">&quot;</span></span>)
            .from(step01)
            .next(step02) <span class="comment">// (1)</span>
            .next(step03) <span class="comment">// (1)</span>
            .build(); <span class="comment">// (2)</span>

    <span class="keyword">return</span> <span class="keyword">new</span> JobBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow</span><span class="delimiter">&quot;</span></span>, jobRepository)
            .start(flow)
            .end()
            .build();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock secondary">
<div class="title">XMLConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- tasklet definition is omitted. --&gt;</span>

<span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sequentialFlowTasklet</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:step&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step1</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step2</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>   <span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FlowBuilderのnextメソッド/&lt;batch:step&gt;</code>で、このステップの正常終了後に起動する後続ステップを指定する。<br>
<code>nextメソッドの引数step/next属性</code>に後続ステップのidを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フローの末端になるステップには、<code>nextメソッド/next属性</code>は不要となる。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>これにより、 以下の順でステップが直列に起動する。<br>
<code>jobSequentialFlow.step1</code> &#8594; <code>jobSequentialFlow.step2</code> &#8594; <code>jobSequentialFlow.step3</code><br></p>
</div>
<div class="paragraph">
<p>上述の例では<code>jobSequentialFlowメソッド/&lt;batch:job&gt;</code>内に直接フローを定義した。
いっぽうで、フロー定義を<code>jobSequentialFlowメソッド/&lt;batch:job&gt;</code>の外で記述する方法もある。
詳しくは、<a href="#Ch08_FlowControll_Appendix_FlowDefinition">外部でのフロー定義方法</a>を参照のこと。</p>
</div>
</div>
<div class="sect2">
<h3 id="Ch08_FlowControll_HowToUse_PassingDataToFutureSteps"><a class="anchor" href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps"></a>ステップ間のデータの受け渡し</h3>
<div class="paragraph">
<p>Spring Batchには、ステップ、ジョブそれぞれのスコープで利用できる実行コンテキストの<code>ExecutionContext</code>が用意されている。
ステップ実行コンテキストを利用することでステップ内のコンポーネント間でデータを共有できる。
このとき、ステップ実行コンテキストはステップ間で共有できないため、先行のステップ実行コンテキストは後続のステップ実行コンテキストからは参照できない。
ジョブ実行コンテキストを利用すれば実現可能だが、すべてのステップから参照可能になるため、慎重に扱う必要がある。
ステップ間の情報を引き継ぐ必要があるときは、以下の手順により対応できる。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>先行ステップの後処理で、ステップ実行コンテキストに格納した情報をジョブ実行コンテキストに移す。</p>
</li>
<li>
<p>後続ステップがジョブ実行コンテキストから情報を取得する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>最初の手順は、Spring Batchから提供されている<code>ExecutionContextPromotionListener</code>を利用することで、
実装をせずとも、引き継ぎたい情報をリスナーに指定するだけ実現できる。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">ExecutionContextを使用する上での注意点</div>
<div class="paragraph">
<p>データの受け渡しに使用する<code>ExecutionContext</code>は<code>JobRepository</code>によりRDBMSの
<code>BATCH_JOB_EXECUTION_CONTEXT</code>、<code>BATCH_JOB_STEP_EXECUTION_CONTEXT</code>に
シリアライズされた状態で保存されるため、以下3点に注意すること。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>受け渡しデータはシリアライズ可能な形式のオブジェクトであること。</p>
<div class="ulist">
<ul>
<li>
<p><code>java.io.Serializable</code>を実装している必要がある。</p>
</li>
</ul>
</div>
</li>
<li>
<p>受け渡しデータは必要最小限に留めること。<br>
<code>ExecutionContext</code>はSpring Batchによる実行制御情報の保存でも利用しており、
受け渡しデータが大きくなればそれだけシリアライズコストが増大する。<br></p>
</li>
<li>
<p>データ受け渡しに直接ジョブ実行コンテキストに保存させず、上述の<code>ExecutionContextPromotionListener</code>を使用すること。<br>
ジョブ実行コンテキストはステップ実行コンテキストよりスコープが広いため、無用なシリアライズデータが蓄積しやすいため。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>また、実行コンテキストを経由せず、SingletonやJobスコープのBeanを共有することでも情報のやり取りは可能だが、
この方法もサイズが大きすぎるとメモリリソースを圧迫する可能性があるので注意すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以下、タスクレットモデルとチャンクモデルについて、それぞれステップ間のデータ受け渡しについて説明する。</p>
</div>
<div class="sect3">
<h4 id="Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Tasklet"><a class="anchor" href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Tasklet"></a>タスクレットモデルを用いたステップ間のデータ受け渡し</h4>
<div class="paragraph">
<p>受け渡しデータの保存・取得に、<code>ChunkContext</code>から<code>ExecutionContext</code>を取得し、ステップ間のデータ受け渡しを行う。</p>
</div>
<div class="listingblock">
<div class="title">データ受け渡し元タスクレットの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package, imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SavePromotionalTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// (1)</span>
        chunkContext.getStepContext().getStepExecution().getExecutionContext()
                .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>);

        <span class="comment">// omitted.</span>

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">データ受け渡し先のタスクレット実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ConfirmPromotionalTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) {
        <span class="comment">// (2)</span>
        <span class="predefined-type">Object</span> promotion = chunkContext.getStepContext().getJobExecutionContext()
                .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>);

        <span class="comment">// omitted.</span>

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="exampleblock primary">
<div class="title">JavaConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// import,annotation,component-scan definitions are omitted</span>

<span class="comment">// (3)</span>
<span class="annotation">@Bean</span>
ExecutionContextPromotionListener executionContextPromotionListener() {
    ExecutionContextPromotionListener listener = <span class="keyword">new</span> ExecutionContextPromotionListener();
    listener.setKeys(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> { <span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span> });
    listener.setStrict(<span class="predefined-constant">true</span>);
    <span class="keyword">return</span> listener;
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1(JobRepository jobRepository,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">savePromotionalTasklet</span><span class="delimiter">&quot;</span></span>) SavePromotionalTasklet tasklet,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">executionContextPromotionListener</span><span class="delimiter">&quot;</span></span>) ExecutionContextPromotionListener listener,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> <span class="keyword">new</span> StepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step1</span><span class="delimiter">&quot;</span></span>, jobRepository)
            .tasklet(tasklet, transactionManager)
            .listener(listener)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step2(JobRepository jobRepository,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">confirmPromotionalTasklet</span><span class="delimiter">&quot;</span></span>) ConfirmPromotionalTasklet tasklet,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> <span class="keyword">new</span> StepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span>, jobRepository)
            .tasklet(tasklet, transactionManager)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Job jobPromotionalFlow(JobRepository jobRepository,
                              Step step1, Step step2) {
    <span class="keyword">return</span> <span class="keyword">new</span> JobBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow</span><span class="delimiter">&quot;</span></span>, jobRepository)
            .start(step1)
            .next(step2)
            .build();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock secondary">
<div class="title">XMLConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- import,annotation,component-scan definitions are omitted --&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">savePromotionalTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:listeners&gt;</span>
            <span class="tag">&lt;batch:listener&gt;</span>
                <span class="comment">&lt;!-- (3) --&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.listener.ExecutionContextPromotionListener</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:keys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listener&gt;</span>
        <span class="tag">&lt;/batch:listeners&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">confirmPromotionalTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>
<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 1. 実装内容の説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップ実行コンテキストの<code>ExecutionContext</code>に後続ステップに受け渡す値を設定する。
ここでは一連のデータ受け渡しに必要なキーとして、<code>promotion</code>を指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">先行ステップの(1)で設定された受け渡しデータを<code>ExecutionContext</code>から、
受け渡し元で指定されたキー<code>promotion</code>を用いて取得する。<br>
ここで使用している<code>ExecutionContext</code>は(1)のステップ実行コンテキストではなく、
ジョブ実行コンテキストである点に注意する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ExecutionContextPromotionListener</code>を用い、
ステップ実行コンテキストからジョブ実行コンテキストに受け渡しデータを移す。<br>
<code>setKeysメソッド/keys属性</code>には(1)で指定した受け渡しキーを指定する。<br>
<code>setStrictメソッド/strict属性</code>に<code>true</code>を設定することにより、ステップ実行コンテキストに存在しない場合は<code>IllegalArgumentException</code>がスローされる。
<code>false</code>の場合は受け渡しデータがなくても処理が継続する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">ExecutionContextPromotionListenerとステップ終了コードについて</div>
<div class="paragraph">
<p><code>ExecutionContextPromotionListener</code>はデータ受け渡し元のステップ終了コードが正常終了時(<code>COMPLETED</code>)の場合のみ、
ステップ実行コンテキストからジョブ実行コンテキストへデータを移す。<br>
後続ステップが継続して実行される終了コードのカスタマイズを行う場合、
<code>status</code>プロパティに終了コードを配列形式で指定すること。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Chunk"><a class="anchor" href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Chunk"></a>チャンクモデルを用いたステップ間のデータ受け渡し</h4>
<div class="paragraph">
<p><code>ItemProcessor</code>に<code>@AfterStep</code>、<code>@BeforeStep</code>アノテーションを付与したメソッドを使用する。
データ受け渡しに使用するリスナーと、<code>ExecutionContext</code>の使用方法はタスクレットと同様である。</p>
</div>
<div class="listingblock">
<div class="title">データ受け渡し元ItemProcessorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PromotionSourceItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(<span class="predefined-type">String</span> item) {
        <span class="comment">// omitted.</span>
    }

    <span class="annotation">@AfterStep</span>
    <span class="directive">public</span> ExitStatus afterStep(StepExecution stepExecution) {
        <span class="comment">// (1)</span>
        stepExecution.getExecutionContext().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">データ受け渡し先ItemProcessorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PromotionTargetItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(<span class="predefined-type">String</span> item) {
        <span class="comment">// omitted.</span>
    }

    <span class="annotation">@BeforeStep</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="comment">// (2)</span>
        <span class="predefined-type">Object</span> promotion = stepExecution.getJobExecution().getExecutionContext()
                .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>);
        <span class="comment">// omitted.</span>
    }
}</code></pre>
</div>
</div>
<div class="exampleblock primary">
<div class="title">JavaConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// (3)</span>
<span class="annotation">@Bean</span>
ExecutionContextPromotionListener executionContextPromotionListener() {
    ExecutionContextPromotionListener listener = <span class="keyword">new</span> ExecutionContextPromotionListener();
    listener.setKeys(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> { <span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span> });
    listener.setStrict(<span class="predefined-constant">true</span>);
    <span class="keyword">return</span> listener;
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1(JobRepository jobRepository,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">executionContextPromotionListener</span><span class="delimiter">&quot;</span></span>) ExecutionContextPromotionListener listener,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">listItemReader</span><span class="delimiter">&quot;</span></span>) ListItemReader&lt;<span class="predefined-type">String</span>&gt; reader,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotionSourceItemProcessor</span><span class="delimiter">&quot;</span></span>) ItemProcessor&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; processor,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotionLogItemWriter</span><span class="delimiter">&quot;</span></span>) ItemWriter&lt;<span class="predefined-type">String</span>&gt; writer,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    SimpleStepBuilder&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; builder
            = parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step1</span><span class="delimiter">&quot;</span></span>,
            jobRepository, reader, processor, writer, transactionManager);
    builder.listener(listener);
    <span class="keyword">return</span> builder.build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step2(JobRepository jobRepository,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">listItemReader</span><span class="delimiter">&quot;</span></span>) ListItemReader&lt;<span class="predefined-type">String</span>&gt; reader,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotionTargetItemProcessor</span><span class="delimiter">&quot;</span></span>) ItemProcessor&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; processor,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotionLogItemWriter</span><span class="delimiter">&quot;</span></span>) ItemWriter&lt;<span class="predefined-type">String</span>&gt; writer,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    SimpleStepBuilder&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; builder
            = parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span>,
            jobRepository, reader, processor, writer, transactionManager);
    <span class="keyword">return</span> builder.build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Job jobChunkPromotionalFlow(JobRepository jobRepository,
                                   Step step1, Step step2) {
    <span class="keyword">return</span> <span class="keyword">new</span> JobBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow</span><span class="delimiter">&quot;</span></span>, jobRepository)
            .start(step1)
            .next(step2)
            .build();
}

SimpleStepBuilder&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; parentStepBuilder(<span class="predefined-type">String</span> stepName,
                                                    JobRepository jobRepository,
                                                    ListItemReader&lt;<span class="predefined-type">String</span>&gt; reader,
                                                    ItemProcessor&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; processor,
                                                    ItemWriter&lt;<span class="predefined-type">String</span>&gt; writer,
                                                    PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> <span class="keyword">new</span> StepBuilder(stepName, jobRepository)
            .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; chunk(<span class="integer">1</span>, transactionManager)
            .reader(reader)
            .processor(processor)
            .writer(writer);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock secondary">
<div class="title">XMLConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- import,annotation,component-scan definitions are omitted --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sourceStep</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:listeners&gt;</span>
            <span class="tag">&lt;batch:listener&gt;</span>
                <span class="comment">&lt;!-- (3) --&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.listener.ExecutionContextPromotionListener</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:keys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listener&gt;</span>
        <span class="tag">&lt;/batch:listeners&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">targetStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- step definitions are omitted. --&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 2. 実装内容の説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップ実行コンテキストの<code>ExecutionContext</code>に後続ステップに受け渡す値を設定する。
ここでは一連のデータ受け渡しに必要なキーとして、<code>promotion</code>を指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">先行ステップの(1)で設定された受け渡しデータを<code>ExecutionContext</code>から、
受け渡し元で指定されたキー<code>promotion</code>を用いて取得する。<br>
ここで使用している<code>ExecutionContext</code>は(1)のステップ実行コンテキストではなく、
ジョブ実行コンテキストである点に注意する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ExecutionContextPromotionListener</code>を用い、
ステップ実行コンテキストからジョブ実行コンテキストに受け渡しデータを移す。<br>
プロパティの指定はタスクレットと同様である。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch08_FlowControll_HowToExtend"><a class="anchor" href="#Ch08_FlowControll_HowToExtend"></a>How to extend</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ここでは後続ステップの条件分岐と、条件により後続ステップ実行前にジョブを停止させる停止条件について説明する。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">ジョブ・ステップの終了コードとステータスの違い。</div>
<div class="paragraph">
<p>以降の説明では「ステータス」と「終了コード」という言葉が頻繁に登場する。<br>
これらの判別がつかない場合混乱を招く恐れがあるため、
まず<a href="Ch07_JobManagement.html#Ch07_JobManagement_HowToUse_ExitCode">"終了コードのカスタマイズ"</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="Ch08_FlowControll_HowToExtend_ConditionFlow"><a class="anchor" href="#Ch08_FlowControll_HowToExtend_ConditionFlow"></a>条件分岐</h3>
<div class="paragraph">
<p>条件分岐は先行ステップの実行結果となる終了コードを受けて、複数の後続ステップから1つを選択して継続実行させることを言う。<br>
いずれの後続ステップを実行させずにジョブを停止させる場合は後述の<a href="#Ch08_FlowControll_HowToExtend_StopConfig">"停止条件"</a>を参照。</p>
</div>
<div class="exampleblock primary">
<div class="title">JavaConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step stepA(JobRepository jobRepository,
                  SequentialFlowTasklet tasklet,
                  ChangeExitCodeReturnListener listener,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepA</span><span class="delimiter">&quot;</span></span>, jobRepository,
            tasklet, listener, transactionManager)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step stepB(JobRepository jobRepository,
                  SequentialFlowTasklet tasklet,
                  ChangeExitCodeReturnListener listener,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepB</span><span class="delimiter">&quot;</span></span>, jobRepository,
            tasklet, listener, transactionManager)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step stepC(JobRepository jobRepository,
                  SequentialFlowTasklet tasklet,
                  ChangeExitCodeReturnListener listener,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepC</span><span class="delimiter">&quot;</span></span>, jobRepository,
            tasklet, listener, transactionManager)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Job jobConditionalFlow(JobRepository jobRepository, Step stepA,
                              Step stepB, Step stepC) {
    <span class="keyword">return</span> <span class="keyword">new</span> JobBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow</span><span class="delimiter">&quot;</span></span>, jobRepository)
            .start(stepA)
            .on(FlowExecutionStatus.COMPLETED.getName()).to(stepB) <span class="comment">// (1) (2)</span>
            .from(stepA)
            .on(FlowExecutionStatus.FAILED.getName()).to(stepC) <span class="comment">// (1) (3)</span>
            .end()
            .build();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock secondary">
<div class="title">XMLConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepA</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">conditionalFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepB</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepB</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">conditionalFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">conditionalFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 3. 実装内容の説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">シーケンシャルフローのように<code>nextメソッド/next属性</code>を指定させず、
<code>nextメソッド/&lt;batch:next&gt;要素</code>を複数置くことで、<code>toメソッド/to属性</code>で指定される後続ステップに振り分けることができる。<br>
<code>onメソッド/on属性</code>には遷移条件となるステップの終了コードを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)のステップ終了コードが<code>COMPLETED</code>の場合のみに実行される後続ステップとなる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)のステップ終了コードが<code>FAILED</code>の場合のみに実行される後続ステップとなる。<br>
この指定が行われることで先行ステップ処理失敗時にジョブが停止せず、回復処理などの後続ステップが実行される。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">後続ステップによる回復処理の注意点</div>
<div class="paragraph">
<p>先行ステップの処理失敗(終了コードが<code>FAILED</code>)により後続ステップの回復処理が行われた場合、
回復処理の成否を問わず先行ステップのステータスは<code>ABANDONED</code>となり、リスタート不能となる。</p>
</div>
<div class="paragraph">
<p>後続ステップの回復処理が失敗した場合にジョブをリスタートすると、回復処理のみが再実行される。<br>
このため、先行ステップを含めて処理をやり直す場合は別のジョブ実行としてリランさせる必要がある。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch08_FlowControll_HowToExtend_StopConfig"><a class="anchor" href="#Ch08_FlowControll_HowToExtend_StopConfig"></a>停止条件</h3>
<div class="paragraph">
<p>先行ステップの終了コードに応じ、ジョブを停止させる方法を説明する。<br>
停止の手段として、以下の3つの要素を指定する方法がある。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>end</code></p>
</li>
<li>
<p><code>fail</code></p>
</li>
<li>
<p><code>stop</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>これらの終了コードが先行ステップに該当する場合は後続ステップが実行されない。<br>
また、同一ステップ内にそれぞれ複数指定が可能である。</p>
</div>
<div class="exampleblock primary">
<div class="title">JavaConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TaskletStepBuilder parentStepBuilder(<span class="predefined-type">String</span> stepName,
                                     JobRepository jobRepository,
                                     SequentialFlowTasklet tasklet,
                                     ChangeExitCodeReturnListener listener,
                                     PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> <span class="keyword">new</span> StepBuilder(stepName, jobRepository)
            .listener(listener)
            .tasklet(tasklet, transactionManager);
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1(JobRepository jobRepository,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlowTasklet</span><span class="delimiter">&quot;</span></span>) SequentialFlowTasklet tasklet,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">changeExitCodeReturnListener</span><span class="delimiter">&quot;</span></span>) ChangeExitCodeReturnListener listener,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step1</span><span class="delimiter">&quot;</span></span>, jobRepository, tasklet,
            listener, transactionManager)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step2(JobRepository jobRepository,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlowTasklet</span><span class="delimiter">&quot;</span></span>) SequentialFlowTasklet tasklet,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">changeExitCodeReturnListener</span><span class="delimiter">&quot;</span></span>) ChangeExitCodeReturnListener listener,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step2</span><span class="delimiter">&quot;</span></span>, jobRepository, tasklet,
            listener, transactionManager)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step3(JobRepository jobRepository,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlowTasklet</span><span class="delimiter">&quot;</span></span>) SequentialFlowTasklet tasklet,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">changeExitCodeReturnListener</span><span class="delimiter">&quot;</span></span>) ChangeExitCodeReturnListener listener,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step3</span><span class="delimiter">&quot;</span></span>, jobRepository, tasklet,
            listener, transactionManager)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step4(JobRepository jobRepository,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlowTasklet</span><span class="delimiter">&quot;</span></span>) SequentialFlowTasklet tasklet,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">changeExitCodeReturnListener</span><span class="delimiter">&quot;</span></span>) ChangeExitCodeReturnListener listener,
                  <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step4</span><span class="delimiter">&quot;</span></span>, jobRepository, tasklet,
            listener, transactionManager)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Job jobStopFlow(JobRepository jobRepository,
                       <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExitCodeChangeListener</span><span class="delimiter">&quot;</span></span>) JobExitCodeChangeListener listener,
                       Step step1, Step step2, Step step3, Step step4) {
    <span class="keyword">return</span> <span class="keyword">new</span> JobBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow</span><span class="delimiter">&quot;</span></span>, jobRepository)
            .start(step1)
            .listener(listener)
            .on(<span class="string"><span class="delimiter">&quot;</span><span class="content">END_WITH_NO_EXIT_CODE</span><span class="delimiter">&quot;</span></span>).end()
            .from(step1).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">END_WITH_EXIT_CODE</span><span class="delimiter">&quot;</span></span>).end(<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED_CUSTOM</span><span class="delimiter">&quot;</span></span>)
            .from(step1).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>).to(step2)
            .from(step2).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_FAIL_WITH_NO_EXIT_CODE</span><span class="delimiter">&quot;</span></span>).fail()
            .from(step2).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_FAIL_WITH_EXIT_CODE</span><span class="delimiter">&quot;</span></span>).fail()
            .from(step2).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>).to(step3)
            .from(step3).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_STOP</span><span class="delimiter">&quot;</span></span>).stopAndRestart(step4)
            .from(step3).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_STOP_WITH_EXIT_CODE</span><span class="delimiter">&quot;</span></span>)
            .stopAndRestart(step4)
            .from(step3).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>).to(step4)
            .end()
            .build();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock secondary">
<div class="title">XMLConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;batch:end</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">END_WITH_NO_EXIT_CODE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:end</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">END_WITH_EXIT_CODE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exit-code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED_CUSTOM</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;batch:fail</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_FAIL_WITH_NO_EXIT_CODE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:fail</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_FAIL_WITH_EXIT_CODE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exit-code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED_CUSTOM</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;batch:stop</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_STOP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restart</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 4. ジョブの停止の設定内容説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onメソッドの引数pattern/&lt;batch:end&gt;要素のon属性</code>とステップ終了コードが一致した場合、ジョブは正常終了
(ステータス：<code>COMPLETED</code>)として<code>JobRepository</code>に記録される。<br>
<code>endメソッドの引数status/exit-code属性</code>を付与した場合、ジョブの終了コードをデフォルトの<code>COMPLETED</code>からカスタマイズすることができる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onメソッドの引数pattern/&lt;batch:next&gt;要素のon属性</code>にワイルドカード(<code>*</code>)を指定することで、<code>end</code>、<code>fail</code>、
<code>stop</code>いずれの終了コードにも該当しない場合に後続ジョブを継続させることができる。<br>
ここではステップ要素内の最後に記述しているが、終了コードの一致条件が先に評価されるため、
要素の並び順はステップ要素内であれば任意である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>failメソッド/&lt;batch:fail&gt;要素</code>を使用した場合、ジョブは異常終了(ステータス：<code>FAILED</code>)として<code>JobRepository</code>に記録される。<br>
<code>&lt;batch:end&gt;</code>と同様、<code>exit-code</code>属性を付与することで、ジョブの終了コードをデフォルトの<code>FAILED</code>からカスタマイズすることができる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stopAndRestartメソッド/&lt;batch:stop&gt;要素</code>を使用した場合、ステップの正常終了時にジョブは中断(ステータス：<code>STOPPED</code>)として<code>JobRepository</code>に記録される。<br>
<code>stopAndRestartメソッドの引数restart/restart属性</code>はリスタート時に中断状態からジョブが再開されるステップを指定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">exit-code属性による終了コードのカスタマイズ時は漏れなくプロセス終了コードにマッピングさせること。</div>
<div class="paragraph">
<p>詳細は<a href="Ch07_JobManagement.html#Ch07_JobManagement_HowToUse_ExitCode">"終了コードのカスタマイズ"</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch08_FlowControll_Appendix"><a class="anchor" href="#Ch08_FlowControll_Appendix"></a>Appendix</h2>
<div class="sectionbody">
<div class="sect3">
<h4 id="Ch08_FlowControll_Appendix_FlowDefinition"><a class="anchor" href="#Ch08_FlowControll_Appendix_FlowDefinition"></a>外部でのフロー定義方法</h4>
<div class="paragraph">
<p><code>Bean定義したFlow/&lt;batch:flow&gt;</code>を利用して、フロー定義を外部に切り出すことができる。<br>
以下に<code>Bean定義したFlow/&lt;batch:flow&gt;</code>を利用して、3つのステップからなるジョブのシーケンシャルフローを設定する例を示す。</p>
</div>
<div class="exampleblock primary">
<div class="title">JavaConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step01outer(JobRepository jobRepository,
                        SequentialFlowTasklet tasklet,
                        <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step1</span><span class="delimiter">&quot;</span></span>, jobRepository,
            tasklet, transactionManager)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step02outer(JobRepository jobRepository,
                        SequentialFlowTasklet tasklet,
                        <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step2</span><span class="delimiter">&quot;</span></span>, jobRepository,
            tasklet, transactionManager)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step03outer(JobRepository jobRepository,
                        SequentialFlowTasklet tasklet,
                        <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>) PlatformTransactionManager transactionManager) {
    <span class="keyword">return</span> parentStepBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step3</span><span class="delimiter">&quot;</span></span>, jobRepository,
            tasklet, transactionManager)
            .build();
}

<span class="comment">// (2)</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> Flow outerFlow(Step step01outer, Step step02outer,
                      Step step03outer) {
    <span class="keyword">return</span> <span class="keyword">new</span> FlowBuilder&lt;Flow&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">outerFlow</span><span class="delimiter">&quot;</span></span>)
            .from(step01outer)
            .next(step02outer)
            .next(step03outer)
            .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Job jobSequentialOuterFlow(JobRepository jobRepository,
                                  Flow outerFlow) {
    <span class="keyword">return</span> <span class="keyword">new</span> JobBuilder(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow</span><span class="delimiter">&quot;</span></span>, jobRepository)
            .start(outerFlow) <span class="comment">// (1)</span>
            .end()
            .build();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock secondary">
<div class="title">XMLConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:flow</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">innerFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outerFlow</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;batch:flow</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outerFlow</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step1</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step2</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step2</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step3</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step3</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:flow&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobBuilderのstartメソッド/parent属性</code>に(2)で定義したフローのidを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">シーケンシャルフローを定義する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>これにより、 以下の順でステップが直列に起動する。<br>
<code>jobSequentialFlow.step1</code> &#8594; <code>jobSequentialFlow.step2</code> &#8594; <code>jobSequentialFlow.step3</code></p>
</div>
</div>
</div>
</div>
</div>
<div class="container">

  <div class="common-bg">
    <div class="information">
      Macchinetta Batch Framework (2.x) Development Guideline - version 2.6.0.RELEASE, 2025-3-28
    </div>
    <div class="index">
      <a href="index.html">&gt; INDEX</a>
    </div>
  </div>

  <div class="footer-bg">
    <div class="copyright">
      &copy; Copyright 2017 NTT Corporation.
    </div>
  </div>

</div>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>ファイルアクセスでデータ入出力を行うジョブ</title>
<link rel="stylesheet" href="./theme/css/readthedocs.css">
<link rel="stylesheet" href="./theme/css/font-awesome.min.css">
<link rel="stylesheet" href="./theme/css/coderay-asciidoctor.css">
<link rel="stylesheet" href="./theme/css/header-footer.css">
<title>Macchinetta Batch Framework (2.x) Development Guideline</title>

<div class="common-bg">
  <div class="information">
    Macchinetta Batch Framework (2.x) Development Guideline - version 2.1.1.RELEASE, 2019-3-26
  </div>
  <div class="index">
    <a href="index.html">&gt; INDEX</a>
  </div>
</div>
</head>
<body id="Ch09_Impl_FileAccessJob" class="book toc2 toc-left">
<div id="header">
<h1>ファイルアクセスでデータ入出力を行うジョブ</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#Ch09_Impl_FileAccessJob_Overview">概要</a>
<ul class="sectlevel2">
<li><a href="#Ch09_Impl_FileAccessJob_Overview_Background">背景</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Overview_ProcessOverview">処理概要</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Overview_BusinessSpecification">業務仕様</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Overview_FileSpecification">ファイル仕様</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Overview_JobOverview">ジョブの概要</a></li>
</ul>
</li>
<li><a href="#Ch09_Impl_FileAccessJob_Chunk">チャンクモデルでの実装</a>
<ul class="sectlevel2">
<li><a href="#Ch09_Impl_FileAccessJob_Chunk_JobDefinition">ジョブBean定義ファイルの作成</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Chunk_Dto">DTOの実装</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Chunk_FileAccess">ファイルアクセスの定義</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Chunk_Logic">ロジックの実装</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Impl_FileAccessJob_Chunk_Logic_ItemProcessor">PointAddItemProcessorクラスの実装</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Chunk_Logic_Bean">ジョブBean定義ファイルの設定</a></li>
</ul>
</li>
<li><a href="#Ch09_Impl_FileAccessJob_Chunk_Execution">ジョブの実行と結果の確認</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Console">コンソールログの確認</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Exitcode">終了コードの確認</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Chunk_Execution_OutputFile">会員情報ファイルの確認</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch09_Impl_FileAccessJob_Tasklet">タスクレットモデルでの実装</a>
<ul class="sectlevel2">
<li><a href="#Ch09_Impl_FileAccessJob_Tasklet_JobDefinition">ジョブBean定義ファイルの作成</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Tasklet_Dto">DTOの実装</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Tasklet_FileAccess">ファイルアクセスの定義</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Tasklet_Logic">ロジックの実装</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Impl_FileAccessJob_Tasklet_Logic_Tasklet">PointAddTaskletクラスの実装</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Tasklet_Logic_Bean">ジョブBean定義ファイルの設定</a></li>
</ul>
</li>
<li><a href="#Ch09_Impl_FileAccessJob_Tasklet_Execution">ジョブの実行と結果の確認</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Impl_FileAccessJob_Tasklet_Execution_Run">実行構成からジョブを実行</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Tasklet_Execution_Console">コンソールログの確認</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Tasklet_Execution_Exitcode">終了コードの確認</a></li>
<li><a href="#Ch09_Impl_FileAccessJob_Tasklet_Execution_OutputFile">会員情報ファイルの確認</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="Ch09_Impl_FileAccessJob_Overview"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Overview"></a>概要</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ファイルアクセスでデータ入出力を行うジョブを作成する。</p>
</div>
<div class="paragraph">
<p>なお、本節はMacchinetta Batch 2.x 開発ガイドラインを元に説明しているため、
詳細については<a href="Ch05_FileAccess.html#Ch05_FileAccess">ファイルアクセス</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p><a href="Ch09_TutorialApplication.html#Ch09_TutorialApplication">作成するアプリケーションの説明</a>の
背景、処理概要、業務仕様を以下に再掲する。</p>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Overview_Background"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Overview_Background"></a>背景</h3>
<div class="paragraph">
<p>とある量販店では、会員に対してポイントカードを発行している。<br>
会員には「ゴールド会員」「一般会員」の会員種別が存在し、会員種別に応じたサービスを提供している。<br>
今回そのサービスの一環として、月内に商品を購入した会員のうち、
会員種別が「ゴールド会員」の場合は100ポイント、「一般会員」の場合は10ポイントを月末に加算することにした。</p>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Overview_ProcessOverview"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Overview_ProcessOverview"></a>処理概要</h3>
<div class="paragraph">
<p>会員種別に応じてポイント加算を行うアプリケーションを
月次バッチ処理としてMacchinetta Batch 2.xを使用して実装する。</p>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Overview_BusinessSpecification"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Overview_BusinessSpecification"></a>業務仕様</h3>
<div class="paragraph">
<p>業務仕様は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>商品購入フラグが"1"(処理対象)の場合に、会員種別に応じてポイントを加算する</p>
<div class="ulist">
<ul>
<li>
<p>会員種別が"G"(ゴールド会員)の場合は100ポイント、"N"(一般会員)の場合は10ポイント加算する</p>
</li>
</ul>
</div>
</li>
<li>
<p>商品購入フラグはポイント加算後に"0"(初期状態)に更新する</p>
</li>
<li>
<p>ポイントの上限値は1,000,000ポイントとする</p>
</li>
<li>
<p>ポイント加算後に1,000,000ポイントを超えた場合は、1,000,000ポイントに補正する</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Overview_FileSpecification"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Overview_FileSpecification"></a>ファイル仕様</h3>
<div class="paragraph">
<p>入出力リソースとなる会員情報ファイルの仕様は以下のとおり。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">会員情報ファイル(可変長CSV形式)</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 15%;">
<col style="width: 10%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">フィールド名</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">桁数</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員を一意に示す8桁固定の番号を表す。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の種別を以下のとおり表す。<br>
"G"(ゴールド会員)、"N"(一般会員)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">月内に商品を買ったかどうかを表す。<br>
商品購入で"1"(処理対象)、月次バッチ処理で"0"(初期状態)に更新される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイント</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">数値</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の保有するポイントを表す。<br>
初期値は0。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>このチュートリアルではヘッダレコード、フッタレコードは扱わないこととしているため、
ヘッダレコード、フッタレコードの扱いやファイルフォーマットについては、
<a href="Ch05_FileAccess.html#Ch05_FileAccess">ファイルアクセス</a>を参照してほしい。</p>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Overview_JobOverview"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Overview_JobOverview"></a>ジョブの概要</h3>
<div class="paragraph">
<p>ここで作成するファイルアクセスでデータ入出力を行うジョブの概要を把握するために、
処理フローおよび処理シーケンスを以下に示す。</p>
</div>
<div class="paragraph">
<p>処理シーケンスではトランザクション制御の範囲について触れているが、ファイルの場合は擬似的なトランザクション制御を行うことで実現している。
詳細は、<a href="Ch05_Transaction.html#Ch05_Transaction_HowToUse_SingleDataSource_NonTx">非トランザクショナルなデータソースに対する補足</a>を参照のこと。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">処理フロー概要</dt>
<dd>
<p>処理フローの概要を以下に示す。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/FileAccess/Ch09_FileAccessJob_ProcessFlow.png" alt="ProcessFlow of FileAccess Job">
</div>
<div class="title">ファイルアクセスジョブの処理フロー</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンクモデルの場合の処理シーケンス</dt>
<dd>
<p>チャンクモデルの場合の処理シーケンスを説明する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_FileAccessJob_ProcessSequence_ChunkModel.png" alt="ProcessSequence of FileAccess Job by ChunkModel">
</div>
<div class="title">チャンクモデルのシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
</li>
<li>
<p>ステップは、入力リソースをオープンする。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、member_info(input)ファイルをオープンする。</p>
</li>
<li>
<p>ステップは、出力リソースをオープンする。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、member_info(output)ファイルをオープンする。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで6から16の処理を繰り返す。</p>
</li>
<li>
<p>チャンク単位で、フレームワークトランザクション(擬似的)を開始する。</p>
</li>
<li>
<p>チャンクサイズに達するまで6から12までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは、<code>FlatFileItemReader</code>から入力データを1レコード取得する。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、member_info(input)ファイルから入力データを1レコード取得する。</p>
</li>
<li>
<p>member_info(input)ファイルは、<code>FlatFileItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、ステップに入力データを返却する。</p>
</li>
<li>
<p>ステップは、<code>PointAddItemProcessor</code>で入力データに対して処理を行う。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、入力データを読み込んでポイント加算処理を行う。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、ステップに処理結果を返却する。</p>
</li>
<li>
<p>ステップは、チャンクサイズ分のデータを<code>FlatFileItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、処理結果をバッファリングする。</p>
</li>
<li>
<p>ステップは、フレームワークトランザクション(擬似的)をコミットする。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、フラッシュしてバッファ内のデータをmember_info(output)ファイルに書き込む。</p>
</li>
<li>
<p>ステップは、入力リソースをクローズする。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、member_info(input)ファイルをクローズする。</p>
</li>
<li>
<p>ステップは、出力リソースをクローズする。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、member_info(output)ファイルをクローズする。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは正常終了:0)を返却する。</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">タスクレットモデルの場合の処理シーケンス</dt>
<dd>
<p>タスクレットモデルの場合の処理シーケンスについて説明する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_FileAccessJob_ProcessSequence_TaskletModel.png" alt="ProcessSequence of FileAccess Job by TaskletModel">
</div>
<div class="title">タスクレットモデルのシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
<div class="ulist">
<ul>
<li>
<p>ステップはフレームワークトランザクション(擬似的)を開始する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは<code>PointAddTasklet</code>を実行する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、入力リソースをオープンする。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、member_info(input)ファイルをオープンする。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、出力リソースをオープンする。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、member_info(output)ファイルをオープンする。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで7から13までの処理を繰り返す。</p>
</li>
<li>
<p>一定件数に達するまで7から11までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>PointAddTasklet</code>は、<code>FlatFileItemReader</code>から入力データを1レコード取得する。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、member_info(input)ファイルから入力データを1レコード取得する。</p>
</li>
<li>
<p>member_info(input)ファイルは、<code>FlatFileItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、タスクレットに入力データを返却する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、入力データを読み込んでポイント加算処理を行う。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、一定件数分のデータを<code>FlatFileItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、処理結果をバッファリングする。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、入力リソースをクローズする。</p>
</li>
<li>
<p><code>FlatFileItemReader</code>は、member_info(input)ファイルをクローズする。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、出力リソースをクローズする。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、ステップへ処理終了を返却する。</p>
</li>
<li>
<p>ステップは、フレームワークトランザクション(擬似的)をコミットする。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、フラッシュしてバッファ内のデータをmember_info(output)ファイルに書き込む。</p>
</li>
<li>
<p><code>FlatFileItemWriter</code>は、member_info(output)ファイルをクローズする。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは正常終了:0)を返却する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>以降で、チャンクモデル、タスクレットモデルそれぞれの実装方法を説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk">チャンクモデルでの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet">タスクレットモデルでの実装</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch09_Impl_FileAccessJob_Chunk"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk"></a>チャンクモデルでの実装</h2>
<div class="sectionbody">
<div class="paragraph">
<p>チャンクモデルでのファイルアクセスでデータ入出力を行うジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_JobDefinition">ジョブBean定義ファイルの作成</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_Dto">DTOの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_FileAccess">ファイルアクセスの定義</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_Logic">ロジックの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Chunk_JobDefinition"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_JobDefinition"></a>ジョブBean定義ファイルの作成</h3>
<div class="paragraph">
<p>Bean定義ファイルにて、チャンクモデルでのファイルアクセスでデータ入出力を行うジョブを構成する要素の組み合わせ方を設定する。<br>
ここでは、Bean定義ファイルの枠および共通的な設定のみ記述し、以降の項で各構成要素の設定を行う。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/fileaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.fileaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Macchinetta Batch 2.xを利用する際に、常に必要なBean定義を読み込む設定をインポートする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャン対象とするベースパッケージの設定を行う。<br>
<code>base-package</code>属性に、使用するコンポーネント(ItemProcessorの実装クラスなど)が格納されているパッケージを指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Chunk_Dto"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Dto"></a>DTOの実装</h3>
<div class="paragraph">
<p>業務データを保持するためのクラスとしてDTOクラスを実装する。<br>
DTOクラスはファイルごとに作成する。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="paragraph">
<p>以下のとおり、変換対象クラスとしてDTOクラスを実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.dto.MemberInfoDTO</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.dto</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MemberInfoDto</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> id; <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> type; <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> status; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="type">int</span> point; <span class="comment">// (4)</span>

    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> id;
    }

    <span class="directive">public</span> <span class="type">void</span> setId(<span class="predefined-type">String</span> id) {
        <span class="local-variable">this</span>.id = id;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getType() {
        <span class="keyword">return</span> type;
    }

    <span class="directive">public</span> <span class="type">void</span> setType(<span class="predefined-type">String</span> type) {
        <span class="local-variable">this</span>.type = type;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getStatus() {
        <span class="keyword">return</span> status;
    }

    <span class="directive">public</span> <span class="type">void</span> setStatus(<span class="predefined-type">String</span> status) {
        <span class="local-variable">this</span>.status = status;
    }

    <span class="directive">public</span> <span class="type">int</span> getPoint() {
        <span class="keyword">return</span> point;
    }

    <span class="directive">public</span> <span class="type">void</span> setPoint(<span class="type">int</span> point) {
        <span class="local-variable">this</span>.point = point;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号に対応するフィールドとして<code>id</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別に対応するフィールドとして<code>type</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグに対応するフィールドとして<code>status</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイントに対応するフィールドとして<code>point</code>を定義する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Chunk_FileAccess"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_FileAccess"></a>ファイルアクセスの定義</h3>
<div class="paragraph">
<p>ファイルアクセスでデータ入出力するためのジョブBean定義ファイルの設定を行う。</p>
</div>
<div class="paragraph">
<p>ItemReader、ItemWriterの設定として、ジョブBean定義ファイルに以下の(1)以降を追記する。<br>
ここで触れていない設定内容については、<a href="Ch05_FileAccess.html#Ch05_FileAccess_HowToUse_VariableLength_Input">可変長レコードの入力</a>
および<a href="Ch05_FileAccess.html#Ch05_FileAccess_HowToUse_VariableLength_Output">可変長レコードの出力</a>を参照のこと。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/fileaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.fileaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (1) (2) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:quoteCharacter</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (4) (5) --&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (6) --&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- (7) (8) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (9) --&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (10) --&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (11) --&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (12) --&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReaderの設定を行う。<br>
<code>class</code>属性に、Spring Batchが提供するフラットファイルを読み込むための<code>ItemReader</code>の実装クラスである
<code>org.springframework.batch.item.file.FlatFileItemReader</code>を指定する。<br>
<code>scope</code>属性に、<code>step</code>スコープを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource</code>属性に入力ファイルのパスを設定する。<br>
パスは直接指定することも可能であるが、ここでは、ジョブ起動時にパラメータで渡すようにするため、
入力ファイルパスのパラメータ名を指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineTokenizerの設定を行う。<br>
<code>class</code>属性に、Spring Batchが提供する区切り文字を指定してレコードを分割する<code>LineTokenizer</code>の実装クラスである
<code>org.springframework.batch.item.file.transform.DelimitedLineTokenizer</code>を指定する。<br>
CSV形式の一般的書式とされるRFC-4180の仕様に定義されている、エスケープされた改行、区切り文字、囲み文字の読み込みに対応している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>names</code>属性に、1レコードの各項目に付与する名前を設定する。<br>
<code>FieldSetMapper</code>で使われる<code>FieldSet</code>で設定した名前を用いて各項目を取り出すことができるようになる。<br>
レコードの先頭から各名前をカンマ区切りで指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delimiter</code>属性に、区切り文字としてカンマを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fieldSetMapper</code>の設定を行う。<br>
今回は文字列や数字など特別な変換処理が不要なため、
<code>class</code>属性に、<code>org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</code>を指定する。<br>
<code>targetType</code>属性には、変換対象クラスとして<a href="#Ch09_Impl_FileAccessJob_Chunk_Dto">DTOの実装</a>で作成したDTOクラスを指定する。
これにより、(4)で設定した各項目の名前と一致するフィールドに値を自動的に設定したインスタンスを生成する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriterの設定を行う。<br>
<code>class</code>属性に、Spring Batchが提供するフラットファイルへ書き込むための<code>ItemWriter</code>の実装クラスである
<code>org.springframework.batch.item.file.FlatFileItemWriter</code>を指定する。<br>
<code>scope</code>属性に、<code>step</code>スコープを指定する。<br>
このチュートリアルでは、<code>appendAllowed</code>属性は<code>false</code>(追記しない)、<code>shouldDeleteIfExists</code>属性は<code>true</code>(既存ファイルを削除する)を指定して
ジョブを何度実行しても新規にファイルが作成されるようにする。<br>
<code>transactional</code>属性に、<code>true</code>を指定して、擬似的トランザクション制御を有効にする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource</code>属性に出力ファイルのパスを設定する。<br>
ジョブ起動時にパラメータで渡すようにするため、出力ファイルパスのパラメータ名を指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lineAggregator</code>の設定を行う。<br>
<code>class</code>属性に、対象Beanを1レコードへマッピングするための<code>org.springframework.batch.item.file.transform.LineAggregator</code>を指定する。<br>
Beanのプロパティとレコード内の各項目とのマッピングは<code>FieldExtractor</code>で行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delimiter</code>属性に、区切り文字としてカンマを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fieldExtractor</code>の設定を行う。<br>
 (12)で指定する各項目の名前に(6)で指定したDTOクラスのフィールドと一致する値をマッピングする。 <br>
<code>class</code>属性に、<code>org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</code>を指定する。<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>names</code>属性に、1レコードの各項目に付与する名前を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Chunk_Logic"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Logic"></a>ロジックの実装</h3>
<div class="paragraph">
<p>ポイント加算処理を行うビジネスロジッククラスを実装する。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_Logic_ItemProcessor">PointAddItemProcessorクラスの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Chunk_Logic_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_FileAccessJob_Chunk_Logic_ItemProcessor"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Logic_ItemProcessor"></a>PointAddItemProcessorクラスの実装</h4>
<div class="paragraph">
<p>ItemProcessorインタフェースを実装したPointAddItemProcessorクラスを実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.fileaccess.chunk.PointAddItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.fileaccess.chunk</span>;

<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemProcessor</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;
<span class="keyword">import</span> <span class="include">com.example.batch.tutorial.common.dto.MemberInfoDto</span>;

<span class="annotation">@Component</span> <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PointAddItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;MemberInfoDto, MemberInfoDto&gt; { <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> TARGET_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> INITIAL_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (4)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> GOLD_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">G</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (5)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NORMAL_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">N</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (6)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> MAX_POINT = <span class="integer">1000000</span>; <span class="comment">// (7)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> MemberInfoDto process(MemberInfoDto item) <span class="directive">throws</span> <span class="exception">Exception</span> { <span class="comment">// (8) (9) (10)</span>
        <span class="keyword">if</span> (TARGET_STATUS.equals(item.getStatus())) {
            <span class="keyword">if</span> (GOLD_MEMBER.equals(item.getType())) {
                item.setPoint(item.getPoint() + <span class="integer">100</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (NORMAL_MEMBER.equals(item.getType())) {
                item.setPoint(item.getPoint() + <span class="integer">10</span>);
            }

            <span class="keyword">if</span> (item.getPoint() &gt; MAX_POINT) {
                item.setPoint(MAX_POINT);
            }

            item.setStatus(INITIAL_STATUS);
        }

        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャンの対象とするため、<code>@Component</code>アノテーションを付与してBean定義を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入出力で使用するオブジェクトの型をそれぞれ型引数に指定した<code>ItemProcessor</code>インタフェースを実装する。<br>
ここでは、入出力で使用するオブジェクトは共に<a href="#Ch09_Impl_FileAccessJob_Chunk_Dto">DTOの実装</a>で作成した<code>MemberInfoDTO</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイント加算対象とする商品購入フラグ:1を定義する。<br>
本来、このようなフィールド定数は定数クラスなどに定義し、ロジックに定義することはあまりない。
このチュートリアルでは、便宜上、定数として定義していることを留意すること。(以降の定数も同様)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、商品購入フラグの初期値:0を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員区分:G(ゴールド会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員区分:N(一般会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイントの上限値:1000000を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグおよび、会員種別に応じてポイント加算するビジネスロジックを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">返り値の型は、このクラスで実装している<code>ItemProcessor</code>インタフェースの型引数で指定した
出力オブジェクトの型である<code>MemberInfoDTO</code>とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数として受け取る<code>item</code>の型は、
このクラスで実装している<code>ItemProcessor</code>インタフェースの型引数で指定した入力オブジェクトの型である<code>MemberInfoDTO</code>とする。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_FileAccessJob_Chunk_Logic_Bean"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Logic_Bean"></a>ジョブBean定義ファイルの設定</h4>
<div class="paragraph">
<p>作成したビジネスロジックをジョブとして設定するため、ジョブBean定義ファイルに以下の(1)以降を追記する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/fileaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.fileaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:quoteCharacter</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddChunk</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddChunk.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pointAddItemProcessor</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;/batch:tasklet&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要がある。<br>
ここでは、チャンクモデルのジョブ名として<code>jobPointAddChunk</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要はないが、障害発生時に追跡しやすくなる等の様々なメリットがあるため一意とする。<br>
特別な理由がない限り、(1)で指定したid属性に[step+連番]を付加する形式とする。<br>
ここでは、チャンクモデルのジョブのステップ名として<code>jobPointAddChunk.step01</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンクモデルジョブの設定を行う。<br>
<code>reader</code>、<code>writer</code>それぞれの属性に、前項までに定義した<code>ItemReader</code>、<code>ItemWriter</code>のBeanIDを指定する。<br>
<code>processor</code>属性に、ItemProcessorの実装クラスのBeanIDである<code>pointAddItemProcessor</code>を指定する。<br>
<code>commit-interval</code>属性に、1チャンクあたりの入力データ件数を10件として設定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">commit-intervalのチューニング</div>
<div class="paragraph">
<p>commit-intervalはチャンクモデルジョブにおける、性能上のチューニングポイントである。</p>
</div>
<div class="paragraph">
<p>このチュートリアルでは10件としているが、利用できるマシンリソースやジョブの特性によって適切な件数は異なる。
複数のリソースにアクセスしてデータを加工するジョブであれば10件から100件程度で処理スループットが頭打ちになることもある。
一方、入出力リソースが1:1対応しておりデータを移し替える程度のジョブであれば5,000件や10,000件でも処理スループットが伸びることがある。</p>
</div>
<div class="paragraph">
<p>ジョブ実装時のcommit-intervalは100件程度で仮置きしておき、 その後に実施した性能測定の結果に応じてジョブごとにチューニングするとよい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Chunk_Execution"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Execution"></a>ジョブの実行と結果の確認</h3>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_FileAccessJob_Chunk_Execution_Run"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Run"></a>実行構成からジョブを実行</h4>
<div class="paragraph">
<p>以下のとおり実行構成を作成し、ジョブを実行する。<br>
実行構成の作成手順は<a href="Ch09_EnvironmentConstruction.html#Ch09_EnvironmentConstruction_OperationCheck">動作確認</a>を参照。</p>
</div>
<div class="paragraph">
<p>ここでは、正常系データを利用してジョブを実行する。<br>
Argumentsタブに入出力ファイルのパラメータを引数として追加する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">実行構成の設定値</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Name: 任意の名称(例: Run FileAccessJob for ChunkModel)</p>
</li>
<li>
<p>Mainタブ</p>
<div class="ulist">
<ul>
<li>
<p>Project: <code>macchinetta-batch-tutorial</code></p>
</li>
<li>
<p>Main class: <code>org.springframework.batch.core.launch.support.CommandLineJobRunner</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Argumentsタブ</p>
<div class="ulist">
<ul>
<li>
<p>Program arguments: <code>META-INF/jobs/fileaccess/jobPointAddChunk.xml jobPointAddChunk inputFile=files/input/input-member-info-data.csv outputFile=files/output/output-member-info-data.csv</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_FileAccessJob_Chunk_Execution_Console"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Console"></a>コンソールログの確認</h4>
<div class="paragraph">
<p>Consoleに以下の内容のログが出力されていることを確認する。</p>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/08/18 11:09:19] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddChunk]] completed with the following parameters: [{inputFile=files/input/input-member-info-data.csv, outputFile=files/output/output-member-info-data.csv, jsr_batch_run_id=386}] and the following status: [COMPLETED]
[2017/08/18 11:09:19] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@735f7ae5: startup date [Fri Aug 18 11:09:12 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_FileAccessJob_Chunk_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Execution_Exitcode"></a>終了コードの確認</h4>
<div class="paragraph">
<p>終了コードにより、正常終了したことを確認する。<br>
確認手順は<a href="Ch09_EnvironmentConstruction.html#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が0(正常終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/FileAccess/Ch09_FileAccessJob_Confirm_ExitCode_ChunkModel.png" alt="Confirm the Exit Code of FileAccess for ChunkModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_FileAccessJob_Chunk_Execution_OutputFile"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Chunk_Execution_OutputFile"></a>会員情報ファイルの確認</h4>
<div class="paragraph">
<p>会員情報ファイルの入出力内容を比較し、確認内容のとおりとなっていることを確認する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>出力ディレクトリに会員情報ファイルが出力されていること</p>
<div class="ulist">
<ul>
<li>
<p>出力ファイル: files/output/output-member-info-data.csv</p>
</li>
</ul>
</div>
</li>
<li>
<p>statusフィールド</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointフィールド</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeフィールドが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeフィールドが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
<li>
<p>1,000,000(上限値)を超えたレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>会員情報ファイルの入出力内容は以下のとおり。<br>
ファイルのフィールドはid(会員番号)、type(会員種別)、status(商品購入フラグ)、point(ポイント)の順で出力される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/FileAccess/Ch09_FileAccessJob_Result_MemberInfoFile.png" alt="File of member_info">
</div>
<div class="title">会員情報ファイルの入出力内容</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch09_Impl_FileAccessJob_Tasklet"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet"></a>タスクレットモデルでの実装</h2>
<div class="sectionbody">
<div class="paragraph">
<p>タスクレットモデルでのファイルアクセスでデータ入出力を行うジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_JobDefinition">ジョブBean定義ファイルの作成</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_Dto">DTOの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_FileAccess">ファイルアクセスの定義</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_Logic">ロジックの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Tasklet_JobDefinition"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_JobDefinition"></a>ジョブBean定義ファイルの作成</h3>
<div class="paragraph">
<p>Bean定義ファイルにて、タスクレットモデルでのファイルアクセスでデータ入出力を行うジョブを構成する要素の組み合わせ方を設定する。<br>
ここでは、Bean定義ファイルの枠および共通的な設定のみ記述し、以降の項で各構成要素の設定を行う。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/fileaccess/jobPointAddTasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.fileaccess.tasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Macchinetta Batch 2.xを利用する際に、常に必要なBean定義を読み込む設定をインポートする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>base-package</code>属性に、使用するコンポーネント(Taskletの実装クラスなど)が格納されているパッケージを指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Tasklet_Dto"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Dto"></a>DTOの実装</h3>
<div class="paragraph">
<p>業務データを保持するためのクラスとしてDTOクラスを実装する。<br>
DTOクラスはファイルごとに作成する。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="paragraph">
<p>以下のとおり、変換対象クラスとしてDTOクラスを実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.dto.MemberInfoDTO</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.dto</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MemberInfoDto</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> id; <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> type; <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> status; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="type">int</span> point; <span class="comment">// (4)</span>

    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> id;
    }

    <span class="directive">public</span> <span class="type">void</span> setId(<span class="predefined-type">String</span> id) {
        <span class="local-variable">this</span>.id = id;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getType() {
        <span class="keyword">return</span> type;
    }

    <span class="directive">public</span> <span class="type">void</span> setType(<span class="predefined-type">String</span> type) {
        <span class="local-variable">this</span>.type = type;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getStatus() {
        <span class="keyword">return</span> status;
    }

    <span class="directive">public</span> <span class="type">void</span> setStatus(<span class="predefined-type">String</span> status) {
        <span class="local-variable">this</span>.status = status;
    }

    <span class="directive">public</span> <span class="type">int</span> getPoint() {
        <span class="keyword">return</span> point;
    }

    <span class="directive">public</span> <span class="type">void</span> setPoint(<span class="type">int</span> point) {
        <span class="local-variable">this</span>.point = point;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号に対応するフィールドとして<code>id</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別に対応するフィールドとして<code>type</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグに対応するフィールドとして<code>status</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイントに対応するフィールドとして<code>point</code>を定義する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Tasklet_FileAccess"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_FileAccess"></a>ファイルアクセスの定義</h3>
<div class="paragraph">
<p>ファイルアクセスでデータ入出力するためのジョブBean定義ファイルの設定を行う。</p>
</div>
<div class="paragraph">
<p>ItemReader、ItemWriterの設定として、ジョブBean定義ファイルに以下の(1)以降を追記する。<br>
ここで触れていない設定内容については、<a href="Ch05_FileAccess.html#Ch05_FileAccess_HowToUse_VariableLength_Input">可変長レコードの入力</a>
および<a href="Ch05_FileAccess.html#Ch05_FileAccess_HowToUse_VariableLength_Output">可変長レコードの出力</a>を参照のこと。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/fileaccess/jobPointAddTasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.fileaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (1) (2) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:quoteCharacter</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (4) (5) --&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (6) --&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- (7) (8) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (9) --&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (10) --&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (11) --&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (12) --&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReaderの設定を行う。<br>
<code>class</code>属性に、Spring Batchが提供するフラットファイルを読み込むための<code>ItemReader</code>の実装クラスである
<code>org.springframework.batch.item.file.FlatFileItemReader</code>を指定する。<br>
<code>scope</code>属性に、<code>step</code>スコープを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource</code>属性に入力ファイルのパスを設定する。<br>
パスは直接指定することも可能であるが、ここでは、ジョブ起動時にパラメータで渡すようにするため、
入力ファイルパスのパラメータ名を指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineTokenizerの設定を行う。<br>
<code>class</code>属性に、Spring Batchが提供する区切り文字を指定してレコードを分割する<code>LineTokenizer</code>の実装クラスである
<code>org.springframework.batch.item.file.transform.DelimitedLineTokenizer</code>を指定する。<br>
CSV形式の一般的書式とされるRFC-4180の仕様に定義されている、エスケープされた改行、区切り文字、囲み文字の読み込みに対応している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>names</code>属性に、1レコードの各項目に付与する名前を設定する。<br>
<code>FieldSetMapper</code>で使われる<code>FieldSet</code>で設定した名前を用いて各項目を取り出すことができるようになる。<br>
レコードの先頭から各名前をカンマ区切りで指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delimiter</code>属性に、区切り文字としてカンマを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fieldSetMapper</code>の設定を行う。<br>
今回は文字列や数字など特別な変換処理が不要なため、
<code>class</code>属性に、<code>org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</code>を指定する。<br>
<code>targetType</code>属性には、変換対象クラスとして<a href="#Ch09_Impl_FileAccessJob_Tasklet_Dto">DTOの実装</a>で作成したDTOクラスを指定する。
これにより、(4)で設定した各項目の名前と一致するフィールドに値を自動的に設定したインスタンスを生成する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriterの設定を行う。<br>
<code>class</code>属性に、Spring Batchが提供するフラットファイルへ書き込むための<code>ItemWriter</code>の実装クラスである
<code>org.springframework.batch.item.file.FlatFileItemWriter</code>を指定する。<br>
<code>scope</code>属性に、<code>step</code>スコープを指定する。<br>
このチュートリアルでは、<code>appendAllowed</code>属性は<code>false</code>(追記しない)、<code>shouldDeleteIfExists</code>属性は<code>true</code>(既存ファイルを削除する)を指定して
ジョブを何度実行しても新規にファイルが作成されるようにする。<br>
<code>transactional</code>属性に、<code>true</code>を指定して、擬似的トランザクション制御を有効にする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource</code>属性に出力ファイルのパスを設定する。<br>
ジョブ起動時にパラメータで渡すようにするため、出力ファイルパスのパラメータ名を指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lineAggregator</code>の設定を行う。<br>
<code>class</code>属性に、対象Beanを1レコードへマッピングするための<code>org.springframework.batch.item.file.transform.LineAggregator</code>を指定する。<br>
Beanのプロパティとレコード内の各項目とのマッピングは<code>FieldExtractor</code>で行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delimiter</code>属性に、区切り文字としてカンマを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fieldExtractor</code>の設定を行う。<br>
 (12)で指定する各項目の名前に(6)で指定したDTOクラスのフィールドと一致する値をマッピングする。 <br>
<code>class</code>属性に、<code>org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</code>を指定する。<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>names</code>属性に、1レコードの各項目に付与する名前を設定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">チャンクモデルのコンポーネントを利用するTasklet実装</div>
<div class="paragraph">
<p>このチュートリアルでは、タスクレットモデルでファイルアクセスするジョブの作成を容易に実現するために、
チャンクモデルのコンポーネントであるItemReader・ItemWriterを利用している。</p>
</div>
<div class="paragraph">
<p>Tasklet実装の中でチャンクモデルの各種コンポーネントを利用するかどうかは、
<a href="Ch03_CreateTaskletJob.html#Ch03_CreateTaskletJob_HowToUse_InOutImpl">チャンクモデルのコンポーネントを利用するTasklet実装</a>を参照して適宜判断してほしい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Tasklet_Logic"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Logic"></a>ロジックの実装</h3>
<div class="paragraph">
<p>ポイント加算処理を行うビジネスロジッククラスを実装する。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_Logic_Tasklet">PointAddTaskletクラスの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_FileAccessJob_Tasklet_Logic_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_FileAccessJob_Tasklet_Logic_Tasklet"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Logic_Tasklet"></a>PointAddTaskletクラスの実装</h4>
<div class="paragraph">
<p>Taskletインタフェースを実装したPointAddTaskletクラスを作成する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.fileaccess.tasklet.PointAddTasklet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.fileaccess.tasklet</span>;

<span class="keyword">import</span> <span class="include">org.springframework.batch.core.StepContribution</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.scope.context.ChunkContext</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.step.tasklet.Tasklet</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemStreamException</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemStreamReader</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemStreamWriter</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.repeat.RepeatStatus</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Scope</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;
<span class="keyword">import</span> <span class="include">com.example.batch.tutorial.common.dto.MemberInfoDto</span>;

<span class="keyword">import</span> <span class="include">javax.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Component</span> <span class="comment">// (1)</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>) <span class="comment">// (2)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PointAddTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> TARGET_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> INITIAL_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (4)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> GOLD_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">G</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (5)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NORMAL_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">N</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (6)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> MAX_POINT = <span class="integer">1000000</span>; <span class="comment">// (7)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> CHUNK_SIZE = <span class="integer">10</span>; <span class="comment">// (8)</span>

    <span class="annotation">@Inject</span> <span class="comment">// (9)</span>
    ItemStreamReader&lt;MemberInfoDto&gt; reader; <span class="comment">// (10)</span>

    <span class="annotation">@Inject</span> <span class="comment">// (9)</span>
    ItemStreamWriter&lt;MemberInfoDto&gt; writer; <span class="comment">// (11)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> { <span class="comment">// (12)</span>
        MemberInfoDto item = <span class="predefined-constant">null</span>;

        <span class="predefined-type">List</span>&lt;MemberInfoDto&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(CHUNK_SIZE); <span class="comment">// (13)</span>
        <span class="keyword">try</span> {

            reader.open(chunkContext.getStepContext().getStepExecution().getExecutionContext()); <span class="comment">// (14)</span>
            writer.open(chunkContext.getStepContext().getStepExecution().getExecutionContext()); <span class="comment">// (14)</span>

            <span class="keyword">while</span> ((item = reader.read()) != <span class="predefined-constant">null</span>) { <span class="comment">// (15)</span>

                <span class="keyword">if</span> (TARGET_STATUS.equals(item.getStatus())) {
                    <span class="keyword">if</span> (GOLD_MEMBER.equals(item.getType())) {
                        item.setPoint(item.getPoint() + <span class="integer">100</span>);
                    } <span class="keyword">else</span> <span class="keyword">if</span> (NORMAL_MEMBER.equals(item.getType())) {
                        item.setPoint(item.getPoint() + <span class="integer">10</span>);
                    }

                    <span class="keyword">if</span> (item.getPoint() &gt; MAX_POINT) {
                        item.setPoint(MAX_POINT);
                    }

                    item.setStatus(INITIAL_STATUS);
                }

                items.add(item);

                <span class="keyword">if</span> (items.size() == CHUNK_SIZE) { <span class="comment">// (16)</span>
                    writer.write(items); <span class="comment">// (17)</span>
                    items.clear();
                }
            }

            writer.write(items); <span class="comment">// (18)</span>
        } <span class="keyword">finally</span> {
            <span class="keyword">try</span> {
                reader.close(); <span class="comment">// (19)</span>
            } <span class="keyword">catch</span> (ItemStreamException e) {
                <span class="comment">// do nothing.</span>
            }
            <span class="keyword">try</span> {
                writer.close(); <span class="comment">// (19)</span>
            } <span class="keyword">catch</span> (ItemStreamException e) {
                <span class="comment">// do nothing.</span>
            }
        }

        <span class="keyword">return</span> RepeatStatus.FINISHED; <span class="comment">// (20)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャンの対象とするため、<code>@Component</code>アノテーションを付与してBean定義を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">クラスに@Scopeアノテーションを付与して<code>step</code>スコープを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイント加算対象とする商品購入フラグ:1を定義する。<br>
本来、このようなフィールド定数は定数クラスなどに定義し、ロジックに定義することはあまりない。
このチュートリアルでは、便宜上、定数として定義していることを留意すること。(以降の定数も同様)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、商品購入フラグの初期値:0を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員種別:G(ゴールド会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員種別:N(一般会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイントの上限値:1000000を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、まとめて処理する単位(一定件数):10を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Inject</code>アノテーションを付与して、<code>ItemStreamReader/ItemStreamWriter</code>の実装をインジェクションする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイルアクセスするために<code>ItemReader</code>のサブインタフェースである、<code>ItemStreamReader</code>として型を定義する。<br>
<code>ItemStreamReader</code>はリソースのオープン/クローズを実行する必要がある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイルアクセスするために<code>ItemWriter</code>のサブインタフェースである、<code>ItemStreamWriter</code>として型を定義する。<br>
<code>ItemStreamWriter</code>はリソースのオープン/クローズを実行する必要がある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグおよび、会員種別に応じてポイント加算するビジネスロジックを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(13)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">一定件数分の<code>item</code>を格納するためのリストを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(14)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入出力リソースをオープンする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(15)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力リソース全件を逐次ループ処理する。<br>
<code>ItemReader#read</code>は、入力データがすべて読み取り末端に到達した場合、<code>null</code>を返却する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(16)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リストに追加した<code>item</code>の数が一定件数に達したかどうかを判定する。<br>
一定件数に達した場合は、(17)でファイルへ出力し、リストを<code>clear</code>する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(17)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理したデータをファイルへ出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(18)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">全体の処理件数/一定件数の余り分をファイルへ出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(19)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入出力リソースをクローズする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(20)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Taskletの処理が完了したかどうかを返却する。<br>
常に<code>return RepeatStatus.FINISHED;</code>と明示する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_FileAccessJob_Tasklet_Logic_Bean"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Logic_Bean"></a>ジョブBean定義ファイルの設定</h4>
<div class="paragraph">
<p>作成したビジネスロジックをジョブとして設定するため、ジョブBean定義ファイルに以下の(1)以降を追記する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/fileaccess/jobPointAddTasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.fileaccess.tasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:quoteCharacter</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id,type,status,point</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddTasklet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddTasklet.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                           <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pointAddTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要がある。<br>
ここでは、タスクレットモデルのジョブ名として<code>jobPointAddTasklet</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要はないが、障害発生時に追跡しやすくなる等の様々なメリットがあるため一意とする。<br>
 特別な理由がない限り、(1)で指定したid属性に[step+連番]を付加する形式とする。<br>
ここでは、タスクレットモデルのジョブのステップ名として<code>jobPointAddTasklet.step01</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">タスクレットの設定を行う。<br>
<code>ref</code>属性に、Taskletの実装クラスのBeanIDである<code>pointAddTasklet</code>を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_FileAccessJob_Tasklet_Execution"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Execution"></a>ジョブの実行と結果の確認</h3>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_FileAccessJob_Tasklet_Execution_Run"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Execution_Run"></a>実行構成からジョブを実行</h4>
<div class="paragraph">
<p>以下のとおり実行構成を作成し、ジョブを実行する。<br>
実行構成の作成手順は<a href="Ch09_EnvironmentConstruction.html#Ch09_EnvironmentConstruction_OperationCheck">動作確認</a>を参照。</p>
</div>
<div class="paragraph">
<p>ここでは、正常系データを利用してジョブを実行する。<br>
Argumentsタブに入出力ファイルのパラメータを引数として追加する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">実行構成の設定値</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Name: 任意の名称(例: Run FileAccessJob for TaskletModel)</p>
</li>
<li>
<p>Mainタブ</p>
<div class="ulist">
<ul>
<li>
<p>Project: <code>macchinetta-batch-tutorial</code></p>
</li>
<li>
<p>Main class: <code>org.springframework.batch.core.launch.support.CommandLineJobRunner</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Argumentsタブ</p>
<div class="ulist">
<ul>
<li>
<p>Program arguments: <code>META-INF/jobs/fileaccess/jobPointAddTasklet.xml jobPointAddTasklet inputFile=files/input/input-member-info-data.csv outputFile=files/output/output-member-info-data.csv</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_FileAccessJob_Tasklet_Execution_Console"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Execution_Console"></a>コンソールログの確認</h4>
<div class="paragraph">
<p>Consoleに以下の内容のログが出力されていることを確認する。</p>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/09/12 10:13:18] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddTasklet]] completed with the following parameters: [{inputFile=files/input/input-member-info-data.csv, outputFile=files/output/output-member-info-data.csv, jsr_batch_run_id=474}] and the following status: [COMPLETED]
[2017/09/12 10:13:18] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@735f7ae5: startup date [Tue Sep 12 10:13:16 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_FileAccessJob_Tasklet_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Execution_Exitcode"></a>終了コードの確認</h4>
<div class="paragraph">
<p>終了コードにより、正常終了したことを確認する。<br>
確認手順は<a href="Ch09_EnvironmentConstruction.html#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が0(正常終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/FileAccess/Ch09_FileAccessJob_Confirm_ExitCode_TaskletModel.png" alt="Confirm the Exit Code of FileAccessJob for TaskletModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_FileAccessJob_Tasklet_Execution_OutputFile"><a class="anchor" href="#Ch09_Impl_FileAccessJob_Tasklet_Execution_OutputFile"></a>会員情報ファイルの確認</h4>
<div class="paragraph">
<p>会員情報ファイルの入出力内容を比較し、確認内容のとおりとなっていることを確認する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>出力ディレクトリに会員情報ファイルが出力されていること</p>
<div class="ulist">
<ul>
<li>
<p>出力ファイル: files/output/output-member-info-data.csv</p>
</li>
</ul>
</div>
</li>
<li>
<p>statusフィールド</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointフィールド</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeフィールドが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeフィールドが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
<li>
<p>1,000,000(上限値)を超えたレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>会員情報ファイルの入出力内容は以下のとおり。<br>
ファイルのフィールドはid(会員番号)、type(会員種別)、status(商品購入フラグ)、point(ポイント)の順で出力される。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/FileAccess/Ch09_FileAccessJob_Result_MemberInfoFile.png" alt="File of member_info">
</div>
<div class="title">会員情報ファイルの入出力内容</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="container">

  <div class="common-bg">
    <div class="information">
      Macchinetta Batch Framework (2.x) Development Guideline - version 2.1.1.RELEASE, 2019-3-26
    </div>
    <div class="index">
      <a href="index.html">&gt; INDEX</a>
    </div>
  </div>

  <div class="footer-bg">
    <div class="copyright">
      &copy; Copyright 2017 NTT Corporation.
    </div>
  </div>

</div>
</body>
</html>
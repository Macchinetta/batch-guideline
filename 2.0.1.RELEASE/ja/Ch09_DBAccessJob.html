<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>データベースアクセスでデータ入出力を行うジョブ</title>
<link rel="stylesheet" href="./theme/css/readthedocs.css">
<link rel="stylesheet" href="./theme/css/font-awesome.min.css">
<link rel="stylesheet" href="./theme/css/coderay-asciidoctor.css">
<link rel="stylesheet" href="./theme/css/header-footer.css">
<title>Macchinetta Batch Framework (2.x) Development Guideline</title>

<div class="common-bg">
  <div class="information">
    Macchinetta Batch Framework (2.x) Development Guideline - version 2.0.1.RELEASE, 2018-3-9
  </div>
  <div class="index">
      <a href="index.html">&gt; INDEX</a>
  </div>
</div>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113850349-5"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-113850349-5');
</script>
</head>
<body id="Ch09_Impl_DBAccessJob" class="book toc2 toc-left">
<div id="header">
<h1>データベースアクセスでデータ入出力を行うジョブ</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#Ch09_Impl_DBAccessJob_Overview">概要</a>
<ul class="sectlevel2">
<li><a href="#Ch09_Impl_DBAccessJob_Overview_Background">背景</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Overview_ProcessOverview">処理概要</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Overview_BusinessSpecification">業務仕様</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Overview_TableSpecification">テーブル仕様</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Overview_JobOverview">ジョブの概要</a></li>
</ul>
</li>
<li><a href="#Ch09_Impl_DBAccessJob_Chunk">チャンクモデルでの実装</a>
<ul class="sectlevel2">
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_JobDefinition">ジョブBean定義ファイルの作成</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_Dto">DTOの実装</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis">MyBatisによるデータベースアクセスの定義</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_Repository">Repositoryインターフェースの実装</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_MapperXML">MapperXMLファイルの作成</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_Bean">ジョブBean定義ファイルの設定</a></li>
</ul>
</li>
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_Logic">ロジックの実装</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_Logic_ItemProcessor">PointAddItemProcessorクラスの実装</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_Logic_Bean">ジョブBean定義ファイルの設定</a></li>
</ul>
</li>
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_Execution">ジョブの実行と結果の確認</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Run">実行構成からジョブを実行</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Console">コンソールログの確認</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Exitcode">終了コードの確認</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Table">会員情報テーブルの確認</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet">タスクレットモデルでの実装</a>
<ul class="sectlevel2">
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_JobDefinition">ジョブBean定義ファイルの作成</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_Dto">DTOの実装</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis">MyBatisによるデータベースアクセスの定義</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Repository">Repositoryインターフェースの実装</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_MapperXML">MapperXMLファイルの作成</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Bean">ジョブBean定義ファイルの設定</a></li>
</ul>
</li>
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_Logic">ロジックの実装</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_Logic_Tasklet">PointAddTaskletクラスの実装</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_Logic_Bean">ジョブBean定義ファイルの設定</a></li>
</ul>
</li>
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_Execution">ジョブの実行と結果の確認</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_Execution_Run">実行構成からジョブを実行</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_Execution_Console">コンソールログの確認</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_Execution_Exitcode">終了コードの確認</a></li>
<li><a href="#Ch09_Impl_DBAccessJob_Tasklet_Execution_Table">会員情報テーブルの確認</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="Ch09_Impl_DBAccessJob_Overview"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Overview"></a>概要</h2>
<div class="sectionbody">
<div class="paragraph">
<p>データベースアクセスを行うジョブを作成する。</p>
</div>
<div class="paragraph">
<p>なお、本節はMacchinetta Batch 2.x 開発ガイドラインを元に説明しているため、
詳細については<a href="Ch05_DBAccess.html#Ch05_DBAccess">データベースアクセス</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p><a href="Ch09_TutorialApplication.html#Ch09_TutorialApplication">作成するアプリケーションの説明</a>の
背景、処理概要、業務仕様を以下に再掲する。</p>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Overview_Background"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Overview_Background"></a>背景</h3>
<div class="paragraph">
<p>とある量販店では、会員に対してポイントカードを発行している。<br>
会員には「ゴールド会員」「一般会員」の会員種別が存在し、会員種別に応じたサービスを提供している。<br>
今回そのサービスの一環として、月内に商品を購入した会員のうち、
会員種別が「ゴールド会員」の場合は100ポイント、「一般会員」の場合は10ポイントを月末に加算することにした。</p>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Overview_ProcessOverview"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Overview_ProcessOverview"></a>処理概要</h3>
<div class="paragraph">
<p>会員種別に応じてポイント加算を行うアプリケーションを
月次バッチ処理としてMacchinetta Batch 2.xを使用して実装する。</p>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Overview_BusinessSpecification"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Overview_BusinessSpecification"></a>業務仕様</h3>
<div class="paragraph">
<p>業務仕様は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>商品購入フラグが"1"(処理対象)の場合に、会員種別に応じてポイントを加算する</p>
<div class="ulist">
<ul>
<li>
<p>会員種別が"G"(ゴールド会員)の場合は100ポイント、"N"(一般会員)の場合は10ポイント加算する</p>
</li>
</ul>
</div>
</li>
<li>
<p>商品購入フラグはポイント加算後に"0"(初期状態)に更新する</p>
</li>
<li>
<p>ポイントの上限値は1,000,000ポイントとする</p>
</li>
<li>
<p>ポイント加算後に1,000,000ポイントを超えた場合は、1,000,000ポイントに補正する</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Overview_TableSpecification"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Overview_TableSpecification"></a>テーブル仕様</h3>
<div class="paragraph">
<p>入出力リソースとなる会員情報テーブルの仕様は以下のとおり。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">会員情報テーブル(member_info)</caption>
<colgroup>
<col style="width: 3.0927%;">
<col style="width: 15.4639%;">
<col style="width: 10.3092%;">
<col style="width: 4.1237%;">
<col style="width: 12.3711%;">
<col style="width: 8.2474%;">
<col style="width: 46.392%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">属性名</th>
<th class="tableblock halign-left valign-top">カラム名</th>
<th class="tableblock halign-left valign-top">PK</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">桁数</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員を一意に示す8桁固定の番号を表す。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の種別を以下のとおり表す。<br>
"G"(ゴールド会員)、"N"(一般会員)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">月内に商品を買ったかどうかを表す。<br>
商品購入で"1"(処理対象)、月次バッチ処理で"0"(初期状態)に更新される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイント</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">point</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員の保有するポイントを表す。<br>
初期値は0。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">テーブル仕様について</div>
<div class="paragraph">
<p>チュートリアルを実施するうえでの便宜を図り、
実際の業務に即したテーブル設計は行っていないため留意すること。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Overview_JobOverview"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Overview_JobOverview"></a>ジョブの概要</h3>
<div class="paragraph">
<p>ここで作成するデータベースアクセスするジョブの概要を把握するために、
処理フローおよび処理シーケンスを以下に示す。</p>
</div>
<div class="paragraph">
<p>処理シーケンスではトランザクション制御の範囲について触れている。
ジョブのトランザクション制御はSpring Batchがもつ仕組みを利用しており、これをフレームワークトランザクションと定義して説明する。
トランザクション制御の詳細は<a href="Ch05_Transaction.html#Ch05_Transaction">トランザクション制御</a>を参照のこと。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">処理フロー概要</dt>
<dd>
<p>処理フローの概要を以下に示す。</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/DBAccess/Ch09_DBAccessJob_ProcessFlow.png" alt="ProcessFlow of DBAccess Job">
</div>
<div class="title">データベースアクセスジョブの処理フロー</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンクモデルの場合の処理シーケンス</dt>
<dd>
<p>チャンクモデルの場合の処理シーケンスを説明する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_DBAccessJob_ProcessSequence_ChunkModel.png" alt="ProcessSequence of DBAccess Job by ChunkModel">
</div>
<div class="title">チャンクモデルのシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
</li>
<li>
<p>ステップは、リソースをオープンする。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから会員情報をすべて取得(select文の発行)する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで、以降の処理を繰り返す。</p>
</li>
<li>
<p>チャンク単位で、フレームワークトランザクションを開始する。</p>
</li>
<li>
<p>チャンクサイズに達するまで4から10までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは、<code>MyBatisCursorItemReader</code>から入力データを1件取得する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから入力データを1件取得する。</p>
</li>
<li>
<p>member_infoテーブルは、<code>MyBatisCursorItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、ステップに入力データを返却する。</p>
</li>
<li>
<p>ステップは、<code>PointAddItemProcessor</code>で入力データに対して処理を行う。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、入力データを読み込んでポイント加算処理を行う。</p>
</li>
<li>
<p><code>PointAddItemProcessor</code>は、ステップに処理結果を返却する。</p>
</li>
<li>
<p>ステップは、チャンクサイズ分のデータを<code>MyBatisBatchItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>MyBatisBatchItemWriter</code>は、member_infoテーブルに対して会員情報の更新(update文の発行)を行う。</p>
</li>
<li>
<p>ステップはフレームワークトランザクションをコミットする。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは正常終了:0)を返却する。</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">タスクレットモデルの場合の処理シーケンス</dt>
<dd>
<p>タスクレットモデルの場合の処理シーケンスについて説明する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>このチュートリアルでは、タスクレットモデルでもチャンクモデルのように一定件数のデータをまとめて処理する方式としている。
大量データを効率的に処理できるなどのメリットがある。詳細は<a href="Ch03_CreateTaskletJob.html#Ch03_CreateTaskletJob_HowToUse_InOutImpl">チャンクモデルのコンポーネントを利用するTasklet実装</a>を参照のこと。</p>
</div>
<div class="paragraph">
<p>橙色のオブジェクトは今回実装するクラスを表す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch09_DBAccessJob_ProcessSequence_TaskletModel.png" alt="ProcessSequence of DBAccess Job by TaskletModel">
</div>
<div class="title">タスクレットモデルのシーケンス図</div>
</div>
<div class="olist arabic">
<div class="title">シーケンス図の説明</div>
<ol class="arabic">
<li>
<p>ジョブからステップが実行される。</p>
<div class="ulist">
<ul>
<li>
<p>ステップはフレームワークトランザクションを開始する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ステップは<code>PointAddTasklet</code>を実行する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、リソースをオープンする。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから会員情報をすべて取得(select文の発行)する。</p>
<div class="ulist">
<ul>
<li>
<p>入力データがなくなるまで5から9までの処理を繰り返す。</p>
</li>
<li>
<p>一定件数に達するまで5から11までの処理を繰り返す。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>PointAddTasklet</code>は、<code>MyBatisCursorItemReader</code>から入力データを1件取得する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、member_infoテーブルから入力データを1件取得する。</p>
</li>
<li>
<p>member_infoテーブルは、<code>MyBatisCursorItemReader</code>に入力データを返却する。</p>
</li>
<li>
<p><code>MyBatisCursorItemReader</code>は、タスクレットに入力データを返却する。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、入力データを読み込んでポイント加算処理を行う。</p>
</li>
<li>
<p><code>PointAddTasklet</code>は、一定件数分のデータを<code>MyBatisBatchItemWriter</code>で出力する。</p>
</li>
<li>
<p><code>MyBatisBatchItemWriter</code>は、member_infoテーブルに対して会員情報の更新(update文の発行)を行う。</p>
</li>
<li>
<p><code>PointAddTasklet</code>はステップへ処理終了を返却する。</p>
</li>
<li>
<p>ステップはフレームワークトランザクションをコミットする。</p>
</li>
<li>
<p>ステップはジョブに終了コード(ここでは正常終了:0)を返却する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>以降で、チャンクモデル、タスクレットモデルそれぞれの実装方法を説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk">チャンクモデルでの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet">タスクレットモデルでの実装</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch09_Impl_DBAccessJob_Chunk"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk"></a>チャンクモデルでの実装</h2>
<div class="sectionbody">
<div class="paragraph">
<p>チャンクモデルでデータベースアクセスするジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_JobDefinition">ジョブBean定義ファイルの作成</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_Dto">DTOの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis">MyBatisによるデータベースアクセスの定義</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_Logic">ロジックの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Chunk_JobDefinition"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_JobDefinition"></a>ジョブBean定義ファイルの作成</h3>
<div class="paragraph">
<p>Bean定義ファイルにて、チャンクモデルでデータベースアクセスを行うジョブを構成する要素の組み合わせ方を設定する。<br>
ここでは、Bean定義ファイルの枠および共通的な設定のみ記述し、以降の項で各構成要素の設定を行う。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Macchinetta Batch 2.xを利用する際に、常に必要なBean定義を読み込む設定をインポートする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャンの設定を行う。<br>
<code>base-package</code>属性に、使用するコンポーネント(ItemProcessorの実装クラスなど)が格納されているパッケージを指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Chunk_Dto"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Dto"></a>DTOの実装</h3>
<div class="paragraph">
<p>業務データを保持するためのクラスとしてDTOクラスを実装する。<br>
DTOクラスはテーブルごとに作成する。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.dto.MemberInfoDTO</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.dto</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MemberInfoDto</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> id; <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> type; <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> status; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="type">int</span> point; <span class="comment">// (4)</span>

    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> id;
    }

    <span class="directive">public</span> <span class="type">void</span> setId(<span class="predefined-type">String</span> id) {
        <span class="local-variable">this</span>.id = id;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getType() {
        <span class="keyword">return</span> type;
    }

    <span class="directive">public</span> <span class="type">void</span> setType(<span class="predefined-type">String</span> type) {
        <span class="local-variable">this</span>.type = type;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getStatus() {
        <span class="keyword">return</span> status;
    }

    <span class="directive">public</span> <span class="type">void</span> setStatus(<span class="predefined-type">String</span> status) {
        <span class="local-variable">this</span>.status = status;
    }

    <span class="directive">public</span> <span class="type">int</span> getPoint() {
        <span class="keyword">return</span> point;
    }

    <span class="directive">public</span> <span class="type">void</span> setPoint(<span class="type">int</span> point) {
        <span class="local-variable">this</span>.point = point;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号に対応するフィールドとして<code>id</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別に対応するフィールドとして<code>type</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグに対応するフィールドとして<code>status</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイントに対応するフィールドとして<code>point</code>を定義する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Chunk_MyBatis"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis"></a>MyBatisによるデータベースアクセスの定義</h3>
<div class="paragraph">
<p>MyBatisを利用してデータベースアクセスするための実装・設定を行う。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_Repository">Repositoryインターフェースの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_MapperXML">MapperXMLファイルの作成</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Chunk_MyBatis_Repository"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_Repository"></a>Repositoryインターフェースの実装</h4>
<div class="paragraph">
<p>MapperXMLファイルに定義したSQLを呼び出すためのインターフェースを実装する。<br>
このインターフェースに対する実装クラスは、MyBatisが自動で生成するため、開発者はインターフェースのみ作成すればよい。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.repository.MemberInfoRepository</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.repository</span>;

<span class="keyword">import</span> <span class="include">com.example.batch.tutorial.common.dto.MemberInfoDto</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">MemberInfoRepository</span> {
  <span class="predefined-type">List</span>&lt;MemberInfoDto&gt; findAll(); <span class="comment">// (1)</span>

  <span class="type">int</span> updatePointAndStatus(MemberInfoDto memberInfo); <span class="comment">// (2)</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MapperXMLファイルに定義するSQLのIDに対応するメソッドを定義する。<br>
ここでは、member_infoテーブルからすべてのレコードを取得するためのメソッドを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ここでは、member_infoテーブルのpointカラムとstatusカラムを更新するためのメソッドを定義する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Chunk_MyBatis_MapperXML"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_MapperXML"></a>MapperXMLファイルの作成</h4>
<div class="paragraph">
<p>SQLとO/Rマッピングの設定を記載するMapperXMLファイルを作成する。<br>
MapperXMLファイルは、Repositoryインターフェースごとに作成する。</p>
</div>
<div class="paragraph">
<p>MyBatisが定めたルールに則ったディレクトリに格納することで、自動的にMapperXMLファイルを読み込むことができる。
MapperXMLファイルを自動的に読み込ませるために、Repositoryインターフェースのパッケージ階層と同じ階層のディレクトリにMapperXMLファイルを格納する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/com/example/batch/tutorial/common/repository/MemberInfoRepository.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="doctype">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findAll</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        SELECT
            id,
            type,
            status,
            point
        FROM
            member_info
        ORDER BY
            id ASC
    <span class="tag">&lt;/select&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;update</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updatePointAndStatus</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        UPDATE
            member_info
        SET
            status = #{status},
            point = #{point}
        WHERE
            id = #{id}
    <span class="tag">&lt;/update&gt;</span>
<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mapper要素のnamespace属性に、Repositoryインターフェースの完全修飾クラス名(FQCN)を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">参照系のSQLの設定を行う。<br>
ここでは、member_infoテーブルからすべてのレコードを取得するSQLを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新系のSQLの設定を行う。<br>
ここでは、member_infoテーブルの指定したidに一致するレコードについて、
ステータスとポイントを更新するSQLを設定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Chunk_MyBatis_Bean"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_MyBatis_Bean"></a>ジョブBean定義ファイルの設定</h4>
<div class="paragraph">
<p>MyBatisによるデータベースアクセスするための設定として、ジョブBean定義ファイルに以下の(1)～(3)を追記する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;mybatis:scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.findAll</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.updatePointAndStatus</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repositoryインターフェースをスキャンするための設定を行う。<br>
<code>base-package</code>属性に、Repositoryインターフェースが格納されている基底パッケージを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReaderの設定を行う。<br>
<code>class</code>属性に、MyBatisが提供しているSpring連携ライブラリであるMyBatis-Springから提供されている<code>org.mybatis.spring.batch.MyBatisCursorItemReader</code>を指定する。
データベースから大量データを取得する際は、この<code>MyBatisCursorItemReader</code>を使用する。
詳細は<a href="Ch05_DBAccess.html#Ch05_DBAccess_HowToUse_Input">入力</a>を参照のこと。<br>
<code>queryId</code>属性に、MapperXMLファイルに設定するSQLの<code>namespace</code>+<code>id</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriterの設定を行う。<br>
<code>class</code>属性に、MyBatisが提供しているSpring連携ライブラリであるMyBatis-Springから提供されている<code>org.mybatis.spring.batch.MyBatisBatchItemWriter</code>を指定する。<br>
<code>statementId</code>属性に、MapperXMLファイルに設定するSQLの<code>namespace</code>+<code>id</code>を指定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">ItemReader・ItemWriter以外のデータベースアクセス</div>
<div class="paragraph">
<p>ItemReader・ItemWriter以外でデータベースアクセスする方法として、Mapperインターフェースを利用する方法がある。
Mapperインターフェースを利用するにあたっては、Macchinetta Batch 2.xとして制約を設けているため、
<a href="Ch05_DBAccess.html#Ch05_DBAccess_HowToUse_Input_MapperInterface">Mapperインターフェース(入力)</a>、<a href="Ch05_DBAccess.html#Ch05_DBAccess_HowToUse_Output_MapperInterface">Mapperインターフェース(出力)</a>を参照してほしい。
ItemProcessorの実装例は、<a href="Ch05_DBAccess.html#Ch05_DBAccess_HowToUse_Input_MapperInterface_Chunk">チャンクモデルにおける利用方法</a>(入力)、
<a href="Ch05_DBAccess.html#Ch05_DBAccess_HowToUse_Output_MapperInterface_Chunk">チャンクモデルにおける利用方法</a>(出力)を参照のこと。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Chunk_Logic"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Logic"></a>ロジックの実装</h3>
<div class="paragraph">
<p>ポイント加算処理を行うビジネスロジッククラスを実装する。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_Logic_ItemProcessor">PointAddItemProcessorクラスの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Chunk_Logic_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Chunk_Logic_ItemProcessor"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Logic_ItemProcessor"></a>PointAddItemProcessorクラスの実装</h4>
<div class="paragraph">
<p>ItemProcessorインターフェースを実装したPointAddItemProcessorクラスを実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.dbaccess.chunk.PointAddItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.dbaccess.chunk</span>;

<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemProcessor</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;
<span class="keyword">import</span> <span class="include">com.example.batch.tutorial.common.dto.MemberInfoDto</span>;

<span class="annotation">@Component</span> <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PointAddItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;MemberInfoDto, MemberInfoDto&gt; { <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> TARGET_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> INITIAL_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (4)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> GOLD_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">G</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (5)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NORMAL_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">N</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (6)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> MAX_POINT = <span class="integer">1000000</span>; <span class="comment">// (7)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> MemberInfoDto process(MemberInfoDto item) <span class="directive">throws</span> <span class="exception">Exception</span> { <span class="comment">// (8) (9) (10)</span>
        <span class="keyword">if</span> (TARGET_STATUS.equals(item.getStatus())) {
            <span class="keyword">if</span> (GOLD_MEMBER.equals(item.getType())) {
                item.setPoint(item.getPoint() + <span class="integer">100</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (NORMAL_MEMBER.equals(item.getType())) {
                item.setPoint(item.getPoint() + <span class="integer">10</span>);
            }

            <span class="keyword">if</span> (item.getPoint() &gt; MAX_POINT) {
                item.setPoint(MAX_POINT);
            }

            item.setStatus(INITIAL_STATUS);
        }

        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャンの対象とするため、<code>@Component</code>アノテーションを付与してBean定義を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入出力で使用するオブジェクトの型をそれぞれ型引数に指定した<code>ItemProcessor</code>インターフェースを実装する。<br>
ここでは、入出力で使用するオブジェクトは共に<a href="#Ch09_Impl_DBAccessJob_Chunk_Dto">DTOの実装</a>で作成した<code>MemberInfoDTO</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイント加算対象とする商品購入フラグ:1を定義する。<br>
本来、このようなフィールド定数は定数クラスなどに定義し、ロジックに定義することはあまりない。
このチュートリアルでは、便宜上、定数として定義していることを留意すること。(以降の定数も同様)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、商品購入フラグの初期値:0を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員種別:G(ゴールド会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員種別:N(一般会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイントの上限値:1000000を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグおよび、会員種別に応じてポイント加算するビジネスロジックを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">返り値の型は、このクラスで実装している<code>ItemProcessor</code>インターフェースの型引数で指定した
出力オブジェクトの型である<code>MemberInfoDTO</code>とする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数として受け取る<code>item</code>の型は、
このクラスで実装している<code>ItemProcessor</code>インターフェースの型引数で指定した入力オブジェクトの型である<code>MemberInfoDTO</code>とする。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Chunk_Logic_Bean"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Logic_Bean"></a>ジョブBean定義ファイルの設定</h4>
<div class="paragraph">
<p>作成したビジネスロジックをジョブとして設定するため、ジョブBean定義ファイルに以下の(1)以降を追記する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddChunk.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;mybatis:scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.findAll</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.updatePointAndStatus</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddChunk</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddChunk.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pointAddItemProcessor</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;/batch:tasklet&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要がある。<br>
ここでは、チャンクモデルのジョブ名として<code>jobPointAddChunk</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要はないが、障害発生時に追跡しやすくなる等の様々なメリットがあるため一意とする。<br>
特別な理由がない限り、(1)で指定したid属性に[step+連番]を付加する形式とする。<br>
ここでは、チャンクモデルのジョブのステップ名として<code>jobPointAddChunk.step01</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">チャンクモデルジョブの設定を行う。<br>
<code>reader</code>、<code>writer</code>それぞれの属性に、前項までに定義した<code>ItemReader</code>、<code>ItemWriter</code>のBeanIDを指定する。<br>
<code>processor</code>属性に、ItemProcessorの実装クラスのBeanIDである<code>pointAddItemProcessor</code>を指定する。<br>
<code>commit-interval</code>属性に、1チャンクあたりの入力データ件数を10件として設定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">commit-intervalのチューニング</div>
<div class="paragraph">
<p>commit-intervalはチャンクモデルジョブにおける、性能上のチューニングポイントである。</p>
</div>
<div class="paragraph">
<p>このチュートリアルでは10件としているが、利用できるマシンリソースやジョブの特性によって適切な件数は異なる。
複数のリソースにアクセスしてデータを加工するジョブであれば10件から100件程度で処理スループットが頭打ちになることもある。
一方、入出力リソースが1:1対応しておりデータを移し替える程度のジョブであれば5,000件や10,000件でも処理スループットが伸びることがある。</p>
</div>
<div class="paragraph">
<p>ジョブ実装時のcommit-intervalは100件程度で仮置きしておき、 その後に実施した性能測定の結果に応じてジョブごとにチューニングするとよい。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Chunk_Execution"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Execution"></a>ジョブの実行と結果の確認</h3>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Chunk_Execution_Run"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Run"></a>実行構成からジョブを実行</h4>
<div class="paragraph">
<p>以下のとおり実行構成を作成し、ジョブを実行する。<br>
実行構成の作成手順は<a href="Ch09_EnvironmentConstruction.html#Ch09_EnvironmentConstruction_OperationCheck">プロジェクトの動作確認</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">実行構成の設定値</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Name: 任意の名称(例: Run DBAccessJob for ChunkModel)</p>
</li>
<li>
<p>Mainタブ</p>
<div class="ulist">
<ul>
<li>
<p>Project: <code>macchinetta-batch-tutorial</code></p>
</li>
<li>
<p>Main class: <code>org.springframework.batch.core.launch.support.CommandLineJobRunner</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Argumentsタブ</p>
<div class="ulist">
<ul>
<li>
<p>Program arguments: <code>META-INF/jobs/dbaccess/jobPointAddChunk.xml jobPointAddChunk</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Chunk_Execution_Console"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Console"></a>コンソールログの確認</h4>
<div class="paragraph">
<p>Consoleに以下の内容のログが出力されていることを確認する。</p>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/09/12 13:32:32] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddChunk]] completed with the following parameters: [{jsr_batch_run_id=484}] and the following status: [COMPLETED]
[2017/09/12 13:32:32] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@735f7ae5: startup date [Tue Sep 12 13:32:29 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Chunk_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Exitcode"></a>終了コードの確認</h4>
<div class="paragraph">
<p>終了コードにより、正常終了したことを確認する。<br>
確認手順は<a href="Ch09_EnvironmentConstruction.html#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が0(正常終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/DBAccess/Ch09_DBAccessJob_Confirm_ExitCode_ChunkModel.png" alt="Confiｒm the Exit Code of DBAccessJob for ChunkModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Chunk_Execution_Table"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Chunk_Execution_Table"></a>会員情報テーブルの確認</h4>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容を比較し、確認内容のとおりとなっていることを確認する。<br>
確認手順は<a href="Ch09_EnvironmentConstruction.html#Ch09_EnvironmentConstruction_OperationCheck_RefDB">Data Source Explorerを使用してデータベースを参照する</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>statusカラム</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointカラム</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeカラムが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeカラムが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
<li>
<p>1,000,000(上限値)を超えたレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容は以下のとおり。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/DBAccess/Ch09_DBAccessJob_Result_MemberInfoTable.png" alt="Table of member_info">
</div>
<div class="title">更新前後の会員情報テーブルの内容</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch09_Impl_DBAccessJob_Tasklet"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet"></a>タスクレットモデルでの実装</h2>
<div class="sectionbody">
<div class="paragraph">
<p>タスクレットモデルでデータベースアクセスするジョブの作成から実行までを以下の手順で実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_JobDefinition">ジョブBean定義ファイルの作成</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_Dto">DTOの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis">MyBatisによるデータベースアクセスの定義</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_Logic">ロジックの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_Execution">ジョブの実行と結果の確認</a></p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Tasklet_JobDefinition"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_JobDefinition"></a>ジョブBean定義ファイルの作成</h3>
<div class="paragraph">
<p>Bean定義ファイルにて、タスクレットモデルでデータベースアクセスを行うジョブを構成する要素の組み合わせ方を設定する。<br>
ここでは、Bean定義ファイルの枠および共通的な設定のみ記述し、以降の項で各構成要素の設定を行う。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddtasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.tasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Macchinetta Batch 2.xを利用する際に、常に必要なBean定義を読み込む設定をインポートする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャンの設定を行う。<br>
<code>base-package</code>属性に、使用するコンポーネント(Taskletの実装クラスなど)が格納されているパッケージを指定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Tasklet_Dto"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Dto"></a>DTOの実装</h3>
<div class="paragraph">
<p>業務データを保持するためのクラスとしてDTOクラスを作成する。<br>
DTOクラスはテーブルごとに作成する。</p>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.dto.MemberInfoDTO</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.dto</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MemberInfoDto</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> id; <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> type; <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> status; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="type">int</span> point; <span class="comment">// (4)</span>

    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> id;
    }

    <span class="directive">public</span> <span class="type">void</span> setId(<span class="predefined-type">String</span> id) {
        <span class="local-variable">this</span>.id = id;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getType() {
        <span class="keyword">return</span> type;
    }

    <span class="directive">public</span> <span class="type">void</span> setType(<span class="predefined-type">String</span> type) {
        <span class="local-variable">this</span>.type = type;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getStatus() {
        <span class="keyword">return</span> status;
    }

    <span class="directive">public</span> <span class="type">void</span> setStatus(<span class="predefined-type">String</span> status) {
        <span class="local-variable">this</span>.status = status;
    }

    <span class="directive">public</span> <span class="type">int</span> getPoint() {
        <span class="keyword">return</span> point;
    }

    <span class="directive">public</span> <span class="type">void</span> setPoint(<span class="type">int</span> point) {
        <span class="local-variable">this</span>.point = point;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員番号に対応するフィールドとして<code>id</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会員種別に対応するフィールドとして<code>type</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグに対応するフィールドとして<code>status</code>を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ポイントに対応するフィールドとして<code>point</code>を定義する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Tasklet_MyBatis"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis"></a>MyBatisによるデータベースアクセスの定義</h3>
<div class="paragraph">
<p>MyBatisを利用してデータベースアクセスするための実装・設定を行う。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Repository">Repositoryインターフェースの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_MapperXML">MapperXMLファイルの作成</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>チャンクモデル/タスクレットモデルで共通して利用するため、既に作成している場合は読み飛ばしてよい。</p>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Repository"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Repository"></a>Repositoryインターフェースの実装</h4>
<div class="paragraph">
<p>MapperXMLファイルに定義したSQLを呼び出すためのインターフェースを作成する。<br>
このインターフェースに対する実装クラスは、MyBatisが自動で生成するため、開発者はインターフェースのみ作成すればよい。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.common.repository.MemberInfoRepository</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.common.repository</span>;

<span class="keyword">import</span> <span class="include">com.example.batch.tutorial.common.dto.MemberInfoDto</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">MemberInfoRepository</span> {
    <span class="predefined-type">List</span>&lt;MemberInfoDto&gt; findAll(); <span class="comment">// (1)</span>

    <span class="type">int</span> updatePointAndStatus(MemberInfoDto memberInfo); <span class="comment">// (2)</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MapperXMLファイルに定義するSQLのIDに対応するメソッドを定義する。<br>
ここでは、member_infoテーブルからすべてのレコードを取得するためのメソッドを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ここでは、member_infoテーブルのpointカラムとstatusカラムを更新するためのメソッドを定義する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Tasklet_MyBatis_MapperXML"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_MapperXML"></a>MapperXMLファイルの作成</h4>
<div class="paragraph">
<p>SQLとO/Rマッピングの設定を記載するMapperXMLファイルを作成する。<br>
MapperXMLファイルは、Repositoryインターフェースごとに作成する。</p>
</div>
<div class="paragraph">
<p>MyBatisが定めたルールに則ったディレクトリに格納することで、自動的にMapperXMLファイルを読み込むことができる。
MapperXMLファイルを自動的に読み込ませるために、Repositoryインターフェースのパッケージ階層と同じ階層のディレクトリにMapperXMLファイルを格納する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/com/example/batch/tutorial/common/repository/MemberInfoRepository.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="doctype">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findAll</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        SELECT
            id,
            type,
            status,
            point
        FROM
            member_info
        ORDER BY
            id ASC
    <span class="tag">&lt;/select&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;update</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updatePointAndStatus</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.dto.MemberInfoDto</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        UPDATE
            member_info
        SET
            status = #{status},
            point = #{point}
        WHERE
            id = #{id}
    <span class="tag">&lt;/update&gt;</span>
<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mapper要素のnamespace属性に、Repositoryインターフェースの完全修飾クラス名(FQCN)を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">参照系のSQLの定義を行う。<br>
ここでは、member_infoテーブルからすべてのレコードを取得するSQLを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新系のSQLの定義を行う。<br>
ここでは、member_infoテーブルの指定したidに一致するレコードについて、
statusとpointを更新するSQLを設定する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Bean"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_MyBatis_Bean"></a>ジョブBean定義ファイルの設定</h4>
<div class="paragraph">
<p>MyBatisによるデータベースアクセスするための設定として、ジョブBean定義ファイルに以下の(1)～(3)を追記する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddTasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.tasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;mybatis:scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.findAll</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.updatePointAndStatus</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repositoryインターフェースをスキャンするための設定を行う。<br>
<code>base-package</code>属性に、Repositoryインターフェースが格納されている基底パッケージを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReaderの設定を行う。<br>
<code>class</code>属性に、MyBatisが提供しているSpring連携ライブラリMyBatis-Springから提供されている<code>org.mybatis.spring.batch.MyBatisCursorItemReader</code>を指定する。<br>
<code>queryId</code>属性に、MapperXMLファイルに設定するSQLの<code>namespace</code>+<code>id</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriterの設定を行う。<br>
<code>class</code>属性に、MyBatisが提供しているSpring連携ライブラリMyBatis-Springから提供されている<code>org.mybatis.spring.batch.MyBatisBatchItemWriter</code>を指定する。<br>
<code>statementId</code>属性に、MapperXMLファイルに設定するSQLの<code>namespace</code>+<code>id</code>を指定する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">チャンクモデルのコンポーネントを利用するTasklet実装</div>
<div class="paragraph">
<p>このチュートリアルでは、タスクレットモデルでデータベースアクセスするジョブの作成を容易に実現するために、
チャンクモデルのコンポーネントであるItemReader・ItemWriterを利用している。</p>
</div>
<div class="paragraph">
<p>Tasklet実装の中でチャンクモデルの各種コンポーネントを利用するかどうかは、
<a href="Ch03_CreateTaskletJob.html#Ch03_CreateTaskletJob_HowToUse_InOutImpl">チャンクモデルのコンポーネントを利用するTasklet実装</a>を参照して適宜判断してほしい。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">ItemReader・ItemWriter以外のデータベースアクセス</div>
<div class="paragraph">
<p>ItemReader・ItemWriter以外でデータベースアクセスする方法として、Mapperインターフェースを利用する方法がある。
Mapperインターフェースを利用するにあたっては、Macchinetta Batch 2.xとして制約を設けているため、
<a href="Ch05_DBAccess.html#Ch05_DBAccess_HowToUse_Input_MapperInterface">Mapperインターフェース(入力)</a>、<a href="Ch05_DBAccess.html#Ch05_DBAccess_HowToUse_Output_MapperInterface">Mapperインターフェース(出力)</a>を参照してほしい。
Taskletの実装例は、<a href="Ch05_DBAccess.html#Ch05_DBAccess_HowToUse_Input_MapperInterface_Tasklet">タスクレットモデルにおける利用方法</a>(入力)、
<a href="Ch05_DBAccess.html#Ch05_DBAccess_HowToUse_Output_MapperInterface_Tasklet">タスクレットモデルにおける利用方法</a>(出力)を参照のこと。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Tasklet_Logic"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Logic"></a>ロジックの実装</h3>
<div class="paragraph">
<p>ポイント加算処理を行うビジネスロジッククラスを実装する。</p>
</div>
<div class="paragraph">
<p>以下の作業を実施する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_Logic_Tasklet">PointAddTaskletクラスの実装</a></p>
</li>
<li>
<p><a href="#Ch09_Impl_DBAccessJob_Tasklet_Logic_Bean">ジョブBean定義ファイルの設定</a></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Tasklet_Logic_Tasklet"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Logic_Tasklet"></a>PointAddTaskletクラスの実装</h4>
<div class="paragraph">
<p>Taskletインターフェースを実装したPointAddTaskletクラスを実装する。</p>
</div>
<div class="listingblock">
<div class="title">com.example.batch.tutorial.dbaccess.tasklet.PointAddTasklet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.batch.tutorial.dbaccess.tasklet</span>;

<span class="keyword">import</span> <span class="include">org.springframework.batch.core.StepContribution</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.scope.context.ChunkContext</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.step.tasklet.Tasklet</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemStreamReader</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.item.ItemWriter</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.repeat.RepeatStatus</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;
<span class="keyword">import</span> <span class="include">com.example.batch.tutorial.common.dto.MemberInfoDto</span>;

<span class="keyword">import</span> <span class="include">javax.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Component</span> <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PointAddTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> TARGET_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (2)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> INITIAL_STATUS = <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (3)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> GOLD_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">G</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (4)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NORMAL_MEMBER = <span class="string"><span class="delimiter">&quot;</span><span class="content">N</span><span class="delimiter">&quot;</span></span>; <span class="comment">// (5)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> MAX_POINT = <span class="integer">1000000</span>; <span class="comment">// (6)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> CHUNK_SIZE = <span class="integer">10</span>; <span class="comment">// (7)</span>

    <span class="annotation">@Inject</span> <span class="comment">// (8)</span>
    ItemStreamReader&lt;MemberInfoDto&gt; reader; <span class="comment">// (9)</span>

    <span class="annotation">@Inject</span> <span class="comment">// (8)</span>
    ItemWriter&lt;MemberInfoDto&gt; writer; <span class="comment">// (10)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> { <span class="comment">// (11)</span>
        MemberInfoDto item = <span class="predefined-constant">null</span>;

        <span class="predefined-type">List</span>&lt;MemberInfoDto&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(CHUNK_SIZE); <span class="comment">// (12)</span>

        <span class="keyword">try</span> {
            reader.open(chunkContext.getStepContext().getStepExecution().getExecutionContext()); <span class="comment">// (13)</span>

            <span class="keyword">while</span> ((item = reader.read()) != <span class="predefined-constant">null</span>) { <span class="comment">// (14)</span>

                <span class="keyword">if</span> (TARGET_STATUS.equals(item.getStatus())) {
                    <span class="keyword">if</span> (GOLD_MEMBER.equals(item.getType())) {
                        item.setPoint(item.getPoint() + <span class="integer">100</span>);
                    } <span class="keyword">else</span> <span class="keyword">if</span> (NORMAL_MEMBER.equals(item.getType())) {
                        item.setPoint(item.getPoint() + <span class="integer">10</span>);
                    }

                    <span class="keyword">if</span> (item.getPoint() &gt; MAX_POINT) {
                        item.setPoint(MAX_POINT);
                    }

                    item.setStatus(INITIAL_STATUS);
                }

                items.add(item);

                <span class="keyword">if</span> (items.size() == CHUNK_SIZE) { <span class="comment">// (15)</span>
                    writer.write(items); <span class="comment">// (16)</span>
                    items.clear();
                }
            }

            writer.write(items); <span class="comment">// (17)</span>
        } <span class="keyword">finally</span> {
            reader.close(); <span class="comment">// (18)</span>
        }

        <span class="keyword">return</span> RepeatStatus.FINISHED; <span class="comment">// (19)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンポーネントスキャンの対象とするため、<code>@Component</code>アノテーションを付与してBean定義を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイント加算対象とする商品購入フラグ:1を定義する。<br>
本来、このようなフィールド定数は定数クラスなどに定義し、ロジックに定義することはあまりない。
このチュートリアルでは、便宜上、定数として定義していることを留意すること。(以降の定数も同様)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、商品購入フラグの初期値:0を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員種別:G(ゴールド会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、会員種別:N(一般会員)を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、ポイントの上限値:1000000を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定数として、まとめて処理する単位(一定件数):10を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Inject</code>アノテーションを付与して、<code>ItemStreamReader/ItemWriter</code>の実装をインジェクションする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データベースアクセスするために<code>ItemReader</code>のサブインターフェースである、<code>ItemStreamReader</code>として型を定義する。<br>
<code>ItemStreamReader</code>はリソースのオープン/クローズを実行する必要がある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemWriter</code>を定義する。<br>
<code>ItemStreamReader</code>とは異なり、リソースのオープン/クローズを実行する必要はない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">商品購入フラグおよび、会員種別に応じてポイント加算するビジネスロジックを実装する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">一定件数分の<code>item</code>を格納するためのリストを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(13)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力リソースをオープンする。<br>
このタイミングでSQLが発行される。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(14)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力リソース全件を逐次ループ処理する。<br>
<code>ItemReader#read</code>は、入力データがすべて読み取り末端に到達した場合、<code>null</code>を返却する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(15)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リストに追加した<code>item</code>の数が一定件数に達したかどうかを判定する。<br>
一定件数に達した場合は、(16)でデータベースへ出力し、リストを<code>clear</code>する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(16)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データベースへ出力する。<br>
このタイミングでコミットするわけではないため留意すること。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(17)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">全体の処理件数/一定件数の余り分をデータベースへ出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(18)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リソースをクローズする。<br>
なお、ここでは実装を簡易にするため例外処理を実装していない。例外処理は必要に応じて実装すること。<br>
ここで例外が発生した場合、タスクレット全体のトランザクションがロールバックされ、例外のスタックトレースを出力し、ジョブが異常終了する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(19)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Taskletの処理が完了したかどうかを返却する。<br>
常に<code>return RepeatStatus.FINISHED;</code>と明示する。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Tasklet_Logic_Bean"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Logic_Bean"></a>ジョブBean定義ファイルの設定</h4>
<div class="paragraph">
<p>作成したビジネスロジックをジョブとして設定するため、ジョブBean定義ファイルに以下の(1)以降を追記する。</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/jobs/dbaccess/jobPointAddTasklet.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.dbaccess.tasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;mybatis:scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.findAll</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.batch.tutorial.common.repository.MemberInfoRepository.updatePointAndStatus</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddTasklet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPointAddTasklet.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                           <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pointAddTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">説明</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ジョブの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要がある。<br>
ここでは、タスクレットモデルのジョブ名として<code>jobPointAddTasklet</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステップの設定を行う。<br>
<code>id</code>属性は、1つのバッチアプリケーションに含まれる全ジョブの範囲内で一意とする必要はないが、障害発生時に追跡しやすくなる等の様々なメリットがあるため一意とする。<br>
 特別な理由がない限り、(1)で指定したid属性に[step+連番]を付加する形式とする。<br>
ここでは、タスクレットモデルのジョブのステップ名として<code>jobPointAddTasklet.step01</code>を指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">タスクレットの設定を行う。<br>
<code>ref</code>属性に、Taskletの実装クラスのBeanIDである<code>pointAddTasklet</code>を指定する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_Impl_DBAccessJob_Tasklet_Execution"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Execution"></a>ジョブの実行と結果の確認</h3>
<div class="paragraph">
<p>作成したジョブをSTS上で実行し、結果を確認する。</p>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Tasklet_Execution_Run"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Execution_Run"></a>実行構成からジョブを実行</h4>
<div class="paragraph">
<p>以下のとおり実行構成を作成し、ジョブを実行する。<br>
実行構成の作成手順は<a href="Ch09_EnvironmentConstruction.html#Ch09_EnvironmentConstruction_OperationCheck">プロジェクトの動作確認</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">実行構成の設定値</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Name: 任意の名称(例: Run DBAccessJob for TaskletModel)</p>
</li>
<li>
<p>Mainタブ</p>
<div class="ulist">
<ul>
<li>
<p>Project: <code>macchinetta-batch-tutorial</code></p>
</li>
<li>
<p>Main class: <code>org.springframework.batch.core.launch.support.CommandLineJobRunner</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Argumentsタブ</p>
<div class="ulist">
<ul>
<li>
<p>Program arguments: <code>META-INF/jobs/dbaccess/jobPointAddTasklet.xml jobPointAddTasklet</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Tasklet_Execution_Console"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Execution_Console"></a>コンソールログの確認</h4>
<div class="paragraph">
<p>Consoleに以下の内容のログが出力されていることを確認する。</p>
</div>
<div class="listingblock">
<div class="title">コンソールログ出力例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2017/09/12 10:09:56] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=jobPointAddTasklet]] completed with the following parameters: [{jsr_batch_run_id=472}] and the following status: [COMPLETED]
[2017/09/12 10:09:56] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@735f7ae5: startup date [Tue Sep 12 10:09:54 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Tasklet_Execution_Exitcode"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Execution_Exitcode"></a>終了コードの確認</h4>
<div class="paragraph">
<p>終了コードにより、正常終了したことを確認する。<br>
確認手順は<a href="Ch09_EnvironmentConstruction.html#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">ジョブの実行と結果の確認</a>を参照。
終了コード(exit value)が0(正常終了)となっていることを確認する。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/DBAccess/Ch09_DBAccessJob_Confirm_ExitCode_TaskletModel.png" alt="Confiｒm the Exit Code of DBAccessJob for TaskletModel">
</div>
<div class="title">終了コードの確認</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Impl_DBAccessJob_Tasklet_Execution_Table"><a class="anchor" href="#Ch09_Impl_DBAccessJob_Tasklet_Execution_Table"></a>会員情報テーブルの確認</h4>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容を比較し、確認内容のとおりとなっていることを確認する。<br>
確認手順は<a href="Ch09_EnvironmentConstruction.html#Ch09_EnvironmentConstruction_OperationCheck_RefDB">Data Source Explorerを使用してデータベースを参照する</a>を参照。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">確認内容</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>statusカラム</p>
<div class="ulist">
<ul>
<li>
<p>"0"(初期状態)のレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
<li>
<p>pointカラム</p>
<div class="ulist">
<ul>
<li>
<p>ポイント加算対象について、会員種別に応じたポイントが加算されていること</p>
<div class="ulist">
<ul>
<li>
<p>typeカラムが"G"(ゴールド会員)の場合は100ポイント</p>
</li>
<li>
<p>typeカラムが"N"(一般会員)の場合は10ポイント</p>
</li>
</ul>
</div>
</li>
<li>
<p>1,000,000(上限値)を超えたレコードが存在しないこと</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>更新前後の会員情報テーブルの内容は以下のとおり。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/DBAccess/Ch09_DBAccessJob_Result_MemberInfoTable.png" alt="Table of member_info">
</div>
<div class="title">更新前後の会員情報テーブルの内容</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="container">

  <div class="common-bg">
    <div class="information">
      Macchinetta Batch Framework (2.x) Development Guideline - version 2.0.1.RELEASE, 2018-3-9
    </div>
    <div class="index">
      <a href="index.html">&gt; INDEX</a>
    </div>
  </div>

  <div class="footer-bg">
    <div class="copyright">
      &copy; Copyright 2018 NTT Corporation.
    </div>
  </div>

</div>
</body>
</html>
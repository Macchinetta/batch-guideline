<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>ファイルアクセス</title>
<link rel="stylesheet" href="./theme/css/readthedocs.css">
<link rel="stylesheet" href="./theme/css/font-awesome.min.css">
<link rel="stylesheet" href="./theme/css/coderay-asciidoctor.css">
<link rel="stylesheet" href="./theme/css/header-footer.css">
<title>Macchinetta Batch Framework (2.x) Development Guideline</title>

<div class="common-bg">
  <div class="information">
    Macchinetta Batch Framework (2.x) Development Guideline - version 2.2.1.RELEASE, 2021-3-26, commit-id:94f5df3
  </div>
  <div class="index">
    <a href="index.html">&gt; INDEX</a>
  </div>
</div>
</head>
<body id="Ch05_FileAccess" class="book toc2 toc-left">
<div id="header">
<h1>ファイルアクセス</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#Ch05_FileAccess_Overview">Overview</a>
<ul class="sectlevel2">
<li><a href="#Ch05_FileAccess_Overview_FileType">扱えるファイルの種類</a></li>
<li><a href="#Ch05_FileAccess_Overview_FileAccessComponents">フラットファイルの入出力を行うコンポーネント</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_HowToUse">How to use</a>
<ul class="sectlevel2">
<li><a href="#Ch05_FileAccess_HowToUse_VariableLength">可変長レコード</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_HowToUse_VariableLength_Input">入力</a></li>
<li><a href="#Ch05_FileAccess_HowToUse_VariableLength_Output">出力</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_HowToUse_FixedLength">固定長レコード</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_HowToUse_FixedLength_Input">入力</a></li>
<li><a href="#Ch05_FileAccess_HowToUse_FixedLength_Output">出力</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_HowToUse_SingleRecord">単一文字列レコード</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_HowToUse_SingleRecord_Input">入力</a></li>
<li><a href="#Ch05_FileAccess_HowToUse_SingleRecord_Output">出力</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_HowToUse_HeaderFooter">ヘッダとフッタ</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input">入力</a></li>
<li><a href="#Ch05_FileAccess_HowToUse_HeaderFooter_Output">出力</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_HowToUse_MultiFile">複数ファイル</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_HowToUse_MultiFile_Input">入力</a></li>
<li><a href="#Ch05_FileAccess_HowToUse_MultiFile_Output">出力</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_HowToUse_ControlBreak">コントロールブレイク</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_HowToExtend">How to extend</a>
<ul class="sectlevel2">
<li><a href="#Ch05_FileAccess_FieldSetMapper">FieldSetMapperの実装</a></li>
<li><a href="#Ch05_FileAccess_HowToExtend_Xml">XMLファイル</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_HowToExtend_Xml_Mapping">オブジェクト変換ライブラリ</a></li>
<li><a href="#Ch05_FileAccess_HowToExtend_Xml_Encoding">入出力におけるエンコーディングの仕様</a></li>
<li><a href="#Ch05_FileAccess_HowToExtend_Xml_Input">入力</a></li>
<li><a href="#Ch05_FileAccess_HowToExtend_Xml_Output">出力</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_HowToExtend_MultiFormat">マルチフォーマット</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_HowToExtend_MultiFormat_Input">入力</a></li>
<li><a href="#Ch05_FileAccess_HowToExtend_MultiFormat_Output">出力</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="Ch05_FileAccess_Overview"><a class="anchor" href="#Ch05_FileAccess_Overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本節では、ファイルの入出力を行う方法について説明する。</p>
</div>
<div class="paragraph">
<p>本機能は、チャンクモデルとタスクレットモデルとで同じ使い方になる。</p>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_Overview_FileType"><a class="anchor" href="#Ch05_FileAccess_Overview_FileType"></a>扱えるファイルの種類</h3>
<div class="paragraph">
<div class="title">扱えるファイルの種類</div>
<p>Macchinetta Batch 2.xで扱えるファイルは以下のとおりである。<br>
これは、TERASOLUNA Batch 5.xにて扱えるものと同じである。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>フラットファイル</p>
</li>
<li>
<p>XML</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ここではフラットファイルの入出力を行うための方法について説明したのち、
XMLについて<a href="#Ch05_FileAccess_HowToExtend">How to extend</a>で説明する。</p>
</div>
<div class="paragraph">
<p>まず、Macchinetta Batch 2.xで扱えるフラットファイルの種類を示す。<br>
フラットファイルにおける行をここでは<code>レコード</code>と呼び、
ファイルの種類はレコードの形式にもとづく、とする。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 1. レコード形式</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">形式</th>
<th class="tableblock halign-left valign-top">概要</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">可変長レコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CSVやTSVに代表される区切り文字により各項目を区切ったレコード形式。各項目の長さが可変である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">固定長レコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">項目の長さ(バイト数)により各項目を区切ったレコード形式。各項目の長さが固定である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">単一文字列レコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1レコードを1文字列として扱う形式。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">扱えるファイルの構造</div>
<p>フラットファイルの基本構造は以下の2点から構成される。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>レコード区分</p>
</li>
<li>
<p>レコードフォーマット</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 2. フラットファイルのフォーマットを構成する要素</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">要素</th>
<th class="tableblock halign-left valign-top">概要</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区分</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコードの種類、役割を指す。ヘッダ、データ、トレーラなどがある。<br>
詳しくは後述する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコードフォーマット</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ヘッダ、データ、トレーラレコードがそれぞれ何行あるのか、ヘッダ部～トレーラ部が複数回繰り返されるかなど、レコードの構造を指す。<br>
シングルフォーマットとマルチフォーマットがある。詳しくは後述する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Macchinetta Batch 2.xでは、各種レコード区分をもつシングルフォーマットおよびマルチフォーマットのフラットファイルを扱うことができる。</p>
</div>
<div class="paragraph">
<p>各種レコード区分およびレコードフォーマットについて説明する。</p>
</div>
<div class="paragraph">
<p>各種レコード区分の概要を以下に示す。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 3. レコード区分ごとの特徴</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">レコード区分</th>
<th class="tableblock halign-left valign-top">概要</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ヘッダレコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイル(データ部)の先頭に付与されるレコードである。<br>
フィールド名、ファイル共通の事項、データ部の集計情報などをもつ。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">データレコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイルの主な処理対象となるデータをもつレコードである。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">トレーラ/フッタレコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイル(データ部)の末尾に付与されるレコードである。<br>
ファイル共通の事項、データ部の集計情報などをもつ。<br>
シングルフォーマットの場合、フッタレコードと呼ばれることもある。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">フッタ/エンドレコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">マルチフォーマットの場合にファイルの末尾に付与されるレコードである。<br>
ファイル共通の事項、ファイル全体の集計情報などをもつ。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">レコード区分を示すフィールドについて</div>
<div class="paragraph">
<p>ヘッダレコードやトレーラレコードをもつフラットファイルでは、レコード区分を示すフィールドをもたせる場合がある。<br>
Macchinetta Batch 2.xでは特にマルチフォーマットファイルの処理において、レコード区分ごとに異なる処理を実施する場合などにレコード区分のフィールドを活用する。<br>
レコード区分によって実行する処理を選択する場合の実装は、<a href="#Ch05_FileAccess_HowToExtend_MultiFormat">マルチフォーマット</a>を参考にすること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">ファイルフォーマット関連の名称について</div>
<div class="paragraph">
<p>個々のシステムにおけるファイルフォーマットの定義によっては、
フッタレコードをエンドレコードと呼ぶなど本ガイドラインとは異なる名称が使われている場合がある。<br>
適宜読み替えを行うこと。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>シングルフォーマットおよびマルチフォーマットの概要を以下に示す。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 4. シングルフォーマットおよびマルチフォーマットの概要</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">フォーマット</th>
<th class="tableblock halign-left valign-top">概要</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">シングルフォーマット</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ヘッダn行 + データn行 + トレーラn行 の形式である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">マルチフォーマット</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(ヘッダn行 + データn行 + トレーラn行)* n + フッタn行 の形式である。<br>
シングルフォーマットを複数回繰り返した後にフッタレコードが付与されている形式である。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>マルチフォーマットのレコード構成を図に表すと下記のようになる。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FileFormat_multi.png" alt="Multi format file layout">
</div>
<div class="title">図 1. マルチフォーマットのレコード構成図</div>
</div>
<div class="paragraph">
<p>シングルフォーマット、マルチフォーマットフラットファイルの例を以下に示す。<br>
なお、ファイルの内容説明に用いるコメントアウトを示す文字として<code>//</code>を使用する。</p>
</div>
<div class="listingblock">
<div class="title">シングルフォーマット、レコード区分なしフラットファイル(CSV形式)の例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">branchId,year,month,customerId,amount  // (1)
000001,2016,1,0000000001,100000000  // (2)
000001,2016,1,0000000002,200000000  // (2)
000001,2016,1,0000000003,300000000  // (2)
000001,3,600000000  // (3)</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 5. ファイルの内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ヘッダレコードである。<br>
データ部のフィールド名を示している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データレコードである。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トレーラレコードである。<br>
データ部の集計情報を保持している。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">マルチフォーマット、レコード区分ありのフラットファイル(CSV形式)の例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">// (1)
H,branchId,year,month,customerId,amount  // (2)
D,000001,2016,1,0000000001,100000000
D,000001,2016,1,0000000002,200000000
D,000001,2016,1,0000000003,300000000
T,000001,3,600000000
H,branchId,year,month,customerId,amount  // (2)
D,00002,2016,1,0000000004,400000000
D,00002,2016,1,0000000005,500000000
D,00002,2016,1,0000000006,600000000
T,00002,3,1500000000
H,branchId,year,month,customerId,amount  // (2)
D,00003,2016,1,0000000007,700000000
D,00003,2016,1,0000000008,800000000
D,00003,2016,1,0000000009,900000000
T,00003,3,2400000000
F,3,9,4500000000  // (3)</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 6. ファイルの内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコードの先頭にレコード区分を示すフィールドをもっている。<br>
それぞれ下記のレコード区分を示す。<br>
<code>H</code>：ヘッダレコード<br>
<code>D</code>：データレコード<br>
<code>T</code>：トレーラレコード<br>
<code>F</code>：フッタレコード</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchIdが変わるごとにヘッダ、データ、トレーラを3回繰り返している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フッタレコードである。<br>
ファイル全体の集計情報を保持している。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">データ部のフォーマットに関する前提</div>
<div class="paragraph">
<p><a href="#Ch05_FileAccess_HowToUse">How to use</a>では、データ部のレコードが同一のフォーマットである事を前提として説明する。<br>
これは、データ部のレコードがすべて同じ変換対象クラスへマッピングされることを意味する。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">マルチフォーマットファイルの説明について</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_HowToUse">How to use</a>では、シングルフォーマットファイルについて説明する。</p>
</li>
<li>
<p>マルチフォーマットや上記の構造にフッタ部を含む構造をもつフラットファイルについては、<a href="#Ch05_FileAccess_HowToExtend">How to extend</a>を参照。</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_Overview_FileAccessComponents"><a class="anchor" href="#Ch05_FileAccess_Overview_FileAccessComponents"></a>フラットファイルの入出力を行うコンポーネント</h3>
<div class="paragraph">
<p>フラットファイルを扱うためのクラスを示す。</p>
</div>
<div class="paragraph">
<div class="title">入力</div>
<p>フラットファイルの入力を行うために使用するクラスの関連は以下のとおりである。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemReader_component_relationship_class.png" alt="Component relationship FlatFileItemReader class diagram">
</div>
<div class="title">図 2. フラットファイルの入力を行うために使用するクラスの関連</div>
</div>
<div class="paragraph">
<p>各コンポーネントの呼び出し関係は以下のとおりである。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemReader_component_relationship_sequence.png" alt="Component relationship FlatFileItemReader sequence diagram">
</div>
<div class="title">図 3. 各コンポーネントの呼び出し関係</div>
</div>
<div class="paragraph">
<p>各コンポーネントの詳細を以下に示す。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.FlatFileItemReader</dt>
<dd>
<p>フラットファイルを読み込みに使用する<code>ItemReader</code>の実装クラス。以下のコンポーネントを利用する。<br>
簡単な処理の流れは以下のとおり。<br>
1.<code>BufferedReaderFactory</code>を使用して<code>BufferedReader</code>を取得する。<br>
2.取得した<code>BufferedReader</code>を使用してフラットファイルから1レコードを読み込む。<br>
3.<code>LineMapper</code>を使用して1レコードを対象Beanへマッピングする。</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.BufferedReaderFactory</dt>
<dd>
<p>ファイルを読み込むための<code>BufferedReader</code>を生成する。</p>
</dd>
<dt class="hdlist1">org.springframework.batch.item.file.LineMapper</dt>
<dd>
<p>1レコードを対象Beanへマッピングする。以下のコンポーネントを利用する。<br>
簡単な処理の流れは以下のとおり。<br>
1.<code>LineTokenizer</code>を使用して1レコードを各項目に分割する。<br>
2.<code>FieldSetMapper</code>によって分割した項目をBeanのプロパティにマッピングする。</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.transform.LineTokenizer</dt>
<dd>
<p>ファイルから取得した1レコードを各項目に分割する。<br>
分割された各項目は<code>FieldSet</code>クラスに格納される。</p>
</dd>
<dt class="hdlist1">org.springframework.batch.item.file.mapping.FieldSetMapper</dt>
<dd>
<p>分割した1レコード内の各項目を対象Beanのプロパティへマッピングする。</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">出力</div>
<p>フラットファイルの出力を行うために使用するクラスの関連は以下のとおりである。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemWriter_component_relationship_class.png" alt="Component relationship FlatFileItemWriter class diagram">
</div>
<div class="title">図 4. フラットファイルの出力を行うために使用するクラスの関連</div>
</div>
<div class="paragraph">
<p>各コンポーネントの呼び出し関係は以下のとおりである。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemWriter_component_relationship_sequence.png" alt="Component relationship FlatFileItemWriter sequence diagram">
</div>
<div class="title">図 5. 各コンポーネントの呼び出し関係</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.FlatFileItemWriter</dt>
<dd>
<p>フラットファイルへの書き出しに使用する<code>ItemWriter</code>の実装クラス。以下のコンポーネントを利用する。
<code>LineAggregator</code>対象Beanを1レコードへマッピングする。</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.transform.LineAggregator</dt>
<dd>
<p>対象Beanを1レコードへマッピングするために使う。
Beanのプロパティとレコード内の各項目とのマッピングは<code>FieldExtractor</code>で行う。</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.transform.FieldExtractor</dt>
<dd>
<p>対象Beanのプロパティを1レコード内の各項目へマッピングする。</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch05_FileAccess_HowToUse"><a class="anchor" href="#Ch05_FileAccess_HowToUse"></a>How to use</h2>
<div class="sectionbody">
<div class="paragraph">
<p>フラットファイルのレコード形式別に使い方を説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_HowToUse_VariableLength">可変長レコード</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_HowToUse_FixedLength">固定長レコード</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_HowToUse_SingleRecord">単一文字列レコード</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>その後、以下の項目について説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_HowToUse_HeaderFooter">ヘッダとフッタ</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_HowToUse_MultiFile">複数ファイル</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_HowToUse_ControlBreak">コントロールブレイク</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_HowToUse_VariableLength"><a class="anchor" href="#Ch05_FileAccess_HowToUse_VariableLength"></a>可変長レコード</h3>
<div class="paragraph">
<p>可変長レコードファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToUse_VariableLength_Input"><a class="anchor" href="#Ch05_FileAccess_HowToUse_VariableLength_Input"></a>入力</h4>
<div class="paragraph">
<p>下記の入力ファイルを読み込むための設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="comment">&lt;!-- (6) (7) (8) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:quoteCharacter</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (9) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 7. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルの文字コードを設定する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Spring Batchが提供するコンポーネントの文字コードのデフォルト値はItemReaderとItemWriterで異なっている(ItemWriterのデフォルト値は「UTF-8」)。<br>
そのため、デフォルト値の値を使用する場合においても明示的に文字コードを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVMのデフォルト文字セット</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueを設定すると、入力ファイルが存在しない(開けない)場合に例外が発生する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.mapping.DefaultLineMapper</code>を設定する。<br>
<code>DefaultLineMapper</code>は、設定された<code>LineTokenizer</code>と<code>FieldSetMapper</code>を用いてレコードを変換対象クラスへ変換する基本的な動作を提供する<code>LineMapper</code>である。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineTokenizer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.transform.DelimitedLineTokenizer</code>を設定する。<br>
<code>DelimitedLineTokenizer</code>は、区切り文字を指定してレコードを分割する<code>LineTokenizer</code>の実装クラス。<br>
CSV形式の一般的書式とされるRFC-4180の仕様に定義されている、エスケープされた改行、区切り文字、囲み文字の読み込みに対応している。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1レコードの各項目に名前を付与する。<br>
<code>FieldSetMapper</code>で使われる<code>FieldSet</code>で設定した名前を用いて各項目を取り出すことができるようになる。<br>
レコードの先頭から各名前をカンマ区切りで設定する。<br>
<code>BeanWrapperFieldSetMapper</code>を利用する場合は、必須設定である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delimiter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">区切り文字を設定する</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">カンマ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">quoteCharacter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">囲み文字を設定する</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldSetMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列や数字など特別な変換処理が不要な場合は、<code>org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</code>を利用し、
<code>targetType</code>属性に変換対象クラスを指定する。
これにより、(5)で設定した各項目の名前と一致するフィールドに値を自動的に設定したインスタンスを生成する。<br>
変換処理が必要な場合は、<code>org.springframework.batch.item.file.mapping.FieldSetMapper</code>の実装クラスを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">FieldSetMapperの独自実装について</div>
<div class="paragraph">
<p>FieldSetMapperを独自に実装する場合については、<a href="#Ch05_FileAccess_HowToExtend">How to extend</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">TSV形式ファイルの入力方法</div>
<div class="paragraph">
<p>TSVファイルの読み込みを行う場合には、区切り文字にタブを設定することで実現可能である。</p>
</div>
<div class="listingblock">
<div class="title">TSVファイル読み込み時:区切り文字設定例(定数による設定)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;util:constant</span>
            <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer.DELIMITER_TAB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>または、以下のようにしてもよい。</p>
</div>
<div class="listingblock">
<div class="title">TSVファイル読み込み時:区切り文字設定例(文字参照による設定)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#09;</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">BeanWrapperFieldSetMapperの留意事項</div>
<div class="paragraph">
<p><code>BeanWrapperFieldSetMapper</code>は、文字列を<code>trim</code>するため、先頭・末尾の空白と制御文字が削除されることに留意すること。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToUse_VariableLength_Output"><a class="anchor" href="#Ch05_FileAccess_HowToUse_VariableLength_Output"></a>出力</h4>
<div class="paragraph">
<p>下記の出力ファイルを書き出すための設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">001,CustomerName001,CustomerAddress001,11111111111,001
002,CustomerName002,CustomerAddress002,11111111111,002
003,CustomerName003,CustomerAddress003,11111111111,003</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Customer</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerName;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerAddress;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerTel;
    <span class="directive">private</span> <span class="predefined-type">String</span> chargeBranchId;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> createDate;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> updateDate;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のファイルを書き出すための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (9) --&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (10) --&gt;</span>
        <span class="comment">&lt;!-- (11) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId,customerName,customerAddress,customerTel,chargeBranchId</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 8. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルの文字コードを設定する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Spring Batchが提供するコンポーネントの文字コードのデフォルト値はItemReaderとItemWriterで異なっている(ItemReaderのデフォルト値は「JavaVMのデフォルト文字セット」)。<br>
そのため、デフォルト値の値を使用する場合においても明示的に文字コードを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区切り(改行コード)を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">システムプロパティの<code>line.separator</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appendAllowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、既存のファイルに追記をする。<br>
<span class="icon"><i class="fa fa-warning"></i></span> trueの場合、shouldDeleteIfExistsの設定値は無効化されるため、注意が必要である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> appendAllowedがtrueの場合は、この設定は無効化されるため、値を指定しないことを推奨する。<br>
trueの場合、既にファイルが存在すれば削除する。<br>
falseの場合、既にファイルが存在すれば例外をスローする。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、出力件数が0件であれば出力対象ファイルを削除する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> 他の設定との組み合わせによって意図しない動作をする場合があるため、trueは設定しないことを推奨する。詳細は<a href="#Ch05_FileAccess_HowToUse_VariableLength_Output_AboutShouldDeleteIfEmpty">後述</a>する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクション制御を行うかを設定する。詳細は、<a href="Ch05_Transaction.html#Ch05_Transaction">トランザクション制御</a>を参照。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.transform.DelimitedLineAggregator</code>を設定する。<br>
フィールドを囲み文字で囲む場合は、<code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code>を設定する。<br>
<code>EnclosableDelimitedLineAggregator</code>の使用方法は後述する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delimiter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">区切り文字を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">カンマ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldExtractor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列や数字など特別な変換処理が不要な場合は、<code>org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</code>が利用できる。<br>
変換処理が必要な場合は、<code>org.springframework.batch.item.file.transform.FieldExtractor</code>の実装クラスを設定する。<br>
<code>FieldExtractor</code>の実装例は<a href="#Ch05_FileAccess_HowToUse_FixedLength_Output">固定長レコードの出力</a>にて、全角文字のフォーマットを例に説明しているためそちらを参照。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1レコードの各項目に名前を付与する。 レコードの先頭から各名前をカンマ区切りで設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div id="Ch05_FileAccess_HowToUse_VariableLength_Output_AboutShouldDeleteIfEmpty" class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">FlatFileItemWriterのshouldDeleteIfEmptyプロパティにはtrueは設定しないことを推奨する</div>
<div class="paragraph">
<p>FlatFileItemWriterは、以下のような組み合わせでプロパティ設定を行った場合に意図しないファイル削除が行われてしまう。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>p:shouldDeleteIfEmpty="true"</code></p>
</li>
<li>
<p><code>p:shouldDeleteIfExists="false"</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>理由は以下の通りである。<br>
shouldDeleteIfEmptyにtrueを設定すると、出力件数が0件の場合に出力対象ファイルの削除が行われる。<br>
この「出力件数が0件の場合」には、shouldDeleteIfExistsにfalseを設定した状態で出力対象ファイルが既に存在していた場合も含まれる。</p>
</div>
<div class="paragraph">
<p>よって、上記の組み合わせでプロパティを指定すると既に出力対象ファイルが存在する場合に出力対象ファイルの削除が行われてしまう。<br>
これは、出力対象ファイルが既に存在する場合は例外をスローさせて処理を終了したい場合には意図しない動作である。</p>
</div>
<div class="paragraph">
<p>このような意図しない動作が行われるため、shouldDeleteIfEmptyにはtrueは設定しないことを推奨する。</p>
</div>
<div class="paragraph">
<p>また、出力件数が0件であった場合にファイル削除等の後処理を行う場合は、shouldDeleteIfEmptyではなくOSコマンドやListener等で実装すること。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">EnclosableDelimitedLineAggregatorの使用方法</div>
<p>フィールドを囲み文字で囲む場合は、TERASOLUNA Batch 5.xが提供する<code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code>を使用する。<br>
<code>EnclosableDelimitedLineAggregator</code>の仕様は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>囲み文字、区切り文字を任意に指定可能</p>
<div class="ulist">
<ul>
<li>
<p>デフォルトはCSV形式で一般的に使用される以下の値である</p>
<div class="ulist">
<ul>
<li>
<p>囲み文字：<code>"</code>(ダブルクォート)</p>
</li>
<li>
<p>区切り文字：<code>,</code>(カンマ)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>フィールドに行頭復帰、改行、囲み文字、区切り文字が含まれている場合、囲み文字でフィールドを囲む</p>
<div class="ulist">
<ul>
<li>
<p>囲み文字が含まれている場合、直前に囲み文字を付与しエスケープする</p>
</li>
<li>
<p>設定によってすべてのフィールドを囲み文字で囲むことが可能</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>EnclosableDelimitedLineAggregator</code>の使用方法を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">&quot;001&quot;,&quot;CustomerName&quot;&quot;001&quot;&quot;&quot;,&quot;CustomerAddress,001&quot;,&quot;11111111111&quot;,&quot;001&quot;
&quot;002&quot;,&quot;CustomerName&quot;&quot;002&quot;&quot;&quot;,&quot;CustomerAddress,002&quot;,&quot;11111111111&quot;,&quot;002&quot;
&quot;003&quot;,&quot;CustomerName&quot;&quot;003&quot;&quot;&quot;,&quot;CustomerAddress,003&quot;,&quot;11111111111&quot;,&quot;003&quot;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// 上記の例と同様</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義例(lineAggregatorの設定のみ)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
  <span class="comment">&lt;!-- (2) (3) (4) --&gt;</span>
  <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">p:enclosure</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span>
        <span class="attribute-name">p:allEnclosing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 9. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delimiter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">区切り文字を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">カンマ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">enclosure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">囲み文字を設定する。<br>
囲み文字がフィールドに含まれる場合は、エスケープ処理として囲み文字を2つ連結されたものへ置換される。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ダブルクォート</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allEnclosing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、すべてのフィールドが囲み文字で囲まれる。<br>
falseの場合フィールド内に行頭復帰(CR)、改行(LF)、区切り文字、囲み文字が含まれるフィールドのみ囲み文字で囲まれる。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">EnclosableDelimitedLineAggregatorの提供について</div>
<div class="paragraph">
<p>TERASOLUNA Batch 5.xでは、RFC-4180の仕様を満たすことを目的として拡張クラス<code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code>を提供している。</p>
</div>
<div class="paragraph">
<p>Spring Batchが提供している<code>org.springframework.batch.item.file.transform.DelimitedLineAggregator</code>はフィールドを囲み文字で囲む処理に対応しておらず、RFC-4180の仕様を満たすことができないためである。
<a href="https://github.com/spring-projects/spring-batch/issues/1139">Spring Batch/BATCH-2463</a> を参照。</p>
</div>
<div class="paragraph">
<p>CSV形式のフォーマットについて、CSV形式の一般的書式とされるRFC-4180では下記のように定義されている。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>フィールドに改行、囲み文字、区切り文字が含まれていない場合、各フィールドはダブルクォート(囲み文字)で囲んでも囲わなくてもよい</p>
</li>
<li>
<p>改行(CRLF)、ダブルクォート(囲み文字)、カンマ(区切り文字)を含むフィールドは、ダブルクォートで囲むべきである</p>
</li>
<li>
<p>フィールドがダブルクォート(囲み文字)で囲まれている場合、フィールドの値に含まれるダブルクォートは、その直前に1つダブルクォートを付加して、エスケープしなければならない</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">TSV形式ファイルの出力方法</div>
<div class="paragraph">
<p>TSVファイルの出力を行う場合には、区切り文字にタブを設定することで実現可能である。</p>
</div>
<div class="listingblock">
<div class="title">TSVファイル出力時の区切り文字設定例(定数による設定)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;util:constant</span>
            <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer.DELIMITER_TAB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>または、以下のようにしてもよい。</p>
</div>
<div class="listingblock">
<div class="title">TSVファイル出力時の区切り文字設定例(文字参照による設定)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#09;</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_HowToUse_FixedLength"><a class="anchor" href="#Ch05_FileAccess_HowToUse_FixedLength"></a>固定長レコード</h3>
<div class="paragraph">
<p>固定長レコードファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToUse_FixedLength_Input"><a class="anchor" href="#Ch05_FileAccess_HowToUse_FixedLength_Input"></a>入力</h4>
<div class="paragraph">
<p>下記の入力ファイルを読み込むための設定例を示す。</p>
</div>
<div class="paragraph">
<p>Macchinetta Batch 2.xでは、レコードの区切りを改行で判断する形式とバイト数で判断する形式
に対応している。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例1(レコードの区切りは改行)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">売上012016 1   00000011000000000
売上022017 2   00000022000000000
売上032018 3   00000033000000000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">入力ファイル例2(レコードの区切りはバイト数、32バイトで1レコード)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">売上012016 1   00000011000000000売上022017 2   00000022000000000売上032018 3   00000033000000000</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 10. 入力ファイル仕様</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 35%;">
<col style="width: 35%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">フィールド名</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">バイト数</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">year</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">customerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bufferedReaderFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.DefaultBufferedReaderFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (6) --&gt;</span>
                <span class="comment">&lt;!-- (7) --&gt;</span>
                <span class="comment">&lt;!-- (8) --&gt;</span>
                <span class="comment">&lt;!-- (9) --&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.transform.FixedByteLengthLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">c:ranges</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1-6, 7-10, 11-12, 13-22, 23-32</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">c:charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (10) --&gt;</span>
              <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 11. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルの文字コードを設定する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Spring Batchが提供するコンポーネントの文字コードのデフォルト値はItemReaderとItemWriterで異なっている(ItemWriterのデフォルト値は「UTF-8」)。<br>
そのため、デフォルト値の値を使用する場合においても明示的に文字コードを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVMのデフォルト文字セット</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueを設定すると、入力ファイルが存在しない(開けない)場合に例外が発生する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bufferedReaderFactory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコードの区切りを改行で判断する場合は、デフォルト値である<code>org.springframework.batch.item.file.DefaultBufferedReaderFactory</code>を使用する。
<code>DefaultBufferedReaderFactory</code>が生成する<code>BufferedReader</code>は改行までを1レコードとして取得する。</p>
<p class="tableblock">レコードの区切りをバイト数で判断する場合は、TERASOLUNA Batch 5.xが提供する<code>org.terasoluna.batch.item.file.FixedByteLengthBufferedReaderFactory</code>を設定する。
<code>FixedByteLengthBufferedReaderFactory</code>が生成する<code>BufferedReader</code>は指定したバイト数までを1レコードとして取得する。<br>
<code>FixedByteLengthBufferedReaderFactory</code>の詳しい仕様および使用方法は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DefaultBufferedReaderFactory</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.mapping.DefaultLineMapper</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineTokenizer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TERASOLUNA Batch 5.xが提供する<code>org.terasoluna.batch.item.file.transform.FixedByteLengthLineTokenizer</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1レコードの各項目に名前を付与する。<br>
<code>FieldSetMapper</code>で使われる<code>FieldSet</code>で設定した名前を用いて各項目を取り出すことができるようになる。<br>
レコードの先頭から各名前をカンマ区切りで設定する。<br>
<code>BeanWrapperFieldSetMapper</code>を利用する場合は、必須設定である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ranges<br>
(コンストラクタ引数)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">区切り位置を設定する。レコードの先頭から区切り位置をカンマ区切りで設定する。<br>
各区切り位置の単位はバイトであり、<code>開始位置-終了位置</code>形式で指定する。<br>
区切り位置を設定した順番でレコードから指定された範囲を取得し、<code>FieldSet</code>に格納される。<br>
(6)のnamesを指定した場合は区切り位置を設定した順番でnamesと対応付けて<code>FieldSet</code>に格納される。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">charset<br>
(コンストラクタ引数)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)で指定した文字コードと同じ値を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldSetMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列や数字など特別な変換処理が不要な場合は、<code>org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</code>を利用し、
<code>targetType</code>属性に変換対象クラスを指定する。
これにより、(6)で設定した各項目の名前と一致するフィールドに値を自動的に設定したインスタンスを生成する。<br>
変換処理が必要な場合は、<code>org.springframework.batch.item.file.mapping.FieldSetMapper</code>の実装クラスを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">FieldSetMapperの独自実装について</div>
<div class="paragraph">
<p>FieldSetMapperを独自に実装する場合については、<a href="#Ch05_FileAccess_HowToExtend">How to extend</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">FixedByteLengthBufferedReaderFactoryの使用方法</div>
<p>レコードの区切りをバイト数で判断するファイルを読み込む場合は、TERASOLUNA Batch 5.xが提供する<code>org.terasoluna.batch.item.file.FixedByteLengthBufferedReaderFactory</code>を使用する。</p>
</div>
<div class="paragraph">
<p><code>FixedByteLengthBufferedReaderFactory</code>を使用することで指定したバイト数までを1レコードとして取得することができる。<br>
<code>FixedByteLengthBufferedReaderFactory</code>の仕様は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>コンストラクタ引数としてレコードのバイト数を指定する</p>
</li>
<li>
<p>指定されたバイト数を1レコードとしてファイルを読み込む<code>FixedByteLengthBufferedReader</code>を生成する</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>FixedByteLengthBufferedReader</code>の使用は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>インスタンス生成時に指定されたバイト長を1レコードとしてファイルを読み込む</p>
</li>
<li>
<p>改行コードが存在する場合、破棄せず1レコードのバイト長に含めて読み込みを行う</p>
</li>
<li>
<p>読み込み時に使用するファイルエンコーディングは<code>FlatFileItemWriter</code>に設定したものが<code>BufferedReader</code>生成時に設定される</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>FixedByteLengthBufferedReaderFactory</code>の定義方法を以下に示す。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bufferedReaderFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.FixedByteLengthBufferedReaderFactory</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">c:byteLength</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">32</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 12. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">byteLength<br>
(コンストラクタ引数)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1レコードあたりのバイト数を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">固定長ファイルを扱う場合に使用するコンポーネント</div>
<div class="paragraph">
<p>固定長ファイルを扱う場合は、Macchinetta Batch 2.xが提供するコンポーネントを使うことを前提にしている。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">FixedByteLengthBufferedReaderFactory</dt>
<dd>
<p>改行なし固定長ファイルから、指定した文字コードのバイト数で1レコードを読み込む<code>BufferedReader</code>生成クラス</p>
</dd>
<dt class="hdlist1">FixedByteLengthLineTokenizer</dt>
<dd>
<p>マルチバイト文字列に対応したバイト数区切りの<code>FixedLengthTokenizer</code>拡張クラス</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">マルチバイト文字列を含むレコードを処理する場合</div>
<div class="paragraph">
<p>マルチバイト文字列を含むレコードを処理する場合は、<code>FixedByteLengthLineTokenizer</code>を必ず利用する。<br>
Spring Batchが提供する<code>FixedLengthTokenizer</code>は、レコードをバイト数ではなく文字数で区切ってしまうため、期待どおりの項目切り出しが行われない恐れがある。
この点については<a href="https://github.com/spring-projects/spring-batch/issues/1062">Spring Batch/BATCH-2540</a>で報告しているため、今後不要になる可能性がある。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
FieldSetMapperの実装については、<a href="#Ch05_FileAccess_HowToExtend">How to extend</a>を参照。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToUse_FixedLength_Output"><a class="anchor" href="#Ch05_FileAccess_HowToUse_FixedLength_Output"></a>出力</h4>
<div class="paragraph">
<p>下記の出力ファイルを書き出すための設定例を示す。</p>
</div>
<div class="paragraph">
<p>固定長ファイルを書き出すためには、Beanから取得した値をフィールドのバイト数にあわせてフォーマットを行う必要がある。<br>
フォーマットの実行方法は全角文字が含まれるか否かによって下記のように異なる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>全角文字が含まれない場合(半角文字のみであり文字のバイト数が一定)</p>
<div class="ulist">
<ul>
<li>
<p><code>FormatterLineAggregator</code>にてフォーマットを行う。</p>
</li>
<li>
<p>フォーマットは、<code>String.format</code>メソッドで使用する書式で設定する。</p>
</li>
</ul>
</div>
</li>
<li>
<p>全角文字が含まれる場合(文字コードによって文字のバイト数が一定ではない)</p>
<div class="ulist">
<ul>
<li>
<p><code>FieldExtractor</code>の実装クラスにてフォーマットを行う。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>まず、出力ファイルに全角文字が含まれない場合の設定例を示し、その後全角文字が含まれる場合の設定例を示す。</p>
</div>
<div class="paragraph">
<p>出力ファイルに全角文字が含まれない場合の設定について下記に示す。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">   0012016 10000000001  10000000
   0022017 20000000002  20000000
   0032018 30000000003  30000000</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 13. 出力ファイル仕様</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 35%;">
<col style="width: 35%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">フィールド名</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">バイト数</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">year</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">customerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>フィールドのバイト数に満たない部分は半角スペース埋めとしている。</p>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のファイルを書き出すための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.FormatterLineAggregator</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:format</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">%6s%4s%2s%10s%10s</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (9) --&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (10) --&gt;</span>
              <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (11) --&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 14. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルの文字コードを設定する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Spring Batchが提供するコンポーネントの文字コードのデフォルト値はItemReaderとItemWriterで異なっている(ItemReaderのデフォルト値は「JavaVMのデフォルト文字セット」)。<br>
そのため、デフォルト値の値を使用する場合においても明示的に文字コードを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区切り(改行コード)を設定する。<br>
改行なしにする場合は、空文字を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">システムプロパティの<code>line.separator</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appendAllowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、既存のファイルに追記をする。<br>
<span class="icon"><i class="fa fa-warning"></i></span> trueの場合、shouldDeleteIfExistsの設定値は無効化されるため、注意が必要である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> appendAllowedがtrueの場合は、この設定は無効化されるため、値を指定しないことを推奨する。<br>
trueの場合、既にファイルが存在すれば削除する。<br>
falseの場合、既にファイルが存在すれば例外をスローする。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、出力件数が0件であれば出力対象ファイルを削除する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> 他の設定との組み合わせによって意図しない動作をする場合があるため、trueは設定しないことを推奨する。詳細は<a href="#Ch05_FileAccess_HowToUse_VariableLength_Output_AboutShouldDeleteIfEmpty">可変長レコードの出力の注意書き</a>を参照。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクション制御を行うかを設定する。詳細は、<a href="Ch05_Transaction.html#Ch05_Transaction">トランザクション制御</a>を参照。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.transform.FormatterLineAggregator</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String.format</code>メソッドで使用する書式で出力フォーマットを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldExtractor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列や数字など特別な変換処理、全角文字のフォーマットが不要な場合は、<code>org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</code>が利用できる。</p>
<p class="tableblock">値の変換処理や全角文字をフォーマットする等の対応が必要な場合は、<code>org.springframework.batch.item.file.transform.FieldExtractor</code>の実装クラスを設定する。<br>
全角文字をフォーマットする場合における<code>FieldExtractor</code>の実装例は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PassThroughFieldExtractor</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1レコードの各項目に名前を付与する。 レコードの先頭から各フィールドの名前をカンマ区切りで設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">PassThroughFieldExtractorとは</div>
<div class="paragraph">
<p><code>FormatterLineAggregator</code>がもつ<code>fieldExtractor</code>プロパティのデフォルト値は<code>org.springframework.batch.item.file.transform.PassThroughFieldExtractor</code>である。</p>
</div>
<div class="paragraph">
<p><code>PassThroughFieldExtractor</code>は、もとのアイテムに対して処理を行わずに返すクラスであり、<code>FieldExtractor</code>にて何も処理を行わない場合に使用する。</p>
</div>
<div class="paragraph">
<p>アイテムが配列またはコレクションの場合はそのまま返されるが、それ以外の場合は、単一要素の配列にラップされる。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">全角文字が含まれるフィールドに対してフォーマットを行う際の設定例</div>
<p>全角文字に対するフォーマットを行う場合、文字コードにより1文字あたりのバイト数が異なるため、<code>FormatterLineAggregator</code>ではなく、<code>FieldExtractor</code>の実装クラスを使用する。</p>
</div>
<div class="paragraph">
<p><code>FieldExtractor</code>の実装クラスは以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FieldExtractor</code>クラスを実装し、<code>extract</code>メソッドをオーバーライドする</p>
</li>
<li>
<p><code>extract</code>メソッドは以下の要領で実装する</p>
<div class="ulist">
<ul>
<li>
<p>item(処理対象のBean)から値を取得し、適宜変換処理等を行う</p>
</li>
<li>
<p>Object型の配列に格納し返す</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>FieldExtractor</code>の実装クラスで行う全角文字を含むフィールドのフォーマットは以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>文字コードに対するバイト数を取得する</p>
</li>
<li>
<p>取得したバイト数をもとにパディング・トリム処理で整形する</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以下に全角文字を含むフィールドをフォーマットする場合の設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">   0012016 10000000001  10000000
  番号2017 2 売上高002  20000000
 番号32018 3   売上003  30000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力ファイルの使用は上記の例と同様。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義(lineAggregatorの設定のみ)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.FormatterLineAggregator</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:format</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">%s%4s%2s%s%10s</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.plan.SalesPlanFixedLengthFieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 15. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.transform.FormatterLineAggregator</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String.format</code>メソッドで使用する書式で出力フォーマットを設定する。<br>
全角文字が含まれないフィールドに対してのみ桁数の指定をしている。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldExtractor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FieldExtractor</code>の実装クラスを設定する。<br>
実装例は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PassThroughFieldExtractor</code></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">全角文字をフォーマットするFieldExtractorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanFixedLengthFieldExtractor</span> <span class="directive">implements</span> FieldExtractor&lt;SalesPlanDetail&gt; {
    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Object</span><span class="type">[]</span> extract(SalesPlanDetail item) {
        <span class="predefined-type">Object</span><span class="type">[]</span> values = <span class="keyword">new</span> <span class="predefined-type">Object</span>[<span class="integer">5</span>];  <span class="comment">// (2)</span>

        <span class="comment">// (3)</span>
        values[<span class="integer">0</span>] = fillUpSpace(item.getBranchId(), <span class="integer">6</span>);  <span class="comment">// (4)</span>
        values[<span class="integer">1</span>] = item.getYear();
        values[<span class="integer">2</span>] = item.getMonth();
        values[<span class="integer">3</span>] = fillUpSpace(item.getCustomerId(), <span class="integer">10</span>);  <span class="comment">// (4)</span>
        values[<span class="integer">4</span>] = item.getAmount();

        <span class="keyword">return</span> values; <span class="comment">// (8)</span>
    }

    <span class="comment">// It is a simple impl for example</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> fillUpSpace(<span class="predefined-type">String</span> val, <span class="type">int</span> num) {
        <span class="predefined-type">String</span> charsetName = <span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>;
        <span class="type">int</span> len;
        <span class="keyword">try</span> {
            len = val.getBytes(charsetName).length;  <span class="comment">// (5)</span>
        } <span class="keyword">catch</span> (<span class="exception">UnsupportedEncodingException</span> e) {
            <span class="comment">// omitted exception handling</span>
        }

        <span class="comment">// (6)</span>
        <span class="keyword">if</span> (len &gt; num) {
            <span class="keyword">throw</span> <span class="keyword">new</span> IncorrectFieldLengthException(<span class="string"><span class="delimiter">&quot;</span><span class="content">The length of field is invalid. </span><span class="delimiter">&quot;</span></span> + <span class="string"><span class="delimiter">&quot;</span><span class="content">[value:</span><span class="delimiter">&quot;</span></span> + val + <span class="string"><span class="delimiter">&quot;</span><span class="content">][length:</span><span class="delimiter">&quot;</span></span>
                    + len + <span class="string"><span class="delimiter">&quot;</span><span class="content">][expect length:</span><span class="delimiter">&quot;</span></span> + num + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>);
        }

        <span class="keyword">if</span> (num == len) {
            <span class="keyword">return</span> val;
        }

        <span class="predefined-type">StringBuilder</span> filledVal = <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>();
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; (num - len); i++) {  <span class="comment">// (7)</span>
            filledVal.append(<span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span>);
        }
        filledVal.append(val);

        <span class="keyword">return</span> filledVal.toString();
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 16. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FieldExtractor</code>クラスを実装し、<code>extract</code>メソッドをオーバーライドする。<br>
<code>FieldExtractor</code>の型引数には変換対象クラスを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">変換処理等を行ったデータを格納するためのObject型配列を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受けたitem(処理対象のBean)から値を取得し、適宜変換処理を行い、Object型の配列に格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">全角文字が含まれるフィールドに対してフォーマット処理を行う。<br>
フォーマット処理の詳細は(5)、(6)を参照。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字コードに対するバイト数を取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">取得したバイト数が最大長を超えている場合は、例外をスローする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">取得したバイト数をもとにパディング・トリム処理で整形する。<br>
実装例では指定されたバイト数まで文字列の前に空白を付与している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理結果を保持しているObject型の配列を返す。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_HowToUse_SingleRecord"><a class="anchor" href="#Ch05_FileAccess_HowToUse_SingleRecord"></a>単一文字列レコード</h3>
<div class="paragraph">
<p>単一文字列レコードファイルを扱う場合の定義方法を説明する</p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToUse_SingleRecord_Input"><a class="anchor" href="#Ch05_FileAccess_HowToUse_SingleRecord_Input"></a>入力</h4>
<div class="paragraph">
<p>下記の入力ファイルを読み込むための設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Summary1:4,000,000,000
Summary2:5,000,000,000
Summary3:6,000,000,000</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.PassThroughLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 17. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルの文字コードを設定する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Spring Batchが提供するコンポーネントの文字コードのデフォルト値はItemReaderとItemWriterで異なっている(ItemWriterのデフォルト値は「UTF-8」)。<br>
そのため、デフォルト値の値を使用する場合においても明示的に文字コードを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVMのデフォルト文字セット</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueを設定すると、入力ファイルが存在しない(開けない)場合に例外が発生する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.mapping.PassThroughLineMapper</code>を設定する。<br>
<code>PassThroughLineMapper</code>は渡されたレコードをそのまま文字列として返す<code>LineMapper</code>の実装クラスである。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToUse_SingleRecord_Output"><a class="anchor" href="#Ch05_FileAccess_HowToUse_SingleRecord_Output"></a>出力</h4>
<div class="paragraph">
<p>下記の出力ファイルを書き出すための設定例を示す。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Summary1:4,000,000,000
Summary2:5,000,000,000
Summary3:6,000,000,000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.PassThroughLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 18. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルの文字コードを設定する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> Spring Batchが提供するコンポーネントの文字コードのデフォルト値はItemReaderとItemWriterで異なっている(ItemReaderのデフォルト値は「JavaVMのデフォルト文字セット」)。<br>
そのため、デフォルト値の値を使用する場合においても明示的に文字コードを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区切り(改行コード)を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">システムプロパティの<code>line.separator</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appendAllowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、既存のファイルに追記をする。<br>
<span class="icon"><i class="fa fa-warning"></i></span> trueの場合、shouldDeleteIfExistsの設定値は無効化されるため、注意が必要である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> appendAllowedがtrueの場合は、この設定は無効化されるため、値を指定しないことを推奨する。<br>
trueの場合、既にファイルが存在すれば削除する。<br>
falseの場合、既にファイルが存在すれば例外をスローする。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、出力件数が0件であれば出力対象ファイルを削除する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> 他の設定との組み合わせによって意図しない動作をする場合があるため、trueは設定しないことを推奨する。詳細は<a href="#Ch05_FileAccess_HowToUse_VariableLength_Output_AboutShouldDeleteIfEmpty">可変長レコードの出力の注意書き</a>を参照。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクション制御を行うかを設定する。詳細は、<a href="Ch05_Transaction.html#Ch05_Transaction">トランザクション制御</a>を参照。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.transform.PassThroughLineAggregator</code>を設定する。<br>
<code>PassThroughLineAggregator</code>はitem(処理対象のBean)をそのまま文字列へ変換(<code>item.toString()</code>を実行)する<code>LineAggregator</code>の実装クラスである。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_HowToUse_HeaderFooter"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter"></a>ヘッダとフッタ</h3>
<div class="paragraph">
<p>ヘッダ・フッタがある場合の入出力方法を説明する。</p>
</div>
<div class="paragraph">
<p>ここでは行数指定にてヘッダ・フッタを読み飛ばす方法を説明する。<br>
ヘッダ・フッタのレコード数が可変であり行数指定ができない場合は、<a href="#Ch05_FileAccess_HowToExtend_MultiFormat_Input">マルチフォーマットの入力</a>を参考に<code>PatternMatchingCompositeLineMapper</code>を使用すること。</p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToUse_HeaderFooter_Input"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input"></a>入力</h4>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToUse_HeaderFooter_Input_SkipHeaders"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_SkipHeaders"></a>ヘッダの読み飛ばし</h5>
<div class="paragraph">
<p>ヘッダレコードを読み飛ばす方法には以下に示す2パターンがある。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FlatFileItemReader</code>の<code>linesToSkip</code>にファイルの先頭から読み飛ばす行数を設定</p>
</li>
<li>
<p>OSコマンドによる前処理でヘッダレコードを取り除く</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">sales_plan_detail_11
branchId,year,month,customerId,amount
000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>先頭から2行がヘッダレコードである。</p>
</div>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">linesToSkipによる読み飛ばし</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:linesToSkip</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 19. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">linesToSkip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">読み飛ばすヘッダ行数を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">OSコマンドによる読み飛ばし処理</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Remove number of lines in header from the top of input file
tail -n +`expr 2 + 1` input.txt &gt; output.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>tailコマンドを利用し、入力ファイルinput.txtの3行目以降を取得し、output.txtに出力している。
tailコマンドのオプション<code>-n +K</code>に指定する値はヘッダレコードの数+1となるため注意すること。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">ヘッダレコードとフッタレコードを読み飛ばすOSコマンド</div>
<div class="paragraph">
<p>headコマンドとtailコマンドをうまく活用することでヘッダレコードとフッタレコードを行数指定をして読み飛ばすことが可能である。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ヘッダレコードの読み飛ばし方</dt>
<dd>
<p>tailコマンドをオプション<code>-n +K</code>を付与して実行することで、処理対象の<code>K</code>行目以降を取得する。</p>
</dd>
<dt class="hdlist1">フッタレコードの読み飛ばし方</dt>
<dd>
<p>headコマンドをオプション<code>-n -K</code>を付与して実行することで、処理対象の末尾から<code>K</code>行目より前を取得する。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>ヘッダレコードとフッタレコードをそれぞれ読み飛ばすシェルスクリプト例を下記に示す。<br></p>
</div>
<div class="listingblock">
<div class="title">ヘッダ/フッタから指定行数を取り除くシェルスクリプトの例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">#!/bin/bash

if [ $# -ne 4 ]; then
  echo &quot;The number of arguments must be 4, given is $#.&quot; 1&gt;&amp;2
  exit 1
fi

# Input file.
input=$1

# Output file.
output=$2

# Number of lines in header.
header=$3

# Number of lines in footer.
footer=$4

# Remove number of lines in header from the top of input file
# and number of lines in footer from the end,
# and save to output file.
tail -n +`expr ${header} + 1` ${input} | head -n -${footer} &gt; ${output}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 20. 引数</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイル</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイル</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">読み飛ばすヘッダの行数</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">読み飛ばすフッタの行数</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders"></a>ヘッダ情報の取り出し</h5>
<div class="paragraph">
<p>ヘッダレコードを認識し、ヘッダレコードの情報を取り出す方法を示す。</p>
</div>
<div class="paragraph">
<p>ヘッダ情報の取り出しは以下の要領で実装する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">設定</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.item.file.LineCallbackHandler</code>の実装クラスにヘッダに対する処理を実装する</p>
<div class="ulist">
<ul>
<li>
<p><code>LineCallbackHandler#handleLine()</code>内で取得したヘッダ情報を<code>stepExecutionContext</code>に格納する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>FlatFileItemReader</code>の<code>skippedLinesCallback</code>に<code>LineCallbackHandler</code>の実装クラスを設定する</p>
</li>
<li>
<p><code>FlatFileItemReader</code>の<code>linesToSkip</code>にヘッダの行数を指定する</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">ファイル読み込みおよびヘッダ情報の取り出し</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>linesToSkip</code>の設定によってスキップされるヘッダレコード1行ごとに<code>LineCallbackHandler#handleLine()</code>が呼び出される</p>
<div class="ulist">
<ul>
<li>
<p>ヘッダ情報が<code>stepExecutionContext</code>に格納される</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">取得したヘッダ情報を利用する</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>ヘッダ情報を<code>stepExecutionContext</code>から取得してデータ部の処理で利用する</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>ヘッダレコードの情報を取り出す際の実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.module.HoldHeaderLineCallbackHandler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:linesToSkip</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:skippedLinesCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingHeaderRecordItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 21. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">linesToSkip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">読み飛ばすヘッダ行数を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">skippedLinesCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LineCallbackHandler</code>の実装クラスを設定する。<br>
実装例は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">listener</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecutionListener</code>の実装クラスを設定する。<br>
<code>FlatFileItemReader</code>の<code>skippedLinesCallback</code>に指定する<code>LineCallbackHandler</code>は自動で<code>Listener</code>として登録されないため設定が必須となる。<br>
詳しい理由は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">リスナー設定について</div>
<div class="paragraph">
<p>下記の2つの場合は自動で<code>Listener</code>として登録されないため、ジョブ定義時に<code>Listeners</code>にも定義を追加する必要がある。<br>
(リスナの定義を追加しないと、<code>StepExecutionListener#beforeStep()</code>が実行されない)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FlatFileItemReader</code>の<code>skippedLinesCallback</code>に指定する<code>LineCallbackHandler</code>の<code>StepExecutionListener</code></p>
</li>
<li>
<p><code>Tasklet</code>の実装クラスに実装する<code>StepExecutionListener</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingHeaderRecordItemProcessor</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;batch:listeners&gt;</span>
                    <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingItemReaderListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="comment">&lt;!-- mandatory --&gt;</span>
                    <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/batch:listeners&gt;</span>
            <span class="tag">&lt;/batch:tasklet&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>LineCallbackHandler</code>は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>StepExecutionListener#beforeStep()</code>の実装</p>
<div class="ulist">
<ul>
<li>
<p>下記のいずれかの方法で<code>StepExecutionListener#beforeStep()</code>を実装する</p>
<div class="ulist">
<ul>
<li>
<p><code>StepExecutionListener</code>クラスを実装し、<code>beforeStep</code>メソッドをオーバーライドする</p>
</li>
<li>
<p>beforeStepメソッドを実装し、<code>@BeforeStep</code>アノテーションを付与する</p>
</li>
</ul>
</div>
</li>
<li>
<p>beforeStepメソッドにて<code>StepExecution</code>を取得してクラスフィールドに保持する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>LineCallbackHandler#handleLine()</code>の実装</p>
<div class="ulist">
<ul>
<li>
<p><code>LineCallbackHandler</code>クラスを実装し、<code>handleLine</code>メソッドをオーバーライドする</p>
<div class="ulist">
<ul>
<li>
<p><code>handleLine</code>メソッドはスキップする1行ごとに1回呼ばれる点に注意すること。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>StepExecution</code>から<code>stepExecutionContext</code>を取得し、<code>stepExecutionContext</code>にヘッダ情報を格納する。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">LineCallbackHandlerの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HoldHeaderLineCallbackHandler</span> <span class="directive">implements</span> LineCallbackHandler {  <span class="comment">// (1)</span>
    <span class="directive">private</span> StepExecution stepExecution;  <span class="comment">// (2)</span>

    <span class="annotation">@BeforeStep</span>  <span class="comment">// (3)</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="local-variable">this</span>.stepExecution = stepExecution;  <span class="comment">// (4)</span>
    }

    <span class="annotation">@Override</span>  <span class="comment">// (5)</span>
    <span class="directive">public</span> <span class="type">void</span> handleLine(<span class="predefined-type">String</span> line) {
        <span class="local-variable">this</span>.stepExecution.getExecutionContext().putString(<span class="string"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>, line);  <span class="comment">// (6)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 22. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LineCallbackHandler</code>クラスを実装し、<code>handleLine</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code>を保持するためのフィールドを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>beforeStep</code>メソッドを実装し、<code>@BeforeStep</code>アノテーションを付与する。<br>
シグネチャは<code>void beforeStep(StepExecution stepExecution)</code>とする。<br>
<code>StepExecutionListener</code>クラスを実装し、<code>beforeStep</code>メソッドをオーバーライドする方法でもよい。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code>を取得してクラスフィールドに保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LineCallbackHandler</code>クラスを実装し、<code>handleLine</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code>から<code>stepExecutionContext</code>を取得し、<code>header</code>というキーを指定して<code>stepExecutionContext</code>にヘッダ情報を格納する。<br>
ここでは簡単のため、スキップする2行のうち、最後の1行だけを格納している。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>ヘッダ情報を<code>stepExecutionContext</code>から取得してデータ部の処理で利用する例を示す。<br>
<code>ItemProcessor</code>にてヘッダ情報を利用する場合を例にあげて説明する。<br>
他のコンポーネントでヘッダ情報を利用する際も同じ要領で実現することができる。</p>
</div>
<div class="paragraph">
<p>ヘッダ情報を利用する処理は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>LineCallbackHandler</code>の実装例と同様に<code>StepExecutionListener#beforeStep()</code>を実装する</p>
</li>
<li>
<p><code>beforeStep</code>メソッドにて<code>StepExecution</code>を取得してクラスフィールドに保持する</p>
</li>
<li>
<p><code>StepExecution</code>から<code>stepExecutionContext</code>およびヘッダ情報を取得して利用する</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">ヘッダ情報の利用例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">LoggingHeaderRecordItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetail, SalesPlanDetail&gt; {
    <span class="directive">private</span> StepExecution stepExecution;  <span class="comment">// (1)</span>

    <span class="annotation">@BeforeStep</span>  <span class="comment">// (2)</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="local-variable">this</span>.stepExecution = stepExecution;  <span class="comment">// (3)</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">String</span> headerData = <span class="local-variable">this</span>.stepExecution.getExecutionContext()
                .getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// (4)</span>
        <span class="comment">// omitted business logic</span>
        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 23. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code>を保持するためのフィールドを定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>beforeStep</code>メソッドを実装し、<code>@BeforeStep</code>アノテーションを付与する。<br>
シグネチャは<code>void beforeStep(StepExecution stepExecution)</code>とする。<br>
<code>StepExecutionListener</code>クラスを実装し、<code>beforeStep</code>メソッドをオーバーライドする方法でもよい。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code>を取得してクラスフィールドに保持する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code>から<code>stepExecutionContext</code>を取得し、<code>header</code>というキーを指定して<code>stepExecutionContext</code>からヘッダ情報を取得する。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Job/StepのExecutionContextの使用について</div>
<div class="paragraph">
<p>ヘッダ(フッタ)情報の取出しでは、読み込んだヘッダ情報を<code>StepExecution</code>の<code>ExecutionContext</code>に格納しておき、使用する際に<code>ExecutionContext</code>から取り出す方式をとる。</p>
</div>
<div class="paragraph">
<p>下記の例では1つのステップ内でヘッダ情報の取得および利用を行うため<code>StepExecution</code>の<code>ExecutionContext</code>へヘッダ情報を格納している。
ヘッダ情報の取得および利用にてステップが分かれる場合は<code>JobExecution</code>の<code>ExecutionContext</code>を利用すること。</p>
</div>
<div class="paragraph">
<p>Job/Stepの<code>ExecutionContext</code>に関する詳細は、<a href="Ch02_SpringBatchArchitecture.html#Ch02_SpringBatchArch">Spring Batchのアーキテクチャ</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToUse_HeaderFooter_Input_SkipFooters"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_SkipFooters"></a>フッタの読み飛ばし</h5>
<div class="paragraph">
<p>TERASOLUNA Batch 5.xおよびMacchinetta Batch 2.xでは、フッタレコードの読み飛ばし機能は提供していないため、OSコマンドで対応する。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000
number of items,3
total of amounts,6000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>末尾から2行がフッタレコードである。</p>
</div>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">OSコマンドによる読み飛ばし処理</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ # Remove number of lines in footer from the end of input file
$ head -n -2 input.txt &gt; output.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>headコマンドを利用し、入力ファイルinput.txtの末尾から2行目より前を取得し、output.txtに出力している。</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessFooters"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessFooters"></a>フッタ情報の取り出し</h5>
<div class="paragraph">
<p>TERASOLUNA Batch 5.xおよびMacchinetta Batch 2.xでは、フッタレコードの読み飛ばし機能、フッタ情報の取得機能は提供していない。</p>
</div>
<div class="paragraph">
<p>そのため、処理を下記ようにOSコマンドによる前処理と2つのステップに分割することで対応する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OSコマンドによってフッタレコードを分割する</p>
</li>
<li>
<p>1つめのステップにてフッタレコードを読み込み、フッタ情報を<code>ExecutionContext</code>に格納する</p>
</li>
<li>
<p>2つめのステップにて<code>ExecutionContext</code>からフッタ情報を取得し、利用する</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>フッタ情報を取り出しは以下の要領で実装する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">OSコマンドによるフッタレコードの分割</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>OSコマンドを利用して入力ファイルをフッタ部とフッタ部以外に分割する</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">1つめのステップでフッタレコードを読み込み、フッタ情報を取得する</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>フッタレコードを読み込み<code>jobExecutionContext</code>に格納する</p>
<div class="ulist">
<ul>
<li>
<p>フッタ情報の格納と利用にてステップが異なるため、<code>jobExecutionContext</code>に格納する。</p>
</li>
<li>
<p><code>jobExecutionContext</code>を利用する方法は、JobとStepのスコープに関する違い以外は、<a href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders">ヘッダ情報の取り出し</a>にて説明した<code>stepExecutionContext</code>と同様である。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">2つめのステップにて取得したフッタ情報を利用する</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>フッタ情報を<code>jobExecutionContext</code>から取得してデータ部の処理で利用する</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>以下に示すファイルのフッタ情報を取り出して利用する場合を例にあげて説明する。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000
number of items,3
total of amounts,6000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>末尾から2行がフッタレコードである。</p>
</div>
<div class="paragraph">
<div class="title">OSコマンドによるフッタレコードの分割</div>
<p>上記のファイルをOSコマンドを利用してフッタ部とフッタ部以外に分割する設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">OSコマンドによる読み飛ばし処理</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ # Extract non-footer record from input file and save to output file.
$ head -n -2 input.txt &gt; input_data.txt

$ # Extract footer record from input file and save to output file.
$ tail -n 2 input.txt &gt; input_footer.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>headコマンドを利用し、入力ファイルinput.txtのフッタ部以外をinput_data.txtへ、フッタ部をinput_footer.txtに出力している。</p>
</div>
<div class="paragraph">
<p>出力ファイル例は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例(input_data.txt)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">出力ファイル例(input_footer.txt)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">number of items,3
total of amounts,6000000000</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">フッタ情報の取得、利用</div>
<p>OSコマンドにて分割したフッタレコードからフッタ情報を取得、利用する方法を説明する。<br></p>
</div>
<div class="paragraph">
<p>フッタレコードを読み込むステップを前処理として主処理とステップを分割している。<br>
ステップの分割に関する詳細は、<a href="Ch08_FlowControll.html#Ch08_FlowControll">フロー制御</a>を参照。</p>
</div>
<div class="paragraph">
<p>下記の例ではフッタ情報を取得し、<code>jobExecutionContext</code>へフッタ情報を格納するまでの例を示す。<br>
<code>jobExecutionContext</code>からフッタ情報を取得し利用する方法は<a href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders">ヘッダ情報の取り出し</a>と同じ要領で実現可能である。</p>
</div>
<div class="listingblock">
<div class="title">データレコードの情報を保持するクラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">フッタレコードの情報を保持するクラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailFooter</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="comment">// omitted serialVersionUID</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="directive">private</span> <span class="predefined-type">String</span> value;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>下記の要領でBean定義を行う。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>フッタレコードを読み込む<code>ItemReader</code>を定義する</p>
</li>
<li>
<p>データレコードを読み込む<code>ItemReader</code>を定義する</p>
</li>
<li>
<p>フッタレコードを取得するビジネスロジックを定義する</p>
<div class="ulist">
<ul>
<li>
<p>下記の例では<code>Tasklet</code>の実装クラスで実現している</p>
</li>
</ul>
</div>
</li>
<li>
<p>ジョブを定義する</p>
<div class="ulist">
<ul>
<li>
<p>フッタ情報を取得する前処理ステップとデータレコードを読み込み主処理を行うステップを定義する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- ItemReader for reading footer records --&gt;</span>
<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footerReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['footerInputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted other settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- ItemReader for reading data records --&gt;</span>
<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['dataInputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted other settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="comment">&lt;!-- omitted settings --&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- Tasklet for reading footer records --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">readFooterTasklet</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.module.ReadFooterTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter.step01</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter.step02</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">readFooterTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="comment">&lt;!-- (4) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter.step02</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">readFooterTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 24. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">項目</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">footerReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フッタレコードを保持するファイルを読み込むための<code>ItemReader</code>を定義する。<br>
フッタ情報を取得するステップで実行される<code>readFooterTasklet</code>にてインジェクトして使用する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dataReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データレコードを保持するファイルを読み込むための<code>ItemReader</code>を定義する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">前処理ステップ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フッタ情報を取得するステップを定義する。<br>
処理は<code>readFooterTasklet</code>に実装している。実装例は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">主処理ステップ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データ情報を取得するとともにフッタ情報を利用するステップを定義する。<br>
<code>reader</code>には<code>dataReader</code>を使用する。<br>
例ではフッタ情報を<code>jobExecutionContext</code>から取得し利用する処理(<code>ItemProcessor</code>等)は実装していない。<br>
フッタ情報を取得し利用する方法は<a href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders">ヘッダ情報の取り出し</a>と同じ要領で実現可能である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">listeners</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>readFooterTasklet</code>を設定する。<br>
この設定を行わないと<code>readFooterTasklet</code>内に実装する<code>JobExecutionListener#beforeJob()</code>が実行されない。<br>
詳しい理由は、<a href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders">ヘッダ情報の取り出し</a>を参照。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>フッタレコードを保持するファイルを読み込み、<code>jobExecutionContext</code>に格納する処理を行う処理の例を示す。</p>
</div>
<div class="paragraph">
<p><code>Tasklet</code>の実装クラスとして実現する際の要領は以下のとおり。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bean定義した<code>footerReader</code>を<code>@Inject</code>アノテーションと<code>@Named</code>アノテーションを使用し名前指定でインジェクトする。</p>
</li>
<li>
<p>読み込んだフッタ情報を<code>jobExecutionContext</code>に格納する</p>
<div class="ulist">
<ul>
<li>
<p>実現方法は<a href="#Ch05_FileAccess_HowToUse_HeaderFooter_Input_AccessHeaders">ヘッダ情報の取り出し</a>と同様である</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">フッタ情報の取得</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ReadFooterTasklet</span> <span class="directive">implements</span> Tasklet {
    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">footerReader</span><span class="delimiter">&quot;</span></span>)
    ItemStreamReader&lt;SalesPlanDetailFooter&gt; itemReader;

    <span class="directive">private</span> JobExecution jobExecution;

    <span class="annotation">@BeforeJob</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="local-variable">this</span>.jobExecution = jobExecution;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">ArrayList</span>&lt;SalesPlanDetailFooter&gt; footers = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

        <span class="comment">// (2)</span>
        itemReader.open(chunkContext.getStepContext().getStepExecution()
                .getExecutionContext());

        SalesPlanDetailFooter footer;
        <span class="keyword">while</span> ((footer = itemReader.read()) != <span class="predefined-constant">null</span>) {
            footers.add(footer);
        }

        <span class="comment">// (3)</span>
        jobExecution.getExecutionContext().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">footers</span><span class="delimiter">&quot;</span></span>, footers);

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 25. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean定義した<code>footerReader</code>を<code>@Inject</code>アノテーションと<code>@Named</code>アノテーションを使用し名前指定でインジェクトする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>footerReader</code>を使用してフッタレコードを保持したファイルを読み込みフッタ情報を取得する。<br>
<code>Tasklet</code>の実装クラス内でBean定義した<code>ItemReader</code>を使用する方法は<a href="Ch03_CreateTaskletJob.html#Ch03_CreateTaskletJob_HowToUse_Impl">タスクレット指向ジョブの作成</a>を参照。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecution</code>から<code>jobExecutionContext</code>を取得し、<code>footers</code>というキーを指定して<code>jobExecutionContext</code>へフッタ情報を格納する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToUse_HeaderFooter_Output"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Output"></a>出力</h4>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToUse_HeaderFooter_Output_Headers"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Output_Headers"></a>ヘッダ情報の出力</h5>
<div class="paragraph">
<p>フラットファイルでヘッダ情報を出力する際は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.item.file.FlatFileHeaderCallback</code>の実装を行う</p>
</li>
<li>
<p>実装した<code>FlatFileHeaderCallback</code>を<code>FlatFileItemWriter</code>の<code>headerCallback</code>に設定する</p>
<div class="ulist">
<ul>
<li>
<p><code>headerCallback</code>を設定すると<code>FlatFileItemWriter</code>の出力処理で、最初に<code>FlatFileHeaderCallback#writeHeader()</code>が実行される</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>FlatFileHeaderCallback</code>は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FlatFileHeaderCallback</code>クラスを実装し、<code>writeHeader</code>メソッドをオーバーライドする</p>
</li>
<li>
<p>引数で受ける<code>Writer</code>を用いてヘッダ情報を出力する。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記に<code>FlatFileHeaderCallback</code>クラスの実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">FlatFileHeaderCallbackの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WriteHeaderFlatFileFooterCallback</span> <span class="directive">implements</span> FlatFileHeaderCallback {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> writeHeader(<span class="predefined-type">Writer</span> writer) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="comment">// (2)</span>
        writer.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">omitted</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 26. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FlatFileHeaderCallback</code>クラスを実装し、<code>writeHeader</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受ける<code>Writer</code>を用いてヘッダ情報を出力する。<br>
<code>FlatFileHeaderCallback#writeHeader()</code>の実行直後に<code>FlatFileItemWriter</code>が出力する処理を実行する。<br>
そのため、ヘッダ情報末尾の改行は出力不要である。
出力される改行は、Bean定義時に<code>FlatFileItemWriter</code>に指定したものである。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:headerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeHeaderFlatFileFooterCallback</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 27. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">headerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FlatFileHeaderCallback</code>の実装クラスを設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区切り(改行コード)を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">システムプロパティの<code>line.separator</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">FlatFileHeaderCallback実装時にヘッダ情報末尾の改行は出力不要</div>
<div class="paragraph">
<p><code>FlatFileItemWriter</code>内で<code>FlatFileHeaderCallback#writeHeader()</code>の実行直後にBean定義時に指定した改行を出力する処理が実行されるため、ヘッダ情報末尾の改行は出力不要である。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToUse_HeaderFooter_Output_Footers"><a class="anchor" href="#Ch05_FileAccess_HowToUse_HeaderFooter_Output_Footers"></a>フッタ情報の出力</h5>
<div class="paragraph">
<p>フラットファイルでフッタ情報を出力する際は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.item.file.FlatFileFooterCallback</code>の実装を行う</p>
</li>
<li>
<p>実装した<code>FlatFileFooterCallback</code>を<code>FlatFileItemWriter</code>の<code>footerCallback</code>に設定する</p>
<div class="ulist">
<ul>
<li>
<p><code>footerCallback</code>を設定すると<code>FlatFileItemWriter</code>の出力処理で、最後に<code>FlatFileFooterCallback#writeFooter()</code>が実行される</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>フラットファイルでフッタ情報を出力する方法について説明する。</p>
</div>
<div class="paragraph">
<p><code>FlatFileFooterCallback</code>は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>引数で受ける<code>Writer</code>を用いてフッタ情報を出力する。</p>
</li>
<li>
<p><code>FlatFileFooterCallback</code>クラスを実装し、<code>writeFooter</code>メソッドをオーバーライドする</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記にJobの<code>ExecutionContext</code>からフッタ情報を取得し、ファイルへ出力する<code>FlatFileFooterCallback</code>クラスの実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">フッタレコードの情報を保持するクラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailFooter</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="comment">// omitted serialVersionUID</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="directive">private</span> <span class="predefined-type">String</span> value;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">FlatFileFooterCallbackの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WriteFooterFlatFileFooterCallback</span> <span class="directive">implements</span> FlatFileFooterCallback {  <span class="comment">// (1)</span>
    <span class="directive">private</span> JobExecution jobExecution;

    <span class="annotation">@BeforeJob</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="local-variable">this</span>.jobExecution = jobExecution;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> writeFooter(<span class="predefined-type">Writer</span> writer) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
        <span class="predefined-type">ArrayList</span>&lt;SalesPlanDetailFooter&gt; footers = (<span class="predefined-type">ArrayList</span>&lt;SalesPlanDetailFooter&gt;) <span class="local-variable">this</span>.jobExecution.getExecutionContext().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">footers</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// (2)</span>

        <span class="predefined-type">BufferedWriter</span> bufferedWriter = <span class="keyword">new</span> <span class="predefined-type">BufferedWriter</span>(writer);  <span class="comment">// (3)</span>
        <span class="comment">// (4)</span>
        <span class="keyword">for</span> (SalesPlanDetailFooter footer : footers) {
            bufferedWriter.write(footer.getName() +<span class="string"><span class="delimiter">&quot;</span><span class="content"> is </span><span class="delimiter">&quot;</span></span> + footer.getValue());
            bufferedWriter.newLine();
            bufferedWriter.flush();
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 28. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FlatFileFooterCallback</code>クラスを実装し、<code>writeFooter</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jobの<code>ExecutionContext</code>から<code>footers</code>というkeyを指定してフッタ情報を取得する。<br>
例ではArrayListで複数のフッタ情報を取得している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例では改行の出力に<code>BufferedWriter.newLine()</code>を使用するため、引数で受ける<code>Writer</code>を引数として<code>BufferedWriter</code>を生成する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受ける<code>Writer</code>を用いてフッタ情報を出力する。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:footerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeFooterFlatFileFooterCallback</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 29. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">footerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FlatFileFooterCallback</code>の実装クラスを設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_HowToUse_MultiFile"><a class="anchor" href="#Ch05_FileAccess_HowToUse_MultiFile"></a>複数ファイル</h3>
<div class="paragraph">
<p>複数ファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToUse_MultiFile_Input"><a class="anchor" href="#Ch05_FileAccess_HowToUse_MultiFile_Input"></a>入力</h4>
<div class="paragraph">
<p>同一レコード形式の複数ファイルを読み込む場合は、<code>org.springframework.batch.item.file.MultiResourceItemReader</code>を利用する。<br>
<code>MultiResourceItemReader</code>は指定された<code>ItemReader</code>を使用し正規表現で指定された複数のファイルを読み込むことができる。</p>
</div>
<div class="paragraph">
<p><code>MultiResourceItemReader</code>は以下の要領で定義する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>MultiResourceItemReader</code>のBeanを定義する</p>
<div class="ulist">
<ul>
<li>
<p><code>resources</code>プロパティに読み込み対象のファイルを指定する</p>
<div class="ulist">
<ul>
<li>
<p>正規表現で複数ファイルを指定する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>delegate</code>プロパティにファイル読み込みに利用する<code>ItemReader</code>を指定する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記に示す複数のファイルを読み込む<code>MultiResourceItemReader</code>の定義例は以下のとおりである。</p>
</div>
<div class="listingblock">
<div class="title">読み込み対象ファイル(ファイル名)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">sales_plan_detail_01.csv
sales_plan_detail_02.csv
sales_plan_detail_03.csv</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multiResourceReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.MultiResourceItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resources</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:input/sales_plan_detail_*.csv</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:delegate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 30. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">正規表現で複数の入力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">実際にファイルを読み込み処理する<code>ItemReader</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">実際にファイルを読み込み処理する<code>ItemReader</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource</code>プロパティは、<code>MultiResourceItemReader</code>から自動的に設定されるため、Bean定義に設定は不要である。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">MultiResourceItemReaderが使用するItemReaderにresourceの指定は不要である</div>
<div class="paragraph">
<p><code>MultiResourceItemReader</code>から委譲される<code>ItemReader</code>の<code>resource</code>は、<code>MultiResourceItemReader</code>から自動的に設定されるため、Bean定義に設定は不要である。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToUse_MultiFile_Output"><a class="anchor" href="#Ch05_FileAccess_HowToUse_MultiFile_Output"></a>出力</h4>
<div class="paragraph">
<p>複数ファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="paragraph">
<p>一定の件数ごとに異なるファイルへ出力する場合は、<code>org.springframework.batch.item.file.MultiResourceItemWriter</code>を利用する。</p>
</div>
<div class="paragraph">
<p><code>MultiResourceItemWriter</code>は指定された<code>ItemWriter</code>を使用して指定した件数ごとに複数ファイルへ出力することができる。<br>
出力対象のファイル名は重複しないように一意にする必要があるが、そのための仕組みとして<code>ResourceSuffixCreator</code>が提供されている。<br>
<code>ResourceSuffixCreator</code>はファイル名が一意となるようなサフィックスを生成するクラスである。<br></p>
</div>
<div class="paragraph">
<p>たとえば、出力対象ファイルを<code>outputDir/customer_list_01.csv</code>(<code>01</code>の部分は連番)というファイル名にしたい場合は下記のように設定する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>MultiResourceItemWriter</code>に<code>outputDir/customer_list_</code>と設定する</p>
</li>
<li>
<p>サフィックス<code>01.csv</code>(<code>01</code>の部分は連番)を生成する処理を<code>ResourceSuffixCreator</code>に実装する</p>
<div class="ulist">
<ul>
<li>
<p>連番は<code>MultiResourceItemWriter</code>から自動で増分されて渡される値を使用することができる</p>
</li>
</ul>
</div>
</li>
<li>
<p>実施に使用される<code>ItemWriter</code>には<code>outputDir/customer_list_01.csv</code>が設定される</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>MultiResourceItemWriter</code>は以下の要領で定義する。<code>ResourceSuffixCreator</code>の実装方法は後述する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ResourceSuffixCreator</code>の実装クラスを定義する</p>
</li>
<li>
<p><code>MultiResourceItemWriter</code>のBeanを定義する</p>
<div class="ulist">
<ul>
<li>
<p><code>resources</code>プロパティに出力対象のファイルを指定する</p>
<div class="ulist">
<ul>
<li>
<p><code>ResourceSuffixCreator</code>の実装クラスで付与するサフィックスまでを設定</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>resourceSuffixCreator</code>プロパティにサフィックスを生成する<code>ResourceSuffixCreator</code>の実装クラスを指定する</p>
</li>
<li>
<p><code>delegate</code>プロパティにファイル読み込みに利用する<code>ItemWriter</code>を指定する</p>
</li>
<li>
<p><code>itemCountLimitPerResource</code>プロパティに1ファイルあたりの出力件数を指定する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multiResourceItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.MultiResourceItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputDir']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resourceSuffixCreator-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerListResourceSuffixCreator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:delegate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:itemCountLimitPerResource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerListResourceSuffixCreator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.module.CustomerListResourceSuffixCreator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (6) --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 31. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力対象ファイルのサフィックスを付与する前の状態を設定する。<br>
<code>ItemWriter</code>には、<code>MultiResourceItemWriter</code>が自動でサフィックスを付与したものが設定される。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resourceSuffixCreator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResourceSuffixCreator</code>の実装クラスを設定する。<br>
デフォルト値は<code>"." + index</code>というサフィックスを生成する<code>org.springframework.batch.item.file.SimpleResourceSuffixCreator</code>である。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SimpleResourceSuffixCreator</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">実際にファイルを読み込み処理する<code>ItemWriter</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">itemCountLimitPerResource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1ファイルあたりの出力件数を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Integer.MAX_VALUE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">実際にファイルを読み込み処理する<code>ItemWriter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource</code>プロパティは、<code>MultiResourceItemWriter</code>から自動的に設定されるため、Bean定義に設定は不要である。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResourceSuffixCreator</code>の実装クラス</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">サフィックスを生成する<code>ResourceSuffixCreator</code>の実装クラスを定義する。<br>
実装方法は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title"><code>itemCountLimitPerResource</code>で指定されたレコード件数で意図通りに出力されないことがある</div>
<div class="paragraph">
<p><code>itemCountLimitPerResource</code>は1ファイルのレコードの出力件数を決定するものだが、<br>
この値は<code>commit-interval</code>で指定された数のレコードが出力された後で評価される。<br>
このため、<code>itemCountLimitPerResource</code>で指定された値以上のレコードが1ファイルに出力される場合がある。<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>itemCountLimitPerResource &lt;= commit-interval</code>の場合<br></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>&#160;&#160;&#160;&#160;1ファイルのレコードの出力件数は<code>commit-interval</code>の値になる。<br>
&#160;&#160;&#160;&#160;例：入力データ全部で10件あり、<code>itemCountLimitPerResource=4, commit-interval=5</code>の場合<br>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;1ファイル目のレコードの出力件数は5件になる<br>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;2ファイル目のレコードの出力件数は5件になる<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>itemCountLimitPerResource &gt; commit-interval</code>の場合<br></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>&#160;&#160;&#160;&#160;1ファイルのレコードの出力件数は<code>itemCountLimitPerResource</code>の値を超えたら、<br>
&#160;&#160;&#160;&#160;次のチャンクが新しく作成されたファイルに書き込まれる。<br>
&#160;&#160;&#160;&#160;例：入力データ全部で21件あり、<code>itemCountLimitPerResource=6, commit-interval=4</code>の場合<br>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;1ファイル目のレコードの出力件数は8件になる<br>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;2ファイル目のレコードの出力件数は8件になる<br>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;3ファイル目のレコードの出力件数は5件になる<br>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;補足：最初4件は1ファイル目に出力された後<code>itemCountLimitPerResource</code>の6を超えていない、<br>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;そのため次の4件も1ファイル目に出力され、全部で8件になる。<br>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;さらに次の4件は来た時、8件はすでに<code>itemCountLimitPerResource</code>の6を超えているため、<br>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;この4件は2ファイル目に出力される。<br>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;結果として、1ファイル目と2ファイル目は8件になり、3ファイル目は5件になる<br></p>
</div>
<div class="paragraph">
<p>よって、<code>itemCountLimitPerResource</code>で指定されたレコード件数でファイルの出力を分けるためには、<br>
<code>commit-interval</code>と<code>itemCountLimitPerResource</code>の値を同数とするか、<br>
<code>commit-interval</code>を<code>itemCountLimitPerResource</code>の約数となるように設定する。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">MultiResourceItemWriterが使用するItemWriterにresourceの指定は不要である</div>
<div class="paragraph">
<p><code>MultiResourceItemWriter</code>から委譲される<code>ItemWriter</code>の<code>resource</code>は、<code>MultiResourceItemWriter</code>から自動的に設定されるため、Bean定義に設定は不要である。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>ResourceSuffixCreator</code>は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ResourceSuffixCreator</code>クラスを実装し、<code>getSuffix</code>メソッドをオーバーライドする</p>
</li>
<li>
<p>引数で受ける<code>index</code>を用いてサフィックスを生成して返り値として返す</p>
<div class="ulist">
<ul>
<li>
<p><code>index</code>は初期値<code>1</code>で始まり出力対象ファイルごとにインクリメントされる<code>int</code>型の値である</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">ResourceSuffixCreatorの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerListResourceSuffixCreator</span> <span class="directive">implements</span> ResourceSuffixCreator {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getSuffix(<span class="type">int</span> index) {
        <span class="keyword">return</span> <span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">%02d</span><span class="delimiter">&quot;</span></span>, index) + <span class="string"><span class="delimiter">&quot;</span><span class="content">.csv</span><span class="delimiter">&quot;</span></span>;  <span class="comment">// (2)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 32. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResourceSuffixCreator</code>クラスを実装し、<code>getSuffix</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受ける<code>index</code>を用いてサフィックスを生成して返り値として返す。
<code>index</code>は初期値<code>1</code>で始まり出力対象ファイルごとにインクリメントされる<code>int</code>型の値である。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_HowToUse_ControlBreak"><a class="anchor" href="#Ch05_FileAccess_HowToUse_ControlBreak"></a>コントロールブレイク</h3>
<div class="paragraph">
<p>コントロールブレイクの実現方法について説明する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">コントロールブレイクとは</dt>
<dd>
<p>コントロールブレイク処理(またはキーブレイク処理)とは、ソート済みのレコードを順次読み込み、
レコード内にある特定の項目(キー項目)が同じレコードを1つのグループとして処理する手法のことを指す。<br>
主にデータを集計するときに用いられ、
キー項目が同じ値の間は集計を続け、キー項目が異なる値になる際に集計値を出力する、
というアルゴリズムになる。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>コントロールブレイク処理をするためには、グループの変わり目を判定するために、レコードを先読みする必要がある。
<code>org.springframework.batch.item.support.SingleItemPeekableItemReader</code>を使うことで先読みを実現できる。<br>
また、コントロールブレイクはタスクレットモデルでのみ処理可能とする。
これは、チャンクが前提とする「1行で定義するデータ構造をN行処理する」や「一定件数ごとのトランザクション境界」といった点が、
コントロールブレイクの「グループの変わり目で処理をする」という点と合わないためである。</p>
</div>
<div class="paragraph">
<p>コントロールブレイク処理の実行タイミングと比較条件を以下に示す。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>対象レコード処理前にコントロールブレイク実施</p>
<div class="ulist">
<ul>
<li>
<p>前回読み取ったレコードを保持し、前回レコードと現在読み込んだレコードとの比較</p>
</li>
</ul>
</div>
</li>
<li>
<p>対象レコード処理後にコントロールブレイク実施</p>
<div class="ulist">
<ul>
<li>
<p><code>SingleItemPeekableItemReader</code>により次のレコードを先読みし、次レコードと現在読み込んだレコードとの比較</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記に入力データから処理結果を出力するコントロールブレイクの実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">入力データ</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">01,2016,10,1000
01,2016,11,1500
01,2016,12,1300
02,2016,12,900
02,2016,12,1200</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">処理結果</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">Header Branch Id : 01,,,
01,2016,10,1000
01,2016,11,1500
01,2016,12,1300
Summary Branch Id : 01,,,3800
Header Branch Id : 02,,,
02,2016,12,900
02,2016,12,1200
Summary Branch Id : 02,,,2100</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">コントロールブレイクの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ControlBreakTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="annotation">@Inject</span>
    SingleItemPeekableItemReader&lt;SalesPerformanceDetail&gt; reader; <span class="comment">// (1)</span>

    <span class="annotation">@Inject</span>
    ItemStreamWriter&lt;SalesPerformanceDetail&gt; writer;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// omitted.</span>

        SalesPerformanceDetail previousData = <span class="predefined-constant">null</span>;   <span class="comment">// (2)</span>
        <span class="predefined-type">BigDecimal</span> summary = <span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">0</span>);  <span class="comment">//(3)</span>

        <span class="predefined-type">List</span>&lt;SalesPerformanceDetail&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();   <span class="comment">// (4)</span>

        <span class="keyword">try</span> {
            reader.open(executionContext);
            writer.open(executionContext);

            <span class="keyword">while</span> (reader.peek() != <span class="predefined-constant">null</span>) {   <span class="comment">// (5)</span>
                SalesPerformanceDetail data = reader.read(); <span class="comment">// (6)</span>

                <span class="comment">// (7)</span>
                <span class="keyword">if</span> (isBreakByBranchId(previousData, data)) {
                    SalesPerformanceDetail beforeBreakData =
                            <span class="keyword">new</span> SalesPerformanceDetail();
                    beforeBreakData.setBranchId(<span class="string"><span class="delimiter">&quot;</span><span class="content">Header Branch Id : </span><span class="delimiter">&quot;</span></span>
                              + currentData.getBranchId());
                    items.add(beforeBreakData);
                }

                <span class="comment">// omitted.</span>
                items.add(data);  <span class="comment">// (8)</span>

                SalesPerformanceDetail nextData = reader.peek();  <span class="comment">// (9)</span>
                summary = summary.add(data.getAmount());

                <span class="comment">// (10)</span>
                SalesPerformanceDetail afterBreakData = <span class="predefined-constant">null</span>;
                <span class="keyword">if</span> (isBreakByBranchId(nextData, data)) {
                    afterBreakData = <span class="keyword">new</span> SalesPerformanceDetail();
                    afterBreakData.setBranchId(<span class="string"><span class="delimiter">&quot;</span><span class="content">Summary Branch Id : </span><span class="delimiter">&quot;</span></span>
                            + currentData.getBranchId());
                    afterBreakData.setAmount(summary);
                    items.add(afterBreakData);
                    summary = <span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">0</span>);
                    writer.write(items);  <span class="comment">// (11)</span>
                    items.clear();
                }
                previousData = data;  <span class="comment">// (12)</span>
            }
        } <span class="keyword">finally</span> {
            <span class="keyword">try</span> {
                reader.close();
            } <span class="keyword">catch</span> (ItemStreamException e) {
            }
            <span class="keyword">try</span> {
                writer.close();
            } <span class="keyword">catch</span> (ItemStreamException e) {
            }
        }
        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
    <span class="comment">// (13)</span>
    <span class="directive">private</span> <span class="type">boolean</span> isBreakByBranchId(SalesPerformanceDetail o1,
            SalesPerformanceDetail o2) {
        <span class="keyword">return</span> (o1 == <span class="predefined-constant">null</span> || !o1.getBranchId().equals(o2.getBranchId()));
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 33. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SingleItemPeekableItemReader</code>をInjectする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">前回読み取ったレコードを保持する変数を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">グループごとの集計値を格納する変数を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コントロールブレイクの処理結果を含めたグループ単位のレコードを格納する変数を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力データが無くなるまで処理を繰り返す。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理対象のレコードを読み込む。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">対象レコード処理前にコントロールブレイクを実施する。<br>
ここではグループの先頭であれば見出しを設定して、(4)で定義した変数に格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">対象レコードへの処理結果を(4)で定義した変数に格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">次のレコードを先読みする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">対象レコード処理後にコントロールブレイクを実施する。
ここではグループの末尾であれば集計データをトレーラに設定して、(4)で定義した変数に格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">グループ単位で処理結果を出力する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理レコードを(2)で定義した変数に格納する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(13)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">キー項目が切り替わったか判定する。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.SingleItemPeekableItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:delegate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegateReader</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>

<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegateReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.app.model.performance.SalesPerformanceDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 34. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SingleItemPeekableItemReader</code>をBean定義する。TaskletへのInject対象。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delegate-ref</code>属性に実際にファイルを読み込むItemReaderのBeanを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">実際にファイルを読み込むItemReaderのBeanを定義する。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch05_FileAccess_HowToExtend"><a class="anchor" href="#Ch05_FileAccess_HowToExtend"></a>How to extend</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ここでは、以下のケースについて説明する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_FieldSetMapper">FieldSetMapperの実装</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_HowToExtend_Xml">XMLファイル</a>の入出力</p>
</li>
<li>
<p><a href="#Ch05_FileAccess_HowToExtend_MultiFormat">マルチフォーマット</a>の入出力</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_FieldSetMapper"><a class="anchor" href="#Ch05_FileAccess_FieldSetMapper"></a>FieldSetMapperの実装</h3>
<div class="paragraph">
<p><code>FieldSetMapper</code>を自作で実装する方法について説明する。</p>
</div>
<div class="paragraph">
<p><code>FieldSetMapper</code>の実装クラスは下記の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FieldSetMapper</code>クラスを実装し、<code>mapFieldSet</code>メソッドをオーバーライドする</p>
</li>
<li>
<p>引数で受けた<code>FieldSet</code>から値を取得し、適宜変換処理を行い、変換対象のBeanに格納し返り値として返す</p>
<div class="ulist">
<ul>
<li>
<p><code>FieldSet</code>クラスはJDBCにある<code>ResultSet</code>クラスのようにインデックスまたは名前と関連付けてデータを保持するクラスである</p>
</li>
<li>
<p><code>FieldSet</code>クラスは<code>LineTokenizer</code>によって分割されたレコードの各フィールドの値を保持する</p>
</li>
<li>
<p>インデックスまたは名前を指定して値を格納および取得することができる</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記のような和暦フォーマットのDate型やカンマを含むBigDecimal型の変換を行うファイルを読み込む場合の実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">&quot;000001&quot;,&quot;平成28年1月1日&quot;,&quot;000000001&quot;,&quot;1,000,000,000&quot;
&quot;000002&quot;,&quot;平成29年2月2日&quot;,&quot;000000002&quot;,&quot;2,000,000,000&quot;
&quot;000003&quot;,&quot;平成30年3月3日&quot;,&quot;000000003&quot;,&quot;3,000,000,000&quot;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 35. 入力ファイル仕様</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 35%;">
<col style="width: 35%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">フィールド名</th>
<th class="tableblock halign-left valign-top">データ型</th>
<th class="tableblock halign-left valign-top">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日付</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">和暦フォーマット</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">customerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">カンマを含む</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">UseDateSalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="predefined-type">Date</span> date;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">FieldSetMapperの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UseDateSalesPlanDetailFieldSetMapper</span> <span class="directive">implements</span> FieldSetMapper&lt;UseDateSalesPlanDetail&gt; {  <span class="comment">// (1)</span>
    <span class="comment">/**
     * {@inheritDoc}
     *
     * @param fieldSet {@inheritDoc}
     * @return Sales performance detail.
     * @throws BindException {@inheritDoc}
     */</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> UseDateSalesPlanDetail mapFieldSet(FieldSet fieldSet) <span class="directive">throws</span> <span class="exception">BindException</span> {
        UseDateSalesPlanDetail item = <span class="keyword">new</span> UseDateSalesPlanDetail();  <span class="comment">// (2)</span>

        item.setBranchId(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId</span><span class="delimiter">&quot;</span></span>));  <span class="comment">// (3)</span>

        <span class="comment">// (4)</span>
        <span class="predefined-type">DateFormat</span> japaneseFormat = <span class="keyword">new</span> <span class="predefined-type">SimpleDateFormat</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">GGGGy年M月d日</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Locale</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">ja</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JP</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JP</span><span class="delimiter">&quot;</span></span>));
        <span class="keyword">try</span> {
            item.setDate(japaneseFormat.parse(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>)));
        } <span class="keyword">catch</span> (<span class="exception">ParseException</span> e) {
            <span class="comment">// omitted exception handling</span>
        }

        <span class="comment">// (5)</span>
        item.setCustomerId(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId</span><span class="delimiter">&quot;</span></span>));

        <span class="comment">// (6)</span>
        <span class="predefined-type">DecimalFormat</span> decimalFormat = <span class="keyword">new</span> <span class="predefined-type">DecimalFormat</span>();
        decimalFormat.setParseBigDecimal(<span class="predefined-constant">true</span>);
        <span class="keyword">try</span> {
            item.setAmount((<span class="predefined-type">BigDecimal</span>) decimalFormat.parse(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">amount</span><span class="delimiter">&quot;</span></span>)));
        } <span class="keyword">catch</span> (<span class="exception">ParseException</span> e) {
            <span class="comment">// omitted exception handling</span>
        }

        <span class="keyword">return</span> item;  <span class="comment">// (7)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 36. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FieldSetMapper</code>クラスを実装し、<code>mapFieldSet</code>メソッドをオーバーライドする。
<code>FieldSetMapper</code>の型引数には変換対象クラスを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">変換処理等を行ったデータを格納するために変換対象クラスの変数を定義する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受けた<code>FieldSet</code>から<code>branchId</code>を取得し、変換対象クラスの変数へ格納する。<br>
<code>branchId</code>は変換処理が不要であるため、変換処理等は行っていない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受けた<code>FieldSet</code>から<code>date</code>を取得し、変換対象クラスの変数へ格納する。<br>
和暦フォーマットの日付をDate型へ変換するため、<code>SimpleDateFormat</code>でフォーマットを指定している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受けた<code>FieldSet</code>から<code>customerId</code>を取得し、変換対象クラスの変数へ格納する。<br>
<code>customerId</code>は変換処理が不要であるため、変換処理等は行っていない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受けた<code>FieldSet</code>から<code>amount</code>を取得し、変換対象クラスの変数へ格納する。<br>
カンマを含む値をBigDecimal型へ変換するため、<code>DecimalFormat</code>を使用している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理結果を保持している変換対象クラスを返す。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">FieldSetクラスからの値取得</div>
<div class="paragraph">
<p><code>FieldSet</code>クラスは、下記のような格納された値を取得するための様々なデータ型に対応したメソッドをもつ。<br>
また、<code>FieldSet</code>生成時にフィールドの名前と関連付けられてデータを格納した場合は、名前指定でのデータ取得、名前を指定しない場合ではインデックスを指定してのデータ取得が可能である。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>readString()</code></p>
</li>
<li>
<p><code>readInt()</code></p>
</li>
<li>
<p><code>readBigDecimal()</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>など</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_HowToExtend_Xml"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_Xml"></a>XMLファイル</h3>
<div class="paragraph">
<p>XMLファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToExtend_Xml_Mapping"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_Xml_Mapping"></a>オブジェクト変換ライブラリ</h4>
<div class="paragraph">
<p>BeanとXML間の変換処理(O/X (Object/XML) マッピング)にはSpring Frameworkが提供するライブラリを使用する。<br>
XMLファイルとオブジェクト間の変換処理を行うライブラリとして、XStreamやJAXBなどを利用した<code>Marshaller</code>および<code>Unmarshaller</code>を実装クラスが提供されている。<br>
状況に応じて適しているものを使用すること。</p>
</div>
<div class="paragraph">
<p>JAXBとXStreamを例に特徴と採用する際のポイントを説明する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">JAXB</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>変換対象のBeanはBean定義にて指定する</p>
</li>
<li>
<p>スキーマファイルを用いたバリデーションを行うことができる</p>
</li>
<li>
<p>対外的にスキーマを定義しており、入力ファイルの仕様が厳密に決まっている場合に有用である</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">XStream</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Bean定義にて柔軟にXMLの要素とBeanのフィールドをマッピングすることができる</p>
</li>
<li>
<p>柔軟にBeanマッピングする必要がある場合に有用である</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>なお、以降の説明ではJAXBを利用する例を示す。</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToExtend_Xml_Encoding"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_Xml_Encoding"></a>入出力におけるエンコーディングの仕様</h4>
<div class="paragraph">
<p>XMLの入出力にはSpring Batchが提供する<code>org.springframework.batch.item.xml.StaxEventItemReader</code>
および<code>org.springframework.batch.item.xml.StaxEventItemWriter</code>を使用する。<br>
これらのコンポーネントのエンコーディングの仕様は以下の表のとおり異なっているため、利用時には特にデフォルト値の違いに注意する必要がある。
デフォルト値の違いによって意図しないエンコーディングで入出力が行われることを防ぐため、
<code>StaxEventItemWriter</code>ではデフォルト値をそのまま使用する意図である場合でも明示的にエンコーディングを設定することを推奨する。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 37. 各コンポーネントのエンコーディングについての仕様</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 15%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">コンポーネント名</th>
<th class="tableblock halign-left valign-top">エンコーディングの指定方法</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StaxEventItemReader</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力するXMLのencoding属性に従う。<br>
encoding属性が宣言されていない場合はUTF-8となる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StaxEventItemWriter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean定義においてencodingプロパティを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Spring Batchのバージョンアップに伴うエンコーディングの仕様変更</div>
<div class="paragraph">
<p>Spring Batch 4.3.0以降では<code>StaxEventItemReader</code>にencodingプロパティが追加され、Bean定義でのエンコーディングの指定が可能となった。
これに合わせ、デフォルト値も<code>FlatFileItemReader</code>等と同様にJavaVMのデフォルトエンコーディングに従うよう変更されている。</p>
</div>
<div class="paragraph">
<p>Macchinetta Batch 2.3.0はSpring Batch 4.3.1を利用しているため、Macchinetta Batch 2.3.0へのバージョンアップを行う場合は、
エンコーディングを明示的に指定しないと読み込みに利用されるエンコーディングが変化してしまう可能性があるため注意すること。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToExtend_Xml_Input"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_Xml_Input"></a>入力</h4>
<div class="paragraph">
<p>XMLファイルの入力にはSpring Batchが提供する<code>org.springframework.batch.item.xml.StaxEventItemReader</code>を使用する。<br>
<code>StaxEventItemReader</code>は指定した<code>Unmarshaller</code>を使用してXMLファイルをBeanにマッピングすることでXMLファイルを読み込むことができる。</p>
</div>
<div class="paragraph">
<p><code>StaxEventItemReader</code>は以下の要領で定義する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>XMLのルート要素となる変換対象クラスに<code>@XmlRootElement</code>を付与する</p>
</li>
<li>
<p><code>StaxEventItemReader</code>に以下のプロパティを設定する</p>
<div class="ulist">
<ul>
<li>
<p><code>resource</code>プロパティに読み込み対象ファイルを設定する</p>
</li>
<li>
<p><code>fragmentRootElementName</code>プロパティにルート要素の名前を設定する</p>
</li>
<li>
<p><code>unmarshaller</code>プロパティに<code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>を設定する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>Jaxb2Marshaller</code>には以下のプロパティを設定する</p>
<div class="ulist">
<ul>
<li>
<p><code>classesToBeBound</code>プロパティに変換対象のクラスをリスト形式で設定する</p>
</li>
<li>
<p>スキーマファイルを用いたバリデーションを行う場合は、以下に示す2つのプロパティを設定する</p>
<div class="ulist">
<ul>
<li>
<p><code>schema</code>プロパティにバリデーションにて使用するスキーマファイルを設定する</p>
</li>
<li>
<p><code>validationEventHandler</code>プロパティにバリデーションにて発生したイベントを処理する<code>ValidationEventHandler</code>の実装クラスを設定する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記の入力ファイルを読み込むための設定例を示す。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">依存ライブラリの追加</div>
<div class="paragraph">
<p><code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>など、
Spring Frameworkが提供するライブラリであるSpring Object/XML Marshallingを使用する場合は、
ライブラリの依存関係に以下の設定を追加する必要がある。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-oxm<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Java SE 11でJAXBを利用する場合、jaxb-core及びjaxb-implが必要となる。
アプリケーションの依存ライブラリやバッチから提供されるライブラリにjaxb-core及びjaxb-implがない場合は、下記のようにpom.xmlに依存関係を追加すること。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.sun.xml.bind<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jaxb-core<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${jaxb-core.version}<span class="tag">&lt;/version&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.sun.xml.bind<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jaxb-impl<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${jaxb-impl.version}<span class="tag">&lt;/version&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 38. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="Ch02_MacchinettaBatchStack.html#Ch02_MacchinettaBatchStack_Stack_OSS">「表 1. OSSバージョン一覧」</a>のjaxb-coreのバージョンを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="Ch02_MacchinettaBatchStack.html#Ch02_MacchinettaBatchStack_Stack_OSS">「表 1. OSSバージョン一覧」</a>のjaxb-implのバージョンを指定する。</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;records&gt;</span>
    <span class="tag">&lt;customer&gt;</span>
        <span class="tag">&lt;name&gt;</span>Data Taro<span class="tag">&lt;/name&gt;</span>
        <span class="tag">&lt;phoneNumbers&gt;</span>
            <span class="tag">&lt;phone-number&gt;</span>01234567890<span class="tag">&lt;/phone-number&gt;</span>
        <span class="tag">&lt;/phoneNumbers&gt;</span>
    <span class="tag">&lt;/customer&gt;</span>
    <span class="tag">&lt;customer&gt;</span>
        <span class="tag">&lt;name&gt;</span>Data Jiro<span class="tag">&lt;/name&gt;</span>
        <span class="tag">&lt;phoneNumbers&gt;</span>
            <span class="tag">&lt;phone-number&gt;</span>01234567891<span class="tag">&lt;/phone-number&gt;</span>
            <span class="tag">&lt;phone-number&gt;</span>01234567892<span class="tag">&lt;/phone-number&gt;</span>
        <span class="tag">&lt;/phoneNumbers&gt;</span>
    <span class="tag">&lt;/customer&gt;</span>
    <span class="tag">&lt;customer&gt;</span>
        <span class="tag">&lt;name&gt;</span>Data Hanako<span class="tag">&lt;/name&gt;</span>
        <span class="tag">&lt;phoneNumbers&gt;</span>
            <span class="tag">&lt;phone-number&gt;</span>01234567893<span class="tag">&lt;/phone-number&gt;</span>
            <span class="tag">&lt;phone-number&gt;</span>01234567894<span class="tag">&lt;/phone-number&gt;</span>
        <span class="tag">&lt;/phoneNumbers&gt;</span>
    <span class="tag">&lt;/customer&gt;</span>
<span class="tag">&lt;/records&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@XmlRootElement</span>  <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Customer</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;PhoneNumber&gt; phoneNumbers = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="annotation">@XmlElement</span>  <span class="comment">// (2)</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> name;
    }

    <span class="directive">public</span> <span class="type">void</span> setName(<span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.name = name;
    }

    <span class="annotation">@XmlElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">phone-number</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (3)</span>
    <span class="annotation">@XmlElementWrapper</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">phoneNumbers</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (4)</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;PhoneNumber&gt; getPhoneNumbers() {
        <span class="keyword">return</span> phoneNumbers;
    }

    <span class="directive">public</span> <span class="type">void</span> setPhoneNumbers(<span class="predefined-type">List</span>&lt;PhoneNumber&gt; phoneNumbers) {
        <span class="local-variable">this</span>.phoneNumbers = phoneNumbers;
    }

    <span class="comment">// omitted.</span>
}

<span class="annotation">@XmlType</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">phone-number</span><span class="delimiter">&quot;</span></span>) <span class="error">　</span><span class="comment">// (5)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PhoneNumber</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> phoneNumber;

    <span class="annotation">@XmlValue</span> <span class="error">　</span><span class="comment">// (6)</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getPhoneNumber() {
        <span class="keyword">return</span> phoneNumber;
    }

    <span class="directive">public</span> <span class="type">void</span> setPhoneNumber(<span class="predefined-type">String</span> phoneNumber) {
        <span class="local-variable">this</span>.phoneNumber = phoneNumber;
    }

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 39. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@XmlRootElement</code>アノテーションで<code>&lt;customer&gt;</code>要素をルート要素としてXML要素にマップする。<br>
XML要素とクラス名が同じの場合、<code>name</code>属性での要素の指定は不要である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@XmlElement</code>アノテーションで<code>&lt;name&gt;</code>要素をXML要素にマップする。<br>
XML要素とJavaBeanプロパティが同じの場合、<code>name</code>属性での要素の指定は不要である。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@XmlElement</code>アノテーションで<code>&lt;phone-number&gt;</code>要素をXML要素にマップする。<br>
<code>name</code>属性には、(4)の属性名でラップされる要素の名前を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@XmlElementWrapper</code>アノテーションで(3)の要素をラップするラッパー要素を生成する。<br>
<code>name</code>属性には、ラッパー要素の名前を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@XmlType</code>アノテーションで(3)の<code>&lt;phone-number&gt;</code>要素にクラスをマップする。<br>
<code>name</code>属性には、マップされる要素の名前を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@XmlValue</code>アノテーションで(5)でマップされたクラスの<code>&lt;phone-number&gt;</code>要素にマップする。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:fragmentRootElementName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unmarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="comment">&lt;!-- (5) (6) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jaxb.Jaxb2Marshaller</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:schema</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:files/test/input/ch05/fileaccess/customer.xsd</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:validationEventHandler-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerValidationEventHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classesToBeBound</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (7) --&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="tag">&lt;value&gt;</span>jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.model.jaxb.Customer<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 40. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fragmentRootElementName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ルート要素の名前を設定する。<br>
対象となるオブジェクトが複数ある場合には、<code>fragmentRootElementNames</code>を利用する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueを設定すると、入力ファイルが存在しない(開けない)場合に例外が発生する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unmarshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">アンマーシャラを設定する。<br>
JAXBを利用する場合は、<code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>のBeanを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">schema</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バリデーションにて使用するスキーマファイルを設定する。<br>
スキーマファイルの記述例は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">validationEventHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バリデーションにて発生したイベントを処理する<code>ValidationEventHandler</code>の実装クラスを設定する。<br>
<code>ValidationEventHandler</code>の実装例は後述する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">classesToBeBound</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">変換対象のクラスをリスト形式で設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">スキーマファイル記述例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;xs:schema</span> <span class="attribute-name">xmlns:xs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;xs:complexType&gt;</span>
            <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;xs:sequence&gt;</span>
                <span class="comment">&lt;!-- (4) --&gt;</span>
                <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stringMaxSize</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
                <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">phoneNumbers</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">phoneNumberList</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (6) --&gt;</span>
            <span class="tag">&lt;/xs:sequence&gt;</span>
        <span class="tag">&lt;/xs:complexType&gt;</span>
    <span class="tag">&lt;/xs:element&gt;</span>

    <span class="comment">&lt;!-- (7) --&gt;</span>
    <span class="tag">&lt;xs:simpleType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stringMaxSize</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xs:restriction</span> <span class="attribute-name">base</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;xs:maxLength</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/xs:restriction&gt;</span>
    <span class="tag">&lt;/xs:simpleType&gt;</span>

    <span class="comment">&lt;!-- (8) --&gt;</span>
    <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">phoneNumberList</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xs:sequence&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">phone-number</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/xs:sequence&gt;</span>
    <span class="tag">&lt;/xs:complexType&gt;</span>

<span class="tag">&lt;/xs:schema&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 41. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;xs:element&gt;</code>要素の<code>name</code>属性には、入力XMLファイルのレコードにおけるルート要素を設定する。<br>
ここでは<code>customer</code>を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;xs:complexType&gt;</code>要素は、子要素や属性を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;xs:sequence&gt;</code>要素は、子要素の出現順序を設定する。<br>
ここでは、<code>name</code>、<code>phoneNumbers</code>の順で出現することを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;xs:element&gt;</code>要素は、子要素の属性名や属性値のデータ型などを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">子要素<code>name</code>に(7)の制約を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">子要素<code>phoneNumbers</code>に(8)の制約を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;xs:simpleType&gt;</code>要素は、整数値の範囲や文字列の長さといった制約を設定することができる。<br>
ここでは、文字列の長さの最大値は10という制約を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>phoneNumbers</code>要素の子要素である<code>phone-number</code>要素に制約を設定する。<br>
ここでは、最低出現回数が1回、最高出現回数が2回という制約を設定する。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">ValidationEventHandlerの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerValidationEventHandler</span> <span class="directive">implements</span> ValidationEventHandler {
    <span class="comment">/**
     * Logger.
     */</span>
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(CustomerValidationEventHandler.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> handleEvent(ValidationEvent event) {
        <span class="comment">// (2)</span>
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">[EVENT [SEVERITY:{}] [MESSAGE:{}] [LINKED EXCEPTION:{}] [LOCATOR: </span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content">[LINE NUMBER:{}] [COLUMN NUMBER:{}] [OFFSET:{}] [OBJECT:{}] [NODE:{}] [URL:{}] ] ]</span><span class="delimiter">&quot;</span></span>,
                event.getSeverity(),
                event.getMessage(),
                event.getLinkedException(),
                event.getLocator().getLineNumber(),
                event.getLocator().getColumnNumber(),
                event.getLocator().getOffset(),
                event.getLocator().getObject(),
                event.getLocator().getNode(),
                event.getLocator().getURL());
        <span class="keyword">return</span> <span class="predefined-constant">false</span>; <span class="comment">// (3)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 42. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ValidationEventHandler</code>クラスを実装し、<code>handleEvent</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受けたevent(<code>ValidationEvent</code>)からイベントの情報を取得し、適宜処理を行う。<br>
例ではイベントの情報をログ出力している。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検証処理を終了させるためfalseを返す。
検証処理を続行する場合はtrueを返す。<br>
適切な<code>UnmarshalException</code>、<code>ValidationException</code>、または<code>MarshalException</code>を生成して現在の操作を終了させる場合はfalseを返す。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToExtend_Xml_Output"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_Xml_Output"></a>出力</h4>
<div class="paragraph">
<p>XMLファイルの出力にはSpring Batchが提供する<code>org.springframework.batch.item.xml.StaxEventItemWriter</code>を使用する。<br>
<code>StaxEventItemWriter</code>は指定した<code>Marshaller</code>を使用してBeanをXMLにマッピングすることでXMLファイルを出力することができる。</p>
</div>
<div class="paragraph">
<p><code>StaxEventItemWriter</code>は以下の要領で定義する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>変換対象クラスに以下の設定を行う</p>
<div class="ulist">
<ul>
<li>
<p>XMLのルート要素となる変換対象クラスに<code>@XmlRootElement</code>を付与する</p>
</li>
<li>
<p><code>@XmlType</code>アノテーションを使用してフィールドを出力する順番を設定する</p>
</li>
<li>
<p>XMLへの変換対象外とするフィールドがある場合、対象フィールドのgetterに<code>@XmlTransient</code>アノテーションを付与する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>StaxEventItemWriter</code>に以下のプロパティを設定する</p>
<div class="ulist">
<ul>
<li>
<p><code>resource</code>プロパティに出力対象ファイルを設定する</p>
</li>
<li>
<p><code>marshaller</code>プロパティに<code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>を設定する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>Jaxb2Marshaller</code>には以下のプロパティを設定する</p>
<div class="ulist">
<ul>
<li>
<p><code>classesToBeBound</code>プロパティに変換対象のクラスをリスト形式で設定する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>下記の出力ファイルを書き出すための設定例を示す。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">依存ライブラリの追加</div>
<div class="paragraph">
<p><code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>など、
Spring Frameworkが提供するライブラリであるSpring Object/XML Marshallingを使用する場合は、
ライブラリの依存関係に以下の設定を追加する必要がある。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-oxm<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Java SE 11でJAXBを利用する場合、jaxb-core及びjaxb-implが必要となる。
アプリケーションの依存ライブラリやバッチから提供されるライブラリにjaxb-core及びjaxb-implがない場合は、下記のようにpom.xmlに依存関係を追加すること。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.sun.xml.bind<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jaxb-core<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${jaxb-core.version}<span class="tag">&lt;/version&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.sun.xml.bind<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jaxb-impl<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${jaxb-impl.version}<span class="tag">&lt;/version&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 43. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="Ch02_MacchinettaBatchStack.html#Ch02_MacchinettaBatchStack_Stack_OSS">「表 1. OSSバージョン一覧」</a>のjaxb-coreのバージョンを指定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="Ch02_MacchinettaBatchStack.html#Ch02_MacchinettaBatchStack_Stack_OSS">「表 1. OSSバージョン一覧」</a>のjaxb-implのバージョンを指定する。</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;records&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>001<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName001<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress001<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>001<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>002<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName002<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress002<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>002<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>003<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName003<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress003<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>003<span class="tag">&lt;/chargeBranchId&gt;</span>
  <span class="tag">&lt;/Customer&gt;</span>
<span class="tag">&lt;/records&gt;</span></code></pre>
</div>
</div>
<div id="Ch05_FileAccess_HowToExtend_Xml_Output_format" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">XMLファイル出力時のフォーマット処理(改行およびインデント)について</div>
<div class="paragraph">
<p>上記の出力ファイル例ではフォーマット処理(改行およびインデント)済みのXMLを例示しているが、実際にはフォーマットされていないファイルが出力される。</p>
</div>
<div class="paragraph">
<p><code>Jaxb2Marshaller</code>にはXML出力時にフォーマットを行う機能があるが期待どおり動作しない。<br>
この件に関してはSpring Forumにて議論されているため、今後期待どおり動作するようになる可能性がある。</p>
</div>
<div class="paragraph">
<p>これを回避し、フォーマット済みの出力を行うためには、以下のように<code>marshallerProperties</code>に設定すればよい。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jaxb.Jaxb2Marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classesToBeBound</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- omitted settings --&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshallerProperties</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;map&gt;</span>
                <span class="tag">&lt;entry&gt;</span>
                    <span class="tag">&lt;key&gt;</span>
                        <span class="tag">&lt;util:constant</span>
                            <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.xml.bind.Marshaller.JAXB_FORMATTED_OUTPUT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;/key&gt;</span>
                    <span class="tag">&lt;value</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Boolean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/entry&gt;</span>
            <span class="tag">&lt;/map&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@XmlRootElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="annotation">@XmlType</span>(propOrder={<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">customerName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">customerAddress</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">customerTel</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">chargeBranchId</span><span class="delimiter">&quot;</span></span>})  <span class="comment">// (2)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerToJaxb</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerName;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerAddress;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerTel;
    <span class="directive">private</span> <span class="predefined-type">String</span> chargeBranchId;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> createDate;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> updateDate;

    <span class="comment">// omitted getter/setter</span>

    <span class="annotation">@XmlTransient</span>  <span class="comment">// (3)</span>
    <span class="directive">public</span> <span class="predefined-type">Timestamp</span> getCreateDate() { <span class="keyword">return</span> createDate; }

    <span class="annotation">@XmlTransient</span>  <span class="comment">// (3)</span>
    <span class="directive">public</span> <span class="predefined-type">Timestamp</span> getUpdateDate() { <span class="keyword">return</span> updateDate; }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 44. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@XmlRootElement</code>アノテーションで<code>&lt;Customer&gt;</code>要素をルート要素としてXML要素にマップする。<br>
<code>name</code>属性には、<code>Customer</code>を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@XmlType</code>アノテーションを使用してフィールドを出力する順番を設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XMLへの変換対象外とするフィールドのgetterに<code>@XmlTransient</code>アノテーションを付与する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>上記のファイルを書き出すための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:rootTagName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">records</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:overwriteOutput</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (7) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jaxb.Jaxb2Marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classesToBeBound</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="tag">&lt;value&gt;</span>jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.model.mst.CustomerToJaxb<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 45. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルを設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力ファイルのエンコーディングを設定する。<br>
<a href="#Ch05_FileAccess_HowToExtend_Xml_Encoding">入出力におけるエンコーディングの仕様</a>で述べたように、ItemReader/Writer間のデフォルト値の違いによって意図しないエンコーディングで
出力が行われることを防ぐため、デフォルト値をそのまま使用する意図である場合でも明示的にエンコーディングを設定することを推奨する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rootTagName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ルート要素の名前を設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">overwriteOutput</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、既にファイルが存在すれば削除する。<br>
falseの場合、既にファイルが存在すれば例外をスローする。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trueの場合、出力件数が0件であれば出力対象ファイルを削除する。<br>
<span class="icon"><i class="fa fa-warning"></i></span> 他の設定との組み合わせによって意図しない動作をする場合があるため、trueは設定しないことを推奨する。詳細は<a href="#Ch05_FileAccess_HowToUse_VariableLength_Output_AboutShouldDeleteIfEmpty">可変長レコードの出力の注意書き</a>を参照。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トランザクション制御を行うかを設定する。詳細は、<a href="Ch05_Transaction.html#Ch05_Transaction">トランザクション制御</a>を参照。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">marshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">マーシャラを設定する。
JAXBを利用する場合は、<code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">classesToBeBound</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">変換対象のクラスをリスト形式で設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="Ch05_FileAccess_HowToExtend_Xml_HeaderFooter"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_Xml_HeaderFooter"></a>ヘッダ・フッタの出力</h5>
<div class="paragraph">
<p>ヘッダとフッタの出力には、<code>org.springframework.batch.item.xml.StaxWriterCallback</code>の実装クラスを使用する。</p>
</div>
<div class="paragraph">
<p>ヘッダの出力は、<code>headerCallback</code>、フッタの出力は、<code>footerCallback</code>に<code>StaxWriterCallback</code>の実装を設定する。</p>
</div>
<div class="paragraph">
<p>以下に出力されるファイルの例を示す。<br>
ヘッダはルート要素の開始タグ直後、フッタはルート要素の終了タグ直前に出力される。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;records&gt;</span>
<span class="comment">&lt;!-- Customer list header --&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>001<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName001<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress001<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>001<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>002<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName002<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress002<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>002<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>003<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName003<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress003<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>003<span class="tag">&lt;/chargeBranchId&gt;</span>
  <span class="tag">&lt;/Customer&gt;</span>
<span class="comment">&lt;!-- Customer list footer --&gt;</span>
<span class="tag">&lt;/records&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">XMLファイル出力時のフォーマット処理(改行およびインデント)について</div>
<div class="paragraph">
<p>上記の出力ファイル例ではフォーマット処理(改行およびインデント)済みのXMLを例示しているが、実際にはフォーマットされていないファイルが出力される。</p>
</div>
<div class="paragraph">
<p>詳細は、<a href="#Ch05_FileAccess_HowToExtend_Xml_Output">出力</a>を参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>上記のようなファイルを出力する設定を以下に示す。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:headerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeHeaderStaxWriterCallback</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:footerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeFooterStaxWriterCallback</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 46. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">headerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StaxWriterCallback</code>の実装クラスを設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">footerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StaxWriterCallback</code>の実装クラスを設定する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>StaxWriterCallback</code>は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>StaxWriterCallback</code>クラスを実装し、<code>write</code>メソッドをオーバーライドする</p>
</li>
<li>
<p>引数で受ける<code>XMLEventWriter</code>を用いてヘッダ/フッタを出力する</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">StaxWriterCallbackの実装例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WriteHeaderStaxWriterCallback</span> <span class="directive">implements</span> StaxWriterCallback { <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> write(XMLEventWriter writer) <span class="directive">throws</span> <span class="exception">IOException</span> {
        XMLEventFactory factory = XMLEventFactory.newInstance();
        <span class="keyword">try</span> {
            writer.add(factory.createComment(<span class="string"><span class="delimiter">&quot;</span><span class="content"> Customer list header </span><span class="delimiter">&quot;</span></span>)); <span class="comment">// (2)</span>
        } <span class="keyword">catch</span> (XMLStreamException e) {
            <span class="comment">// omitted exception handling</span>
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 47. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StaxWriterCallback</code>クラスを実装し、<code>write</code>メソッドをオーバーライドする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引数で受ける<code>XMLEventWriter</code>を用いてヘッダ/フッタを出力する。<br></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">XMLEventFactoryを使用したXMLの出力</div>
<div class="paragraph">
<p><code>XMLEventWriter</code>クラスを用いたXMLファイルの出力では<code>XMLEventFactory</code>クラスを使用することで効率的に<code>XMLEvent</code>を生成することができる。</p>
</div>
<div class="paragraph">
<p><code>XMLEventWriter</code>クラスには<code>add</code>メソッドが定義されており、<code>XMLEvent</code>オブジェクトを引数に取りXMLファイルの出力を行う。<br>
<code>XMLEvent</code>オブジェクトを都度生成するのは非常に手間が掛かるため、<code>XMLEvent</code>を容易に生成することができる<code>XMLEventFactory</code>クラスを使用する。<br>
<code>XMLEventFactory</code>クラスには <code>createStartDocument</code>メソッドや<code>createStartElement</code>メソッドなど、作成するイベントに対応したメソッドが定義してある。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_HowToExtend_MultiFormat"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_MultiFormat"></a>マルチフォーマット</h3>
<div class="paragraph">
<p>マルチフォーマットファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="paragraph">
<p>マルチフォーマットは、<a href="#Ch05_FileAccess_Overview">Overview</a>で説明したとおり(ヘッダn行 + データn行 + トレーラn行)* n + フッタn行 の形式を基本とするが以下のようなパターンも存在する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>フッタレコードがある場合、ない場合</p>
</li>
<li>
<p>同一レコード区分内でフォーマットが異なるレコードがある場合</p>
<div class="ulist">
<ul>
<li>
<p>例)データ部は項目数が5と6のデータレコードが混在する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>マルチフォーマットのパターンはいくつかあるが、実現方式は同じになる。</p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToExtend_MultiFormat_Input"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_MultiFormat_Input"></a>入力</h4>
<div class="paragraph">
<p>マルチフォーマットファイルの読み込みには、Spring Batchが提供する<code>org.springframework.batch.item.file.mapping.PatternMatchingCompositeLineMapper</code>を使用する。<br>
マルチフォーマットファイルでは各レコードのフォーマットごとに異なるBeanにマッピングする必要がある。<br>
<code>PatternMatchingCompositeLineMapper</code>は、パターンマッチによってレコードに対して使用する<code>LineTokenizer</code>および<code>FieldSetMapper</code>を選択することができる。</p>
</div>
<div class="paragraph">
<p>たとえば、以下のような形で使用する<code>LineTokenizer</code>を選択することが可能である。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>USER*</code>にマッチする(レコードの先頭が<code>USER</code>である)場合は<code>userTokenizer</code>を使用する</p>
</li>
<li>
<p><code>LINEA*</code>にマッチする(レコードの先頭が<code>LINEA</code>である)場合は<code>lineATokenizer</code>を使用する</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">マルチフォーマットファイルを読み込む際のレコードにかかるフォーマットの制約</div>
<div class="paragraph">
<p>マルチフォーマットファイルを読み込むためには、レコード区分がAntPathMatcherによるパターンマッチで判別可能なフォーマットでなければならない。
詳細は<code><a href="https://docs.spring.io/spring-batch/docs/4.2.5.RELEASE/api/org/springframework/batch/support/PatternMatcher.html">PatternMatcher</a></code>のAPIドキュメントを参照。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>PatternMatchingCompositeLineMapper</code>は以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>変換対象クラスはレコード区分をもつクラスを定義し、各レコード区分のクラスに継承させる</p>
</li>
<li>
<p>各レコードをBeanにマッピングするための<code>LineTokenizer</code>および<code>FieldSetMapper</code>を定義する</p>
</li>
<li>
<p><code>PatternMatchingCompositeLineMapper</code>を定義する</p>
<div class="ulist">
<ul>
<li>
<p><code>tokenizers</code>プロパティに各レコード区分に対応する<code>LineTokenizer</code>を設定する</p>
</li>
<li>
<p><code>fieldSetMappers</code>プロパティに各レコード区分に対応する<code>FieldSetMapper</code>を設定する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">変換対象クラスはレコード区分をもつクラスを定義し、各レコード区分のクラスに継承させる</div>
<div class="paragraph">
<p><code>ItemProcessor</code>は1つの型を引数に取る仕様である。</p>
</div>
<div class="paragraph">
<p>しかし、単純に<code>PatternMatchingCompositeLineMapper</code>にてマルチフォーマットのファイルをレコード区分ごとに異なるBeanにマッピングすると、<code>ItemProcessor</code>は1つの型を引数に取るため複数の型を処理することができない。</p>
</div>
<div class="paragraph">
<p>そのため、変換対象のクラスに継承関係をもたせ、<code>ItemProcessor</code>の引数の型にスーパークラスを指定することで解決が可能である。</p>
</div>
<div class="paragraph">
<p>以下に変換対象クラスのクラス図と<code>ItemProcessor</code>の定義例を示す。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_Conversion_target_class_with_inheritance_relationship.png" alt="Conversion target class definition when loading multiple formats">
</div>
<div class="title">図 6. 変換対象クラスのクラス図</div>
</div>
<div class="listingblock">
<div class="title">ItemProcessorの定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MultiFormatItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetailMultiFormatRecord, <span class="predefined-type">String</span>&gt; {
    <span class="annotation">@Override</span>
    <span class="comment">// (1)</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(SalesPlanDetailMultiFormatRecord item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">String</span> record = item.getRecord();  <span class="comment">// (2)</span>

        <span class="keyword">switch</span> (record) {  <span class="comment">// (3)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">H</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">T</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">E</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">default</span>:
            <span class="comment">// omitted exception handling</span>
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 48. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemProcessor</code>の引数に継承関係をもたせた変換対象クラスのスーパークラスを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">itemからレコード区分を取得する。<br>
各レコード区分によって実態のクラスは異なるが、ポリモーフィズムによってレコード区分を取得できる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区分を判定し、各レコード区分ごとの処理を行う。<br>
適宜、クラスの変換処理等を行うこと。</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以下に下記の入力ファイルを読み込むための設定例を示す。実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">入力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">H,Sales_plan_detail header No.1
D,000001,2016,1,0000000001,100000000
D,000001,2016,1,0000000002,200000000
D,000001,2016,1,0000000003,300000000
T,000001,3,600000000
H,Sales_plan_detail header No.2
D,00002,2016,1,0000000004,400000000
D,00002,2016,1,0000000005,500000000
D,00002,2016,1,0000000006,600000000
T,00002,3,1500000000
H,Sales_plan_detail header No.3
D,00003,2016,1,0000000007,700000000
D,00003,2016,1,0000000008,800000000
D,00003,2016,1,0000000009,900000000
T,00003,3,2400000000
E,3,9,4500000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>下記に変換対象クラスのBean定義例を示す。</p>
</div>
<div class="listingblock">
<div class="title">変換対象クラス</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * Model of record indicator of sales plan detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailMultiFormatRecord</span> {

    <span class="directive">protected</span> <span class="predefined-type">String</span> record;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of sales plan detail header.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailHeader</span> <span class="directive">extends</span> SalesPlanDetailMultiFormatRecord {

    <span class="directive">private</span> <span class="predefined-type">String</span> description;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of Sales plan Detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailData</span> <span class="directive">extends</span> SalesPlanDetailMultiFormatRecord {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of Sales plan Detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailTrailer</span> <span class="directive">extends</span> SalesPlanDetailMultiFormatRecord {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> number;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> total;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of Sales plan Detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailEnd</span> <span class="directive">extends</span> SalesPlanDetailMultiFormatRecord {
    <span class="comment">// omitted getter/setter</span>

    <span class="directive">private</span> <span class="type">int</span> headNum;
    <span class="directive">private</span> <span class="type">int</span> trailerNum;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> total;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のファイルを読む込むための設定は以下のとおり。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,description</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,number,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,headNum,trailerNum,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailHeader</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailData</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailTrailer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailEnd</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.PatternMatchingCompositeLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tokenizers</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
                <span class="tag">&lt;map&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">H*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">D*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">T*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">E*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/map&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMappers</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
                <span class="tag">&lt;map&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">H*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">D*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">T*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">E*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/map&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 49. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコードに対応する<code>LineTokenizer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコード区分に対応する<code>LineTokenizer</code>を定義する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコードに対応する<code>FieldSetMapper</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコード区分に対応する<code>FieldSetMapper</code>を定義する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.mapping.PatternMatchingCompositeLineMapper</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tokenizers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map形式で各レコード区分に対応する<code>LineTokenizer</code>を設定する。<br>
<code>key</code>にレコードを判別するパターンを設定し、<code>value-ref</code>に使用する<code>LineTokenizer</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldSetMappers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map形式で各レコード区分に対応する<code>FieldSetMapper</code>を設定する。<br>
<code>key</code>にレコードを判別するパターンを設定し、<code>value-ref</code>に使用する<code>FieldSetMapper</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToExtend_MultiFormat_Output"><a class="anchor" href="#Ch05_FileAccess_HowToExtend_MultiFormat_Output"></a>出力</h4>
<div class="paragraph">
<p>マルチフォーマットファイルを扱う場合の定義方法を説明する。</p>
</div>
<div class="paragraph">
<p>マルチフォーマットファイル読み込みではレコード区分によって使用する<code>LineTokenizer</code>および<code>FieldSetMapper</code>を判別する<code>PatternMatchingCompositeLineMapper</code>を使用することで実現可能である。<br>
しかし、書き込み時に同様の機能をもつコンポーネントは提供されていない。<br></p>
</div>
<div class="paragraph">
<p>そのため、<code>ItemProcessor</code>内で変換対象クラスをレコード(文字列)に変換する処理までを行い、<code>ItemWriter</code>では受け取った文字列をそのまま書き込みを行うことでマルチフォーマットファイルの書き込みを実現する。</p>
</div>
<div class="paragraph">
<p>マルチフォーマットファイルの書き込みは以下の要領で実装する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ItemProcessor</code>にて変換対象クラスをレコード(文字列)に変換して<code>ItemWriter</code>に渡す</p>
<div class="ulist">
<ul>
<li>
<p>例では、各レコード区分ごとの<code>LineAggregator</code>および<code>FieldExtractor</code>を定義し、<code>ItemProcessor</code>でインジェクトして使用する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ItemWriter</code>では受け取った文字列をそのままファイルへ書き込みを行う</p>
<div class="ulist">
<ul>
<li>
<p><code>ItemWriter</code>の<code>lineAggregator</code>プロパティに<code>PassThroughLineAggregator</code>を設定する</p>
</li>
<li>
<p><code>PassThroughLineAggregator</code>は受け取ったitemの<code>item.toString()</code>した結果を返す<code>LineAggregator</code>である</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>以下に下記の出力ファイルを書き出すための設定例を示す。実装例を示す。</p>
</div>
<div class="listingblock">
<div class="title">出力ファイル例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">H,Sales_plan_detail header No.1
D,000001,2016,1,0000000001,100000000
D,000001,2016,1,0000000002,200000000
D,000001,2016,1,0000000003,300000000
T,000001,3,600000000
H,Sales_plan_detail header No.2
D,00002,2016,1,0000000004,400000000
D,00002,2016,1,0000000005,500000000
D,00002,2016,1,0000000006,600000000
T,00002,3,1500000000
H,Sales_plan_detail header No.3
D,00003,2016,1,0000000007,700000000
D,00003,2016,1,0000000008,800000000
D,00003,2016,1,0000000009,900000000
T,00003,3,2400000000
E,3,9,4500000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>変換対象クラスの定義および<code>ItemProcessor</code>定義例、注意点は<a href="#Ch05_FileAccess_HowToExtend_MultiFormat_Input">マルチフォーマットの入力</a>と同様である。</p>
</div>
<div class="paragraph">
<p>上記のファイルを出力するための設定は以下のとおり。
<code>ItemProcessor</code>の定義例をBean定義例の後に示す。</p>
</div>
<div class="listingblock">
<div class="title">Bean定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,description</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,number,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,headNum,trailerNum,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>


<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.PassThroughLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 50. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">設定項目名</th>
<th class="tableblock halign-left valign-top">設定内容</th>
<th class="tableblock halign-left valign-top">必須</th>
<th class="tableblock halign-left valign-top">デフォルト値</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコード区分に対応する<code>LineAggregator</code>および<code>FieldExtractor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LineAggregator</code>および<code>FieldExtractor</code>を定義する。<br>
<code>ItemProcessor</code>で<code>LineAggregator</code>をインジェクトして使用する。</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.item.file.transform.PassThroughLineAggregator</code>を設定する。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">なし</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>ItemProcessor</code>の実装例を以下に示す。<br>
例で実装しているのは、受け取ったitemを文字列に変換して<code>ItemWriter</code>に渡す処理のみである。</p>
</div>
<div class="listingblock">
<div class="title">ItemProcessorの定義例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MultiFormatItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetailMultiFormatRecord, <span class="predefined-type">String</span>&gt; {

    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiFormatRecord&gt; headerDelimitedLineAggregator;

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiFormatRecord&gt; dataDelimitedLineAggregator;

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiFormatRecord&gt; trailerDelimitedLineAggregator;

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiFormatRecord&gt; endDelimitedLineAggregator;

    <span class="annotation">@Override</span>
    <span class="comment">// (2)</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(SalesPlanDetailMultiFormatRecord item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">String</span> record = item.getRecord();  <span class="comment">// (3)</span>

        <span class="keyword">switch</span> (record) {  <span class="comment">// (4)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">H</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> headerDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> dataDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">T</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> trailerDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">E</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> endDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">default</span>:
            <span class="keyword">throw</span> <span class="keyword">new</span> IncorrectRecordClassificationException(
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">Record classification is incorrect.[value:</span><span class="delimiter">&quot;</span></span> + record + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>);
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 51. 設定内容の項目一覧</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項番</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコード区分に対応する<code>LineAggregator</code>をインジェクトする。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemProcessor</code>の引数に継承関係をもたせた変換対象クラスのスーパークラスを設定する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">itemからレコード区分を取得する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レコード区分を判定し、各レコード区分ごとの処理を行う。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各レコード区分に対応する<code>LineAggregator</code>を使用し変換対象クラスをレコード(文字列)に変換して<code>ItemWriter</code>に渡す。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<link rel="stylesheet" href="./theme/css/coderay-asciidoctor.css">
<div class="container">

  <div class="common-bg">
    <div class="information">
      Macchinetta Batch Framework (2.x) Development Guideline - version 2.2.1.RELEASE, 2021-3-26, commit-id:94f5df3
    </div>
    <div class="index">
      <a href="index.html">&gt; INDEX</a>
    </div>
  </div>

  <div class="footer-bg">
    <div class="copyright">
      &copy; Copyright 2017 NTT Corporation.
    </div>
  </div>

</div>
</body>
</html>